<!DOCTYPE html>
<html lang="tr">
<head>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  (function(){
    var EMAILJS_PUBLIC_KEY  = '';
    var EMAILJS_SERVICE_ID  = '';
    var EMAILJS_TEMPLATE_ID = '';
    window._EJS = { pub: EMAILJS_PUBLIC_KEY, svc: EMAILJS_SERVICE_ID, tpl: EMAILJS_TEMPLATE_ID };
    if (EMAILJS_PUBLIC_KEY) emailjs.init(EMAILJS_PUBLIC_KEY);
  })();
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#b01020">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Nature.co">
<meta name="mobile-web-app-capable" content="yes">
<title>Nature.co</title>
<link rel="icon" href="data:image/svg+xml,<svg viewBox='0 0 120 120' xmlns='http://www.w3.org/2000/svg'><defs><clipPath id='lci'><path d='M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z'/></clipPath></defs><path d='M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z' fill='%230e2b0c'/><g clip-path='url(%23lci)'><line x1='60' y1='14' x2='60' y2='108' stroke='%234a8f40' stroke-width='1.2'/><line x1='60' y1='35' x2='78' y2='55' stroke='%234a8f40' stroke-width='.7'/><line x1='60' y1='35' x2='42' y2='55' stroke='%234a8f40' stroke-width='.7'/><line x1='60' y1='52' x2='82' y2='68' stroke='%234a8f40' stroke-width='.6'/><line x1='60' y1='52' x2='38' y2='68' stroke='%234a8f40' stroke-width='.6'/><line x1='60' y1='68' x2='78' y2='82' stroke='%234a8f40' stroke-width='.5'/><line x1='60' y1='68' x2='42' y2='82' stroke='%234a8f40' stroke-width='.5'/><line x1='60' y1='82' x2='70' y2='94' stroke='%234a8f40' stroke-width='.4'/><line x1='60' y1='82' x2='50' y2='94' stroke='%234a8f40' stroke-width='.4'/></g><path d='M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z' fill='none' stroke='%234a8f40' stroke-width='1.2'/></svg>">

<script>
const manifestData={name:"Biyom",short_name:"T√ºrkSohbet",start_url:"https://natureco.me/",display:"standalone",background_color:"#2c3038",theme_color:"#2c3038",orientation:"portrait",icons:[{src:"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' rx='40' fill='%233f0e40'/><text y='130' x='96' text-anchor='middle' font-size='110'>üí¨</text></svg>",sizes:"192x192",type:"image/svg+xml"}]};
const _mb=new Blob([JSON.stringify(manifestData)],{type:'application/json'});
const _ml=document.createElement('link');_ml.rel='manifest';_ml.href=URL.createObjectURL(_mb);document.head.appendChild(_ml);
</script>

<style>
:root{
  --purple-dark:#1c1f23;
  --purple:     #2c3038;
  --purple-mid: #3a3f47;
  --aubergine:  #141618;
  --bg:         #141618;
  --bg2:        #1c1f23;
  --surface:    #252830;
  --surface2:   #2f3340;
  --border:     #3a3f47;
  --text:       #c9cdd4;
  --text-hi:    #ffffff;
  --muted:      #7a8090;
  --green:      #2ecc71;
  --blue:       #5b9bd5;
  --red:        #e05555;
  --yellow:     #f0c040;
  --own-bg:     #2a4a7a;
  --incoming-bg:#263045;
  --safe-top:   env(safe-area-inset-top,0px);
  --safe-bot:   env(safe-area-inset-bottom,0px);
  --app-height: 100%;
  /* Tema renk aksanƒ± */
  --accent:     #5b9bd5;
  --accent2:    #2a4a7a;
}

/* ‚îÄ‚îÄ TEMALAR ‚îÄ‚îÄ */
[data-theme="dark"] {
  --purple-dark:#1c1f23; --purple:#2c3038; --purple-mid:#3a3f47;
  --bg:#141618; --bg2:#1c1f23; --surface:#252830; --surface2:#2f3340;
  --border:#3a3f47; --text:#c9cdd4; --text-hi:#ffffff; --muted:#7a8090;
  --accent:#5b9bd5; --accent2:#2a4a7a; --own-bg:#2a4a7a; --incoming-bg:#263045;
}
[data-theme="forest"] {
  --purple-dark:#0d1a0f; --purple:#1a2e1c; --purple-mid:#2a4a2e;
  --bg:#0d1a0f; --bg2:#1a2e1c; --surface:#1f3823; --surface2:#28472d;
  --border:#2a4a2e; --text:#b8d4bc; --text-hi:#e8f5e9; --muted:#6a9070;
  --accent:#4caf50; --accent2:#1b5e20; --own-bg:#1b5e20; --incoming-bg:#1a3520;
}
[data-theme="ocean"] {
  --purple-dark:#091520; --purple:#0d2235; --purple-mid:#133452;
  --bg:#091520; --bg2:#0d2235; --surface:#102840; --surface2:#163552;
  --border:#1a3d60; --text:#a8c8e8; --text-hi:#e0f0ff; --muted:#5a8ab0;
  --accent:#29b6f6; --accent2:#01579b; --own-bg:#01579b; --incoming-bg:#0d2a48;
}
[data-theme="sunset"] {
  --purple-dark:#1a0e10; --purple:#2d1620; --purple-mid:#45202e;
  --bg:#1a0e10; --bg2:#2d1620; --surface:#3a1a25; --surface2:#4a2030;
  --border:#5a2a3a; --text:#e8c0c8; --text-hi:#fff0f3; --muted:#a06070;
  --accent:#f06292; --accent2:#880e4f; --own-bg:#880e4f; --incoming-bg:#3d1528;
}
[data-theme="midnight"] {
  --purple-dark:#080810; --purple:#10101e; --purple-mid:#18182e;
  --bg:#080810; --bg2:#10101e; --surface:#151528; --surface2:#1e1e36;
  --border:#282845; --text:#c0c0e0; --text-hi:#f0f0ff; --muted:#6060a0;
  --accent:#9c27b0; --accent2:#4a0072; --own-bg:#4a0072; --incoming-bg:#1a1535;
}
[data-theme="latte"] {
  --purple-dark:#f0ebe3; --purple:#e8e0d4; --purple-mid:#d8cfc2;
  --bg:#f5f0e8; --bg2:#ede5d8; --surface:#e2d8c8; --surface2:#d8ccb8;
  --border:#c8bca8; --text:#3a3028; --text-hi:#1a1410; --muted:#807060;
  --accent:#8b4513; --accent2:#d2691e; --own-bg:#d2691e; --incoming-bg:#c8b898;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;width:100%;overflow:hidden;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;font-size:15px;-webkit-font-smoothing:antialiased;}

/* ‚îÄ‚îÄ Yan D√∂nme Engelleme ‚îÄ‚îÄ */
#orientationBlock {
  display: none !important;
  position: fixed;
  inset: 0;
  z-index: 999999;
  background: #141618;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  color: #fff;
}
#orientationBlock .ob-icon {
  font-size: 3rem;
  animation: obRotate 1.5s ease-in-out infinite;
}
#orientationBlock .ob-text {
  font-size: 1rem;
  font-weight: 700;
  color: rgba(255,255,255,.8);
  text-align: center;
  padding: 0 32px;
}
@keyframes obRotate {
  0%,100% { transform: rotate(0deg); }
  50% { transform: rotate(-90deg); }
}
@media (orientation: landscape) and (max-width: 1024px) {
  #orientationBlock {
    display: flex !important;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üé® UI STƒ∞L Sƒ∞STEMƒ∞ ‚Äî Glass / Clean / Vivid
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ GLASS / AURORA ‚îÄ‚îÄ */
[data-ui="glass"] {
  --bg:         #0d0b20;
  --bg2:        #13103a;
  --surface:    rgba(255,255,255,.07);
  --surface2:   rgba(255,255,255,.12);
  --border:     rgba(255,255,255,.1);
  --text:       rgba(255,255,255,.85);
  --text-hi:    #ffffff;
  --muted:      rgba(255,255,255,.38);
  --accent:     #6c63ff;
  --accent2:    #a855f7;
  --own-bg:     rgba(108,99,255,.75);
  --purple:     rgba(255,255,255,.05);
  --purple-dark:#0f0c29;
  --purple-mid: rgba(255,255,255,.08);
}
[data-ui="glass"] #roomsScreen,
[data-ui="glass"] #deskRail {
  background: linear-gradient(180deg,#0d0a24 0%,#110e30 100%);
  position: relative;
}
[data-ui="glass"] #roomsScreen::before,
[data-ui="glass"] #deskRail::before {
  content:'';position:absolute;width:250px;height:200px;
  top:-40px;left:-60px;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse,rgba(108,99,255,.3) 0%,transparent 70%);
  animation:uiAurora1 9s ease-in-out infinite;
}
[data-ui="glass"] #deskSidebar {
  background: linear-gradient(180deg,#0f0c29 0%,#13103a 100%);
  position: relative; overflow: hidden;
}
[data-ui="glass"] #deskSidebar::before {
  content:'';position:absolute;width:280px;height:200px;
  top:-60px;left:-80px;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse,rgba(108,99,255,.22) 0%,transparent 70%);
}
[data-ui="glass"] #deskSidebar::after {
  content:'';position:absolute;width:200px;height:150px;
  bottom:40px;right:-60px;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse,rgba(0,200,160,.12) 0%,transparent 70%);
}
[data-ui="glass"] #deskMain { background: linear-gradient(180deg,#0d0b20 0%,#0a091a 100%); }
[data-ui="glass"] .ob {
  background: linear-gradient(135deg,rgba(108,99,255,.75),rgba(90,40,180,.75));
  border: 1px solid rgba(108,99,255,.3);
}
[data-ui="glass"] .inp-box {
  background: rgba(255,255,255,.07);
  border: 1px solid rgba(255,255,255,.1);
  backdrop-filter: blur(16px);
}
[data-ui="glass"] .c-header,
[data-ui="glass"] .ws-header,
[data-ui="glass"] #deskChatHeader {
  background: rgba(255,255,255,.05) !important;
  backdrop-filter: blur(20px);
  border-bottom-color: rgba(255,255,255,.08) !important;
}
[data-ui="glass"] .tab-bar {
  background: rgba(255,255,255,.04);
  backdrop-filter: blur(20px);
  border-top-color: rgba(255,255,255,.07);
}
[data-ui="glass"] .login-btn { background: linear-gradient(135deg,#6c63ff,#a855f7); }
[data-ui="glass"] .forum-card { background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.1); }
[data-ui="glass"] #deskSidebarHeader { border-bottom-color: rgba(255,255,255,.07); }
@keyframes uiAurora1{0%,100%{transform:translate(0,0) scale(1);}50%{transform:translate(20px,15px) scale(1.1);}}

/* ‚îÄ‚îÄ Glass emoji picker opak ‚îÄ‚îÄ */
[data-ui="glass"] #emojiPicker,
[data-ui="glass"] #deskEmojiPicker,
[data-ui="glass"] .picker-body,
[data-ui="glass"] .picker-tabs,
[data-ui="glass"] .gif-search-wrap { background: #0f0c29 !important; }

/* ‚îÄ‚îÄ CLEAN SLATE ‚îÄ‚îÄ */
[data-ui="clean"] {
  --bg:         #0e1016;
  --bg2:        #111418;
  --surface:    #181b22;
  --surface2:   #1e2230;
  --border:     #1e2230;
  --text:       #c8d0e0;
  --text-hi:    #e8eaf0;
  --muted:      #4a5268;
  --accent:     #5b9bd5;
  --accent2:    #1d3568;
  --own-bg:     #1d2d4a;
  --purple:     #111418;
  --purple-dark:#0d0f14;
  --purple-mid: #161922;
}
[data-ui="clean"] #deskRail { background: #0d0f14; border-right-color: #181b22; }
[data-ui="clean"] #deskSidebar { background: #111418; border-right-color: #181b22; }
[data-ui="clean"] #deskMain { background: #0e1016; }
[data-ui="clean"] #roomsScreen { background: #0d0f14; }
[data-ui="clean"] .ws-header { background: #111418 !important; border-bottom: 1px solid #181b22 !important; }
[data-ui="clean"] .c-header { background: #111418 !important; border-bottom-color: #181b22 !important; }
[data-ui="clean"] .tab-bar { background: #0d0f14; border-top-color: #181b22; }
[data-ui="clean"] .ob { background: #1d2d4a; border-radius: 14px 3px 14px 14px; }
[data-ui="clean"] .inp-box { background: #181b22; border-color: #1e2230; }
[data-ui="clean"] .r-row { border-radius: 6px; margin: 1px 6px; }
[data-ui="clean"] .r-row.act { background: #161c2a; }
[data-ui="clean"] .forum-card { background: #111418; border-color: #1e2230; }
[data-ui="clean"] .login-btn { background: #1d3568; }
[data-ui="clean"] #deskSidebarHeader { border-bottom-color: #181b22; }

/* ‚îÄ‚îÄ VIVID / SUNSET ‚îÄ‚îÄ */
[data-ui="vivid"] {
  --bg:         #0a0c12;
  --bg2:        #0c0e14;
  --surface:    #161922;
  --surface2:   #1f2430;
  --border:     rgba(255,255,255,.07);
  --text:       #c0c8d8;
  --text-hi:    #ffffff;
  --muted:      rgba(255,255,255,.35);
  --accent:     #f97316;
  --accent2:    #ec4899;
  --own-bg:     linear-gradient(135deg,#f97316,#ec4899);
  --purple:     #0c0e14;
  --purple-dark:#080a10;
  --purple-mid: rgba(255,255,255,.05);
}
[data-ui="vivid"] #deskRail { background: #080a10; border-right-color: rgba(255,255,255,.05); }
[data-ui="vivid"] #deskSidebar { background: #0c0e14; border-right-color: rgba(255,255,255,.05); }
[data-ui="vivid"] #deskMain { background: #0a0c12; }
[data-ui="vivid"] #roomsScreen { background: #080a10; }
[data-ui="vivid"] .ws-header { background: #0c0e14 !important; border-bottom: 1px solid rgba(255,255,255,.05) !important; }
[data-ui="vivid"] .c-header { background: rgba(255,255,255,.02) !important; border-bottom-color: rgba(255,255,255,.05) !important; }
[data-ui="vivid"] .tab-bar { background: #080a10; border-top-color: rgba(255,255,255,.05); }
[data-ui="vivid"] .ob {
  background: linear-gradient(135deg,#f97316,#ec4899) !important;
  box-shadow: 0 4px 16px rgba(249,115,22,.25);
  border-radius: 18px 18px 4px 18px;
}
[data-ui="vivid"] .inp-box { background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.08); }
[data-ui="vivid"] .r-row.act { background: rgba(249,115,22,.1); border-left: 2px solid #f97316; }
[data-ui="vivid"] .forum-card { background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.07); }
[data-ui="vivid"] .login-btn { background: linear-gradient(135deg,#f97316,#ec4899); }
[data-ui="vivid"] .rail-btn.act, [data-ui="vivid"] .rail-btn:hover { background: rgba(249,115,22,.2); }
[data-ui="vivid"] .dsk-row.act { background: rgba(249,115,22,.1); border-left: 2px solid #f97316; }
[data-ui="vivid"] #deskSidebarHeader { border-bottom-color: rgba(255,255,255,.05); }

/* Active rail indicator line */
[data-ui="glass"] .rail-btn.act::after,
[data-ui="clean"] .rail-btn.act::after,
[data-ui="vivid"] .rail-btn.act::after {
  content:'';position:absolute;left:-2px;
  width:4px;height:24px;border-radius:0 4px 4px 0;
}
[data-ui="glass"] .rail-btn.act::after { background: linear-gradient(180deg,#6c63ff,#a855f7); }
[data-ui="clean"] .rail-btn.act::after { background: #5b9bd5; }
[data-ui="vivid"] .rail-btn.act::after { background: linear-gradient(180deg,#f97316,#ec4899); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üî∑ SVG ƒ∞KON SETƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.ui-icon { width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;display:inline-block;flex-shrink:0; }
.ui-icon-sm { width:16px;height:16px; }
.ui-icon-lg { width:24px;height:24px; }
.ui-icon-box {
  width:40px;height:40px;border-radius:11px;
  display:flex;align-items:center;justify-content:center;
}
.ic-purple{background:rgba(108,99,255,.14);color:#9b8eff;}
.ic-blue  {background:rgba(59,114,192,.14);color:#5b9bd5;}
.ic-teal  {background:rgba(0,188,156,.14); color:#00bca0;}
.ic-orange{background:rgba(249,115,22,.14);color:#fb923c;}
.ic-red   {background:rgba(224,85,85,.14); color:#f07070;}
.ic-green {background:rgba(34,197,94,.14); color:#4ade80;}
.ic-pink  {background:rgba(236,72,153,.14);color:#f472b6;}
.ic-yellow{background:rgba(234,179,8,.14); color:#fbbf24;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üß© UI Bƒ∞LE≈ûEN K√úT√úPHANESƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Butonlar */
.ui-btn { padding:8px 16px;border-radius:9px;font-size:.8rem;font-weight:700;cursor:pointer;border:none;font-family:inherit;transition:all .15s;display:inline-flex;align-items:center;gap:5px; }
.ui-btn-primary { background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 3px 12px rgba(0,0,0,.2); }
.ui-btn-secondary { background:var(--surface2);color:var(--text);border:1px solid var(--border); }
.ui-btn-ghost { background:transparent;color:var(--muted);border:1px solid var(--border); }
.ui-btn-danger { background:rgba(224,85,85,.12);color:#f07070;border:1px solid rgba(224,85,85,.2); }
.ui-btn-success { background:rgba(34,197,94,.1);color:#4ade80;border:1px solid rgba(34,197,94,.2); }
.ui-btn-sm { padding:5px 11px;font-size:.72rem;border-radius:7px; }
.ui-btn:hover { opacity:.88; }
.ui-btn:active { opacity:.75;transform:scale(.97); }

/* Badge'ler */
.ui-badge { padding:2px 9px;border-radius:100px;font-size:.62rem;font-weight:700;letter-spacing:.02em;display:inline-flex;align-items:center;gap:4px; }
.ui-badge-blue   { background:rgba(59,114,192,.15);color:#5b9bd5;border:1px solid rgba(59,114,192,.25); }
.ui-badge-green  { background:rgba(34,197,94,.12); color:#4ade80;border:1px solid rgba(34,197,94,.22); }
.ui-badge-red    { background:rgba(224,85,85,.12); color:#f07070;border:1px solid rgba(224,85,85,.22); }
.ui-badge-purple { background:rgba(108,99,255,.12);color:#9b8eff;border:1px solid rgba(108,99,255,.22); }
.ui-badge-orange { background:rgba(249,115,22,.12);color:#fb923c;border:1px solid rgba(249,115,22,.22); }
.ui-badge-yellow { background:rgba(234,179,8,.12); color:#fbbf24;border:1px solid rgba(234,179,8,.22); }

/* Ayƒ±rƒ±cƒ± */
.ui-divider { height:1px;background:var(--border);margin:10px 0; }

/* Toast bile≈üeni */
.ui-toast { background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:11px 14px;display:flex;align-items:flex-start;gap:10px;font-size:.8rem;box-shadow:0 8px 24px rgba(0,0,0,.4); }
.ui-toast-icon { font-size:1.05rem;flex-shrink:0;margin-top:1px; }
.ui-toast-body { flex:1; }
.ui-toast-title { font-weight:700;color:var(--text-hi);margin-bottom:1px; }
.ui-toast-sub { color:var(--muted);font-size:.72rem; }

/* Emoji tepki √ßubuƒüu */
.ui-react-bar { display:flex;gap:4px;align-items:center;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:5px 10px; }
.ui-react-btn { font-size:.95rem;cursor:pointer;padding:2px 5px;border-radius:7px;transition:background .15s; }
.ui-react-btn:hover,.ui-react-btn.on { background:rgba(108,99,255,.14); }
.ui-react-pill { display:inline-flex;align-items:center;gap:3px;background:rgba(108,99,255,.1);border:1px solid rgba(108,99,255,.22);border-radius:100px;padding:2px 9px;font-size:.68rem;color:#9b8eff; }

/* Kart */
.ui-card { background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px; }

/* UI stili se√ßici card */
.ui-style-card {
  cursor:pointer;border-radius:12px;padding:12px 10px;text-align:center;
  background:var(--surface);border:2px solid transparent;
  transition:all .2s;position:relative;overflow:hidden;
}
.ui-style-card:hover { border-color:rgba(255,255,255,.15); transform:translateY(-2px); }
.ui-style-card.selected { border-color:var(--accent); background:var(--surface2); }
.ui-style-card .ui-style-preview {
  width:100%;height:54px;border-radius:8px;overflow:hidden;margin-bottom:8px;
  display:flex;position:relative;
}
.ui-style-card .ui-style-label { font-size:.72rem;font-weight:700;color:var(--text-hi); }
.ui-style-card .ui-style-desc { font-size:.6rem;color:var(--muted);margin-top:2px; }

.screen{position:fixed;top:0;left:0;right:0;bottom:0;width:100%;height:100%;height:100dvh;display:none;flex-direction:column;background:var(--bg);overflow:hidden;}
.screen.active{display:flex;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#loginScreen{background:linear-gradient(145deg,var(--purple-dark) 0%,var(--bg2) 40%,var(--purple) 70%,var(--purple-dark) 100%);align-items:center;justify-content:center;padding:24px;padding-top:calc(env(safe-area-inset-top,0px) + 24px);overflow-y:auto;z-index:10;position:relative;}
#loginScreen::before{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(ellipse 70% 50% at 50% 0%,rgba(91,155,213,.18) 0%,transparent 70%),radial-gradient(ellipse 50% 40% at 80% 100%,rgba(91,155,213,.1) 0%,transparent 60%);z-index:0;}
#loginScreen>.login-box{position:relative;z-index:1;}
[data-ui="glass"] #loginScreen{background:linear-gradient(145deg,#0d0b20 0%,#13103a 40%,#0f0c29 70%,#0d0b20 100%);}
[data-ui="glass"] #loginScreen::before{background:radial-gradient(ellipse 70% 50% at 50% 0%,rgba(108,99,255,.28) 0%,transparent 70%),radial-gradient(ellipse 50% 40% at 80% 100%,rgba(168,85,247,.15) 0%,transparent 60%);}
[data-ui="clean"] #loginScreen{background:linear-gradient(145deg,#0d0f14 0%,#111418 40%,#0e1016 70%,#0d0f14 100%);}
[data-ui="clean"] #loginScreen::before{background:radial-gradient(ellipse 70% 50% at 50% 0%,rgba(91,155,213,.15) 0%,transparent 70%);}
[data-ui="vivid"] #loginScreen{background:linear-gradient(145deg,#080a10 0%,#0c0e14 40%,#0a0c12 70%,#080a10 100%);}
[data-ui="vivid"] #loginScreen::before{background:radial-gradient(ellipse 70% 50% at 30% 20%,rgba(249,115,22,.2) 0%,transparent 60%),radial-gradient(ellipse 50% 40% at 80% 80%,rgba(236,72,153,.18) 0%,transparent 60%);}
[data-theme="forest"] #loginScreen{background:linear-gradient(145deg,#0d1a0f 0%,#1a2e1c 40%,#0d1a0f 100%);}
[data-theme="ocean"] #loginScreen{background:linear-gradient(145deg,#091520 0%,#0d2235 40%,#091520 100%);}
[data-theme="sunset"] #loginScreen{background:linear-gradient(145deg,#1a0e10 0%,#2d1620 40%,#1a0e10 100%);}
[data-theme="midnight"] #loginScreen{background:linear-gradient(145deg,#080810 0%,#10101e 40%,#080810 100%);}
[data-theme="latte"] #loginScreen{background:linear-gradient(145deg,#e8e0d4 0%,#f5f0e8 40%,#ede5d8 100%);}
.login-box{width:100%;max-width:380px;background:var(--bg2);border-radius:16px;padding:32px 24px;border:1px solid var(--border);}
.login-logo{text-align:center;font-size:3rem;margin-bottom:8px;}
.login-title{text-align:center;font-size:1.4rem;font-weight:900;color:var(--text-hi);margin-bottom:4px;}
.login-sub{text-align:center;font-size:.82rem;color:var(--muted);margin-bottom:24px;}
.login-field{margin-bottom:14px;}
.login-label{font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:5px;}
.login-inp{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:11px 13px;color:var(--text-hi);font-size:.92rem;font-family:inherit;outline:none;transition:border-color .15s;-webkit-appearance:none;}
.login-inp.masked{-webkit-text-security:disc;text-security:disc;}
.login-inp:focus{border-color:#5b9bd5;}
.login-inp::placeholder{color:var(--muted);}
.login-btn{width:100%;padding:13px;background:#2a4a7a;border:none;border-radius:8px;color:#fff;font-size:.95rem;font-weight:900;cursor:pointer;transition:opacity .15s;margin-top:4px;}
.login-btn:active{opacity:.8;}
.login-err{background:rgba(224,30,90,.15);border:1px solid rgba(224,30,90,.3);border-radius:8px;padding:10px 13px;font-size:.82rem;color:#ff6b9d;margin-bottom:14px;display:none;}
.login-err.show{display:block;}
.login-pass-wrap{display:none;margin-bottom:14px;}
.login-pass-wrap.show{display:block;}
.turkish-decoration{text-align:center;font-size:1.4rem;letter-spacing:6px;margin-bottom:10px;opacity:.7;}


#msgsScreen{background:var(--bg2);}
#friendsScreen{background:var(--bg2);}
#profileScreen{background:var(--bg2);}
#msgsScreen .ws-header,#friendsScreen .ws-header,#profileScreen .ws-header{background:var(--purple);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROOMS SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#roomsScreen{background:var(--purple-dark);padding-top:0;padding-bottom:0;}

.ws-header{display:flex;align-items:center;gap:10px;padding:14px 16px 11px;padding-top:calc(14px + env(safe-area-inset-top,0px));background:var(--purple);flex-shrink:0;overflow:hidden;}
.ws-logo{width:30px;height:30px;background:#fff;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.ws-name{flex:1;min-width:0;font-size:1.05rem;font-weight:900;color:#fff;letter-spacing:-.01em;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ws-av{width:32px;height:32px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:900;color:#fff;flex-shrink:0;cursor:pointer;border:2px solid rgba(255,255,255,.3);position:relative;}
.ws-av .sdot{position:absolute;bottom:-3px;right:-3px;width:11px;height:11px;border-radius:50%;background:var(--green);border:2.5px solid var(--purple);}
.admin-badge{background:var(--yellow);color:#000;font-size:.55rem;font-weight:900;border-radius:3px;padding:1px 4px;margin-left:4px;vertical-align:middle;}

.search-row{margin:8px 12px 4px;background:rgba(255,255,255,.11);border:1px solid rgba(255,255,255,.14);border-radius:7px;display:flex;align-items:center;gap:8px;padding:7px 12px;flex-shrink:0;}
.search-row span{font-size:.87rem;color:rgba(255,255,255,.55);font-weight:700;}

.rooms-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:4px 0 6px;}
.rooms-scroll::-webkit-scrollbar{display:none;}

.sec-hdr{display:flex;align-items:center;gap:6px;padding:7px 14px 3px;font-size:.72rem;font-weight:900;color:rgba(255,255,255,.45);text-transform:uppercase;letter-spacing:.06em;cursor:pointer;user-select:none;}
.sec-hdr .chev{font-size:.6rem;transition:transform .2s;}
.sec-add{margin-left:auto;font-size:1.15rem;color:rgba(255,255,255,.4);line-height:1;}



/* ‚îÄ‚îÄ Kanal √ñnizleme Popup Konumlama ‚îÄ‚îÄ */
(function(){
  document.addEventListener('mouseover', function(e){
    const row = e.target.closest('.dsk-row, .r-row');
    if(!row) return;
    const popup = row.querySelector('.room-preview-popup');
    if(!popup) return;
    const rect = row.getBoundingClientRect();
    popup.style.top = Math.min(rect.top, window.innerHeight - 120) + 'px';
    popup.style.left = (rect.right + 8) + 'px';
    popup.style.transform = 'none';
  });
})();

/* ‚îÄ‚îÄ Pull-to-Refresh ‚îÄ‚îÄ */
#ptr-indicator {
  position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--surface2); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem; color: var(--blue); opacity: 0;
  transition: opacity .2s, top .2s;
  z-index: 50; pointer-events: none;
}
#ptr-indicator.ptr-visible { opacity: 1; top: 8px; }
#ptr-indicator.ptr-spinning { animation: ptrSpin .8s linear infinite; }
@keyframes ptrSpin { to { transform: translateX(-50%) rotate(360deg); } }
#roomsList { position: relative; transition: transform .2s; }

.r-row{display:flex;align-items:center;gap:10px;padding:6px 14px;cursor:pointer;transition:background .1s;-webkit-user-select:none;user-select:none;}
.r-row:active{background:rgba(255,255,255,.09);}
.r-row.act{background:rgba(255,255,255,.15);}
.r-row.unread .r-label{color:#fff;font-weight:900;}

.r-icon{width:22px;text-align:center;font-size:.95rem;color:rgba(255,255,255,.5);flex-shrink:0;font-weight:900;}
.r-av{width:22px;height:22px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.58rem;font-weight:900;color:#fff;flex-shrink:0;position:relative;}
.r-dot{position:absolute;bottom:-2px;right:-2px;width:9px;height:9px;border-radius:50%;border:2px solid var(--purple-dark);}
.r-dot.on{background:var(--green);} .r-dot.off{background:var(--muted);}
.r-label{flex:1;font-size:.9rem;font-weight:700;color:rgba(255,255,255,.72);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.r-row.act .r-label{color:#fff;}
.ubadge{background:var(--red);color:#fff;font-size:.62rem;font-weight:900;border-radius:100px;padding:1px 6px;min-width:18px;text-align:center;flex-shrink:0;}

.tab-bar{display:flex;background:var(--purple-dark);border-top:1px solid rgba(255,255,255,.07);flex-shrink:0;padding-bottom:max(var(--safe-bot),8px);backdrop-filter:blur(20px);}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;gap:1px;padding:7px 4px 5px;cursor:pointer;opacity:.45;transition:opacity .2s,transform .15s;user-select:none;position:relative;}
.tab.act{opacity:1;}
.tab.act .tab-ic-wrap{background:rgba(91,155,213,.18);border-radius:10px;}
.tab:active{transform:scale(.92);}
.tab-ic-wrap{width:36px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:10px;transition:background .2s;margin-bottom:1px;}
.tab-ic{font-size:1.25rem;line-height:1;}
.tab-lb{font-size:.58rem;font-weight:700;color:rgba(255,255,255,.7);letter-spacing:.01em;}
.tab.act .tab-lb{color:var(--accent);}
.tab.act::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:24px;height:2.5px;background:var(--accent);border-radius:0 0 3px 3px;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHAT SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#chatScreen{background:var(--bg);padding-top:0;position:relative;}

.c-header{display:flex;align-items:center;gap:10px;padding:9px 12px;padding-top:calc(9px + env(safe-area-inset-top,0px));background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;min-height:52px;}
.back-btn{width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--blue);cursor:pointer;border-radius:6px;transition:background .1s;flex-shrink:0;}
.back-btn:active{background:var(--surface);}
.c-hdr-ic{width:30px;height:30px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:900;color:#fff;flex-shrink:0;}
.c-hdr-body{flex:1;min-width:0;}
.c-hdr-name{font-size:.95rem;font-weight:900;color:var(--text-hi);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* ‚îÄ‚îÄ Kanal √ñnizleme Popup ‚îÄ‚îÄ */
.r-row { position: relative; }

/* ‚îÄ‚îÄ Online Flip Saya√ß ‚îÄ‚îÄ */
.flip-counter {
  display: inline-flex; overflow: hidden; height: 1.2em;
  position: relative; vertical-align: middle;
}
.flip-counter-inner {
  display: flex; flex-direction: column;
  transition: transform .4s cubic-bezier(.34,1.56,.64,1);
}
.flip-counter-digit { height: 1.2em; line-height: 1.2em; font-weight: 700; }

.room-preview-popup {
  display: none; position: fixed; z-index: 9000;
  top: auto; left: auto;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 12px; padding: 10px 14px; min-width: 200px; max-width: 240px;
  box-shadow: 0 8px 32px rgba(0,0,0,.5); pointer-events: none;
  animation: popupFadeIn .15s ease;
}
@keyframes popupFadeIn { from { opacity:0; transform:translateY(-50%) scale(.95); } to { opacity:1; transform:translateY(-50%) scale(1); } }
/* popup JS ile konumlanƒ±yor ‚Äî CSS'te gizle/g√∂ster sadece */
.r-row:hover .room-preview-popup,
.dsk-row:hover .room-preview-popup { display: block; }
.rpp-name { font-size:.78rem; font-weight:700; color:var(--text); margin-bottom:4px; }
.rpp-msg  { font-size:.72rem; color:var(--muted); line-height:1.4; margin-bottom:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.rpp-meta { display:flex; align-items:center; gap:6px; font-size:.65rem; color:var(--muted); }
.rpp-dot  { width:6px; height:6px; border-radius:50%; background:var(--green); }

.c-hdr-sub{font-size:.7rem;color:var(--muted);}
.c-hdr-sub.on{color:var(--green);}
.hdr-btns{display:flex;gap:2px;flex-shrink:0;}
.hdr-btn{width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;border-radius:6px;color:var(--muted);transition:background .1s;}
.hdr-btn:active{background:var(--surface);}

#chatMsgs{flex:1;overflow-y:auto;overflow-x:visible;-webkit-overflow-scrolling:touch;padding:6px 0 4px;display:flex;flex-direction:column;}
#chatMsgs::-webkit-scrollbar{display:none;}

.date-div{display:flex;align-items:center;gap:10px;padding:12px 14px 4px;}
.date-div::before,.date-div::after{content:'';flex:1;height:1px;background:var(--border);}
.date-txt{font-size:.7rem;font-weight:700;color:var(--muted);white-space:nowrap;}

.mb{display:flex;align-items:flex-start;gap:10px;padding:4px 40px 4px 40px;transition:background .1s;position:relative;overflow:visible;}


.mb.first{padding-top:10px;}
.mb.own{flex-direction:row-reverse;}

/* 3-dot mesaj men√ºs√º */
.mb-actions{display:none;position:absolute;top:50%;transform:translateY(-50%);z-index:200;}
.mb.own .mb-actions{right:auto;left:-36px;}
.mb:not(.own) .mb-actions{left:auto;right:-36px;}
.mb:hover .mb-actions{display:flex;}
.mb-more-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.05rem;color:var(--muted);transition:background .15s,color .15s;border-radius:8px;background:var(--surface2);border:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,.4);}
.mb-more-btn:hover{background:var(--surface);color:var(--text-hi);}
.mb-av-menu-btn{display:none;width:28px;height:28px;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;color:var(--muted);transition:background .15s,color .15s;border-radius:8px;flex-shrink:0;align-self:center;background:var(--surface2);border:1px solid var(--border);padding:0;box-shadow:0 2px 8px rgba(0,0,0,.4);line-height:1;}
.mb-av-menu-btn:hover{background:var(--border);}
.mb:hover .mb-av-menu-btn{display:flex;}

/* mb-actions eski sistemi gizle */
.mb-actions{display:none !important;}
.mb-react-quick{display:flex;gap:0px;padding:0 2px;}
.mb-react-quick span{font-size:1.15rem;cursor:pointer;padding:3px 7px;border-radius:7px;line-height:1;transition:background .12s, transform .15s;display:inline-block;}
.mb-react-quick span:hover{background:var(--border);transform:scale(1.35);}
.mb-react-quick span:active{transform:scale(.85);}
.mb-react-quick span.emoji-bounce{animation:emojiBounce .35s cubic-bezier(.34,1.56,.64,1);}
@keyframes emojiBounce{0%{transform:scale(1)}40%{transform:scale(1.5) rotate(-8deg)}70%{transform:scale(.9)}100%{transform:scale(1)}}
.mb-action-sep{width:1px;background:var(--border);height:18px;margin:0 2px;}
/* Context menu */
#msgCtxMenu{display:none;position:fixed;z-index:99999;}
#msgCtxMenu.show{display:block;}
.ctx-item{display:flex;align-items:center;gap:10px;padding:9px 12px;cursor:pointer;border-radius:6px;font-size:.88rem;color:var(--text);transition:background .1s;white-space:nowrap;}
.ctx-item:hover{background:var(--border);}
.ctx-item.danger{color:var(--red);}
/* Emoji tepkiler */
.msg-reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:5px;}
.react-pill{display:flex;align-items:center;gap:3px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;padding:2px 8px;font-size:.82rem;cursor:pointer;transition:all .15s;user-select:none;}
.react-pill:hover{background:rgba(91,155,213,.15);border-color:rgba(91,155,213,.4);}
.react-pill.mine{background:rgba(91,155,213,.2);border-color:rgba(91,155,213,.5);}
.react-count{font-size:.75rem;font-weight:700;color:var(--text-hi);}
/* Sabitlenmi≈ü mesaj √ßubuƒüu */
#pinBar{display:none;align-items:center;gap:8px;background:var(--surface);border-bottom:2px solid var(--blue);padding:7px 14px;cursor:pointer;flex-shrink:0;transition:background .15s;}
#pinBar.show{display:flex;}
#pinBar:hover{background:var(--surface2);}
.pin-icon{font-size:1rem;color:var(--blue);flex-shrink:0;}
.pin-text{flex:1;font-size:.78rem;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pin-label{font-size:.68rem;font-weight:900;color:var(--blue);text-transform:uppercase;letter-spacing:.05em;flex-shrink:0;}
.pin-close{font-size:1rem;color:var(--muted);cursor:pointer;padding:2px 6px;border-radius:4px;}
.pin-close:hover{background:var(--border);}
/* D√ºzenleme modu */
.msg-edit-wrap{display:flex;gap:6px;margin-top:4px;align-items:flex-end;}
.msg-edit-inp{flex:1;background:var(--surface);border:1px solid var(--blue);border-radius:8px;padding:6px 10px;color:var(--text-hi);font-family:inherit;font-size:.9rem;resize:none;outline:none;max-height:120px;}
.msg-edit-btns{display:flex;gap:4px;flex-shrink:0;}
.msg-edit-ok{padding:6px 12px;background:var(--blue);border:none;border-radius:6px;color:#fff;font-size:.8rem;font-weight:700;cursor:pointer;}
.msg-edit-cancel{padding:6px 10px;background:var(--surface2);border:none;border-radius:6px;color:var(--muted);font-size:.8rem;cursor:pointer;}

.av{width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:900;color:#fff;flex-shrink:0;margin-top:1px;}
.av.ghost{visibility:hidden;}

.mb-body{flex:1;min-width:0;position:relative;}
.mb.own .mb-body{display:flex;flex-direction:column;align-items:flex-end;}
.mb-meta{display:flex;align-items:baseline;gap:8px;margin-bottom:2px;}
.mb.own .mb-meta{flex-direction:row-reverse;}
.mb-meta-mini{display:flex;justify-content:flex-end;margin-bottom:1px;margin-top:-2px;}
.mb-name{font-size:.88rem;font-weight:900;color:var(--text-hi);}
.mb.own .mb-name{color:var(--blue);}
.mb-ts{font-size:.68rem;color:var(--muted);}

/* Balon ≈üekilleri ‚Äî yumu≈üak, b√ºk√ºlme yok */
.mb-text{font-size:.9rem;color:var(--text-hi);line-height:1.5;word-break:break-word;white-space:pre-wrap;background:var(--incoming-bg,#263045);border-radius:4px 14px 14px 14px;padding:8px 13px;display:inline-block;max-width:80%;}
.mb-text a{color:var(--accent);text-decoration:none;}
.ob{background:var(--own-bg);color:#fff;border-radius:14px 4px 14px 14px;padding:8px 13px;font-size:.9rem;line-height:1.5;word-break:break-word;white-space:pre-wrap;max-width:80%;display:inline-block;}
.ob a{color:#7ec8e3;}

.msg-sys{text-align:center;font-size:.73rem;color:var(--muted);padding:4px 14px;}
.msg-img{max-width:min(260px,70vw);border-radius:8px;cursor:pointer;display:block;margin-top:4px;border:1px solid var(--border);}
.msg-file-card{display:flex;align-items:center;gap:10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;max-width:260px;margin-top:4px;text-decoration:none;cursor:pointer;}
.msg-file-icon{font-size:1.5rem;flex-shrink:0;}
.msg-file-info{flex:1;min-width:0;}
.msg-file-name{font-size:.8rem;font-weight:700;color:var(--text-hi);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.msg-file-size{font-size:.68rem;color:var(--muted);}

.empty-chat{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:40px 24px;text-align:center;}
.empty-ic{font-size:3rem;margin-bottom:4px;}
.empty-title{font-size:1.05rem;font-weight:900;color:var(--text-hi);}
.empty-sub{font-size:.82rem;color:var(--muted);line-height:1.5;}

.inp-wrap{flex-shrink:0;padding:8px 12px;padding-bottom:calc(8px + env(safe-area-inset-bottom,0px));background:var(--bg2);border-top:1px solid var(--border);}
.inp-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;}
#msgInp{width:100%;background:transparent;border:none;outline:none;color:var(--text-hi);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;font-size:.92rem;line-height:1.46;padding:10px 12px 6px;resize:none;max-height:120px;-webkit-appearance:none;}
#msgInp::placeholder{color:var(--muted);}
.inp-btm{display:flex;align-items:center;padding:4px 8px 7px;gap:2px;border-top:1px solid var(--border);}
.ii{width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:1.05rem;cursor:pointer;border-radius:6px;color:var(--muted);transition:background .1s;}
.ii:active{background:var(--surface2);}
.send-btn{width:32px;height:32px;background:var(--green);border:none;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1rem;cursor:pointer;color:#fff;margin-left:auto;flex-shrink:0;transition:opacity .15s,transform .1s;}
.send-btn:active{opacity:.8;transform:scale(.9);}
.send-btn:disabled{opacity:.3;}

#emojiPicker{display:none;background:var(--bg2);border-top:1px solid var(--border);padding:0;max-height:320px;overflow:hidden;flex-direction:column;}
#emojiPicker.open{display:flex;}
.eg{display:grid;grid-template-columns:repeat(10,1fr);gap:1px;}
.eb{font-size:1.35rem;padding:3px;border-radius:6px;text-align:center;cursor:pointer;}
.eb:active{background:var(--surface2);}
.ec{font-size:.6rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;padding:6px 0 2px;grid-column:1/-1;font-weight:900;}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTOM SHEETS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.bs-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;align-items:flex-end;justify-content:center;}
.bs-back.open{display:flex;}
.bs{width:100%;max-width:500px;background:var(--bg2);border-radius:16px 16px 0 0;padding:16px;padding-bottom:calc(16px + var(--safe-bot));max-height:82vh;display:flex;flex-direction:column;animation:sup .22s ease;}
@keyframes sup{from{transform:translateY(100%);}to{transform:translateY(0);}}
.bs-handle{width:32px;height:3px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.bs-title{font-size:.95rem;font-weight:900;color:var(--text-hi);margin-bottom:12px;}
.bs-search{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 13px;color:var(--text-hi);font-size:.9rem;font-family:inherit;outline:none;width:100%;margin-bottom:10px;-webkit-appearance:none;}
.bs-search::placeholder{color:var(--muted);}
.bs-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;}

.dm-row{display:flex;align-items:center;gap:12px;padding:9px 4px;cursor:pointer;border-radius:8px;transition:background .1s;}
.dm-close-btn{display:none;width:22px;height:22px;border-radius:5px;align-items:center;justify-content:center;font-size:.75rem;color:rgba(255,255,255,.5);background:rgba(255,255,255,.08);flex-shrink:0;transition:background .15s,color .15s;margin-left:auto;}
.dm-close-btn:hover{background:var(--red);color:#fff;}
.dm-row:hover .dm-close-btn{display:flex;}
.dsk-dm-close{display:none;width:20px;height:20px;border-radius:4px;align-items:center;justify-content:center;font-size:.7rem;color:rgba(255,255,255,.45);background:transparent;flex-shrink:0;transition:background .15s,color .15s;margin-left:auto;}
.dsk-dm-close:hover{background:var(--red) !important;color:#fff !important;}
.dsk-dm-row:hover .dsk-dm-close{display:flex;}
.dm-row:active{background:var(--surface);}
.dm-av{width:38px;height:38px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.78rem;font-weight:900;color:#fff;flex-shrink:0;position:relative;}
.dm-av .r-dot{position:absolute;bottom:-2px;right:-2px;width:9px;height:9px;border-radius:50%;border:2px solid var(--bg2);}
.dm-name{font-size:.9rem;font-weight:700;color:var(--text-hi);}
.dm-status{font-size:.73rem;color:var(--muted);}

.prof-av{width:64px;height:64px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:900;color:#fff;margin:0 auto 12px;}
.prof-name{font-size:1.05rem;font-weight:900;color:var(--text-hi);text-align:center;margin-bottom:2px;}
.prof-sub{font-size:.8rem;color:var(--muted);text-align:center;margin-bottom:18px;}
.prof-div{height:1px;background:var(--border);margin:0 0 10px;}
.prof-act{display:flex;align-items:center;gap:12px;padding:11px 4px;cursor:pointer;border-radius:8px;transition:background .1s;}
.prof-act:active{background:var(--surface);}
.prof-act-ic{font-size:1.1rem;width:24px;text-align:center;}
.prof-act-lb{font-size:.9rem;font-weight:700;color:var(--text-hi);}
.prof-act.danger .prof-act-lb{color:var(--red);}
.prof-act.admin-action .prof-act-lb{color:var(--yellow);}

#imgOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:999;align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:20px;}
#imgOverlay.open{display:flex;}
#imgOverlayImg{max-width:100%;max-height:80vh;border-radius:8px;object-fit:contain;}
.img-close{position:absolute;top:calc(var(--safe-top)+12px);right:16px;font-size:1.2rem;cursor:pointer;color:#fff;background:rgba(255,255,255,.15);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;}

#toast{position:fixed;bottom:calc(90px + var(--safe-bot));left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 16px;font-size:.82rem;color:var(--text-hi);font-weight:700;z-index:999;opacity:0;transition:opacity .25s;pointer-events:none;white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,.5);}
#toast.show{opacity:1;}

.ld{display:none !important;}
.ld span{width:7px;height:7px;border-radius:50%;background:var(--muted);animation:ldot 1.2s infinite;}
.ld span:nth-child(2){animation-delay:.15s;} .ld span:nth-child(3){animation-delay:.3s;}
@keyframes ldot{0%,80%,100%{transform:scale(.7);opacity:.4;}40%{transform:scale(1);opacity:1;}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#adminPanel{background:var(--bg);padding-top:0;z-index:100;}

/* Header */
.admin-header{display:flex;align-items:center;gap:10px;padding:10px 14px;padding-top:calc(10px + env(safe-area-inset-top,0px));background:linear-gradient(135deg,#2d1b4e 0%,#3f0e40 60%,#1a1230 100%);border-bottom:1px solid rgba(255,255,255,.08);flex-shrink:0;box-shadow:0 2px 16px rgba(0,0,0,.4);}
.admin-title{flex:1;font-size:1.05rem;font-weight:900;color:#fff;letter-spacing:.01em;}
.admin-close{width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;color:rgba(255,255,255,.6);cursor:pointer;border-radius:8px;background:rgba(255,255,255,.08);transition:all .15s;}
.admin-close:hover{background:rgba(255,255,255,.18);color:#fff;}

/* Tabs */
.admin-tabs{display:flex;background:var(--surface);border-bottom:2px solid var(--border);flex-shrink:0;overflow-x:auto;gap:2px;padding:0 6px;scrollbar-width:none;}
.admin-tabs::-webkit-scrollbar{display:none;}
.atab{display:flex;flex-direction:column;align-items:center;gap:3px;padding:9px 10px 8px;text-align:center;font-size:.65rem;font-weight:800;color:var(--muted);cursor:pointer;border-bottom:2.5px solid transparent;transition:all .18s;letter-spacing:.03em;white-space:nowrap;flex-shrink:0;}
.atab .atab-icon{font-size:1.1rem;transition:transform .18s;}
.atab:hover{color:var(--text);background:rgba(255,255,255,.04);border-radius:8px 8px 0 0;}
.atab.act{color:#c4a7ff;border-bottom-color:#9b72ff;}
.atab.act .atab-icon{transform:scale(1.15);}

/* Body */
.admin-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;}
#deskAdminTabs::-webkit-scrollbar{height:0;display:none;}
#deskAdminTabs div:hover{background:var(--surface2) !important;color:var(--text) !important;}
.admin-body::-webkit-scrollbar{display:none;}

/* Sections */
.admin-section{margin-bottom:20px;}
.admin-sec-title{font-size:.7rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.admin-sec-title::before{content:'';display:inline-block;width:3px;height:12px;background:var(--accent);border-radius:2px;}

/* Cards */
.admin-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:10px;box-shadow:0 1px 6px rgba(0,0,0,.2);}

/* Rows */
.admin-row{display:flex;align-items:center;gap:12px;padding:11px 14px;border-bottom:1px solid rgba(255,255,255,.04);}
.admin-row:last-child{border-bottom:none;}
.admin-row:hover{background:rgba(255,255,255,.02);}
.admin-row-av{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:900;color:#fff;flex-shrink:0;}
.admin-row-info{flex:1;min-width:0;}
.admin-row-name{font-size:.88rem;font-weight:700;color:var(--text-hi);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.admin-row-sub{font-size:.7rem;color:var(--muted);margin-top:1px;}
.admin-row-btns{display:flex;gap:5px;flex-shrink:0;flex-wrap:wrap;}

/* Buttons */
.a-btn{padding:5px 11px;border:none;border-radius:7px;font-size:.72rem;font-weight:800;cursor:pointer;transition:all .15s;letter-spacing:.01em;}
.a-btn:hover{filter:brightness(1.15);}
.a-btn:active{transform:scale(.95);}
.a-btn.red{background:rgba(224,30,90,.18);color:#ff5a8a;border:1px solid rgba(224,30,90,.25);}
.a-btn.green{background:rgba(46,182,125,.15);color:#2eb67d;border:1px solid rgba(46,182,125,.2);}
.a-btn.yellow{background:rgba(236,178,46,.15);color:#f0c040;border:1px solid rgba(236,178,46,.2);}
.a-btn.blue{background:rgba(91,155,213,.15);color:#5b9bd5;border:1px solid rgba(91,155,213,.2);}
.a-btn.purple{background:rgba(155,114,255,.15);color:#c4a7ff;border:1px solid rgba(155,114,255,.2);}

/* Inputs */
.admin-inp{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:10px 13px;color:var(--text-hi);font-size:.88rem;font-family:inherit;outline:none;margin-bottom:10px;-webkit-appearance:none;transition:border-color .15s;}
.admin-inp:focus{border-color:#9b72ff;box-shadow:0 0 0 3px rgba(155,114,255,.12);}
.admin-inp::placeholder{color:var(--muted);}
.admin-inp-row{display:flex;gap:8px;margin-bottom:10px;}
.admin-inp-row .admin-inp{margin-bottom:0;}

/* Submit */
.admin-submit{width:100%;padding:12px;background:linear-gradient(135deg,#9b72ff,#6c3fce);border:none;border-radius:9px;color:#fff;font-size:.9rem;font-weight:900;cursor:pointer;transition:all .18s;box-shadow:0 2px 12px rgba(155,114,255,.25);}
.admin-submit:hover{filter:brightness(1.1);box-shadow:0 4px 18px rgba(155,114,255,.35);}
.admin-submit:active{transform:scale(.98);}

/* Radio */
.admin-radio-group{display:flex;gap:8px;margin-bottom:12px;}
.admin-radio{flex:1;padding:9px;background:var(--surface);border:2px solid var(--border);border-radius:9px;text-align:center;cursor:pointer;font-size:.82rem;font-weight:700;color:var(--muted);transition:all .15s;}
.admin-radio.sel{border-color:#9b72ff;color:#c4a7ff;background:rgba(155,114,255,.1);}

/* Tags */
.banned-tag{background:rgba(224,30,90,.2);color:#ff5a8a;font-size:.63rem;font-weight:900;border-radius:5px;padding:2px 7px;margin-left:6px;border:1px solid rgba(224,30,90,.2);}
.admin-tag{background:rgba(236,178,46,.2);color:var(--yellow);font-size:.63rem;font-weight:900;border-radius:5px;padding:2px 7px;margin-left:6px;border:1px solid rgba(236,178,46,.2);}
.online-tag{background:rgba(46,182,125,.15);color:#2eb67d;font-size:.63rem;font-weight:900;border-radius:5px;padding:2px 7px;margin-left:6px;border:1px solid rgba(46,182,125,.2);}

/* Msg panel */
.admin-msg-room{font-size:.68rem;color:#9b72ff;margin-bottom:2px;font-weight:700;}
.admin-msg-text{font-size:.84rem;color:var(--text);line-height:1.4;word-break:break-word;}
.admin-msg-meta{display:flex;align-items:center;gap:8px;margin-top:4px;}
.admin-msg-user{font-size:.72rem;font-weight:800;color:var(--blue);}
.admin-msg-ts{font-size:.67rem;color:var(--muted);}

/* Stat cards */
.admin-stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px;}
.admin-stat-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:4px;position:relative;overflow:hidden;}
.admin-stat-card::before{content:'';position:absolute;top:-10px;right:-10px;width:50px;height:50px;border-radius:50%;opacity:.07;}
.admin-stat-val{font-size:1.7rem;font-weight:900;line-height:1;}
.admin-stat-label{font-size:.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:.04em;}

/* Announce */
.announce-select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:10px 13px;color:var(--text-hi);font-size:.88rem;font-family:inherit;outline:none;margin-bottom:10px;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a8b8c' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;}
.announce-textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:10px 13px;color:var(--text-hi);font-size:.88rem;font-family:inherit;outline:none;resize:none;min-height:100px;margin-bottom:10px;-webkit-appearance:none;transition:border-color .15s;}
.announce-textarea:focus,.announce-select:focus,.admin-inp:focus{border-color:#9b72ff;}
.announce-textarea::placeholder{color:var(--muted);}

/* Toggle switch */
.admin-toggle{position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0;}
.admin-toggle input{opacity:0;width:0;height:0;}
.admin-toggle-slider{position:absolute;inset:0;background:var(--surface2);border-radius:100px;cursor:pointer;transition:.25s;border:1px solid var(--border);}
.admin-toggle-slider:before{position:absolute;content:'';height:18px;width:18px;left:2px;bottom:2px;background:#fff;border-radius:50%;transition:.25s;box-shadow:0 1px 4px rgba(0,0,0,.3);}
.admin-toggle input:checked + .admin-toggle-slider{background:linear-gradient(135deg,#9b72ff,#6c3fce);border-color:#9b72ff;}
.admin-toggle input:checked + .admin-toggle-slider:before{transform:translateX(20px);}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FRIENDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.fr-row{display:flex;align-items:center;gap:12px;padding:10px 4px;border-radius:8px;transition:background .1s;}
.fr-row:active{background:var(--surface);}
.fr-av{width:42px;height:42px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.82rem;font-weight:900;color:#fff;flex-shrink:0;position:relative;}
.fr-av .r-dot{position:absolute;bottom:-2px;right:-2px;width:10px;height:10px;border-radius:50%;border:2px solid var(--bg2);}
.fr-info{flex:1;min-width:0;}
.fr-name{font-size:.9rem;font-weight:700;color:var(--text-hi);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.fr-status{font-size:.72rem;color:var(--muted);}
.fr-btns{display:flex;gap:6px;flex-shrink:0;}
.fr-btn{padding:6px 12px;border:none;border-radius:7px;font-size:.75rem;font-weight:900;cursor:pointer;transition:opacity .15s;}
.fr-btn:active{opacity:.7;}
.fr-btn.msg{background:var(--blue);color:#fff;}
.fr-btn.remove{background:rgba(224,30,90,.15);color:var(--red);}
.fr-btn.accept{background:var(--green);color:#fff;}
.fr-btn.reject{background:rgba(224,30,90,.15);color:var(--red);}
.fr-btn.add{background:rgba(29,155,209,.15);color:var(--blue);}
.fr-btn.pending{background:var(--surface2);color:var(--muted);cursor:default;}
.fr-section-title{font-size:.7rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;padding:12px 4px 6px;}
.notif-dot{position:absolute;top:-2px;right:-2px;width:9px;height:9px;border-radius:50%;background:var(--red);border:2px solid var(--purple-dark);display:none;}
.notif-dot.show{display:block;}
.tab-wrap{position:relative;flex:1;display:flex;flex-direction:column;align-items:center;}
.fr-empty{text-align:center;padding:32px 16px;color:var(--muted);font-size:.85rem;line-height:1.6;}
.ltab{flex:1;padding:8px 6px;text-align:center;font-size:.78rem;font-weight:700;color:var(--muted);cursor:pointer;border-radius:6px;transition:all .15s;}
.ltab.act{background:var(--surface2);color:var(--text-hi);}
.ltab:active{opacity:.7;}

.fr-empty-ic{font-size:2.5rem;margin-bottom:8px;}

/* ‚ïê‚ïê CALL ‚ïê‚ïê */
.wave-bar{width:4px;border-radius:4px;background:#5b9bd5;animation:wave 1.2s ease-in-out infinite;}
.wave-bar:nth-child(1){animation-delay:0s;height:10px;}
.wave-bar:nth-child(2){animation-delay:.2s;height:20px;}
.wave-bar:nth-child(3){animation-delay:.4s;height:28px;}
.wave-bar:nth-child(4){animation-delay:.2s;height:20px;}
.wave-bar:nth-child(5){animation-delay:0s;height:10px;}
@keyframes wave{0%,100%{transform:scaleY(1);}50%{transform:scaleY(1.8);}}


/* ‚ïê‚ïê MEDIA EMBED ‚ïê‚ïê */
.media-embed{margin-top:8px;border-radius:10px;overflow:hidden;max-width:min(320px,80vw);}
.media-embed iframe{width:100%;aspect-ratio:16/9;border:none;display:block;}
.media-embed-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;max-width:min(320px,80vw);margin-top:8px;text-decoration:none;display:block;}
.media-embed-thumb{width:100%;aspect-ratio:16/9;object-fit:cover;display:block;}
.media-embed-info{padding:8px 10px;}
.media-embed-title{font-size:.82rem;font-weight:700;color:var(--text-hi);line-height:1.4;}
.media-embed-src{font-size:.68rem;color:var(--muted);margin-top:2px;}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FORUM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.fcat{background:var(--surface);border:1px solid var(--border);border-radius:100px;padding:5px 12px;font-size:.72rem;font-weight:700;color:var(--muted);cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0;}
.fcat.act{background:#5b9bd5;border-color:#5b9bd5;color:#fff;}
.fcat:active{opacity:.7;}

.forum-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px;transition:background .1s;}
.forum-card:active{background:var(--surface);}
.forum-card-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.forum-card-av{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:900;color:#fff;flex-shrink:0;}
.forum-card-meta{flex:1;min-width:0;}
.forum-card-user{font-size:.88rem;font-weight:900;color:var(--text-hi);}
.forum-card-time{font-size:.68rem;color:var(--muted);}
.forum-card-cat{font-size:.65rem;font-weight:700;background:var(--surface);border:1px solid var(--border);border-radius:100px;padding:2px 8px;color:var(--muted);}
.forum-card-text{font-size:.9rem;color:var(--text);line-height:1.6;word-break:break-word;margin-bottom:12px;}
.forum-card-text blockquote{border-left:3px solid var(--accent);padding-left:10px;margin:6px 0;color:var(--muted);font-style:italic;}
.forum-card-text code{background:var(--surface2);border-radius:4px;padding:1px 5px;font-family:monospace;font-size:.85em;}
.forum-card-text ul,.forum-card-text ol{padding-left:20px;margin:4px 0;}
.forum-card-text a{color:var(--accent);text-decoration:underline;}
.bb-spoiler{background:var(--surface2);color:transparent;border-radius:4px;padding:1px 5px;cursor:pointer;user-select:none;transition:color .2s;}
.bb-spoiler.revealed{color:var(--text-hi);}
.bb-spoiler:not(.revealed)::after{content:'üëÅ Spoiler - g√∂rmek i√ßin tƒ±kla';color:var(--muted);font-size:.8rem;}
.forum-card-actions{display:flex;gap:14px;align-items:center;border-top:1px solid var(--border);padding-top:10px;}
.forum-action-btn{display:flex;align-items:center;gap:5px;font-size:.78rem;color:var(--muted);cursor:pointer;padding:4px 8px;border-radius:6px;transition:background .1s;user-select:none;}
.forum-action-btn:active{background:var(--surface2);}
.forum-action-btn.liked{color:#e05555;}
.forum-action-btn.disliked{color:#5b9bd5;}
.forum-comment-actions{display:flex;align-items:center;gap:4px;margin-top:5px;}
.com-act-btn{display:flex;align-items:center;gap:3px;font-size:.72rem;color:var(--muted);cursor:pointer;padding:2px 6px;border-radius:5px;transition:background .1s;user-select:none;}
.com-act-btn:active{background:var(--surface2);}
.com-act-btn.liked{color:#e05555;}
.com-act-btn.disliked{color:#5b9bd5;}
.forum-del-btn{margin-left:auto;font-size:.78rem;color:var(--muted);cursor:pointer;padding:4px 8px;border-radius:6px;transition:background .1s;}
.forum-del-btn:active{background:var(--surface2);}
.forum-comments{margin-top:10px;border-top:1px solid var(--border);padding-top:10px;}
.forum-comment{display:flex;gap:8px;margin-bottom:8px;}
.forum-comment-av{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:900;color:#fff;flex-shrink:0;}
.forum-comment-body{flex:1;background:var(--surface);border-radius:8px;padding:7px 10px;}
.forum-comment-user{font-size:.75rem;font-weight:900;color:var(--text-hi);margin-bottom:2px;}
.forum-comment-text{font-size:.82rem;color:var(--text);line-height:1.5;}
.forum-comment-inp-row{display:flex;gap:8px;align-items:center;margin-top:8px;}
.forum-comment-inp{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:7px 11px;color:var(--text-hi);font-size:.82rem;font-family:inherit;outline:none;-webkit-appearance:none;}
.forum-comment-inp::placeholder{color:var(--muted);}
.forum-send-btn{width:30px;height:30px;background:#5b9bd5;border:none;border-radius:7px;color:#fff;font-size:.85rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DESKTOP LAYOUT  (min-width: 768px)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media (min-width: 768px) {
  /* Hide mobile tab-bars */
  .tab-bar { display: none !important; }

  /* Login stays centered */
  #loginScreen { padding: 0; }

  /* ‚îÄ‚îÄ Desktop Shell ‚îÄ‚îÄ */
  #desktopShell {
    position: fixed; inset: 0;
    flex-direction: row;
    background: var(--bg);
  }

  /* ‚îÄ‚îÄ Icon Rail (far left, like Discord) ‚îÄ‚îÄ */
  #deskRail {
    width: 68px;
    background: #1a1d21;
    display: flex; flex-direction: column;
    align-items: center;
    padding: 12px 0;
    gap: 6px;
    flex-shrink: 0;
    border-right: 1px solid rgba(255,255,255,.06);
    overflow-y: auto;
    overflow-x: hidden;
  }
  #deskRail::-webkit-scrollbar { display: none; }

  .rail-logo {
    width: 44px; height: 44px;
    background: var(--purple);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem;
    cursor: pointer;
    margin-bottom: 6px;
    transition: border-radius .2s;
    flex-shrink: 0;
  }
  .rail-logo:hover { border-radius: 50%; }


  .rail-sep {
    width: 32px; height: 2px;
    background: rgba(255,255,255,.1);
    border-radius: 1px;
    margin: 2px 0;
    flex-shrink: 0;
  }

  .rail-btn {
    width: 44px; height: 44px;
    border-radius: 50%;
    background: var(--surface);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    cursor: pointer;
    transition: border-radius .2s, background .15s;
    position: relative;
    flex-shrink: 0;
    gap: 1px;
  }
  .rail-btn:hover { border-radius: 14px; background: var(--blue); }
  .rail-btn.act { border-radius: 14px; background: var(--blue); }
  .rail-btn-ic { font-size: 1.2rem; line-height: 1; }
  .rail-btn-lb { font-size: .45rem; font-weight: 900; color: rgba(255,255,255,.5); letter-spacing: .03em; text-transform: uppercase; display: none; }
  .rail-btn.act .rail-btn-lb { color: #fff; }
  .rail-btn .notif-pill {
    position: absolute; bottom: 0; right: 0;
    background: var(--red); color: #fff;
    font-size: .5rem; font-weight: 900;
    border-radius: 100px; padding: 1px 4px;
    border: 2px solid #1a1d21;
  }

  /* User avatar at bottom of rail */
  #deskRailUser {
    margin-top: auto;
    width: 44px; height: 44px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: .72rem; font-weight: 900; color: #fff;
    cursor: pointer;
    flex-shrink: 0;
    position: relative;
    border: 2px solid rgba(255,255,255,.2);
    transition: border-radius .2s;
  }
  #deskRailUser:hover { border-radius: 14px; }
  #deskRailUser .sdot {
    position: absolute; bottom: -2px; right: -2px;
    width: 12px; height: 12px;
    border-radius: 50%; background: var(--green);
    border: 2.5px solid #1a1d21;
  }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  #deskSidebar {
    width: 260px;
    background: #222529;
    display: flex; flex-direction: column;
    flex-shrink: 0;
    border-right: 1px solid rgba(255,255,255,.06);
    overflow: hidden;
  }

  #deskSidebarHeader {
    padding: 14px 16px 10px;
    border-bottom: 1px solid rgba(255,255,255,.08);
    flex-shrink: 0;
  }
  #deskSidebarTitle {
    font-size: 1rem; font-weight: 900; color: var(--text-hi);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  #deskSidebarSub {
    font-size: .72rem; color: var(--muted); margin-top: 2px;
  }

  #deskSearch {
    margin: 8px 10px;
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: 7px;
    display: flex; align-items: center; gap: 7px;
    padding: 7px 10px;
    flex-shrink: 0;
    cursor: text;
  }
  #deskSearch span { font-size: .82rem; color: var(--muted); }
  #deskSearchInp {
    background: none; border: none; outline: none;
    color: var(--text-hi); font-size: .82rem;
    font-family: inherit; flex: 1; min-width: 0;
  }
  #deskSearchInp::placeholder { color: var(--muted); }

  #deskSideList {
    flex: 1; overflow-y: auto;
    padding: 4px 0 12px;
  }
  #deskSideList::-webkit-scrollbar { width: 4px; }
  #deskSideList::-webkit-scrollbar-track { background: transparent; }
  #deskSideList::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); border-radius: 2px; }

  .dsk-sec-hdr {
    display: flex; align-items: center;
    padding: 14px 10px 4px 12px;
    font-size: .7rem; font-weight: 900;
    color: rgba(255,255,255,.4);
    text-transform: uppercase; letter-spacing: .07em;
    cursor: pointer;
    user-select: none;
  }
  .dsk-sec-hdr .chev { font-size: .6rem; margin-right: 4px; transition: transform .15s; }
  .dsk-sec-hdr .sec-add-btn {
    margin-left: auto;
    width: 18px; height: 18px;
    border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    font-size: .9rem; color: rgba(255,255,255,.4);
    transition: background .15s, color .15s;
  }
  .dsk-sec-hdr .sec-add-btn:hover { background: rgba(255,255,255,.1); color: #fff; }

  .dsk-row {
    display: flex; align-items: center; gap: 8px;
    padding: 3px 10px 3px 12px;
    cursor: pointer;
    border-radius: 6px;
    margin: 0 6px;
    transition: background .1s;
    min-height: 32px;
    position: relative;
    overflow: visible;
  }
  .dsk-row:hover { background: rgba(255,255,255,.07); }
  .dsk-row.act { background: rgba(255,255,255,.14); }
  .dsk-row.act .dsk-row-name { color: #fff; font-weight: 700; }

  .dsk-row-ic {
    width: 18px; text-align: center;
    font-size: .85rem; color: rgba(255,255,255,.45);
    flex-shrink: 0;
  }
  .dsk-row-av {
    width: 24px; height: 24px;
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: .6rem; font-weight: 900; color: #fff;
    flex-shrink: 0; position: relative;
  }
  .dsk-row-av .r-dot {
    width: 8px; height: 8px;
    border: 2px solid #222529;
  }
  .dsk-row-name {
    flex: 1; font-size: .87rem;
    color: rgba(255,255,255,.6);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .dsk-row.act .dsk-row-name,
  .dsk-row:hover .dsk-row-name { color: rgba(255,255,255,.9); }
  .dsk-row-badge {
    background: var(--red); color: #fff;
    font-size: .58rem; font-weight: 900;
    border-radius: 100px; padding: 1px 5px;
    min-width: 16px; text-align: center;
  }
  .dsk-spy-tag {
    background: rgba(245,166,35,.2); color: #f5a623;
    font-size: .55rem; font-weight: 900;
    border-radius: 4px; padding: 1px 4px;
  }

  /* ‚îÄ‚îÄ Main Chat Area ‚îÄ‚îÄ */
  #deskMain {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
    background: var(--bg);
  }

  /* Desktop chat header */
  #deskChatHeader {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 20px;
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0; min-height: 54px;
  }
  #deskChatHdrIcon {
    width: 32px; height: 32px; border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    font-size: .78rem; font-weight: 900; color: #fff;
    flex-shrink: 0;
  }
  #deskChatHdrName {
    font-size: 1rem; font-weight: 900; color: var(--text-hi);
  }
  #deskChatHdrSub {
    font-size: .75rem; color: var(--muted);
    margin-left: 10px;
  }
  .dsk-hdr-actions {
    margin-left: auto; display: flex; gap: 6px; align-items: center;
  }
  .dsk-hdr-btn {
    width: 34px; height: 34px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 1rem;
    color: var(--muted);
    transition: background .12s, color .12s;
  }
  .dsk-hdr-btn:hover { background: var(--surface2); color: var(--text-hi); }

  /* Desktop empty state */
  #deskEmptyState {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    color: var(--muted);
    gap: 12px;
  }
  #deskEmptyState .big-ic { font-size: 4rem; }
  #deskEmptyState .big-title { font-size: 1.2rem; font-weight: 900; color: var(--text-hi); }
  #deskEmptyState .big-sub { font-size: .85rem; max-width: 300px; text-align: center; }

  /* Desktop messages area */
  #deskMsgs {
    flex: 1; overflow-y: auto;
    padding: 12px 20px 4px;
    -webkit-overflow-scrolling: touch;
    position: relative;
  }
  #deskMsgs::-webkit-scrollbar { width: 6px; }
  #deskMsgs::-webkit-scrollbar-track { background: transparent; }
  #deskMsgs::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); border-radius: 3px; }

  /* Desktop spy banner */
  #deskSpyBanner {
    display: none;
    background: rgba(245,166,35,.1);
    border-bottom: 1px solid rgba(245,166,35,.2);
    padding: 8px 20px;
    align-items: center; gap: 10px;
    flex-shrink: 0;
  }

  /* Desktop input */
  #deskInputArea {
    padding: 10px 20px 16px;
    background: var(--bg);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  #deskInputBox {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    display: flex; align-items: flex-end; gap: 8px;
    padding: 8px 12px;
    transition: border-color .15s;
  }
  #deskInputBox:focus-within { border-color: rgba(91,155,213,.5); }
  #deskInp {
    flex: 1; background: none; border: none; outline: none;
    color: var(--text-hi); font-size: .92rem;
    font-family: inherit; resize: none;
    max-height: 180px; line-height: 1.5;
    padding: 2px 0;
  }
  #deskInp::placeholder { color: var(--muted); }
  .dsk-inp-btn {
    width: 32px; height: 32px; border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: .95rem;
    color: var(--muted); flex-shrink: 0;
    transition: background .12s, color .12s;
    border: none; background: none;
  }
  .dsk-inp-btn:hover { background: var(--surface); color: var(--text-hi); }
  #deskSendBtn {
    background: var(--blue); color: #fff;
    border: none; border-radius: 7px;
    width: 34px; height: 34px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; flex-shrink: 0;
    font-size: .85rem;
    transition: opacity .15s;
  }
  #deskSendBtn:hover { opacity: .85; }
  #deskSendBtn:disabled { opacity: .3; }
  #deskSendBtn.squish { animation: sendSquish .28s ease both; }

  /* Desktop Right panel (members list) */
  #deskMemberPanel {
    width: 220px;
    background: #222529;
    border-left: 1px solid rgba(255,255,255,.06);
    display: flex; flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
  }
  #deskMemberPanel.hidden { display: none; }
  .desk-mp-title {
    padding: 14px 14px 8px;
    font-size: .72rem; font-weight: 900;
    color: var(--muted); text-transform: uppercase; letter-spacing: .07em;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .desk-mp-list { flex: 1; overflow-y: auto; padding: 8px 6px; }
  .desk-mp-list::-webkit-scrollbar { width: 4px; }
  .desk-mp-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,.1); border-radius: 2px; }
  .desk-member-row {
    display: flex; align-items: center; gap: 8px;
    padding: 4px 8px; border-radius: 6px;
    cursor: default;
    transition: background .1s;
  }
  .desk-member-row:hover { background: rgba(255,255,255,.06); }
  .desk-m-av {
    width: 28px; height: 28px; border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    font-size: .65rem; font-weight: 900; color: #fff;
    flex-shrink: 0; position: relative;
  }
  .desk-m-av .r-dot { width: 9px; height: 9px; border: 2px solid #222529; }
  .desk-m-name {
    font-size: .82rem; color: rgba(255,255,255,.6);
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    flex: 1;
  }

  /* ‚îÄ‚îÄ Mobile screens hidden in desktop ‚îÄ‚îÄ */
  #roomsScreen, #chatScreen, #forumScreen,
  #msgsScreen, #friendsScreen, #profileScreen, #adminPanel { display: none !important; }

  /* ‚îÄ‚îÄ Forum / Friends / Profile as panels in deskMain ‚îÄ‚îÄ */
  #deskContentPanel {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
  }
}

@media (max-width: 767px) {
  #desktopShell { display: none !important; }
}


/* ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ */
.dsk-row.drag-over { background: rgba(91,155,213,.2); border: 1px dashed rgba(91,155,213,.5); border-radius: 6px; }
.dsk-row.dragging { opacity: 0.4; }
.dsk-drag-handle {
  opacity: 0;
  color: var(--muted);
  font-size: .7rem;
  cursor: grab;
  padding: 0 2px;
  flex-shrink: 0;
  transition: opacity .15s;
  user-select: none;
}
.dsk-row:hover .dsk-drag-handle { opacity: 1; }
.dsk-drag-handle:active { cursor: grabbing; }


/* ‚ïê‚ïê Desktop Forum ‚ïê‚ïê */
.dsk-forum-wrap {
  display: flex; height: 100%; overflow: hidden;
}
.dsk-forum-feed {
  flex: 1; overflow-y: auto; padding: 0;
  background: var(--bg);
}
.dsk-forum-feed::-webkit-scrollbar { width: 6px; }
.dsk-forum-feed::-webkit-scrollbar-thumb { background: rgba(255,255,255,.12); border-radius: 3px; }

/* Forum top bar */
.dsk-forum-topbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  display: flex; align-items: center; gap: 0;
  flex-shrink: 0; overflow-x: auto;
}
.dsk-forum-topbar::-webkit-scrollbar { display: none; }
.dsk-ftab {
  padding: 14px 14px;
  font-size: .8rem; font-weight: 700;
  color: var(--muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  white-space: nowrap;
  transition: color .15s, border-color .15s;
  flex-shrink: 0;
}
.dsk-ftab:hover { color: var(--text-hi); }
.dsk-ftab.act { color: var(--blue); border-bottom-color: var(--blue); }

/* Entry / post card - Ek≈üi style */
.dsk-entry {
  border-bottom: 1px solid rgba(255,255,255,.05);
  padding: 20px 24px 16px;
  transition: background .1s;
  position: relative;
}
.dsk-entry:hover { background: rgba(255,255,255,.015); }
.dsk-entry-header {
  display: flex; align-items: flex-start; gap: 12px; margin-bottom: 10px;
}
.dsk-entry-av {
  width: 38px; height: 38px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: .75rem; font-weight: 900; color: #fff;
  flex-shrink: 0;
}
.dsk-entry-meta { flex: 1; min-width: 0; }
.dsk-entry-author {
  font-size: .88rem; font-weight: 900; color: var(--text-hi);
  display: flex; align-items: center; gap: 8px;
}
.dsk-entry-author .origin-flag { font-size: .75rem; color: var(--muted); font-weight: 400; }
.dsk-entry-time { font-size: .72rem; color: var(--muted); margin-top: 1px; }
.dsk-entry-cat-badge {
  display: inline-flex; align-items: center;
  background: rgba(91,155,213,.15); color: #5b9bd5;
  font-size: .65rem; font-weight: 700;
  border-radius: 100px; padding: 2px 9px;
  flex-shrink: 0;
}
.dsk-entry-body {
  font-size: .92rem; color: var(--text);
  line-height: 1.75; margin: 6px 0 12px 50px;
  word-break: break-word; white-space: pre-wrap;
}
.dsk-entry-body a { color: var(--blue); text-decoration: none; }
.dsk-entry-body a:hover { text-decoration: underline; }
.dsk-entry-footer {
  display: flex; align-items: center; gap: 6px;
  margin-left: 50px;
}
.dsk-vote-btn {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 11px; border-radius: 100px;
  border: 1px solid rgba(255,255,255,.1);
  background: none; cursor: pointer;
  font-size: .78rem; font-weight: 700; color: var(--muted);
  transition: all .15s;
}
.dsk-vote-btn:hover { border-color: rgba(255,255,255,.25); color: var(--text-hi); }
.dsk-vote-btn.active-up { background: rgba(46,204,113,.15); border-color: rgba(46,204,113,.35); color: #2ecc71; }
.dsk-vote-btn.active-down { background: rgba(224,85,85,.15); border-color: rgba(224,85,85,.35); color: #e05555; }
.dsk-vote-btn.active-heart { background: rgba(231,76,120,.15); border-color: rgba(231,76,120,.35); color: #e74c78; }
.dsk-entry-reply-btn {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 11px; border-radius: 100px;
  background: none; border: 1px solid transparent;
  cursor: pointer; font-size: .78rem; font-weight: 700;
  color: var(--muted); transition: all .15s;
}
.dsk-entry-reply-btn:hover { border-color: rgba(255,255,255,.15); color: var(--text-hi); }
.dsk-entry-del-btn {
  margin-left: auto;
  padding: 5px 10px; border-radius: 100px;
  background: none; border: 1px solid transparent;
  cursor: pointer; font-size: .72rem; color: var(--muted);
  transition: all .15s;
}
.dsk-entry-del-btn:hover { border-color: rgba(224,85,85,.3); color: #e05555; }

/* Comments */
.dsk-comments { margin-left: 50px; }
.dsk-comment {
  display: flex; gap: 10px;
  padding: 10px 0;
  border-top: 1px solid rgba(255,255,255,.04);
}
.dsk-comment-av {
  width: 28px; height: 28px; border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  font-size: .62rem; font-weight: 900; color: #fff;
  flex-shrink: 0;
}
.dsk-comment-body { flex: 1; min-width: 0; }
.dsk-comment-author { font-size: .78rem; font-weight: 900; color: var(--text-hi); }
.dsk-comment-time { font-size: .65rem; color: var(--muted); margin-left: 6px; }
.dsk-comment-text { font-size: .85rem; color: var(--text); margin-top: 2px; line-height: 1.6; }

/* Comment input */
.dsk-reply-area {
  margin-left: 50px; margin-top: 8px;
  display: none;
}
.dsk-reply-area.open { display: flex; gap: 8px; }
.dsk-reply-inp {
  flex: 1; background: var(--surface);
  border: 1px solid var(--border); border-radius: 8px;
  padding: 9px 12px; color: var(--text-hi);
  font-size: .85rem; font-family: inherit;
  outline: none; resize: none;
  transition: border-color .15s;
}
.dsk-reply-inp:focus { border-color: #5b9bd5; }
.dsk-reply-send {
  background: var(--blue); border: none; border-radius: 8px;
  color: #fff; font-size: .82rem; font-weight: 700;
  padding: 0 16px; cursor: pointer; flex-shrink: 0;
  transition: opacity .15s;
}
.dsk-reply-send:hover { opacity: .85; }

/* New post compose area */
.dsk-compose {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
}
.dsk-compose-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  transition: border-color .15s;
}
.dsk-compose-box:focus-within { border-color: rgba(91,155,213,.5); }
.dsk-compose-inp {
  width: 100%; background: none; border: none; outline: none;
  color: var(--text-hi); font-size: .92rem;
  font-family: inherit; resize: none;
  line-height: 1.6; min-height: 60px;
}
.dsk-compose-inp::placeholder { color: var(--muted); }
.dsk-compose-footer {
  display: flex; align-items: center; gap: 8px; margin-top: 10px;
}
.dsk-cat-sel {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text-hi);
  font-size: .8rem; padding: 7px 10px;
  outline: none; cursor: pointer; font-family: inherit;
}
.dsk-forum-post-btn {
  margin-left: auto;
  background: var(--blue); border: none; border-radius: 8px;
  color: #fff; font-size: .85rem; font-weight: 700;
  padding: 8px 20px; cursor: pointer;
  transition: opacity .15s;
}
.dsk-forum-post-btn:hover { opacity: .85; }
.dsk-forum-post-btn:disabled { opacity: .4; cursor: default; }

/* Sidebar widgets */
/* ‚ïê‚ïê WATCH / TV SCREEN CSS ‚ïê‚ïê */
.watch-wrap { display: flex; flex-direction: column; height: 100%; overflow: hidden; background: var(--bg); }
.watch-header { background: var(--bg2); border-bottom: 1px solid var(--border); padding: 14px 20px; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
.watch-header-title { font-size: 1.1rem; font-weight: 900; color: var(--text-hi); }
.watch-header-sub { font-size: .75rem; color: var(--muted); margin-top: 1px; }
.watch-live-badge { display: inline-flex; align-items: center; gap: 5px; background: rgba(224,85,85,.15); border: 1px solid rgba(224,85,85,.3); color: #e05555; font-size: .65rem; font-weight: 900; border-radius: 100px; padding: 3px 9px; letter-spacing: .04em; }
.watch-live-badge::before { content:''; width: 6px; height: 6px; border-radius: 50%; background: #e05555; animation: watchPulse 1.2s ease-in-out infinite; }
@keyframes watchPulse { 0%,100%{opacity:1} 50%{opacity:.3} }
.watch-content { display: flex; flex: 1; overflow: hidden; }
.watch-sidebar { width: 280px; flex-shrink: 0; background: var(--bg2); border-right: 1px solid var(--border); overflow-y: auto; }
.watch-sidebar::-webkit-scrollbar { width: 4px; }
.watch-sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
.watch-cat-header { padding: 10px 14px 4px; font-size: .65rem; font-weight: 900; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; }
.watch-ch-item { display: flex; align-items: center; gap: 10px; padding: 9px 14px; cursor: pointer; transition: background .1s; border-radius: 0; }
.watch-ch-item:hover { background: var(--surface); }
.watch-ch-item.act { background: var(--surface2); border-left: 3px solid var(--accent); }
.watch-ch-logo { width: 38px; height: 38px; border-radius: 8px; object-fit: contain; background: var(--surface2); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; overflow: hidden; }
.watch-ch-logo img { width: 100%; height: 100%; object-fit: contain; }
.watch-ch-info { flex: 1; min-width: 0; }
.watch-ch-name { font-size: .88rem; font-weight: 700; color: var(--text-hi); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.watch-ch-cat { font-size: .68rem; color: var(--muted); }
.watch-player-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.watch-player-box { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; position: relative; }
.watch-player-box iframe { width: 100%; height: 100%; border: none; }
.watch-player-placeholder { text-align: center; color: rgba(255,255,255,.3); }
.watch-player-placeholder .pp-icon { font-size: 4rem; margin-bottom: 12px; }
.watch-player-placeholder .pp-text { font-size: .95rem; font-weight: 700; }
.watch-player-placeholder .pp-sub { font-size: .78rem; margin-top: 4px; opacity: .6; }
.watch-now-info { background: var(--bg2); border-top: 1px solid var(--border); padding: 10px 16px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
.watch-now-ch { font-size: .95rem; font-weight: 900; color: var(--text-hi); }
.watch-now-sub { font-size: .75rem; color: var(--muted); margin-top: 1px; }
/* Mobile watch screen */
.watch-mob-grid { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; padding: 14px; }
.watch-mob-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 14px 10px; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: background .1s; }
.watch-mob-card:active { background: var(--surface2); }
.watch-mob-card .wmc-logo { width: 52px; height: 52px; border-radius: 12px; background: var(--surface2); display: flex; align-items: center; justify-content: center; font-size: 1.6rem; overflow: hidden; }
.watch-mob-card .wmc-logo img { width: 100%; height: 100%; object-fit: contain; }
.watch-mob-card .wmc-name { font-size: .78rem; font-weight: 700; color: var(--text-hi); text-align: center; }
.watch-mob-card .wmc-cat { font-size: .62rem; color: var(--muted); }
.watch-mob-player { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; }
.watch-mob-player-header { display: flex; align-items: center; gap: 10px; padding: 10px 14px; padding-top: calc(10px + env(safe-area-inset-top,0px)); background: rgba(0,0,0,.7); position: absolute; top: 0; left: 0; right: 0; z-index: 1; }
.watch-mob-player iframe { width: 100%; height: 100%; border: none; }
.watch-mob-close { width: 34px; height: 34px; border-radius: 50%; background: rgba(255,255,255,.15); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.1rem; color: #fff; flex-shrink: 0; }

/* ‚îÄ‚îÄ Screen Share & Call UI ‚îÄ‚îÄ */
#callScreen { user-select:none; }
.call-part-av {
  width: 36px; height: 36px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: .75rem; font-weight: 900; color: #fff;
  outline-offset: 2px; transition: outline .2s;
  cursor: default; user-select: none;
}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.3)}}
#localVideo { transition: opacity .2s; }
#localVideo:hover { opacity:.85; }
#callShareScreenBtn.active { background:rgba(46,204,113,.25) !important; border-color:rgba(46,204,113,.5) !important; }
#callCamBtn.off, #callSpeakerBtn.off { background:rgba(224,85,85,.3) !important; border-color:rgba(224,85,85,.55) !important; }
.wave-bar { width:4px; border-radius:2px; animation: wave 1.2s ease-in-out infinite; }
@keyframes wave {
  0%,100%{height:5px;opacity:.3}
  50%{height:26px;opacity:.9}
}
.wave-bar:nth-child(1){animation-delay:0s}
.wave-bar:nth-child(2){animation-delay:.18s}
.wave-bar:nth-child(3){animation-delay:.36s}
.wave-bar:nth-child(4){animation-delay:.54s}
.wave-bar:nth-child(5){animation-delay:.72s}
.wave-bar:nth-child(5){animation-delay:.6s}

/* ‚îÄ‚îÄ Chat Context Menu ‚îÄ‚îÄ */
#chatContextMenu .cm-item{display:flex;align-items:center;gap:10px;padding:11px 16px;cursor:pointer;font-size:.88rem;color:var(--text);transition:background .1s;}
#chatContextMenu .cm-item:hover{background:rgba(255,255,255,.07);}
#chatContextMenu .cm-item.danger{color:var(--red);}
#chatContextMenu .cm-sep{height:1px;background:var(--border);margin:4px 0;}


.picker-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0;height:38px;}
.picker-tab{flex:1;padding:9px 0;text-align:center;font-size:.82rem;font-weight:700;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:color .15s,border-color .15s;}
.picker-tab.active{color:var(--text-hi);border-bottom-color:var(--accent);}
.picker-body{padding:10px 10px;overflow-y:scroll;height:274px;-webkit-overflow-scrolling:touch;background:var(--bg2);box-sizing:border-box;}
.gif-search-wrap{padding:8px 10px 4px;background:var(--bg2);flex-shrink:0;}
.gif-search-inp{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text-hi);font-size:.85rem;padding:7px 12px;outline:none;box-sizing:border-box;}
.gif-search-inp::placeholder{color:var(--muted);}
.gif-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;}
.gif-item{border-radius:6px;overflow:hidden;cursor:pointer;aspect-ratio:1;background:var(--surface2);}
.gif-item img{width:100%;height:100%;object-fit:cover;display:block;}
.gif-item:hover{opacity:.85;}
.gif-loading{text-align:center;padding:20px;color:var(--muted);font-size:.85rem;}


/* Custom Emoji */
.custom-emoji-grid{display:flex;flex-wrap:wrap;gap:6px;padding:4px 0;}
.custom-emoji-item{width:36px;height:36px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;overflow:hidden;transition:background .15s;position:relative;}
.custom-emoji-item:hover{background:var(--border);}
.custom-emoji-item img{width:32px;height:32px;object-fit:contain;}
.custom-emoji-item .ce-delete{display:none;position:absolute;top:-3px;right:-3px;width:14px;height:14px;background:#e74c3c;color:#fff;border-radius:50%;font-size:9px;align-items:center;justify-content:center;cursor:pointer;line-height:1;}
.custom-emoji-item:hover .ce-delete{display:flex;}
.add-emoji-btn{display:flex;align-items:center;gap:6px;padding:7px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text-hi);font-size:.82rem;cursor:pointer;transition:background .15s;width:100%;box-sizing:border-box;margin-top:6px;font-weight:600;}
.add-emoji-btn:hover{background:var(--border);}
.ce-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999999;align-items:center;justify-content:center;}
.ce-modal-overlay.open{display:flex;}
.ce-modal{background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:24px;width:320px;max-width:90vw;box-shadow:0 16px 48px rgba(0,0,0,.6);}
.ce-modal h3{margin:0 0 16px;font-size:1rem;color:var(--text-hi);}
.ce-modal input[type=text]{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text-hi);padding:9px 12px;font-size:.88rem;outline:none;box-sizing:border-box;margin-bottom:12px;}
.ce-modal input[type=text]::placeholder{color:var(--muted);}
.ce-preview{width:64px;height:64px;background:var(--surface);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;overflow:hidden;}
.ce-preview img{width:56px;height:56px;object-fit:contain;}
.ce-upload-area{border:2px dashed var(--border);border-radius:10px;padding:16px;text-align:center;cursor:pointer;color:var(--muted);font-size:.82rem;margin-bottom:12px;transition:border-color .15s;}
.ce-upload-area:hover{border-color:var(--accent);color:var(--text-hi);}
.ce-modal-btns{display:flex;gap:8px;}
.ce-modal-btns button{flex:1;padding:9px;border-radius:8px;border:none;cursor:pointer;font-size:.88rem;font-weight:700;}
.ce-cancel{background:var(--surface);color:var(--muted);}
.ce-save{background:var(--accent);color:#fff;}

.msg-emoji-img{width:48px!important;height:48px!important;border-radius:6px!important;}

/* ‚ïê‚ïê MINI GAMES CSS ‚ïê‚ïê */
.games-lobby{padding:0;}
.games-title{font-size:1.1rem;font-weight:900;color:var(--text-hi);margin-bottom:4px;}
.games-sub{font-size:.8rem;color:var(--muted);margin-bottom:20px;}
.game-card{background:var(--surface2);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:12px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:14px;}
.game-card:hover{border-color:var(--accent);background:var(--surface);}
.game-card-ic{font-size:2rem;flex-shrink:0;width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:var(--surface);border-radius:12px;}
.game-card-info{flex:1;}
.game-card-name{font-size:.95rem;font-weight:800;color:var(--text-hi);margin-bottom:2px;}
.game-card-desc{font-size:.75rem;color:var(--muted);}
.game-card-badge{font-size:.7rem;font-weight:700;background:var(--accent);color:#fff;border-radius:20px;padding:2px 8px;margin-left:auto;flex-shrink:0;}
.msg-status{display:inline-flex;align-items:center;margin-left:4px;font-size:.6rem;vertical-align:middle;line-height:1;}
.msg-status svg{width:16px;height:9px;fill:none;stroke:rgba(255,255,255,.35);stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
.msg-status.delivered svg{stroke:rgba(255,255,255,.55);}
.msg-status.read svg{stroke:#4fc3f7;}
.game-invites-section{margin-bottom:20px;}
.game-invite-card{background:rgba(91,155,213,.12);border:1px solid rgba(91,155,213,.3);border-radius:12px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;}
.game-invite-from{font-size:.88rem;font-weight:700;color:var(--text-hi);flex:1;}
.game-invite-type{font-size:.75rem;color:var(--muted);}
.game-invite-btns{display:flex;gap:6px;}
.game-invite-accept{background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:.78rem;font-weight:700;padding:6px 12px;cursor:pointer;}
.game-invite-decline{background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--muted);font-size:.78rem;font-weight:700;padding:6px 10px;cursor:pointer;}
.game-active-section{margin-bottom:20px;}
.game-active-card{background:rgba(46,204,113,.08);border:1px solid rgba(46,204,113,.25);border-radius:12px;padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;cursor:pointer;}
.game-active-card:hover{border-color:rgba(46,204,113,.5);}

/* Tic-Tac-Toe Board */

/* RPS Game */

/* Game modal header */
.game-modal-header{display:flex;align-items:center;gap:10px;margin-bottom:16px;}
.game-modal-back{background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text-hi);font-size:.8rem;padding:5px 10px;cursor:pointer;flex-shrink:0;}
.game-modal-title{font-size:1rem;font-weight:900;color:var(--text-hi);}
.game-modal-vs{font-size:.8rem;color:var(--muted);margin-left:auto;}
.game-invite-user-list{max-height:200px;overflow-y:auto;}
.game-user-row{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;cursor:pointer;transition:background .15s;}
.game-user-row:hover{background:var(--surface2);}
.game-user-av{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:900;color:#fff;flex-shrink:0;}
.game-user-name{font-size:.88rem;font-weight:700;color:var(--text-hi);}
.game-user-status{font-size:.72rem;color:#2ecc71;margin-left:auto;}

/* ‚ïê‚ïê Sesli Mesaj ‚ïê‚ïê */
.voice-msg-wrap { display:flex; align-items:center; gap:8px; min-width:160px; max-width:260px; }
.voice-play-btn { width:34px; height:34px; border-radius:50%; background:var(--accent); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:opacity .15s; }
.voice-play-btn:active { opacity:.75; }
.voice-waveform { flex:1; height:28px; display:flex; align-items:center; gap:2px; overflow:hidden; }
.voice-waveform span { display:inline-block; width:3px; border-radius:2px; background:rgba(255,255,255,.45); transition:height .1s; }
.voice-progress { font-size:.7rem; color:rgba(255,255,255,.6); flex-shrink:0; min-width:32px; text-align:right; }

/* ‚ïê‚ïê Yazƒ±yor g√∂stergesi ‚ïê‚ïê */
.typing-dots { display:inline-flex; gap:3px; align-items:center; }
.typing-dots span { width:5px; height:5px; border-radius:50%; background:var(--accent); animation:tdot 1.2s ease-in-out infinite; }
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}
@keyframes tdot{0%,60%,100%{transform:translateY(0);opacity:.5}30%{transform:translateY(-4px);opacity:1}}

/* ‚ïê‚ïê Sohbet arama √ßubuƒüu ‚ïê‚ïê */
#chatSearchBar { display:none; position:absolute; top:0; left:0; right:0; z-index:40; background:var(--bg2); padding:8px 12px; gap:8px; align-items:center; box-shadow:0 2px 12px rgba(0,0,0,.3); }
#chatSearchBar.open { display:flex; }
#chatSearchInp { flex:1; background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:8px 12px; color:var(--text-hi); font-size:.9rem; outline:none; }
#chatSearchInp::placeholder { color:var(--muted); }
#chatSearchCount { font-size:.75rem; color:var(--muted); white-space:nowrap; min-width:40px; text-align:center; }
.search-highlight { background:rgba(255,200,0,.35); border-radius:2px; }
.search-highlight.current { background:rgba(255,200,0,.7); }

/* ‚ïê‚ïê Ses kayƒ±t butonu ‚ïê‚ïê */
.voice-record-btn { width:36px; height:36px; border-radius:50%; background:transparent; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; transition:background .15s; color:var(--muted); }
.voice-record-btn:hover { background:var(--surface2); color:var(--text-hi); }
.voice-record-btn.recording { background:rgba(224,85,85,.2); color:#e05555; animation:recpulse 1s ease-in-out infinite; }

/* ‚îÄ‚îÄ Forum Rich Text Edit√∂r ‚îÄ‚îÄ */
.fmt-btn{background:transparent;border:none;color:var(--text);padding:3px 7px;border-radius:5px;cursor:pointer;font-size:.85rem;line-height:1.4;transition:background .12s,color .12s;min-width:26px;text-align:center;}
.fmt-btn:hover{background:var(--border);color:var(--text-hi);}
.fmt-btn.active{background:var(--accent2);color:var(--text-hi);}
#forumPostInp:empty::before{content:attr(data-placeholder);color:var(--muted);pointer-events:none;}
#forumPostInp blockquote{border-left:3px solid var(--accent);padding-left:10px;margin:4px 0;color:var(--muted);font-style:italic;}
#forumPostInp code{background:var(--surface2);border-radius:4px;padding:1px 5px;font-family:monospace;font-size:.85em;}
#forumPostInp ul,#forumPostInp ol{padding-left:20px;margin:4px 0;}
#forumPostInp a{color:var(--accent);text-decoration:underline;}
@keyframes recpulse{0%,100%{box-shadow:0 0 0 0 rgba(224,85,85,.4)}50%{box-shadow:0 0 0 6px rgba(224,85,85,0)}}
.rec-timer { font-size:.72rem; color:#e05555; font-weight:700; min-width:36px; display:none; }
.rec-timer.show { display:block; }

/* ‚ïê‚ïê Mesaj status (okundu) fix ‚ïê‚ïê */
.msg-status svg { width:14px; height:9px; fill:none; stroke:rgba(255,255,255,.4); stroke-width:2; }
.msg-status.delivered svg { stroke:rgba(255,255,255,.7); }
.msg-status.read svg { stroke:#5b9bd5; }

/* ‚ïê‚ïê Son g√∂r√ºlme ‚ïê‚ïê */
.last-seen-badge { font-size:.68rem; color:var(--muted); margin-top:1px; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   YENƒ∞ √ñZELLƒ∞KLER CSS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Tema Smooth Transition ‚îÄ‚îÄ */
*, *::before, *::after {
  transition-property: background-color, border-color, color;
  transition-duration: 0s;
}
[data-theme-transitioning] *, [data-theme-transitioning] *::before, [data-theme-transitioning] *::after {
  transition-duration: 350ms !important;
  transition-timing-function: ease !important;
}

/* ‚îÄ‚îÄ Hover Zaman Damgasƒ± Tooltip ‚îÄ‚îÄ */
.mb { position: relative; }
.msg-hover-tooltip {
  position: absolute;
  bottom: calc(100% + 5px);
  left: 50%;
  transform: translateX(-50%) scale(.85);
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 5px 10px;
  font-size: .65rem;
  color: var(--text);
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity .18s, transform .18s;
  box-shadow: 0 4px 16px rgba(0,0,0,.5);
  z-index: 500;
}
.mb:hover .msg-hover-tooltip { opacity: 1; transform: translateX(-50%) scale(1); }
.msg-hover-tooltip::after {
  content: '';
  position: absolute;
  top: 100%; left: 50%; transform: translateX(-50%);
  border: 4px solid transparent;
  border-top-color: var(--border);
}

/* ‚îÄ‚îÄ Mesaj G√∂nderim Pop Animasyonu ‚îÄ‚îÄ */
@keyframes msgPopIn {
  from { opacity: 0; transform: scale(.8) translateY(6px); }
  to   { opacity: 1; transform: scale(1) translateY(0); }
}
.mb.pop-in { animation: msgPopIn .3s cubic-bezier(.34,1.56,.64,1) both; }
.mb.sending-state { opacity: .45; }
.mb.sending-state .mb-text, .mb.sending-state .ob { opacity: .5; }

/* ‚îÄ‚îÄ Tepki Bounce Animasyonu ‚îÄ‚îÄ */
@keyframes reactBounce {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.4); }
  70%  { transform: scale(.9); }
  100% { transform: scale(1); }
}
.react-pill.bouncing { animation: reactBounce .35s cubic-bezier(.34,1.56,.64,1); }

/* ‚îÄ‚îÄ G√∂nder Butonu Squish ‚îÄ‚îÄ */
@keyframes sendSquish {
  0%   { transform: scale(1); }
  40%  { transform: scale(.8); }
  70%  { transform: scale(1.15); }
  100% { transform: scale(1); }
}
.send-btn.squish { animation: sendSquish .28s ease both; }

/* ‚îÄ‚îÄ Tab Badge Pop ‚îÄ‚îÄ */
@keyframes badgePop {
  0%   { transform: scale(.5); }
  60%  { transform: scale(1.35); }
  100% { transform: scale(1); }
}
.ubadge.badge-pop, .dsk-row-badge.badge-pop { animation: badgePop .35s cubic-bezier(.34,1.56,.64,1); }

/* ‚îÄ‚îÄ Scroll-to-Bottom Butonu ‚îÄ‚îÄ */
#scrollToBottomBtn {
  position: absolute;
  bottom: 70px; right: 14px;
  width: 38px; height: 38px;
  border-radius: 50%;
  background: var(--surface2);
  border: 1px solid var(--border);
  box-shadow: 0 4px 18px rgba(0,0,0,.55);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  opacity: 0;
  transform: scale(.7) translateY(10px);
  transition: opacity .25s, transform .25s;
  z-index: 100;
  font-size: .9rem;
  color: var(--text-hi);
  user-select: none;
}
#scrollToBottomBtn.visible { opacity: 1; transform: scale(1) translateY(0); }
#scrollToBottomBtn .stb-badge {
  position: absolute;
  top: -5px; left: 50%; transform: translateX(-50%);
  background: #e05555;
  color: #fff; font-size: .52rem; font-weight: 900;
  border-radius: 100px; padding: 1px 5px;
  white-space: nowrap;
  border: 1.5px solid var(--bg);
  line-height: 1.4;
  display: none;
}
#scrollToBottomBtn.has-unread .stb-badge { display: block; }

/* ‚îÄ‚îÄ Online Durum Noktasƒ± Smooth Ge√ßi≈ü ‚îÄ‚îÄ */
.r-dot, .sdot, .dm-av .r-dot,
.dsk-row-av .r-dot, .desk-m-av .r-dot, .fr-av .r-dot {
  transition: background .5s ease, box-shadow .5s ease;
}
.r-dot.on { box-shadow: 0 0 0 2px rgba(31,214,85,.25); }

/* ‚îÄ‚îÄ S√ºr√ºkle-Bƒ±rak Overlay ‚îÄ‚îÄ */
#dropOverlay {
  position: absolute;
  inset: 0;
  background: rgba(74,143,64,.1);
  border: 2px dashed rgba(74,143,64,.5);
  border-radius: 12px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 10px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s;
  z-index: 200;
  backdrop-filter: blur(2px);
}
#dropOverlay.active { opacity: 1; pointer-events: all; }
#dropOverlay .drop-icon { font-size: 2.5rem; }
#dropOverlay .drop-text { font-size: .9rem; font-weight: 700; color: var(--accent2); }
#dropOverlay .drop-sub { font-size: .72rem; color: var(--muted); }

/* ‚îÄ‚îÄ Swipe-to-Reply G√∂stergesi ‚îÄ‚îÄ */
.mb { overflow: visible; }
.mb .swipe-reply-hint {
  position: absolute;
  left: -38px; top: 50%; transform: translateY(-50%) scale(.6);
  width: 30px; height: 30px;
  border-radius: 50%;
  background: rgba(91,155,213,.2);
  border: 1px solid rgba(91,155,213,.4);
  display: flex; align-items: center; justify-content: center;
  font-size: .9rem;
  opacity: 0;
  transition: opacity .2s, transform .2s;
  pointer-events: none;
}
.mb.swiping-right .swipe-reply-hint { opacity: 1; transform: translateY(-50%) scale(1); }
.mb.swiping-right .mb-body, .mb.swiping-right .av { transform: translateX(36px); transition: transform .2s cubic-bezier(.34,1.56,.64,1); }

/* ‚îÄ‚îÄ Kanal √ñnizleme Popup (Desktop) ‚îÄ‚îÄ */
.rail-ch-preview {
  position: absolute;
  left: calc(100% + 12px);
  top: 50%; transform: translateY(-50%) scale(.9);
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  width: 220px;
  pointer-events: none;
  opacity: 0;
  transition: opacity .2s, transform .2s;
  z-index: 9999;
  box-shadow: 0 12px 40px rgba(0,0,0,.7);
}
.r-row:hover .rail-ch-preview { opacity: 1; transform: translateY(-50%) scale(1); }
.rcp-name { font-size: .8rem; font-weight: 700; color: var(--text-hi); margin-bottom: 3px; }
.rcp-last { font-size: .7rem; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.rcp-meta { display: flex; align-items: center; gap: 6px; margin-top: 7px; }
.rcp-online { font-size: .65rem; color: var(--green); display: flex; align-items: center; gap: 3px; }
.rcp-time { font-size: .62rem; color: var(--muted); margin-left: auto; }

/* ‚îÄ‚îÄ Desktop Scroll-to-Bottom Butonu ‚îÄ‚îÄ */
#deskScrollToBottomBtn {
  position: absolute;
  bottom: 80px; right: 18px;
  width: 38px; height: 38px;
  border-radius: 50%;
  background: var(--surface2);
  border: 1px solid var(--border);
  box-shadow: 0 4px 18px rgba(0,0,0,.55);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  opacity: 0;
  transform: scale(.7) translateY(10px);
  transition: opacity .25s, transform .25s;
  z-index: 100;
  font-size: .9rem;
  color: var(--text-hi);
  user-select: none;
}
#deskScrollToBottomBtn.visible { opacity: 1; transform: scale(1) translateY(0); }
#deskScrollToBottomBtn .stb-badge {
  position: absolute;
  top: -5px; left: 50%; transform: translateX(-50%);
  background: #e05555;
  color: #fff; font-size: .52rem; font-weight: 900;
  border-radius: 100px; padding: 1px 5px;
  white-space: nowrap;
  border: 1.5px solid var(--bg);
  line-height: 1.4;
  display: none;
}
#deskScrollToBottomBtn.has-unread .stb-badge { display: block; }

/* ‚îÄ‚îÄ Desktop Drag & Drop Overlay ‚îÄ‚îÄ */
#deskDropOverlay {
  position: absolute;
  inset: 0;
  background: rgba(74,143,64,.1);
  border: 2px dashed rgba(74,143,64,.5);
  border-radius: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 10px;
  opacity: 0;
  pointer-events: none;
  transition: opacity .2s;
  z-index: 200;
  backdrop-filter: blur(2px);
}
#deskDropOverlay.active { opacity: 1; pointer-events: all; }
#deskDropOverlay .drop-icon { font-size: 2.5rem; }
#deskDropOverlay .drop-text { font-size: .9rem; font-weight: 700; color: var(--accent2); }
#deskDropOverlay .drop-sub { font-size: .72rem; color: var(--muted); }

/* ‚îÄ‚îÄ Sohbet Arka Plan ‚îÄ‚îÄ */
#chatMsgs[data-bg="dots"],
#deskMsgs[data-bg="dots"] {
  background-image: radial-gradient(rgba(74,143,64,.12) 1px, transparent 1px);
  background-size: 22px 22px;
}
#chatMsgs[data-bg="grid"],
#deskMsgs[data-bg="grid"] {
  background-image: linear-gradient(rgba(74,143,64,.06) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(74,143,64,.06) 1px, transparent 1px);
  background-size: 24px 24px;
}
#chatMsgs[data-bg="cross"],
#deskMsgs[data-bg="cross"] {
  background-image: radial-gradient(circle, rgba(91,155,213,.08) 2px, transparent 2px);
  background-size: 30px 30px;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PROFƒ∞L SAYFASI ƒ∞Yƒ∞LE≈ûTƒ∞RMELER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Kendi Profil Sayfasƒ± ‚îÄ‚îÄ */
.prof-banner {
  height: 90px;
  background: linear-gradient(135deg, var(--accent2) 0%, var(--bg2) 100%);
  position: relative;
  flex-shrink: 0;
}
.prof-hero {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0 16px 20px;
  margin-top: -45px;
}
.prof-av-wrap {
  position: relative;
  margin-bottom: 10px;
}
.prof-av-ring {
  width: 90px; height: 90px;
  border-radius: 22px;
  border: 3px solid var(--bg2);
  overflow: hidden;
  display: flex; align-items: center; justify-content: center;
  font-size: 2rem; font-weight: 900; color: #fff;
  box-shadow: 0 4px 20px rgba(0,0,0,.5);
  cursor: pointer;
  position: relative;
}
.prof-av-ring::after {
  content: 'üì∑';
  position: absolute; inset: 0;
  background: rgba(0,0,0,.45);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.4rem;
  opacity: 0;
  transition: opacity .2s;
  border-radius: 19px;
}
.prof-av-ring:hover::after { opacity: 1; }
.prof-status-dot {
  position: absolute;
  bottom: 2px; right: 2px;
  width: 14px; height: 14px;
  border-radius: 50%;
  background: var(--green);
  border: 2.5px solid var(--bg2);
}
.prof-display-name {
  font-size: 1.25rem; font-weight: 900;
  color: var(--text-hi); margin-bottom: 2px;
  letter-spacing: -.02em;
}
.prof-handle {
  font-size: .78rem; color: var(--muted);
  margin-bottom: 8px;
}
.prof-stat-row {
  display: flex; gap: 0;
  background: var(--surface);
  border-radius: 12px;
  border: 1px solid var(--border);
  overflow: hidden;
  margin: 12px 0;
  width: 100%;
}
.prof-stat {
  flex: 1; padding: 10px 8px;
  text-align: center;
  border-right: 1px solid var(--border);
}
.prof-stat:last-child { border-right: none; }
.prof-stat-num {
  font-size: 1.1rem; font-weight: 900;
  color: var(--text-hi); display: block;
  min-height: 1.3em;
}
/* "‚Äî" g√∂sterilince hafif animasyon */
@keyframes statPulse {
  0%,100% { opacity:.4; } 50% { opacity:.9; }
}
.prof-stat-num:not(:empty) { animation: none; }
.prof-stat-lbl {
  font-size: .62rem; color: var(--muted);
  text-transform: uppercase; letter-spacing: .06em;
  display: block; margin-top: 2px;
}
.prof-bio-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  width: 100%;
  margin-bottom: 12px;
}
.prof-bio-card .pbc-label {
  font-size: .65rem; font-weight: 900;
  color: var(--muted); text-transform: uppercase;
  letter-spacing: .08em; margin-bottom: 6px;
}
.prof-bio-card textarea {
  width: 100%; background: transparent;
  border: none; outline: none;
  color: var(--text-hi); font-size: .88rem;
  resize: none; font-family: inherit;
  line-height: 1.55;
}
.prof-section-title {
  font-size: .65rem; font-weight: 900;
  color: var(--muted); text-transform: uppercase;
  letter-spacing: .08em; margin: 16px 0 8px;
  display: flex; align-items: center; gap: 6px;
}
.prof-section-title::before {
  content: ''; display: inline-block;
  width: 3px; height: 11px;
  background: var(--accent); border-radius: 2px;
}

/* ‚îÄ‚îÄ √úye Profil Modal (up-card) ‚îÄ‚îÄ */
#userProfileModal {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,.7);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 9999;
  align-items: flex-end;
  justify-content: center;
  padding: 0;
}
#userProfileModal.show { display: flex; }
.up-card {
  width: 100%; max-width: 480px;
  background: var(--bg2);
  border-radius: 24px 24px 0 0;
  overflow: hidden;
  animation: upCardIn .3s cubic-bezier(.34,1.2,.64,1) both;
  max-height: 90vh;
  display: flex; flex-direction: column;
}
@media(min-width:640px){
  #userProfileModal { align-items: center; padding: 24px; }
  .up-card { border-radius: 20px; max-height: 80vh; }
}
@keyframes upCardIn {
  from { transform: translateY(30px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}
.up-banner {
  height: 80px;
  background: linear-gradient(135deg, var(--accent2) 0%, var(--bg) 100%);
  flex-shrink: 0;
  position: relative;
}
.up-close {
  position: absolute; top: 12px; right: 14px;
  width: 28px; height: 28px;
  border-radius: 50%;
  background: rgba(0,0,0,.35);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: rgba(255,255,255,.8);
  font-size: .8rem;
  transition: background .15s;
}
.up-close:hover { background: rgba(0,0,0,.55); color: #fff; }
.up-body-scroll {
  flex: 1; overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 0 18px 20px;
  margin-top: -40px;
}
.up-body-scroll::-webkit-scrollbar { display: none; }
.up-av {
  width: 80px; height: 80px;
  border-radius: 18px;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.8rem; font-weight: 900; color: #fff;
  border: 3px solid var(--bg2);
  box-shadow: 0 4px 16px rgba(0,0,0,.5);
  margin-bottom: 10px;
  position: relative;
}
.up-online-dot {
  position: absolute; bottom: 2px; right: 2px;
  width: 14px; height: 14px;
  border-radius: 50%;
  border: 2.5px solid var(--bg2);
  transition: background .5s;
}
.up-name {
  font-size: 1.15rem; font-weight: 900;
  color: var(--text-hi); margin-bottom: 2px;
}
.up-status {
  font-size: .75rem; margin-bottom: 10px;
  display: flex; align-items: center; gap: 5px;
}
.up-badge-row {
  display: inline-flex;
  background: rgba(74,143,64,.12);
  border: 1px solid rgba(74,143,64,.25);
  border-radius: 100px;
  padding: 3px 10px;
  font-size: .72rem;
  color: var(--accent2);
  margin-bottom: 10px;
}
.up-bio-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 11px 13px;
  font-size: .83rem;
  color: var(--text);
  line-height: 1.55;
  text-align: left;
  margin: 8px 0;
}
.up-stat-row {
  display: flex; gap: 0;
  background: var(--surface);
  border-radius: 12px;
  border: 1px solid var(--border);
  overflow: hidden;
  margin: 10px 0;
}
.up-stat { flex: 1; padding: 9px 6px; text-align: center; border-right: 1px solid var(--border); }
.up-stat:last-child { border-right: none; }
.up-stat-n { font-size: 1rem; font-weight: 900; color: var(--text-hi); display: block; }
.up-stat-l { font-size: .6rem; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; display: block; }
.up-social-row {
  display: flex; flex-wrap: wrap; gap: 6px;
  margin: 8px 0;
}
.up-social-chip {
  display: flex; align-items: center; gap: 5px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; padding: 6px 10px;
  font-size: .75rem; color: var(--text);
  text-decoration: none;
  transition: border-color .15s, background .15s;
}
.up-social-chip:hover { border-color: var(--accent); background: var(--surface2); color: var(--text-hi); }
.up-action-row {
  display: flex; gap: 8px;
  margin-top: 14px;
}
.up-btn {
  flex: 1; padding: 10px;
  border: none; border-radius: 10px;
  font-size: .82rem; font-weight: 700;
  cursor: pointer; font-family: inherit;
  transition: all .15s;
}
.up-btn.primary { background: var(--accent); color: #fff; }
.up-btn.primary:hover { filter: brightness(1.1); }
.up-btn.danger { background: rgba(224,85,85,.12); color: var(--red); border: 1px solid rgba(224,85,85,.25); }
.up-btn.danger:hover { background: rgba(224,85,85,.22); }
.up-btn.muted { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); }
.up-btn.muted:hover { border-color: var(--text); color: var(--text-hi); }

/* ‚îÄ‚îÄ Ses Sil ‚îÄ‚îÄ (delete sound flash) */
@keyframes msgDeleteFlash {
  0%   { background: rgba(224,85,85,.2); }
  100% { background: transparent; }
}
.mb.deleting { animation: msgDeleteFlash .4s ease both; pointer-events: none; }

</style>
</head>
<body>

<!-- ‚îÄ‚îÄ Yan D√∂nme Engelleme Overlay ‚îÄ‚îÄ -->
<div id="orientationBlock">
  <div class="ob-icon">üì±</div>
  <div class="ob-text">L√ºtfen telefonu dik tutun</div>
</div>

<!-- ‚ïê‚ïê DESKTOP SHELL (hidden on mobile) ‚ïê‚ïê -->
<div id="desktopShell" style="display:none;">

  <!-- Icon Rail -->
  <div id="deskRail">
    <div class="rail-logo" onclick="showServerSwitchWithLogin()" title="Sunucu Deƒüi≈ütir" style="cursor:pointer;padding:4px;"><svg viewBox="0 0 120 120" width="32" height="32" xmlns="http://www.w3.org/2000/svg"><defs><clipPath id="lcrl"><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z"/></clipPath></defs><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="#0e2b0c"/><g clip-path="url(#lcrl)"><line x1="60" y1="14" x2="60" y2="108" stroke="#4a8f40" stroke-width="1.2"/><line x1="60" y1="35" x2="78" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="35" x2="42" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="52" x2="82" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="52" x2="38" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="68" x2="78" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="68" x2="42" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="82" x2="70" y2="94" stroke="#4a8f40" stroke-width=".4"/><line x1="60" y1="82" x2="50" y2="94" stroke="#4a8f40" stroke-width=".4"/></g><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="none" stroke="#4a8f40" stroke-width="1.2"/></svg></div>
    <div class="rail-sep"></div>
    <div class="rail-btn act" id="rb-home" onclick="deskNav('home')" title="Ana Sayfa">
      <div class="rail-btn-ic">üè†</div>
    </div>
    <div class="rail-btn" id="rb-forum" onclick="deskNav('forum')" title="Forum">
      <div class="rail-btn-ic">üìã</div>
    </div>
    <div class="rail-btn" id="rb-friends" onclick="deskNav('friends')" title="Arkada≈ülar">
      <div class="rail-btn-ic">üë•</div>
      <div class="notif-pill" id="deskFrNotif" style="display:none">!</div>
    </div>
    <div class="rail-btn" id="rb-games" onclick="deskNav('games')" title="Mini Oyunlar">
      <div class="rail-btn-ic">üéÆ</div>
      <div class="notif-pill" id="deskGameInviteNotif" style="display:none">!</div>
    </div>
    <div class="rail-btn" id="rb-watch" onclick="deskNav('watch')" title="Canlƒ± ƒ∞zle">
      <div class="rail-btn-ic">üì∫</div>
    </div>
     <div class="rail-btn" id="rb-botHome" onclick="deskNav('botHome')" title="Robot Evi">
       <div class="rail-btn-ic" style="display:flex;align-items:center;justify-content:center;">
         <svg width="26" height="22" viewBox="0 0 110 90" fill="none" xmlns="http://www.w3.org/2000/svg">
           <ellipse cx="55" cy="88" rx="46" ry="6" fill="rgba(74,143,64,.25)"/>
           <rect x="10" y="42" width="90" height="46" rx="4" fill="#1a2a1a" stroke="#2d5a2d" stroke-width="1.5"/>
           <path d="M4 44 L55 6 L106 44 Z" fill="#2d5a20" stroke="#4a8f40" stroke-width="1.5"/>
           <path d="M8 44 L55 10 L102 44 Z" fill="#3a7a28"/>
           <line x1="55" y1="10" x2="55" y2="44" stroke="#2d5a20" stroke-width="1"/>
           <line x1="29" y1="32" x2="81" y2="32" stroke="#2d5a20" stroke-width=".8"/>
           <circle cx="55" cy="6" r="4" fill="#4a8f40"/><circle cx="55" cy="6" r="2" fill="#6dbf67"/>
           <rect x="10" y="44" width="90" height="44" rx="3" fill="#0f1f0f" stroke="#1a3a1a" stroke-width="1"/>
           <path d="M38 88 L38 62 Q38 52 55 52 Q72 52 72 62 L72 88 Z" fill="#0a150a"/>
           <rect x="34" y="30" width="42" height="13" rx="4" fill="#1a3a10" stroke="#4a8f40" stroke-width="1"/>
           <text x="55" y="40" text-anchor="middle" font-size="7" font-weight="bold" fill="#6dbf67" font-family="monospace">NatureBot</text>
           <rect x="15" y="52" width="18" height="14" rx="2" fill="#0a1a0a" stroke="#2d5a2d" stroke-width="1"/>
           <line x1="24" y1="52" x2="24" y2="66" stroke="#2d5a2d" stroke-width=".8"/>
           <line x1="15" y1="59" x2="33" y2="59" stroke="#2d5a2d" stroke-width=".8"/>
           <rect x="77" y="52" width="18" height="14" rx="2" fill="#0a1a0a" stroke="#2d5a2d" stroke-width="1"/>
           <line x1="86" y1="52" x2="86" y2="66" stroke="#2d5a2d" stroke-width=".8"/>
           <line x1="77" y1="59" x2="95" y2="59" stroke="#2d5a2d" stroke-width=".8"/>
           <circle cx="15" cy="72" r="3" fill="#2d5a20" opacity=".9"/>
           <circle cx="95" cy="72" r="3" fill="#2d5a20" opacity=".9"/>
         </svg>
       </div>
     </div>
    <div class="rail-sep"></div>
    <div class="rail-btn" id="rb-admin" onclick="deskNav('admin')" title="Admin Paneli" style="display:none">
      <div class="rail-btn-ic"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M2 19h20v2H2v-2z" fill="#f0c040"/>
  <path d="M2 19l3-9 4.5 4.5L12 5l2.5 9.5L19 10l3 9H2z" fill="#f0c040" stroke="#d4a017" stroke-width="1" stroke-linejoin="round"/>
  <circle cx="2" cy="10" r="1.5" fill="#f0c040" stroke="#d4a017" stroke-width="0.5"/>
  <circle cx="12" cy="5" r="1.5" fill="#f0c040" stroke="#d4a017" stroke-width="0.5"/>
  <circle cx="22" cy="10" r="1.5" fill="#f0c040" stroke="#d4a017" stroke-width="0.5"/>
</svg></div>
    </div>
    <div id="deskRailUser" onclick="deskNav('profile')">
      <div class="sdot"></div>
    </div>
  </div>

  <!-- Sidebar -->
  <div id="deskSidebar">
    <div id="deskSidebarHeader">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div id="deskSidebarTitle" onclick="showServerSwitchModal()" title="Sunucu deƒüi≈ütir" style="cursor:pointer;user-select:none;" onmouseover="this.style.opacity='.75'" onmouseout="this.style.opacity='1'">Nature.co</div>
          <div id="deskSidebarSub">Ana Sayfa</div>
        </div>
        <!-- Zil + Profil -->
        <div style="display:flex;align-items:center;gap:4px;">
          <div id="deskBellBtn" onclick="openNotifCenter(this)" title="Bildirimler" style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;position:relative;color:rgba(255,255,255,.7);transition:background .15s;flex-shrink:0;" onmouseover="this.style.background='rgba(255,255,255,.1)'" onmouseout="this.style.background='transparent'">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            <div id="deskNotifDot" style="display:none;position:absolute;top:3px;right:3px;width:6px;height:6px;background:#e05555;border-radius:50%;border:1.5px solid #222529;"></div>
          </div>
          <div id="deskSidebarAvatar" onclick="deskNav('profile')" title="Profilim" style="width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:900;color:#fff;cursor:pointer;flex-shrink:0;background:#5b9bd5;border:1.5px solid rgba(255,255,255,.2);transition:opacity .15s;position:relative;" onmouseover="this.style.opacity='.8'" onmouseout="this.style.opacity='1'">
            <div class="sdot" style="position:absolute;bottom:-2px;right:-2px;width:9px;height:9px;border-radius:50%;background:var(--green);border:2px solid #222529;"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="deskSearch" onclick="openGlobalSearch()" style="cursor:pointer;">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <span style="color:var(--muted);font-size:.82rem;">Ara... <span style="margin-left:auto;font-size:.7rem;opacity:.6;">‚åòK</span></span>
    </div>
    <div id="deskSideList">
    </div>
  </div>

  <!-- Main Area -->
  <div id="deskMain">
    <!-- Empty state (no room selected) -->
    <div id="deskEmptyState">
      <div style="position:relative;margin-bottom:8px;">
        <svg viewBox="0 0 120 120" width="72" height="72" xmlns="http://www.w3.org/2000/svg" style="filter:drop-shadow(0 0 24px rgba(74,143,64,.3));"><defs><clipPath id="lcbi"><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z"/></clipPath></defs><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="#0e2b0c"/><g clip-path="url(#lcbi)"><line x1="60" y1="14" x2="60" y2="108" stroke="#4a8f40" stroke-width="1.2"/><line x1="60" y1="35" x2="78" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="35" x2="42" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="52" x2="82" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="52" x2="38" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="68" x2="78" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="68" x2="42" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="82" x2="70" y2="94" stroke="#4a8f40" stroke-width=".4"/><line x1="60" y1="82" x2="50" y2="94" stroke="#4a8f40" stroke-width=".4"/></g><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="none" stroke="#4a8f40" stroke-width="1.2"/></svg>
      </div>
      <div class="big-title">Nature.co'ya Ho≈ü Geldin</div>
      <div class="big-sub">Soldaki listeden bir kanal, grup veya ki≈üi se√ßerek sohbete ba≈üla</div>
      <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
        <div onclick="document.querySelector('#deskSideList .room-item')&&document.querySelector('#deskSideList .room-item').click()" style="background:rgba(74,143,64,.15);border:1px solid rgba(74,143,64,.25);border-radius:10px;padding:8px 14px;font-size:.78rem;color:#a5d6a7;cursor:pointer;transition:background .15s;" onmouseover="this.style.background='rgba(74,143,64,.28)'" onmouseout="this.style.background='rgba(74,143,64,.15)'">üí¨ Kanal Se√ß</div>
        <div onclick="deskNav('friends')" style="background:rgba(91,155,213,.12);border:1px solid rgba(91,155,213,.2);border-radius:10px;padding:8px 14px;font-size:.78rem;color:#90caf9;cursor:pointer;transition:background .15s;" onmouseover="this.style.background='rgba(91,155,213,.25)'" onmouseout="this.style.background='rgba(91,155,213,.12)'">üë• Arkada≈ülar</div>
      </div>
    </div>

    <!-- Active chat -->
    <div id="deskChatArea" style="display:none;flex:1;display:none;flex-direction:column;overflow:hidden;">
      <!-- Chat header -->
      <div id="deskChatHeader">
        <div id="deskChatHdrIcon">#</div>
        <div style="flex:1;min-width:0;">
          <div id="deskChatHdrName">‚Äî</div>
          <div id="deskChatHdrSub" style="font-size:.72rem;color:var(--muted);"></div>
        </div>
        <div class="dsk-hdr-actions">
          <div class="dsk-hdr-btn" id="deskCallAudio" onclick="startCall('audio')" style="display:none" title="Sesli Ara">üìû</div>
          <div class="dsk-hdr-btn" id="deskCallVideo" onclick="startCall('video')" style="display:none" title="G√∂r√ºnt√ºl√º Ara">üìπ</div>
          <div class="dsk-hdr-btn" id="deskCallScreen" onclick="startCall('screen')" style="display:none" title="Ekran Payla≈ü">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="2" y="4" width="20" height="14" rx="2" stroke="rgba(255,255,255,.9)" stroke-width="2"/><path d="M8 20h8M12 18v2" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/></svg>
    </div>
          <div class="dsk-hdr-btn" id="deskToggleMembers" onclick="toggleDeskMembers()" title="√úyeler">üë•</div>
        </div>
      </div>

      <!-- Admin panel -->
      <div id="deskSpyBanner"></div>

      <div style="flex:1;display:flex;overflow:hidden;flex-direction:column;">
        <!-- Sabitlenmi≈ü mesaj -->
        <div id="deskPinBar" style="display:none;align-items:center;gap:8px;background:var(--surface);border-bottom:2px solid var(--blue);padding:7px 14px;cursor:pointer;flex-shrink:0;">
          <span style="color:var(--blue);">üìå</span>
          <div style="flex:1;min-width:0;">
            <div style="font-size:.68rem;font-weight:900;color:var(--blue);text-transform:uppercase;letter-spacing:.05em;">Sabitlenmi≈ü Mesaj</div>
            <div id="deskPinBarText" style="font-size:.78rem;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
          </div>
          <div onclick="event.stopPropagation();unpinMsg()" style="font-size:1rem;color:var(--muted);cursor:pointer;padding:2px 6px;border-radius:4px;">‚úï</div>
        </div>
        <div style="flex:1;display:flex;overflow:hidden;position:relative;">
        <!-- Drag & Drop Overlay (Desktop) -->
        <div id="deskDropOverlay">
          <div class="drop-icon">üìÇ</div>
          <div class="drop-text">Dosyayƒ± buraya bƒ±rak</div>
          <div class="drop-sub">PNG ¬∑ JPG ¬∑ PDF ¬∑ ZIP desteklenir</div>
        </div>
        <!-- Scroll-to-Bottom Butonu (Desktop) -->
        <div id="deskScrollToBottomBtn" onclick="deskScrollToBottom()">
          <span>‚Üì</span>
          <div class="stb-badge">yeni</div>
        </div>
        <!-- Messages -->
        <div id="deskMsgs" onclick="document.activeElement&&document.activeElement.blur()">
        </div>

        <!-- Members panel -->
        <div id="deskMemberPanel" class="hidden">
          <div class="desk-mp-title">√úyeler</div>
          <div class="desk-mp-list" id="deskMemberList"></div>
        </div>
        </div><!-- end inner flex -->
      </div>

      <!-- Input area -->
      <div id="deskInputArea">
        <div id="deskInputBox">
          <button class="dsk-inp-btn" onclick="toggleEmoji()" title="Emoji">üòä</button>
          <button class="dsk-inp-btn" onclick="pickFile()" title="Dosya">üìé</button>
          <textarea id="deskInp" rows="1" placeholder="Mesaj yaz..." oninput="deskInpResize(this)" onkeydown="onDeskMsgKey(event)"></textarea>
          <span class="rec-timer" id="deskRecTimer">0:00</span>
          <button class="voice-record-btn" id="deskVoiceRecordBtn" title="Sesli mesaj" onclick="toggleVoiceRecord('desk')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="2" width="6" height="12" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="9" y1="22" x2="15" y2="22"/></svg>
          </button>
          <button id="deskSendBtn" onclick="sendDeskMsg()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Forum / Friends / Profile panels -->
    <div id="deskPanelContent" style="flex:1;overflow-y:auto;display:none;"></div>
  </div>
</div>


<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<!-- ‚ïê‚ïê‚ïê SUNUCU SE√áƒ∞M EKRANI ‚ïê‚ïê‚ïê -->
<div class="screen active" id="serverSelectScreen" style="align-items:center;justify-content:center;padding:24px;background:linear-gradient(145deg,var(--purple-dark) 0%,var(--bg2) 40%,var(--purple) 70%,var(--purple-dark) 100%);">
  <div style="position:relative;z-index:1;width:100%;max-width:400px;">
    <div style="text-align:center;margin-bottom:32px;">
      <div style="display:flex;justify-content:center;margin-bottom:10px;"><svg viewBox="0 0 120 120" width="64" height="64" xmlns="http://www.w3.org/2000/svg"><defs><clipPath id="lcss"><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z"/></clipPath></defs><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="#0e2b0c"/><g clip-path="url(#lcss)"><line x1="60" y1="14" x2="60" y2="108" stroke="#4a8f40" stroke-width="1.2"/><line x1="60" y1="35" x2="78" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="35" x2="42" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="52" x2="82" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="52" x2="38" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="68" x2="78" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="68" x2="42" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="82" x2="70" y2="94" stroke="#4a8f40" stroke-width=".4"/><line x1="60" y1="82" x2="50" y2="94" stroke="#4a8f40" stroke-width=".4"/></g><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="none" stroke="#4a8f40" stroke-width="1.2"/></svg></div>
      <div style="font-size:1.5rem;font-weight:900;color:var(--text-hi);margin-bottom:6px;">Nature.co</div>
      <div style="font-size:.85rem;color:var(--muted);">Baƒülanmak istediƒüin sunucuyu se√ß</div>
    </div>

    <div id="serverList" style="display:flex;flex-direction:column;gap:12px;">
      <!-- JS tarafƒ±ndan doldurulur -->
    </div>

    <div style="margin-top:24px;text-align:center;font-size:.72rem;color:var(--muted);">
      Her sunucu baƒüƒ±msƒ±zdƒ±r ‚Äî ayrƒ± hesap, ayrƒ± odalar
    </div>
  </div>
</div>

<div class="screen" id="loginScreen">
  <div class="login-box">
    <div style="display:flex;align-items:center;margin-bottom:8px;">
      <div onclick="backToServerSelect()" style="font-size:.75rem;color:var(--muted);cursor:pointer;padding:4px 8px;border-radius:6px;background:var(--surface);border:1px solid var(--border);display:flex;align-items:center;gap:4px;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">‚Äπ Sunucu</div>
    </div>
    <div class="login-logo"><svg viewBox="0 0 120 120" width="56" height="56" xmlns="http://www.w3.org/2000/svg"><defs><clipPath id="lcll"><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z"/></clipPath></defs><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="#0e2b0c"/><g clip-path="url(#lcll)"><line x1="60" y1="14" x2="60" y2="108" stroke="#4a8f40" stroke-width="1.2"/><line x1="60" y1="35" x2="78" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="35" x2="42" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="52" x2="82" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="52" x2="38" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="68" x2="78" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="68" x2="42" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="82" x2="70" y2="94" stroke="#4a8f40" stroke-width=".4"/><line x1="60" y1="82" x2="50" y2="94" stroke="#4a8f40" stroke-width=".4"/></g><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="none" stroke="#4a8f40" stroke-width="1.2"/></svg></div>
    <div class="login-title">Nature.co</div>


    <!-- Sekme -->
    <div style="display:flex;background:var(--surface);border-radius:10px;padding:3px;margin-bottom:18px;gap:3px;">
      <div id="tabGiris" onclick="showLoginTab('giris')" style="flex:1;padding:9px;text-align:center;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;background:var(--surface2);color:var(--text-hi);transition:all .15s;">Giri≈ü Yap</div>
      <div id="tabKayit" onclick="showLoginTab('kayit')" style="flex:1;padding:9px;text-align:center;border-radius:8px;font-size:.82rem;font-weight:700;cursor:pointer;color:var(--muted);transition:all .15s;">Kayƒ±t Ol</div>
    </div>

    <div class="login-err" id="loginErr"></div>

    <!-- Gƒ∞Rƒ∞≈û FORMU -->
    <div id="girisForm">
      <!-- ADIM 1: Kullanƒ±cƒ± adƒ± -->
      <div id="loginStep1">
        <div class="login-field">
          <div class="login-label">Kullanƒ±cƒ± Adƒ±</div>
          <input class="login-inp" id="loginUser" type="text" placeholder="Kullanƒ±cƒ± adƒ±n..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
        </div>
        <button class="login-btn" onclick="loginNext()">ƒ∞leri ‚Üí</button>
      </div>
      <!-- ADIM 2: G√ºvenlik Kodu -->
      <div id="loginStep2" style="display:none;">
        <div class="login-field" style="display:flex;align-items:center;gap:8px;margin-bottom:14px;">
          <div style="width:32px;height:32px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:900;color:#fff;flex-shrink:0;" id="loginUserAvatar"></div>
          <div>
            <div style="font-size:.82rem;font-weight:700;color:var(--text-hi);" id="loginUserLabel"></div>
            <div style="font-size:.7rem;color:var(--muted);">hesabƒ±na giri≈ü yapƒ±lƒ±yor</div>
          </div>
          <div style="margin-left:auto;font-size:.8rem;color:var(--blue);cursor:pointer;" onclick="loginBack()">‚Üê Deƒüi≈ütir</div>
        </div>
        <div class="login-field">
          <div class="login-label">Doƒürulama</div>
          <input class="login-inp" id="loginPass" type="password" placeholder="Kodunu gir..." autocomplete="new-password" autocorrect="off" autocapitalize="none" spellcheck="false">
        </div>
        <button class="login-btn" id="loginBtn" onclick="submitLogin()">Giri≈ü Yap ‚Üí</button>
      </div>
    </div>

    <!-- KAYIT FORMU -->
    <!-- Kayƒ±t kapalƒ± mesajƒ± -->
    <div id="regClosedMsg" style="display:none;padding:24px 16px;text-align:center;">
      <div style="font-size:42px;margin-bottom:12px;">üîí</div>
      <div style="font-size:16px;font-weight:700;color:var(--text-hi);margin-bottom:8px;">Kayƒ±t ≈ûu An Kapalƒ±</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:20px;">Bu sunucuda yeni √ºye alƒ±mƒ± ge√ßici olarak durdurulmu≈ütur.</div>
      <div id="regClosedOtherServers" style="display:flex;flex-direction:column;gap:10px;"></div>
    </div>
    <div id="kayitForm" style="display:none;">
      <div class="login-field">
        <div class="login-label">Davet Kodu <span style="font-size:.7rem;color:var(--muted);">(Adminden alƒ±n)</span></div>
        <input class="login-inp" id="regInviteCode" type="text" placeholder="Davet kodunu girin..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
        </div>
      <div class="login-field">
        <div class="login-label">Kullanƒ±cƒ± Adƒ±</div>
        <input class="login-inp" id="regUser" type="text" placeholder="Kullanƒ±cƒ± adƒ±n..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
      </div>
      <div class="login-field">
        <div class="login-label">E-posta Adresi</div>
        <input class="login-inp" id="regEmail" type="email" placeholder="ornek@mail.com" autocomplete="email" autocorrect="off" autocapitalize="none" spellcheck="false">
      </div>
      <div class="login-field">
          <div class="login-label">Doƒürulama</div>
          <input class="login-inp" id="regPass" type="password" placeholder="En az 6 karakter..." autocomplete="new-password" autocorrect="off" autocapitalize="none" spellcheck="false">
      </div>
      <div class="login-field">
          <div class="login-label">Doƒürulama (tekrar)</div>
          <input class="login-inp" id="regPass2" type="password" placeholder="Tekrar gir..." autocomplete="new-password" autocorrect="off" autocapitalize="none" spellcheck="false">
      </div>
      <div class="login-field">
        <div class="login-label">K√∂ken / Uyruk</div>
        <select class="login-inp" id="regOrigin" style="-webkit-appearance:none;cursor:pointer;">
          <option value="">‚Äî Se√ßiniz ‚Äî</option>
              <option value="üáπüá∑ T√ºrk">üáπüá∑ T√ºrk</option>
              <option value="üá¶üáø Azerbaycanlƒ±">üá¶üáø Azerbaycanlƒ±</option>
              <option value="üá∫üáø √ñzbek">üá∫üáø √ñzbek</option>
              <option value="üáπüá≤ T√ºrkmen">üáπüá≤ T√ºrkmen</option>
              <option value="üá∞üáø Kazak">üá∞üáø Kazak</option>
              <option value="üá∞üá¨ Kƒ±rgƒ±z">üá∞üá¨ Kƒ±rgƒ±z</option>
              <option value="üá∫üá¶ Ukraynalƒ±">üá∫üá¶ Ukraynalƒ±</option>
              <option value="üá∑üá∫ Rus">üá∑üá∫ Rus</option>
              <option value="üá©üá™ Alman">üá©üá™ Alman</option>
              <option value="üá¨üáß ƒ∞ngiliz">üá¨üáß ƒ∞ngiliz</option>
              <option value="üá´üá∑ Fransƒ±z">üá´üá∑ Fransƒ±z</option>
              <option value="üá≥üá± Hollandalƒ±">üá≥üá± Hollandalƒ±</option>
              <option value="üáßüá™ Bel√ßikalƒ±">üáßüá™ Bel√ßikalƒ±</option>
              <option value="üá¶üáπ Avusturyalƒ±">üá¶üáπ Avusturyalƒ±</option>
              <option value="üá®üá≠ ƒ∞svi√ßreli">üá®üá≠ ƒ∞svi√ßreli</option>
              <option value="üá∏üá™ ƒ∞sve√ßli">üá∏üá™ ƒ∞sve√ßli</option>
              <option value="üá≥üá¥ Norve√ßli">üá≥üá¥ Norve√ßli</option>
              <option value="üá©üá∞ Danimarkalƒ±">üá©üá∞ Danimarkalƒ±</option>
              <option value="üá´üáÆ Finlandiyalƒ±">üá´üáÆ Finlandiyalƒ±</option>
              <option value="üáÆüáπ ƒ∞talyan">üáÆüáπ ƒ∞talyan</option>
              <option value="üá™üá∏ ƒ∞spanyol">üá™üá∏ ƒ∞spanyol</option>
              <option value="üáµüáπ Portekizli">üáµüáπ Portekizli</option>
              <option value="üá¨üá∑ Yunan">üá¨üá∑ Yunan</option>
              <option value="üáßüá¨ Bulgar">üáßüá¨ Bulgar</option>
              <option value="üá∑üá¥ Rumen">üá∑üá¥ Rumen</option>
              <option value="üáµüá± Polonyalƒ±">üáµüá± Polonyalƒ±</option>
              <option value="üá≠üá∫ Macar">üá≠üá∫ Macar</option>
              <option value="üá®üáø √áek">üá®üáø √áek</option>
              <option value="üá∏üá∞ Slovak">üá∏üá∞ Slovak</option>
              <option value="üá∑üá∏ Sƒ±rp">üá∑üá∏ Sƒ±rp</option>
              <option value="üá≠üá∑ Hƒ±rvat">üá≠üá∑ Hƒ±rvat</option>
              <option value="üáßüá¶ Bo≈ünak">üáßüá¶ Bo≈ünak</option>
              <option value="üá∏üáÆ Sloven">üá∏üáÆ Sloven</option>
              <option value="üá≤üá∞ Makedon">üá≤üá∞ Makedon</option>
              <option value="üá¶üá± Arnavut">üá¶üá± Arnavut</option>
              <option value="üá≤üá™ Karadaƒülƒ±">üá≤üá™ Karadaƒülƒ±</option>
              <option value="üá∏üáæ Suriyeli">üá∏üáæ Suriyeli</option>
              <option value="üáÆüá∂ Iraklƒ±">üáÆüá∂ Iraklƒ±</option>
              <option value="üáÆüá∑ ƒ∞ranlƒ±">üáÆüá∑ ƒ∞ranlƒ±</option>
              <option value="üá¶üá´ Afganlƒ±">üá¶üá´ Afganlƒ±</option>
              <option value="üáµüá∞ Pakistanlƒ±">üáµüá∞ Pakistanlƒ±</option>
              <option value="üáÆüá≥ Hintli">üáÆüá≥ Hintli</option>
              <option value="üáßüá© Banglade≈üli">üáßüá© Banglade≈üli</option>
              <option value="üá®üá≥ √áinli">üá®üá≥ √áinli</option>
              <option value="üáØüáµ Japon">üáØüáµ Japon</option>
              <option value="üá∞üá∑ Koreli">üá∞üá∑ Koreli</option>
              <option value="üá∏üá¶ Suudi Arabistanlƒ±">üá∏üá¶ Suudi Arabistanlƒ±</option>
              <option value="üá¶üá™ BAE'li">üá¶üá™ BAE'li</option>
              <option value="üá∂üá¶ Katarlƒ±">üá∂üá¶ Katarlƒ±</option>
              <option value="üá≤üá¶ Faslƒ±">üá≤üá¶ Faslƒ±</option>
              <option value="üá©üáø Cezayirli">üá©üáø Cezayirli</option>
              <option value="üáπüá≥ Tunuslu">üáπüá≥ Tunuslu</option>
              <option value="üá™üá¨ Mƒ±sƒ±rlƒ±">üá™üá¨ Mƒ±sƒ±rlƒ±</option>
              <option value="üá±üáæ Libyalƒ±">üá±üáæ Libyalƒ±</option>
              <option value="üá∏üá¥ Somalili">üá∏üá¥ Somalili</option>
              <option value="üá™üáπ Etiyopyalƒ±">üá™üáπ Etiyopyalƒ±</option>
              <option value="üá≥üá¨ Nijeryalƒ±">üá≥üá¨ Nijeryalƒ±</option>
              <option value="üáøüá¶ G√ºney Afrikalƒ±">üáøüá¶ G√ºney Afrikalƒ±</option>
              <option value="üá∫üá∏ Amerikalƒ±">üá∫üá∏ Amerikalƒ±</option>
              <option value="üá®üá¶ Kanadalƒ±">üá®üá¶ Kanadalƒ±</option>
              <option value="üá≤üáΩ Meksikalƒ±">üá≤üáΩ Meksikalƒ±</option>
              <option value="üáßüá∑ Brezilyalƒ±">üáßüá∑ Brezilyalƒ±</option>
              <option value="üá¶üá∑ Arjantinli">üá¶üá∑ Arjantinli</option>
              <option value="üá¶üá∫ Avustralyalƒ±">üá¶üá∫ Avustralyalƒ±</option>
              <option value="üåç Diƒüer">üåç Diƒüer</option>
        </select>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px;padding:10px 2px;">
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <input type="checkbox" id="regTosCheck" style="width:18px;height:18px;min-width:18px;margin-top:2px;accent-color:#2ecc71;cursor:pointer;">
          <label for="regTosCheck" style="font-size:12.5px;color:#bbb;line-height:1.5;cursor:pointer;">
            <a href="#" onclick="event.preventDefault();showTosTab('tos');document.getElementById('tosModal').style.display='block'" style="color:#2ecc71;text-decoration:underline;">√úyelik S√∂zle≈ümesi</a>'ni okudum, anladƒ±m ve kabul ediyorum.
          </label>
        </div>
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <input type="checkbox" id="regKvkkCheck" style="width:18px;height:18px;min-width:18px;margin-top:2px;accent-color:#2ecc71;cursor:pointer;">
          <label for="regKvkkCheck" style="font-size:12.5px;color:#bbb;line-height:1.5;cursor:pointer;">
            <a href="#" onclick="event.preventDefault();showTosTab('kvkk');document.getElementById('tosModal').style.display='block'" style="color:#2ecc71;text-decoration:underline;">KVKK Aydƒ±nlatma Metni</a>'ni okudum; k√∂ken/milliyet bilgisinin √∂zel nitelikli veri olarak i≈ülenmesine <strong style="color:#fff;">a√ßƒ±k rƒ±za</strong> veriyorum.
          </label>
        </div>
      </div>
            <button class="login-btn" id="regBtn" onclick="submitRegister()">Kayƒ±t Ol ‚Üí</button>
      <!-- Kod doƒürulama adƒ±mƒ± -->
      <div id="regVerifyStep" style="display:none;margin-top:12px;">
        <div class="login-label" style="margin-bottom:6px;">üìß E-postana onay kodu g√∂nderildi. Kodu girin:</div>
        <input class="login-inp" id="regVerifyCode" type="text" placeholder="6 haneli kod..." maxlength="6" autocomplete="one-time-code" style="text-align:center;letter-spacing:6px;font-size:22px;">
        <button class="login-btn" id="regVerifyBtn" onclick="verifyRegCode()" style="margin-top:8px;">Hesabƒ± Aktifle≈ütir ‚úì</button>
        <div style="margin-top:8px;font-size:12px;color:#aaa;text-align:center;">Kod gelmedi mi? <span style="color:#e67e22;cursor:pointer;" onclick="resendRegCode()">Tekrar g√∂nder</span></div>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê ROOMS ‚ïê‚ïê -->
<div class="screen" id="roomsScreen">
  <div id="ptr-indicator">‚Üª</div>
  <div class="ws-header">
    <div class="ws-name" id="wsHeaderName" onclick="showServerSwitchModal()" style="cursor:pointer;" title="Sunucu deƒüi≈ütir">Nature.co</div>
    <div style="display:flex;align-items:center;gap:8px;">
      <div onclick="openNotifCenter()" title="Bildirimler" style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:9px;cursor:pointer;position:relative;color:rgba(255,255,255,.7);transition:background .15s;" onmouseover="this.style.background='rgba(255,255,255,.08)'" onmouseout="this.style.background='transparent'">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <div id="mobNotifDot" style="display:none;position:absolute;top:4px;right:4px;width:8px;height:8px;background:var(--red);border-radius:50%;border:2px solid var(--purple);"></div>
      </div>
      <div class="ws-av" id="myAvatar" onclick="openProfile()"><div class="sdot"></div></div>
      <!-- Robot yuvasƒ±: bell ‚Üí profil ‚Üí robot sƒ±rasƒ± -->
      <div id="mobileRobotSlot" style="width:40px;height:44px;flex-shrink:0;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:10px;"></div>
    </div>
  </div>
  <div class="search-row" onclick="openGlobalSearch()" style="cursor:pointer;">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    <span style="color:var(--muted);font-size:.85rem;">Ki≈üi, oda veya forum ara...</span>
  </div>
  <div class="rooms-scroll" id="roomsList">
  </div>
  <div class="tab-bar">
    <div class="tab act" id="tabHome" onclick="switchMainTab('home')"><div class="tab-ic-wrap"><div class="tab-ic">üè†</div></div><div class="tab-lb">Ana Sayfa</div></div>
    <div class="tab" onclick="openDMModal()"><div class="tab-ic-wrap"><div class="tab-ic">üí¨</div></div><div class="tab-lb">Mesajlar</div></div>
    <div class="tab" id="tabForum" onclick="switchMainTab('forum')"><div class="tab-ic-wrap"><div class="tab-ic">üìã</div></div><div class="tab-lb">Forum</div></div>
    <div class="tab-wrap" onclick="openFriendsModal()"><div class="tab"><div class="tab-ic-wrap"><div class="tab-ic">üë•</div></div><div class="tab-lb">Arkada≈ülar</div></div><div class="notif-dot" id="frNotifDot"></div></div>
    <div class="tab" onclick="switchMainTab('watch')"><div class="tab-ic-wrap"><div class="tab-ic">üì∫</div></div><div class="tab-lb">ƒ∞zle</div></div>
  </div>
</div>


<!-- ‚ïê‚ïê FORUM ‚ïê‚ïê -->
<div class="screen" id="forumScreen">
  <div class="ws-header">
    
    <div class="ws-name">üìã Forum</div>
    <div class="ws-av" id="forumAvatar" onclick="openProfile()"><div class="sdot"></div></div>
  </div>

  <!-- Yeni Payla≈üƒ±m Kutusu -->
  <div id="forumNewPost" style="padding:10px 12px;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;">
    <div style="display:flex;gap:10px;align-items:flex-start;">
      <div id="forumMyAv" style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:900;color:#fff;flex-shrink:0;background:#5b9bd5;"></div>
      <div style="flex:1;">
        <!-- Rich Text / BBCode Edit√∂r Kutusu -->
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:border-color .15s;" id="forumEditorWrap"
          onfocusin="this.style.borderColor='var(--accent)'" onfocusout="this.style.borderColor='var(--border)'">
          <!-- Toolbar -->
          <div id="forumToolbar" style="display:flex;flex-wrap:nowrap;overflow-x:auto;overflow-y:hidden;gap:1px;padding:6px 8px;border-bottom:1px solid var(--border);background:var(--surface2);align-items:center;scrollbar-width:none;-webkit-overflow-scrolling:touch;" onscroll="this.style.setProperty('--tb-scroll',this.scrollLeft+'px')">
            <button onclick="bbWrap('b')" title="Kalƒ±n" class="fmt-btn"><b>B</b></button>
            <button onclick="bbWrap('i')" title="ƒ∞talik" class="fmt-btn"><i>I</i></button>
            <button onclick="bbWrap('u')" title="Altƒ± √áizili" class="fmt-btn"><u>U</u></button>
            <button onclick="bbWrap('s')" title="√úst√º √áizili" class="fmt-btn"><s>S</s></button>
            <span style="width:1px;height:18px;background:var(--border);margin:0 4px;flex-shrink:0;"></span>
            <button onclick="bbColor()" title="Renk" class="fmt-btn" style="font-size:.85rem;">üé®</button>
            <button onclick="bbSize()" title="Yazƒ± boyutu" class="fmt-btn" style="font-size:.78rem;font-weight:700;">Aa</button>
            <span style="width:1px;height:18px;background:var(--border);margin:0 4px;flex-shrink:0;"></span>
            <button onclick="bbWrap('url')" title="Link" class="fmt-btn">üîó</button>
            <button onclick="bbWrap('img')" title="Resim URL" class="fmt-btn" style="font-size:.85rem;">üñºÔ∏è</button>
            <span style="width:1px;height:18px;background:var(--border);margin:0 4px;flex-shrink:0;"></span>
            <button onclick="bbInsert('[list]\n[*] ')" title="Liste" class="fmt-btn" style="font-size:.85rem;">‚Ä¢ ‚â°</button>
            <button onclick="bbWrap('quote')" title="Alƒ±ntƒ±" class="fmt-btn" style="font-size:.95rem;">‚ùù</button>
            <button onclick="bbWrap('code')" title="Kod" class="fmt-btn" style="font-family:monospace;font-size:.8rem;">&lt;/&gt;</button>
            <button onclick="bbWrap('spoiler')" title="Spoiler" class="fmt-btn" style="font-size:.75rem;">üëÅÔ∏è</button>
            <span style="width:1px;height:18px;background:var(--border);margin:0 4px;flex-shrink:0;"></span>
            <button onclick="toggleBbPreview()" title="√ñnizleme" class="fmt-btn" id="bbPreviewBtn" style="font-size:.75rem;font-weight:700;">üëÅ √ñnizle</button>
          </div>
          <!-- Textarea -->
          <textarea id="forumPostInp" placeholder="D√º≈ü√ºncelerini payla≈ü..." rows="3"
            style="width:100%;background:transparent;border:none;padding:10px 13px;color:var(--text-hi);font-size:.9rem;font-family:inherit;outline:none;resize:none;-webkit-appearance:none;line-height:1.5;box-sizing:border-box;display:block;min-height:80px;max-height:200px;"
            oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,200)+'px'"></textarea>
          <!-- √ñnizleme alanƒ± -->
          <div id="bbPreviewArea" style="display:none;padding:10px 13px;min-height:60px;border-top:1px solid var(--border);font-size:.9rem;line-height:1.6;color:var(--text-hi);background:var(--bg2);word-break:break-word;"></div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:7px;">
          <div style="display:flex;gap:6px;">
            <select id="forumCategorySelect" onchange="onForumCatChange(this.value)" style="background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--muted);font-size:.75rem;padding:4px 8px;outline:none;cursor:pointer;">
              <option value="" disabled selected>‚Äî Kategori se√ß ‚Äî</option>
              <option value="genel">üí¨ Genel</option>
              <option value="tarih">üìú Tarih</option>
              <option value="kultur">üé≠ K√ºlt√ºr</option>
              <option value="spor">‚öΩ Spor</option>
              <option value="muzik">üéµ M√ºzik</option>
              <option value="teknoloji">üíª Teknoloji</option>
              <option value="soru">‚ùì Soru</option>
            </select>
          </div>
          <button onclick="submitForumPost()" style="background:#5b9bd5;border:none;border-radius:8px;color:#fff;padding:7px 18px;font-size:.82rem;font-weight:700;cursor:pointer;transition:opacity .15s;" onmousedown="this.style.opacity='.7'" onmouseup="this.style.opacity='1'">Payla≈ü ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Kategori Filtresi -->
  <div style="display:flex;gap:6px;padding:8px 12px;overflow-x:auto;flex-shrink:0;-webkit-overflow-scrolling:touch;" id="forumCatFilter">
    <div class="fcat act" onclick="filterForum('hepsi')" data-cat="hepsi">T√ºm√º</div>
    <div class="fcat" onclick="filterForum('genel')" data-cat="genel">üí¨ Genel</div>
    <div class="fcat" onclick="filterForum('tarih')" data-cat="tarih">üìú Tarih</div>
    <div class="fcat" onclick="filterForum('kultur')" data-cat="kultur">üé≠ K√ºlt√ºr</div>
    <div class="fcat" onclick="filterForum('spor')" data-cat="spor">‚öΩ Spor</div>
    <div class="fcat" onclick="filterForum('muzik')" data-cat="muzik">üéµ M√ºzik</div>
    <div class="fcat" onclick="filterForum('teknoloji')" data-cat="teknoloji">üíª Teknoloji</div>
    <div class="fcat" onclick="filterForum('soru')" data-cat="soru">‚ùì Soru</div>
  </div>

  <!-- G√∂nderiler Listesi -->
  <div id="forumFeed" style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:6px 12px 80px;">
  </div>

  <div class="tab-bar"><div class="tab" onclick="switchMainTab('home')"><div class="tab-ic-wrap"><div class="tab-ic">üè†</div></div><div class="tab-lb">Ana Sayfa</div></div><div class="tab" onclick="openDMModal()"><div class="tab-ic-wrap"><div class="tab-ic">üí¨</div></div><div class="tab-lb">Mesajlar</div></div><div class="tab act" onclick="switchMainTab('forum')"><div class="tab-ic-wrap"><div class="tab-ic">üìã</div></div><div class="tab-lb">Forum</div></div><div class="tab-wrap" onclick="openFriendsModal()"><div class="tab"><div class="tab-ic-wrap"><div class="tab-ic">üë•</div></div><div class="tab-lb">Arkada≈ülar</div></div></div><div class="tab" onclick="switchMainTab('watch')"><div class="tab-ic-wrap"><div class="tab-ic">üì∫</div></div><div class="tab-lb">ƒ∞zle</div></div></div>
</div>

<!-- ‚ïê‚ïê CHAT ‚ïê‚ïê -->
<div class="screen" id="chatScreen">
  <div class="c-header">
    <div class="back-btn" onclick="goBack()">‚Äπ</div>
    <div class="c-hdr-ic" id="chatHdrIcon">?</div>
    <div class="c-hdr-body">
      <div class="c-hdr-name" id="chatHdrName">‚Äî</div>
      <div class="c-hdr-sub" id="chatHdrSub">‚Äî</div>
    </div>
    <div class="hdr-btns">
      <div class="hdr-btn" id="chatSearchBtn" onclick="toggleChatSearch()" title="Ara" style="display:flex;">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      </div>
      <div class="hdr-btn" id="callAudioBtn" onclick="startCall('audio')" style="display:none" title="Sesli Ara">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.81 19.79 19.79 0 01.22 1.18 2 2 0 012.18 0h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.91 7.91a16 16 0 006.06 6.06l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
      </div>
      <div class="hdr-btn" id="callVideoBtn" onclick="startCall('video')" style="display:none" title="G√∂r√ºnt√ºl√º Ara">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
      </div>
      <div class="hdr-btn" id="callScreenBtn" onclick="startCall('screen')" style="display:none" title="Ekran Payla≈ü">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      </div>
      <div class="hdr-btn" id="chatMenuBtn" onclick="toggleChatMenu(event)">‚ãÆ</div>
    </div>
  </div>
  <!-- Chat context menu -->
  <div id="chatContextMenu" style="display:none;position:fixed;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:6px 0;z-index:500;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,.5);"></div>
  <!-- Arama √ßubuƒüu -->
  <div id="chatSearchBar">
    <button onclick="toggleChatSearch()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;padding:2px 4px;">‚úï</button>
    <input id="chatSearchInp" placeholder="Mesajlarda ara..." oninput="onChatSearch()" />
    <span id="chatSearchCount"></span>
    <button onclick="chatSearchNav(-1)" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;">‚Üë</button>
    <button onclick="chatSearchNav(1)" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1rem;">‚Üì</button>
  </div>
  <!-- Sabitlenen mesaj √ßubuƒüu -->
  <div id="pinBar">
    <div class="pin-icon">üìå</div>
    <div style="flex:1;min-width:0;">
      <div class="pin-label">Sabitlenmi≈ü Mesaj</div>
      <div class="pin-text" id="pinBarText"></div>
    </div>
    <div class="pin-close" onclick="event.stopPropagation();unpinMsg()">‚úï</div>
  </div>
  <!-- Admin panel (Mobil) -->
  <div id="adminSpyBanner" style="display:none;align-items:center;gap:8px;background:rgba(245,166,35,.08);border-bottom:1px solid rgba(245,166,35,.25);padding:7px 14px;flex-shrink:0;"></div>
  <!-- Mesaj saƒü tƒ±k men√ºs√º -->
  <div id="msgCtxMenu"></div>
  <!-- S√ºr√ºkle-Bƒ±rak Overlay -->
  <div id="dropOverlay">
    <div class="drop-icon">üìÇ</div>
    <div class="drop-text">Dosyayƒ± buraya bƒ±rak</div>
    <div class="drop-sub">PNG ¬∑ JPG ¬∑ PDF ¬∑ ZIP desteklenir</div>
  </div>
  <div id="chatMsgs" onclick="document.activeElement&&document.activeElement.blur();closeEmoji()"></div>
  <!-- Scroll-to-Bottom Butonu -->
  <div id="scrollToBottomBtn" onclick="scrollToBottomSmooth()">
    <span>‚Üì</span>
    <div class="stb-badge" id="stbBadge">yeni</div>
  </div>
  <div id="emojiPicker"></div>
  <div class="inp-wrap" id="chatInputRow">
    <div class="inp-box">
      <textarea id="msgInp" rows="1" placeholder="Mesaj yaz..." oninput="autoResize(this)" onkeydown="onMsgKey(event)"></textarea>
      <div class="inp-btm">
        <div class="ii" onclick="toggleEmoji()">üòä</div>
        <div class="ii" onclick="pickFile()">üìé</div>
        <button class="voice-record-btn" id="voiceRecordBtn" title="Sesli mesaj" onclick="toggleVoiceRecord('mob')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="2" width="6" height="12" rx="3"/><path d="M5 10a7 7 0 0 0 14 0"/><line x1="12" y1="17" x2="12" y2="22"/><line x1="9" y1="22" x2="15" y2="22"/></svg>
        </button>
        <span class="rec-timer" id="recTimer">0:00</span>
        <div class="ii" style="font-weight:900;font-size:.9rem;">@</div>
        <input type="file" id="fileInput" style="display:none" onchange="handleFile(this)">
        <button class="send-btn" id="sendBtn" onclick="sendMsg()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê ADMIN PANEL ‚ïê‚ïê -->
<div class="screen" id="adminPanel">
  <div class="admin-header">
    <div style="width:32px;height:32px;border-radius:9px;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M2 19h20v2H2v-2z" fill="#f0c040"/><path d="M2 19l3-9 4.5 4.5L12 5l2.5 9.5L19 10l3 9H2z" fill="#f0c040" stroke="#d4a017" stroke-width="1" stroke-linejoin="round"/><circle cx="2" cy="10" r="1.5" fill="#f0c040"/><circle cx="12" cy="5" r="1.5" fill="#f0c040"/><circle cx="22" cy="10" r="1.5" fill="#f0c040"/></svg>
    </div>
    <div>
      <div class="admin-title">Admin Paneli</div>
      <div id="adminSrvLabel" style="font-size:.65rem;color:rgba(255,255,255,.5);margin-top:1px;"></div>
    </div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
      <div id="adminOnlineBadge" style="font-size:.68rem;color:#2eb67d;background:rgba(46,182,125,.12);border:1px solid rgba(46,182,125,.2);border-radius:100px;padding:3px 9px;font-weight:800;"></div>
      <div class="admin-close" onclick="closeAdminPanel()">‚úï</div>
    </div>
  </div>
  <!-- Sunucu Switcher -->
  <div id="adminSrvSwitcher" style="display:flex;gap:6px;padding:8px 10px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;"></div>
  <div class="admin-tabs">
    <div class="atab act" onclick="adminTab('users')"><span class="atab-icon">üë•</span>√úyeler</div>
    <div class="atab" onclick="adminTab('rooms')"><span class="atab-icon">üì¢</span>Odalar</div>
    <div class="atab" onclick="adminTab('msgs')"><span class="atab-icon">üí¨</span>Mesajlar</div>
    <div class="atab" onclick="adminTab('forum')"><span class="atab-icon">üìã</span>Forum</div>
    <div class="atab" onclick="adminTab('announce')"><span class="atab-icon">üì£</span>Duyuru</div>
    <div class="atab" onclick="adminTab('games')"><span class="atab-icon">üéÆ</span>Oyunlar</div>
    <div class="atab" onclick="adminTab('health')"><span class="atab-icon">üìä</span>Sistem</div>
    <div class="atab" onclick="adminTab('security')"><span class="atab-icon">üõ°Ô∏è</span>G√ºvenlik</div>
    <div class="atab" onclick="adminTab('ipbans')"><span class="atab-icon">üåê</span>IP Banlar</div>
    <div class="atab" onclick="adminTab('settings')"><span class="atab-icon">‚öôÔ∏è</span>Ayarlar</div>
    <div class="atab" onclick="adminTab('naturebot')"><span class="atab-icon">ü§ñ</span>NatureBot</div>
  </div>
  <div class="admin-body" id="adminBody">
  </div>
</div>

<!-- ‚ïê‚ïê ARKADA≈ûLAR EKRANI ‚ïê‚ïê -->
<div class="screen" id="friendsScreen">
  <div class="ws-header">
    
    <div class="ws-name">üë• Arkada≈ülar</div>
    <button class="fr-btn add" style="margin-left:auto;margin-right:0;font-size:.75rem;" onclick="switchFrTab(3)">+ Ekle</button>
  </div>
  <div style="padding:8px 12px 4px;flex-shrink:0;">
    <div style="display:flex;gap:0;background:var(--surface);border-radius:10px;padding:4px;gap:2px;">
      <div class="ltab act" id="frTab1" onclick="switchFrTab(1)">üë• Arkada≈ülar</div>
      <div class="ltab" id="frTab2" onclick="switchFrTab(2)">üì© ƒ∞stekler <span id="frReqBadge" style="display:none;background:var(--red);color:#fff;border-radius:100px;padding:0 5px;font-size:.62rem;font-weight:900;margin-left:3px"></span></div>
      <div class="ltab" id="frTab3" onclick="switchFrTab(3)">üîç Ki≈üi Ekle</div>
    </div>
  </div>
  <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:8px 12px;" id="frContent">
  </div>
  <div class="tab-bar"><div class="tab" onclick="switchMainTab('home')"><div class="tab-ic-wrap"><div class="tab-ic">üè†</div></div><div class="tab-lb">Ana Sayfa</div></div><div class="tab" onclick="openDMModal()"><div class="tab-ic-wrap"><div class="tab-ic">üí¨</div></div><div class="tab-lb">Mesajlar</div></div><div class="tab" onclick="switchMainTab('forum')"><div class="tab-ic-wrap"><div class="tab-ic">üìã</div></div><div class="tab-lb">Forum</div></div><div class="tab-wrap act" onclick="openFriendsModal()"><div class="tab act"><div class="tab-ic-wrap"><div class="tab-ic">üë•</div></div><div class="tab-lb">Arkada≈ülar</div></div></div><div class="tab" onclick="switchMainTab('watch')"><div class="tab-ic-wrap"><div class="tab-ic">üì∫</div></div><div class="tab-lb">ƒ∞zle</div></div></div>
</div>

<!-- ‚ïê‚ïê MESAJLAR EKRANI ‚ïê‚ïê -->
<div class="screen" id="msgsScreen">
  <div class="ws-header">
    
    <div class="ws-name">üí¨ Mesajlar</div>
  </div>
  <div style="padding:10px 12px;flex-shrink:0;">
    <input style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 13px;color:var(--text-hi);font-size:.9rem;font-family:inherit;outline:none;-webkit-appearance:none;" type="text" placeholder="Ki≈üi ara..." id="dmSearch" oninput="filterDMUsers()" autocorrect="off" autocapitalize="none">
  </div>
  <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 12px 8px;" id="dmUserList">
  </div>
  <div class="tab-bar"><div class="tab" onclick="switchMainTab('home')"><div class="tab-ic-wrap"><div class="tab-ic">üè†</div></div><div class="tab-lb">Ana Sayfa</div></div><div class="tab act" onclick="openDMModal()"><div class="tab-ic-wrap"><div class="tab-ic">üí¨</div></div><div class="tab-lb">Mesajlar</div></div><div class="tab" onclick="switchMainTab('forum')"><div class="tab-ic-wrap"><div class="tab-ic">üìã</div></div><div class="tab-lb">Forum</div></div><div class="tab-wrap" onclick="openFriendsModal()"><div class="tab"><div class="tab-ic-wrap"><div class="tab-ic">üë•</div></div><div class="tab-lb">Arkada≈ülar</div></div></div><div class="tab" onclick="switchMainTab('watch')"><div class="tab-ic-wrap"><div class="tab-ic">üì∫</div></div><div class="tab-lb">ƒ∞zle</div></div></div>
</div>

<!-- ‚ïê‚ïê PROFƒ∞L EKRANI ‚ïê‚ïê -->
<div class="screen" id="profileScreen">
  <div class="ws-header" style="background:var(--bg);border-bottom:none;padding-bottom:0;">
    <div class="ws-name" style="font-size:.9rem;color:var(--muted);font-weight:600;letter-spacing:.04em;text-transform:uppercase;">Profil</div>
  </div>
  <!-- Profil Tab Bar -->
  <div style="display:flex;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--bg);padding:0 4px;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;">
    <style>#profileScreen > div:nth-child(2)::-webkit-scrollbar{display:none}</style>
    <div id="ptab-profile" onclick="switchProfTab('profile')" style="flex:1;flex-shrink:0;min-width:60px;padding:10px 4px;text-align:center;font-size:.72rem;font-weight:700;color:#fff;border-bottom:2px solid var(--accent);cursor:pointer;white-space:nowrap;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-2px;margin-right:3px"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>Profil</div>
    <div id="ptab-appearance" onclick="switchProfTab('appearance')" style="flex:1;flex-shrink:0;min-width:60px;padding:10px 4px;text-align:center;font-size:.72rem;font-weight:700;color:var(--muted);border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-2px;margin-right:3px"><circle cx="12" cy="12" r="9"/><path d="M12 3v2M12 19v2M3 12h2M19 12h2"/><circle cx="12" cy="12" r="3"/></svg>G√∂r√ºn√ºm</div>
    <div id="ptab-sounds" onclick="switchProfTab('sounds')" style="flex:1;flex-shrink:0;min-width:60px;padding:10px 4px;text-align:center;font-size:.72rem;font-weight:700;color:var(--muted);border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-2px;margin-right:3px"><path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>Sesler</div>
    <div id="ptab-account" onclick="switchProfTab('account')" style="flex:1;flex-shrink:0;min-width:60px;padding:10px 4px;text-align:center;font-size:.72rem;font-weight:700;color:var(--muted);border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-2px;margin-right:3px"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Hesap</div>
  </div>

  <div style="flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;">

    <!-- TAB: Profil -->
    <div id="profTabBody-profile" style="display:flex;flex-direction:column;">
      <!-- Banner -->
      <div class="prof-banner" id="profBanner"></div>
      <input type="file" id="photoFileInput" accept="image/*" style="display:none" onchange="handlePhotoUpload(event)">
      <!-- Hero -->
      <div class="prof-hero">
        <div class="prof-av-wrap" onclick="triggerPhotoUpload()">
          <div class="prof-av-ring" id="profAvBig"></div>
          <div class="prof-status-dot"></div>
        </div>
        <div class="prof-display-name" id="profName"></div>
        <div class="prof-handle" id="profHandleLabel"></div>
        <!-- ƒ∞statistik Satƒ±rƒ± -->
        <div class="prof-stat-row">
          <div class="prof-stat">
            <span class="prof-stat-num" id="profMsgCount">‚Äî</span>
            <span class="prof-stat-lbl">Mesaj</span>
          </div>
          <div class="prof-stat">
            <span class="prof-stat-num" id="profFriendCount">‚Äî</span>
            <span class="prof-stat-lbl">Arkada≈ü</span>
          </div>
          <div class="prof-stat">
            <span class="prof-stat-num" id="profJoinDate">‚Äî</span>
            <span class="prof-stat-lbl">Katƒ±lƒ±m</span>
          </div>
          <div class="prof-stat">
            <span class="prof-stat-num"><svg width="10" height="10" viewBox="0 0 10 10"><circle cx="5" cy="5" r="4" fill="#4ade80"/></svg></span>
            <span class="prof-stat-lbl">Aktif</span>
          </div>
        </div>
        <!-- Rozet Alanƒ± -->
        <div id="profBadgesRow" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:-4px;margin-bottom:4px;"></div>
        <!-- Bio -->
        <div class="prof-bio-card" style="width:100%;">
          <div class="pbc-label" style="display:flex;align-items:center;gap:4px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-1px"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Hakkƒ±mda</div>
          <textarea id="profBioInp" placeholder="Kendinizi kƒ±saca tanƒ±tƒ±n..." maxlength="160" rows="2" oninput="autoBioResize(this)"></textarea>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
            <span id="bioCharCount" style="font-size:.68rem;color:var(--muted);">0/160</span>
            <button onclick="saveBio()" style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:5px 14px;font-size:.78rem;font-weight:700;cursor:pointer;">Kaydet</button>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: G√∂r√ºn√ºm -->
    <div id="profTabBody-appearance" style="padding:16px;display:none;">
      <!-- UI Stil Se√ßici -->
      <div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;padding:0 2px 10px;display:flex;align-items:center;gap:4px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-1px"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> Aray√ºz Stili</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:18px;" id="uiStyleGrid"></div>

      <!-- SVG ƒ∞kon - Kalƒ±cƒ± Aktif -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:18px;padding:12px;background:var(--surface);border-radius:12px;border:1px solid var(--border);">
        <div>
          <div style="font-size:.82rem;font-weight:700;color:var(--text-hi);display:flex;align-items:center;gap:5px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> SVG ƒ∞konlar</div>
          <div style="font-size:.68rem;color:var(--muted);margin-top:2px;">Vekt√∂r tab ikonlarƒ±</div>
        </div>
        <span style="background:rgba(34,197,94,.12);color:#4ade80;border:1px solid rgba(34,197,94,.2);font-size:.68rem;font-weight:700;border-radius:100px;padding:3px 10px;">‚úì Aktif</span>
      </div>
      <!-- Yazƒ± Boyutu -->
      <div style="margin-top:14px;">
        <div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;padding:0 2px 10px;display:flex;align-items:center;gap:4px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg> Yazƒ± Boyutu</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">
          <div onclick="setFontSize('small')" id="fs-small" style="background:var(--surface);border:2px solid var(--border);border-radius:9px;padding:8px;text-align:center;cursor:pointer;transition:all .15s;">
            <div style="font-size:.7rem;font-weight:900;color:var(--text-hi);">K√º√ß√ºk</div>
            <div style="font-size:.58rem;color:var(--muted);margin-top:2px;">13px</div>
          </div>
          <div onclick="setFontSize('medium')" id="fs-medium" style="background:var(--accent);border:2px solid var(--accent);border-radius:9px;padding:8px;text-align:center;cursor:pointer;transition:all .15s;">
            <div style="font-size:.75rem;font-weight:900;color:#fff;">Orta</div>
            <div style="font-size:.6rem;color:rgba(255,255,255,.7);margin-top:2px;">15px</div>
          </div>
          <div onclick="setFontSize('large')" id="fs-large" style="background:var(--surface);border:2px solid var(--border);border-radius:9px;padding:8px;text-align:center;cursor:pointer;transition:all .15s;">
            <div style="font-size:.82rem;font-weight:900;color:var(--text-hi);">B√ºy√ºk</div>
            <div style="font-size:.62rem;color:var(--muted);margin-top:2px;">17px</div>
          </div>
        </div>
      </div>
      <!-- Kompakt Mod -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px;padding:12px;background:var(--surface);border-radius:12px;border:1px solid var(--border);">
        <div>
          <div style="font-size:.82rem;font-weight:700;color:var(--text-hi);">Kompakt Mesaj Modu</div>
          <div style="font-size:.68rem;color:var(--muted);margin-top:2px;">Mesajlar arasƒ± bo≈üluƒüu azaltƒ±r</div>
        </div>
        <div onclick="toggleCompactMode()" id="compactModeToggle" style="width:42px;height:24px;border-radius:100px;background:var(--surface2);border:1px solid var(--border);position:relative;cursor:pointer;transition:background .2s;">
          <div id="compactModeKnob" style="width:18px;height:18px;border-radius:50%;background:#fff;position:absolute;top:2px;left:2px;transition:transform .2s;box-shadow:0 1px 4px rgba(0,0,0,.3);"></div>
        </div>
      </div>
    </div>

    <!-- TAB: Sesler -->
    <div id="profTabBody-sounds" style="padding:16px;display:none;">
      <div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;padding:0 2px 10px;display:flex;align-items:center;gap:5px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-1px"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.77 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.74a16 16 0 0 0 6 6l1.06-1.06a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg> Arama Zil Sesi</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;" id="ringToneGrid"></div>
      <div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;padding:14px 2px 10px;display:flex;align-items:center;gap:5px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-1px"><path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg> Bildirim Sesi</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;" id="notifToneGrid"></div>
    </div>

    <!-- TAB: Hesap -->
    <div id="profTabBody-account" style="padding:16px;display:none;">
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div class="prof-act admin-action" id="adminPanelBtn" style="display:none" onclick="switchMainTab('home');openAdminPanel()">
          <div class="prof-act-ic"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M2 19h20v2H2v-2z" fill="#f0c040"/>
  <path d="M2 19l3-9 4.5 4.5L12 5l2.5 9.5L19 10l3 9H2z" fill="#f0c040" stroke="#d4a017" stroke-width="1" stroke-linejoin="round"/>
  <circle cx="2" cy="10" r="1.5" fill="#f0c040" stroke="#d4a017" stroke-width="0.5"/>
  <circle cx="12" cy="5" r="1.5" fill="#f0c040" stroke="#d4a017" stroke-width="0.5"/>
  <circle cx="22" cy="10" r="1.5" fill="#f0c040" stroke="#d4a017" stroke-width="0.5"/>
</svg></div>
          <div class="prof-act-lb">Admin Paneli</div>
        </div>
        <div class="prof-act" onclick="openChangePassword()">
          <div class="prof-act-ic"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="7.5" cy="15.5" r="4.5"/><path d="M21 2l-9.6 9.6"/><path d="M15.5 7.5l3 3L22 7l-3-3"/></svg></div>
          <div class="prof-act-lb">≈ûifre Deƒüi≈ütir</div>
        </div>
        <div class="prof-act danger" onclick="doLogout()">
          <div class="prof-act-ic"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></div>
          <div class="prof-act-lb">√áƒ±kƒ±≈ü Yap</div>
        </div>
      </div>
    </div>

  </div>

  <!-- ≈ûifre Deƒüi≈ütir Modal (mobil i√ßin profil i√ßinde kalƒ±r ama JS ile body'e ta≈üƒ±nƒ±r) -->
  <div id="changePwModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:99999;align-items:center;justify-content:center;padding:24px;">
    <div style="background:var(--bg2);border-radius:16px;padding:22px;width:100%;max-width:340px;box-shadow:0 20px 60px rgba(0,0,0,.5);">
      <div style="font-size:1rem;font-weight:900;color:var(--text-hi);margin-bottom:16px;">üîë ≈ûifre Deƒüi≈ütir</div>
      <div class="login-err" id="pwChangeErr" style="margin-bottom:10px;"></div>
      <input class="login-inp" id="pwOld" type="password" placeholder="Mevcut ≈üifre..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="margin-bottom:10px;">
      <input class="login-inp" id="pwNew" type="password" placeholder="Yeni ≈üifre (min 6)..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="margin-bottom:10px;">
      <input class="login-inp" id="pwNew2" type="password" placeholder="Yeni ≈üifre tekrar..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" style="margin-bottom:16px;">
      <div style="display:flex;gap:8px;">
        <button onclick="closeChangePassword()" style="flex:1;padding:11px;background:var(--surface);border:none;border-radius:9px;color:var(--muted);font-size:.85rem;font-weight:700;cursor:pointer;">ƒ∞ptal</button>
        <button onclick="submitChangePassword()" style="flex:1;padding:11px;background:#5b9bd5;border:none;border-radius:9px;color:#fff;font-size:.85rem;font-weight:700;cursor:pointer;">Kaydet</button>
      </div>
    </div>
  </div>
  <div class="tab-bar"><div class="tab" onclick="switchMainTab('home')"><div class="tab-ic-wrap"><div class="tab-ic">üè†</div></div><div class="tab-lb">Ana Sayfa</div></div><div class="tab" onclick="openDMModal()"><div class="tab-ic-wrap"><div class="tab-ic">üí¨</div></div><div class="tab-lb">Mesajlar</div></div><div class="tab" onclick="switchMainTab('forum')"><div class="tab-ic-wrap"><div class="tab-ic">üìã</div></div><div class="tab-lb">Forum</div></div><div class="tab-wrap" onclick="openFriendsModal()"><div class="tab"><div class="tab-ic-wrap"><div class="tab-ic">üë•</div></div><div class="tab-lb">Arkada≈ülar</div></div></div><div class="tab" onclick="switchMainTab('watch')"><div class="tab-ic-wrap"><div class="tab-ic">üì∫</div></div><div class="tab-lb">ƒ∞zle</div></div></div>
</div>

<!-- ‚ïê‚ïê IMAGE OVERLAY ‚ïê‚ïê -->
<div id="imgOverlay">
  <div style="position:absolute;top:16px;right:16px;display:flex;gap:8px;z-index:10;">
    <div onclick="downloadOverlayImg()" title="ƒ∞ndir" style="width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:background .15s;" onmouseover="this.style.background='rgba(255,255,255,.28)'" onmouseout="this.style.background='rgba(255,255,255,.15)'">‚¨áÔ∏è</div>
    <div onclick="closeImg()" title="Kapat" style="width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1rem;transition:background .15s;" onmouseover="this.style.background='rgba(255,255,255,.28)'" onmouseout="this.style.background='rgba(255,255,255,.15)'">‚úï</div>
  </div>
  <img id="imgOverlayImg" src="" alt="">
</div>


<!-- ‚ïê‚ïê ARAMA EKRANI ‚ïê‚ïê -->
<div id="callScreen" style="display:none;position:fixed;inset:0;background:rgba(8,9,18,.82);backdrop-filter:blur(32px);-webkit-backdrop-filter:blur(32px);z-index:5000;flex-direction:column;align-items:center;justify-content:center;">
  <!-- Minimize button (top-right) -->
  <div id="callMinimizeBtn" onclick="minimizeCallScreen()" title="K√º√ß√ºlt" style="position:absolute;top:calc(16px + env(safe-area-inset-top,0px));right:16px;z-index:20;width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .15s;">
    <svg width="14" height="3" viewBox="0 0 14 3" fill="none"><rect width="14" height="2.5" rx="1.25" fill="rgba(255,255,255,.8)"/></svg>
  </div>
  <!-- Video alanƒ± -->
  <div id="callVideoArea" style="display:none;position:relative;width:100%;height:100%;background:#000;">
    <video id="remoteVideo" autoplay playsinline style="width:100%;height:100%;object-fit:contain;background:#000;"></video>
    <video id="localVideo" autoplay playsinline muted style="position:absolute;bottom:100px;right:16px;width:120px;height:90px;object-fit:cover;border-radius:10px;border:2px solid rgba(255,255,255,.25);background:#222;cursor:move;z-index:10;"></video>
    <!-- Screen share badge -->
    <div id="callScreenBadge" style="display:none;position:absolute;top:14px;left:50%;transform:translateX(-50%);background:rgba(46,204,113,.25);border:1px solid rgba(46,204,113,.5);border-radius:100px;padding:5px 14px;font-size:.8rem;font-weight:700;color:#2ecc71;white-space:nowrap;pointer-events:none;">üñ•Ô∏è Ekran Payla≈üƒ±lƒ±yor</div>
  </div>
  <!-- Sesli arama bilgi alanƒ± -->
  <div id="callAudioArea" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;">
    <div id="callAvatar" style="width:90px;height:90px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:900;color:#fff;margin-bottom:20px;border:3px solid rgba(255,255,255,.2);">?</div>
    <div id="callName" style="font-size:1.3rem;font-weight:900;color:#fff;margin-bottom:6px;">‚Äî</div>
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
      <div id="callStatus" style="font-size:.88rem;color:rgba(255,255,255,.6);">Baƒülanƒ±yor...</div>
      <div id="callQualityIndicator" style="display:none;align-items:center;gap:3px;" title="Ses Kalitesi">
        <div style="width:3px;border-radius:1px;background:rgba(255,255,255,.3);" id="cqi1"></div>
        <div style="width:3px;border-radius:1px;background:rgba(255,255,255,.3);" id="cqi2"></div>
        <div style="width:3px;border-radius:1px;background:rgba(255,255,255,.3);" id="cqi3"></div>
        <div style="width:3px;border-radius:1px;background:rgba(255,255,255,.3);" id="cqi4"></div>
      </div>
    </div>
    <div id="callTimerDisplay" style="display:none;font-size:.82rem;color:rgba(255,255,255,.45);font-variant-numeric:tabular-nums;letter-spacing:.05em;">0:00</div>
    <!-- Katƒ±lƒ±mcƒ± avatarlarƒ± -->
    <div id="callParticipants" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:16px;max-width:280px;"></div>
    <!-- Audio g√∂rselle≈ütirme -->
    <div id="callWaves" style="display:flex;gap:4px;align-items:center;margin-top:20px;height:30px;">
      <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
      <div class="wave-bar"></div><div class="wave-bar"></div>
    </div>
  </div>
  <!-- Kontroller -->
  <div style="display:flex;gap:16px;padding:28px;background:rgba(0,0,0,.5);width:100%;justify-content:center;align-items:center;flex-shrink:0;flex-wrap:wrap;">
    <div id="callMuteBtn" onclick="toggleMute()" style="width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:1.4rem;cursor:pointer;" title="Mikrofon">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="9" y="2" width="6" height="11" rx="3" fill="rgba(255,255,255,.9)"/><path d="M5 11a7 7 0 0 0 14 0" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="18" x2="12" y2="22" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/><line x1="9" y1="22" x2="15" y2="22" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/></svg>
    </div>
    <div id="callShareScreenBtn" onclick="toggleScreenShare()" style="width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:1.4rem;cursor:pointer;" title="Ekran Payla≈ü">üñ•Ô∏è</div>
    <div id="callAddPersonBtn" onclick="openCallInviteDialog()" style="width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:1.4rem;cursor:pointer;" title="Ki≈üi Ekle">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="10" cy="8" r="4" stroke="rgba(255,255,255,.9)" stroke-width="2"/><path d="M2 20c0-4 3.6-7 8-7" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/><line x1="19" y1="13" x2="19" y2="21" stroke="rgba(255,255,255,.9)" stroke-width="2.5" stroke-linecap="round"/><line x1="15" y1="17" x2="23" y2="17" stroke="rgba(255,255,255,.9)" stroke-width="2.5" stroke-linecap="round"/></svg>
    </div>
    <div onclick="endCall()" title="Aramayƒ± Bitir" style="width:68px;height:68px;border-radius:50%;background:linear-gradient(145deg,#e05555,#c0392b);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 28px rgba(224,85,85,.5);transition:transform .12s;" onmousedown="this.style.transform='scale(.92)'" onmouseup="this.style.transform=''">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="white"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1-9.4 0-17-7.6-17-17 0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z"/></svg>
    </div>
    <div id="callCamBtn" onclick="toggleCamera()" style="width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:1.4rem;cursor:pointer;" title="Kamera">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="rgba(255,255,255,.9)"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>
    </div>
    <div id="callSpeakerBtn" onclick="toggleSpeaker()" style="width:56px;height:56px;border-radius:50%;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;font-size:1.4rem;cursor:pointer;" title="Hoparl√∂r">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M11 5L6 9H2v6h4l5 4V5z" fill="rgba(255,255,255,.9)"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/></svg>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê GELEN ARAMA - Kompakt Banner ‚ïê‚ïê -->
<div id="incomingCallScreen" style="display:none;position:fixed;top:calc(env(safe-area-inset-top,0px) + 10px);left:50%;transform:translateX(-50%);z-index:6000;width:calc(100% - 24px);max-width:420px;background:rgba(30,34,42,.97);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:14px 16px;box-shadow:0 8px 32px rgba(0,0,0,.6);flex-direction:row;align-items:center;gap:12px;cursor:grab;touch-action:none;user-select:none;-webkit-user-select:none;">
  <!-- Avatar -->
  <div id="incomingCallAv" style="width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:900;color:#fff;flex-shrink:0;"></div>
  <!-- Info -->
  <div style="flex:1;min-width:0;">
    <div id="incomingCallName" style="font-size:.95rem;font-weight:900;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;"></div>
    <div id="incomingCallType" style="font-size:.75rem;color:rgba(255,255,255,.55);margin-top:1px;"></div>
  </div>
  <!-- Buttons -->
  <div style="display:flex;gap:10px;flex-shrink:0;">
    <div onclick="rejectCall()" data-nodrag title="Reddet" style="width:44px;height:44px;border-radius:50%;background:#e05555;display:flex;align-items:center;justify-content:center;font-size:1.3rem;cursor:pointer;box-shadow:0 2px 8px rgba(224,85,85,.4);">üìµ</div>
    <div onclick="acceptCall()" data-nodrag title="Cevapla" style="width:44px;height:44px;border-radius:50%;background:#2ecc71;display:flex;align-items:center;justify-content:center;font-size:1.3rem;cursor:pointer;box-shadow:0 2px 8px rgba(46,204,113,.4);">üìû</div>
  </div>
</div>

<!-- ‚ïê‚ïê Mƒ∞Nƒ∞Mƒ∞ZE EDƒ∞LMƒ∞≈û ARAMA √áUBUƒûU ‚ïê‚ïê -->
<div id="callMinimizedBar" style="display:none;position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:5100;background:rgba(20,22,30,.96);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(46,204,113,.35);border-radius:100px;padding:8px 16px;box-shadow:0 4px 24px rgba(0,0,0,.6);flex-direction:row;align-items:center;gap:10px;cursor:grab;white-space:nowrap;touch-action:none;user-select:none;-webkit-user-select:none;">
  <div style="width:9px;height:9px;border-radius:50%;background:#2ecc71;animation:pulse 1.5s infinite;flex-shrink:0;"></div>
  <div id="callMinBar_name" style="font-size:.85rem;font-weight:700;color:#fff;"></div>
  <div id="callMinBar_status" style="font-size:.75rem;color:rgba(255,255,255,.5);min-width:36px;"></div>
  <div onclick="event.stopPropagation();maximizeCallScreen()" title="B√ºy√ºt" style="width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;">
    <svg width="11" height="11" viewBox="0 0 24 24" fill="none"><path d="M3 9V3h6M21 9V3h-6M3 15v6h6M21 15v6h-6" stroke="rgba(255,255,255,.8)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </div>
  <div onclick="event.stopPropagation();endCall()" title="Aramayƒ± Bitir" style="width:28px;height:28px;border-radius:50%;background:#e05555;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="white"><path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1-9.4 0-17-7.6-17-17 0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z"/></svg>
  </div>
</div>

<div id="turkQuoteOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:9999;align-items:center;justify-content:center;padding:24px;">
  <div id="turkQuoteBox" style="width:100%;max-width:400px;background:linear-gradient(135deg,#1c1f23,#2c3038);border-radius:20px;padding:28px 24px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.6);border:2px solid rgba(255,255,255,.15);position:relative;">
    
    <div style="font-size:.65rem;font-weight:900;color:rgba(255,255,255,.5);letter-spacing:.15em;text-transform:uppercase;margin-bottom:16px" id="turkQuoteEra"></div>
    <div style="font-size:.75rem;font-weight:900;color:rgba(255,255,255,.6);margin-bottom:12px;letter-spacing:.05em" id="turkQuoteRuler"></div>
    <div style="font-size:1.5rem;color:rgba(255,255,255,.25);line-height:1;margin-bottom:8px">"</div>
    <div style="font-size:.95rem;color:#fff;line-height:1.7;font-style:italic;font-weight:600;margin-bottom:8px" id="turkQuoteText"></div>
    <div style="font-size:1.5rem;color:rgba(255,255,255,.25);line-height:1;margin-bottom:20px">"</div>
    <div style="width:40px;height:2px;background:rgba(255,255,255,.3);margin:0 auto 20px;"></div>
    <button onclick="closeTurkQuote()" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);color:#fff;padding:10px 28px;border-radius:100px;font-size:.85rem;font-weight:700;cursor:pointer;">‚ò™Ô∏è Kapat</button>
  </div>
</div>

<div id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
<script>
'use strict';

/* ‚îÄ‚îÄ Firebase Configs (√áoklu Sunucu) ‚îÄ‚îÄ */
const FB_SERVERS = {
  sohbet: {
    label: 'Biyom',
    icon: 'üåê',
    color: '#5b9bd5',
    description: 'Genel sohbet odalarƒ±',
    config: {
      apiKey:"AIzaSyCluGUx9dqi4R_Udd4teG4A7T5aL-xgO8U",
      authDomain:"sohbet-cfe7f.firebaseapp.com",
      databaseURL:"https://sohbet-cfe7f-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"sohbet-cfe7f",
      storageBucket:"sohbet-cfe7f.firebasestorage.app",
      messagingSenderId:"672228058338",
      appId:"1:672228058338:web:9bd002534b9bf2e51caabb"
    }
  },
  chat: {
    label: 'Ekosistem Chat',
    icon: 'üåø',
    color: '#2ecc71',
    description: 'Ekosistem Chat Sunucusu',
    config: {
      apiKey:"AIzaSyBMA7zmhpq66DBjacenKzZIub_-YCZWegk",
      authDomain:"lisa-518f0.firebaseapp.com",
      databaseURL:"https://lisa-518f0-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"lisa-518f0",
      storageBucket:"lisa-518f0.firebasestorage.app",
      messagingSenderId:"873280730927",
      appId:"1:873280730927:web:68548536ebbcc91da593da",
      measurementId:"G-Z3BPNY1EPW"
    }
  }
};

/* Aktif sunucu ‚Äî sunucu se√ßim ekranƒ±nda belirlenir */
let _activeServer = null;
let FB_CONFIG = null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ADMƒ∞N KULLANICI ADI
   ≈ûifre/hash kaynak kodda SAKLANMIYOR.
   Doƒürulama: Firebase Realtime DB REST ‚Äî users/{admin}.passwordHash
   Admin yetkisi: users/{admin}.isAdmin === true  VEYA  admins/{admin} kaydƒ±
   Cloud Function (setAdminClaim) baƒüƒ±mlƒ±lƒ±ƒüƒ± KALDIRILDI.
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ADMIN_USERNAME = 'admin';

let _db=null,_auth=null,_functions=null,_cu=null,_isAdmin=false,_cRoom=null;

/* ‚îÄ‚îÄ Oyun g√∂rselleri ‚Äî tek kaynak of truth ‚îÄ‚îÄ */
let _customGameImages = {};
function _cgiCacheKey(){ return 'sohbet_gameImages_' + (_activeServer||''); }
function _loadCgiCache(){
  try{
    const raw = localStorage.getItem(_cgiCacheKey());
    if(raw) _customGameImages = JSON.parse(raw);
  }catch(e){ _customGameImages = {}; }
}
function _saveCgiCache(){
  try{ localStorage.setItem(_cgiCacheKey(), JSON.stringify(_customGameImages)); }catch(e){}
}
async function loadCustomGameImages(){
  _loadCgiCache();
  try{
    const data = await fbRestGet('settings/gameImages');
    if(data && typeof data==='object'){ _customGameImages=data; _saveCgiCache(); }
  }catch(e){
    try{ const s=await dbRef('settings/gameImages').once('value'); const d=s.val(); if(d&&typeof d==='object'){_customGameImages=d;_saveCgiCache();} }catch(e2){}
  }
  try{ dbRef('settings/gameImages').on('value',s=>{ const d=s.val(); if(d&&typeof d==='object'){_customGameImages=d;_saveCgiCache();} }); }catch(e){}
}

/* ‚îÄ‚îÄ Admin tarafƒ±ndan eklenen oyunlar ‚îÄ‚îÄ */
let _customGames = [];
function _cgCacheKey(){ return 'sohbet_customGames_' + (_activeServer||''); }
function _loadCgCache(){
  try{
    const raw = localStorage.getItem(_cgCacheKey());
    if(raw) _customGames = JSON.parse(raw);
  }catch(e){ _customGames = []; }
}
function _saveCgCache(){
  try{ localStorage.setItem(_cgCacheKey(), JSON.stringify(_customGames)); }catch(e){}
}
async function loadCustomGames(){
  _loadCgCache();
  try{
    const data = await fbRestGet('settings/customGames');
    if(data && typeof data === 'object'){
      _customGames = Object.entries(data).map(([id,g])=>({...g, id, _custom:true}));
      _saveCgCache();
    } else {
      _customGames = [];
    }
  }catch(e){}
}
function allGames(){
  return [...GAME_CATALOG, ..._customGames];
}

const _mainScreenIds={home:'roomsScreen',msgs:'msgsScreen',forum:'forumScreen',friends:'friendsScreen',profile:'profileScreen',games:'gamesScreen',watch:'watchScreen'};
let _activeMainTab='home';

function switchMainTab(tab){
  _activeMainTab=tab;
  if(typeof _updateURL === 'function') _updateURL(tab);
  // Hide all screens except login/chat/admin
  ['roomsScreen','forumScreen','msgsScreen','friendsScreen','profileScreen','chatScreen','adminPanel','gamesScreen','watchScreen'].forEach(id=>{
    var el=document.getElementById(id);
    if(el) el.classList.remove('active');
  });
  // Show target screen
  var targetId=_mainScreenIds[tab]||'roomsScreen';
  var el=document.getElementById(targetId);
  if(el) el.classList.add('active');
  // Tab specific actions
  if(tab==='forum'){
    var fav=document.getElementById('forumMyAv');
    if(fav&&_cu) setAvatar(fav,_cu);
    var fAv2=document.getElementById('forumAvatar');
    if(fAv2&&_cu) setAvatar(fAv2,_cu);
    loadForum();
  }
  if(tab!=='forum'&&_forumStop){_forumStop();_forumStop=null;}
  // NatureBot ev g√∂sterimi
  const _nbHomeZone = document.getElementById('natureBotHomeZone');
  if (_nbHomeZone) _nbHomeZone.style.display = (tab === 'watch') ? 'flex' : 'none';
  // Robot: ƒ∞zle sekmesine ge√ßince mobilde eve git, diƒüerlerinde ba≈ülƒ±ƒüa d√∂n
  if (window._natureBotInstance) {
    if (window.innerWidth < 768) {
      const bot = window._natureBotInstance;
      if (tab === 'watch') {
        // Robot watchScreenBody i√ßine ta≈üƒ± - ev g√∂r√ºn√ºm√º
        const watchBody = document.getElementById('watchScreenBody');
        if (watchBody && !watchBody.contains(bot.el)) {
          watchBody.appendChild(bot.el);
          bot.el.style.position = 'absolute';
          bot.el.style.left = '50%';
          bot.el.style.top = '35%';
          bot.el.style.transform = 'translateX(-50%)';
          bot.el.style.width = '64px';
          bot.el.style.height = '80px';
          bot.el.style.zIndex = '10';
          bot.isAtHome = true;
          bot.el.classList.add('at-home');
        }
      } else {
        // Diƒüer sekmelerde header slotuna geri ta≈üƒ±
        const slot = document.getElementById('mobileRobotSlot');
        if (slot && !slot.contains(bot.el)) {
          slot.appendChild(bot.el);
          bot.el.style.position = 'relative';
          bot.el.style.left = 'auto';
          bot.el.style.top = 'auto';
          bot.el.style.transform = 'none';
          bot.el.style.width = '44px';
          bot.el.style.height = '54px';
          bot.isAtHome = false;
          bot.el.classList.remove('at-home');
        }
      }
    }
    window._natureBotInstance.recordInteraction();
  }
  if(tab==='msgs'){
    var ds=document.getElementById('dmSearch');
    var dl=document.getElementById('dmUserList');
    if(ds) ds.value='';
    if(dl) dl.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
    if(_db&&_cu) dbRef('users').once('value').then(function(snap){
      var users=snap.val()||{};
      _allUsers=Object.keys(users).filter(function(u){if(u===_cu||users[u].banned) return false; return true;});
      if(!_allUsers.length){if(dl)dl.innerHTML='<p style="color:var(--muted);padding:16px;font-size:.85rem;text-align:center">Hen√ºz kullanƒ±cƒ± yok.</p>';return;}
      renderDMUsers(_allUsers);
    });
  }
  if(tab==='friends') switchFrTab(1);
  if(tab==='games'){ applyCustomGameImages(); loadGamesPanel(); }
  if(tab==='watch') loadWatchPanel();
  if(tab==='profile'){
    var av=document.getElementById('profAvBig');
    var pn=document.getElementById('profName');
    if(av&&_cu) setAvatar(av,_cu);
    if(pn&&_cu) pn.textContent=_cu;
    setTimeout(()=>{ switchProfTab('profile'); }, 50);
  }
  setTimeout(()=>applyTabIcons(true), 0);
}

let _stopMsg=null,_stopOnl=null,_hbTimer=null,_stopReads=null;
let _passwordHash='';
let _online={},_unread={},_lastMsg={},_reads={};
let _adminTab='users';

/* ‚îÄ‚îÄ Hash ‚îÄ‚îÄ */
// ‚îÄ‚îÄ SHA-256 tabanlƒ± g√ºvenli hash (WebCrypto API) ‚îÄ‚îÄ
async function hashStr(s){
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(s));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
// Senkron fallback (eski hash - legacy uyumluluk i√ßin tutuldu)
function hashStrSync(s){
  let h=5381;
  for(let i=0;i<s.length;i++) h=((h<<5)+h+s.charCodeAt(i))>>>0;
  return h.toString(16);
}

/* ‚îÄ‚îÄ Firebase Init ‚îÄ‚îÄ */
async function fbInit(){
  try{
    // √ñnceki app varsa √∂nce sil, bekle
    if(firebase.apps.length){
      await Promise.all(firebase.apps.map(app=>app.delete().catch(()=>{})));
    }
    const a = firebase.initializeApp(FB_CONFIG);
    _db = firebase.database(a);
    _auth = firebase.auth(a);
    _functions = firebase.functions(a);
    // Her ziyaret√ßiyi anonim olarak Firebase Auth'a giri≈ü yaptƒ±r
    // Bu sayede auth!=null kurallarƒ± √ßalƒ±≈üƒ±r ve raw REST saldƒ±rƒ±larƒ± engellenir
    // NOT: Bazƒ± projelerde Anonymous Auth kapalƒ± olabilir; bu hata kritik deƒüil, devam edilir.
    try{
      await _auth.signInAnonymously();
    }catch(e){
      if(e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed'){
        console.warn('‚ö†Ô∏è Bu Firebase projesinde Anonymous Authentication aktif deƒüil.',
          'Firebase Console ‚Üí Authentication ‚Üí Sign-in method ‚Üí Anonymous ‚Üí Enable yapƒ±n.');
        // Auth olmadan devam et; DB baƒülantƒ±sƒ± var, REST token'sƒ±z √ßalƒ±≈üacak
      } else {
        console.warn('Anonim giri≈ü ba≈üarƒ±sƒ±z:', e);
      }
    }
    // Persistence: offline cache ile anlƒ±k y√ºkleme
    try{ _db.ref('.info/connected').on('value',()=>{}); }catch(e){}
    // Sƒ±k kullanƒ±lan yollarƒ± √∂n belleƒüe al
    try{
      _db.ref('rooms').keepSynced(true);
      _db.ref('online').keepSynced(true);
    }catch(e){}
    return true;
  }catch(e){ console.error('fbInit hatasƒ±:', e); return false; }
}
/* ‚îÄ‚îÄ Workspace (kaldƒ±rƒ±ldƒ±) ‚îÄ‚îÄ */
let _WS = null; // artƒ±k kullanƒ±lmƒ±yor
function dbRef(p){ return _db.ref(p); }
function wsPath(p){ return p; }

/* ‚îÄ‚îÄ Sunucu Se√ßim Fonksiyonlarƒ± ‚îÄ‚îÄ */
function renderServerSelect(){
  const list = document.getElementById('serverList');
  if(!list) return;
  list.innerHTML = Object.entries(FB_SERVERS).map(([key, srv]) => `
    <div onclick="selectServer('${key}')" style="
      display:flex;align-items:center;gap:14px;
      background:var(--surface);border:1px solid var(--border);
      border-radius:14px;padding:18px 20px;cursor:pointer;
      transition:border-color .2s, background .2s, transform .15s;
    "
    onmouseover="this.style.borderColor='${srv.color}';this.style.background='var(--surface2)';this.style.transform='translateY(-1px)'"
    onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--surface)';this.style.transform='translateY(0)'">
      <div style="width:48px;height:48px;border-radius:12px;background:${srv.color}22;border:1px solid ${srv.color}44;display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0;">${srv.icon}</div>
      <div style="flex:1;min-width:0;">
        <div style="font-size:1rem;font-weight:900;color:var(--text-hi);margin-bottom:2px;">${srv.label}</div>
        <div style="font-size:.76rem;color:var(--muted);">${srv.description}</div>
      </div>
      <div style="color:${srv.color};font-size:1.2rem;">‚Ä∫</div>
    </div>
  `).join('');
}

function selectServer(key){
  if(!FB_SERVERS[key]) return;
  _activeServer = key;
  FB_CONFIG = FB_SERVERS[key].config;
  _FB_REST = FB_SERVERS[key].config.databaseURL; // ‚Üê REST API URL'sini g√ºncelle

  // Sunucu adƒ±nƒ± ve simgesini login ekranƒ±nda g√∂ster
  const logoEl = document.querySelector('#loginScreen .login-logo');
  const titleEl = document.querySelector('#loginScreen .login-title');
  if(logoEl) logoEl.innerHTML = '<svg viewBox="0 0 120 120" width="56" height="56" xmlns="http://www.w3.org/2000/svg"><defs><clipPath id="lcll"><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z"/></clipPath></defs><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="#0e2b0c"/><g clip-path="url(#lcll)"><line x1="60" y1="14" x2="60" y2="108" stroke="#4a8f40" stroke-width="1.2"/><line x1="60" y1="35" x2="78" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="35" x2="42" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="52" x2="82" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="52" x2="38" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="68" x2="78" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="68" x2="42" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="82" x2="70" y2="94" stroke="#4a8f40" stroke-width=".4"/><line x1="60" y1="82" x2="50" y2="94" stroke="#4a8f40" stroke-width=".4"/></g><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="none" stroke="#4a8f40" stroke-width="1.2"/></svg>';
  if(titleEl) titleEl.textContent = FB_SERVERS[key].label;

  // Sidebar ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
  const sideTitle = document.getElementById('deskSidebarTitle');
  if(sideTitle) sideTitle.textContent = FB_SERVERS[key].label;

  // Kayƒ±tlƒ± oturum var mƒ± kontrol et
  waitForFirebase(async ()=>{
    try{
      if(!await fbInit()){
        showScreen('loginScreen');
        showToast('Firebase baƒülanamadƒ±');
        return;
      }
      // Sunucu se√ßim ekranƒ±ndan gelince her zaman giri≈ü ekranƒ± g√∂ster
      showScreen('loginScreen');
      startTurkQuoteTimer();
    }catch(e){
      console.error('Server init error:',e);
      showScreen('loginScreen');
    }
  });
}

/* Logout sonrasƒ± sunucu se√ßimine d√∂n */
async function backToServerSelect(){
  _activeServer = null;
  FB_CONFIG = null;
  _FB_REST = '';
  _db = null;
  _cu = null;
  _isAdmin = false;

  // Firebase apps temizle - bekle
  try{ if(_auth){ await _auth.signOut().catch(()=>{}); _auth=null; } }catch(e){}
  try{ await Promise.all(firebase.apps.map(app=>app.delete().catch(()=>{}))); }catch(e){}
  _functions=null;
  document.querySelectorAll('.screen').forEach(s=>{s.classList.remove('active');s.style.display='';});
  document.getElementById('serverSelectScreen').classList.add('active');
  renderServerSelect();
}
/* ‚îÄ‚îÄ Sunucu Deƒüi≈ütirme Modal ‚îÄ‚îÄ */

function goBackToServerSelect(){
  document.querySelectorAll('.screen').forEach(s=>{s.classList.remove('active');s.style.display='';});
  document.getElementById('serverSelectScreen').classList.add('active');
  if(typeof renderServerSelect==='function') renderServerSelect();
}
function showServerSwitchModal(){
  const others = Object.entries(FB_SERVERS).filter(([k])=>k!==_activeServer);
  if(!others.length) return;
  const old = document.getElementById('_serverSwitchModal');
  if(old) old.remove();
  const modal = document.createElement('div');
  modal.id = '_serverSwitchModal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:9999999;display:flex;align-items:center;justify-content:center;padding:20px;';
  const box = document.createElement('div');
  box.style.cssText = 'background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:24px;width:100%;max-width:360px;box-shadow:0 16px 48px rgba(0,0,0,.6);';
  box.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
      <div style="font-size:1rem;font-weight:900;color:var(--text-hi);">Sunucu Deƒüi≈ütir</div>
      <div onclick="document.getElementById('_serverSwitchModal').remove()" style="cursor:pointer;color:var(--muted);font-size:1.2rem;padding:2px 6px;">‚úï</div>
    </div>
    <div style="font-size:.78rem;color:var(--muted);margin-bottom:14px;">≈ûu an: <b style="color:var(--text-hi)">${FB_SERVERS[_activeServer]?.label||_activeServer}</b></div>
    ${others.map(([k,s])=>`
      <div onclick="_switchToServer('${k}')" style="display:flex;align-items:center;gap:12px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 16px;cursor:pointer;margin-bottom:10px;transition:border-color .2s;"
        onmouseover="this.style.borderColor='${s.color}'" onmouseout="this.style.borderColor='var(--border)'">
        <div style="width:40px;height:40px;border-radius:10px;background:${s.color}22;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;">${s.icon}</div>
        <div>
          <div style="font-weight:700;color:var(--text-hi);font-size:.9rem;">${s.label}</div>
          <div style="font-size:.72rem;color:var(--muted);">${s.description}</div>
        </div>
        <div style="margin-left:auto;color:${s.color};font-size:1.1rem;">‚Ä∫</div>
      </div>
    `).join('')}
  `;
  modal.appendChild(box);
  modal.addEventListener('click',e=>{ if(e.target===modal) modal.remove(); });
  document.body.appendChild(modal);
}

async function _switchToServer(key){
  const modal = document.getElementById('_serverSwitchModal');
  if(modal) modal.remove();
  if(_stopMsg){_stopMsg();_stopMsg=null;}
  if(_stopOnl){_stopOnl();_stopOnl=null;}
  if(_stopFrReqs){_stopFrReqs();_stopFrReqs=null;}
  clearInterval(_hbTimer);
  if(_db&&_cu) dbRef('online/'+_cu).remove().catch(()=>{});
  _cu=null;_cRoom=null;_online={};_unread={};_isAdmin=false;
  if(_auth){ _auth.signOut().catch(()=>{}); _auth=null; }
  _functions=null;
  Object.values(_lastMsgListeners).forEach(s=>{try{s();}catch(e){}});
  Object.keys(_lastMsgListeners).forEach(k=>delete _lastMsgListeners[k]);
  await selectServer(key);
}

function onUsernameInput(){ hideLoginErr(); }
function showLoginErr(msg){const el=document.getElementById('loginErr');el.textContent=msg;el.classList.add('show');}
function hideLoginErr(){document.getElementById('loginErr').classList.remove('show');}

function loginNext(){
  const user=document.getElementById('loginUser').value.trim();
  if(!user){showLoginErr('Kullanƒ±cƒ± adƒ± girin.');return;}
  hideLoginErr();
  // Avatar rengi
  const av=document.getElementById('loginUserAvatar');
  av.textContent=initials(user);
  av.style.background=strColor(user);
  document.getElementById('loginUserLabel').textContent=user;
  document.getElementById('loginStep1').style.display='none';
  document.getElementById('loginStep2').style.display='block';
  // ≈ûifre alanƒ±na odaklan
  setTimeout(function(){
    const p=document.getElementById('loginPass');
    if(p) p.focus();
  },100);
}
function loginBack(){
  hideLoginErr();
  document.getElementById('loginStep2').style.display='none';
  document.getElementById('loginStep1').style.display='block';
  const p=document.getElementById('loginPass');
  if(p) p.value='';
}
function showLoginTab(tab){
  // Giri≈ü formunu step1'e sƒ±fƒ±rla
  const s1=document.getElementById('loginStep1');
  const s2=document.getElementById('loginStep2');
  if(s1) s1.style.display='block';
  if(s2) s2.style.display='none';
  const p=document.getElementById('loginPass');
  if(p) p.value='';
  const isGiris = tab==='giris';
  document.getElementById('girisForm').style.display = isGiris?'block':'none';
  document.getElementById('tabGiris').style.background = isGiris?'var(--surface2)':'transparent';
  document.getElementById('tabGiris').style.color = isGiris?'var(--text-hi)':'var(--muted)';
  document.getElementById('tabKayit').style.background = isGiris?'transparent':'var(--surface2)';
  document.getElementById('tabKayit').style.color = isGiris?'var(--muted)':'var(--text-hi)';
  hideLoginErr();
  if(!isGiris){
    // Kayƒ±t a√ßƒ±k mƒ± kontrol et
    document.getElementById('kayitForm').style.display='none';
    const closedMsg = document.getElementById('regClosedMsg');
    if(closedMsg) closedMsg.style.display='none';
    fbRestGet('settings/registration').then(val=>{
      const isOpen = !val || val === 'open';
      if(isOpen){
        document.getElementById('kayitForm').style.display='block';
      } else {
        if(closedMsg){
          // Diƒüer sunucularƒ± g√∂ster
          const others = Object.entries(FB_SERVERS).filter(([k])=>k!==_activeServer);
          const othersEl = document.getElementById('regClosedOtherServers');
          if(othersEl && others.length){
            othersEl.innerHTML = '<div style="font-size:12px;color:var(--muted);margin-bottom:8px;">Diƒüer sunuculara g√∂z atabilirsin:</div>' +
              others.map(([k,srv])=>`
                <button onclick="goBackToServerSelect()" 
                  style="display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:var(--surface);cursor:pointer;width:100%;text-align:left;">
                  <span style="font-size:24px">${srv.icon}</span>
                  <div>
                    <div style="font-weight:700;color:var(--text-hi);font-size:13px">${srv.label}</div>
                    <div style="font-size:11px;color:var(--muted)">${srv.description||''}</div>
                  </div>
                </button>
              `).join('');
          } else if(othersEl){
            othersEl.innerHTML='';
          }
          closedMsg.style.display='block';
        }
      }
    }).catch(()=>{
      // Hata durumunda formu g√∂ster
      document.getElementById('kayitForm').style.display='block';
    });
  } else {
    document.getElementById('kayitForm').style.display='none';
    const closedMsg = document.getElementById('regClosedMsg');
    if(closedMsg) closedMsg.style.display='none';
  }
}

/* ‚îÄ‚îÄ Firebase REST yardƒ±mcƒ±larƒ± (WebSocket yerine HTTP fetch - mobilde √ßok daha g√ºvenilir) ‚îÄ‚îÄ */
let _FB_REST='https://lisa-518f0-default-rtdb.europe-west1.firebasedatabase.app'; // selectServer() i√ßinde g√ºncellenir
/* ‚îÄ‚îÄ Firebase REST Auth Token Yardƒ±mcƒ±sƒ± ‚îÄ‚îÄ */
async function getFbAuthToken(){
  try{
    if(_auth && _auth.currentUser){
      return await _auth.currentUser.getIdToken(false);
    }
  }catch(e){}
  return null;
}

async function fbRestGet(path, retries=3){
  const wpath = wsPath(path);
  for(let i=0;i<retries;i++){
    const ctrl=new AbortController();
    const t=setTimeout(()=>ctrl.abort(),8000);
    try{
      const token = await getFbAuthToken();
      const authParam = token ? '?auth='+token : '';
      const r=await fetch(_FB_REST+'/'+wpath+'.json'+authParam,{signal:ctrl.signal,cache:'no-store'});
      clearTimeout(t);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }catch(e){
      clearTimeout(t);
      if(i<retries-1 && e.name==='AbortError'){
        await new Promise(res=>setTimeout(res,1500));
        continue;
      }
      throw e;
    }
  }
}
async function fbRestSet(path,val, retries=3){
  const wpath = wsPath(path);
  for(let i=0;i<retries;i++){
    const ctrl=new AbortController();
    const t=setTimeout(()=>ctrl.abort(),8000);
    try{
      const token = await getFbAuthToken();
      const authParam = token ? '?auth='+token : '';
      const r=await fetch(_FB_REST+'/'+wpath+'.json'+authParam,{method:'PUT',body:JSON.stringify(val),headers:{'Content-Type':'application/json'},signal:ctrl.signal});
      clearTimeout(t);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }catch(e){
      clearTimeout(t);
      if(i<retries-1 && e.name==='AbortError'){
        await new Promise(res=>setTimeout(res,1500));
        continue;
      }
      throw e;
    }
  }
}


/* ‚ïê‚ïê G√úVENLƒ∞K: Brute Force Korumasƒ± ‚ïê‚ïê */
const _loginAttempts = {}; // {username: {count, lastAttempt, lockedUntil}}

function recordLoginAttempt(username, success){
  const key = username.toLowerCase();
  if(!_loginAttempts[key]) _loginAttempts[key] = {count:0, lastAttempt:0, lockedUntil:0};
  const rec = _loginAttempts[key];
  if(success){
    // Ba≈üarƒ±lƒ± giri≈üte sƒ±fƒ±rla
    delete _loginAttempts[key];
    return {allowed: true};
  }
  const now = Date.now();
  // 15 dakika ge√ßtiyse sƒ±fƒ±rla
  if(now - rec.lastAttempt > 15 * 60 * 1000) rec.count = 0;
  rec.count++;
  rec.lastAttempt = now;
  // 5 ba≈üarƒ±sƒ±z denemeden sonra kilitle
  if(rec.count >= 5){
    const lockMins = Math.min(rec.count * 2, 60); // max 60 dk
    rec.lockedUntil = now + lockMins * 60 * 1000;
    return {allowed: false, lockedUntil: rec.lockedUntil, mins: lockMins};
  }
  return {allowed: true, remaining: 5 - rec.count};
}

function checkLoginLock(username){
  const key = username.toLowerCase();
  const rec = _loginAttempts[key];
  if(!rec) return {allowed: true};
  if(rec.lockedUntil && Date.now() < rec.lockedUntil){
    const mins = Math.ceil((rec.lockedUntil - Date.now()) / 60000);
    return {allowed: false, mins};
  }
  return {allowed: true, remaining: rec.count > 0 ? 5 - rec.count : 5};
}

/* ‚ïê‚ïê G√úVENLƒ∞K: ƒ∞√ßerik Temizleme (XSS) ‚ïê‚ïê */
function sanitizeInput(str, maxLen=200){
  if(typeof str !== 'string') return '';
  return str.trim().slice(0, maxLen)
    .replace(/[<>'"]/g, c => ({'<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
}

function sanitizeMessage(str, maxLen=2000){
  if(typeof str !== 'string') return '';
  // Script taglerini tamamen √ßƒ±kar
  return str.slice(0, maxLen)
    .replace(/<script[\s\S]*?<\/script>/gi, '')
    .replace(/javascript:/gi, '')
    .replace(/on\w+\s*=/gi, '')
    .replace(/<iframe[\s\S]*?>/gi, '')
    .replace(/<img[^>]+onerror[^>]*>/gi, '');
}

/* ‚ïê‚ïê G√úVENLƒ∞K: Rate Limiting (API √ßaƒürƒ±larƒ±) ‚ïê‚ïê */
const _apiCallLog = {};
function checkRateLimit(action, maxPerMin=20){
  const now = Date.now();
  if(!_apiCallLog[action]) _apiCallLog[action] = [];
  _apiCallLog[action] = _apiCallLog[action].filter(t => now - t < 60000);
  if(_apiCallLog[action].length >= maxPerMin) return false;
  _apiCallLog[action].push(now);
  return true;
}
async function submitLogin(){
  // IP ban kontrol√º
  const ipBanned = await checkIPBan();
  if(ipBanned){ showLoginErr('Bu IP adresi yasaklƒ±dƒ±r.'); return; }
  const user=document.getElementById('loginUser').value.trim();
  const pass=document.getElementById('loginPass').value;
  if(!user){showLoginErr('Kullanƒ±cƒ± adƒ± girin.');return;}
  if(!pass){showLoginErr('≈ûifre girin.');return;}

  // Brute force kontrol√º
  const lockCheck = checkLoginLock(user);
  if(!lockCheck.allowed){
    showLoginErr('‚è≥ √áok fazla hatalƒ± deneme. ' + lockCheck.mins + ' dakika bekleyin.');
    return;
  }

  // Rate limit kontrol√º
  if(!checkRateLimit('login', 10)){
    showLoginErr('‚ö†Ô∏è √áok hƒ±zlƒ± istek g√∂nderiyorsunuz. L√ºtfen bekleyin.');
    return;
  }

  const btn=document.getElementById('loginBtn');
  btn.textContent='Giri≈ü yapƒ±lƒ±yor...';
  btn.disabled=true;

  const ph=await hashStr(pass+user);
  try{
    // ‚îÄ‚îÄ Admin giri≈üi ‚Äî Cloud Function baƒüƒ±mlƒ±lƒ±ƒüƒ± yok, doƒürudan DB (REST) ‚îÄ‚îÄ
    if(ADMIN_USERNAME && user===ADMIN_USERNAME){
      try{
        if(!_db){ const ok = await fbInit().catch(()=>false); if(!ok||!_db){ showLoginErr('Sunucuya baƒülanƒ±lamadƒ±.'); resetBtn(); return; } }
        const adminData = await fbRestGet('users/'+user).catch(()=>null);
        const phLegacy  = hashStrSync(pass+user);
        if(!adminData){
          showLoginErr('Admin hesabƒ± bulunamadƒ±. Firebase DB'ye users/admin kaydƒ± ekleyin.');
          resetBtn(); return;
        }
        const storedHash = adminData.passwordHash || '';
        const matched    = (storedHash === ph) || (storedHash === phLegacy);
        if(!matched){
          const rem  = recordLoginAttempt(user, false);
          const lock = checkLoginLock(user);
          if(!lock.allowed) showLoginErr('‚è≥ √áok fazla hatalƒ± giri≈ü. ' + lock.mins + ' dakika kilitli.');
          else showLoginErr('≈ûifre yanlƒ±≈ü.' + (rem.remaining !== undefined ? ' ' + rem.remaining + ' hakkƒ±nƒ±z kaldƒ±.' : ''));
          resetBtn(); return;
        }
        if(adminData.banned){ showLoginErr('Bu hesap yasaklandƒ±.'); resetBtn(); return; }
        // Legacy hash y√ºkselt
        if(storedHash === phLegacy && storedHash !== ph){
          await fbRestSet('users/'+user+'/passwordHash', ph).catch(()=>{});
        }
        // Admin yetkisi: isAdmin flag VEYA admins/ path
        const isAdminFlag  = adminData.isAdmin === true;
        const adminsEntry  = await fbRestGet('admins/'+user).catch(()=>null);
        recordLoginAttempt(user, true);
        _passwordHash=ph; _cu=user; _isAdmin=(isAdminFlag || !!adminsEntry);
        onLoginSuccess();
        return;
      }catch(dbErr){
        const msg = dbErr.message || String(dbErr);
        if(msg.includes('permission_denied')||msg.includes('401')||msg.includes('403')){
          showLoginErr('DB eri≈üimi reddedildi. Firebase Rules veya Anonymous Auth ayarƒ±nƒ± kontrol edin.');
        } else {
          showLoginErr('Baƒülantƒ± hatasƒ±: ' + msg);
        }
        resetBtn(); return;
      }
    }
    // Normal kullanƒ±cƒ± ‚Äî users/ tablosundan doƒürula
    const phLegacy = hashStrSync(pass+user);
    // _db null ise yeniden baƒülanmayƒ± dene
    if(!_db){
      const ok = await fbInit().catch(()=>false);
      if(!ok || !_db){ showLoginErr('Sunucuya baƒülanƒ±lamadƒ±. Sayfayƒ± yenileyip tekrar deneyin.'); resetBtn(); return; }
    }
    // SDK yerine REST kullan ‚Äî auth/configuration-not-found olan sunucularda da √ßalƒ±≈üƒ±r
    const rootD = await fbRestGet('users/'+user).catch(()=>null);
    if(!rootD){showLoginErr('Kullanƒ±cƒ± bulunamadƒ±. Kayƒ±t ol!');resetBtn();return;}
    const stored = rootD.passwordHash;
    let matched = false;
    if(stored === ph){ matched=true; }
    else if(stored === phLegacy){
      matched=true;
      await fbRestSet('users/'+user+'/passwordHash', ph).catch(()=>{});
    }
    if(!matched){
      const rem = recordLoginAttempt(user, false);
      const lock = checkLoginLock(user);
      if(!lock.allowed) showLoginErr('‚è≥ √áok fazla hatalƒ± giri≈ü. ' + lock.mins + ' dakika hesabƒ±n kilitli.');
      else showLoginErr('≈ûifre yanlƒ±≈ü.' + (rem.remaining !== undefined ? ' ' + rem.remaining + ' hakkƒ±nƒ±z kaldƒ±.' : ''));
      resetBtn();return;
    }
    if(rootD.banned){showLoginErr('Bu hesap yasaklandƒ±.');resetBtn();return;}
    recordLoginAttempt(user, true);
    _passwordHash=ph;_cu=user;_isAdmin=false;
    onLoginSuccess();
  }catch(e){
    let msg = e.message || String(e);
    if(msg.includes('permission_denied') || msg.includes('HTTP 401') || msg.includes('HTTP 403')){
      msg = 'Sunucu baƒülantƒ± yetkisi reddedildi. Firebase Console\'da Anonymous Authentication\'ƒ± etkinle≈ütirin.';
    } else if(e.name==='AbortError'){
      msg = 'Sunucuya ula≈üƒ±lamadƒ±. ƒ∞nternet baƒülantƒ±nƒ± kontrol et ve tekrar dene.';
    } else {
      msg = 'Baƒülantƒ± hatasƒ±: ' + msg;
    }
    showLoginErr(msg); resetBtn();
  }
}

/* ‚îÄ‚îÄ Kayƒ±t: global ge√ßici veri ‚îÄ‚îÄ */
var _regPending = null;

async function submitRegister(){
  // Kayƒ±t a√ßƒ±k mƒ± kontrol√º
  try{
    const regSetting = await fbRestGet('settings/registration');
    if(regSetting === 'closed'){
      showLoginErr('‚ùå Bu sunucuda ≈üu an yeni √ºye kaydƒ± kapalƒ±dƒ±r.');
      return;
    }
  }catch(e){ /* ayar yoksa a√ßƒ±k say */ }
  const user=sanitizeInput(document.getElementById('regUser').value.trim(), 30);
  const email=sanitizeInput(document.getElementById('regEmail').value.trim(), 100);
  const pass=document.getElementById('regPass').value;
  const pass2=document.getElementById('regPass2').value;
  const origin=document.getElementById('regOrigin').value;

  const tosChecked = document.getElementById('regTosCheck')?.checked;
  const kvkkChecked = document.getElementById('regKvkkCheck')?.checked;
  if(!tosChecked){showLoginErr('√úyelik S√∂zle≈ümesini kabul etmelisiniz.');return;}
  if(!kvkkChecked){showLoginErr('KVKK Aydƒ±nlatma Metnini kabul etmelisiniz.');return;}
  if(!user){showLoginErr('Kullanƒ±cƒ± adƒ± girin.');return;}
  if(user.length<2){showLoginErr('Kullanƒ±cƒ± adƒ± en az 2 karakter.');return;}
  if(!/^[a-zA-Z0-9_.\-√ßƒüƒ±≈ü√∂√º√áƒûƒ∞≈û√ñ√ú]+$/.test(user)){showLoginErr('Kullanƒ±cƒ± adƒ±nda ge√ßersiz karakter.');return;}
  if(user===ADMIN_USERNAME){showLoginErr('Bu kullanƒ±cƒ± adƒ± kullanƒ±lamaz.');return;}
  if(!email||!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){showLoginErr('Ge√ßerli bir e-posta girin.');return;}
  if(pass.length<6){showLoginErr('≈ûifre en az 6 karakter olmalƒ±.');return;}
  if(pass!==pass2){showLoginErr('≈ûifreler e≈üle≈ümiyor.');return;}
  if(!origin){showLoginErr('K√∂ken/uyruk se√ßin.');return;}

  // Davet kodu doƒürulama (Firebase'de settings/inviteCode varsa zorunlu)
  const inviteCodeInput = (document.getElementById('regInviteCode')?.value||'').trim();
  try{
    const inviteCode = await fbRestGet('settings/inviteCode').catch(()=>null);
    if(inviteCode){
      if(!inviteCodeInput){showLoginErr('Davet kodu gereklidir.');return;}
      if(inviteCodeInput !== String(inviteCode)){showLoginErr('Davet kodu hatalƒ±.');return;}
    }
  }catch(e){}

  const arabOrigins=['üá∏üáæ Suriyeli','üáÆüá∂ Iraklƒ±','üá∏üá¶ Suudi Arabistanlƒ±','üá¶üá™ BAE\'li','üá∂üá¶ Katarlƒ±','üá≤üá¶ Faslƒ±','üá©üáø Cezayirli','üáπüá≥ Tunuslu','üá™üá¨ Mƒ±sƒ±rlƒ±','üá±üáæ Libyalƒ±','üá∏üá¥ Somalili'];
  if(arabOrigins.includes(origin)){showLoginErr('√úzg√ºn√ºz, bu platformda kayƒ±t olamazsƒ±nƒ±z.');return;}

  const regBtn=document.getElementById('regBtn');
  regBtn.textContent='Kod g√∂nderiliyor...';regBtn.disabled=true;
  const rstReg=()=>{regBtn.textContent='Kayƒ±t Ol ‚Üí';regBtn.disabled=false;};

  try{
    const ex = await fbRestGet('users/'+user);
    if(ex){showLoginErr('Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü.');rstReg();return;}
  }catch(e){showLoginErr('Baƒülantƒ± hatasƒ±.');rstReg();return;}

  const code = String(Math.floor(100000+Math.random()*900000));
  const ph = await hashStr(pass+user);
  _regPending = {user,email,pass:ph,origin,code,exp:Date.now()+30*60*1000};

  // ‚îÄ‚îÄ EmailJS Graceful Degradation ‚îÄ‚îÄ
  const _ejsConfigured = window._EJS && window._EJS.pub && window._EJS.svc && window._EJS.tpl;
  if(!_ejsConfigured){
    regBtn.textContent='Hesap olu≈üturuluyor...';
    try{
      const ex2 = await fbRestGet('users/'+user).catch(()=>null);
      if(ex2){ showLoginErr('Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü.'); rstReg(); return; }
      await fbRestSet('users/'+user,{
        username:user, email:email, createdAt:Date.now(),
        isAdmin:false, banned:false, passwordHash:ph, origin:origin
      });
      _passwordHash=ph; _cu=user; _isAdmin=false;
      _regPending=null;
      onLoginSuccess();
    }catch(e){
      showLoginErr('Kayƒ±t hatasƒ±. ƒ∞nternet baƒülantƒ±nƒ± kontrol et.');
      rstReg();
    }
    return;
  }

  try{
    // EmailJS kota korumasƒ±: aynƒ± email'e 5 dakikada max 3 kod
    const ejsKey = 'ejs_'+email;
    const ejsLog = JSON.parse(localStorage.getItem(ejsKey)||'[]').filter(t=>Date.now()-t<5*60*1000);
    if(ejsLog.length >= 3){ showLoginErr('‚ö†Ô∏è √áok fazla kod isteƒüi. 5 dakika bekleyin.'); rstReg(); return; }
    ejsLog.push(Date.now());
    localStorage.setItem(ejsKey, JSON.stringify(ejsLog));

    await emailjs.send(window._EJS.svc, window._EJS.tpl, {
      to_name: user, email: email, passcode: code
    });
    document.getElementById('regVerifyStep').style.display='block';
    regBtn.style.display='none';
    showLoginErr('');
    document.getElementById('regVerifyCode').focus();
  }catch(e){
    showLoginErr('Mail g√∂nderilemedi: '+(e.text||e.message||'Bilinmeyen hata'));
    rstReg();
  }
}

async function verifyRegCode(){
  if(!_regPending){showLoginErr('L√ºtfen √∂nce kayƒ±t formunu doldurun.');return;}
  if(Date.now()>_regPending.exp){showLoginErr('Kodun s√ºresi doldu. Tekrar deneyin.');_resetRegForm();return;}
  const entered=document.getElementById('regVerifyCode').value.trim();
  if(entered!==_regPending.code){showLoginErr('Kod hatalƒ±. Tekrar deneyin.');return;}

  const vBtn=document.getElementById('regVerifyBtn');
  vBtn.textContent='Hesap olu≈üturuluyor...';vBtn.disabled=true;
  try{
    const ex=await fbRestGet('users/'+_regPending.user);
    if(ex){showLoginErr('Bu kullanƒ±cƒ± adƒ± artƒ±k alƒ±nmƒ±≈ü.');_resetRegForm();return;}
    await fbRestSet('users/'+_regPending.user,{
      username:_regPending.user,
      email:_regPending.email,
      createdAt:Date.now(),
      isAdmin:false,
      banned:false,
      passwordHash:_regPending.pass,
      origin:_regPending.origin
    });
    _passwordHash=_regPending.pass;_cu=_regPending.user;_isAdmin=false;
    _regPending=null;
    onLoginSuccess();
  }catch(e){
    showLoginErr('Baƒülantƒ± hatasƒ±. ƒ∞nterneti kontrol et.');
    vBtn.textContent='Hesabƒ± Aktifle≈ütir ‚úì';vBtn.disabled=false;
  }
}

async function resendRegCode(){
  if(!_regPending){return;}
  const _ejsOk = window._EJS && window._EJS.pub && window._EJS.svc && window._EJS.tpl;
  if(!_ejsOk){ showLoginErr('‚ö†Ô∏è E-posta √∂zelliƒüi ≈üu an devre dƒ±≈üƒ±.'); return; }
  const newCode=String(Math.floor(100000+Math.random()*900000));
  _regPending.code=newCode;
  _regPending.exp=Date.now()+30*60*1000;
  try{
    await emailjs.send(window._EJS.svc, window._EJS.tpl, {
      to_name:_regPending.user,
      email:_regPending.email,
      passcode:newCode
    });
    showLoginErr('Yeni kod g√∂nderildi! ‚úÖ');
  }catch(e){showLoginErr('Mail g√∂nderilemedi: '+(e.text||e.message||'Bilinmeyen hata'));}
}

function _resetRegForm(){
  _regPending=null;
  document.getElementById('regVerifyStep').style.display='none';
  document.getElementById('regBtn').style.display='block';
  document.getElementById('regBtn').textContent='Kayƒ±t Ol ‚Üí';
  document.getElementById('regBtn').disabled=false;
  document.getElementById('regVerifyCode').value='';
  document.getElementById('regVerifyBtn').textContent='Hesabƒ± Aktifle≈ütir ‚úì';
  document.getElementById('regVerifyBtn').disabled=false;
}


function resetBtn(){
  const btn=document.getElementById('loginBtn');
  btn.textContent='Giri≈ü Yap ‚Üí';
  btn.disabled=false;
}

/* ‚îÄ‚îÄ Login Success ‚îÄ‚îÄ */



/* ‚îÄ‚îÄ IP Adresi Kaydetme ‚îÄ‚îÄ */
async function getUserIP(){
  try{
    const r = await fetch('https://api.ipify.org?format=json',{cache:'no-store'});
    const d = await r.json();
    return d.ip||null;
  }catch(e){ return null; }
}

async function saveUserIP(username){
  const ip = await getUserIP();
  if(!ip||!username) return;
  const now = Date.now();
  // Kullanƒ±cƒ± kaydƒ±na IP ekle
  try{
    await fbRestGet('users/'+username).then(async u=>{
      const ips = u?.ipHistory||{};
      ips[now] = ip;
      // Son 10 IP'yi tut
      const keys = Object.keys(ips).sort((a,b)=>b-a).slice(0,10);
      const trimmed = {};
      keys.forEach(k=>{ trimmed[k]=ips[k]; });
      await fbRestSet('users/'+username+'/ipHistory', trimmed).catch(()=>{});
      await fbRestSet('users/'+username+'/lastIP', ip).catch(()=>{});
    });
    // IP ban listesinde var mƒ± kontrol et
    const banned = await fbRestGet('bannedIPs/'+ip.replace(/\./g,'_'));
    if(banned){
      showToast('Bu IP adresi yasaklƒ±dƒ±r.');
      setTimeout(()=>logout(),1500);
    }
  }catch(e){}
}

async function checkIPBan(){
  const ip = await getUserIP();
  if(!ip) return false;
  try{
    const banned = await fbRestGet('bannedIPs/'+ip.replace(/\./g,'_'));
    return !!banned;
  }catch(e){ return false; }
}
function onLoginSuccess(){
  loadCustomGameImages();
  loadCustomGames();
  loadUserSecurityData();
  saveUserIP(_cu);
  localStorage.setItem('sohbet_user_' + _activeServer, _cu);
  localStorage.setItem('sohbet_pass_' + _activeServer, _passwordHash||'');
  localStorage.setItem('sohbet_last_server', _activeServer);
  // Admin durumunu her zaman DB'den doƒürula ‚Äî localStorage'a g√ºvenme
  const _finalizeAdminStatus = (isAdm) => {
    _isAdmin = isAdm && (_cu === ADMIN_USERNAME);
    if(_isAdmin) localStorage.setItem('sohbet_admin_' + _activeServer,'1');
    else localStorage.removeItem('sohbet_admin_' + _activeServer);
    const ab = document.getElementById('adminPanelBtn');
    if(ab) ab.style.display = _isAdmin ? 'flex' : 'none';
    const rb = document.getElementById('rb-admin');
    if(rb) rb.style.display = _isAdmin ? 'flex' : 'none';
  };
  if(_cu){
    fbRestGet('admins/'+_cu).then(val=>{
      _finalizeAdminStatus(!!val);
    }).catch(()=>{ _finalizeAdminStatus(_cu === ADMIN_USERNAME); });
  } else {
    _finalizeAdminStatus(_cu === ADMIN_USERNAME);
  }
  // Kendi fotoƒürafƒ±nƒ± √∂nceden cache'e y√ºkle
  if(_db && _cu){
    dbRef('users/'+_cu+'/photoURL').once('value').then(s=>{
      const url = s.val();
      if(url){ _avatarCache[_cu] = url; }
      renderMyAvatar();
    }).catch(()=>{ renderMyAvatar(); });
  } else {
    renderMyAvatar();
  }
  // adminPanelBtn artƒ±k _finalizeAdminStatus i√ßinde y√∂netiliyor

  // loginScreen'i tamamen gizle ‚Äî z-index:10 olduƒüu i√ßin kaldƒ±rƒ±lmazsa her ≈üeyin √∂n√ºnde kalƒ±r
  var ls = document.getElementById('loginScreen');
  if(ls){ ls.classList.remove('active'); ls.style.display='none'; }

  switchMainTab('home');
  loadRooms();
  if(typeof deskLoadRoomList==='function' && IS_DESKTOP()) setTimeout(deskLoadRoomList,500);
  startHeartbeat();listenOnline();listenFriendRequests();
  requestNotifPermission();
  listenIncomingCalls();
  initLocalVideoDrag();
  scheduleDMClear();
  if(typeof _newFeatureInit==='function') _newFeatureInit();
}

function doLogout(){
  if(_stopMsg){_stopMsg();_stopMsg=null;}
  if(_stopOnl){_stopOnl();_stopOnl=null;}
  if(_stopFrReqs){_stopFrReqs();_stopFrReqs=null;}
  clearInterval(_hbTimer);
  if(_db&&_cu) dbRef('online/'+_cu).remove().catch(()=>{});
  localStorage.removeItem('sohbet_user_' + _activeServer);
  localStorage.removeItem('sohbet_admin_' + _activeServer);
  localStorage.removeItem('sohbet_pass_' + _activeServer);
  localStorage.removeItem('sohbet_last_server');
  try{ localStorage.removeItem(_cgiCacheKey()); }catch(e){}
  try{ localStorage.removeItem(_cgCacheKey()); }catch(e){}
  _customGameImages = {};
  _customGames = [];
  _cu=null;_cRoom=null;_online={};_unread={};_isAdmin=false;
  Object.values(_lastMsgListeners).forEach(s=>{try{s();}catch(e){}});
  Object.keys(_lastMsgListeners).forEach(k=>delete _lastMsgListeners[k]);
  switchMainTab('home');
  var av=document.getElementById('myAvatar');if(av){av.textContent='';av.style.background='';}
  var lu=document.getElementById('loginUser');if(lu)lu.value='';
  var lp=document.getElementById('loginPass');if(lp)lp.value='';
  var lb=document.getElementById('loginBtn');if(lb){lb.textContent='Giri≈ü Yap ‚Üí';lb.disabled=false;}
  hideLoginErr();
  if(typeof showLoginTab==='function')showLoginTab('giris');
  // Sunucu se√ßimine d√∂n
  backToServerSelect();
}

/* ‚îÄ‚îÄ Nav ‚îÄ‚îÄ */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>{s.classList.remove('active');});
  // loginScreen display'ini sƒ±fƒ±rla (onLoginSuccess'ta none yapƒ±lmƒ±≈ü olabilir)
  const ls=document.getElementById('loginScreen');
  if(ls) ls.style.display='';
  const el=document.getElementById(id);
  if(el){ el.style.display=''; el.classList.add('active'); }
  if(id==='chatScreen') setTimeout(scrollBottom,100);
  // If returning to a main tab screen, restore active tab
  if(Object.values(_mainScreenIds).includes(id)){
    _activeMainTab=Object.keys(_mainScreenIds).find(k=>_mainScreenIds[k]===id)||'home';
  }
}
function goBack(){if(_stopMsg){_stopMsg();_stopMsg=null;}clearTypingFlag();stopTypingListener();_cRoom=null;closeEmoji();closeChatMenu();document.getElementById('callAudioBtn').style.display='none';document.getElementById('callVideoBtn').style.display='none';document.getElementById('callScreenBtn').style.display='none';switchMainTab('home');loadRooms();}

/* ‚îÄ‚îÄ Online ‚îÄ‚îÄ */
function startHeartbeat(){
  clearInterval(_hbTimer);
  const b=()=>{
    if(!_cu||!_db) return;
    dbRef('online/'+_cu).set({ts:Date.now(),user:_cu}).catch(()=>{});
    // Son g√∂r√ºlme g√ºncelle
    dbRef(wsPath('users/'+_cu+'/lastSeen')).set(Date.now()).catch(()=>{});
  };
  b(); _hbTimer=setInterval(b,25000);
  // Sayfa kapanƒ±nca lastSeen yaz
  window.addEventListener('beforeunload',()=>{
    if(_cu&&_db) dbRef(wsPath('users/'+_cu+'/lastSeen')).set(Date.now());
  },{once:true});
}
function listenOnline(){
  if(_stopOnl){_stopOnl();_stopOnl=null;}
  const ref=dbRef('online');
  const h=snap=>{
    const now=Date.now(),data=snap.val()||{};
    _online={};
    Object.entries(data).forEach(([k,v])=>{if(v&&now-v.ts<60000)_online[k]=true;});
    if(typeof _updateHdrOnlineFlip==='function'){
      const _cnt=Object.keys(_online).length;
      _updateHdrOnlineFlip(_cnt);
    }
    // Desktop member list'te online dotlarƒ± smooth g√ºncelle
    document.querySelectorAll('.desk-member-row .r-dot, .dsk-row-av .r-dot').forEach(dot=>{
      const av = dot.closest('[style*="background"]');
      if(!av) return;
      const nameEl = av.closest('.desk-member-row,.dsk-row')?.querySelector('.desk-m-name,.dsk-row-name');
      if(!nameEl) return;
      const uname = nameEl.textContent.trim();
      const isOn = !!_online[uname];
      dot.className = 'r-dot ' + (isOn?'on':'off');
    });
    updateChatStatus();refreshDots();
  };
  ref.on('value',h);_stopOnl=()=>ref.off('value',h);
}

/* ‚îÄ‚îÄ Rooms ‚îÄ‚îÄ */
function loadRooms(){
  const L=document.getElementById('roomsList');
  // Cache'den √∂nce g√∂ster (anlƒ±k), sonra canlƒ± g√ºncelle
  const _roomsRef=dbRef('rooms');
  _roomsRef.once('value').then(snap=>{
    const rooms=snap.val()||{};
    renderRooms(rooms);
    Object.values(rooms).forEach(r=>{
      if(!r.id) return;
      // Kanal: herkese a√ßƒ±k, dinle
      if(r.type==='channel'){ listenLastMsg(r.id); return; }
      // DM veya grup: sadece √ºyesi olduƒüumuz odalarƒ± dinle
      const members = r.members||[];
      if(members.includes(_cu)){ listenLastMsg(r.id); }
    });
  }).catch(()=>{
    if(L) L.innerHTML='<div style="padding:20px;text-align:center;color:var(--muted);font-size:.85rem;">Baƒülantƒ± hatasƒ±</div>';
  });
}
function renderRooms(rooms){
  const L=document.getElementById('roomsList');
  const all=Object.values(rooms);
  const ch=all.filter(r=>r.type==='channel');
  // Admin: t√ºm gruplarƒ± g√∂r√ºr (√ºye olmasa da)
  const grMember=all.filter(r=>r.type==='group'&&(r.members&&r.members.includes(_cu)));
  const grHidden=_isAdmin?all.filter(r=>r.type==='group'&&!(r.members&&r.members.includes(_cu))):[];
  const dm=all.filter(r=>r.type==='dm'&&(r.members&&r.members.includes(_cu))&&!(r.hiddenBy&&r.hiddenBy.includes(_cu)));
  let h='';
  if(ch.length){
    h+=`<div class="sec-hdr"><span class="chev">‚ñæ</span>Kanallar</div>`;
    ch.forEach(r=>{h+=chRow(r,false,false);});
  }
  const allGr=[...grMember,...grHidden];
  if(allGr.length||_isAdmin){
    h+=`<div class="sec-hdr"><span class="chev">‚ñæ</span>Gruplar<span class="sec-add" onclick="openCreateGroupModal()">Ôºã</span></div>`;
    grMember.forEach(r=>{h+=chRow(r,true,false);});
    // Admin i√ßin √ºye olmadƒ±ƒüƒ± gruplar - gizli mod ile
    grHidden.forEach(r=>{h+=chRow(r,false,true);});
  }
  h+=`<div class="sec-hdr"><span class="chev">‚ñæ</span>Direkt Mesajlar<span class="sec-add" onclick="openDMModal()">Ôºã</span></div>`;
  if(dm.length){dm.forEach(r=>{h+=dmRowHTML(r);});}
  else{h+=`<div style="padding:5px 44px;font-size:.82rem;color:rgba(255,255,255,.3)">Ôºã ile yeni mesaj ba≈ülat</div>`;}
  L.innerHTML=h||'<div style="padding:20px 16px;font-size:.85rem;color:rgba(255,255,255,.3)">Hen√ºz oda yok. Admin kanal olu≈üturabilir.</div>';
}
function chRow(r, showLeave, hiddenAdmin){
  const unread=_unread[r.id]||0;
  const cls=unread?'r-row unread':'r-row';
  const icon=r.type==='group'?'üë•':'#';
  const isMember=r.members&&r.members.includes(_cu);
  const leaveBtn=(showLeave&&r.type==='group'&&isMember)?`<div class="r-leave-btn" onclick="event.stopPropagation();leaveGroup('${r.id}','${esc(r.name||r.id)}')" title="Gruptan ayrƒ±l">‚úï</div>`:'';
  // Admin √∂zel badge
  const spyBadge=hiddenAdmin?`<div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:rgba(245,166,35,.15);color:#f5a623;font-size:.6rem;font-weight:900;padding:2px 6px;border-radius:100px;letter-spacing:.04em;">üëÅ Gƒ∞ZLƒ∞</div>`:'';
  const last = _lastMsg[r.id]||{};
  const prevText = last.text ? (last.text.length>40?last.text.slice(0,40)+'‚Ä¶':last.text) : (last.file?'üìé Dosya':'');
  const prevUser = last.user||'';
  const prevOnline = Object.values(_online||{}).length;
  const popup = `<div class="room-preview-popup">
    <div class="rpp-name">${r.type==='group'?'üë• ':'# '}${esc(r.name||r.id)}</div>
    ${prevText?`<div class="rpp-msg">${prevUser?`<b style="color:var(--text)">${esc(prevUser)}:</b> `:''}${esc(prevText)}</div>`:''}
    <div class="rpp-meta"><div class="rpp-dot"></div><span id="rpp-online-${r.id}">‚Ä¶ √ßevrimi√ßi</span></div>
  </div>`;
  return `<div class="${cls}" style="position:relative;${hiddenAdmin?'opacity:.75;':''}" onclick="openRoom('${r.id}')">
    <div class="r-icon">${icon}</div>
    <div class="r-label">${esc(r.name||r.id)}</div>
    ${unread?`<div class="ubadge">${unread}</div>`:''}
    ${leaveBtn}
    ${spyBadge}
    ${popup}
  </div>`;
}
function dmRowHTML(r){
  const other=(r.members||[]).find(m=>m!==_cu)||'?';
  const on=!!_online[other];
  const col=strColor(other);
  const unread=_unread[r.id]||0;
  const cls=unread?'r-row unread':'r-row';
  return `<div class="${cls}" onclick="openRoom('${r.id}')">
    <div class="r-av" style="background:${col}">${initials(other)}<div class="r-dot ${on?'on':'off'}" id="rdot-${r.id}"></div></div>
    <div class="r-label" id="rlabel-${r.id}">${esc(other)}</div>
    ${unread?`<div class="ubadge">${unread}</div>`:''}
    <div class="dm-close-btn" onclick="event.stopPropagation();closeDmConversation('${r.id}')" title="Kapat">‚úï</div>
  </div>`;
}
function closeDmConversation(roomId){
  if(!confirm('Bu DM konu≈ümasƒ±nƒ± listeden kaldƒ±rmak istiyor musunuz?\n\nMesajlar silinmez, ki≈üiyle tekrar mesajla≈üƒ±nca geri a√ßƒ±lƒ±r.')) return;
  dbRef('rooms/'+roomId+'/hiddenBy').once('value').then(snap=>{
    const hidden = snap.val()||[];
    if(!hidden.includes(_cu)){
      dbRef('rooms/'+roomId+'/hiddenBy').set([...hidden, _cu]).then(()=>{
        if(IS_DESKTOP()){
          if(_deskRoom===roomId){_deskRoom=null;document.getElementById('deskChatArea').style.display='none';document.getElementById('deskEmptyState').style.display='flex';}
          deskLoadRoomList();
        } else {
          if(_cRoom===roomId){goBack();}
          loadRooms();
        }
      });
    }
  });
}
function refreshDots(){
  document.querySelectorAll('[id^="rdot-"]').forEach(dot=>{
    const rid=dot.id.replace('rdot-','');
    const lbl=document.getElementById('rlabel-'+rid);
    if(!lbl)return;
    dot.className='r-dot '+(!!_online[lbl.textContent]?'on':'off');
  });
}
// Aktif dinleyicileri sakla ‚Äî tekrar baƒülanmayƒ± √∂nle
const _lastMsgListeners = {};

function listenLastMsg(roomId){
  // Zaten dinleniyorsa tekrar baƒülama
  if(_lastMsgListeners[roomId]) return;
  const ref = dbRef('msgs/'+roomId).orderByChild('ts').limitToLast(1);
  const handler = snap=>{
    const msgs=snap.val();
    if(msgs){
      const last=Object.values(msgs)[0];
      _lastMsg[roomId]=last;
      if(last&&last.user!==_cu){
        checkAndNotify(roomId, last);
      }
      if(_cRoom!==roomId&&last&&last.user!==_cu){
        _unread[roomId]=(_unread[roomId]||0)+1;
        updateRoomBadge(roomId, _unread[roomId]);
        // Bildirim merkezi
        if(typeof addNotif==='function'){
          const notifText=(last.text||'').slice(0,50);
          addNotif('msg', last.user + ' sana mesaj atti', notifText, function(){openChat(roomId,'','','');});
        }
        // Auto-unhide DM if we receive a new message from them
        dbRef('rooms/'+roomId+'/hiddenBy').once('value').then(s=>{
          const hidden=s.val()||[];
          if(hidden.includes(_cu)){
            const updated=hidden.filter(u=>u!==_cu);
            dbRef('rooms/'+roomId+'/hiddenBy').set(updated.length?updated:null).then(()=>{
              if(IS_DESKTOP()) deskLoadRoomList(); else loadRooms();
            });
          }
        });
      }
    }
  };
  ref.on('value', handler);
  _lastMsgListeners[roomId] = ()=>ref.off('value', handler);
}



function adminJoinGroup(){
  if(!_cRoom)return;
  dbRef('rooms/'+_cRoom+'/members').once('value').then(snap=>{
    const members=snap.val()||[];
    if(members.includes(_cu))return;
    members.push(_cu);
    dbRef('rooms/'+_cRoom+'/members').set(members).then(()=>{
      showToast('Gruba katƒ±ldƒ±nƒ±z.');
      document.getElementById('adminSpyBanner').style.display='none';
      const inp=document.getElementById('chatInputRow');
      if(inp) inp.style.display='';
      loadRooms();
    });
  });
}

/* ‚îÄ‚îÄ Chat Context Menu ‚îÄ‚îÄ */
let _chatMenuOpen = false;

function toggleChatMenu(e){
  e.stopPropagation();
  const menu = document.getElementById('chatContextMenu');
  if(_chatMenuOpen){ closeChatMenu(); return; }
  
  const btn = document.getElementById('chatMenuBtn');
  const rect = btn.getBoundingClientRect();
  
  // Build menu items based on room type
  dbRef('rooms/'+_cRoom).once('value').then(snap=>{
    const room = snap.val()||{};
    const isDM = room.type==='dm';
    const isGroup = room.type==='group';
    const isChannel = room.type==='channel';
    const other = isDM ? (room.members||[]).find(m=>m!==_cu)||'?' : null;
    const isMember = isGroup && (room.members||[]).includes(_cu);
    
    let items = [];
    
    // Notification toggle
    const muted = JSON.parse(localStorage.getItem('sohbet_muted')||'{}');
    const isMuted = !!muted[_cRoom];
    items.push({icon: isMuted?'üîî':'üîï', label: isMuted?'Bildirimleri A√ß':'Bildirimleri Kapat', action: ()=>toggleRoomMute(_cRoom)});
    
    // Search messages
    items.push({icon:'üîç', label:'Mesajlarda Ara', action: ()=>openMsgSearch()});
    
    // Separator
    items.push({sep:true});
    
    if(isDM){
      items.push({icon:'üñ•Ô∏è', label:'Ekran Payla≈ü', action: ()=>startCall('screen')});
      items.push({icon:'üìπ', label:'G√∂r√ºnt√ºl√º Ara', action: ()=>startCall('video')});
      items.push({icon:'üìû', label:'Sesli Ara', action: ()=>startCall('audio')});
      items.push({sep:true});
      items.push({icon:'üóëÔ∏è', label:'Konu≈ümayƒ± Kapat', action: ()=>closeDmConversation(_cRoom), danger:true});
    }
    
    if(isGroup && isMember){
      items.push({icon:'üë•', label:'√úyeleri G√∂r', action: ()=>showGroupMembers(room)});
      items.push({sep:true});
      items.push({icon:'üö™', label:'Gruptan Ayrƒ±l', action: ()=>leaveGroup(_cRoom, room.name||_cRoom), danger:true});
    }
    
    if(_isAdmin){
      items.push({sep:true});
      items.push({icon:'‚öôÔ∏è', label:'Oda Ayarlarƒ± (Admin)', action: ()=>{switchMainTab('home');openAdminPanel();adminTab('rooms');}});
    }
    
    // Render
    menu.innerHTML = items.map(item=>{
      if(item.sep) return '<div class="cm-sep"></div>';
      return `<div class="cm-item${item.danger?' danger':''}" onclick="closeChatMenu();(${item.action.toString()})()">
        <span style="font-size:1rem;width:20px;text-align:center">${item.icon}</span>
        <span>${item.label}</span>
      </div>`;
    }).join('');
    
    // Position
    menu.style.display = 'block';
    const menuW = 210, menuH = menu.scrollHeight;
    let left = rect.right - menuW;
    let top = rect.bottom + 4;
    if(left < 8) left = 8;
    if(top + menuH > window.innerHeight - 8) top = rect.top - menuH - 4;
    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
    
    _chatMenuOpen = true;
    setTimeout(()=>document.addEventListener('click', closeChatMenuOutside, true), 0);
  });
}

function closeChatMenu(){
  document.getElementById('chatContextMenu').style.display='none';
  _chatMenuOpen = false;
  document.removeEventListener('click', closeChatMenuOutside, true);
}

function closeChatMenuOutside(e){
  const menu = document.getElementById('chatContextMenu');
  if(!menu.contains(e.target)) closeChatMenu();
}

function toggleRoomMute(roomId){
  const muted = JSON.parse(localStorage.getItem('sohbet_muted')||'{}');
  if(muted[roomId]){ delete muted[roomId]; showToast('Bildirimler a√ßƒ±ldƒ±.'); }
  else { muted[roomId]=true; showToast('Bildirimler kapatƒ±ldƒ±.'); }
  localStorage.setItem('sohbet_muted', JSON.stringify(muted));
}

function openMsgSearch(){
  // Simple prompt-based search for now
  const q = prompt('Mesajlarda ara:');
  if(!q||!q.trim()) return;
  const term = q.trim().toLowerCase();
  const msgs = document.querySelectorAll('#chatMsgs .mb-text, #chatMsgs .ob');
  let found = 0;
  msgs.forEach(el=>{
    const orig = el.innerHTML;
    el.innerHTML = orig.replace(/<mark[^>]*>/g,'').replace(/<\/mark>/g,'');
    const text = el.textContent;
    if(text.toLowerCase().includes(term)){
      el.innerHTML = el.textContent.replace(new RegExp('('+term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'),'<mark style="background:#f0c040;color:#000;border-radius:2px;padding:0 2px">$1</mark>');
      found++;
    }
  });
  if(found){ 
    // Scroll to first match
    const first = document.querySelector('#chatMsgs mark');
    if(first) first.scrollIntoView({behavior:'smooth',block:'center'});
    showToast(found+' sonu√ß bulundu.');
  } else {
    showToast('Sonu√ß bulunamadƒ±.');
  }
}

function showGroupMembers(room){
  const members = room.members||[];
  const online = members.filter(u=>_online[u]);
  const offline = members.filter(u=>!_online[u]);
  let msg = 'üë• '+room.name+' ‚Äî '+members.length+' √ºye\n\n';
  if(online.length) msg += 'üü¢ √áevrimi√ßi: '+online.join(', ')+'\n';
  if(offline.length) msg += '‚ö´ √áevrimdƒ±≈üƒ±: '+offline.join(', ');
  alert(msg);
}

async function leaveGroup(roomId, roomName){
  if(!confirm('"'+roomName+'" grubundan ayrƒ±lmak istediƒüinize emin misiniz?'))return;
  try{
    const snap = await dbRef('rooms/'+roomId+'/members').once('value');
    const members=(snap.val()||[]).filter(m=>m!==_cu);
    await dbRef('rooms/'+roomId+'/members').set(members);
    showToast(roomName+' grubundan ayrƒ±ldƒ±nƒ±z.');
    loadRooms();
  }catch(e){showToast('Hata.');}
}

/* ‚îÄ‚îÄ Create Group Modal ‚îÄ‚îÄ */
function openCreateGroupModal(){
  document.getElementById('createGroupModal').style.display='flex';
  document.getElementById('cgName').value='';
  document.getElementById('cgSearch').value='';
  document.getElementById('cgUserList').innerHTML='';
  document.getElementById('cgSelectedList').innerHTML='<div style="color:var(--muted);font-size:.78rem">Hen√ºz kimse se√ßilmedi</div>';
  _cgSelected=new Set();
  loadCGUsers('');
}
function closeCGModal(){document.getElementById('createGroupModal').style.display='none';}
let _cgSelected=new Set();
function loadCGUsers(q){
  const el=document.getElementById('cgUserList');
  dbRef('users').once('value').then(snap=>{
    const rawUsers=snap.val()||{}; const users=Object.keys(rawUsers).filter(u=>{if(u===_cu||rawUsers[u].banned) return false; if(q&&!u.toLowerCase().includes(q)) return false; return true;});
    if(!users.length){el.innerHTML='<div style="color:var(--muted);font-size:.78rem;padding:8px">Kullanƒ±cƒ± bulunamadƒ±</div>';return;}
    el.innerHTML=users.map(u=>`
      <div style="display:flex;align-items:center;gap:8px;padding:6px 4px;cursor:pointer;" onclick="toggleCGUser('${u}')">
        <input type="checkbox" id="cgcb-${u}" ${_cgSelected.has(u)?'checked':''} style="width:15px;height:15px;">
        <div style="width:30px;height:30px;border-radius:7px;background:${strColor(u)};display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:900;color:#fff;">${initials(u)}</div>
        <div style="font-size:.85rem;color:var(--text-hi);">${esc(u)}</div>
        <div style="font-size:.7rem;color:var(--muted);margin-left:auto;">${_online[u]?'üü¢':''}</div>
      </div>`).join('');
  });
}
function toggleCGUser(u){
  if(_cgSelected.has(u))_cgSelected.delete(u);
  else _cgSelected.add(u);
  const cb=document.getElementById('cgcb-'+u);
  if(cb)cb.checked=_cgSelected.has(u);
  const selEl=document.getElementById('cgSelectedList');
  if(_cgSelected.size===0){selEl.innerHTML='<div style="color:var(--muted);font-size:.78rem">Hen√ºz kimse se√ßilmedi</div>';return;}
  selEl.innerHTML=[..._cgSelected].map(s=>`<div style="display:inline-flex;align-items:center;gap:4px;background:var(--surface2);border-radius:100px;padding:3px 10px 3px 6px;font-size:.75rem;margin:2px;">
    <div style="width:18px;height:18px;border-radius:4px;background:${strColor(s)};display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:900;color:#fff;">${initials(s)}</div>
    ${esc(s)}
    <span onclick="toggleCGUser('${s}')" style="cursor:pointer;color:var(--muted);margin-left:2px;">‚úï</span>
  </div>`).join('');
}
function submitCreateGroup(){
  const name=document.getElementById('cgName').value.trim();
  if(!name){showToast('Grup adƒ± girin.');return;}
  const members=[_cu,..._cgSelected];
  const id='group_'+name.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'')+'_'+Date.now();
  const data={id,name,type:'group',members,createdBy:_cu,ts:Date.now()};
  dbRef('rooms/'+id).set(data).then(()=>{
    showToast('"'+name+'" grubu olu≈üturuldu!');
    closeCGModal();
    loadRooms();
    setTimeout(()=>openRoom(id),300);
  }).catch(()=>showToast('Hata olu≈ütu.'));
}

/* ‚îÄ‚îÄ Open Room ‚îÄ‚îÄ */
function openRoom(roomId){
  if(_stopMsg){_stopMsg();_stopMsg=null;}
  stopTypingListener();
  _cRoom=roomId;clearUnreadBadge(roomId);closeEmoji();
  _currentMsgBox='chatMsgs';
  markRoomRead(roomId);
  listenReads(roomId);
  listenTyping(roomId);
  listenPinBar(roomId);
  document.getElementById('chatMsgs').innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  dbRef('rooms/'+roomId).once('value').then(snap=>{
    const room=snap.val();if(!room)return;
    if(room.type==='dm'){
      const other=(room.members||[]).find(m=>m!==_cu)||'?';
      const ic=document.getElementById('chatHdrIcon');
      ic.textContent=initials(other);ic.style.background=strColor(other);
      document.getElementById('chatHdrName').textContent=other;
      updateChatStatus();
      showCallBtns(true);
    } else {
      showCallBtns(false);
      const ic=document.getElementById('chatHdrIcon');
      ic.textContent=room.type==='group'?'üë•':'#';
      ic.style.background=room.type==='group'?'linear-gradient(135deg,#9b72ff,#c4a7ff)':'var(--surface2)';
      document.getElementById('chatHdrName').textContent=room.name||roomId;
      const isHiddenAdmin=_isAdmin&&room.type==='group'&&!(room.members||[]).includes(_cu);
      const subEl=document.getElementById('chatHdrSub');
      if(isHiddenAdmin){
        subEl.textContent='\u{1F441} \u00d6zel mod \u2014 '+(room.members||[]).length+' \u00fcye';
        subEl.className='c-hdr-sub';
        subEl.style.color='#f5a623';
        // Mesaj g√∂nderim alanƒ±nƒ± gizle
        const inp=document.getElementById('chatInputRow');
        if(inp) inp.style.display='none';
        document.getElementById('adminSpyBanner').style.display='flex';
      } else {
        // Online sayƒ±sƒ±nƒ± flip animasyonla g√∂ster
        const _memberCount = (room.members||[]).length;
        const _onlineCount = (room.members||[]).filter(m=>!!(_online||{})[m]).length;
        if(room.type==='group'){
          subEl.innerHTML = `${_memberCount} √ºye &nbsp;¬∑&nbsp; <span id="hdrOnlineCount" style="color:var(--green);">${_onlineCount} √ßevrimi√ßi</span>`;
        } else {
          // Kanal ‚Äî t√ºm online kullanƒ±cƒ±lar
          const _allOnline = Object.keys(_online||{}).length;
          subEl.innerHTML = `Kanal &nbsp;¬∑&nbsp; <span id="hdrOnlineCount" style="color:var(--green);">${_allOnline} √ßevrimi√ßi</span>`;
        }
        subEl.className='c-hdr-sub';
        subEl.style.color='';
        const inp=document.getElementById('chatInputRow');
        if(inp) inp.style.display='';
        document.getElementById('adminSpyBanner').style.display='none';
      }
    }
  });
  showScreen('chatScreen');
  // clearedAt bilgisini ONCE al, SONRA listener ba≈ülat (race condition fix)
  const ref=dbRef('msgs/'+roomId);
  dbRef('rooms/'+roomId+'/clearedAt').once('value').then(cs=>{
    const _clearedAt=cs.val()||0;
    if(_cRoom!==roomId)return;
    const h=snap=>{if(_cRoom!==roomId)return;renderMsgs(snap.val(),_clearedAt);};
    ref.on('value',h);_stopMsg=()=>ref.off('value',h);
  }).catch(()=>{
    const h=snap=>{if(_cRoom!==roomId)return;renderMsgs(snap.val(),0);};
    ref.on('value',h);_stopMsg=()=>ref.off('value',h);
  });
}
function updateChatStatus(){
  const roomId = _deskRoom || _cRoom;
  if(!roomId) return;
  dbRef('rooms/'+roomId).once('value').then(snap=>{
    const room=snap.val();if(!room||room.type!=='dm')return;
    const other=(room.members||[]).find(m=>m!==_cu)||'?';
    const on=!!_online[other];
    // Mobil header
    const el=document.getElementById('chatHdrSub');
    if(el){
      if(on){ el.className='c-hdr-sub on'; el.innerHTML='üü¢ √áevrimi√ßi'; }
      else {
        dbRef(wsPath('users/'+other+'/lastSeen')).once('value').then(ls=>{
          const ts=ls.val(); el.className='c-hdr-sub';
          el.textContent = ts ? 'Son g√∂r√ºlme: '+fmtLastSeen(ts) : '√áevrimdƒ±≈üƒ±';
        });
      }
    }
    // Desktop header
    const deskSub = document.getElementById('deskChatHdrSub');
    if(deskSub && _deskRoom){
      if(on){ deskSub.textContent='üü¢ √áevrimi√ßi'; }
      else {
        dbRef(wsPath('users/'+other+'/lastSeen')).once('value').then(ls=>{
          const ts=ls.val();
          deskSub.textContent = ts ? 'Son g√∂r√ºlme: '+fmtLastSeen(ts) : '√áevrimdƒ±≈üƒ±';
        });
      }
    }
  });
}

function fmtLastSeen(ts){
  const diff = Date.now()-ts;
  const m = Math.floor(diff/60000);
  if(m<1) return 'az √∂nce';
  if(m<60) return m+' dakika √∂nce';
  const h=Math.floor(m/60);
  if(h<24) return h+' saat √∂nce';
  const d=Math.floor(h/24);
  return d+' g√ºn √∂nce';
}

/* ‚îÄ‚îÄ Render Messages ‚îÄ‚îÄ */
function renderMsgs(msgsObj, clearedAt){
  const box=document.getElementById('chatMsgs');if(!box)return;
  const atBot=box.scrollHeight-box.scrollTop-box.clientHeight<80;
  let msgs=msgsObj?Object.entries(msgsObj).map(([k,v])=>({...v,_key:k})).sort((a,b)=>a.ts-b.ts):[];
  // clearedAt filtresini uygula ‚Äî temizleme zamanƒ±ndan √∂nceki mesajlarƒ± g√∂sterme
  if(clearedAt) msgs=msgs.filter(m=>m.ts>clearedAt);
  if(!msgs.length){
    box.innerHTML=`<div class="empty-chat"><div class="empty-ic">üí¨</div><div class="empty-title">Sohbet ba≈ülasƒ±n!</div><div class="empty-sub">Hen√ºz mesaj yok. ƒ∞lk mesajƒ± sen g√∂nder.</div></div>`;
    return;
  }
  let h='',lastDate='',lastUser='',lastTs=0;
  msgs.forEach((m)=>{
    if(m.sys){h+=`<div class="msg-sys">${esc(m.text)}</div>`;lastUser='';return;}
    const own=m.user===_cu;
    const d=new Date(m.ts);
    const ds=formatDate(d);
    if(ds!==lastDate){h+=`<div class="date-div"><span class="date-txt">${ds}</span></div>`;lastDate=ds;lastUser='';}
    const gap=m.ts-lastTs>300000;
    const first=m.user!==lastUser||gap;
    lastUser=m.user;lastTs=m.ts;
    let content='';
    if(m.file){
      if(m.file.type&&m.file.type.startsWith('image/')){content=m.file.isEmoji?`<img class="msg-emoji-img" src="${m.file.data}" style="width:48px;height:48px;border-radius:6px;vertical-align:middle;">`:`<img class="msg-img" src="${m.file.data}" onclick="zoomImg(this.src)" loading="lazy">`;}
      else if(m.file.type&&m.file.type.startsWith('video/')){content=`<video controls style="max-width:min(260px,70vw);border-radius:8px;margin-top:4px"><source src="${m.file.data}" type="${m.file.type}"></video>`;}
      else{content=`<div class="msg-file-card" onclick="event.stopPropagation();downloadDataUrl('${m.file.data}','${esc(m.file.name||'dosya')}')"><div class="msg-file-icon">üìÑ</div><div class="msg-file-info"><div class="msg-file-name">${esc(m.file.name)}</div><div class="msg-file-size">${fmtSize(m.file.size)}</div></div><div style="margin-left:auto;font-size:1rem;color:var(--muted);">‚¨áÔ∏è</div></div>`;}
    } else if(m.voice){
      const dur = m.voice.dur ? fmtDuration(m.voice.dur) : '0:00';
      content = `<div class="voice-msg-wrap">
        <button class="voice-play-btn" onclick="playVoiceMsg(this,'${m._key}')">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="white"><polygon points="5,3 19,12 5,21"/></svg>
        </button>
        <div class="voice-waveform" id="vwf_${m._key}">${Array.from({length:20},(_,i)=>`<span style="height:${m.voice.bars?m.voice.bars[i]||4:4+Math.sin(i*0.7)*4}px"></span>`).join('')}</div>
        <span class="voice-progress" id="vpr_${m._key}">${dur}</span>
        <audio id="vau_${m._key}" src="${m.voice.data||''}" preload="none"></audio>
      </div>`;
    } else {
      let replyHtml = '';
      if(m.replyTo){
        replyHtml = `<div style="border-left:3px solid var(--accent);padding:4px 8px;margin-bottom:4px;border-radius:0 4px 4px 0;background:rgba(255,255,255,.05);font-size:.78rem;cursor:pointer;max-width:100%;overflow:hidden;" onclick="scrollToMsg('${m.replyTo.key}')">
          <span style="color:var(--accent);font-weight:700;">${esc(m.replyTo.user)}</span>
          <span style="color:var(--muted);display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc((m.replyTo.text||'').slice(0,60))}</span>
        </div>`;
      }
      content=own?`<div class="ob">${replyHtml}${linkify(esc(m.text))}</div>`:`<div class="mb-text">${replyHtml}${linkify(esc(m.text))}</div>`;
    }
    const meta=first?`<div class="mb-meta"><div class="mb-name">${esc(own?_cu:m.user)}</div><div class="mb-ts">${fmtTime(m.ts)}${own?getMsgStatusSvg('sent'):''}</div></div>`:
    own?`<div class="mb-meta mb-meta-mini"><div class="mb-ts">${fmtTime(m.ts)}${getMsgStatusSvg('sent')}</div></div>`:'';
    const reactionsHtml = buildReactionsHtml(_cRoom, m._key, m.reactions);
     const avMenuBtn = `<button class="mb-av-menu-btn" data-room="${_cRoom}" data-key="${m._key}" data-own="${own}" data-admin="${_isAdmin}" data-text="${esc(m.text||'').replace(/"/g,'&quot;')}" onclick="showMsgMenuAtBtn(event)">‚ãÆ</button>`;




     h+=`<div class="mb ${own?'own':''} ${first?'first':''}" data-key="${m._key}"${own?' data-ts="'+m.ts+'"':''}>
       <div class="av ${first?'':' ghost'}" style="background:${strColor(m.user)}" data-av-user="${m.user}">${initials(m.user)}</div>
       ${own ? avMenuBtn : ''}
       <div class="mb-body">${meta}${content}${reactionsHtml}</div>
       ${own ? '' : avMenuBtn}
     </div>`;
  });
  box.innerHTML=h;
  // Fotoƒüraflƒ± avatarlarƒ± g√ºncelle
  box.querySelectorAll('[data-av-user]').forEach(el=>{
    setAvatar(el,el.dataset.avUser);
  });
  if(atBot)scrollBottom();
  if(_cRoom){markRoomRead(_cRoom);updateMsgStatuses(_cRoom);}
}
function scrollBottom(){const b=document.getElementById('chatMsgs');if(b)b.scrollTop=b.scrollHeight;}

/* ‚îÄ‚îÄ Read Receipts ‚îÄ‚îÄ */
function markRoomRead(roomId){
  if(!_cu||!roomId)return;
  dbRef('reads/'+roomId+'/'+_cu).set(Date.now());
}
function listenReads(roomId){
  if(_stopReads){_stopReads();_stopReads=null;}
  const ref=dbRef('reads/'+roomId);
  const h=snap=>{_reads[roomId]=snap.val()||{};updateMsgStatuses(roomId);};
  ref.on('value',h);
  _stopReads=()=>ref.off('value',h);
}
function getMsgStatusSvg(type){
  // type: 'sent' | 'delivered' | 'read'
  if(type==='sent'){
    return `<span class="msg-status"><svg viewBox="0 0 14 9"><polyline points="1,5 5,9 13,1"/></svg></span>`;
  }
  // double tick
  const cls=type==='read'?'read':'delivered';
  return `<span class="msg-status ${cls}"><svg viewBox="0 0 20 10"><polyline points="1,5 5,9 13,1"/><polyline points="7,5 11,9 19,1"/></svg></span>`;
}
function updateMsgStatuses(roomId){
  if(!roomId)return;
  const box=document.getElementById(_currentMsgBox||'chatMsgs');
  if(!box)return;
  const reads=_reads[roomId]||{};
  box.querySelectorAll('.mb.own[data-key]').forEach(el=>{
    const ts=parseInt(el.dataset.ts||'0');
    const statusEl=el.querySelector('.msg-status');
    if(!statusEl||!ts)return;
    const others=Object.entries(reads).filter(([u])=>u!==_cu);
    const anyRead=others.some(([,t])=>t>=ts);
    const anyDelivered=others.length>0;
    const cls = anyRead?'read':anyDelivered?'delivered':'';
    statusEl.className='msg-status '+(cls||'');
    // SVG g√ºncelle ‚Äî tek tik: sent, √ßift tik: delivered/read
    const isSingle = !anyDelivered && !anyRead;
    statusEl.innerHTML = isSingle
      ? `<svg viewBox="0 0 14 9"><polyline points="1,5 5,9 13,1"/></svg>`
      : `<svg viewBox="0 0 20 10"><polyline points="1,5 5,9 13,1"/><polyline points="7,5 11,9 19,1"/></svg>`;
  });
}
let _currentMsgBox='chatMsgs';
function updateRoomBadge(roomId, count){
  document.querySelectorAll('.r-row').forEach(row=>{
    const oc=row.getAttribute('onclick')||'';
    if(!oc.includes("'"+roomId+"'")) return;
    row.classList.add('unread');
    let b=row.querySelector('.ubadge');
    if(!b){b=document.createElement('div');b.className='ubadge';row.appendChild(b);}
    b.textContent=count>99?'99+':count;
  });
  document.querySelectorAll('.dsk-row').forEach(row=>{
    if((row.dataset.id||'')!==roomId) return;
    let b=row.querySelector('.dsk-row-badge');
    if(!b){b=document.createElement('div');b.className='dsk-row-badge';row.appendChild(b);}
    b.textContent=count>99?'99+':count;
  });
}
function clearUnreadBadge(roomId){
  _unread[roomId]=0;
  document.querySelectorAll('.r-row').forEach(row=>{
    const oc=row.getAttribute('onclick')||'';
    if(oc.includes("'"+roomId+"'")){
      row.classList.remove('unread');
      const b=row.querySelector('.ubadge');if(b)b.remove();
    }
  });
  document.querySelectorAll('.dsk-row').forEach(row=>{
    if((row.dataset.id||'')===(roomId)){
      const b=row.querySelector('.dsk-row-badge');if(b)b.remove();
    }
  });
}
function deleteMsg(roomId,key){
  document.getElementById('msgCtxMenu').classList.remove('show');
  if(!confirm('Bu mesajƒ± sil?'))return;
  dbRef('msgs/'+roomId+'/'+key).remove().catch(()=>showToast('Silinemedi'));
}

/* ‚îÄ‚îÄ Mesaj Men√ºs√º (3 nokta) ‚Äî Slack tarzƒ± ‚îÄ‚îÄ */
function showMsgMenu(e, room, key, own, isAdmin, text){
  e.stopPropagation();
  e.preventDefault();
  // √ñnceki listener'ƒ± temizle
  document.removeEventListener('click', _closeCtx);
  const menu = document.getElementById('msgCtxMenu');
  if(!menu) return;
  let html = '';
  html += `<div class="ctx-item" onclick="event.stopPropagation();showReactMenu(event,'${room}','${key}')"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span> Tepki Ekle</div>`;
  html += `<div class="ctx-item" onclick="event.stopPropagation();replyToMsg('${room}','${key}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg></span> Cevapla</div>`;
  html += `<div class="ctx-item" onclick="event.stopPropagation();pinMsg('${room}','${key}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V17z"/></svg></span> Sabitle</div>`;
  html += `<div class="ctx-item" onclick="event.stopPropagation();copyMsgText(${JSON.stringify(text)});_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></span> Kopyala</div>`;
  if(own) html += `<div class="ctx-item" onclick="event.stopPropagation();startEditMsg('${room}','${key}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span> D√ºzenle</div>`;
  if(own||isAdmin){
    html += `<div style="height:1px;background:var(--border);margin:3px 4px;"></div>`;
    html += `<div class="ctx-item danger" onclick="event.stopPropagation();deleteMsg('${room}','${key}')"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></span> Sil</div>`;
  }
  menu.innerHTML = html;
  const menuW = 200;
  const menuH = (html.match(/ctx-item/g)||[]).length * 42 + 16;
  let x = e.clientX, y = e.clientY;
  if(x + menuW > window.innerWidth) x = window.innerWidth - menuW - 8;
  if(y + menuH > window.innerHeight) y = window.innerHeight - menuH - 8;
  if(y < 8) y = 8;
  menu.style.cssText = `display:block;position:fixed;left:${x}px;top:${y}px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:5px;z-index:999999;box-shadow:0 8px 32px rgba(0,0,0,.7);min-width:200px;`;
  // Kapat listener'ƒ± 300ms sonra ekle (tƒ±klama bitmeden ekleme)
  setTimeout(()=>document.addEventListener('click', _closeCtx, {once:true}), 300);
}
function _closeCtx(){ 
  const m=document.getElementById('msgCtxMenu'); 
  if(m){ m.style.display='none'; m.classList.remove('show'); }
  document.removeEventListener('click', _closeCtx);
}

function showMsgMenuAtBtn(e){
  e.stopPropagation();
  e.preventDefault();
  document.removeEventListener('click', _closeCtx);

  // data attribute'lardan parametreleri oku
  const btn = e.currentTarget || e.target.closest('button') || e.target;
  const room = btn.dataset.room;
  const key = btn.dataset.key;
  const own = btn.dataset.own === 'true';
  // DOM'dan admin durumu okuma ‚Äî manip√ºlasyona a√ßƒ±k. Ger√ßek deƒüi≈ükeni kullan.
  const isAdmin = _isAdmin;
  const text = btn.dataset.text || '';

  // Men√ºy√º body'e ta≈üƒ± ‚Äî z-index sorunlarƒ±nƒ± √∂nlemek i√ßin
  let menu = document.getElementById('msgCtxMenu');
  if(!menu){ menu = document.createElement('div'); menu.id='msgCtxMenu'; }
  document.body.appendChild(menu);

  let html = '';
  html += `<div class="ctx-item" onclick="event.stopPropagation();showReactMenu(event,'${room}','${key}')"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span> Tepki Ekle</div>`;
  html += `<div class="ctx-item" onclick="event.stopPropagation();replyToMsg('${room}','${key}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg></span> Cevapla</div>`;
  html += `<div class="ctx-item" onclick="event.stopPropagation();pinMsg('${room}','${key}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V17z"/></svg></span> Sabitle</div>`;
  html += `<div class="ctx-item" onclick="event.stopPropagation();copyMsgText(${JSON.stringify(text)});_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></span> Kopyala</div>`;
  if(own) html += `<div class="ctx-item" onclick="event.stopPropagation();startEditMsg('${room}','${key}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span> D√ºzenle</div>`;
  if(own||isAdmin){
    html += `<div style="height:1px;background:var(--border);margin:3px 4px;"></div>`;
    html += `<div class="ctx-item danger" onclick="event.stopPropagation();deleteMsg('${room}','${key}')"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></span> Sil</div>`;
  }
  menu.innerHTML = html;

  // Butona g√∂re konumlandƒ±r
  const rect = btn.getBoundingClientRect();
  const menuW = 210;
  const menuH = menu.querySelectorAll('.ctx-item').length * 42 + 20;
  let x = rect.right + 8;
  let y = rect.top;
  if(x + menuW > window.innerWidth) x = rect.left - menuW - 8;
  if(x < 8) x = 8;
  if(y + menuH > window.innerHeight) y = window.innerHeight - menuH - 8;
  if(y < 8) y = 8;

  menu.style.cssText = 'display:block;position:fixed;left:'+x+'px;top:'+y+'px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:5px;z-index:9999999;box-shadow:0 8px 32px rgba(0,0,0,.7);min-width:200px;';
  setTimeout(()=>document.addEventListener('click', _closeCtx, {once:true}), 300);
}

function copyMsgText(text){
  if(!text) return;
  navigator.clipboard.writeText(text).then(()=>showToast('üìã Kopyalandƒ±!')).catch(()=>{
    const ta=document.createElement('textarea'); ta.value=text;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); showToast('üìã Kopyalandƒ±!');
  });
}

function replyToMsg(room, key){
  if(!_db) return;
  dbRef('msgs/'+room+'/'+key).once('value').then(s=>{
    const msg = s.val(); if(!msg) return;
    const inp = document.getElementById('msgInp') || document.getElementById('deskInp');
    if(inp){
      inp.dataset.replyKey = key;
      inp.dataset.replyUser = msg.user||'';
      inp.dataset.replyText = (msg.text||'').slice(0,80);
      showReplyPreview(msg.user||'', msg.text||'');
      inp.focus();
    }
  });
}

function showReplyPreview(user, text){
  removeReplyPreview();
  const inpWrap = document.querySelector('#chatScreen .inp-wrap') || document.getElementById('deskInpWrap');
  if(!inpWrap) return;
  const div = document.createElement('div');
  div.id = 'replyPreview';
  div.style.cssText = 'display:flex;align-items:center;gap:8px;background:var(--surface);border-left:3px solid var(--blue);border-radius:0 6px 6px 0;padding:6px 10px;font-size:.8rem;flex-shrink:0;';
  div.innerHTML = '<span style="color:var(--blue);font-weight:700;flex-shrink:0;">'+esc(user)+'</span><span style="color:var(--muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+esc(text)+'</span><span onclick="cancelReply()" style="cursor:pointer;color:var(--muted);font-size:1rem;padding:0 4px;flex-shrink:0;">‚úï</span>';
  inpWrap.insertBefore(div, inpWrap.firstChild);
}
function removeReplyPreview(){
  const old = document.getElementById('replyPreview'); if(old) old.remove();
  const inp = document.getElementById('msgInp') || document.getElementById('deskInp');
  if(inp){ delete inp.dataset.replyKey; delete inp.dataset.replyUser; delete inp.dataset.replyText; }
}
function cancelReply(){ removeReplyPreview(); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚úçÔ∏è  YAZIYYOR G√ñSTERGESƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _typingTimer = null;
let _isTyping = false;
let _stopTyping = null;

function setTypingFlag(){
  if(!_cRoom||!_cu) return;
  if(!_isTyping){
    _isTyping = true;
    dbRef('typing/'+_cRoom+'/'+_cu).set(true);
  }
  clearTimeout(_typingTimer);
  _typingTimer = setTimeout(clearTypingFlag, 3000);
}

function clearTypingFlag(){
  clearTimeout(_typingTimer);
  if(_isTyping && _cRoom && _cu){
    _isTyping = false;
    dbRef('typing/'+_cRoom+'/'+_cu).remove();
  }
}

function stopTypingListener(){
  if(_stopTyping){ _stopTyping(); _stopTyping=null; }
}

function listenTyping(roomId){
  stopTypingListener();
  const ref = dbRef('typing/'+roomId);
  const h = snap=>{
    const data = snap.val()||{};
    const others = Object.keys(data).filter(u=>u!==_cu&&data[u]);
    const el = document.getElementById('chatHdrSub');
    if(!el) return;
    if(others.length>0){
      const names = others.slice(0,2).map(u=>u).join(', ');
      let typingLabel;
      if(others.length===1) typingLabel = `<strong>${others[0]}</strong> yazƒ±yor`;
      else if(others.length===2) typingLabel = `<strong>${others[0]}</strong> ve <strong>${others[1]}</strong> yazƒ±yor`;
      else typingLabel = `<strong>${others[0]}</strong> ve <strong>${others.length-1} ki≈üi</strong> daha yazƒ±yor`;
      el.innerHTML = `<span style="color:var(--accent)">${typingLabel} <span class="typing-dots"><span></span><span></span><span></span></span></span>`;
    } else {
      updateChatStatus();
    }
  };
  ref.on('value',h);
  _stopTyping = ()=>ref.off('value',h);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üéôÔ∏è  SESLƒ∞ MESAJ
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _mediaRec = null;
let _recChunks = [];
let _recStartTs = 0;
let _recInterval = null;
let _recDuration = 0;

async function startVoiceRecord(e){
  e.preventDefault();
  if(_mediaRec) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    _mediaRec = new MediaRecorder(stream, {mimeType: MediaRecorder.isTypeSupported('audio/webm')?'audio/webm':'audio/ogg'});
    _recChunks = [];
    _recStartTs = Date.now();
    _recDuration = 0;

    _mediaRec.ondataavailable = e=>{ if(e.data.size>0) _recChunks.push(e.data); };
    _mediaRec.onstop = ()=>{
      stream.getTracks().forEach(t=>t.stop());
      const blob = new Blob(_recChunks, {type:_mediaRec.mimeType});
      const reader = new FileReader();
      reader.onload = ev=>{
        // Basit dalga formu olu≈ütur (16 bar)
        const bars = Array.from({length:16},()=>Math.floor(3+Math.random()*14));
        const msg = {
          user:_cu, ts:Date.now(), text:'',
          voice:{ data:ev.target.result, dur:_recDuration, bars }
        };
        dbRef('msgs/'+_cRoom).push(msg).catch(()=>showToast('G√∂nderilemedi'));
      };
      reader.readAsDataURL(blob);
      _recChunks=[];
    };

    _mediaRec.start(100);

    const btn = document.getElementById('voiceRecordBtn');
    const timer = document.getElementById('recTimer');
    if(btn) btn.classList.add('recording');
    if(timer) timer.classList.add('show');

    _recInterval = setInterval(()=>{
      _recDuration = Math.floor((Date.now()-_recStartTs)/1000);
      const m=Math.floor(_recDuration/60);
      const s=_recDuration%60;
      if(timer) timer.textContent = m+':'+(s<10?'0':'')+s;
      if(_recDuration>=120) stopVoiceRecord(); // max 2 dakika
    },500);
  }catch(e){
    showToast('Mikrofon eri≈üimi reddedildi');
  }
}

async function toggleVoiceRecord(mode){
  if(_mediaRec && _mediaRec.state!=='inactive'){
    // Kayƒ±t devam ediyor ‚Üí durdur & g√∂nder
    clearInterval(_recInterval);
    const isDesk = (mode==='desk');
    const btn = document.getElementById(isDesk?'deskVoiceRecordBtn':'voiceRecordBtn');
    const timer = document.getElementById(isDesk?'deskRecTimer':'recTimer');
    if(btn) btn.classList.remove('recording');
    if(timer){ timer.classList.remove('show'); timer.textContent='0:00'; }
    _mediaRec.stop();
    _mediaRec = null;
    return;
  }
  // Kayƒ±t yok ‚Üí ba≈ülat
  if(_mediaRec) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    const isDesk = (mode==='desk');
    _mediaRec = new MediaRecorder(stream, {mimeType: MediaRecorder.isTypeSupported('audio/webm')?'audio/webm':'audio/ogg'});
    _recChunks = [];
    _recStartTs = Date.now();
    _recDuration = 0;

    _mediaRec.ondataavailable = ev=>{ if(ev.data.size>0) _recChunks.push(ev.data); };
    _mediaRec.onstop = ()=>{
      stream.getTracks().forEach(t=>t.stop());
      if(_recDuration < 1){ showToast('Kayƒ±t √ßok kƒ±sa'); _recChunks=[]; return; }
      const blob = new Blob(_recChunks, {type:_mediaRec.mimeType});
      const reader = new FileReader();
      reader.onload = ev2=>{
        const bars = Array.from({length:16},()=>Math.floor(3+Math.random()*14));
        const msg = {
          user:_cu, ts:Date.now(), text:'',
          voice:{ data:ev2.target.result, dur:_recDuration, bars }
        };
        dbRef('msgs/'+_cRoom).push(msg).catch(()=>showToast('G√∂nderilemedi'));
      };
      reader.readAsDataURL(blob);
      _recChunks=[];
    };

    _mediaRec.start(100);

    const btn = document.getElementById(isDesk?'deskVoiceRecordBtn':'voiceRecordBtn');
    const timer = document.getElementById(isDesk?'deskRecTimer':'recTimer');
    if(btn) btn.classList.add('recording');
    if(timer) timer.classList.add('show');

    _recInterval = setInterval(()=>{
      _recDuration = Math.floor((Date.now()-_recStartTs)/1000);
      const m=Math.floor(_recDuration/60);
      const s=_recDuration%60;
      if(timer) timer.textContent = m+':'+(s<10?'0':'')+s;
      if(_recDuration>=120) toggleVoiceRecord(mode); // max 2 dakika
    },500);
  }catch(e){
    showToast('Mikrofon eri≈üimi reddedildi');
  }
}

function stopVoiceRecord(){
  if(!_mediaRec||_mediaRec.state==='inactive') return;
  clearInterval(_recInterval);
  const btn = document.getElementById('voiceRecordBtn');
  const timer = document.getElementById('recTimer');
  if(btn){ btn.classList.remove('recording'); }
  if(timer){ timer.classList.remove('show'); timer.textContent='0:00'; }
  _mediaRec.stop();
  _mediaRec = null;
}

function playVoiceMsg(btn, key){
  const audio = document.getElementById('vau_'+key);
  const progEl = document.getElementById('vpr_'+key);
  if(!audio) return;

  if(!audio.paused){
    audio.pause();
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="white"><polygon points="5,3 19,12 5,21"/></svg>';
    return;
  }

  // Diƒüer sesleri durdur
  document.querySelectorAll('audio[id^="vau_"]').forEach(a=>{ if(a!==audio) a.pause(); });

  audio.play();
  btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="white"><rect x="5" y="3" width="4" height="18"/><rect x="15" y="3" width="4" height="18"/></svg>';

  audio.ontimeupdate = ()=>{
    if(progEl) progEl.textContent = fmtDuration(Math.floor(audio.currentTime));
  };
  audio.onended = ()=>{
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="white"><polygon points="5,3 19,12 5,21"/></svg>';
    if(progEl) progEl.textContent = fmtDuration(audio.duration||0);
  };
}

function fmtDuration(sec){
  sec = Math.floor(sec)||0;
  return Math.floor(sec/60)+':'+(sec%60<10?'0':'')+(sec%60);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üîç  SOHBETƒ∞√áƒ∞ ARAMA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _searchMatches = [];
let _searchIdx = 0;

function toggleChatSearch(){
  const bar = document.getElementById('chatSearchBar');
  const inp = document.getElementById('chatSearchInp');
  if(bar.classList.contains('open')){
    bar.classList.remove('open');
    clearSearchHighlights();
    _searchMatches=[];
  } else {
    bar.classList.add('open');
    if(inp) inp.focus();
  }
}

function onChatSearch(){
  const q = (document.getElementById('chatSearchInp').value||'').trim().toLowerCase();
  clearSearchHighlights();
  _searchMatches=[];
  _searchIdx=0;
  if(q.length<2){ document.getElementById('chatSearchCount').textContent=''; return; }

  const box = document.getElementById('chatMsgs');
  if(!box) return;

  // T√ºm metin elementlerini tara
  box.querySelectorAll('.mb-text,.ob').forEach(el=>{
    const orig = el.textContent;
    if(orig.toLowerCase().includes(q)){
      const regex = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');
      el.innerHTML = el.innerHTML.replace(regex, m=>`<mark class="search-highlight">${m}</mark>`);
      el.querySelectorAll('.search-highlight').forEach(m=>_searchMatches.push(m));
    }
  });

  const cnt = document.getElementById('chatSearchCount');
  if(cnt) cnt.textContent = _searchMatches.length ? `1/${_searchMatches.length}` : 'Yok';
  if(_searchMatches.length){ _searchMatches[0].classList.add('current'); _searchMatches[0].scrollIntoView({block:'center'}); }
}

function chatSearchNav(dir){
  if(!_searchMatches.length) return;
  _searchMatches[_searchIdx].classList.remove('current');
  _searchIdx = (_searchIdx+dir+_searchMatches.length)%_searchMatches.length;
  _searchMatches[_searchIdx].classList.add('current');
  _searchMatches[_searchIdx].scrollIntoView({block:'center',behavior:'smooth'});
  const cnt = document.getElementById('chatSearchCount');
  if(cnt) cnt.textContent = `${_searchIdx+1}/${_searchMatches.length}`;
}

function clearSearchHighlights(){
  document.querySelectorAll('.search-highlight').forEach(el=>{
    el.replaceWith(document.createTextNode(el.textContent));
  });
}

function scrollToMsg(key){
  const el = document.querySelector('[data-key="'+key+'"]');
  if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); el.style.background='rgba(91,155,213,.2)'; setTimeout(()=>el.style.background='',1200); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üë§  BIO & SON G√ñR√úLME
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function autoBioResize(el){
  el.style.height='auto';
  el.style.height=Math.min(el.scrollHeight,120)+'px';
  const cnt = document.getElementById('bioCharCount');
  if(cnt) cnt.textContent=(el.value||'').length+'/160';
}

async function saveBio(){
  if(!_cu||!_db) return;
  const bio=(document.getElementById('profBioInp').value||'').slice(0,160);
  await dbRef(wsPath('users/'+_cu+'/bio')).set(bio);
  showToast('‚úÖ Bio kaydedildi');
}

async function loadBio(){
  if(!_cu||!_db) return;
  const snap = await dbRef(wsPath('users/'+_cu+'/bio')).once('value');
  const bio = snap.val()||'';
  const inp = document.getElementById('profBioInp');
  if(inp){ inp.value=bio; autoBioResize(inp); }
}

/* Profil tabƒ± a√ßƒ±lƒ±nca bio y√ºkle */
const _origSwitchProfTab = typeof switchProfTab==='function' ? switchProfTab : null;


/* ‚îÄ‚îÄ Tepki se√ßici ‚îÄ‚îÄ */
const QUICK_REACTS = ['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•','üëè','üéâ','üòç','üíØ'];
function showReactMenu(e, room, key){
  e.stopPropagation();
  const menu = document.getElementById('msgCtxMenu');
  let html = `<div style="padding:6px 8px 4px;font-size:.68rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;">Tepki Se√ß</div>`;
  html += `<div style="display:flex;flex-wrap:wrap;gap:2px;padding:4px 6px;">`;
  QUICK_REACTS.forEach(em => {
    html += `<span onclick="addReaction(event,'${room}','${key}','${em}')" style="font-size:1.3rem;padding:4px 6px;cursor:pointer;border-radius:6px;transition:background .1s;" onmouseover="this.style.background='var(--border)'" onmouseout="this.style.background=''">${em}</span>`;
  });
  html += `</div>`;
  menu.innerHTML = html;
  let x = e.clientX, y = e.clientY;
  if(x + 200 > window.innerWidth) x = window.innerWidth - 210;
  if(y + 120 > window.innerHeight) y = window.innerHeight - 130;
  menu.style.cssText = `position:fixed;left:${x}px;top:${y}px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:4px;z-index:9999;box-shadow:0 8px 24px rgba(0,0,0,.6);min-width:200px;`;
  menu.classList.add('show');
  setTimeout(()=>document.addEventListener('click', _closeCtx, {once:true}), 10);
}

/* ‚îÄ‚îÄ Emoji Tepkiler ‚îÄ‚îÄ */
function addReaction(e, room, key, emoji){
  e.stopPropagation();
  document.getElementById('msgCtxMenu').classList.remove('show');
  if(!_cu) return;
  const ref = dbRef('msgs/'+room+'/'+key+'/reactions/'+emoji+'/'+_cu);
  ref.once('value').then(snap=>{
    if(snap.exists()) ref.remove();
    else ref.set(true);
  });
}
function buildReactionsHtml(room, key, reactions){
  if(!reactions) return '';
  let html = '<div class="msg-reactions">';
  Object.entries(reactions).forEach(([emoji, users])=>{
    const count = Object.keys(users).length;
    if(!count) return;
    const mine = _cu && users[_cu] ? 'mine' : '';
    html += `<div class="react-pill ${mine}" onclick="addReaction(event,'${room}','${key}','${emoji}')"><span>${emoji}</span><span class="react-count">${count}</span></div>`;
  });
  html += '</div>';
  return html;
}

/* ‚îÄ‚îÄ Mesaj D√ºzenleme ‚îÄ‚îÄ */
function startEditMsg(room, key){
  document.getElementById('msgCtxMenu').classList.remove('show');
  const msgEl = document.querySelector(`.mb[data-key="${key}"]`);
  if(!msgEl) return;
  const bodyEl = msgEl.querySelector('.mb-body');
  const textEl = bodyEl.querySelector('.ob, .mb-text');
  if(!textEl) return;
  const origText = textEl.innerText.trim();
  const editId = 'edit_'+key;
  textEl.style.display='none';
  const wrap = document.createElement('div');
  wrap.className='msg-edit-wrap';
  wrap.id=editId;
  wrap.innerHTML=`<textarea class="msg-edit-inp" rows="2">${origText}</textarea><div class="msg-edit-btns"><button class="msg-edit-ok" onclick="saveEditMsg('${room}','${key}','${editId}')">Kaydet</button><button class="msg-edit-cancel" onclick="cancelEditMsg('${editId}')">ƒ∞ptal</button></div>`;
  textEl.after(wrap);
  wrap.querySelector('textarea').focus();
}
function saveEditMsg(room, key, editId){
  const wrap = document.getElementById(editId);
  if(!wrap) return;
  const newText = wrap.querySelector('textarea').value.trim();
  if(!newText){showToast('Bo≈ü mesaj kaydedilemez');return;}
  dbRef('msgs/'+room+'/'+key).update({text:newText,edited:true}).then(()=>{
    cancelEditMsg(editId);
  }).catch(()=>showToast('D√ºzenlenemedi'));
}
function cancelEditMsg(editId){
  const wrap = document.getElementById(editId);
  if(!wrap) return;
  const msgEl = wrap.closest('.mb');
  const textEl = msgEl.querySelector('.ob, .mb-text');
  if(textEl) textEl.style.display='';
  wrap.remove();
}

/* ‚îÄ‚îÄ Mesaj Sabitleme ‚îÄ‚îÄ */
function pinMsg(room, key){
  document.getElementById('msgCtxMenu').classList.remove('show');
  dbRef('msgs/'+room+'/'+key).once('value').then(snap=>{
    const msg = snap.val();
    if(!msg) return;
    dbRef('pinned/'+room).set({key, text:msg.text||'', user:msg.user, ts:msg.ts});
    showToast('üìå Mesaj sabitlendi');
  });
}
function unpinMsg(){
  const room = _cRoom || _deskRoom;
  if(!room) return;
  dbRef('pinned/'+room).remove();
}
function listenPinBar(room){
  dbRef('pinned/'+room).on('value', snap=>{
    const data = snap.val();
    const text = data && data.text ? (data.user?data.user+': ':'')+data.text : null;
    // Mobile pinBar
    const bar = document.getElementById('pinBar');
    if(bar){
      if(text){ bar.classList.add('show'); document.getElementById('pinBarText').textContent=text; }
      else bar.classList.remove('show');
    }
    // Desktop pinBar
    const dbar = document.getElementById('deskPinBar');
    if(dbar){
      if(text){ dbar.style.display='flex'; document.getElementById('deskPinBarText').textContent=text; }
      else dbar.style.display='none';
    }
  });
}

/* ‚îÄ‚îÄ Send ‚îÄ‚îÄ */
// Rate limiting i√ßin son g√∂nderim zamanƒ±
let _lastMsgTs = 0;
let _msgCount = 0;
let _msgCountReset = 0;
const MSG_RATE_MS = 1200; // mesajlar arasƒ± min s√ºre (ms)
const MSG_BURST_LIMIT = 8; // 10 saniyede max mesaj
const MSG_BURST_WINDOW = 10000;

function sendMsg(){
  if(!checkRateLimit('sendMsg', 15)){
    showToast('‚ö†Ô∏è √áok hƒ±zlƒ± mesaj g√∂nderiyorsunuz.');
    return;
  }
  const inp=document.getElementById('msgInp');const t=inp.value.trim();
  if(!t||!_cRoom||!_cu)return;
  // Slash bot komutu kontrol√º
  if(t.startsWith('/') && typeof checkBotCommand==='function' && checkBotCommand(t)){
    inp.value='';if(inp._autoResize)inp._autoResize();else{inp.style.height='';} return;
  }
  const box=document.getElementById('slashSuggestBox');if(box) box.style.display='none';
  // ‚îÄ‚îÄ Susturma kontrol√º ‚îÄ‚îÄ
  const muteUntil = _userMutedUntil || 0;
  if(muteUntil > Date.now()){
    const rem = Math.ceil((muteUntil - Date.now()) / 60000);
    showToast('üîá Susturuldunuz. ' + rem + ' dk kaldƒ±.'); return;
  }

  // ‚îÄ‚îÄ Rate limiting ‚îÄ‚îÄ
  const now = Date.now();
  if(now - _msgCountReset > MSG_BURST_WINDOW){ _msgCount=0; _msgCountReset=now; }
  if(now - _lastMsgTs < MSG_RATE_MS){ showToast('‚è± √áok hƒ±zlƒ± g√∂nderiyorsunuz.'); return; }
  if(_msgCount >= MSG_BURST_LIMIT){ showToast('‚è± √áok fazla mesaj g√∂nderildi, biraz bekleyin.'); return; }
  _lastMsgTs = now;
  _msgCount++;

  // ‚îÄ‚îÄ Mesaj uzunluk sƒ±nƒ±rƒ± ‚îÄ‚îÄ
  if(t.length > 2000){ showToast('Mesaj √ßok uzun (max 2000 karakter).'); return; }

  // ‚îÄ‚îÄ Yasaklƒ± kelime filtresi ‚îÄ‚îÄ
  let filtered = t;
  if(_bannedWordsList && _bannedWordsList.length){
    _bannedWordsList.forEach(w=>{
      if(!w) return;
      const re = new RegExp(w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');
      filtered = filtered.replace(re, '***');
    });
  }

  const msg={user:_cu,text:filtered,ts:now};
  if(inp.dataset.replyKey){
    msg.replyTo={key:inp.dataset.replyKey,user:inp.dataset.replyUser||'',text:(inp.dataset.replyText||'').slice(0,80)};
  }
  inp.value='';autoResize(inp);closeEmoji();removeReplyPreview();
  clearTypingFlag();
  dbRef('msgs/'+_cRoom).push(msg).catch(()=>showToast('G√∂nderilemedi'));
}

// Global deƒüi≈ükenler: mute & banned words
let _userMutedUntil = 0;
let _bannedWordsList = [];

// Giri≈ü ba≈üarƒ±lƒ± olunca kullanƒ±cƒ± verilerini y√ºkle
function loadUserSecurityData(){
  if(!_cu) return;
  // Mute durumu kontrol et
  dbRef('users/'+_cu+'/mutedUntil').once('value').then(s=>{
    _userMutedUntil = s.val() || 0;
  });
  // Yasaklƒ± kelimeleri y√ºkle
  dbRef('settings/bannedWords').once('value').then(s=>{
    const raw = s.val() || '';
    _bannedWordsList = raw.split(',').map(w=>w.trim()).filter(Boolean);
  });
  // Canlƒ± mute izleme
  dbRef('users/'+_cu+'/mutedUntil').on('value', s=>{
    _userMutedUntil = s.val() || 0;
  });
}
function onMsgKey(e){
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();return;}
  setTypingFlag();
}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}

/* ‚îÄ‚îÄ File ‚îÄ‚îÄ */
function pickFile(){
  // On desktop, also set the upload handler to use deskRoom
  document.getElementById('fileInput').click();
}
function handleFile(inp){
  const file=inp.files[0];inp.value='';if(!file)return;
  if(file.size>5*1024*1024){showToast('Max 5MB');return;}
  showToast('Y√ºkleniyor...');
  const r=new FileReader();
  r.onload=e=>{dbRef('msgs/'+_cRoom).push({user:_cu,text:'',ts:Date.now(),file:{name:file.name,size:file.size,type:file.type,data:e.target.result}}).catch(()=>showToast('G√∂nderilemedi'));};
  r.readAsDataURL(file);
}

/* ‚îÄ‚îÄ Emoji ‚îÄ‚îÄ */
const EMOJIS={
'üòÄ Y√ºzler & ƒ∞nsanlar':['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üôÉ','ü´†','üòâ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','üòö','üòô','ü•≤','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü´∂','ü§≠','ü´¢','ü´£','ü§´','ü§î','ü´°','ü§ê','ü§®','üòê','üòë','üò∂','ü´•','üòè','üòí','üôÑ','üò¨','ü§•','ü´®','üòå','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü§ß','ü•µ','ü•∂','ü•¥','üòµ','ü§Ø','ü§†','ü•∏','üòé','üßê','üòï','ü´§','üòü','üôÅ','‚òπÔ∏è','üòÆ','üòØ','üò≤','üò≥','ü•∫','ü•π','üò¶','üòß','üò®','üò∞','üò•','üò¢','üò≠','üò±','üòñ','üò£','üòû','üòì','üò©','üò´','ü•±','üò§','üò°','üò†','ü§¨','üòà','üëø','üíÄ','‚ò†Ô∏è','üí©','ü§°','üëπ','üë∫','üëª','üëΩ','üëæ','ü§ñ'],
'üëã El & Beden':['üëã','ü§ö','üñêÔ∏è','‚úã','üññ','ü´±','ü´≤','ü´≥','ü´¥','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü´∞','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','ü´µ','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','ü´∂','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','üß†','ü´Ä','ü´Å','ü¶∑','ü¶¥','üëÄ','üëÅÔ∏è','üëÖ','üëÑ','ü´¶'],
'üë®‚Äçüë©‚Äçüëß ƒ∞nsanlar':['üë∂','üßí','üë¶','üëß','üßë','üë±','üë®','üßî','üë©','üßì','üë¥','üëµ','üôç','üôé','üôÖ','üôÜ','üíÅ','üôã','üßè','üôá','ü§¶','ü§∑','üëÆ','üïµÔ∏è','üíÇ','üßë‚Äç‚öïÔ∏è','üë®‚Äç‚öïÔ∏è','üë©‚Äç‚öïÔ∏è','üßë‚Äçüåæ','üë®‚Äçüåæ','üë©‚Äçüåæ','üßë‚Äçüç≥','üë®‚Äçüç≥','üë©‚Äçüç≥','üßë‚Äçüéì','üë®‚Äçüéì','üë©‚Äçüéì','üßë‚Äçüé§','üë®‚Äçüé§','üë©‚Äçüé§','üßë‚Äçüè´','üë®‚Äçüè´','üë©‚Äçüè´','üßë‚Äçüè≠','üë®‚Äçüè≠','üë©‚Äçüè≠','üßë‚Äçüíª','üë®‚Äçüíª','üë©‚Äçüíª','üßë‚Äçüíº','üë®‚Äçüíº','üë©‚Äçüíº','üßë‚Äçüîß','üë®‚Äçüîß','üë©‚Äçüîß','üßë‚Äçüî¨','üë®‚Äçüî¨','üë©‚Äçüî¨','üßë‚Äçüé®','üë®‚Äçüé®','üë©‚Äçüé®','üßë‚Äç‚úàÔ∏è','üë®‚Äç‚úàÔ∏è','üë©‚Äç‚úàÔ∏è','üßë‚ÄçüöÄ','üë®‚ÄçüöÄ','üë©‚ÄçüöÄ','üßë‚Äçüöí','üë®‚Äçüöí','üë©‚Äçüöí','üë∞','ü§µ','ü´Ö','ü§¥','üë∏','ü¶∏','ü¶π','üßô','üßù','üßõ','üßü','üßû','üßú','üßö','ü™Ñ','üëº','ü§∂','üéÖ','üßë‚Äçü§ù‚Äçüßë','üë´','üë¨','üë≠','üíè','üíë','üë®‚Äçüë©‚Äçüë¶','üë®‚Äçüë©‚Äçüëß','üë®‚Äçüë©‚Äçüëß‚Äçüë¶'],
'‚ù§Ô∏è Kalpler & Duygular':['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','‚ù§Ô∏è‚Äçü©π','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚ù£Ô∏è','üíå','üíã','ü´¶','üòª','üíØ','üí¢','üí•','üí´','üí¶','üí®','üï≥Ô∏è','üí¨','üí≠','üí§'],
'üê∂ Hayvanlar & Doƒüa':['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üêª‚Äç‚ùÑÔ∏è','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üôà','üôâ','üôä','üêî','üêß','üê¶','üê§','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','ü™±','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ü','ü¶ó','üï∑Ô∏è','ü¶Ç','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶û','ü¶Ä','üê°','üê†','üêü','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ','ü¶ì','ü¶ç','ü¶ß','ü¶£','üêò','ü¶õ','ü¶è','üê™','üê´','ü¶í','ü¶ò','ü¶¨','üêÉ','üêÇ','üêÑ','üêé','üêñ','üêè','üêë','ü¶ô','üêê','ü¶å','üêï','üê©','ü¶Æ','üêï‚Äçü¶∫','üêà','üêà‚Äç‚¨õ','ü™∂','üêì','ü¶É','ü¶§','ü¶ö','ü¶ú','ü¶¢','üïäÔ∏è','üêá','ü¶ù','ü¶®','ü¶°','ü¶¶','ü¶•','üêÅ','üêÄ','üêøÔ∏è','ü¶î','üåµ','üéÑ','üå≤','üå≥','üå¥','ü™µ','üå±','üåø','‚òòÔ∏è','üçÄ','üéç','ü™¥','üéã','üçÉ','üçÇ','üçÅ','üçÑ','ü™∏','üåæ','üíê','üå∑','üåπ','ü•Ä','üå∫','üå∏','üåº','üåª','üåû','üåù','üåõ','üåú','üåö','üåï','üåñ','üåó','üåò','üåë','üåí','üåì','üåî','üåô','üåü','‚≠ê','üå†','üåå','‚òÄÔ∏è','‚õÖ','üå§Ô∏è','üå•Ô∏è','‚òÅÔ∏è','üå¶Ô∏è','üåßÔ∏è','‚õàÔ∏è','üå©Ô∏è','üå®Ô∏è','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑ','üå¨Ô∏è','üí®','üåÄ','üåà','üåÇ','‚òÇÔ∏è','‚òî','‚õ±Ô∏è','‚ö°','üî•','üíß','üåä'],
'üçé Yiyecek & ƒ∞√ßecek':['üçé','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü´í','ü•¶','ü•¨','ü•í','üå∂Ô∏è','ü´ë','üßÑ','üßÖ','ü•î','üç†','ü´ö','ü•ê','ü•Ø','üçû','ü•ñ','ü•®','üßÄ','ü•ö','üç≥','üßà','ü•û','üßá','ü•ì','ü•©','üçó','üçñ','ü¶¥','üå≠','üçî','üçü','üçï','ü´ì','üåÆ','üåØ','ü´î','ü•ô','üßÜ','ü•ö','üçú','üçù','üçõ','üç£','üç±','ü•ü','ü¶™','üç§','üçô','üçö','üçò','üç•','ü•Æ','üç°','üßÅ','üç∞','üéÇ','üçÆ','üç≠','üç¨','üç´','üçø','üç©','üç™','üå∞','ü•ú','üçØ','üßÉ','ü•§','üßã','üçµ','‚òï','ü´ñ','üç∂','üç∫','üçª','ü•Ç','üç∑','ü´ó','ü•É','üç∏','üçπ','üßâ','üçæ'],
'‚öΩ Spor & Aktivite':['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','ü™Ä','üèì','üè∏','üèí','ü•ç','üèë','ü•Ö','‚õ≥','ü™Å','üèπ','üé£','ü§ø','ü•ä','ü•ã','üéΩ','üõπ','üõº','üõ∑','‚õ∏Ô∏è','ü•å','üéø','‚õ∑Ô∏è','üèÇ','ü™Ç','üèãÔ∏è','ü§º','ü§∏','‚õπÔ∏è','ü§∫','ü§æ','üèåÔ∏è','üèá','üßò','üèÑ','üèä','ü§Ω','üö£','üßó','üöµ','üö¥','üèÜ','ü•á','ü•à','ü•â','üèÖ','üéñÔ∏è','üéóÔ∏è','üé´','üéüÔ∏è','üé™','ü§π','üé≠','ü©∞','üé®','üé¨','üé§','üéß','üéº','üéµ','üé∂','üé∑','ü™ó','üé∏','üéπ','üé∫','üéª','ü™ï','ü•Å','ü™ò'],
'üöó Ta≈üƒ±tlar & Yerler':['üöó','üöï','üöô','üöå','üöé','üèéÔ∏è','üöì','üöë','üöí','üöê','üõª','üöö','üöõ','üöú','üèçÔ∏è','üõµ','üõ∫','üö≤','üõ¥','üõπ','üõº','üõ∫','üöè','üõ£Ô∏è','üõ§Ô∏è','üõû','‚õΩ','üö®','üö•','üö¶','üõë','üöß','‚öì','üõü','‚õµ','üö§','üõ•Ô∏è','üõ≥Ô∏è','‚õ¥Ô∏è','üö¢','‚úàÔ∏è','üõ©Ô∏è','üõ´','üõ¨','ü™Ç','üí∫','üöÅ','üöü','üö†','üö°','üõ∞Ô∏è','üöÄ','üõ∏','ü™ê','üåç','üåé','üåè','üó∫Ô∏è','üß≠','üèîÔ∏è','‚õ∞Ô∏è','üåã','üóª','üèïÔ∏è','üèñÔ∏è','üèúÔ∏è','üèùÔ∏è','üèûÔ∏è','üèüÔ∏è','üèõÔ∏è','üèóÔ∏è','üß±','üèòÔ∏è','üèöÔ∏è','üè†','üè°','üè¢','üè£','üè§','üè•','üè¶','üè®','üè©','üè™','üè´','üè¨','üè≠','üèØ','üè∞','üíí','üóº','üóΩ','‚õ™','üïå','üõï','üïç','‚õ©Ô∏è','üïã','‚õ≤','‚õ∫','üåÅ','üåÉ','üèôÔ∏è','üåÑ','üåÖ','üåÜ','üåá','üåâ','üóæ','üéë','üèûÔ∏è'],
'üí° Objeler & Semboller':['üí°','üî¶','üïØÔ∏è','ü™î','üß±','üíé','üîÆ','ü™Ñ','üßø','üìø','üíà','üî≠','üî¨','ü©∫','ü©ª','ü©π','üíä','ü©∫','üå°Ô∏è','üõÅ','üöø','ü™†','üß¥','üß∑','üßπ','üß∫','üßª','ü™£','üßº','ü´ß','üßΩ','üõí','üö™','ü™ë','üöΩ','ü™§','üß∏','ü™Ü','üñºÔ∏è','üßµ','ü™°','üß∂','üëì','üï∂Ô∏è','ü•Ω','üß£','üß§','üß•','üëò','üëó','ü•ª','ü©±','ü©≤','ü©≥','üëô','üëö','üëõ','üëú','üëù','üéí','üß≥','üëí','üé©','üß¢','‚õëÔ∏è','üì±','üíª','‚å®Ô∏è','üñ•Ô∏è','üñ®Ô∏è','üñ±Ô∏è','üñ≤Ô∏è','üíæ','üíø','üìÄ','üì∑','üì∏','üìπ','üé•','üìΩÔ∏è','üì∫','üìª','üì°','üîã','üîå','üí°','üî¶','üïØÔ∏è','ü™ô','üí¥','üíµ','üí∂','üí∑','üí∏','üí≥','üßæ','üìà','üìâ','üìä','üìã','üìå','üìç','üìé','üñáÔ∏è','üìè','üìê','‚úÇÔ∏è','üóÉÔ∏è','üóëÔ∏è','üóÑÔ∏è','üîí','üîì','üîë','üóùÔ∏è','üî®','ü™ì','‚õèÔ∏è','‚öíÔ∏è','üõ†Ô∏è','üó°Ô∏è','‚öîÔ∏è','üõ°Ô∏è','üîß','üî©','‚öôÔ∏è','üóúÔ∏è','‚öñÔ∏è','ü¶Ø','üîó','‚õìÔ∏è','ü™ù','üß≤','üî´','ü™É','üèπ','üõ°Ô∏è','ü™ö','üîÆ','üíä','ü©π','ü©∫'],
'#Ô∏è‚É£ Semboller':['‚ù§Ô∏è','üíØ','‚úÖ','‚ùå','‚≠ï','üî¥','üü†','üü°','üü¢','üîµ','üü£','‚ö´','‚ö™','üü§','üî∫','üîª','üî∑','üî∂','üîπ','üî∏','‚ñ™Ô∏è','‚ñ´Ô∏è','‚óæ','‚óΩ','‚óºÔ∏è','‚óªÔ∏è','üî≤','üî≥','‚¨õ','‚¨ú','üè≥Ô∏è','üè¥','üö©','üéå','üèÅ','üöÄ','‚ö°','üî•','üí•','‚ùÑÔ∏è','‚ú®','üåä','üí®','üåÄ','üåà','‚öúÔ∏è','üî±','üìõ','üî∞','‚≠ï','‚úÖ','‚òëÔ∏è','‚úîÔ∏è','‚ùé','‚ûï','‚ûñ','‚ûó','‚úñÔ∏è','üü∞','‚ôæÔ∏è','üí≤','üí±','„ÄΩÔ∏è','‚ö†Ô∏è','üö∏','üîû','üìµ','üö´','‚ùó','‚ùï','‚ùì','‚ùî','‚ÄºÔ∏è','‚ÅâÔ∏è','üîÖ','üîÜ','üì∂','üì≥','üì¥','üìµ','üì∂','üîá','üîà','üîâ','üîä','üì¢','üì£','üîî','üîï','üéµ','üé∂','‚öóÔ∏è','üî≠','üî¨','ü©∫','‚öïÔ∏è','üõê','‚òØÔ∏è','‚ú°Ô∏è','üîØ','üïé','‚ò™Ô∏è','‚òÆÔ∏è','‚úùÔ∏è','üõï','‚õ™','üïå','üïç']
};
function toggleEmoji(){
  if(IS_DESKTOP()){
    // Desktop: show floating emoji picker near input
    let el=document.getElementById('deskEmojiPicker');
    if(!el){
      el=document.createElement('div');
      el.id='deskEmojiPicker';
      el.style.cssText='position:absolute;bottom:70px;left:20px;right:20px;overflow:hidden;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:0;z-index:50;box-shadow:0 8px 32px rgba(0,0,0,.8);';
      document.getElementById('deskInputArea').style.position='relative';
      document.getElementById('deskInputArea').appendChild(el);
    }
    const showing=el.style.display!=='none'&&el.innerHTML.trim();
    if(showing){el.style.display='none';return;}
    el.style.display='block';
    if(!el.innerHTML.trim())buildEmojis(true);
    // Click outside to close
    setTimeout(()=>{
      function _emojiOutside(e){
        if(!el.contains(e.target)&&!e.target.closest('.dsk-inp-btn')){
          el.style.display='none';
          document.removeEventListener('click',_emojiOutside,true);
        }
      }
      document.addEventListener('click',_emojiOutside,true);
    },0);
    return;
  }
  const el=document.getElementById('emojiPicker');
  el.classList.toggle('open');
  if(el.classList.contains('open')&&!el.innerHTML.trim())buildEmojis(false);
}
function closeEmoji(){
  document.getElementById('emojiPicker').classList.remove('open');
  const de=document.getElementById('deskEmojiPicker');
  if(de)de.style.display='none';
}
function buildEmojis(isDesk){
  const target=isDesk?document.getElementById('deskEmojiPicker'):document.getElementById('emojiPicker');
  if(!target) return;
  let h='<div class="picker-tabs">';
  h+='<div class="picker-tab active" id="'+(isDesk?'desk':'mob')+'TabEmoji" onclick="switchPickerTab(\'emoji\','+(isDesk?'true':'false')+')">üòä Emoji</div>';
  h+='<div class="picker-tab" id="'+(isDesk?'desk':'mob')+'TabGif" onclick="switchPickerTab(\'gif\','+(isDesk?'true':'false')+')">üé¨ GIFs</div>';
  h+='</div>';
  h+='<div id="'+(isDesk?'desk':'mob')+'EmojiBody" class="picker-body">';
  // Custom emojiler b√∂l√ºm√º
  h+='<div id="'+(isDesk?'desk':'mob')+'CustomEmojiSection">';
  h+='<div class="ec" style="display:flex;align-items:center;justify-content:space-between;">‚ú® √ñZEL EMOJƒ∞LER<button class="add-emoji-btn" style="width:auto;padding:3px 10px;margin:0;font-size:.75rem;" onclick="openCeModal()">+ Emoji Ekle</button></div>';
  h+='<div class="custom-emoji-grid" id="'+(isDesk?'desk':'mob')+'CustomEmojiGrid"><div style="color:var(--muted);font-size:.78rem;">Hen√ºz √∂zel emoji yok.</div></div>';
  h+='</div>';
  h+='<div style="height:1px;background:var(--border);margin:8px 0;"></div>';
  // Standart emoji kategorileri
  h+='<div style="display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;margin-bottom:6px;border-bottom:1px solid var(--border);-webkit-overflow-scrolling:touch;">';
  const catIcons=Object.keys(EMOJIS).map(k=>k.split(' ')[0]);
  catIcons.forEach((ic,i)=>{h+=`<div onclick="scrollEmojiCat(${i})" style="font-size:1.2rem;padding:4px 6px;border-radius:6px;cursor:pointer;flex-shrink:0;" title="${Object.keys(EMOJIS)[i]}">${ic}</div>`;});
  h+='</div><div id="emojiGrid" class="eg">';
  Object.entries(EMOJIS).forEach(([cat,emojis],i)=>{
    h+=`<div class="ec" id="ecat-${i}">${cat}</div>`;
    emojis.forEach(e=>{h+=`<div class="eb" onclick="insertEmoji('${e}')">${e}</div>`;});
  });
  h+='</div></div>';
  h+='<div id="'+(isDesk?'desk':'mob')+'GifBody" style="display:none;flex-direction:column;overflow:hidden;height:274px;">';
  h+='<div class="gif-search-wrap"><input class="gif-search-inp" placeholder="Search GIFs on Giphy..." id="'+(isDesk?'desk':'mob')+'GifSearch" oninput="gifSearchDebounce(this.value,'+(isDesk?'true':'false')+')" /></div>';
  h+='<div style="overflow-y:scroll;-webkit-overflow-scrolling:touch;padding:6px 10px 10px;height:224px;box-sizing:border-box;"><div class="gif-grid" id="'+(isDesk?'desk':'mob')+'GifGrid"><div class="gif-loading">Y√ºkleniyor...</div></div></div>';
  h+='</div>';
  target.innerHTML=h;
  loadTrendingGifs(isDesk);
  loadCustomEmojis(isDesk);
}

function switchPickerTab(tab, isDesk){
  const pfx = isDesk?'desk':'mob';
  const emojiTab = document.getElementById(pfx+'TabEmoji');
  const gifTab = document.getElementById(pfx+'TabGif');
  const emojiBody = document.getElementById(pfx+'EmojiBody');
  const gifBody = document.getElementById(pfx+'GifBody');
  if(!emojiTab||!gifTab) return;
  if(tab==='emoji'){
    emojiTab.classList.add('active'); gifTab.classList.remove('active');
    emojiBody.style.display=''; gifBody.style.display='none';
  } else {
    gifTab.classList.add('active'); emojiTab.classList.remove('active');
    emojiBody.style.display='none'; gifBody.style.display='block';
  }
}

// GIF API key ‚Äî developers.giphy.com adresinden √ºcretsiz alƒ±nabilir
const GIPHY_KEY = '';
let _gifDebTimer = null;
let _gifApiReady = true;

function gifSearchDebounce(q, isDesk){
  clearTimeout(_gifDebTimer);
  _gifDebTimer = setTimeout(()=>{
    if(q.trim()) searchGifs(q.trim(), isDesk);
    else loadTrendingGifs(isDesk);
  }, 400);
}

async function loadTrendingGifs(isDesk){
  const grid = document.getElementById((isDesk?'desk':'mob')+'GifGrid');
  if(!grid) return;
  if(!_gifApiReady){ showGifKeyPrompt(grid, isDesk); return; }
  grid.innerHTML = '<div class="gif-loading">Y√ºkleniyor...</div>';
  try {
    const r = await fetch(`https://api.giphy.com/v1/gifs/trending?api_key=${GIPHY_KEY}&limit=21&rating=g`);
    const d = await r.json();
    if(d.meta?.status !== 200) throw new Error(d.meta?.msg||'API error');
    renderGifs(d.data||[], grid, isDesk);
  } catch(e){ grid.innerHTML = '<div class="gif-loading">Y√ºklenemedi: '+e.message+'</div>'; }
}

async function searchGifs(q, isDesk){
  const grid = document.getElementById((isDesk?'desk':'mob')+'GifGrid');
  if(!grid) return;
  if(!_gifApiReady){ showGifKeyPrompt(grid, isDesk); return; }
  grid.innerHTML = '<div class="gif-loading">Aranƒ±yor...</div>';
  try {
    const r = await fetch(`https://api.giphy.com/v1/gifs/search?api_key=${GIPHY_KEY}&q=${encodeURIComponent(q)}&limit=21&rating=g&lang=tr`);
    const d = await r.json();
    if(d.meta?.status !== 200) throw new Error(d.meta?.msg||'API error');
    renderGifs(d.data||[], grid, isDesk);
  } catch(e){ grid.innerHTML = '<div class="gif-loading">Hata: '+e.message+'</div>'; }
}

function renderGifs(results, grid, isDesk){
  if(!results.length){ grid.innerHTML='<div class="gif-loading">Sonu√ß bulunamadƒ±.</div>'; return; }
  grid.innerHTML = results.map(g=>{
    const preview = g.images?.fixed_height_small?.url || g.images?.downsized_small?.url || g.images?.downsized?.url || '';
    const full = g.images?.original?.url || preview;
    const safeUrl = full.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    return `<div class="gif-item" onclick="sendGifMsg('${safeUrl}',${isDesk})"><img src="${preview}" loading="lazy" /></div>`;
  }).join('');
}

function showGifKeyPrompt(grid, isDesk){
  grid.innerHTML = `<div style="padding:16px;text-align:center;color:var(--muted);font-size:.82rem;line-height:1.6;">
    <div style="font-size:1.5rem;margin-bottom:8px;">üîë</div>
    <div style="color:var(--text-hi);font-weight:700;margin-bottom:6px;">Giphy API Key Gerekli</div>
    <div style="margin-bottom:10px;"><a href="https://developers.giphy.com" target="_blank" style="color:var(--accent);">developers.giphy.com</a> adresinden √ºcretsiz key al, a≈üaƒüƒ±ya yapƒ±≈ütƒ±r:</div>
    <input id="gifKeyInput" placeholder="API key..." style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text-hi);padding:7px 10px;font-size:.82rem;outline:none;box-sizing:border-box;margin-bottom:8px;" />
    <button onclick="saveGifKey(${isDesk})" style="background:var(--accent);color:#fff;border:none;border-radius:7px;padding:7px 18px;cursor:pointer;font-size:.83rem;font-weight:700;">Kaydet ve Y√ºkle</button>
  </div>`;
  // Daha √∂nce kaydedilmi≈ü key varsa doldur
  const saved = localStorage.getItem('sohbet_giphy_key');
  if(saved){ document.getElementById('gifKeyInput').value = saved; }
}

function saveGifKey(isDesk){
  const inp = document.getElementById('gifKeyInput');
  const key = inp ? inp.value.trim() : '';
  if(!key){ showToast('Key bo≈ü olamaz'); return; }
  localStorage.setItem('sohbet_giphy_key', key);
  // Global key'i g√ºncelle
  window._gifApiKey = key;
  window._gifApiReady = true;
  // Monkey-patch
  window.GIPHY_KEY_LIVE = key;
  loadTrendingGifsWithKey(isDesk, key);
}

async function loadTrendingGifsWithKey(isDesk, key){
  const grid = document.getElementById((isDesk?'desk':'mob')+'GifGrid');
  if(!grid) return;
  grid.innerHTML = '<div class="gif-loading">Y√ºkleniyor...</div>';
  try {
    const r = await fetch(`https://api.giphy.com/v1/gifs/trending?api_key=${key}&limit=21&rating=g`);
    const d = await r.json();
    if(d.meta?.status !== 200) throw new Error(d.meta?.msg||'Ge√ßersiz key');
    // Key √ßalƒ±≈üƒ±yor, global'e kaydet
    Object.defineProperty(window, 'GIPHY_KEY', {value: key, writable: true, configurable: true});
    _gifApiReady = true;
    renderGifs(d.data||[], grid, isDesk);
  } catch(e){ grid.innerHTML = '<div class="gif-loading" style="color:#e88;">Hata: '+e.message+'</div>'; }
}

// Sayfa a√ßƒ±lƒ±rken localStorage'daki key'i y√ºkle
(function initGifKey(){
  const saved = localStorage.getItem('sohbet_giphy_key');
  if(saved){
    try{ Object.defineProperty(window,'GIPHY_KEY',{value:saved,writable:true,configurable:true}); } catch(e){}
    _gifApiReady = true;
  }
})();

function sendGifMsg(url, isDesk){
  closeEmoji();
  const room = isDesk ? _deskRoom : _cRoom;
  if(!room||!_cu) return;
  const msgData = { user:_cu, ts:Date.now(), file:{ type:'image/gif', data:url, name:'gif' } };
  dbRef('msgs/'+room).push(msgData).catch(()=>showToast('G√∂nderilemedi'));
}
function scrollEmojiCat(i){const el=document.getElementById('ecat-'+i);if(el)el.scrollIntoView({block:'nearest'});}

/* ‚ïê‚ïê Custom Emoji Sistemi ‚ïê‚ïê */
let _ceFileData = null;
let _ceFileName = null;

function openCeModal(){
  _ceFileData = null;
  document.getElementById('ceNameInp').value = '';
  document.getElementById('cePreview').innerHTML = '<span style="color:var(--muted);font-size:.7rem;text-align:center;">√ñnizleme</span>';
  document.getElementById('ceFileInput').value = '';
  document.getElementById('ceModal').classList.add('open');
}
function closeCeModal(){
  document.getElementById('ceModal').classList.remove('open');
}
function cePrevFile(inp){
  const file = inp.files[0];
  if(!file) return;
  _ceFileName = file.name;
  const reader = new FileReader();
  reader.onload = function(e){
    _ceFileData = e.target.result;
    document.getElementById('cePreview').innerHTML = `<img src="${_ceFileData}" />`;
    // ƒ∞sim alanƒ±nƒ± otomatik doldur (uzantƒ±sƒ±z)
    const nameInp = document.getElementById('ceNameInp');
    if(!nameInp.value){
      nameInp.value = file.name.replace(/\.[^.]+$/, '').replace(/[^a-zA-Z0-9_-]/g, '_').toLowerCase().slice(0,32);
    }
  };
  reader.readAsDataURL(file);
}
async function saveCustomEmoji(){
  const name = document.getElementById('ceNameInp').value.trim().replace(/[^a-zA-Z0-9_-]/g,'_').toLowerCase();
  if(!name){ showToast('Emoji adƒ± girin'); return; }
  if(!_ceFileData){ showToast('Bir dosya se√ßin'); return; }
  if(!_cu){ showToast('Giri≈ü yapmalƒ±sƒ±nƒ±z'); return; }
  // Firebase'e kaydet
  const key = name + '_' + Date.now();
  const ceData = { name, url: _ceFileData, addedBy: _cu, ts: Date.now() };
  try {
    await dbRef('customEmojis/' + key).set(ceData);
    showToast('‚ú® Emoji eklendi: :' + name + ':');
    closeCeModal();
    // Picker'ƒ± yenile
    loadCustomEmojis(IS_DESKTOP());
  } catch(e) {
    showToast('Kaydedilemedi: ' + e.message);
  }
}
async function loadCustomEmojis(isDesk){
  const pfx = isDesk ? 'desk' : 'mob';
  const grid = document.getElementById(pfx + 'CustomEmojiGrid');
  if(!grid) return;
  try {
    const snap = await dbRef('customEmojis').once('value');
    const data = snap.val();
    if(!data || !Object.keys(data).length){
      grid.innerHTML = '<div style="color:var(--muted);font-size:.78rem;">Hen√ºz √∂zel emoji yok. + Emoji Ekle butonuna tƒ±kla!</div>';
      return;
    }
    grid.innerHTML = Object.entries(data).map(([key, ce])=>{
      const safeUrl = (ce.url||'').replace(/'/g,"\'");
      const canDelete = ce.addedBy === _cu || _isAdmin;
      return `<div class="custom-emoji-item" title=":${ce.name}:" onclick="insertCustomEmoji('${safeUrl}')">
        <img src="${ce.url}" />
        ${canDelete ? `<div class="ce-delete" onclick="event.stopPropagation();deleteCustomEmoji('${key}')">‚úï</div>` : ''}
      </div>`;
    }).join('');
  } catch(e) {
    grid.innerHTML = '<div style="color:var(--muted);font-size:.78rem;">Y√ºklenemedi.</div>';
  }
}
function insertCustomEmoji(url){
  // √ñzel emoji resim olarak g√∂nder
  closeEmoji();
  const room = IS_DESKTOP() ? _deskRoom : _cRoom;
  if(!room || !_cu) return;
  const msgData = { user: _cu, ts: Date.now(), file: { type: 'image/gif', data: url, name: 'emoji', isEmoji: true } };
  dbRef('msgs/' + room).push(msgData).catch(()=>showToast('G√∂nderilemedi'));
}
async function deleteCustomEmoji(key){
  if(!confirm('Bu emojiyi sil?')) return;
  await dbRef('customEmojis/' + key).remove().catch(()=>showToast('Silinemedi'));
  showToast('Emoji silindi');
  loadCustomEmojis(IS_DESKTOP());
}

function insertEmoji(e){
  const inp=IS_DESKTOP()?document.getElementById('deskInp'):document.getElementById('msgInp');
  if(!inp)return;
  const s=inp.selectionStart,end=inp.selectionEnd;
  inp.value=inp.value.slice(0,s)+e+inp.value.slice(end);
  inp.selectionStart=inp.selectionEnd=s+e.length;
  if(IS_DESKTOP())deskInpResize(inp);else autoResize(inp);
  inp.focus();
  closeEmoji();
}

/* ‚îÄ‚îÄ DM Modal ‚îÄ‚îÄ */
let _allUsers=[];
function openDMModal(){ switchMainTab('msgs'); }
function closeDMModal(){ switchMainTab('home'); }
function filterDMUsers(){const q=document.getElementById('dmSearch').value.toLowerCase();renderDMUsers(_allUsers.filter(u=>u.toLowerCase().includes(q)));}
function renderDMUsers(users){
  const el=document.getElementById('dmUserList');
  if(!users.length){el.innerHTML='<p style="color:var(--muted);padding:10px;font-size:.85rem">Kullanƒ±cƒ± bulunamadƒ±.</p>';return;}
  // Load friends list to show proper button states
  dbRef('friends/'+_cu).once('value').then(snap=>{
    const myFriends=snap.val()||{};
    dbRef('friendRequests/'+_cu).once('value').then(rSnap=>{
      const incoming=rSnap.val()||{};
      // Also check sent requests
      dbRef('friendRequestsSent/'+_cu).once('value').then(sSnap=>{
        const sent=sSnap.val()||{};
        el.innerHTML=users.map(u=>{
          const on=!!_online[u];
          const isFriend=!!myFriends[u];
          const hasSent=!!sent[u];
          const hasIncoming=!!incoming[u];
          let btn='';
          if(isFriend) btn=`<button class="fr-btn msg" onclick="event.stopPropagation();startDM('${u}')">Mesaj</button>`;
          else if(hasSent) btn=`<button class="fr-btn pending" disabled>ƒ∞stek G√∂nderildi</button>`;
          else if(hasIncoming) btn=`<button class="fr-btn accept" onclick="event.stopPropagation();acceptFriendRequest('${u}')">Kabul Et</button>`;
          else btn=`<button class="fr-btn add" onclick="event.stopPropagation();sendFriendRequest('${u}',this)">+ Arkada≈ü Ekle</button>`;
          return `<div class="dm-row"><div class="dm-av" style="background:${strColor(u)}">${initials(u)}<div class="r-dot ${on?'on':'off'}"></div></div><div style="flex:1"><div class="dm-name">${esc(u)}</div><div class="dm-status">${on?'üü¢ √áevrimi√ßi':'√áevrimdƒ±≈üƒ±'}</div></div>${btn}</div>`;
        }).join('');
      });
    });
  });
}
function startDM(other){
  const members=[_cu,other].sort();const id='dm_'+members.join('_');
  closeDMModal();
  dbRef('rooms/'+id).once('value').then(snap=>{
    if(!snap.val()){
      dbRef('rooms/'+id).set({id,name:other,type:'dm',members,ts:Date.now()},()=>{openRoom(id);showCallBtns(true);});
    } else {
      // Unhide if previously hidden by current user
      const room = snap.val();
      if(room.hiddenBy && room.hiddenBy.includes(_cu)){
        const updated = room.hiddenBy.filter(u=>u!==_cu);
        dbRef('rooms/'+id+'/hiddenBy').set(updated.length?updated:null);
      }
      openRoom(id);showCallBtns(true);
    }
  });
}
function showCallBtns(show){
  const canScreen = !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia);
  document.getElementById('callAudioBtn').style.display=show?'flex':'none';
  document.getElementById('callVideoBtn').style.display=show?'flex':'none';
  document.getElementById('callScreenBtn').style.display=(show&&canScreen)?'flex':'none';
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üë• ARKADA≈û Sƒ∞STEMƒ∞
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _friends={}, _friendReqs={}, _sentReqs={};
let _frTab=1;
let _stopFrReqs=null;

function listenFriendRequests(){
  if(_stopFrReqs){_stopFrReqs();_stopFrReqs=null;}
  const ref=dbRef('friendRequests/'+_cu);
  const h=snap=>{
    _friendReqs=snap.val()||{};
    const count=Object.keys(_friendReqs).length;
    const dot=document.getElementById('frNotifDot');
    const badge=document.getElementById('frReqBadge');
    if(dot){dot.classList.toggle('show',count>0);}
    if(badge){
      badge.style.display=count>0?'inline':'none';
      badge.textContent=count;
    }
    // Desktop: update badge and refresh panel if open
    if(IS_DESKTOP()){
      deskUpdateFrBadge();
      if(_deskNav==='friends' && document.getElementById('deskFrContent')){
        deskLoadFriendsPanel();
      }
    }
  };
  ref.on('value',h);
  _stopFrReqs=()=>ref.off('value',h);
}

/* ‚îÄ‚îÄ Open/Close ‚îÄ‚îÄ */
function openFriendsModal(){ switchMainTab('friends'); }
function closeFriendsModal(){ switchMainTab('home'); }
function openAddFriendTab(){ switchMainTab('friends'); switchFrTab(3); }

/* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
function switchFrTab(n){
  _frTab=n;
  [1,2,3].forEach(i=>{
    document.getElementById('frTab'+i).classList.toggle('act',i===n);
  });
  if(n===1) loadFriendsList();
  else if(n===2) loadFriendRequests();
  else loadAddFriend();
}

/* ‚îÄ‚îÄ Tab 1: Arkada≈ülar ‚îÄ‚îÄ */
function loadFriendsList(){
  const el=document.getElementById('frContent');
  el.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';

  // Online ki≈üileri _online'dan al (Firebase'e baƒülƒ±, anlƒ±k)
  // Arkada≈ü listesi yoksa da online yabancƒ±larƒ± g√∂ster
  function renderWithFriends(friends){
    const friendList=Object.keys(friends);
    const onlineStrangers=Object.keys(_online).filter(u=>u!==_cu&&!friends[u]);
    let h='';

    if(friendList.length){
      const onlineFr=friendList.filter(u=>!!_online[u]);
      const offlineFr=friendList.filter(u=>!_online[u]);
      if(onlineFr.length){
        h+='<div class="fr-section-title">üü¢ Arkada≈ülar ‚Äî √áevrimi√ßi ('+onlineFr.length+')</div>';
        onlineFr.forEach(u=>{h+=friendRow(u,true);});
      }
      if(offlineFr.length){
        h+='<div class="fr-section-title">‚ö´ Arkada≈ülar ‚Äî √áevrimdƒ±≈üƒ± ('+offlineFr.length+')</div>';
        offlineFr.forEach(u=>{h+=friendRow(u,false);});
      }
    } else {
      h+='<div class="fr-empty"><div class="fr-empty-ic">üë•</div><div>Hen√ºz arkada≈üƒ±n yok.</div><div style="margin-top:8px"><button class="fr-btn add" onclick="switchFrTab(3)">Arkada≈ü Ekle</button></div></div>';
    }

    if(onlineStrangers.length){
      h+='<div class="fr-section-title" style="margin-top:14px">üåê ≈ûu An √áevrimi√ßi ('+onlineStrangers.length+')</div>';
      onlineStrangers.forEach(function(u){
        h+='<div class="fr-row">';
        h+='<div class="fr-av" style="background:'+strColor(u)+'">'+initials(u)+'<div class="r-dot on"></div></div>';
        h+='<div class="fr-info"><div class="fr-name">'+esc(u)+'</div><div class="fr-status">üü¢ √áevrimi√ßi</div></div>';
        h+='<div class="fr-btns"><button class="fr-btn add" onclick="sendFriendRequest(this.dataset.u,this)" data-u="'+esc(u)+'">+ Ekle</button></div>';
        h+='</div>';
      });
    }

    if(!h) h='<div class="fr-empty"><div class="fr-empty-ic">üåê</div><div>≈ûu an √ßevrimi√ßi kimse yok.</div></div>';
    el.innerHTML=h;
  }

  // _online hen√ºz dolmadƒ±ysa kƒ±sa bir bekleme sonrasƒ± tekrar dene
  function tryLoad(attempt){
    if(attempt>3){
      // Online listesi bo≈ü g√∂r√ºn√ºyor, direkt Firebase'den √ßek
      dbRef('online').once('value').then(function(onSnap){
        const now=Date.now();
        const onData=onSnap.val()||{};
        Object.entries(onData).forEach(function([k,v]){if(v&&now-v.ts<60000)_online[k]=true;});
        dbRef('friends/'+_cu).once('value').then(function(frSnap){
          renderWithFriends(frSnap.val()||{});
        }).catch(function(){ renderWithFriends({}); });
      }).catch(function(){ renderWithFriends({}); });
      return;
    }
    if(Object.keys(_online).length>0){
      dbRef('friends/'+_cu).once('value').then(function(frSnap){
        renderWithFriends(frSnap.val()||{});
      }).catch(function(){ renderWithFriends({}); });
    } else {
      setTimeout(function(){ tryLoad(attempt+1); }, 600);
    }
  }
  tryLoad(0);
}
function friendRow(u,on){
  return `<div class="fr-row">
    <div class="fr-av" style="background:${strColor(u)}">${initials(u)}<div class="r-dot ${on?'on':'off'}"></div></div>
    <div class="fr-info">
      <div class="fr-name">${esc(u)}</div>
      <div class="fr-status">${on?'üü¢ √áevrimi√ßi':'√áevrimdƒ±≈üƒ±'}</div>
    </div>
    <div class="fr-btns">
      <button class="fr-btn msg" onclick="switchMainTab('home');startDM('${u}')">üí¨ Mesaj</button>
      <button class="fr-btn remove" onclick="removeFriend('${u}')">‚úï</button>
    </div>
  </div>`;
}
function removeFriend(u){
  if(!confirm(u+' arkada≈ülƒ±ktan √ßƒ±karƒ±lsƒ±n mƒ±?'))return;
  Promise.all([
    dbRef('friends/'+_cu+'/'+u).remove(),
    dbRef('friends/'+u+'/'+_cu).remove()
  ]).then(()=>{showToast(u+' arkada≈ülƒ±ktan √ßƒ±karƒ±ldƒ±.');loadFriendsList();}).catch(()=>showToast('Hata olu≈ütu.'));
}

/* ‚îÄ‚îÄ Tab 2: ƒ∞stekler ‚îÄ‚îÄ */
function loadFriendRequests(){
  const el=document.getElementById('frContent');
  el.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  dbRef('friendRequests/'+_cu).once('value').then(snap=>{
    const reqs=snap.val()||{};
    const list=Object.keys(reqs);
    if(!list.length){
      el.innerHTML=`<div class="fr-empty"><div class="fr-empty-ic">üì≠</div><div>Bekleyen arkada≈ülƒ±k isteƒüi yok.</div></div>`;
      return;
    }
    let h=`<div class="fr-section-title">Gelen ƒ∞stekler ‚Äî ${list.length}</div>`;
    list.forEach(from=>{
      const on=!!_online[from];
      h+=`<div class="fr-row">
        <div class="fr-av" style="background:${strColor(from)}">${initials(from)}<div class="r-dot ${on?'on':'off'}"></div></div>
        <div class="fr-info">
          <div class="fr-name">${esc(from)}</div>
          <div class="fr-status">${on?'üü¢ √áevrimi√ßi':'√áevrimdƒ±≈üƒ±'}</div>
        </div>
        <div class="fr-btns">
          <button class="fr-btn accept" onclick="acceptFriendRequest('${from}')">‚úì Kabul</button>
          <button class="fr-btn reject" onclick="rejectFriendRequest('${from}')">‚úï</button>
        </div>
      </div>`;
    });
    el.innerHTML=h;
  });
}
function acceptFriendRequest(from){
  const now=Date.now();
  Promise.all([
    dbRef('friends/'+_cu+'/'+from).set({ts:now}),
    dbRef('friends/'+from+'/'+_cu).set({ts:now}),
    dbRef('friendRequests/'+_cu+'/'+from).remove(),
    dbRef('friendRequestsSent/'+from+'/'+_cu).remove()
  ]).then(()=>{
    showToast('üéâ '+from+' artƒ±k arkada≈üƒ±n!');
    loadFriendRequests();
  }).catch(()=>showToast('Hata olu≈ütu.'));
}
function rejectFriendRequest(from){
  Promise.all([
    dbRef('friendRequests/'+_cu+'/'+from).remove(),
    dbRef('friendRequestsSent/'+from+'/'+_cu).remove()
  ]).then(()=>{showToast('ƒ∞stek reddedildi.');loadFriendRequests();}).catch(()=>showToast('Hata.'));
}

/* ‚îÄ‚îÄ Tab 3: Ki≈üi Ekle ‚îÄ‚îÄ */
function loadAddFriend(){
  const el=document.getElementById('frContent');
  el.innerHTML=`
    <div style="margin-bottom:14px">
      <input class="bs-search" type="text" id="addFriendInp" placeholder="Kullanƒ±cƒ± adƒ± ara..." oninput="searchFriendUsers()" autocorrect="off" autocapitalize="none">
    </div>
    <div id="addFriendResults"><div class="fr-empty"><div class="fr-empty-ic">üîç</div><div>Kullanƒ±cƒ± adƒ± yazarak ara</div></div></div>`;
  document.getElementById('addFriendInp').focus();
}
function searchFriendUsers(){
  const q=document.getElementById('addFriendInp').value.trim().toLowerCase();
  const el=document.getElementById('addFriendResults');
  if(!q){el.innerHTML='<div class="fr-empty"><div class="fr-empty-ic">üîç</div><div>Kullanƒ±cƒ± adƒ± yazarak ara</div></div>';return;}
  el.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  Promise.all([
    dbRef('users').once('value'),
    dbRef('friends/'+_cu).once('value'),
    dbRef('friendRequestsSent/'+_cu).once('value'),
    dbRef('friendRequests/'+_cu).once('value')
  ]).then(([uSnap,fSnap,sSnap,rSnap])=>{
    const users=uSnap.val()||{};
    const myFriends=fSnap.val()||{};
    const sent=sSnap.val()||{};
    const incoming=rSnap.val()||{};
      // Sadece bu workspace'e ait kullanƒ±cƒ±larƒ± g√∂ster
    const results=Object.keys(users).filter(u=>{
      if(u===_cu) return false;
      if(users[u].banned) return false;
      if(!u.toLowerCase().includes(q)) return false;
      return true;
    });
    if(!results.length){el.innerHTML='<div class="fr-empty"><div class="fr-empty-ic">üòï</div><div>Kullanƒ±cƒ± bulunamadƒ±.</div></div>';return;}
    let h='';
    results.forEach(u=>{
      const on=!!_online[u];
      const isFriend=!!myFriends[u];
      const hasSent=!!sent[u];
      const hasIncoming=!!incoming[u];
      let btn='';
      if(isFriend) btn=`<button class="fr-btn msg" onclick="switchMainTab('home');startDM('${u}')">üí¨ Mesaj</button>`;
      else if(hasSent) btn=`<button class="fr-btn pending" disabled>ƒ∞stek G√∂nderildi</button>`;
      else if(hasIncoming) btn=`<button class="fr-btn accept" onclick="acceptFriendRequest('${u}');searchFriendUsers()">‚úì Kabul Et</button>`;
      else btn=`<button class="fr-btn add" onclick="sendFriendRequest('${u}',this)">+ Arkada≈ü Ekle</button>`;
      h+=`<div class="fr-row">
        <div class="fr-av" style="background:${strColor(u)}">${initials(u)}<div class="r-dot ${on?'on':'off'}"></div></div>
        <div class="fr-info"><div class="fr-name">${esc(u)}</div><div class="fr-status">${on?'üü¢ √áevrimi√ßi':'√áevrimdƒ±≈üƒ±'}</div></div>
        <div class="fr-btns">${btn}</div>
      </div>`;
    });
    el.innerHTML=h;
  });
}

/* ‚îÄ‚îÄ Send Request ‚îÄ‚îÄ */
function sendFriendRequest(to, btn){
  if(btn){btn.textContent='G√∂nderiliyor...';btn.disabled=true;}
  Promise.all([
    dbRef('friendRequests/'+to+'/'+_cu).set({from:_cu,ts:Date.now()}),
    dbRef('friendRequestsSent/'+_cu+'/'+to).set({to,ts:Date.now()})
  ]).then(()=>{
    showToast('Arkada≈ülƒ±k isteƒüi g√∂nderildi! ü§ù');
    if(btn){btn.textContent='ƒ∞stek G√∂nderildi';btn.className='fr-btn pending';}
  }).catch(()=>{showToast('Hata olu≈ütu.');if(btn){btn.textContent='+ Arkada≈ü Ekle';btn.disabled=false;}});
}

/* ‚îÄ‚îÄ Profile ‚îÄ‚îÄ */
function openProfile(){ switchMainTab('profile'); }
function closeProfile(){ switchMainTab('home'); }

/* ‚îÄ‚îÄ Image ‚îÄ‚îÄ */
function zoomImg(src){document.getElementById('imgOverlayImg').src=src;document.getElementById('imgOverlay').classList.add('open');}
function closeImg(){document.getElementById('imgOverlay').classList.remove('open');document.getElementById('imgOverlayImg').src='';}
function downloadOverlayImg(){
  const img=document.getElementById('imgOverlayImg');
  if(!img||!img.src) return;
  downloadDataUrl(img.src, 'gorsel_'+Date.now()+'.jpg');
}
/* Evrensel indirme yardƒ±mcƒ±sƒ± ‚Äî data: URL'leri Blob'a √ßevirir (Chrome kƒ±sƒ±tlamasƒ±nƒ± a≈üar) */
function downloadDataUrl(dataUrl, filename){
  try{
    fetch(dataUrl).then(r=>r.blob()).then(blob=>{
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download=filename||'dosya';
      document.body.appendChild(a); a.click();
      document.body.removeChild(a);
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }).catch(()=>{
      // Fallback: direkt link
      const a=document.createElement('a');
      a.href=dataUrl; a.download=filename||'dosya';
      document.body.appendChild(a); a.click();
      document.body.removeChild(a);
    });
  }catch(e){
    const a=document.createElement('a');
    a.href=dataUrl; a.download=filename||'dosya';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }
}

/* ‚îÄ‚îÄ Avatar ‚îÄ‚îÄ */
function renderMyAvatar(){
  // T√ºm kendi avatar elementlerini g√ºncelle
  const ids = ['myAvatar','forumAvatar'];
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(!el||!_cu) return;
    el.innerHTML='<div class="sdot"></div>';
    setAvatar(el,_cu);
    if(!el.querySelector('.sdot')){const d=document.createElement('div');d.className='sdot';el.appendChild(d);}
  });
  // Desktop rail user
  const railUser=document.getElementById('deskRailUser');
  if(railUser&&_cu){
    railUser.innerHTML='<div class="sdot"></div>';
    setAvatar(railUser,_cu);
    if(!railUser.querySelector('.sdot')){const d=document.createElement('div');d.className='sdot';railUser.appendChild(d);}
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üëë ADMƒ∞N PANELƒ∞
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _prevScreen='roomsScreen';

/* Admin i√ßin ikincil Firebase baƒülantƒ±sƒ± */
let _adminDB = null;  // se√ßili sunucunun db'si
let _adminServer = null; // se√ßili sunucu key'i
let _adminRestUrl = ''; // se√ßili sunucunun REST url'i

function openAdminPanel(){
  if(!_isAdmin){showToast('Yetkisiz eri≈üim.');return;}
  _prevScreen=document.querySelector('.screen.active')?.id||'roomsScreen';
  showScreen('adminPanel');
  _adminServer = _activeServer;
  _adminDB = _db;
  _adminRestUrl = _FB_REST;
  renderAdminSrvSwitcher();
  // Header g√ºncellemeleri
  const srvLabel = document.getElementById('adminSrvLabel');
  if(srvLabel && typeof FB_SERVERS!=='undefined' && _activeServer)
    srvLabel.textContent = (FB_SERVERS[_activeServer]?.icon||'') + ' ' + (FB_SERVERS[_activeServer]?.label||_activeServer);
  const badge = document.getElementById('adminOnlineBadge');
  if(badge) badge.textContent = 'üü¢ '+Object.keys(_online||{}).length+' online';
  adminTab('users');
}

function renderAdminSrvSwitcher(){
  const el = document.getElementById('adminSrvSwitcher');
  if(!el) return;
  el.innerHTML = Object.entries(FB_SERVERS).map(([key,srv])=>`
    <button onclick="switchAdminServer('${key}')" id="adminSrvBtn_${key}"
      style="padding:5px 16px;border-radius:100px;font-size:11.5px;font-weight:800;cursor:pointer;white-space:nowrap;transition:all .15s;border:1px solid ${key===(_adminServer||_activeServer)?'rgba(155,114,255,.5)':'var(--border)'};
             background:${key===(_adminServer||_activeServer)?'rgba(155,114,255,.15)':'transparent'};
             color:${key===(_adminServer||_activeServer)?'#c4a7ff':'var(--muted)'}">>
      ${srv.icon} ${srv.label}
    </button>
  `).join('');
  // ƒ∞lk a√ßƒ±lƒ±≈üta aktif sunucuyu se√ß
  if(!_adminServer) _adminServer = _activeServer;
  _adminRestUrl = FB_SERVERS[_adminServer]?.config?.databaseURL || _FB_REST;
}

async function switchAdminServer(key){
  if(!_isAdmin){ showToast('Yetkisiz eri≈üim.'); return; }
  if(!FB_SERVERS[key]) return;
  _adminServer = key;
  _adminRestUrl = FB_SERVERS[key].config.databaseURL;

  // Butonu g√ºncelle
  document.querySelectorAll('[id^="adminSrvBtn_"]').forEach(b=>{
    const k = b.id.replace('adminSrvBtn_','');
    b.style.background = k===key ? 'var(--accent)' : 'var(--bg)';
    b.style.color = k===key ? '#fff' : 'var(--muted)';
  });

  // Y√ºkleniyor g√∂ster
  const body = document.getElementById('adminBody') || document.getElementById('deskAdminBody');
  if(body) body.innerHTML = '<div style="padding:30px;text-align:center;color:var(--muted)">üîÑ Sunucuya baƒülanƒ±lƒ±yor...</div>';

  // Firebase SDK baƒülantƒ±sƒ± + anonim auth ‚Äî paneli a√ßmadan √ñNCE tamamla
  try{
    const existingApp = firebase.apps.find(a=>a.name==='admin_'+key);
    const app = existingApp || firebase.initializeApp(FB_SERVERS[key].config, 'admin_'+key);
    _adminDB = firebase.database(app);

    const adminAuth = firebase.auth(app);
    // Token almadan √∂nce oturumu kesin olarak bekle
    if(!adminAuth.currentUser){
      try{
        await adminAuth.signInAnonymously();
        // Token'ƒ±n hazƒ±r olmasƒ±nƒ± bekle
        await adminAuth.currentUser?.getIdToken(true);
      }catch(authErr){
        console.warn('Admin sunucu anonim auth hatasƒ±:', authErr.code, authErr.message);
        if(authErr.code === 'auth/operation-not-allowed'){
          if(body) body.innerHTML = '<div style="padding:20px;color:var(--red)">‚ö†Ô∏è Bu Firebase projesinde Anonymous Authentication kapalƒ±.<br><br>Firebase Console ‚Üí layla-70d21 ‚Üí Authentication ‚Üí Sign-in method ‚Üí Anonymous ‚Üí Etkinle≈ütir</div>';
          showToast('‚ö†Ô∏è Anonymous Auth kapalƒ± ‚Äî Firebase Console kontrol et');
          return;
        }
      }
    } else {
      // Mevcut token'ƒ± yenile
      try{ await adminAuth.currentUser.getIdToken(true); }catch(e){}
    }
  }catch(e){ console.warn('Admin DB switch:', e); }

  showToast(FB_SERVERS[key].icon+' '+FB_SERVERS[key].label+' baƒülandƒ±');
  adminTab(_adminTab||'users');
}

/* Admin panel i√ßin √∂zel dbRef ‚Äî se√ßili sunucuyu kullanƒ±r */
function adminDbRef(path){
  // Farklƒ± sunucu se√ßildiyse _adminDB kullan, yoksa normal _db
  const db = (_adminServer && _adminServer !== _activeServer && _adminDB) ? _adminDB : _db;
  return db.ref(path);
}

/* Admin panel i√ßin REST get/set ‚Äî se√ßili sunucunun URL'ini kullanƒ±r */
async function getAdminRestToken(){
  // Se√ßili admin sunucusu aktif sunucuyla aynƒ±ysa mevcut token'ƒ± kullan
  if(!_adminServer || _adminServer === _activeServer){
    return await getFbAuthToken();
  }
  // Farklƒ± sunucu: o sunucuya ait Firebase app'in token'ƒ±nƒ± al
  try{
    const app = firebase.apps.find(a=>a.name==='admin_'+_adminServer);
    if(app){
      const auth = firebase.auth(app);
      if(auth.currentUser) return await auth.currentUser.getIdToken(false);
      // Token yok ‚Äî anonim giri≈üi tekrar dene
      try{
        await auth.signInAnonymously();
        if(auth.currentUser) return await auth.currentUser.getIdToken(false);
      }catch(e2){ console.warn('getAdminRestToken anon retry:', e2.code); }
    }
  }catch(e){}
  return null;
}
async function adminRestGet(path){
  if(!_isAdmin){ console.warn('adminRestGet: yetkisiz eri≈üim engellendi'); return null; }
  const url = (_adminServer ? (FB_SERVERS[_adminServer]?.config?.databaseURL||_FB_REST) : _FB_REST);
  const token = await getAdminRestToken();
  const authParam = token ? '?auth='+token : '';
  const r = await fetch(url+'/'+path+'.json'+authParam,{cache:'no-store'});
  const d = await r.json();
  return d;
}
async function adminRestSet(path, val){
  if(!_isAdmin){ console.warn('adminRestSet: yetkisiz eri≈üim engellendi'); return; }
  const url = (_adminServer ? (FB_SERVERS[_adminServer]?.config?.databaseURL||_FB_REST) : _FB_REST);
  const token = await getAdminRestToken();
  const authParam = token ? '?auth='+token : '';
  const r = await fetch(url+'/'+path+'.json'+authParam,{method:'PUT',body:JSON.stringify(val),headers:{'Content-Type':'application/json'}});
  if(!r.ok){ const e=await r.json().catch(()=>({})); throw new Error((e&&e.error)||('HTTP '+r.status)); }
  return r.json().catch(()=>null);
}
async function adminRestDelete(path){
  if(!_isAdmin){ console.warn('adminRestDelete: yetkisiz eri≈üim engellendi'); return; }
  const url = (_adminServer ? (FB_SERVERS[_adminServer]?.config?.databaseURL||_FB_REST) : _FB_REST);
  const token = await getAdminRestToken();
  const authParam = token ? '?auth='+token : '';
  const r = await fetch(url+'/'+path+'.json'+authParam,{method:'DELETE'});
  if(!r.ok){ const e=await r.json().catch(()=>({})); throw new Error((e&&e.error)||('HTTP '+r.status)); }
  return r.json().catch(()=>null);
}
function closeAdminPanel(){if(_prevScreen==='roomsScreen')switchMainTab('home');else showScreen(_prevScreen);}

function adminTab(tab){
  if(IS_DESKTOP()){ deskAdminTab(tab); return; }
  _adminTab=tab;
  document.querySelectorAll('.atab').forEach((el,i)=>{
    el.classList.toggle('act',['users','rooms','msgs','forum','announce','games','health','security','ipbans','settings','naturebot'][i]===tab);
  });
  // Online sayƒ±sƒ±nƒ± g√ºncelle
  const badge = document.getElementById('adminOnlineBadge');
  if(badge) badge.textContent = 'üü¢ '+Object.keys(_online||{}).length+' online';
  const body=document.getElementById('adminBody');
  if(!body) return;
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  if(tab==='users') loadAdminUsers();
  else if(tab==='rooms') loadAdminRooms();
  else if(tab==='msgs') loadAdminMsgs();
  else if(tab==='forum') loadAdminForum();
  else if(tab==='announce') loadAdminAnnounce();
  else if(tab==='games') loadAdminGames();
  else if(tab==='health') loadAdminSystemHealth();
  else if(tab==='stats') loadAdminStats();
  else if(tab==='security') loadAdminSecurity();
  else if(tab==='ipbans') loadAdminIPBans();
  else if(tab==='settings') loadAdminSettings();
}

/* ‚îÄ‚îÄ Admin: Users ‚îÄ‚îÄ */
async function loadAdminUsers(){
  const body=document.getElementById('adminBody');
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  const users=await adminRestGet('users').catch(()=>null)||{};
  try{
    {
    // username alanƒ± yoksa objenin key'ini username olarak ata
    Object.entries(users).forEach(([k,v])=>{ if(v&&!v.username) v.username=k; });
    const list=Object.values(users).filter(u=>u&&u.username).sort((a,b)=>(a.username||'').localeCompare(b.username||''));
    if(!list.length){body.innerHTML='<p style="color:var(--muted)">Kullanƒ±cƒ± yok.</p>';return;}

    let h='<div class="admin-section">';
    // Ba≈ülƒ±k + Toplu i≈ülem ara√ß √ßubuƒüu
    h+=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
      <div class="admin-sec-title" style="margin:0">T√ºm Kullanƒ±cƒ±lar (${list.length})</div>
      <div style="display:flex;gap:6px;align-items:center;">
        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:.78rem;color:var(--muted);">
          <input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers(this)"> T√ºm√ºn√º Se√ß
        </label>
        <button class="a-btn red" id="bulkDeleteBtn" style="display:none;padding:6px 12px;font-size:.75rem;" onclick="bulkDeleteUsers()">üóëÔ∏è Se√ßilenleri Sil</button>
      </div>
    </div>`;
    h+='<div class="admin-card">';

    list.forEach(u=>{
      const isBanned=!!u.banned;
      const isAdminUser=!!u.isAdmin;
      const isMe=u.username===_cu;
      const on=!!_online[u.username];
      h+=`<div class="admin-row" id="urow-${esc(u.username)}">
        <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">
          ${!isMe?`<input type="checkbox" class="user-select-cb" data-u="${esc(u.username)}" onchange="onUserCheckChange()" style="width:16px;height:16px;cursor:pointer;flex-shrink:0;">`:'<div style="width:16px;flex-shrink:0;"></div>'}
          <div class="admin-row-av" style="background:${strColor(u.username)}">${initials(u.username)}</div>
          <div class="admin-row-info">
            <div class="admin-row-name">
              ${esc(u.username)}
              ${isAdminUser?'<span class="admin-tag">Admin</span>':''}
              ${isBanned?'<span class="banned-tag">Banlƒ±</span>':''}
            </div>
            <div class="admin-row-sub">${on?'üü¢ √áevrimi√ßi':'‚ö´ √áevrimdƒ±≈üƒ±'} ¬∑ ${u.origin||'‚Äî'} ¬∑ üè¢ ${u._ws||'?'} ¬∑ üìÖ ${u.createdAt?new Date(u.createdAt).toLocaleString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}):'Bilinmiyor'}</div>
            ${u.lastIP?`<div style="font-size:11px;color:#e67e22;margin-top:2px;font-family:monospace;">üåê ${esc(u.lastIP)}</div>`:''}
          </div>
        </div>
        <div class="admin-row-btns" style="flex-wrap:wrap;">
          <button class="a-btn" style="background:var(--surface);" onclick="adminUserDetails('${u.username}')">üîç Detay</button>
          <button class="a-btn blue" onclick="adminEditUserProfile('${u.username}')">‚úèÔ∏è D√ºzenle</button>
          ${!isMe?`<button class="a-btn ${isBanned?'green':'red'}" onclick="adminToggleBan('${u.username}',${!isBanned})">${isBanned?'‚úÖ Unban':'üö´ Ban'}</button>`:''}
          ${!isMe&&u.lastIP?`<button class="a-btn red" style="background:#8e44ad" onclick="adminIPBan('${u.username}','${u.lastIP||''}')">üåê IP Ban</button>`:''}
          ${!isMe&&!isAdminUser?`<button class="a-btn yellow" onclick="adminMakeAdmin('${u.username}')">üëë Admin Yap</button>`:''}
          ${!isMe&&isAdminUser?`<button class="a-btn red" onclick="adminRemoveAdmin('${u.username}')">üëë Admin Al</button>`:''}
          ${!isMe?`<button class="a-btn" style="background:var(--surface2);" onclick="adminViewUserMessages('${u.username}')">üí¨ Mesajlar</button>`:''}
          ${!isMe?`<button class="a-btn blue" onclick="adminResetPassword('${u.username}')">üîë ≈ûifre Sƒ±fƒ±rla</button>`:''}\n          ${!isMe?`<button class="a-btn red" onclick="adminDeleteUser('${u.username}')">üóëÔ∏è Sil</button>`:''}
        </div>
      </div>`;
    });
    h+='</div></div>';
    body.innerHTML=h;
  }}catch(e){body.innerHTML='<p style="color:var(--muted);padding:20px">Y√ºklenemedi: '+(e&&e.message||e)+'</p>';}
}

function onUserCheckChange(){
  const cbs=document.querySelectorAll('.user-select-cb:checked');
  const btn=document.getElementById('bulkDeleteBtn');
  if(btn) btn.style.display=cbs.length>0?'inline-block':'none';
  const all=document.querySelectorAll('.user-select-cb');
  const selAll=document.getElementById('selectAllUsers');
  if(selAll) selAll.checked=all.length>0&&cbs.length===all.length;
}

function toggleSelectAllUsers(cb){
  document.querySelectorAll('.user-select-cb').forEach(el=>el.checked=cb.checked);
  onUserCheckChange();
}

function bulkDeleteUsers(){
  const cbs=document.querySelectorAll('.user-select-cb:checked');
  const users=[...cbs].map(cb=>cb.dataset.u);
  if(!users.length) return;
  if(!confirm(users.length+' kullanƒ±cƒ± kalƒ±cƒ± olarak silinsin mi?\n\n'+users.join(', '))) return;
  Promise.all(users.flatMap(u=>[
    adminRestDelete('users/'+u),
    adminRestDelete('online/'+u),
    adminRestDelete('friends/'+u),
    adminRestDelete('friendRequests/'+u),
    adminRestDelete('friendRequestsSent/'+u),
    adminRestDelete('admins/'+u)
  ])).then(()=>{
    showToast(users.length+' kullanƒ±cƒ± silindi.');
    loadAdminUsers();
  }).catch(()=>showToast('Bazƒ± silmeler ba≈üarƒ±sƒ±z oldu.'));
}

async function adminIPBan(username, ip){
  if(!ip){ showToast('IP adresi bulunamadƒ±.'); return; }
  if(!confirm('‚ö†Ô∏è '+username+' kullanƒ±cƒ±sƒ±nƒ±n IP adresi yasaklansƒ±n mƒ±?\n\nIP: '+ip+'\n\nBu IP\'den giri≈ü yapmaya √ßalƒ±≈üan HERKESƒ∞N giri≈üi engellenecektir!')) return;
  const key = ip.replace(/\./g,'_');
  try{
    await adminRestSet('bannedIPs/'+key,{ip:ip,bannedBy:_cu,bannedAt:Date.now(),username:username});
    await adminRestSet('users/'+username+'/banned',true);
    showToast('üåê IP ban uygulandƒ±: '+ip);
    loadAdminUsers();
  }catch(e){ showToast('Hata: '+e.message); }
}

async function adminIPUnban(ip){
  if(!confirm('IP yasaƒüƒ± kaldƒ±rƒ±lsƒ±n mƒ±?\n\nIP: '+ip)) return;
  const key = ip.replace(/\./g,'_');
  try{
    await adminRestDelete('bannedIPs/'+key);
    showToast('‚úÖ IP ban kaldƒ±rƒ±ldƒ±: '+ip);
    loadAdminIPBans();
  }catch(e){ showToast('Hata.'); }
}

async function loadAdminIPBans(){
  const body = document.getElementById('adminBody');
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  try{
    const bans = await adminRestGet('bannedIPs')||{};
    const list = Object.values(bans);
    if(!list.length){
      body.innerHTML='<div class="admin-section"><p style="color:var(--muted);padding:20px">Yasaklƒ± IP adresi yok.</p></div>';
      return;
    }
    let h='<div class="admin-section"><div class="admin-sec-title">üåê Yasaklƒ± IP Adresleri ('+list.length+')</div><div class="admin-card">';
    list.sort((a,b)=>b.bannedAt-a.bannedAt).forEach(b=>{
      h+=`<div class="admin-row" style="align-items:center;">
        <div style="flex:1">
          <div style="font-family:monospace;font-weight:700;color:#e67e22">${esc(b.ip)}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:3px">
            üë§ ${esc(b.username||'?')} ¬∑ üïê ${b.bannedAt?new Date(b.bannedAt).toLocaleString('tr-TR'):'?'}
          </div>
        </div>
        <button class="a-btn green" onclick="adminIPUnban('${esc(b.ip)}')">‚úÖ Kaldƒ±r</button>
      </div>`;
    });
    h+='</div></div>';
    body.innerHTML=h;
  }catch(e){ body.innerHTML='<p style="color:var(--muted);padding:20px">Y√ºklenemedi.</p>'; }
}

async function adminToggleBan(username,ban){
  if(!confirm(`${username} kullanƒ±cƒ±sƒ±nƒ± ${ban?'banlamak':'banƒ± kaldƒ±rmak'} istediƒüinize emin misiniz?`))return;
  try{
    await adminRestSet('users/'+username+'/banned',ban);
    showToast(ban?username+' banlandƒ±.':username+' banƒ± kaldƒ±rƒ±ldƒ±.');
    loadAdminUsers();
    if(ban) adminRestDelete('online/'+username).catch(()=>{});
  }catch(e){showToast('Hata: '+(e&&e.message||''));}
}
async function adminMakeAdmin(username){
  if(!confirm(`${username} kullanƒ±cƒ±sƒ±na admin yetkisi verilsin mi?`))return;
  try{
    await Promise.all([adminRestSet('users/'+username+'/isAdmin',true),adminRestSet('admins/'+username,true)]);
    showToast(username+' artƒ±k admin.');
    loadAdminUsers();
  }catch(e){showToast('Hata olu≈ütu.');}
}

/* ‚îÄ‚îÄ Admin: Rooms ‚îÄ‚îÄ */
let _newRoomType='channel';
async function loadAdminRooms(){
  const body=document.getElementById('adminBody');
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  const rooms=await adminRestGet('rooms').catch(()=>null)||{};
  try{
    {
    const list=Object.values(rooms).filter(r=>r.type!=='dm').sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    const dmList=Object.values(rooms).filter(r=>r.type==='dm').sort((a,b)=>(a.ts||0)-(b.ts||0));
    let h='<div class="admin-section"><div class="admin-sec-title">Yeni Oda Olu≈ütur</div>';
    h+=`<div class="admin-radio-group"><div class="admin-radio sel" id="rtChannel" onclick="selectRoomType('channel')">üì¢ Kanal</div><div class="admin-radio" id="rtGroup" onclick="selectRoomType('group')">üë• Grup</div></div>`;
    h+='<input class="admin-inp" id="newRoomName" placeholder="Oda adƒ±..." autocorrect="off">';
    h+='<button class="admin-submit" onclick="adminCreateRoom()">‚úö Olu≈ütur</button></div>';
    h+='<div class="admin-section"><div class="admin-sec-title">Mevcut Odalar ('+list.length+')</div><div class="admin-card">';
    if(!list.length){h+='<div style="padding:14px;color:var(--muted);font-size:.85rem">Hen√ºz kanal/grup yok.</div>';}
    list.forEach(r=>{
      const memberCount=(r.members||[]).length;
      const locked=!!r.locked;
      const slowMode=r.slowMode||0;
      const pinned=r.pinnedMsg||'';
      h+='<div class="admin-row" style="flex-wrap:wrap;gap:8px;">';
      h+='<div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;">';
      h+='<div style="font-size:1.3rem;width:36px;text-align:center;flex-shrink:0">'+(r.type==='group'?'üë•':'#')+'</div>';
      h+='<div class="admin-row-info"><div class="admin-row-name">'+esc(r.name||r.id)+(locked?' üîí':'')+'</div>';
      h+='<div class="admin-row-sub">'+(r.type==='channel'?'Kanal':'Grup')+' ¬∑ '+memberCount+' √ºye'+(r.createdBy?' ¬∑ '+esc(r.createdBy):'')+(slowMode?' ¬∑ ‚è±'+slowMode+'s':'')+'</div></div></div>';
      h+='<div class="admin-row-btns" style="flex-wrap:wrap;">';
      h+='<button class="a-btn blue" data-id="'+r.id+'" data-name="'+esc(r.name||r.id)+'" onclick="adminRenameRoom(this.dataset.id,this.dataset.name)">‚úèÔ∏è Yeniden Adlandƒ±r</button>';
      h+=`<button class="a-btn ${locked?'green':'yellow'}" onclick="adminToggleLockRoom('${r.id}',${!locked})">${locked?'üîì Kilidi A√ß':'üîí Kilitle'}</button>`;
      h+='<button class="a-btn" style="background:var(--surface);" data-id="'+r.id+'" onclick="adminRoomDetails(this.dataset.id)">‚öôÔ∏è Detay</button>';
      h+='<button class="a-btn blue" data-id="'+r.id+'" data-sm="'+slowMode+'" onclick="adminSetSlowMode(this.dataset.id,parseInt(this.dataset.sm))">‚è± Yava≈ü Mod</button>';
      if(r.type==='group') h+='<button class="a-btn blue" data-id="'+r.id+'" data-name="'+esc(r.name||r.id)+'" onclick="adminManageMembers(this.dataset.id,this.dataset.name)">üë• √úyeler</button>';
      h+='<button class="a-btn red" data-id="'+r.id+'" data-name="'+esc(r.name||r.id)+'" onclick="adminClearRoomMsgs(this.dataset.id,this.dataset.name)">üóëÔ∏è Mesajlarƒ± Temizle</button>';
      h+='<button class="a-btn red" data-id="'+r.id+'" data-name="'+esc(r.name||r.id)+'" onclick="adminDeleteRoom(this.dataset.id,this.dataset.name)">‚úï Odayƒ± Sil</button>';
      h+='</div></div>';
    });
    h+='</div></div>';

    // DM Konu≈ümalarƒ± b√∂l√ºm√º
    if(dmList.length){
      h+='<div class="admin-section"><div class="admin-sec-title">üí¨ DM Konu≈ümalarƒ± ('+dmList.length+')</div><div class="admin-card">';
      dmList.forEach(r=>{
        const members=(r.members||[]).filter(m=>m!=='admin');
        const label = members.length>=2 ? members[0]+' ‚Üî '+members[1] : (members[0]||r.id);
        h+='<div class="admin-row">';
        h+='<div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0;"><div style="font-size:1.2rem;width:36px;text-align:center;">üí¨</div>';
        h+='<div class="admin-row-info"><div class="admin-row-name">'+esc(label)+'</div></div></div>';
        h+='<div class="admin-row-btns">';
        h+='<button class="a-btn red" data-id="'+r.id+'" data-name="'+esc(label)+'" onclick="adminClearRoomMsgs(this.dataset.id,this.dataset.name)">üóëÔ∏è Mesajlarƒ± Temizle</button>';
        h+='<button class="a-btn red" data-id="'+r.id+'" data-name="'+esc(label)+'" onclick="adminDeleteRoom(this.dataset.id,this.dataset.name)">‚úï Sil</button>';
        h+='</div></div>';
      });
      h+='</div></div>';
    }

    body.innerHTML=h;
  }}catch(e){body.innerHTML='<p style="color:var(--muted);padding:20px">Y√ºklenemedi.</p>';}
}

async function adminToggleLockRoom(id, lock){
  try{
    await adminRestSet('rooms/'+id+'/locked',lock);
    showToast(lock?'Oda kilitlendi. Sadece adminler mesaj atabilir.':'Oda kilidi a√ßƒ±ldƒ±.');
    loadAdminRooms(); loadRooms();
  }catch(e){showToast('Hata: '+(e&&e.message||''));}
}
async function adminSetSlowMode(id, current){
  const val=prompt('Yava≈ü mod (saniye, 0=kapalƒ±):', current);
  if(val===null)return;
  const n=parseInt(val)||0;
  try{
    await adminRestSet('rooms/'+id+'/slowMode',n);
    showToast('Yava≈ü mod: '+(n?n+'s':'Kapalƒ±'));loadAdminRooms();
  }catch(e){showToast('Hata.');}
}
async function adminClearRoomMsgs(id, name){
  if(!confirm('"'+name+'" odasƒ±ndaki t√ºm mesajlar silinsin mi?'))return;
  const clearedAt = Date.now();
  try{
    await adminRestDelete('msgs/'+id);
    await adminRestSet('rooms/'+id+'/clearedAt',clearedAt);
    showToast('Mesajlar temizlendi. ‚úÖ');loadAdminRooms();
  }catch(e){showToast('Hata.');}
}
async function adminManageMembers(roomId, roomName){
  const room=await adminRestGet('rooms/'+roomId).catch(()=>null);
  if(!room)return;
  const allUsersData=await adminRestGet('users').catch(()=>({})) || {};
  {
    const allUsers=Object.keys(allUsersData).filter(u=>!allUsersData[u].banned);
    const members=room.members||[];
      let html='<div style="max-height:400px;overflow-y:auto;margin-top:12px;">';
      html+='<div style="font-size:.8rem;font-weight:700;color:var(--muted);margin-bottom:8px;">√úYE Lƒ∞STESƒ∞ ‚Äî '+esc(roomName)+'</div>';
      allUsers.forEach(u=>{
        const isMember=members.includes(u);
        html+='<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);">';
        html+='<div style="width:30px;height:30px;border-radius:7px;background:'+strColor(u)+';display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:900;color:#fff;">'+initials(u)+'</div>';
        html+='<div style="flex:1;font-size:.85rem;color:var(--text-hi);">'+esc(u)+'</div>';
        if(isMember){
          html+='<button data-rid="'+roomId+'" data-u="'+u+'" onclick="adminKickFromGroup(this.dataset.rid,this.dataset.u,this.parentElement)" style="background:rgba(224,30,90,.15);color:#e01e5a;border:none;border-radius:6px;padding:4px 10px;font-size:.75rem;cursor:pointer;">√áƒ±kar</button>';
        } else {
          html+='<button data-rid="'+roomId+'" data-u="'+u+'" onclick="adminAddToGroup(this.dataset.rid,this.dataset.u,this)" style="background:rgba(29,155,209,.15);color:#5b9bd5;border:none;border-radius:6px;padding:4px 10px;font-size:.75rem;cursor:pointer;">Ekle</button>';
        }
        html+='</div>';
      });
      html+='</div>';
      const body=document.getElementById('adminBody');
      const existing=document.getElementById('memberMgmtPanel');
      if(existing)existing.remove();
      const panel=document.createElement('div');
      panel.id='memberMgmtPanel';
      panel.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
      panel.innerHTML='<div style="background:var(--bg2);border-radius:14px;padding:18px;width:100%;max-width:400px;max-height:80vh;overflow-y:auto;">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;"><div style="font-weight:900;color:var(--text-hi);">üë• √úye Y√∂netimi</div><div onclick="document.getElementById(\'memberMgmtPanel\').remove()" style="cursor:pointer;color:var(--muted);">‚úï</div></div>'+
        html+'</div>';
      document.body.appendChild(panel);
  }
}
async function adminKickFromGroup(roomId, username, rowEl){
  try{
    const room=await adminRestGet('rooms/'+roomId)||{};
    const members=(room.members||[]).filter(m=>m!==username);
    await adminRestSet('rooms/'+roomId+'/members',members);
    showToast(username+' gruptan √ßƒ±karƒ±ldƒ±.');
    if(rowEl) rowEl.querySelector('button').textContent='Ekle';
    if(rowEl) rowEl.querySelector('button').onclick=function(){adminAddToGroup(roomId,username,this);};
    if(rowEl) rowEl.querySelector('button').style.cssText='background:rgba(29,155,209,.15);color:#5b9bd5;border:none;border-radius:6px;padding:4px 10px;font-size:.75rem;cursor:pointer;';
  }catch(e){showToast('Hata.');}
}
async function adminAddToGroup(roomId, username, btn){
  try{
    const room=await adminRestGet('rooms/'+roomId)||{};
    const members=room.members||[];
    if(members.includes(username))return;
    members.push(username);
    await adminRestSet('rooms/'+roomId+'/members',members);
    showToast(username+' gruba eklendi.');
    if(btn){btn.textContent='√áƒ±kar';btn.style.cssText='background:rgba(224,30,90,.15);color:#e01e5a;border:none;border-radius:6px;padding:4px 10px;font-size:.75rem;cursor:pointer;';btn.onclick=function(){adminKickFromGroup(roomId,username,btn.closest('div[style]'));};}
  }catch(e){showToast('Hata.');}
}
function selectRoomType(type){
  _newRoomType=type;
  document.getElementById('rtChannel').classList.toggle('sel',type==='channel');
  document.getElementById('rtGroup').classList.toggle('sel',type==='group');
}
async function adminCreateRoom(){
  const name=document.getElementById('newRoomName').value.trim();
  if(!name){showToast('Oda adƒ± girin.');return;}
  const id=_newRoomType+'_'+name.toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'')+'_'+Date.now();
  const data={id,name,type:_newRoomType,members:[_cu],ts:Date.now()};
  try{
    await adminRestSet('rooms/'+id,data);
    showToast(name+' olu≈üturuldu!');
    document.getElementById('newRoomName').value='';
    loadAdminRooms();loadRooms();
  }catch(e){showToast('Hata olu≈ütu.');}
}
async function adminDeleteRoom(id,name){
  if(!confirm(`"${name}" odasƒ± silinsin mi? T√ºm mesajlar da silinecek.`))return;
  try{
    await Promise.all([adminRestDelete('rooms/'+id),adminRestDelete('msgs/'+id)]);
    showToast(name+' silindi.');loadAdminRooms();loadRooms();
  }catch(e){showToast('Hata olu≈ütu.');}
}


async function loadAdminStats(){
  const body=document.getElementById('adminBody');
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  try{
  const [users,rooms,posts,online]=await Promise.all([
    adminRestGet('users').catch(()=>({})),
    adminRestGet('rooms').catch(()=>({})),
    adminRestGet('forum/posts').catch(()=>({})),
    adminRestGet('online').catch(()=>({}))
  ]);
  {
    const _users=users||{};
    const _rooms=rooms||{};
    const _posts=posts||{};
    const _online=online||{};
    const now=Date.now();
    const totalUsers=Object.keys(_users).length;
    const bannedUsers=Object.values(_users).filter(u=>u&&u.banned).length;
    const adminUsers=Object.values(_users).filter(u=>u&&u.isAdmin).length;
    const onlineNow=Object.values(_online).filter(v=>v&&now-v.ts<60000).length;
    const channels=Object.values(_rooms).filter(r=>r.type==='channel').length;
    const groups=Object.values(_rooms).filter(r=>r.type==='group').length;
    const forumPosts=Object.keys(_posts).length;
    // Origin daƒüƒ±lƒ±mƒ±
    const origins={};
    Object.values(_users).forEach(u=>{if(u&&u.origin)origins[u.origin]=(origins[u.origin]||0)+1;});
    const topOrigins=Object.entries(origins).sort((a,b)=>b[1]-a[1]).slice(0,8);

    const card=(title,val,color)=>`<div style="background:var(--surface2);border-radius:10px;padding:14px 16px;display:flex;flex-direction:column;gap:4px;"><div style="font-size:.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;">${title}</div><div style="font-size:1.6rem;font-weight:900;color:${color||'var(--text-hi)'};">${val}</div></div>`;
    let h='<div class="admin-section"><div class="admin-sec-title">üìä Anlƒ±k ƒ∞statistikler</div>';
    h+='<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:14px;">';
    h+=card('Toplam √úye',totalUsers);
    h+=card('≈ûu An Online',onlineNow,'#4caf50');
    h+=card('Banlƒ± √úye',bannedUsers,'#e01e5a');
    h+=card('Admin',adminUsers,'#f5a623');
    h+=card('Kanal',channels,'#5b9bd5');
    h+=card('Grup',groups,'#9b59b6');
    h+=card('Forum Payla≈üƒ±mƒ±',forumPosts,'#1abc9c');
    h+='</div>';
    if(topOrigins.length){
      h+='<div class="admin-sec-title" style="margin-top:4px;">üåç K√∂ken Daƒüƒ±lƒ±mƒ±</div>';
      h+='<div class="admin-card" style="padding:12px;">';
      topOrigins.forEach(([origin,count])=>{
        const pct=Math.round(count/totalUsers*100);
        h+=`<div style="margin-bottom:8px;">
          <div style="display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-hi);margin-bottom:3px;"><span>${origin}</span><span>${count} √ºye (${pct}%)</span></div>
          <div style="background:var(--surface2);border-radius:100px;height:6px;overflow:hidden;"><div style="background:var(--blue);height:100%;width:${pct}%;border-radius:100px;transition:width .4s;"></div></div>
        </div>`;
      });
      h+='</div>';
    }
    h+='</div>';
    body.innerHTML=h;
  }
}catch(e){body.innerHTML='<p style="color:var(--muted);padding:20px">Y√ºklenemedi.</p>';}
}

/* ‚îÄ‚îÄ Admin: Messages ‚îÄ‚îÄ */
function loadAdminMsgs(){
  const body=document.getElementById('adminBody');
  // Load all rooms and messages via REST
  Promise.all([adminRestGet('rooms').catch(()=>({})),adminRestGet('msgs').catch(()=>({}))]).then(([roomsData,msgsData])=>{
    const rooms=roomsData||{};
    const roomList=Object.values(rooms);
    if(!roomList.length){body.innerHTML='<p style="color:var(--muted)">Oda yok.</p>';return;}
    const allMsgsAll=msgsData||{};
    const results=roomList.map(r=>({room:r,msgs:allMsgsAll[r.id]||{}}));
    {
      let allMsgs=[];
      results.forEach(({room,msgs})=>{
        Object.entries(msgs).forEach(([key,m])=>{
          if(!m.sys) allMsgs.push({...m,_key:key,_roomId:room.id,_roomName:room.name||room.id});
        });
      });
      allMsgs.sort((a,b)=>b.ts-a.ts);
      if(!allMsgs.length){body.innerHTML='<p style="color:var(--muted);padding:20px">Mesaj yok.</p>';return;}
      let h=`<div class="admin-section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
          <div class="admin-sec-title" style="margin:0">Son Mesajlar (${allMsgs.length})</div>
          <button class="a-btn red" onclick="adminClearAllMsgs()">üóëÔ∏è T√ºm√ºn√º Sil</button>
        </div>
        <div class="admin-card">`;
      allMsgs.forEach(m=>{
        const txt=m.file?`üìé ${m.file.name||'Dosya'}`:m.text;
        h+=`<div class="admin-row" style="align-items:flex-start">
          <div class="admin-row-av" style="background:${strColor(m.user)};flex-shrink:0">${initials(m.user)}</div>
          <div class="admin-row-info">
            <div class="admin-msg-room"># ${esc(m._roomName)}</div>
            <div class="admin-msg-text">${esc(txt).slice(0,120)}${txt.length>120?'‚Ä¶':''}</div>
            <div class="admin-msg-meta">
              <div class="admin-msg-user">${esc(m.user)}</div>
              <div class="admin-msg-ts">${fmtTime(m.ts)} ¬∑ ${formatDate(new Date(m.ts))}</div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0;margin-top:2px">
            <button class="a-btn blue" onclick="adminEditMsg('${m._roomId}','${m._key}',this)">‚úèÔ∏è</button>
            <button class="a-btn red" onclick="adminDeleteMsgFromPanel('${m._roomId}','${m._key}')">üóëÔ∏è</button>
          </div>
        </div>`;
      });
      h+='</div></div>';
      body.innerHTML=h;
    }
  }).catch(e=>{ body.innerHTML='<p style="color:var(--muted);padding:20px">Y√ºklenemedi.</p>'; });
}
async function adminDeleteMsgFromPanel(roomId,key){
  if(!confirm('Bu mesajƒ± sil?'))return;
  try{
    await adminRestDelete('msgs/'+roomId+'/'+key);
    showToast('Mesaj silindi.');loadAdminMsgs();
  }catch(e){showToast('Hata.');}
}

/* ‚îÄ‚îÄ Admin: Announce ‚îÄ‚îÄ */
async function loadAdminAnnounce(){
  const body=document.getElementById('adminBody');
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  const rooms=await adminRestGet('rooms').catch(()=>null)||{};
  {
    const list=Object.values(rooms).filter(r=>r.type!=='dm');
    let opts=`<option value="__all__">üì£ T√ºm Kanallara</option>`;
    list.forEach(r=>{opts+=`<option value="${r.id}">${r.type==='group'?'üë•':'#'} ${esc(r.name||r.id)}</option>`;});
    body.innerHTML=`
    <div class="admin-section">
      <div class="admin-sec-title">Duyuru G√∂nder</div>
      <select class="announce-select" id="announceRoom">${opts}</select>
      <textarea class="announce-textarea" id="announceText" placeholder="Duyuru metni..." rows="5"></textarea>
      <button class="admin-submit" onclick="adminSendAnnounce()">üì£ Duyuruyu G√∂nder</button>
    </div>
    <div class="admin-section" style="margin-top:12px">
      <div class="admin-sec-title" style="margin-bottom:8px">üí° ƒ∞pucu</div>
      <div style="background:var(--surface);border-radius:8px;padding:12px;font-size:.82rem;color:var(--muted);line-height:1.6">
        Duyurular sistem mesajƒ± olarak g√∂nderilir ve t√ºm kullanƒ±cƒ±lar tarafƒ±ndan g√∂r√ºl√ºr. "T√ºm Kanallara" se√ßeneƒüi her kanala ayrƒ± ayrƒ± g√∂nderir.
      </div>
    </div>`;
  }
}
async function adminSendAnnounce(){
  const roomVal=document.getElementById('announceRoom').value;
  const text=document.getElementById('announceText').value.trim();
  if(!text){showToast('Duyuru metni girin.');return;}
  try{
    const rooms=await adminRestGet('rooms').catch(()=>({}))||{};
    const targets=roomVal==='__all__'
      ?Object.values(rooms).filter(r=>r.type!=='dm').map(r=>r.id)
      :[roomVal];
    const key=Date.now().toString(36)+'_ann';
    await Promise.all(targets.map(rid=>adminRestSet('msgs/'+rid+'/'+key,{sys:true,text:`üì£ Admin Duyurusu: ${text}`,ts:Date.now()})));
    showToast(`Duyuru ${targets.length} odaya g√∂nderildi!`);
    document.getElementById('announceText').value='';
  }catch(e){showToast('Hata olu≈ütu.');}
}


/* ‚îÄ‚îÄ Admin: Rename User ‚îÄ‚îÄ */
async function adminRenameUser(username){
  const newName = prompt(`"${username}" kullanƒ±cƒ±sƒ±nƒ±n yeni adƒ±:`, username);
  if(!newName || newName.trim()===username) return;
  const n = newName.trim();
  if(n.length<2){showToast('En az 2 karakter!');return;}
  if(!/^[a-zA-Z0-9√ßƒüƒ±≈ü√∂√º√áƒûƒ∞≈û√ñ√ú _.\-]+$/.test(n)){showToast('Ge√ßersiz karakter!');return;}
  // Copy user data to new key, delete old
  try{
    const data = await adminRestGet('users/'+username);
    if(!data){showToast('Kullanƒ±cƒ± bulunamadƒ±.');return;}
    data.username = n;
    await adminRestSet('users/'+n,data);
    await adminRestDelete('users/'+username);
    showToast(`"${username}" ‚Üí "${n}" olarak g√ºncellendi.`);
    loadAdminUsers();
  }catch(e){showToast('Hata olu≈ütu.');}
}

async function adminRemoveAdmin(username){
  if(!confirm(`${username} kullanƒ±cƒ±sƒ±nƒ±n admin yetkisi alƒ±nsƒ±n mƒ±?`))return;
  try{
    await Promise.all([adminRestDelete('users/'+username+'/isAdmin'),adminRestDelete('admins/'+username)]);
    showToast(username+' admin yetkisi alƒ±ndƒ±.');loadAdminUsers();
  }catch(e){showToast('Hata olu≈ütu.');}
}

async function adminResetPassword(username){
  const newPass = prompt('üë§ ' + username + ' i√ßin yeni ≈üifre girin:');
  if(!newPass || newPass.trim().length < 3){
    if(newPass !== null) alert('≈ûifre en az 3 karakter olmalƒ±.');
    return;
  }
  const newHash = await hashStr(newPass.trim() + username);
  try{
    await adminRestSet('users/'+username+'/passwordHash',newHash);
    showToast('‚úÖ ' + username + ' ≈üifresi g√ºncellendi!');
  }catch(e){showToast('‚ùå Hata olu≈ütu.');}
}
async function adminDeleteUser(username){
  if(!confirm(username+' kullanƒ±cƒ±sƒ± kalƒ±cƒ± olarak silinsin mi? Bu i≈ülem geri alƒ±namaz!'))return;
  try{
    await Promise.all([adminRestDelete('users/'+username),adminRestDelete('online/'+username),adminRestDelete('friends/'+username),adminRestDelete('friendRequests/'+username),adminRestDelete('friendRequestsSent/'+username),adminRestDelete('admins/'+username)]);
    showToast('‚úÖ '+username+' silindi.'); loadAdminUsers();
  }catch(e){ showToast('‚ùå Hata: '+(e&&e.message||'Bilinmiyor')); }
}

/* ‚îÄ‚îÄ Admin: Rename Room ‚îÄ‚îÄ */
async function adminRenameRoom(id, oldName){
  const newName = prompt(`Odanƒ±n yeni adƒ±:`, oldName);
  if(!newName || newName.trim()===oldName) return;
  const n = newName.trim();
  if(!n){showToast('Ad bo≈ü olamaz!');return;}
  try{
    await adminRestSet('rooms/'+id+'/name',n);
    showToast(`Oda adƒ± "${n}" olarak g√ºncellendi.`);
    loadAdminRooms(); loadRooms();
  }catch(e){showToast('Hata olu≈ütu.');}
}

/* ‚îÄ‚îÄ Admin: Edit Message ‚îÄ‚îÄ */
async function adminEditMsg(roomId, key, btn){
  try{
    const oldText=await adminRestGet('msgs/'+roomId+'/'+key+'/text').catch(()=>'')||'';
    const newText=prompt('Mesajƒ± d√ºzenle:',oldText);
    if(newText===null||newText.trim()===oldText)return;
    const t=newText.trim();
    if(!t){showToast('Mesaj bo≈ü olamaz!');return;}
    await adminRestSet('msgs/'+roomId+'/'+key+'/text',t);
    showToast('Mesaj g√ºncellendi.');loadAdminMsgs();
  }catch(e){showToast('Hata.');}
}

/* ‚îÄ‚îÄ Admin: Forum ‚îÄ‚îÄ */
async function loadAdminForum(){
  const body = document.getElementById('adminBody');
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  const postsRaw = await adminRestGet('forum/posts').catch(()=>null)||{};
  try{
    const posts = postsRaw;
    const arr = Object.entries(posts).map(([k,v])=>({...v,_key:k})).sort((a,b)=>b.ts-a.ts);
    if(!arr.length){body.innerHTML='<p style="color:var(--muted);padding:20px">Forum payla≈üƒ±mƒ± yok.</p>';return;}
    let h=`<div class="admin-section"><div class="admin-sec-title">Forum Payla≈üƒ±mlarƒ± (${arr.length})</div><div class="admin-card">`;
    arr.forEach(p=>{
      const commentCount = p.comments ? Object.keys(p.comments).length : 0;
      const likeCount = p.likes ? Object.keys(p.likes).length : 0;
      const catLabel = {genel:'üí¨',tarih:'üìú',kultur:'üé≠',spor:'‚öΩ',muzik:'üéµ',teknoloji:'üíª',soru:'‚ùì'}[p.cat]||'üí¨';
      h+=`<div class="admin-row" style="align-items:flex-start">
        <div class="admin-row-av" style="background:${strColor(p.user)};flex-shrink:0">${initials(p.user)}</div>
        <div class="admin-row-info">
          <div class="admin-row-name">${esc(p.user)} <span style="font-size:.65rem;color:var(--muted)">${catLabel} ${p.cat||'genel'}</span></div>
          <div class="admin-msg-text">${esc(p.text).slice(0,100)}${p.text&&p.text.length>100?'‚Ä¶':''}</div>
          <div class="admin-msg-meta">
            <span style="color:var(--muted);font-size:.68rem">‚ù§Ô∏è${likeCount} ¬∑ üí¨${commentCount} ¬∑ ${formatDate(new Date(p.ts))} ${fmtTime(p.ts)}</span>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;flex-shrink:0">
          <button class="a-btn blue" onclick="adminEditForumPost('${p._key}',this)">‚úèÔ∏è</button>
          <button class="a-btn red" onclick="adminDeleteForumPost('${p._key}')">üóëÔ∏è</button>
        </div>
      </div>`;
    });
    h+='</div></div>';
    body.innerHTML=h;
  }catch(e){body.innerHTML='<p style="color:var(--muted);padding:20px">Y√ºklenemedi.</p>';}
}
async function adminEditForumPost(key, btn){
  try{
    const oldText=await adminRestGet('forum/posts/'+key+'/text').catch(()=>'')||'';
    const newText=prompt('Payla≈üƒ±mƒ± d√ºzenle:',oldText);
    if(newText===null||newText.trim()===oldText)return;
    const t=newText.trim();
    if(!t){showToast('Metin bo≈ü olamaz!');return;}
    await adminRestSet('forum/posts/'+key+'/text',t);
    showToast('G√ºncellendi.');loadAdminForum();
  }catch(e){showToast('Hata.');}
}
async function adminDeleteForumPost(key){
  if(!confirm('Bu forum payla≈üƒ±mƒ±nƒ± sil?'))return;
  try{
    await adminRestDelete('forum/posts/'+key);
    showToast('Silindi.');loadAdminForum();
  }catch(e){showToast('Hata.');}
}

/* ‚îÄ‚îÄ Admin: Settings ‚îÄ‚îÄ */
async function loadAdminSettings(){
  const body = document.getElementById('adminBody');
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  const s = await adminRestGet('settings').catch(()=>null)||{};
  try{
    {
    const appName = esc(s.appName||'Nature.co');
    const welcomeMsg = esc(s.welcomeMsg||'');
    const msgLimit = s.msgLimit||100;
    const regOpen = (s.registration||'open')==='open';
    const inviteCode = esc(s.inviteCode||'');

    let html = '<div class="admin-section">';
    html += '<div class="admin-sec-title">‚öôÔ∏è Uygulama Ayarlarƒ±</div>';
    html += '<div class="admin-card" style="padding:14px;display:flex;flex-direction:column;gap:14px;">';

    html += '<div><div class="admin-sec-title" style="margin-bottom:6px">Uygulama Adƒ±</div>';
    html += '<div style="display:flex;gap:8px">';
    html += '<input class="admin-inp" id="setAppName" value="'+appName+'" placeholder="Uygulama adƒ±..." style="margin-bottom:0;flex:1">';
    html += `<button class="a-btn blue" onclick="saveAdminSetting('appName','setAppName','G√ºncellendi.')">Kaydet</button>`;
    html += '</div></div>';

    html += '<div><div class="admin-sec-title" style="margin-bottom:6px">Ho≈ügeldin Mesajƒ±</div>';
    html += '<div style="display:flex;gap:8px">';
    html += '<input class="admin-inp" id="setWelcome" value="'+welcomeMsg+'" placeholder="Yeni √ºyelere mesaj..." style="margin-bottom:0;flex:1">';
    html += `<button class="a-btn blue" onclick="saveAdminSetting('welcomeMsg','setWelcome','G√ºncellendi.')">Kaydet</button>`;
    html += '</div></div>';

    const srvLabel = (typeof FB_SERVERS !== 'undefined' && _activeServer && FB_SERVERS[_activeServer]) ? FB_SERVERS[_activeServer].label : (_activeServer||'Bu Sunucu');
    html += '<div><div class="admin-sec-title" style="margin-bottom:6px">üîê √úye Kaydƒ± ‚Äî <span style="color:var(--primary)">' + srvLabel + '</span></div>';
    html += '<div style="background:var(--bg);border-radius:10px;padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px">';
    html += '<div>';
    html += '<div style="font-size:13px;font-weight:600;color:var(--text-hi)">' + (regOpen ? '‚úÖ Kayƒ±t A√ßƒ±k' : 'üîí Kayƒ±t Kapalƒ±') + '</div>';
    html += '<div style="font-size:11px;color:var(--muted);margin-top:3px">' + (regOpen ? 'Yeni √ºyeler kayƒ±t olabilir' : 'Yeni √ºye alƒ±mƒ± durduruldu') + '</div>';
    html += '</div>';
    html += '<button id="regToggleBtn" onclick="toggleRegistration()" style="padding:10px 20px;border-radius:8px;border:none;font-weight:700;font-size:13px;cursor:pointer;background:' + (regOpen ? '#e74c3c' : '#2ecc71') + ';color:#fff">';
    html += regOpen ? 'üîí Kaydƒ± Durdur' : '‚úÖ Kaydƒ± A√ß';
    html += '</button>';
    html += '</div></div>';

    html += '<div><div class="admin-sec-title" style="margin-bottom:6px">Mesaj Ge√ßmi≈üi Sƒ±nƒ±rƒ±</div>';
    html += '<div style="display:flex;gap:8px">';
    html += '<input class="admin-inp" id="setMsgLimit" type="number" value="'+msgLimit+'" min="10" max="1000" style="margin-bottom:0;flex:1">';
    html += `<button class="a-btn blue" onclick="saveAdminSettingNum('msgLimit','setMsgLimit','G√ºncellendi.')">Kaydet</button>`;
    html += '</div></div>';

    html += '</div></div>';

    html += '<div class="admin-section" style="margin-top:12px">';
    html += '<div class="admin-sec-title">üóëÔ∏è Toplu ƒ∞≈ülemler</div>';
    html += '<div class="admin-card" style="padding:14px;display:flex;flex-direction:column;gap:10px;border-color:rgba(224,30,90,.25);">';
    html += '<div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">‚ö†Ô∏è Bu i≈ülemler geri alƒ±namaz. Dikkatli kullanƒ±n.</div>';
    html += '<button onclick="adminClearAllMsgs()" style="width:100%;padding:11px;border:1px solid rgba(224,30,90,.3);border-radius:9px;background:rgba(224,30,90,.12);color:#ff5a8a;font-weight:900;font-size:.88rem;cursor:pointer;">üóëÔ∏è T√ºm Mesajlarƒ± Sil (DM Dahil)</button>';
    html += '<button onclick="adminClearForumPosts()" style="width:100%;padding:11px;border:1px solid rgba(224,30,90,.3);border-radius:9px;background:rgba(224,30,90,.12);color:#ff5a8a;font-weight:900;font-size:.88rem;cursor:pointer;">üóëÔ∏è T√ºm Forum Payla≈üƒ±mlarƒ±nƒ± Sil</button>';
    html += '</div></div>';
    // ‚îÄ‚îÄ AI Asistan Key b√∂l√ºm√º ‚îÄ‚îÄ
    const aiKey = esc(s.openrouterKey||'');
    const aiKeyMasked = aiKey ? '‚úÖ Key kayƒ±tlƒ± (' + aiKey.slice(0,8) + '...)' : '‚ùå Key girilmemi≈ü';
    html += '<div class="admin-section" style="margin-top:12px">';
    html += '<div class="admin-sec-title">ü§ñ AI Mesaj Asistanƒ±</div>';
    html += '<div class="admin-card" style="padding:14px;display:flex;flex-direction:column;gap:10px;">';
    html += '<div style="font-size:.75rem;color:var(--muted);">OpenRouter API key giriniz ‚Äî t√ºm kullanƒ±cƒ±lar kendi key girmeden AI asistanƒ± kullanabilir.</div>';
    html += '<div style="font-size:.78rem;font-weight:700;color:' + (aiKey ? 'var(--green)' : '#e05555') + ';">' + aiKeyMasked + '</div>';
    html += '<div style="display:flex;gap:8px;">';
    html += '<input class="admin-inp" type="password" id="setAiKey" value="' + aiKey + '" placeholder="sk-or-..." style="margin-bottom:0;flex:1;">';
    html += '<button class="a-btn blue" onclick="saveAiKeyAdmin()">Kaydet</button>';
    html += '</div>';
    html += '<div style="font-size:.7rem;color:var(--muted);">√úcretsiz key: <a href="https://openrouter.ai/keys" target="_blank" style="color:var(--purple);">openrouter.ai/keys</a></div>';
    html += '</div></div>';

    // Davet kodu b√∂l√ºm√º
    html += '<div class="admin-section" style="margin-top:12px">';
    html += '<div class="admin-sec-title">üîë Davet Kodu</div>';
    html += '<div class="admin-card" style="padding:14px;"><div style="font-size:.75rem;color:var(--muted);margin-bottom:8px;">√úye kaydƒ± kapalƒ±yken kullanƒ±cƒ±larƒ±n kayƒ±t olabilmesi i√ßin kod.</div>';
    html += '<div style="display:flex;gap:8px;">';
    html += '<input class="admin-inp" id="setInviteCode" value="'+inviteCode+'" placeholder="√ñrn: NATURE2026" style="margin-bottom:0;flex:1;">';
    html += '<button class="a-btn purple" onclick="saveAdminSetting(\'inviteCode\',\'setInviteCode\',\'Davet kodu g√ºncellendi.\')">Kaydet</button>';
    html += '</div></div></div>';

    // ‚îÄ‚îÄ Yedekleme b√∂l√ºm√º ‚îÄ‚îÄ
    html += '<div class="admin-section" style="margin-top:12px"><div class="admin-sec-title">üì¶ Veri Yedekleme</div><div class="admin-card" style="padding:14px;display:flex;flex-direction:column;gap:8px;"><div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Se√ßilen verileri JSON formatƒ±nda indirin.</div>';
    ['users','rooms','msgs','forum/posts','settings'].forEach(function(p){
      html += '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:var(--surface2);border-radius:8px;"><input type="checkbox" id="bkp_'+p.replace('/','_')+'" checked><span style="font-size:.82rem;color:var(--text);">üìÅ '+p+'</span></label>';
    });
    html += '<button class="a-btn blue" style="width:100%;margin-top:4px;" onclick="execExportFromSettings()">‚¨áÔ∏è Yedek Al</button></div></div>';

    body.innerHTML = html;
  }}catch(e){ body.innerHTML='<p style="color:var(--muted);padding:20px">Y√ºklenemedi.</p>'; }
}

async function execExportFromSettings(){
  const paths=['users','rooms','msgs','forum/posts','settings'].filter(p=>{const el=document.getElementById('bkp_'+p.replace('/','_'));return el&&el.checked;});
  if(!paths.length){showToast('En az bir alan se√ßin.');return;}
  showToast('üì¶ Dƒ±≈üa aktarƒ±lƒ±yor...');
  const result={exportedAt:new Date().toISOString()};
  for(const p of paths){ try{result[p.replace('/','_')]=await adminRestGet(p);}catch(e){result[p.replace('/','_')]=null;} }
  const blob=new Blob([JSON.stringify(result,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='backup_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url);
  showToast('‚úÖ Yedek indirildi!');
}

async function toggleRegistration(){
  const btn = document.getElementById('regToggleBtn');
  if(!btn) return;
  const isOpening = btn.textContent.includes('A√ß');
  const newVal = isOpening ? 'open' : 'closed';
  btn.disabled = true;
  try{ await adminRestSet('settings/registration',newVal); showToast(isOpening?'‚úÖ Kayƒ±t a√ßƒ±ldƒ±!':'üîí Kayƒ±t durduruldu!'); loadAdminSettings(); }
  catch(e){ showToast('‚ùå Hata: '+(e&&e.message||'Bilinmiyor')); btn.disabled=false; }
}
async function saveAiKeyAdmin(){
  const val = (document.getElementById('setAiKey')?.value||'').trim();
  if(!val){ showToast('‚ùå Key bo≈ü olamaz'); return; }
  try{
    await adminRestSet('settings/openrouterKey', val);
    showToast('‚úÖ AI Key kaydedildi! T√ºm kullanƒ±cƒ±lar artƒ±k kullanabilir.');
    loadAdminSettings();
  }catch(e){ showToast('‚ùå Hata: '+(e?.message||'')); }
}

async function saveAdminSetting(key, inputId, successMsg){
  const val = document.getElementById(inputId).value.trim();
  try{ await adminRestSet('settings/'+key,val); showToast(successMsg); }
  catch(e){ showToast('‚ùå Hata: '+(e&&e.message||'Bilinmiyor')); }
}
async function saveAdminSettingNum(key, inputId, successMsg){
  const val = parseInt(document.getElementById(inputId).value)||100;
  try{ await adminRestSet('settings/'+key,val); showToast(successMsg); }catch(e){ showToast('‚ùå Hata: '+(e&&e.message||'')); }
}
async function adminClearAllMsgs(){
  if(!confirm('T√úM mesajlar (DM dahil) silinsin mi? Bu i≈ülem geri alƒ±namaz!'))return;
  try{
    const clearedAt = Date.now();
    const rooms = await adminRestGet('rooms')||{};
    await Promise.all(Object.keys(rooms).map(id=>adminRestSet('rooms/'+id+'/clearedAt',clearedAt)));
    await adminRestDelete('msgs');
    await adminRestDelete('dms');
    showToast('‚úÖ T√ºm mesajlar silindi.'); if(typeof loadAdminMsgs==='function')loadAdminMsgs();
  }catch(e){ console.error('adminClearAllMsgs:',e); showToast('‚ùå Hata: '+((e&&e.message)||'Bilinmiyor')); }
}
async function adminClearForumPosts(){
  if(!confirm('T√úM forum payla≈üƒ±mlarƒ± silinsin mi? Bu i≈ülem geri alƒ±namaz!'))return;
  try{ await adminRestDelete('forum/posts'); showToast('‚úÖ T√ºm forum payla≈üƒ±mlarƒ± silindi.'); if(typeof loadAdminForum==='function')loadAdminForum(); }
  catch(e){ showToast('‚ùå Hata: '+(e&&e.message||'Bilinmiyor')); }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üéÆ ADMIN: OYUN G√ñRSELLERI Y√ñNETƒ∞Mƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üéÆ OYUN G√ñRSELƒ∞ Y√ñNETƒ∞Mƒ∞ ‚Äî DOSYA Y√úKLEME
   G√∂rsele tƒ±klanƒ±nca dosya se√ßici a√ßƒ±lƒ±r,
   canvas ile 300x300'e k√º√ß√ºlt√ºl√ºr,
   base64 olarak Firebase Realtime DB'ye kaydedilir.
   Firebase Storage gerekmez.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

function loadAdminGames(){
  const body = document.getElementById('adminBody');
  body.innerHTML = '<p style="color:var(--muted);padding:20px;text-align:center;">Y√ºkleniyor...</p>';

  Promise.all([
    adminRestGet('settings/gameImages').catch(()=>({})),
    adminRestGet('settings/customGames').catch(()=>({}))
  ]).then(([customImgsRaw, customGamesRaw]) => {
    const customImgs  = customImgsRaw  || {};
    const customGamesObj = customGamesRaw || {};
    const customGamesList = Object.entries(customGamesObj).map(([id,g])=>({...g,id}));

    const cats = [
      { id:'io',       label:'üåê .io Oyunlar' },
      { id:'action',   label:'‚öîÔ∏è Aksiyon' },
      { id:'racing',   label:'üèéÔ∏è Yarƒ±≈ü' },
      { id:'strategy', label:'‚ôüÔ∏è Strateji' },
    ];

    let html = '<div class="admin-section">';

    // ‚îÄ‚îÄ √ñzel Oyunlar Y√∂netimi ‚îÄ‚îÄ
    html += `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <div class="admin-sec-title" style="margin:0">‚ûï √ñzel Oyunlarƒ±m</div>
      <button class="a-btn blue" onclick="showAddGameModal()" style="font-size:.78rem;padding:7px 14px;">+ Oyun Ekle</button>
    </div>`;

    if(customGamesList.length){
      html += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-bottom:20px;">`;
      customGamesList.forEach(g => {
        const imgSrc = customImgs[g.id] || g.img || '';
        html += `<div class="admin-card" style="padding:12px;display:flex;gap:10px;align-items:flex-start;">
          <div style="flex-shrink:0;cursor:pointer;" onclick="document.getElementById('gfile-${g.id}').click()" title="G√∂rsel deƒüi≈ütir">
            <input type="file" id="gfile-${g.id}" accept="image/*" style="display:none" onchange="uploadGameImage('${g.id}',this)">
            ${imgSrc
              ? `<img id="gimg-preview-${g.id}" src="${imgSrc}" style="width:56px;height:56px;border-radius:10px;object-fit:cover;border:2px solid #22c55e;"
                  onerror="this.style.display='none';document.getElementById('gimg-emoji-${g.id}').style.display='flex';">
                 <div id="gimg-emoji-${g.id}" style="display:none;width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,${g.color||'#8e44ad'}cc,${g.color||'#8e44ad'}66);align-items:center;justify-content:center;font-size:1.6rem;">${g.icon||'üéÆ'}</div>`
              : `<img id="gimg-preview-${g.id}" style="display:none;width:56px;height:56px;border-radius:10px;object-fit:cover;">
                 <div id="gimg-emoji-${g.id}" style="display:flex;width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,${g.color||'#8e44ad'}cc,${g.color||'#8e44ad'}66);align-items:center;justify-content:center;font-size:1.6rem;">${g.icon||'üéÆ'}</div>`
            }
          </div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:.82rem;font-weight:800;color:var(--text-hi);">${esc(g.name)}</div>
            <div style="font-size:.68rem;color:var(--muted);margin-bottom:2px;">${esc(g.cat)} ¬∑ ${esc(g.age||'0+')}</div>
            <div style="font-size:.65rem;color:var(--muted);word-break:break-all;margin-bottom:6px;">${esc(g.url)}</div>
            <button class="a-btn red" style="padding:3px 8px;font-size:.65rem;" onclick="deleteCustomGame('${g.id}')">üóëÔ∏è Sil</button>
          </div>
        </div>`;
      });
      html += `</div>`;
    } else {
      html += `<div style="background:var(--surface2);border:1px dashed var(--border);border-radius:12px;padding:20px;text-align:center;margin-bottom:20px;">
        <div style="font-size:1.8rem;margin-bottom:6px;">üéÆ</div>
        <div style="font-size:.8rem;color:var(--muted);">Hen√ºz √∂zel oyun eklenmedi.</div>
        <div style="font-size:.72rem;color:var(--muted);margin-top:4px;">Yukarƒ±daki "+ Oyun Ekle" butonunu kullanƒ±n.</div>
      </div>`;
    }

    html += `<div style="height:1px;background:var(--border);margin-bottom:20px;"></div>`;

    // ‚îÄ‚îÄ Mevcut oyunlarƒ±n g√∂rsel y√∂netimi ‚îÄ‚îÄ
    html += `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
      <div class="admin-sec-title" style="margin:0">üéÆ Oyun G√∂rselleri</div>
      <div style="font-size:.75rem;color:var(--muted);">G√∂rsele tƒ±klayarak bilgisayarƒ±nƒ±zdan dosya y√ºkleyin.</div>
    </div>`;

    cats.forEach(cat => {
      const games = GAME_CATALOG.filter(g => g.cat === cat.id);
      if(!games.length) return;
      html += `<div style="margin-bottom:24px;">
        <div style="font-size:.75rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">${cat.label}</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;">`;

      games.forEach(g => {
        const hasCustom = !!customImgs[g.id];
        const imgSrc = customImgs[g.id] || g.img || '';
        html += `<div class="admin-card" style="padding:10px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;position:relative;"
            onclick="document.getElementById('gfile-${g.id}').click()" title="G√∂rsel y√ºkle">
          <input type="file" id="gfile-${g.id}" accept="image/*" style="display:none" onchange="uploadGameImage('${g.id}',this)">
          <div style="position:relative;width:80px;height:80px;flex-shrink:0;">
            ${imgSrc
              ? `<img id="gimg-preview-${g.id}" src="${imgSrc}" alt="${g.name}"
                  style="width:80px;height:80px;border-radius:14px;object-fit:cover;border:2px solid ${hasCustom?'#22c55e':'var(--border)'};"
                  onerror="this.style.display='none';document.getElementById('gimg-emoji-${g.id}').style.display='flex';">
                <div id="gimg-emoji-${g.id}" style="display:none;width:80px;height:80px;border-radius:14px;background:linear-gradient(135deg,${g.color}cc,${g.color}66);align-items:center;justify-content:center;font-size:2.2rem;">${g.icon}</div>`
              : `<img id="gimg-preview-${g.id}" style="display:none;width:80px;height:80px;border-radius:14px;object-fit:cover;">
                 <div id="gimg-emoji-${g.id}" style="display:flex;width:80px;height:80px;border-radius:14px;background:linear-gradient(135deg,${g.color}cc,${g.color}66);align-items:center;justify-content:center;font-size:2.2rem;">${g.icon}</div>`
            }
            <div id="gimg-overlay-${g.id}" style="position:absolute;inset:0;border-radius:14px;background:rgba(0,0,0,0);display:flex;align-items:center;justify-content:center;transition:background .15s;font-size:1.4rem;opacity:0;">üì∑</div>
          </div>
          <div style="font-size:.75rem;font-weight:700;color:var(--text-hi);text-align:center;line-height:1.2;">${esc(g.name)}</div>
          <div id="gimg-status-${g.id}" style="font-size:.65rem;color:${hasCustom?'#22c55e':'var(--muted)'};">${hasCustom?'‚úÖ √ñzel':'Varsayƒ±lan'}</div>
          ${hasCustom ? `<button class="a-btn red" style="padding:3px 8px;font-size:.65rem;width:100%;" onclick="event.stopPropagation();resetGameImage('${g.id}')">üóëÔ∏è Sƒ±fƒ±rla</button>` : ''}
        </div>`;
      });

      html += '</div></div>';
    });

    html += '</div>';
    html += `<div class="admin-section" style="margin-top:4px;">
      <div class="admin-card" style="padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
        <div>
          <div style="font-size:.82rem;font-weight:700;color:var(--text-hi);">T√ºm √ñzel G√∂rselleri Sƒ±fƒ±rla</div>
          <div style="font-size:.72rem;color:var(--muted);">T√ºm oyunlar varsayƒ±lan g√∂rsellerine d√∂ner.</div>
        </div>
        <button class="a-btn red" style="flex-shrink:0;" onclick="resetAllGameImages()">üóëÔ∏è T√ºm√ºn√º Sƒ±fƒ±rla</button>
      </div>
    </div>`;

    body.innerHTML = html;

    // Hover efekti
    GAME_CATALOG.forEach(g => {
      const overlay = document.getElementById('gimg-overlay-'+g.id);
      if(!overlay) return;
      const card = overlay.closest('.admin-card');
      if(!card) return;
      card.addEventListener('mouseenter', ()=>{ overlay.style.opacity='1'; overlay.style.background='rgba(0,0,0,.45)'; });
      card.addEventListener('mouseleave', ()=>{ overlay.style.opacity='0'; overlay.style.background='rgba(0,0,0,0)'; });
    });

  }).catch(()=>{ body.innerHTML='<p style="color:var(--muted);padding:20px">Y√ºklenemedi.</p>'; });
}

/* Se√ßilen dosyayƒ± canvas ile k√º√ß√ºlt ‚Üí base64 ‚Üí Firebase'e kaydet */
function uploadGameImage(gameId, input){
  const file = input.files[0];
  if(!file) return;
  if(file.size > 5*1024*1024){ showToast('‚ùå Dosya 5MB\'dan k√º√ß√ºk olmalƒ±.'); input.value=''; return; }

  const statusEl = document.getElementById('gimg-status-'+gameId);
  if(statusEl){ statusEl.textContent = '‚è≥ Y√ºkleniyor...'; statusEl.style.color = 'var(--muted)'; }

  const reader = new FileReader();
  reader.onload = function(e){
    const img = new Image();
    img.onload = function(){
      const MAX = 300;
      let w = img.width, h = img.height;
      if(w > h){ h = Math.round(h * MAX / w); w = MAX; }
      else      { w = Math.round(w * MAX / h); h = MAX; }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      const base64 = canvas.toDataURL('image/jpeg', 0.85);

      const _sgimg=async()=>{ try{await adminRestSet('settings/gameImages/'+gameId,base64);}catch(e){await adminDbRef('settings/gameImages/'+gameId).set(base64);} };
      _sgimg().then(()=>{
        _customGameImages[gameId]=base64; _saveCgiCache();
        const preview=document.getElementById('gimg-preview-'+gameId);
        const emoji=document.getElementById('gimg-emoji-'+gameId);
        if(preview){preview.src=base64;preview.style.display='block';preview.style.border='2px solid #22c55e';}
        if(emoji)emoji.style.display='none';
        if(statusEl){statusEl.textContent='‚úÖ √ñzel';statusEl.style.color='#22c55e';}
        showToast('‚úÖ G√∂rsel kaydedildi!');
      }).catch(e=>{
        showToast('‚ùå Kaydetme hatasƒ±: '+(e&&e.message||'ƒ∞zin reddedildi'));
        if(statusEl){statusEl.textContent='Hata';statusEl.style.color='#e74c3c';}
      });
    };
    img.onerror = ()=>{ showToast('‚ùå G√∂rsel okunamadƒ±.'); if(statusEl){ statusEl.textContent='Hata'; statusEl.style.color='#e74c3c'; } };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
  input.value = '';
}

function resetGameImage(gameId){
  if(!confirm('Bu oyunun √∂zel g√∂rseli silinsin mi?')) return;
  adminRestDelete('settings/gameImages/'+gameId).then(()=>{
    delete _customGameImages[gameId];
    _saveCgiCache();
    showToast('G√∂rsel sƒ±fƒ±rlandƒ±.');
    loadAdminGames();
  }).catch(()=>showToast('‚ùå Sƒ±fƒ±rlama hatasƒ±.'));
}

function resetAllGameImages(){
  if(!confirm('T√úM √∂zel oyun g√∂rselleri silinsin mi?')) return;
  adminRestDelete('settings/gameImages').then(()=>{
    _customGameImages = {};
    _saveCgiCache();
    showToast('T√ºm g√∂rseller sƒ±fƒ±rlandƒ±.');
    loadAdminGames();
  }).catch(()=>showToast('‚ùå Sƒ±fƒ±rlama hatasƒ±.'));
}

function applyCustomGameImages(){ return Promise.resolve(); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚ûï √ñZEL OYUN EKLEME
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showAddGameModal(){
  const m = document.createElement('div');
  m.id = 'addGameModal';
  m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
  m.innerHTML = `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:22px;max-width:440px;width:100%;max-height:90vh;overflow-y:auto;">
      <div style="font-size:1rem;font-weight:900;color:var(--text-hi);margin-bottom:16px;">‚ûï Yeni Oyun Ekle</div>

      <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px;">Oyun Adƒ± <span style="color:#e74c3c">*</span></div>
      <input id="ag-name" class="admin-inp" placeholder="√ñrn: Snake Game" style="margin-bottom:10px;">

      <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px;">Oyun URL (iframe a√ßƒ±lacak) <span style="color:#e74c3c">*</span></div>
      <input id="ag-url" class="admin-inp" placeholder="https://..." style="margin-bottom:10px;">

      <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px;">Kategori</div>
      <select id="ag-cat" class="admin-inp" style="margin-bottom:10px;">
        <option value="io">üåê .io Oyunlar</option>
        <option value="action">‚öîÔ∏è Aksiyon</option>
        <option value="racing">üèéÔ∏è Yarƒ±≈ü</option>
        <option value="strategy">‚ôüÔ∏è Strateji</option>
      </select>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
        <div>
          <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px;">Emoji/ƒ∞kon</div>
          <input id="ag-icon" class="admin-inp" placeholder="üéÆ" maxlength="4" style="margin-bottom:0;">
        </div>
        <div>
          <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px;">Renk</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <input id="ag-color" type="color" value="#8e44ad" style="width:40px;height:34px;border-radius:6px;border:1px solid var(--border);cursor:pointer;background:none;padding:2px;">
            <span id="ag-color-val" style="font-size:.72rem;color:var(--muted);">#8e44ad</span>
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
        <div>
          <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px;">Kƒ±sa A√ßƒ±klama</div>
          <input id="ag-desc" class="admin-inp" placeholder="Eƒülenceli oyun!" style="margin-bottom:0;">
        </div>
        <div>
          <div style="font-size:.72rem;color:var(--muted);margin-bottom:4px;">Ya≈ü Sƒ±nƒ±rƒ±</div>
          <select id="ag-age" class="admin-inp" style="margin-bottom:0;">
            <option value="0+">0+</option>
            <option value="6+">6+</option>
            <option value="12+" selected>12+</option>
            <option value="16+">16+</option>
            <option value="18+">18+</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:16px;">
        <button class="a-btn blue" style="flex:1;" onclick="saveNewGame()">‚úÖ Kaydet</button>
        <button class="a-btn" style="flex:1;background:var(--surface2);" onclick="document.getElementById('addGameModal').remove()">ƒ∞ptal</button>
      </div>
    </div>`;
  document.body.appendChild(m);
  // Renk se√ßici preview
  document.getElementById('ag-color').addEventListener('input', function(){ document.getElementById('ag-color-val').textContent = this.value; });
  // Dƒ±≈üa tƒ±klayƒ±nca kapat
  m.addEventListener('click', function(e){ if(e.target===m) m.remove(); });
}

function saveNewGame(){
  const name  = document.getElementById('ag-name')?.value.trim();
  const url   = document.getElementById('ag-url')?.value.trim();
  const cat   = document.getElementById('ag-cat')?.value || 'io';
  const icon  = document.getElementById('ag-icon')?.value.trim() || 'üéÆ';
  const color = document.getElementById('ag-color')?.value || '#8e44ad';
  const desc  = document.getElementById('ag-desc')?.value.trim() || '';
  const age   = document.getElementById('ag-age')?.value || '12+';

  if(!name){ showToast('‚ùå Oyun adƒ± zorunlu!'); return; }
  if(!url || !url.startsWith('http')){ showToast('‚ùå Ge√ßerli bir URL girin!'); return; }

  // Benzersiz id √ºret
  const id = 'custom_' + name.toLowerCase().replace(/[^a-z0-9]/g,'').slice(0,12) + '_' + Date.now().toString(36);
  const gameData = { name, url, cat, icon, color, desc, age };

  adminRestSet('settings/customGames/' + id, gameData).then(()=>{
    // Belleƒüi g√ºncelle
    _customGames.push({...gameData, id, _custom:true});
    _saveCgCache();
    showToast('‚úÖ Oyun eklendi!');
    document.getElementById('addGameModal')?.remove();
    loadAdminGames();
  }).catch(()=>showToast('‚ùå Kaydetme hatasƒ±.'));
}

function deleteCustomGame(gameId){
  if(!confirm('Bu √∂zel oyun silinsin mi?')) return;
  adminRestDelete('settings/customGames/'+gameId).then(()=>{
    // G√∂rselini de sil
    adminRestDelete('settings/gameImages/'+gameId).catch(()=>{});
    delete _customGameImages[gameId];
    _customGames = _customGames.filter(g=>g.id!==gameId);
    _saveCgCache();
    _saveCgiCache();
    showToast('Oyun silindi.');
    loadAdminGames();
  }).catch(()=>showToast('‚ùå Silme hatasƒ±.'));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üõ°Ô∏è ADMIN: G√úVENLƒ∞K & GELƒ∞≈ûMƒ∞≈û YETKƒ∞LER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadAdminSecurity(){
  const body = document.getElementById('adminBody');
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  const s = await adminRestGet('settings').catch(()=>null)||{};
  try{
    {

    let html = '';

    // ‚îÄ‚îÄ Bakƒ±m Modu ‚îÄ‚îÄ
    html += `<div class="admin-section">
      <div class="admin-sec-title">üîß Bakƒ±m Modu</div>
      <div class="admin-card" style="padding:14px;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;">
          <div>
            <div style="font-size:.85rem;font-weight:700;color:var(--text-hi);">Bakƒ±m modunu ${s.maintenance?'kapat':'aktifle≈ütir'}</div>
            <div style="font-size:.75rem;color:var(--muted);margin-top:3px;">Aktifken sadece adminler giri≈ü yapabilir.</div>
          </div>
          <button class="a-btn ${s.maintenance?'green':'red'}" onclick="toggleMaintenance(${!s.maintenance})">
            ${s.maintenance?'‚úÖ Aktif ‚Äî Kapat':'üîß Kapalƒ± ‚Äî Aktifle≈ütir'}
          </button>
        </div>
        ${s.maintenance ? `<div style="margin-top:12px;display:flex;gap:8px;">
          <input class="admin-inp" id="maintMsg" value="${esc(s.maintenanceMsg||'Sistem bakƒ±mda, yakƒ±nda d√∂neceƒüiz!')}" placeholder="Bakƒ±m mesajƒ±..." style="margin-bottom:0;flex:1;">
          <button class="a-btn blue" onclick="saveAdminSetting('maintenanceMsg','maintMsg','Mesaj g√ºncellendi.')">Kaydet</button>
        </div>` : ''}
      </div>
    </div>`;

    // ‚îÄ‚îÄ Kullanƒ±cƒ± Limitleri ‚îÄ‚îÄ
    html += `<div class="admin-section">
      <div class="admin-sec-title">üë• Kullanƒ±cƒ± Limitleri</div>
      <div class="admin-card" style="padding:14px;display:flex;flex-direction:column;gap:12px;">
        <div>
          <div style="font-size:.78rem;color:var(--muted);margin-bottom:6px;">Maksimum kullanƒ±cƒ± sayƒ±sƒ± (0 = sƒ±nƒ±rsƒ±z)</div>
          <div style="display:flex;gap:8px;">
            <input class="admin-inp" id="setMaxUsers" type="number" value="${s.maxUsers||0}" min="0" style="margin-bottom:0;flex:1;">
            <button class="a-btn blue" onclick="saveAdminSettingNum('maxUsers','setMaxUsers','G√ºncellendi.')">Kaydet</button>
          </div>
        </div>
        <div>
          <div style="font-size:.78rem;color:var(--muted);margin-bottom:6px;">Minimum kullanƒ±cƒ± adƒ± uzunluƒüu</div>
          <div style="display:flex;gap:8px;">
            <input class="admin-inp" id="setMinUsername" type="number" value="${s.minUsernameLen||3}" min="2" max="10" style="margin-bottom:0;flex:1;">
            <button class="a-btn blue" onclick="saveAdminSettingNum('minUsernameLen','setMinUsername','G√ºncellendi.')">Kaydet</button>
          </div>
        </div>
        <div>
          <div style="font-size:.78rem;color:var(--muted);margin-bottom:6px;">Kullanƒ±cƒ± ba≈üƒ±na maks. oda sayƒ±sƒ±</div>
          <div style="display:flex;gap:8px;">
            <input class="admin-inp" id="setMaxRoomsUser" type="number" value="${s.maxRoomsPerUser||10}" min="1" style="margin-bottom:0;flex:1;">
            <button class="a-btn blue" onclick="saveAdminSettingNum('maxRoomsPerUser','setMaxRoomsUser','G√ºncellendi.')">Kaydet</button>
          </div>
        </div>
      </div>
    </div>`;

    // ‚îÄ‚îÄ Yasaklƒ± Kelimeler ‚îÄ‚îÄ
    html += `<div class="admin-section">
      <div class="admin-sec-title">üö´ Yasaklƒ± Kelimeler</div>
      <div class="admin-card" style="padding:14px;">
        <div style="font-size:.75rem;color:var(--muted);margin-bottom:8px;">Virg√ºlle ayƒ±rƒ±n. Bu kelimeler mesajlarda otomatik filtrelenecek.</div>
        <textarea class="admin-inp" id="setBannedWords" style="margin-bottom:8px;min-height:80px;resize:vertical;">${esc(s.bannedWords||'')}</textarea>
        <button class="a-btn blue" onclick="saveAdminSetting('bannedWords','setBannedWords','Yasaklƒ± kelimeler g√ºncellendi.')">Kaydet</button>
      </div>
    </div>`;

    // ‚îÄ‚îÄ Susturma Y√∂netimi ‚îÄ‚îÄ
    html += `<div class="admin-section">
      <div class="admin-sec-title">üîá Susturulan Kullanƒ±cƒ±lar</div>
      <div class="admin-card" style="padding:14px;">
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <input class="admin-inp" id="muteUsername" placeholder="Kullanƒ±cƒ± adƒ±..." style="margin-bottom:0;flex:1;" autocorrect="off" autocapitalize="off">
          <input class="admin-inp" id="muteDuration" type="number" value="60" min="1" placeholder="Dakika" style="margin-bottom:0;width:90px;">
          <button class="a-btn red" onclick="adminMuteUser()">üîá Sustur</button>
        </div>`;

    // Muted users listesi
    const mutedList = Object.entries(s.mutedUsers||{}).filter(([,v])=>v>Date.now());
    if(mutedList.length){
      mutedList.forEach(([u, until])=>{
        const remaining = Math.ceil((until-Date.now())/60000);
        html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);">
          <div>
            <div style="font-size:.82rem;font-weight:700;color:var(--text-hi);">${esc(u)}</div>
            <div style="font-size:.7rem;color:var(--red);">‚è± ${remaining} dk kaldƒ±</div>
          </div>
          <button class="a-btn green" style="font-size:.72rem;" onclick="adminUnmuteUser('${esc(u)}')">Sesi A√ß</button>
        </div>`;
      });
    } else {
      html += '<div style="font-size:.78rem;color:var(--muted);">Susturulan kullanƒ±cƒ± yok.</div>';
    }
    html += `</div></div>`;

    // ‚îÄ‚îÄ IP & Aktivite Loglarƒ± ‚îÄ‚îÄ
    html += `<div class="admin-section">
      <div class="admin-sec-title">üìã Aktivite Loglarƒ±</div>
      <div class="admin-card" style="padding:14px;">
        <button class="a-btn blue" style="margin-bottom:10px;width:100%;" onclick="loadActivityLogs()">üìã Son 50 Giri≈üi G√∂ster</button>
        <div id="activityLogsBody" style="font-size:.75rem;color:var(--muted);">Butona basarak loglarƒ± y√ºkleyin.</div>
      </div>
    </div>`;

    // ‚îÄ‚îÄ Toplu Bildirim ‚îÄ‚îÄ
    html += `<div class="admin-section">
      <div class="admin-sec-title">üì¢ Toplu Bildirim G√∂nder</div>
      <div class="admin-card" style="padding:14px;display:flex;flex-direction:column;gap:10px;">
        <input class="admin-inp" id="broadcastTitle" placeholder="Bildirim ba≈ülƒ±ƒüƒ±..." style="margin-bottom:0;">
        <textarea class="admin-inp" id="broadcastMsg" placeholder="Bildirim mesajƒ±..." style="margin-bottom:0;min-height:60px;resize:vertical;"></textarea>
        <button class="a-btn blue" onclick="adminSendBroadcast()">üì¢ T√ºm Kullanƒ±cƒ±lara G√∂nder</button>
      </div>
    </div>`;

    // ‚îÄ‚îÄ Tehlikeli B√∂lge ‚îÄ‚îÄ
    html += `<div class="admin-section">
      <div class="admin-sec-title" style="color:var(--red);">‚ö†Ô∏è Tehlikeli B√∂lge</div>
      <div class="admin-card" style="padding:14px;border-color:rgba(224,85,85,.3);display:flex;flex-direction:column;gap:10px;">
        <button class="admin-submit" style="background:var(--red);margin:0;" onclick="adminForceLogoutAll()">üö™ T√ºm Kullanƒ±cƒ±larƒ± √áƒ±kƒ±≈ü Yaptƒ±r</button>
        <button class="admin-submit" style="background:var(--red);margin:0;" onclick="adminClearAllMsgs()">üóëÔ∏è T√ºm Mesajlarƒ± Sil</button>
        <button class="admin-submit" style="background:var(--red);margin:0;" onclick="adminClearForumPosts()">üóëÔ∏è T√ºm Forum G√∂nderilerini Sil</button>
        <button class="admin-submit" style="background:#7f3f3f;margin:0;" onclick="adminDeleteInactiveUsers()">üë§ Pasif Kullanƒ±cƒ±larƒ± Temizle (30 g√ºn+)</button>
      </div>
    </div>`;

    body.innerHTML = html;
  }}catch(e){ body.innerHTML='<p style="color:var(--muted);padding:20px">Y√ºklenemedi.</p>'; }
}

async function toggleMaintenance(enable){
  if(enable && !confirm('Bakƒ±m modu aktifle≈ütirilsin mi? Adminler dƒ±≈üƒ±nda kimse giri≈ü yapamaz!')) return;
  try{
    await adminRestSet('settings/maintenance',enable);
    showToast(enable ? 'üîß Bakƒ±m modu aktif.' : '‚úÖ Bakƒ±m modu kapatƒ±ldƒ±.');
    loadAdminSecurity();
  }catch(e){showToast('Hata: '+(e&&e.message||''));}
}

async function adminMuteUser(){
  const username = document.getElementById('muteUsername').value.trim();
  const minutes = parseInt(document.getElementById('muteDuration').value)||60;
  if(!username){ showToast('Kullanƒ±cƒ± adƒ± girin.'); return; }
  const until = Date.now() + minutes * 60 * 1000;
  try{
    await Promise.all([
      adminRestSet('settings/mutedUsers/'+username,until),
      adminRestSet('users/'+username+'/mutedUntil',until)
    ]);
    showToast(`üîá ${username} ${minutes} dakika susturuldu.`);
    loadAdminSecurity();
  }catch(e){showToast('Hata.');}
}

async function adminUnmuteUser(username){
  try{
    await Promise.all([
      adminRestDelete('settings/mutedUsers/'+username),
      adminRestDelete('users/'+username+'/mutedUntil')
    ]);
    showToast(`üîä ${username} sesinin kƒ±sƒ±tlamasƒ± kaldƒ±rƒ±ldƒ±.`);
    loadAdminSecurity();
  }catch(e){showToast('Hata.');}
}

function loadActivityLogs(){
  const logsBody = document.getElementById('activityLogsBody');
  if(logsBody) logsBody.innerHTML = '<div class="ld"><span></span><span></span><span></span></div>';
  dbRef('activityLog').limitToLast(50).once('value').then(snap=>{
    const logs = snap.val()||{};
    const arr = Object.values(logs).reverse();
    if(!arr.length){
      if(logsBody) logsBody.innerHTML = '<div style="color:var(--muted);font-size:.78rem;">Log kaydƒ± bulunamadƒ±.</div>';
      return;
    }
    let h = '';
    arr.forEach(log=>{
      const t = log.ts ? new Date(log.ts).toLocaleString('tr-TR') : '?';
      h += `<div style="padding:6px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:10px;">
        <div>
          <span style="font-weight:700;color:var(--text-hi);">${esc(log.user||'?')}</span>
          <span style="color:var(--muted);"> ¬∑ ${esc(log.action||'giri≈ü')}</span>
        </div>
        <div style="color:var(--muted);font-size:.68rem;white-space:nowrap;">${t}</div>
      </div>`;
    });
    if(logsBody) logsBody.innerHTML = h;
  }).catch(()=>{ if(logsBody) logsBody.innerHTML = '<div style="color:var(--muted);">Loglar y√ºklenemedi.</div>'; });
}

function adminSendBroadcast(){
  const title = document.getElementById('broadcastTitle').value.trim();
  const msg = document.getElementById('broadcastMsg').value.trim();
  if(!title||!msg){ showToast('Ba≈ülƒ±k ve mesaj gerekli.'); return; }
  if(!confirm(`T√ºm kullanƒ±cƒ±lara bildirim g√∂nderilsin mi?\n\n"${title}"`)) return;
  const data = { title, msg, ts: Date.now(), from: _cu };
  adminRestSet('broadcasts/'+Date.now(),data).then(()=>{
    showToast('üì¢ Bildirim g√∂nderildi!');
    document.getElementById('broadcastTitle').value='';
    document.getElementById('broadcastMsg').value='';
  }).catch(()=>showToast('Hata.'));
}

async function adminForceLogoutAll(){
  if(!confirm('T√úM kullanƒ±cƒ±lar √ßƒ±kƒ±≈ü yaptƒ±rƒ±lsƒ±n mƒ±? Bu i≈ülem geri alƒ±namaz!')) return;
  try{
    await adminRestSet('forceLogout',{ ts: Date.now(), by: _cu });
    showToast('üö™ T√ºm kullanƒ±cƒ±lar √ßƒ±kƒ±≈ü yaptƒ±rƒ±ldƒ±.');
  }catch(e){showToast('Hata.');}
}

async function adminDeleteInactiveUsers(){
  if(!confirm('30 g√ºnden fazla s√ºredir giri≈ü yapmayan kullanƒ±cƒ±lar silinsin mi?')) return;
  try{
    const cutoff = Date.now()-30*24*60*60*1000;
    const users = await adminRestGet('users')||{};
    const toDelete = Object.entries(users).filter(([k,v])=>!v.isAdmin&&(!v.lastSeen||v.lastSeen<cutoff)).map(([k])=>k);
    if(!toDelete.length){ showToast('Silinecek pasif kullanƒ±cƒ± yok.'); return; }
    if(!confirm(toDelete.length+' pasif kullanƒ±cƒ± silinecek. Devam edilsin mi?')) return;
    await Promise.all(toDelete.flatMap(u=>[adminRestDelete('users/'+u),adminRestDelete('online/'+u),adminRestDelete('friends/'+u),adminRestDelete('friendRequests/'+u),adminRestDelete('friendRequestsSent/'+u)]));
    showToast('‚úÖ '+toDelete.length+' kullanƒ±cƒ± silindi.'); loadAdminUsers();
  }catch(e){ showToast('‚ùå Hata: '+(e&&e.message||'Bilinmiyor')); }
}


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üëë GENƒ∞≈ûLETƒ∞LMƒ∞≈û ADMƒ∞N YETKƒ∞LERƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Kullanƒ±cƒ± Profil D√ºzenleme ‚îÄ‚îÄ */
async function adminEditUserProfile(username) {
  const u = await adminRestGet('users/'+username).catch(()=>null)||{};
  {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
    modal.innerHTML = `
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:22px;max-width:420px;width:100%;max-height:85vh;overflow-y:auto;">
        <div style="font-size:1rem;font-weight:900;color:var(--text-hi);margin-bottom:16px;">‚úèÔ∏è Profil D√ºzenle ‚Äî ${esc(username)}</div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div>
            <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">G√∂r√ºnen Ad</div>
            <input id="ep-displayName" class="admin-inp" value="${esc(u.displayName||username)}" style="margin-bottom:0;">
          </div>
          <div>
            <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Biyografi</div>
            <textarea id="ep-bio" class="admin-inp" style="margin-bottom:0;min-height:60px;resize:vertical;">${esc(u.bio||'')}</textarea>
          </div>
          <div>
            <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Rozet / Unvan</div>
            <input id="ep-badge" class="admin-inp" value="${esc(u.badge||'')}" placeholder="√∂rn: ‚≠ê VIP" style="margin-bottom:0;">
          </div>
          <div>
            <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Yeni ≈ûifre (bo≈ü = deƒüi≈ütirme)</div>
            <input id="ep-password" class="admin-inp" type="password" placeholder="Yeni ≈üifre..." style="margin-bottom:0;">
          </div>
          <div style="display:flex;align-items:center;gap:10px;padding:8px 0;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" id="ep-verified" ${u.verified?'checked':''}>
              <span style="font-size:.82rem;color:var(--text);">‚úÖ Doƒürulanmƒ±≈ü hesap</span>
            </label>
          </div>
          <div style="display:flex;align-items:center;gap:10px;padding:4px 0;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" id="ep-vip" ${u.isVip?'checked':''}>
              <span style="font-size:.82rem;color:var(--text);">üëë VIP kullanƒ±cƒ±</span>
            </label>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:18px;">
          <button class="a-btn blue" style="flex:1;" onclick="adminSaveUserProfile('${esc(username)}',this.closest('[style*=fixed]'))">üíæ Kaydet</button>
          <button class="a-btn" style="flex:1;background:var(--surface2);" onclick="this.closest('[style*=fixed]').remove()">ƒ∞ptal</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }
}

async function adminSaveUserProfile(username, modal) {
  const displayName = document.getElementById('ep-displayName').value.trim();
  const bio = document.getElementById('ep-bio').value.trim();
  const badge = document.getElementById('ep-badge').value.trim();
  const newPass = document.getElementById('ep-password').value.trim();
  const verified = document.getElementById('ep-verified').checked;
  const isVip = document.getElementById('ep-vip').checked;

  const updates = { displayName: displayName||username, bio, badge, verified, isVip };

  if(newPass){
    if(newPass.length < 6){ showToast('≈ûifre min 6 karakter.'); return; }
    updates.passwordHash = await hashStr(username + ':' + newPass);
  }

  try{
    // update: get existing and merge
    const existing = await adminRestGet('users/'+username).catch(()=>({}))||{};
    await adminRestSet('users/'+username, {...existing, ...updates});
    showToast('‚úÖ Profil g√ºncellendi!');
    if(modal) modal.remove();
    loadAdminUsers();
  }catch(e){showToast('Hata olu≈ütu.');}
}

/* ‚îÄ‚îÄ Kullanƒ±cƒ± Mesaj Ge√ßmi≈üi ‚îÄ‚îÄ */
function adminViewUserMessages(username){
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
  modal.innerHTML = `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:20px;max-width:500px;width:100%;max-height:80vh;display:flex;flex-direction:column;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div style="font-size:.95rem;font-weight:900;color:var(--text-hi);">üí¨ ${esc(username)} ‚Äî Mesaj Ge√ßmi≈üi</div>
        <button onclick="this.closest('[style*=fixed]').remove()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.3rem;">‚úï</button>
      </div>
      <div id="userMsgHistory" style="flex:1;overflow-y:auto;font-size:.8rem;">
        <div class="ld"><span></span><span></span><span></span></div>
      </div>
    </div>`;
  document.body.appendChild(modal);

  // T√ºm odalardaki mesajlarƒ± tara
  adminRestGet('msgs').then(msgsData=>{
    const allRooms = msgsData||{};
    const userMsgs = [];
    Object.entries(allRooms).forEach(([roomId, msgs])=>{
      Object.entries(msgs||{}).forEach(([key, m])=>{
        if(m.user === username) userMsgs.push({...m, roomId, key});
      });
    });
    userMsgs.sort((a,b)=>b.ts-a.ts);
    const el = document.getElementById('userMsgHistory');
    if(!el) return;
    if(!userMsgs.length){ el.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px;">Mesaj bulunamadƒ±.</div>'; return; }
    el.innerHTML = userMsgs.slice(0,100).map(m=>`
      <div style="padding:8px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:8px;align-items:flex-start;">
        <div style="flex:1;">
          <div style="font-size:.7rem;color:var(--accent);margin-bottom:2px;">#${esc(m.roomId)}</div>
          <div style="color:var(--text);">${esc(m.text||'[dosya/gif]').slice(0,200)}</div>
        </div>
        <div style="flex-shrink:0;text-align:right;">
          <div style="font-size:.65rem;color:var(--muted);">${new Date(m.ts||0).toLocaleString('tr-TR')}</div>
          <button onclick="adminRestDelete('msgs/'+this.dataset.room+'/'+this.dataset.key).then(()=>{this.closest('div[style*=padding]').remove();showToast('Silindi.');}).catch(()=>showToast('Hata.'))"
            data-room="${esc(m.roomId)}" data-key="${esc(m.key)}"
            style="margin-top:4px;background:var(--red);border:none;border-radius:5px;color:#fff;font-size:.62rem;padding:2px 7px;cursor:pointer;">Sil</button>
        </div>
      </div>`).join('');
  });
}

/* ‚îÄ‚îÄ Kullanƒ±cƒ± Detay Popup ‚îÄ‚îÄ */
async function adminUserDetails(username){
  const u = await adminRestGet('users/'+username).catch(()=>null)||{};
  {
    const isOnline = !!_online[username];
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
    modal.innerHTML = `
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:22px;max-width:400px;width:100%;">
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px;">
          <div style="width:56px;height:56px;border-radius:14px;background:${strColor(username)};display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:900;color:#fff;">${username.slice(0,2).toUpperCase()}</div>
          <div>
            <div style="font-size:1rem;font-weight:900;color:var(--text-hi);">${esc(u.displayName||username)}</div>
            <div style="font-size:.75rem;color:${isOnline?'#2ecc71':'var(--muted)'};">${isOnline?'üü¢ √áevrimi√ßi':'‚ö´ √áevrimdƒ±≈üƒ±'}</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:.78rem;margin-bottom:16px;">
          <div style="background:var(--surface2);border-radius:10px;padding:10px;">
            <div style="color:var(--muted);margin-bottom:2px;">Kayƒ±t Tarihi</div>
            <div style="color:var(--text-hi);font-weight:700;">${u.createdAt?new Date(u.createdAt).toLocaleDateString('tr-TR'):'Bilinmiyor'}</div>
          </div>
          <div style="background:var(--surface2);border-radius:10px;padding:10px;">
            <div style="color:var(--muted);margin-bottom:2px;">Son Giri≈ü</div>
            <div style="color:var(--text-hi);font-weight:700;">${u.lastSeen?new Date(u.lastSeen).toLocaleDateString('tr-TR'):'Bilinmiyor'}</div>
          </div>
          <div style="background:var(--surface2);border-radius:10px;padding:10px;">
            <div style="color:var(--muted);margin-bottom:2px;">Workspace</div>
            <div style="color:var(--text-hi);font-weight:700;">${esc(u.workspace||'‚Äî')}</div>
          </div>
          <div style="background:var(--surface2);border-radius:10px;padding:10px;">
            <div style="color:var(--muted);margin-bottom:2px;">Kayƒ±t Kaynaƒüƒ±</div>
            <div style="color:var(--text-hi);font-weight:700;">${esc(u.origin||'‚Äî')}</div>
          </div>
          ${u.bio?`<div style="background:var(--surface2);border-radius:10px;padding:10px;grid-column:1/-1;">
            <div style="color:var(--muted);margin-bottom:2px;">Biyografi</div>
            <div style="color:var(--text-hi);">${esc(u.bio)}</div>
          </div>`:''}
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:6px;">
          <button class="a-btn blue" onclick="adminEditUserProfile('${esc(username)}');this.closest('[style*=fixed]').remove()">‚úèÔ∏è D√ºzenle</button>
          <button class="a-btn" style="background:var(--surface2);" onclick="adminViewUserMessages('${esc(username)}');this.closest('[style*=fixed]').remove()">üí¨ Mesajlar</button>
          <button class="a-btn" style="background:var(--surface2);" onclick="this.closest('[style*=fixed]').remove()">Kapat</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }
}

/* ‚îÄ‚îÄ Geli≈ümi≈ü Oda Y√∂netimi ‚îÄ‚îÄ */
async function adminRoomDetails(roomId){
  const r = await adminRestGet('rooms/'+roomId).catch(()=>null)||{};
  {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
    modal.innerHTML = `
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:22px;max-width:440px;width:100%;max-height:85vh;overflow-y:auto;">
        <div style="font-size:1rem;font-weight:900;color:var(--text-hi);margin-bottom:16px;">‚öôÔ∏è Oda Ayarlarƒ± ‚Äî ${esc(r.name||roomId)}</div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div>
            <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Oda Adƒ±</div>
            <input id="rd-name" class="admin-inp" value="${esc(r.name||'')}" style="margin-bottom:0;">
          </div>
          <div>
            <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Oda A√ßƒ±klamasƒ±</div>
            <input id="rd-desc" class="admin-inp" value="${esc(r.description||'')}" placeholder="A√ßƒ±klama..." style="margin-bottom:0;">
          </div>
          <div>
            <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Yava≈ü Mod (saniye, 0=kapalƒ±)</div>
            <input id="rd-slow" class="admin-inp" type="number" value="${r.slowMode||0}" min="0" max="3600" style="margin-bottom:0;">
          </div>
          <div>
            <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Max √úye (0=sƒ±nƒ±rsƒ±z)</div>
            <input id="rd-maxmembers" class="admin-inp" type="number" value="${r.maxMembers||0}" min="0" style="margin-bottom:0;">
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:12px;padding:8px 0;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" id="rd-locked" ${r.locked?'checked':''}>
              <span style="font-size:.82rem;color:var(--text);">üîí Kilitli oda</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" id="rd-readonly" ${r.readOnly?'checked':''}>
              <span style="font-size:.82rem;color:var(--text);">üìñ Salt okunur</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
              <input type="checkbox" id="rd-hidden" ${r.hidden?'checked':''}>
              <span style="font-size:.82rem;color:var(--text);">üôà Gizli oda</span>
            </label>
          </div>
        </div>
        <div style="margin-top:16px;">
          <div style="font-size:.75rem;color:var(--muted);margin-bottom:8px;">√úyeler (${(r.members||[]).length})</div>
          <div style="max-height:120px;overflow-y:auto;background:var(--surface2);border-radius:10px;padding:8px;">
            ${(r.members||[]).map(m=>`
              <div style="display:flex;align-items:center;justify-content:space-between;padding:4px 0;">
                <span style="font-size:.8rem;color:var(--text-hi);">${esc(m)}</span>
                <button onclick="adminKickFromRoom('${esc(roomId)}','${esc(m)}')" style="background:var(--red);border:none;border-radius:5px;color:#fff;font-size:.62rem;padding:2px 8px;cursor:pointer;">√áƒ±kar</button>
              </div>`).join('')||'<div style="color:var(--muted);font-size:.78rem;">√úye yok</div>'}
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:16px;">
          <button class="a-btn blue" style="flex:1;" onclick="adminSaveRoomDetails('${esc(roomId)}',this.closest('[style*=fixed]'))">üíæ Kaydet</button>
          <button class="a-btn red" onclick="if(confirm('Oda silinsin mi?'))adminRestDelete('rooms/${esc(roomId)}').then(()=>{adminRestDelete('msgs/${esc(roomId)}').catch(()=>{});showToast('Oda silindi.');this.closest('[style*=fixed]').remove();loadAdminRooms();}).catch(()=>showToast('Hata.'))">üóëÔ∏è</button>
          <button class="a-btn" style="background:var(--surface2);" onclick="this.closest('[style*=fixed]').remove()">ƒ∞ptal</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }
}

async function adminSaveRoomDetails(roomId, modal){
  const updates = {
    name: document.getElementById('rd-name').value.trim(),
    description: document.getElementById('rd-desc').value.trim(),
    slowMode: parseInt(document.getElementById('rd-slow').value)||0,
    maxMembers: parseInt(document.getElementById('rd-maxmembers').value)||0,
    locked: document.getElementById('rd-locked').checked,
    readOnly: document.getElementById('rd-readonly').checked,
    hidden: document.getElementById('rd-hidden').checked,
  };
  if(!updates.name){ showToast('Oda adƒ± bo≈ü olamaz.'); return; }
  try{
    const existing = await adminRestGet('rooms/'+roomId).catch(()=>({}))||{};
    await adminRestSet('rooms/'+roomId, {...existing, ...updates});
    showToast('‚úÖ Oda g√ºncellendi!');
    if(modal) modal.remove();
    loadAdminRooms();
  }catch(e){showToast('Hata.');}
}

async function adminKickFromRoom(roomId, username){
  if(!confirm(username+' odadan √ßƒ±karƒ±lsƒ±n mƒ±?')) return;
  try{
    const room=await adminRestGet('rooms/'+roomId)||{};
    const members=(room.members||[]).filter(m=>m!==username);
    await adminRestSet('rooms/'+roomId+'/members',members);
    showToast(username+' odadan √ßƒ±karƒ±ldƒ±.');
    document.querySelectorAll('[style*="position:fixed"]').forEach(el=>{
      if(el.querySelector('#rd-name')) el.remove();
    });
    adminRoomDetails(roomId);
  }catch(e){showToast('Hata.');}
}

/* ‚îÄ‚îÄ Sistem Saƒülƒ±ƒüƒ± ƒ∞zleme ‚îÄ‚îÄ */
async function loadAdminSystemHealth(){
  const body = document.getElementById('adminBody');
  body.innerHTML = '<div class="ld"><span></span><span></span><span></span></div>';
  const [users,rooms,msgs,forum,online] = await Promise.all([
    adminRestGet('users').catch(()=>({})),
    adminRestGet('rooms').catch(()=>({})),
    adminRestGet('msgs').catch(()=>({})),
    adminRestGet('forum/posts').catch(()=>({})),
    adminRestGet('online').catch(()=>({}))
  ]);
  try{
    {
    const _users=users||{}, _rooms=rooms||{}, _msgs=msgs||{}, _forum=forum||{}, _online2=online||{};
    const usersS=null, roomsS=null, msgsS=null, forumS=null, onlineS=null;

    const totalUsers = Object.keys(_users).length;
    const bannedUsers = Object.values(_users).filter(u=>u&&u.banned).length;
    const adminUsers = Object.values(_users).filter(u=>u&&u.isAdmin).length;
    const totalRooms = Object.keys(_rooms).filter(k=>_rooms[k].type!=='dm').length;
    const totalMsgs = Object.values(_msgs).reduce((a,r)=>a+Object.keys(r||{}).length,0);
    const totalPosts = Object.keys(_forum).length;
    const onlineNow = Object.keys(_online2).length;

    // Depolama tahmini (her kayƒ±t ~500 byte)
    const estimatedKB = Math.round((totalUsers*0.5 + totalMsgs*0.3 + totalPosts*0.3));

    let html = '<div class="admin-stat-grid">';
    const stats = [
      { icon:'üë•', label:'Toplam √úye', val:totalUsers, color:'#5b9bd5' },
      { icon:'üü¢', label:'≈ûu An Online', val:onlineNow, color:'#2ecc71' },
      { icon:'üö´', label:'Banlƒ± √úye', val:bannedUsers, color:'#ff5a8a' },
      { icon:'üëë', label:'Admin Sayƒ±sƒ±', val:adminUsers, color:'#f0c040' },
      { icon:'üì¢', label:'Toplam Oda', val:totalRooms, color:'#c4a7ff' },
      { icon:'üí¨', label:'Toplam Mesaj', val:totalMsgs, color:'#1abc9c' },
      { icon:'üìã', label:'Forum G√∂nderisi', val:totalPosts, color:'#e67e22' },
      { icon:'üíæ', label:'Tahmini Veri', val:estimatedKB+'KB', color:'#7a8090' },
    ];
    stats.forEach(s=>{
      html += `<div class="admin-stat-card">
        <div class="admin-stat-val" style="color:${s.color}">${s.val}</div>
        <div class="admin-stat-label">${s.icon} ${s.label}</div>
      </div>`;
    });
    html += '</div>';

    // Son kayƒ±t olan kullanƒ±cƒ±lar
    const recentUsers = Object.values(_users).filter(u=>u&&u.createdAt).sort((a,b)=>b.createdAt-a.createdAt).slice(0,5);
    if(recentUsers.length){
      html += '<div class="admin-section"><div class="admin-sec-title">üÜï Son Kayƒ±t Olan Kullanƒ±cƒ±lar</div><div class="admin-card">';
      recentUsers.forEach(u=>{
        html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);">
          <div style="font-size:.82rem;font-weight:700;color:var(--text-hi);">${esc(u.username||u.displayName||'?')}</div>
          <div style="font-size:.7rem;color:var(--muted);">${u.createdAt?new Date(u.createdAt).toLocaleString('tr-TR'):'‚Äî'}</div>
        </div>`;
      });
      html += '</div></div>';
    }

    // En aktif odalar
    const roomActivity = Object.entries(_msgs).map(([id,m])=>({id,count:Object.keys(m||{}).length})).sort((a,b)=>b.count-a.count).slice(0,5);
    if(roomActivity.length){
      html += '<div class="admin-section"><div class="admin-sec-title">üî• En Aktif Odalar</div><div class="admin-card">';
      roomActivity.forEach(r=>{
        const room = rooms[r.id]||{};
        html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);">
          <div style="font-size:.82rem;font-weight:700;color:var(--text-hi);">${esc(room.name||r.id)}</div>
          <div style="font-size:.75rem;color:var(--accent);font-weight:700;">${r.count} mesaj</div>
        </div>`;
      });
      html += '</div></div>';
    }

    body.innerHTML = html;
  }}catch(e){ body.innerHTML='<p style="color:var(--muted);padding:20px">Y√ºklenemedi.</p>'; }
}

/* ‚îÄ‚îÄ Toplu Mesaj Silme ‚îÄ‚îÄ */
function adminBulkDeleteMsgs(){
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
  modal.innerHTML = `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:22px;max-width:420px;width:100%;">
      <div style="font-size:1rem;font-weight:900;color:var(--text-hi);margin-bottom:16px;">üóëÔ∏è Toplu Mesaj Silme</div>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <div>
          <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Kullanƒ±cƒ± (bo≈ü=hepsi)</div>
          <input id="bd-user" class="admin-inp" placeholder="Kullanƒ±cƒ± adƒ±..." style="margin-bottom:0;">
        </div>
        <div>
          <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Oda (bo≈ü=hepsi)</div>
          <input id="bd-room" class="admin-inp" placeholder="Oda ID..." style="margin-bottom:0;">
        </div>
        <div>
          <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">ƒ∞√ßerik filtresi (bo≈ü=hepsi)</div>
          <input id="bd-contains" class="admin-inp" placeholder="Bu metni i√ßeren mesajlarƒ± sil..." style="margin-bottom:0;">
        </div>
      </div>
      <div style="background:rgba(224,85,85,.1);border:1px solid rgba(224,85,85,.3);border-radius:10px;padding:10px;margin:12px 0;font-size:.75rem;color:var(--red);">
        ‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz!
      </div>
      <div style="display:flex;gap:8px;">
        <button class="a-btn red" style="flex:1;" onclick="execBulkDeleteMsgs(this.closest('[style*=fixed]'))">üóëÔ∏è Sil</button>
        <button class="a-btn" style="background:var(--surface2);" onclick="this.closest('[style*=fixed]').remove()">ƒ∞ptal</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
}

function execBulkDeleteMsgs(modal){
  const filterUser = document.getElementById('bd-user').value.trim().toLowerCase();
  const filterRoom = document.getElementById('bd-room').value.trim();
  const filterContains = document.getElementById('bd-contains').value.trim().toLowerCase();

  if(!confirm('Filtrelerle e≈üle≈üen mesajlar silinsin mi?')) return;

  adminRestGet('msgs').then(allMsgsData=>{
    const allRooms = allMsgsData||{};
    const delPaths = [];

    Object.entries(allRooms).forEach(([roomId, msgs])=>{
      if(filterRoom && roomId !== filterRoom) return;
      Object.entries(msgs||{}).forEach(([key, m])=>{
        if(filterUser && (m.user||'').toLowerCase() !== filterUser) return;
        if(filterContains && !(m.text||'').toLowerCase().includes(filterContains)) return;
        delPaths.push('msgs/'+roomId+'/'+key);
      });
    });

    Promise.all(delPaths.map(p=>adminRestDelete(p))).then(()=>{
      showToast(`‚úÖ ${delPaths.length} mesaj silindi.`);
      if(modal) modal.remove();
    }).catch(()=>showToast('Bazƒ± silmeler ba≈üarƒ±sƒ±z.'));
  });
}

/* ‚îÄ‚îÄ Veri Yedekleme (JSON export) ‚îÄ‚îÄ */
function adminExportData(){
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px;';
  modal.innerHTML = `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:22px;max-width:380px;width:100%;">
      <div style="font-size:1rem;font-weight:900;color:var(--text-hi);margin-bottom:16px;">üì¶ Veri Yedekleme</div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;">
        ${['users','rooms','msgs','forum/posts','settings'].map(p=>`
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px;background:var(--surface2);border-radius:8px;">
            <input type="checkbox" data-path="${p}" checked>
            <span style="font-size:.82rem;color:var(--text);">üìÅ ${p}</span>
          </label>`).join('')}
      </div>
      <div style="display:flex;gap:8px;">
        <button class="a-btn blue" style="flex:1;" onclick="execExportData(this.closest('[style*=fixed]'))">‚¨áÔ∏è ƒ∞ndir</button>
        <button class="a-btn" style="background:var(--surface2);" onclick="this.closest('[style*=fixed]').remove()">ƒ∞ptal</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
}

async function execExportData(modal){
  const checks = modal.querySelectorAll('input[type=checkbox]:checked');
  const paths = [...checks].map(c=>c.dataset.path);
  if(!paths.length){ showToast('En az bir alan se√ßin.'); return; }

  showToast('üì¶ Dƒ±≈üa aktarƒ±lƒ±yor...');
  const result = { exportedAt: new Date().toISOString() };

  for(const p of paths){
    try{
      const snap = await dbRef(p.startsWith('settings')?p:''+p).once('value');
      result[p.replace('/','_')] = snap.val();
    }catch(e){ result[p] = null; }
  }

  const blob = new Blob([JSON.stringify(result, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='backup_'+'data_'+Date.now()+'.json';
  a.click(); URL.revokeObjectURL(url);
  showToast('‚úÖ Yedek indirildi!');
  if(modal) modal.remove();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ƒ∞Yƒ∞LE≈ûTƒ∞Rƒ∞LMƒ∞≈û loadAdminUsers ‚Äî Detay & D√ºzenle butonlarƒ±
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */


function triggerPhotoUpload(){
  document.getElementById('photoFileInput').click();
}

function handlePhotoUpload(e){
  const file=e.target.files[0];
  if(!file) return;
  if(!file.type.startsWith('image/')){showToast('L√ºtfen bir resim se√ßin.');return;}
  if(file.size>5*1024*1024){showToast('Resim 5MB\'dan k√º√ß√ºk olmalƒ±.');return;}

  const reader=new FileReader();
  reader.onload=function(ev){
    // Resmi sƒ±kƒ±≈ütƒ±r
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      const MAX=256;
      let w=img.width,h=img.height;
      if(w>h){if(w>MAX){h=h*MAX/w;w=MAX;}}else{if(h>MAX){w=w*MAX/h;h=MAX;}}
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      const dataUrl=canvas.toDataURL('image/jpeg',0.82);

      // Firebase'e kaydet
      showToast('Fotoƒüraf y√ºkleniyor...');
      dbRef('users/'+_cu+'/photoURL').set(dataUrl).then(()=>{
        // Cache'i temizle ve fotoƒürafƒ± direkt uygula (Firebase'e gerek kalmadan)
        _avatarCache[_cu] = dataUrl;
        // T√ºm avatar elementlerini g√ºncelle
        ['profAvBig','deskProfAvBig','myAvatar','forumAvatar','deskRailUser','deskSidebarAvatar'].forEach(id=>{
          const el=document.getElementById(id);
          if(el){ _applyAvatarPhoto(el, dataUrl); }
        });
        // Sohbet listesindeki kendi mesaj avatarlarƒ±nƒ± g√ºncelle
        document.querySelectorAll('[data-av-user="'+_cu+'"]').forEach(el=>_applyAvatarPhoto(el,dataUrl));
        showToast('‚úÖ Profil fotoƒürafƒ± g√ºncellendi!');
      }).catch(()=>showToast('Y√ºkleme ba≈üarƒ±sƒ±z.'));
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
  // Input'u sƒ±fƒ±rla
  e.target.value='';
}

function openChangePassword(){
  let modal=document.getElementById('changePwModal');
  // Masa√ºst√º uyumluluƒüu: modal body'e ta≈üƒ±nmamƒ±≈üsa ta≈üƒ±
  if(modal && modal.parentElement !== document.body){
    document.body.appendChild(modal);
  }
  modal=document.getElementById('changePwModal');
  modal.style.display='flex';
  document.getElementById('pwOld').value='';
  document.getElementById('pwNew').value='';
  document.getElementById('pwNew2').value='';
  document.getElementById('pwChangeErr').textContent='';
  document.getElementById('pwChangeErr').classList.remove('show');
}
function closeChangePassword(){
  document.getElementById('changePwModal').style.display='none';
}
async function submitChangePassword(){
  const oldPass=document.getElementById('pwOld').value;
  const newPass=document.getElementById('pwNew').value;
  const newPass2=document.getElementById('pwNew2').value;
  const errEl=document.getElementById('pwChangeErr');
  const showErr=msg=>{errEl.textContent=msg;errEl.classList.add('show');};

  if(!oldPass){showErr('Mevcut ≈üifreyi girin.');return;}
  if(newPass.length<6){showErr('Yeni ≈üifre en az 6 karakter olmalƒ±.');return;}
  if(newPass!==newPass2){showErr('Yeni ≈üifreler e≈üle≈ümiyor.');return;}

  const oldHash=await hashStr(oldPass+_cu);
  const newHash=await hashStr(newPass+_cu);

  if(oldHash!==_passwordHash){showErr('Mevcut ≈üifre yanlƒ±≈ü.');return;}

  dbRef('users/'+_cu+'/passwordHash').set(newHash).then(()=>{
    _passwordHash=newHash;
    localStorage.setItem('sohbet_pass_' + _activeServer, newHash);
    closeChangePassword();
    showToast('≈ûifre ba≈üarƒ±yla g√ºncellendi! üîë');
  }).catch(()=>showErr('G√ºncelleme ba≈üarƒ±sƒ±z.'));
}

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function initials(n){return String(n||'?').slice(0,2).toUpperCase();}
function strColor(s){const c=['#E01E5A','#36C5F0','#2EB67D','#ECB22E','#9B72FF','#1D9BD1','#E8912D','#78D26F'];let h=0;for(let i=0;i<s.length;i++)h=(h*31+s.charCodeAt(i))>>>0;return c[h%c.length];}

/* ‚îÄ‚îÄ Avatar Cache & Helper ‚îÄ‚îÄ */
const _avatarCache={};
function setAvatar(el,username,size){
  if(!el||!username) return;
  // Default initials
  el.textContent=initials(username);
  el.style.background=strColor(username);
  el.style.backgroundImage='';
  el.style.backgroundSize='';
  el.style.color='';
  // Check cache
  if(_avatarCache[username]){
    _applyAvatarPhoto(el,_avatarCache[username]);
    return;
  }
  // Fetch from Firebase
  if(_db) dbRef('users/'+username+'/photoURL').once('value').then(s=>{
    const url=s.val();
    if(url){_avatarCache[username]=url;_applyAvatarPhoto(el,url);}
  }).catch(()=>{});
}
function _applyAvatarPhoto(el,url){
  el.textContent='';
  el.style.backgroundImage='url('+url+')';
  el.style.backgroundSize='cover';
  el.style.backgroundPosition='center';
  el.style.color='transparent';
}
function invalidateAvatarCache(username){delete _avatarCache[username];}

function fmtTime(ts){const d=new Date(ts);return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0');}
function formatDate(d){const now=new Date();if(d.toDateString()===now.toDateString())return 'Bug√ºn';const y=new Date(now);y.setDate(now.getDate()-1);if(d.toDateString()===y.toDateString())return 'D√ºn';return d.toLocaleDateString('tr-TR',{day:'numeric',month:'long'});}
function fmtSize(b){if(b>1024*1024)return(b/1024/1024).toFixed(1)+' MB';if(b>1024)return(b/1024).toFixed(0)+' KB';return b+' B';}
function getYTId(url){
  const m=url.match(/(?:youtube\.com\/(?:watch\?v=|shorts\/|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  return m?m[1]:null;
}
function getSpotifyEmbed(url){
  const m=url.match(/spotify\.com\/(track|album|playlist|episode)\/([a-zA-Z0-9]+)/);
  return m?`https://open.spotify.com/embed/${m[1]}/${m[2]}?utm_source=generator`:null;
}
function getSoundCloudEmbed(url){
  return url.includes('soundcloud.com')?`https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%235b9bd5&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false`:null;
}
function linkify(s){
  return s.replace(/(https?:\/\/[^\s<>"']+)/g, function(url){ url=url.replace(/[<>"']/g,''); if(!/^https?:\/\//i.test(url)) return esc(url);
    // YouTube ‚Äî sadece embed g√∂ster, link g√∂sterme
    const ytId = getYTId(url);
    if(ytId){
      return `<div class="media-embed"><iframe src="https://www.youtube.com/embed/${ytId}?rel=0" allowfullscreen allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" loading="lazy"></iframe></div>`;
    }
    // Spotify ‚Äî sadece embed g√∂ster
    const spUrl = getSpotifyEmbed(url);
    if(spUrl){
      return `<div class="media-embed"><iframe src="${spUrl}" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" style="border-radius:10px;height:152px;"></iframe></div>`;
    }
    // SoundCloud ‚Äî sadece embed g√∂ster
    const scUrl = getSoundCloudEmbed(url);
    if(scUrl){
      return `<div class="media-embed"><iframe src="${scUrl}" style="height:120px;" allow="autoplay" loading="lazy"></iframe></div>`;
    }
    // Normal link
    return `<a href="${url}" target="_blank">${url}</a>`;
  });
}
function showToast(msg,dur=2200){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),dur);}

/* ‚îÄ‚îÄ Keyboard / Back ‚îÄ‚îÄ */
window.visualViewport&&window.visualViewport.addEventListener('resize',()=>{if(document.getElementById('chatScreen').classList.contains('active'))setTimeout(scrollBottom,100);});

/* ‚îÄ‚îÄ Hash Router ‚îÄ‚îÄ */
(function(){
  const TAB_HASH = {
    home: '', forum: 'forum', msgs: 'mesajlar',
    friends: 'arkadaslar', profile: 'profil',
    games: 'oyunlar', watch: 'izle', admin: 'admin'
  };
  const HASH_TAB = {};
  Object.entries(TAB_HASH).forEach(([t,h])=>{ HASH_TAB[h]=t; });
  const labels = {
    home:'Ana Sayfa', forum:'Forum', msgs:'Mesajlar',
    friends:'Arkada≈ülar', profile:'Profil',
    games:'Oyunlar', watch:'ƒ∞zle', admin:'Admin'
  };
  window._updateURL = function(tab){
    try {
      const hash = TAB_HASH[tab];
      location.hash = hash ? '#' + hash : '#';
      document.title = (labels[tab]||tab) + ' ‚Äî Nature.co';
    } catch(e){}
  };
  window.addEventListener('hashchange', function(){
    const hash = location.hash.replace('#','').replace('/','');
    const tab = HASH_TAB[hash] || 'home';
    if(typeof IS_DESKTOP === 'function' && IS_DESKTOP()){
      if(typeof deskNav === 'function') deskNav(tab);
    } else {
      if(typeof switchMainTab === 'function') switchMainTab(tab);
    }
  });
  window.addEventListener('DOMContentLoaded', function(){
    const hash = location.hash.replace('#','').replace('/','');
    const tab = HASH_TAB[hash];
    if(tab && tab !== 'home'){
      setTimeout(()=>{
        if(typeof IS_DESKTOP === 'function' && IS_DESKTOP()){
          if(typeof deskNav === 'function') deskNav(tab);
        } else {
          if(typeof switchMainTab === 'function') switchMainTab(tab);
        }
      }, 800);
    }
  });
})();


/* ‚ïê‚ïê TARƒ∞Hƒ∞ T√úRK S√ñYLEM Sƒ∞STEMƒ∞ ‚ïê‚ïê */
const TURK_QUOTES = [
  // ‚îÄ‚îÄ Kadim T√ºrk / G√∂kt√ºrk ‚îÄ‚îÄ
  {ruler:"Bilge Kaƒüan", era:"G√∂kt√ºrk ƒ∞mparatorluƒüu ¬∑ 716-734", quote:"T√ºrk milleti yok olmasƒ±n diye, milleti i√ßin gece uyumadƒ±m, g√ºnd√ºz oturmadƒ±m."},
  {ruler:"Bilge Kaƒüan", era:"G√∂kt√ºrk ƒ∞mparatorluƒüu ¬∑ 716-734", quote:"√ústte g√∂k √ß√∂kmese, altta yer delinmese, senin ilini ve t√∂reni kim bozabilir?"},
  {ruler:"Bilge Kaƒüan", era:"G√∂kt√ºrk ƒ∞mparatorluƒüu ¬∑ 716-734", quote:"T√ºrk budun, a√ß iken tok olursun; √ßƒ±plak iken giyinirsin; yoksul iken zengin olursun."},
  {ruler:"K√ºl Tigin", era:"G√∂kt√ºrk ƒ∞mparatorluƒüu ¬∑ 684-731", quote:"T√ºrk milleti, kendine ait yurdu, devleti ve t√∂resi olduƒüu s√ºrece yok olmaz."},
  {ruler:"K√ºl Tigin", era:"G√∂kt√ºrk ƒ∞mparatorluƒüu ¬∑ 684-731", quote:"Ey T√ºrk, a√ß isen doyarsƒ±n; g√º√ßs√ºz isen g√º√ßlenirsin; birlik olursan her ≈üeyi yenebilirsin."},
  {ruler:"Tonyukuk", era:"G√∂kt√ºrk Devlet Adamƒ± ¬∑ 646-726", quote:"Birliƒüini kaybeden millet, g√ºc√ºn√º kaybeder."},
  {ruler:"Tonyukuk", era:"G√∂kt√ºrk Devlet Adamƒ± ¬∑ 646-726", quote:"Az ki≈üiyle √ßok ki≈üiyi yendim; g√º√ßl√º olduƒüum i√ßin deƒüil, akƒ±l kullandƒ±ƒüƒ±m i√ßin."},
  // ‚îÄ‚îÄ Hun ƒ∞mparatorluƒüu ‚îÄ‚îÄ
  {ruler:"Mete Han", era:"Hun ƒ∞mparatorluƒüu ¬∑ M√ñ 209-174", quote:"Birlik olmayan yerde kuvvet olmaz, kuvvet olmayan yerde zafer olmaz."},
  {ruler:"Mete Han", era:"Hun ƒ∞mparatorluƒüu ¬∑ M√ñ 209-174", quote:"Atƒ± olmayan er, kanadƒ± olmayan ku≈ü gibidir."},
  {ruler:"Mete Han", era:"Hun ƒ∞mparatorluƒüu ¬∑ M√ñ 209-174", quote:"D√º≈ümanƒ±nƒ± k√º√ß√ºk g√∂rme, kendini b√ºy√ºk g√∂rme."},
  {ruler:"Attila", era:"Hun ƒ∞mparatorluƒüu ¬∑ 434-453", quote:"Nereye kƒ±lƒ±cƒ±m yeti≈üirse, orasƒ± vatanƒ±m olur."},
  {ruler:"Attila", era:"Hun ƒ∞mparatorluƒüu ¬∑ 434-453", quote:"Cesaretsiz bir asker, silahsƒ±z bir askerden daha tehlikelidir."},
  // ‚îÄ‚îÄ Uygur & Avar ‚îÄ‚îÄ
  {ruler:"Moyun √áur Kaƒüan", era:"Uygur Kaƒüanlƒ±ƒüƒ± ¬∑ 747-759", quote:"Devlet, milletin huzuruna hizmet etmek i√ßin vardƒ±r."},
  {ruler:"Bayan Kaƒüan", era:"Avar ƒ∞mparatorluƒüu ¬∑ 562-602", quote:"G√º√ßl√º olan deƒüil, akƒ±llƒ± olan kazanƒ±r."},
  // ‚îÄ‚îÄ B√ºy√ºk Sel√ßuklu ‚îÄ‚îÄ
  {ruler:"Alparslan", era:"B√ºy√ºk Sel√ßuklu ƒ∞mparatorluƒüu ¬∑ 1063-1072", quote:"Zafer, Allah'ƒ±n yardƒ±mƒ±yla kazanƒ±lƒ±r; kƒ±lƒ±cƒ±n g√ºc√ºyle deƒüil."},
  {ruler:"Alparslan", era:"B√ºy√ºk Sel√ßuklu ƒ∞mparatorluƒüu ¬∑ 1063-1072", quote:"Adil ol ki milletin seni sevsin; g√º√ßl√º ol ki d√º≈ümanƒ±n senden √ßekinsin."},
  {ruler:"Melik≈üah", era:"B√ºy√ºk Sel√ßuklu ƒ∞mparatorluƒüu ¬∑ 1072-1092", quote:"Milletin refahƒ±, h√ºk√ºmdarƒ±n ≈üerefidir."},
  // ‚îÄ‚îÄ Atat√ºrk ‚îÄ‚îÄ
  {ruler:"Mustafa Kemal Atat√ºrk", era:"T√ºrkiye Cumhuriyeti Kurucusu ¬∑ 1881-1938", quote:"Ne mutlu T√ºrk'√ºm diyene!"},
  {ruler:"Mustafa Kemal Atat√ºrk", era:"T√ºrkiye Cumhuriyeti Kurucusu ¬∑ 1881-1938", quote:"Yurtta sulh, cihanda sulh."},
  {ruler:"Mustafa Kemal Atat√ºrk", era:"T√ºrkiye Cumhuriyeti Kurucusu ¬∑ 1881-1938", quote:"T√ºrk gen√ßliƒüi, istikbalin teminatƒ±dƒ±r."},
  // ‚îÄ‚îÄ Osmanlƒ± (az) ‚îÄ‚îÄ
  {ruler:"Fatih Sultan Mehmed", era:"Osmanlƒ± ƒ∞mparatorluƒüu ¬∑ 1444-1481", quote:"Bir ≈üehri fethetmek i√ßin √∂nce insan kalplerini fethetmek gerekir."},
  {ruler:"Kanuni Sultan S√ºleyman", era:"Osmanlƒ± ƒ∞mparatorluƒüu ¬∑ 1520-1566", quote:"Adalet m√ºlk√ºn temelidir."},
];

let _turkQuoteIdx = 0;
let _turkQuoteTimer = null;

function showTurkQuote() {
  const q = TURK_QUOTES[_turkQuoteIdx % TURK_QUOTES.length];
  document.getElementById('turkQuoteRuler').textContent = 'üëë ' + q.ruler;
  document.getElementById('turkQuoteEra').textContent = q.era;
  document.getElementById('turkQuoteText').textContent = q.quote;
  const overlay = document.getElementById('turkQuoteOverlay');
  overlay.style.display = 'flex';
  _turkQuoteIdx++;
}

function closeTurkQuote() {
  document.getElementById('turkQuoteOverlay').style.display = 'none';
}

function startTurkQuoteTimer() {
  // devre dƒ±≈üƒ±
}

// Overlay'e tƒ±klayƒ±nca kapat
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('turkQuoteOverlay').addEventListener('click', function(e) {
    if(e.target === this) closeTurkQuote();
  });
});
/* ‚ïê‚ïê TARƒ∞Hƒ∞ T√úRK S√ñYLEM Sƒ∞STEMƒ∞ SON ‚ïê‚ïê */


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FORUM Sƒ∞STEMƒ∞
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _forumFilter = 'hepsi';
let _forumStop = null;
const CAT_LABELS = {genel:'üí¨ Genel', tarih:'üìú Tarih', kultur:'üé≠ K√ºlt√ºr', spor:'‚öΩ Spor', muzik:'üéµ M√ºzik', teknoloji:'üíª Teknoloji', soru:'‚ùì Soru'};





function filterForum(cat) {
  _forumFilter = cat;
  document.querySelectorAll('.fcat').forEach(el => {
    el.classList.toggle('act', el.dataset.cat === cat);
  });
  loadForum();
}

function loadForum() {
  const feed = document.getElementById('forumFeed');
  feed.innerHTML = '<div class="ld"><span></span><span></span><span></span></div>';
  if(_forumStop){ _forumStop(); }

  let ref = dbRef('forum/posts').orderByChild('ts').limitToLast(50);
  const handler = ref.on('value', snap => {
    const posts = snap.val() || {};
    const arr = Object.entries(posts).map(([k,v]) => ({...v, _key:k}));
    arr.sort((a,b) => b.ts - a.ts);
    const filtered = _forumFilter === 'hepsi' ? arr : arr.filter(p => p.cat === _forumFilter);
    if(!filtered.length) {
      feed.innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--muted)"><div style="font-size:2.5rem;margin-bottom:10px">üìã</div><div style="font-weight:700;">Hen√ºz payla≈üƒ±m yok</div><div style="font-size:.82rem;margin-top:4px;">ƒ∞lk payla≈üƒ±mƒ± sen yap!</div></div>';
      return;
    }
    feed.innerHTML = filtered.map(p => renderForumCard(p)).join('');
  });
  _forumStop = () => ref.off('value', handler);
}

function renderForumCard(p) {
  const isOwn = p.user === _cu;
  const likeCount = p.likes ? Object.keys(p.likes).length : 0;
  const liked = !!(p.likes && p.likes[_cu]);
  const dislikeCount = p.dislikes ? Object.keys(p.dislikes).length : 0;
  const disliked = !!(p.dislikes && p.dislikes[_cu]);
  const heartCount = p.hearts ? Object.keys(p.hearts).length : 0;
  const hearted = !!(p.hearts && p.hearts[_cu]);
  const commentCount = p.comments ? Object.keys(p.comments).length : 0;
  const catLabel = CAT_LABELS[p.cat] || p.cat || 'üí¨ Genel';
  const timeStr = formatDate(new Date(p.ts)) + ' ' + fmtTime(p.ts);

  const commentsHtml = p.comments ? Object.entries(p.comments).sort((a,b)=>a[1].ts-b[1].ts).map(([cKey,c]) => {
    const cLiked = !!(c.likes && c.likes[_cu]);
    const cLikeCount = c.likes ? Object.keys(c.likes).length : 0;
    const cDisliked = !!(c.dislikes && c.dislikes[_cu]);
    const cDislikeCount = c.dislikes ? Object.keys(c.dislikes).length : 0;
    return `<div class="forum-comment" id="fcom-${p._key}-${cKey}">
      <div class="forum-comment-av" style="background:${strColor(c.user)}">${initials(c.user)}</div>
      <div class="forum-comment-body">
        <div class="forum-comment-user">${esc(c.user)}</div>
        <div class="forum-comment-text">${esc(c.text)}</div>
        <div class="forum-comment-actions">
          <div class="com-act-btn${cLiked?' liked':''}" onclick="toggleCommentReact('${p._key}','${cKey}','like',${cLiked})">üëç <span>${cLikeCount||''}</span></div>
          <div class="com-act-btn${cDisliked?' disliked':''}" onclick="toggleCommentReact('${p._key}','${cKey}','dislike',${cDisliked})">üëé <span>${cDislikeCount||''}</span></div>
          ${(c.user===_cu||_isAdmin)?`<div class="com-act-btn" onclick="deleteForumComment('${p._key}','${cKey}')">üóëÔ∏è</div>`:''}
        </div>
      </div>
    </div>`;
  }).join('') : '';

  return `<div class="forum-card" id="fcard-${p._key}">
    <div class="forum-card-header">
      <div class="forum-card-av" style="background:${strColor(p.user)}">${initials(p.user)}</div>
      <div class="forum-card-meta">
        <div class="forum-card-user">${esc(p.user)}</div>
        <div class="forum-card-time">${timeStr}</div>
      </div>
      <div class="forum-card-cat">${catLabel}</div>
    </div>
    <div class="forum-card-text">${p.bbcode ? parseBBCode(p.text) : (p.html ? sanitizeForumHtml(p.html) : esc(p.text))}</div>
    <div class="forum-card-actions">
      <div class="forum-action-btn${liked?' liked':''}" onclick="toggleForumReact('${p._key}','like',${liked})">
        üëç <span>${likeCount||''}</span>
      </div>
      <div class="forum-action-btn${disliked?' disliked':''}" onclick="toggleForumReact('${p._key}','dislike',${disliked})">
        üëé <span>${dislikeCount||''}</span>
      </div>
      <div class="forum-action-btn${hearted?' liked':''}" onclick="toggleForumHeart('${p._key}',${hearted})">
        ‚ù§Ô∏è <span>${heartCount||''}</span>
      </div>
      <div class="forum-action-btn" onclick="toggleForumComments('${p._key}')">
        üí¨ <span>${commentCount||''}</span>
      </div>
      ${(isOwn||_isAdmin)?`<div class="forum-del-btn" onclick="deleteForumPost('${p._key}')">üóëÔ∏è</div>`:''}
    </div>
    <div id="fcomments-${p._key}" style="display:none;">
      <div class="forum-comments">
        <div id="fcomlist-${p._key}">${commentsHtml}</div>
        <div class="forum-comment-inp-row">
          <input class="forum-comment-inp" id="fcinp-${p._key}" placeholder="Yorum yaz..." onkeydown="if(event.key==='Enter'){submitForumComment('${p._key}');event.preventDefault();}">
          <button class="forum-send-btn" onclick="submitForumComment('${p._key}')">‚Üë</button>
        </div>
      </div>
    </div>
  </div>`;
}

function onForumCatChange(cat) {
  if(cat) {
    filterForum(cat);
    const sel = document.getElementById('forumCategorySelect');
    if(sel) sel.style.color = 'var(--text-hi)';
  }
}

/* ‚ïê‚ïê BBCode Edit√∂r Fonksiyonlarƒ± ‚ïê‚ïê */
function parseBBCode(text){
  if(!text) return '';
  let s = text
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
  s = s.replace(/\r?\n/g,'<br>');
  s = s.replace(/\[b\]([\s\S]*?)\[\/b\]/gi, '<strong>$1</strong>');
  s = s.replace(/\[i\]([\s\S]*?)\[\/i\]/gi, '<em>$1</em>');
  s = s.replace(/\[u\]([\s\S]*?)\[\/u\]/gi, '<u>$1</u>');
  s = s.replace(/\[s\]([\s\S]*?)\[\/s\]/gi, '<s>$1</s>');
  s = s.replace(/\[color=([a-zA-Z#0-9]+)\]([\s\S]*?)\[\/color\]/gi,'<span style="color:$1">$2</span>');
  s = s.replace(/\[size=(\d+)\]([\s\S]*?)\[\/size\]/gi,(m,sz,ct)=>`<span style="font-size:${Math.min(Math.max(parseInt(sz),8),32)}px">${ct}</span>`);
  s = s.replace(/\[url=([^\]]+)\]([\s\S]*?)\[\/url\]/gi,'<a href="$1" target="_blank" rel="noopener noreferrer">$2</a>');
  s = s.replace(/\[url\]([\s\S]*?)\[\/url\]/gi,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
  s = s.replace(/\[img\]([\s\S]*?)\[\/img\]/gi,'<img src="$1" alt="resim" style="max-width:100%;border-radius:6px;display:block;margin:4px 0;" onerror="this.style.display=\'none\'">');
  s = s.replace(/\[quote=([^\]]+)\]([\s\S]*?)\[\/quote\]/gi,'<blockquote><div style="font-size:.72rem;font-weight:700;margin-bottom:3px;color:var(--accent)">$1 yazdƒ±:</div>$2</blockquote>');
  s = s.replace(/\[quote\]([\s\S]*?)\[\/quote\]/gi,'<blockquote>$1</blockquote>');
  s = s.replace(/\[code\]([\s\S]*?)\[\/code\]/gi,'<pre style="background:var(--surface2);border-radius:6px;padding:8px 12px;overflow-x:auto;font-family:monospace;font-size:.82rem;margin:4px 0;white-space:pre-wrap;">$1</pre>');
  s = s.replace(/\[c\]([\s\S]*?)\[\/c\]/gi,'<code>$1</code>');
  s = s.replace(/\[spoiler\]([\s\S]*?)\[\/spoiler\]/gi,'<span class="bb-spoiler" onclick="this.classList.toggle(\'revealed\')" title="G√∂rmek i√ßin tƒ±kla">$1</span>');
  s = s.replace(/\[list\]([\s\S]*?)\[\/list\]/gi,(m,inner)=>{
    const items=inner.split(/\[\*\]/).filter(x=>x.trim());
    return '<ul>'+items.map(it=>`<li>${it.replace(/<br>/g,'').trim()}</li>`).join('')+'</ul>';
  });
  return s;
}

function sanitizeForumHtml(html){
  if(!html) return '';
  // ƒ∞zin verilen taglar ve √∂zellikler
  const ALLOWED_TAGS = ['b','i','u','s','strong','em','br','p','ul','ol','li','blockquote','code','pre','h1','h2','h3','a','img','span'];
  const ALLOWED_ATTRS = { 'a': ['href','target'], 'img': ['src','alt','width','height'], 'span': ['style'] };
  // Ge√ßici div ile parse et
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  // Tehlikeli elementleri temizle
  const dangerous = tmp.querySelectorAll('script,iframe,object,embed,form,input,button,link,meta,style,base,svg,math');
  dangerous.forEach(el => el.remove());
  // T√ºm elementleri tara
  tmp.querySelectorAll('*').forEach(el => {
    const tag = el.tagName.toLowerCase();
    // ƒ∞zin verilmeyen tag'i span'a √ßevir
    if(!ALLOWED_TAGS.includes(tag)){
      const span = document.createElement('span');
      span.innerHTML = el.innerHTML;
      el.replaceWith(span);
      return;
    }
    // T√ºm attribute'leri tara
    [...el.attributes].forEach(attr => {
      const allowed = ALLOWED_ATTRS[tag] || [];
      if(!allowed.includes(attr.name)){
        el.removeAttribute(attr.name);
      } else {
        // href ve src'de javascript: protokol√ºn√º engelle
        if((attr.name === 'href' || attr.name === 'src') && /^\s*javascript:/i.test(attr.value)){
          el.removeAttribute(attr.name);
        }
        // Harici linklere g√ºvenli √∂zellikler ekle
        if(attr.name === 'href') el.setAttribute('rel','noopener noreferrer');
        if(attr.name === 'target') el.setAttribute('target','_blank');
      }
    });
    // style attribute'te expression/url engellemesi
    if(el.hasAttribute('style')){
      const safe = el.getAttribute('style').replace(/expression\s*\(|url\s*\(|javascript:/gi,'');
      el.setAttribute('style', safe);
    }
  });
  return tmp.innerHTML;
}

function bbWrap(tag){
  const ta=document.getElementById('forumPostInp');
  if(!ta) return;
  const s=ta.selectionStart,e=ta.selectionEnd,sel=ta.value.slice(s,e);
  let open=`[${tag}]`,close=`[/${tag}]`;
  if(tag==='url'){
    const href=prompt('Link URL:','https://');
    if(!href) return;
    open=`[url=${href}]`; close='[/url]';
  }
  ta.value=ta.value.slice(0,s)+open+sel+close+ta.value.slice(e);
  ta.selectionStart=s+open.length;
  ta.selectionEnd=s+open.length+sel.length;
  ta.focus();
  ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight,200)+'px';
  if(document.getElementById('bbPreviewArea').style.display!=='none') updateBbPreview();
}

function bbInsert(text){
  const ta=document.getElementById('forumPostInp');
  if(!ta) return;
  const s=ta.selectionStart;
  ta.value=ta.value.slice(0,s)+text+ta.value.slice(s);
  ta.selectionStart=ta.selectionEnd=s+text.length;
  ta.focus();
  ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight,200)+'px';
}

function bbColor(){
  const c=prompt('Renk (√∂rn: red, #ff0000, blue):','red');
  if(!c) return;
  const ta=document.getElementById('forumPostInp');
  const s=ta.selectionStart,e=ta.selectionEnd,sel=ta.value.slice(s,e)||'metin';
  const tag=`[color=${c}]${sel}[/color]`;
  ta.value=ta.value.slice(0,s)+tag+ta.value.slice(e);
  ta.selectionStart=ta.selectionEnd=s+tag.length; ta.focus();
}

function bbSize(){
  const sz=prompt('Yazƒ± boyutu (8-32):','16');
  if(!sz||isNaN(sz)) return;
  const ta=document.getElementById('forumPostInp');
  const s=ta.selectionStart,e=ta.selectionEnd,sel=ta.value.slice(s,e)||'metin';
  const tag=`[size=${sz}]${sel}[/size]`;
  ta.value=ta.value.slice(0,s)+tag+ta.value.slice(e);
  ta.selectionStart=ta.selectionEnd=s+tag.length; ta.focus();
}

function toggleBbPreview(){
  const area=document.getElementById('bbPreviewArea');
  const btn=document.getElementById('bbPreviewBtn');
  const ta=document.getElementById('forumPostInp');
  if(area.style.display==='none'){
    area.style.display='block';
    btn.style.background='var(--accent2)'; btn.style.color='var(--text-hi)';
    updateBbPreview();
    ta.addEventListener('input',updateBbPreview);
  } else {
    area.style.display='none';
    btn.style.background=''; btn.style.color='';
    ta.removeEventListener('input',updateBbPreview);
  }
}

function updateBbPreview(){
  const ta=document.getElementById('forumPostInp');
  const area=document.getElementById('bbPreviewArea');
  if(!ta||!area) return;
  area.innerHTML=parseBBCode(ta.value)||'<span style="color:var(--muted);font-size:.82rem">√ñnizleme burada g√∂r√ºnecek...</span>';
}

function fmtDoc(){}
function fmtInsertLink(){}
function fmtInlineCode(){}
function forumEditorInput(){}
function forumEditorKeydown(){}
function updateFmtBtns(){}

function submitForumPost(){
  const inp=document.getElementById('forumPostInp');
  const bbcode=inp?inp.value.trim():'';
  const sel=document.getElementById('forumCategorySelect');
  const cat=sel?sel.value:'';
  if(!bbcode){showToast('Bir ≈üeyler yaz!');return;}
  if(!cat){
    if(sel){sel.style.border='1px solid var(--red)';setTimeout(()=>sel.style.border='1px solid var(--border)',1500);}
    showToast('‚ö†Ô∏è Kategori se√ßmelisin!');return;
  }
  if(bbcode.length>2000){showToast('En fazla 2000 karakter!');return;}
  dbRef('forum/posts').push({user:_cu,text:bbcode,bbcode:true,cat,ts:Date.now(),likes:{},dislikes:{},hearts:{},comments:{}})
    .then(()=>{
      if(inp){inp.value='';inp.style.height='auto';}
      if(sel){sel.value='';sel.style.color='var(--muted)';}
      showToast('Payla≈üƒ±ldƒ±! üéâ');
    })
    .catch(()=>showToast('Hata olu≈ütu.'));
}

function toggleForumReact(postKey, type, isActive) {
  const ref = dbRef('forum/posts/'+postKey+'/'+type+'s/'+_cu);
  const opposite = type==='like'?'dislikes':'likes';
  if(isActive){ ref.remove(); }
  else{ ref.set(true); dbRef('forum/posts/'+postKey+'/'+opposite+'/'+_cu).remove(); }
}

function toggleForumHeart(postKey, isHearted) {
  const ref = dbRef('forum/posts/'+postKey+'/hearts/'+_cu);
  if(isHearted) ref.remove();
  else ref.set(true);
}

// Desktop forum i√ßin alias fonksiyonlar
function forumVote(postKey, type) {
  const ref = dbRef('forum/posts/'+postKey+'/'+type+'s/'+_cu);
  const opposite = type==='like'?'dislikes':'likes';
  ref.once('value').then(s=>{
    const isActive = s.val()===true;
    if(isActive){ ref.remove(); }
    else{ ref.set(true); dbRef('forum/posts/'+postKey+'/'+opposite+'/'+_cu).remove(); }
    if(typeof deskLoadForum==='function') setTimeout(deskLoadForum,300);
  });
}
function forumHeart(postKey) {
  const ref = dbRef('forum/posts/'+postKey+'/hearts/'+_cu);
  ref.once('value').then(s=>{
    if(s.val()===true) ref.remove();
    else ref.set(true);
    if(typeof deskLoadForum==='function') setTimeout(deskLoadForum,300);
  });
}

function toggleCommentReact(postKey, commentKey, type, isActive) {
  const ref = dbRef('forum/posts/'+postKey+'/comments/'+commentKey+'/'+type+'s/'+_cu);
  const opposite = type==='like'?'dislikes':'likes';
  if(isActive){ ref.remove(); }
  else{ ref.set(true); dbRef('forum/posts/'+postKey+'/comments/'+commentKey+'/'+opposite+'/'+_cu).remove(); }
}

function toggleForumComments(postKey) {
  const el = document.getElementById('fcomments-'+postKey);
  if(!el) return;
  const isOpen = el.style.display !== 'none';
  el.style.display = isOpen ? 'none' : 'block';
  if(!isOpen) {
    const inp = document.getElementById('fcinp-'+postKey);
    if(inp) setTimeout(()=>inp.focus(), 100);
  }
}

function submitForumComment(postKey) {
  const inp = document.getElementById('fcinp-'+postKey);
  if(!inp) return;
  const text = inp.value.trim();
  if(!text) return;
  dbRef('forum/posts/'+postKey+'/comments').push({ user:_cu, text, ts:Date.now() })
    .then(() => { inp.value=''; })
    .catch(() => showToast('Hata.'));
}

function deleteForumComment(postKey, commentKey) {
  if(!confirm('Bu yorumu sil?')) return;
  dbRef('forum/posts/'+postKey+'/comments/'+commentKey).remove().catch(()=>showToast('Hata.'));
}

function deleteForumPost(postKey) {
  if(!confirm('Bu payla≈üƒ±mƒ± sil?')) return;
  dbRef('forum/posts/'+postKey).remove()
    .then(() => showToast('Silindi.'))
    .catch(() => showToast('Hata.'));
}
/* ‚ïê‚ïê FORUM Sƒ∞STEMƒ∞ SON ‚ïê‚ïê */


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üìû GROUP WebRTC ‚Äî √áOKLU KULLANICI SESLI/G√ñR√úNT√úL√ú ARAMA (v2)
   Mesh mimarisi: her kullanƒ±cƒ± diƒüer t√ºm kullanƒ±cƒ±larla ayrƒ± RTCPeerConnection
   Firebase yapƒ±sƒ±:
     calls/{callId}/host, type, status, ts
     calls/{callId}/parts/{user} = { active, ts }
     calls/{callId}/inv/{user} = { from, status, type, ts }
     calls/{callId}/sig/{userA}__{userB}/offer|answer|ice_{user}
     callInvites/{user}/{callId} = { from, type, ts }
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

const STUN_SERVERS = {iceServers:[
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'},
  {urls:'stun:stun2.l.google.com:19302'},
  {urls:'stun:stun.cloudflare.com:3478'},
  // √úcretsiz public TURN ‚Äî farklƒ± aƒülardaki (4G‚ÜîWiFi) baƒülantƒ±larƒ± saƒülar
  {urls:'turn:openrelay.metered.ca:80',  username:'openrelayproject',credential:'openrelayproject'},
  {urls:'turn:openrelay.metered.ca:443', username:'openrelayproject',credential:'openrelayproject'},
  {urls:'turn:openrelay.metered.ca:443?transport=tcp', username:'openrelayproject',credential:'openrelayproject'},
]};

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let _groupCallId = null;       // Aktif grup aramasƒ± ID'si
let _callId = null;            // _groupCallId ile aynƒ± (uyumluluk)
let _peers = {};               // { username: RTCPeerConnection }
let _remoteStreams = {};        // { username: MediaStream }
let _localStream = null;
let _screenStream = null;
let _callType = null;
let _callOther = null;         // ƒ∞lk davet edilen (display i√ßin)
let _isCaller = false;
let _isMuted = false;
let _isSharingScreen = false;
let _isCameraOn = true;
let _callTimer = null;
let _callSeconds = 0;
let _callStopListeners = [];

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function _pairKey(a, b){ return [a,b].sort().join('__'); }

async function _getLocalStream(type){
  if(type==='screen'){
    const s = await navigator.mediaDevices.getDisplayMedia({video:{cursor:'always'},audio:false});
    try{
      const mic = await navigator.mediaDevices.getUserMedia({audio:true,video:false});
      mic.getAudioTracks().forEach(t=>s.addTrack(t));
    }catch(e){}
    s.getVideoTracks()[0].onended = ()=>endCall();
    return s;
  }
  return navigator.mediaDevices.getUserMedia(
    type==='video'?{audio:true,video:{facingMode:'user'}}:{audio:true,video:false}
  );
}

function _attachRemoteMedia(username, stream){
  // Ses elementi olu≈ütur veya g√ºncelle
  let audio = document.getElementById('_rAudio_'+username);
  if(!audio){
    audio = document.createElement('audio');
    audio.id = '_rAudio_'+username;
    audio.autoplay = true;
    audio.playsInline = true;
    audio.style.display = 'none';
    document.body.appendChild(audio);
  }
  audio.srcObject = stream;
  // Play'i zorla tetikle (autoplay policy bypass)
  audio.play().catch(()=>{
    const resume = ()=>{ audio.play().catch(()=>{}); document.removeEventListener('click',resume); };
    document.addEventListener('click', resume, {once:true});
  });
  // Video varsa: tek katƒ±lƒ±mcƒ±ysa ana ekrana, √ßoksa grid'e
  if(_callType==='video'||_callType==='screen'){
    const rv = document.getElementById('remoteVideo');
    if(rv){ rv.srcObject = stream; rv.play().catch(()=>{}); }
  }
}

/* ‚îÄ‚îÄ Per-pair WebRTC baƒülantƒ±sƒ± kur ‚îÄ‚îÄ */
async function _setupPeer(remoteUser, isOfferer){
  if(_peers[remoteUser]){
    try{_peers[remoteUser].close();}catch(e){}
    delete _peers[remoteUser];
  }
  const pc = new RTCPeerConnection(STUN_SERVERS);
  _peers[remoteUser] = pc;

  // ‚òÖ ICE kuyruk: setRemoteDescription √∂ncesi gelen candidate'leri biriktir
  const iceQueue = [];
  let remoteDescSet = false;
  async function flushIceQueue(){
    while(iceQueue.length){
      try{ await pc.addIceCandidate(new RTCIceCandidate(iceQueue.shift())); }catch(e){}
    }
  }

  _localStream.getTracks().forEach(t=>pc.addTrack(t,_localStream));

  const remoteStream = new MediaStream();
  _remoteStreams[remoteUser] = remoteStream;
  pc.ontrack = e=>{
    e.streams[0].getTracks().forEach(t=>{
      if(!remoteStream.getTracks().find(x=>x.id===t.id)) remoteStream.addTrack(t);
    });
    _attachRemoteMedia(remoteUser, remoteStream);
    _updateParticipantsUI();
  };

  const pair = _pairKey(_cu, remoteUser);
  const sig  = 'calls/'+_groupCallId+'/sig/'+pair;

  pc.onicecandidate = e=>{
    if(e.candidate) dbRef(sig+'/ice_'+_cu).push(e.candidate.toJSON());
  };

  pc.onconnectionstatechange = ()=>{
    const s = pc.connectionState;
    if(s==='connected'){
      const st=document.getElementById('callStatus');
      if(st && !_callTimer) st.textContent='Baƒülandƒ±';
      _updateParticipantsUI();
      if(!_callTimer) startCallTimer();
    } else if(s==='failed'){
      if(isOfferer) pc.restartIce();
    } else if(s==='disconnected'){
      setTimeout(()=>{ if(pc.connectionState==='disconnected') _peerLeft(remoteUser); },6000);
    }
  };
  pc.oniceconnectionstatechange = ()=>{
    if(pc.iceConnectionState==='failed' && isOfferer) pc.restartIce();
  };

  // ‚òÖ ICE candidate'leri kuyrukla ‚Äî remote desc set olunca flush et
  const iceRef = dbRef(sig+'/ice_'+remoteUser);
  const stopIce = iceRef.on('child_added', async snap=>{
    if(!snap.val()) return;
    if(remoteDescSet){
      try{ await pc.addIceCandidate(new RTCIceCandidate(snap.val())); }catch(e){}
    } else {
      iceQueue.push(snap.val());
    }
  });
  _callStopListeners.push(()=>iceRef.off('child_added',stopIce));

  if(isOfferer){
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await dbRef(sig+'/offer').set({sdp:offer.sdp,type:offer.type,from:_cu});

    const ansRef = dbRef(sig+'/answer');
    const stopAns = ansRef.on('value', async snap=>{
      if(snap.val() && !pc.currentRemoteDescription){
        try{
          await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
          remoteDescSet = true;
          await flushIceQueue();
          ansRef.off('value',stopAns);
        }catch(e){ console.warn('[WebRTC offerer]',e); }
      }
    });
    _callStopListeners.push(()=>ansRef.off('value',stopAns));

  } else {
    const offerRef = dbRef(sig+'/offer');
    const stopOff = offerRef.on('value', async snap=>{
      if(snap.val() && !pc.currentRemoteDescription){
        try{
          await pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
          remoteDescSet = true;
          await flushIceQueue();
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          await dbRef(sig+'/answer').set({sdp:answer.sdp,type:answer.type});
          offerRef.off('value',stopOff);
        }catch(e){ console.warn('[WebRTC answerer]',e); }
      }
    });
    _callStopListeners.push(()=>offerRef.off('value',stopOff));
  }

  return pc;
}

function _peerLeft(username){
  if(_peers[username]){
    try{_peers[username].close();}catch(e){}
    delete _peers[username];
  }
  delete _remoteStreams[username];
  const a = document.getElementById('_rAudio_'+username);
  if(a) a.remove();
  _updateParticipantsUI();
  if(Object.keys(_peers).length===0) endCall();
}

/* ‚îÄ‚îÄ Katƒ±lƒ±mcƒ± gelince/gidince dinle ‚îÄ‚îÄ */
function _listenParticipants(){
  const ref = dbRef('calls/'+_groupCallId+'/parts');

  const stopAdd = ref.on('child_added', async snap=>{
    const u = snap.key;
    if(u===_cu||_peers[u]) return;
    const d = snap.val();
    if(!d||!d.active) return;
    // Alphabetically k√º√ß√ºk olan offer yapar
    await _setupPeer(u, _cu < u);
    _updateParticipantsUI();
  });
  _callStopListeners.push(()=>ref.off('child_added',stopAdd));

  const stopRem = ref.on('child_removed', snap=>{
    const u = snap.key;
    if(u!==_cu) _peerLeft(u);
  });
  _callStopListeners.push(()=>ref.off('child_removed',stopRem));

  // Arama sona erdiyse
  const sRef = dbRef('calls/'+_groupCallId+'/status');
  const stopS = sRef.on('value', snap=>{
    if(snap.val()==='ended') endCall();
  });
  _callStopListeners.push(()=>sRef.off('value',stopS));
}

/* ‚îÄ‚îÄ getDMOther ‚îÄ‚îÄ */
function getDMOther(){
  const room = (IS_DESKTOP()&&_deskRoom)?_deskRoom:_cRoom;
  if(!room) return null;
  if(room.startsWith('dm_')){
    const rest=room.slice(3);
    const parts=rest.split('_');
    for(let i=1;i<parts.length;i++){
      const a=parts.slice(0,i).join('_');
      const b=parts.slice(i).join('_');
      if(a===_cu) return b;
      if(b===_cu) return a;
    }
    return parts.find(p=>p!==_cu)||null;
  }
  return null;
}

async function getDMOtherFromDB(){
  const room = (IS_DESKTOP()&&_deskRoom)?_deskRoom:_cRoom;
  if(!room) return null;
  const snap = await dbRef('rooms/'+room).once('value');
  const data = snap.val();
  if(!data||data.type!=='dm') return null;
  return (data.members||[]).find(m=>m!==_cu)||null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ARAMA BA≈ûLAT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function startCall(type){
  const dmOther = getDMOther()||await getDMOtherFromDB();
  if(!dmOther){showToast('DM odasƒ± gerekli!');return;}
  if(!_online[dmOther]){showToast(dmOther+' ≈üu an √ßevrimdƒ±≈üƒ±.');return;}

  _callType = type;
  _callOther = dmOther;
  _isCaller = true;
  _groupCallId = 'gcall_'+_cu+'_'+Date.now();
  _callId = _groupCallId;

  try{
    _localStream = await _getLocalStream(type);
  }catch(e){
    showToast(type==='screen'?'Ekran payla≈üƒ±mƒ± reddedildi.':'Mikrofon/kamera eri≈üimi reddedildi.');
    return;
  }

  // Firebase'e arama olu≈ütur
  await dbRef('calls/'+_groupCallId).set({host:_cu,type,status:'active',ts:Date.now()});
  await dbRef('calls/'+_groupCallId+'/parts/'+_cu).set({active:true,ts:Date.now()});

  // Kar≈üƒ± tarafƒ± davet et
  await dbRef('calls/'+_groupCallId+'/inv/'+dmOther).set({from:_cu,status:'ringing',type,ts:Date.now()});
  await dbRef('callInvites/'+dmOther+'/'+_groupCallId).set({from:_cu,type,ts:Date.now()});

  showCallScreen(dmOther, type, false);
  document.getElementById('callStatus').textContent = '√áaƒürƒ±lƒ±yor...';

  // Davet yanƒ±tƒ±nƒ± dinle
  const invRef = dbRef('calls/'+_groupCallId+'/inv/'+dmOther+'/status');
  const stopInv = invRef.on('value', snap=>{
    const s = snap.val();
    if(s==='accepted'){
      invRef.off('value',stopInv);
      document.getElementById('callStatus').textContent = 'Baƒülanƒ±yor...';
    } else if(s==='rejected'){
      invRef.off('value',stopInv);
      endCall(); showToast(dmOther+' aramayƒ± reddetti.');
    }
  });
  _callStopListeners.push(()=>invRef.off('value',stopInv));

  // Yeni katƒ±lƒ±mcƒ±larƒ± dinle
  _listenParticipants();

  // 30s cevap yoksa bitir
  setTimeout(()=>{
    const st = document.getElementById('callStatus');
    if(_groupCallId && st && st.textContent==='√áaƒürƒ±lƒ±yor...'){
      endCall(); showToast('Cevap yok.');
    }
  },30000);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   G√ñR√ú≈ûMEYE KULLANICI DAVET ET (aktif arama sƒ±rasƒ±nda)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function inviteToCall(username){
  if(!_groupCallId){showToast('Aktif g√∂r√º≈üme yok.');return;}
  if(_peers[username]){showToast(username+' zaten g√∂r√º≈ümede.');return;}
  if(!_online[username]){showToast(username+' ≈üu an √ßevrimdƒ±≈üƒ±.');return;}

  await dbRef('calls/'+_groupCallId+'/inv/'+username).set({from:_cu,status:'ringing',type:_callType,ts:Date.now()});
  await dbRef('callInvites/'+username+'/'+_groupCallId).set({from:_cu,type:_callType,ts:Date.now()});
  showToast('üìû '+username+' g√∂r√º≈ümeye davet edildi.');
}

function openCallInviteDialog(){
  if(!_groupCallId) return;
  // √áevrimi√ßi arkada≈ülarƒ± listele
  const onlineUsers = Object.keys(_online).filter(u=>_online[u]&&u!==_cu&&!_peers[u]);
  if(!onlineUsers.length){showToast('Davet edilebilecek √ßevrimi√ßi kullanƒ±cƒ± yok.');return;}
  let h = '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:16px;position:fixed;bottom:160px;left:50%;transform:translateX(-50%);z-index:9999;min-width:220px;box-shadow:0 8px 32px rgba(0,0,0,.5);">';
  h += '<div style="font-size:.85rem;font-weight:900;color:var(--text-hi);margin-bottom:10px;">üìû G√∂r√º≈ümeye Davet Et</div>';
  onlineUsers.slice(0,8).forEach(u=>{
    h += `<div onclick="inviteToCall('${u}');this.closest('[data-callInvDiv]').remove()" style="display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:8px;cursor:pointer;transition:background .1s;" onmouseenter="this.style.background='var(--surface)'" onmouseleave="this.style.background=''">`+
      `<div style="width:30px;height:30px;border-radius:50%;background:${strColor(u)};display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:900;color:#fff;">${initials(u)}</div>`+
      `<div style="font-size:.85rem;font-weight:700;color:var(--text-hi);">${u}</div>`+
      `<div style="width:8px;height:8px;border-radius:50%;background:#2ecc71;margin-left:auto;"></div>`+
      `</div>`;
  });
  h += `<div onclick="this.closest('[data-callInvDiv]').remove()" style="text-align:center;margin-top:8px;font-size:.75rem;color:var(--muted);cursor:pointer;">Kapat</div></div>`;
  const wrap = document.createElement('div');
  wrap.setAttribute('data-callInvDiv','1');
  wrap.innerHTML = h;
  document.body.appendChild(wrap);
  // Dƒ±≈üarƒ± tƒ±klayƒ±nca kapat
  setTimeout(()=>document.addEventListener('click',function cls(e){
    if(!e.target.closest('[data-callInvDiv]')){wrap.remove();document.removeEventListener('click',cls);}
  }),100);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GELEN ARAMA Dƒ∞NLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function listenIncomingCalls(){
  const ref = dbRef('callInvites/'+_cu);
  ref.on('child_added', async snap=>{
    const callId = snap.key;
    const inv = snap.val();
    if(!inv||!inv.from||!inv.ts) return;
    if(Date.now()-inv.ts>60000) return;  // eskimi≈ü
    if(_groupCallId===callId) return;    // zaten bu aramada
    if(_groupCallId){
      // Zaten aramadayƒ±z ‚Äî bildirim g√∂ster
      showToast('üìû '+inv.from+' sizi arƒ±yor (≈üu an g√∂r√º≈ümedesiniz)');
      return;
    }
    _callId = callId;
    _groupCallId = callId;
    _callOther = inv.from;
    _callType = inv.type;
    _isCaller = false;
    showIncomingCall(inv.from, inv.type);
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ARAMAYI KABUL ET
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function acceptCall(){
  document.getElementById('incomingCallScreen').style.display='none';
  stopRingSound();

  try{
    _localStream = await _getLocalStream(_callType==='screen'?'audio':_callType);
  }catch(e){
    showToast('Mikrofon/kamera eri≈üimi reddedildi.'); rejectCall(); return;
  }

  // Firebase g√ºncelle
  await dbRef('calls/'+_groupCallId+'/inv/'+_cu+'/status').set('accepted');
  await dbRef('calls/'+_groupCallId+'/parts/'+_cu).set({active:true,ts:Date.now()});
  await dbRef('callInvites/'+_cu+'/'+_groupCallId).remove();

  showCallScreen(_callOther, _callType, true);

  // Mevcut katƒ±lƒ±mcƒ±larla baƒülan
  const partsSnap = await dbRef('calls/'+_groupCallId+'/parts').once('value');
  const parts = partsSnap.val()||{};
  
  // Yeni katƒ±lƒ±mcƒ±larƒ± dinlemeye ba≈üla
  _listenParticipants();

  for(const u of Object.keys(parts)){
    if(u===_cu||!parts[u].active||_peers[u]) continue;
    await _setupPeer(u, _cu < u);
  }

  _updateParticipantsUI();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ARAMAYI REDDET
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function rejectCall(){
  document.getElementById('incomingCallScreen').style.display='none';
  stopRingSound();
  if(_groupCallId){
    dbRef('calls/'+_groupCallId+'/inv/'+_cu+'/status').set('rejected');
    dbRef('callInvites/'+_cu+'/'+_groupCallId).remove();
  }
  _groupCallId=null; _callId=null; _callOther=null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   KATILIMCI ARAY√úZ√ú
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function _updateParticipantsUI(){
  const container = document.getElementById('callParticipants');
  if(!container) return;

  const connected = Object.keys(_peers).filter(u=>{
    const pc=_peers[u];
    return pc&&(pc.connectionState==='connected'||pc.connectionState==='connecting'||pc.connectionState==='new');
  });

  container.innerHTML = '';

  // Kendi avatarƒ±
  const self = document.createElement('div');
  self.className = 'call-part-av';
  self.textContent = initials(_cu);
  self.style.cssText = 'background:'+strColor(_cu)+';'+((_isMuted)?'outline:2px solid #e05555;':'outline:2px solid #2ecc71;');
  self.title = _cu+' (Sen)';
  container.appendChild(self);

  connected.forEach(u=>{
    const d = document.createElement('div');
    d.className = 'call-part-av';
    d.textContent = initials(u);
    d.style.cssText = 'background:'+strColor(u)+';outline:2px solid #2ecc71;';
    d.title = u;
    container.appendChild(d);
  });

  // Status g√ºncelle
  const total = connected.length+1;
  const nameEl = document.getElementById('callName');
  if(nameEl && total>2) nameEl.textContent = total+' ki≈üi g√∂r√º≈ü√ºyor';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ARAMA EKRANI G√ñSTEr
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showCallScreen(other, type, incoming){
  const el = document.getElementById('callScreen');
  el.style.display='flex';
  document.getElementById('callMinimizedBar').style.display='none';
  document.getElementById('callName').textContent = other;
  const av = document.getElementById('callAvatar');
  av.textContent = initials(other);
  av.style.background = strColor(other);
  document.getElementById('callStatus').textContent = incoming?'Baƒülanƒ±yor...':'√áaƒürƒ±lƒ±yor...';
  const screenBadge = document.getElementById('callScreenBadge');
  if(screenBadge) screenBadge.style.display = type==='screen'?'flex':'none';
  if(type==='audio'){
    document.getElementById('callVideoArea').style.display='none';
    document.getElementById('callAudioArea').style.display='flex';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ZAMANLAYICI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function startCallTimer(){
  if(_callTimer) return;
  _callSeconds=0;
  const timerDisplay=document.getElementById('callTimerDisplay');
  const qualInd=document.getElementById('callQualityIndicator');
  if(timerDisplay){timerDisplay.style.display='block';}
  if(qualInd){qualInd.style.display='flex';}
  // Kalite indikat√∂r√º bars
  const bars=[document.getElementById('cqi1'),document.getElementById('cqi2'),document.getElementById('cqi3'),document.getElementById('cqi4')];
  const qh=[6,10,14,18];
  const qc=('#4ade80');
  bars.forEach((b,i)=>{if(b){b.style.height=qh[i]+'px';b.style.background=qc;}});
  _callTimer=setInterval(()=>{
    _callSeconds++;
    const m=Math.floor(_callSeconds/60).toString().padStart(2,'0');
    const s=(_callSeconds%60).toString().padStart(2,'0');
    document.getElementById('callStatus').textContent='Baƒülandƒ±';
    if(timerDisplay) timerDisplay.textContent=m+':'+s;
    const ms = document.getElementById('callMinBar_status');
    if(ms) ms.textContent=m+':'+s;
  },1000);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ARAMAYI Bƒ∞Tƒ∞R
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function endCall(){
  stopRingSound();
  if(_callTimer){clearInterval(_callTimer);_callTimer=null;}
  _callStopListeners.forEach(fn=>fn()); _callStopListeners=[];

  // T√ºm peer baƒülantƒ±larƒ±nƒ± kapat
  Object.values(_peers).forEach(pc=>{try{pc.close();}catch(e){}});
  _peers={};
  _remoteStreams={};

  // Ses elementlerini temizle
  document.querySelectorAll('[id^="_rAudio_"]').forEach(el=>el.remove());

  // Streamleri durdur
  if(_localStream){_localStream.getTracks().forEach(t=>t.stop());_localStream=null;}
  if(_screenStream){_screenStream.getTracks().forEach(t=>t.stop());_screenStream=null;}
  _isSharingScreen=false;

  _isSpeakerMuted=false;
  const ssBtn=document.getElementById('callShareScreenBtn');
  if(ssBtn) ssBtn.classList.remove('active');

  // Firebase: kendini participants'tan kaldƒ±r
  if(_groupCallId){
    dbRef('calls/'+_groupCallId+'/parts/'+_cu).remove().catch(()=>{});
    dbRef('callInvites/'+_cu+'/'+_groupCallId).remove().catch(()=>{});
    if(_isCaller){
      dbRef('calls/'+_groupCallId+'/status').set('ended').catch(()=>{});
      setTimeout(()=>{ if(_groupCallId) dbRef('calls/'+_groupCallId).remove().catch(()=>{}); },5000);
    }
  }

  _groupCallId=null; _callId=null; _callOther=null; _isCaller=false; _callSeconds=0;

  document.getElementById('callScreen').style.display='none';
  document.getElementById('incomingCallScreen').style.display='none';
  document.getElementById('callMinimizedBar').style.display='none';
  if(window._callMinSyncInterval){clearInterval(window._callMinSyncInterval);window._callMinSyncInterval=null;}
  document.getElementById('callVideoArea').style.display='none';
  document.getElementById('callAudioArea').style.display='flex';
  document.getElementById('localVideo').srcObject=null;
  document.getElementById('remoteVideo').srcObject=null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   KONTROLLER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Mƒ∞Nƒ∞Mƒ∞ZE / MAKSƒ∞Mƒ∞ZE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function minimizeCallScreen(){
  document.getElementById('callScreen').style.display='none';
  const bar=document.getElementById('callMinimizedBar');
  const nameEl=document.getElementById('callMinBar_name');
  const statusEl=document.getElementById('callMinBar_status');
  if(nameEl) nameEl.textContent=_callOther||'G√∂r√º≈üme';
  bar.style.display='flex';
  if(window._callMinSyncInterval) clearInterval(window._callMinSyncInterval);
  window._callMinSyncInterval=setInterval(()=>{
    const m=Math.floor(_callSeconds/60).toString().padStart(2,'0');
    const s=(_callSeconds%60).toString().padStart(2,'0');
    if(statusEl) statusEl.textContent=m+':'+s;
  },500);
  _initMinBarDrag(bar);
}
function maximizeCallScreen(){
  if(window._callMinSyncInterval){clearInterval(window._callMinSyncInterval);window._callMinSyncInterval=null;}
  document.getElementById('callMinimizedBar').style.display='none';
  document.getElementById('callScreen').style.display='flex';
}
function _initMinBarDrag(bar){
  if(bar._dragInited) return; bar._dragInited=true;
  let sx,sy,bx,by,dragging=false;
  const getPos=e=>e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY};
  bar.addEventListener('mousedown',e=>{
    if(e.target.closest('[title]')&&e.target!==bar) return;
    dragging=true; const p=getPos(e); sx=p.x; sy=p.y;
    const r=bar.getBoundingClientRect(); bx=r.left; by=r.top;
    bar.style.transition='none'; bar.style.cursor='grabbing'; e.preventDefault();
  });
  bar.addEventListener('touchstart',e=>{
    if(e.target.closest('[title]')&&e.target!==bar) return;
    dragging=true; const p=getPos(e); sx=p.x; sy=p.y;
    const r=bar.getBoundingClientRect(); bx=r.left; by=r.top;
    bar.style.transition='none'; e.preventDefault();
  },{passive:false});
  document.addEventListener('mousemove',e=>{
    if(!dragging) return;
    const p=getPos(e);
    bar.style.left=Math.max(0,Math.min(window.innerWidth-bar.offsetWidth,bx+(p.x-sx)))+'px';
    bar.style.top=Math.max(0,Math.min(window.innerHeight-bar.offsetHeight,by+(p.y-sy)))+'px';
    bar.style.transform='none'; bar.style.bottom='auto';
  });
  document.addEventListener('touchmove',e=>{
    if(!dragging) return;
    const p=getPos(e);
    bar.style.left=Math.max(0,Math.min(window.innerWidth-bar.offsetWidth,bx+(p.x-sx)))+'px';
    bar.style.top=Math.max(0,Math.min(window.innerHeight-bar.offsetHeight,by+(p.y-sy)))+'px';
    bar.style.transform='none'; bar.style.bottom='auto';
  },{passive:false});
  const onEnd=()=>{dragging=false;bar.style.cursor='grab';bar.style.transition='';};
  document.addEventListener('mouseup',onEnd);
  document.addEventListener('touchend',onEnd);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GELEN ARAMA G√ñSTER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showIncomingCall(from, type){
  const labels={video:'üìπ G√∂r√ºnt√ºl√º',screen:'üñ•Ô∏è Ekran Payla≈üƒ±mƒ±',audio:'üìû Sesli Arama'};
  const el=document.getElementById('incomingCallScreen');
  const av=document.getElementById('incomingCallAv');
  const nm=document.getElementById('incomingCallName');
  const tp=document.getElementById('incomingCallType');
  if(av){av.textContent=initials(from);av.style.background=strColor(from);}
  if(nm) nm.textContent=from;
  if(tp) tp.textContent=labels[type]||'üìû Sesli Arama';
  el.style.display='flex';
  playRingSound();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   KONTROLLER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function toggleMute(){
  _isMuted=!_isMuted;
  if(_localStream) _localStream.getAudioTracks().forEach(t=>t.enabled=!_isMuted);
  const btn=document.getElementById('callMuteBtn');
  btn.style.background=_isMuted?'rgba(224,85,85,.35)':'rgba(255,255,255,.1)';
  btn.style.borderColor=_isMuted?'rgba(224,85,85,.6)':'rgba(255,255,255,.15)';
  btn.innerHTML=_isMuted
    ?`<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="9" y="2" width="6" height="11" rx="3" fill="rgba(255,255,255,.9)"/><path d="M5 11a7 7 0 0 0 14 0" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="18" x2="12" y2="22" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/><line x1="9" y1="22" x2="15" y2="22" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/><line x1="3" y1="3" x2="21" y2="21" stroke="rgba(255,80,80,.9)" stroke-width="2.2" stroke-linecap="round"/></svg>`
    :`<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="9" y="2" width="6" height="11" rx="3" fill="rgba(255,255,255,.9)"/><path d="M5 11a7 7 0 0 0 14 0" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/><line x1="12" y1="18" x2="12" y2="22" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/><line x1="9" y1="22" x2="15" y2="22" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/></svg>`;
  _updateParticipantsUI();
}

let _isSpeakerMuted=false;
function toggleSpeaker(){
  _isSpeakerMuted=!_isSpeakerMuted;
  document.querySelectorAll('[id^="_rAudio_"]').forEach(a=>{a.muted=_isSpeakerMuted;});
  const rv=document.getElementById('remoteVideo');
  if(rv) rv.muted=_isSpeakerMuted;
  const btn=document.getElementById('callSpeakerBtn');
  if(btn){
    btn.style.background=_isSpeakerMuted?'rgba(224,85,85,.35)':'rgba(255,255,255,.1)';
    btn.style.borderColor=_isSpeakerMuted?'rgba(224,85,85,.6)':'rgba(255,255,255,.15)';
    btn.innerHTML=_isSpeakerMuted
      ?`<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M11 5L6 9H2v6h4l5 4V5z" fill="rgba(255,255,255,.9)"/><line x1="23" y1="9" x2="17" y2="15" stroke="rgba(255,80,80,.9)" stroke-width="2.2" stroke-linecap="round"/><line x1="17" y1="9" x2="23" y2="15" stroke="rgba(255,80,80,.9)" stroke-width="2.2" stroke-linecap="round"/></svg>`
      :`<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M11 5L6 9H2v6h4l5 4V5z" fill="rgba(255,255,255,.9)"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" stroke="rgba(255,255,255,.9)" stroke-width="2" stroke-linecap="round"/></svg>`;
  }
  showToast(_isSpeakerMuted?'üîá Hoparl√∂r kapatƒ±ldƒ±':'üîä Hoparl√∂r a√ßƒ±ldƒ±');
}

async function toggleScreenShare(){
  if(Object.keys(_peers).length===0){showToast('√ñnce arama ba≈ülatƒ±n.');return;}
  if(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia){showToast('Tarayƒ±cƒ±nƒ±z ekran payla≈üƒ±mƒ±nƒ± desteklemiyor.');return;}

  const btn=document.getElementById('callShareScreenBtn');

  if(!_isSharingScreen){
    try{
      _screenStream = await navigator.mediaDevices.getDisplayMedia({video:{cursor:'always'},audio:false});
    }catch(e){showToast('Ekran payla≈üƒ±mƒ± iptal edildi.');return;}
    _isSharingScreen=true;
    if(btn){btn.classList.add('active');btn.title='Payla≈üƒ±mƒ± Durdur';}

    const screenTrack=_screenStream.getVideoTracks()[0];
    // T√ºm peer baƒülantƒ±larƒ±na uygula
    for(const pc of Object.values(_peers)){
      const senders=pc.getSenders();
      const vs=senders.find(s=>s.track&&s.track.kind==='video');
      if(vs) await vs.replaceTrack(screenTrack).catch(()=>{});
    }
    const lv=document.getElementById('localVideo');
    if(lv){lv.srcObject=_screenStream;lv.style.display='block';}
    document.getElementById('callVideoArea').style.display='block';
    document.getElementById('callAudioArea').style.display='none';
    screenTrack.onended=()=>{if(_isSharingScreen) toggleScreenShare();};
    showToast('üñ•Ô∏è Ekran payla≈üƒ±mƒ± ba≈üladƒ±.');
  } else {
    _isSharingScreen=false;
    if(btn){btn.classList.remove('active');btn.title='Ekran Payla≈ü';}
    if(_screenStream){_screenStream.getTracks().forEach(t=>t.stop());_screenStream=null;}
    if(_callType==='video'){
      try{
        const camStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
        const camTrack=camStream.getVideoTracks()[0];
        for(const pc of Object.values(_peers)){
          const vs=pc.getSenders().find(s=>s.track&&s.track.kind==='video');
          if(vs) await vs.replaceTrack(camTrack).catch(()=>{});
        }
        const lv=document.getElementById('localVideo');
        if(lv) lv.srcObject=_localStream;
      }catch(e){}
      document.getElementById('callVideoArea').style.display='block';
      document.getElementById('callAudioArea').style.display='none';
    } else {
      document.getElementById('callVideoArea').style.display='none';
      document.getElementById('callAudioArea').style.display='flex';
    }
    showToast('Ekran payla≈üƒ±mƒ± durduruldu.');
  }
}

async function toggleCamera(){
  if(!_localStream) return;
  const vt=_localStream.getVideoTracks();
  if(!vt.length) return;
  _isCameraOn=!_isCameraOn;
  vt.forEach(t=>t.enabled=_isCameraOn);
  const btn=document.getElementById('callCamBtn');
  if(btn){
    btn.style.background=_isCameraOn?'rgba(255,255,255,.1)':'rgba(224,85,85,.35)';
    btn.style.borderColor=_isCameraOn?'rgba(255,255,255,.15)':'rgba(224,85,85,.6)';
    btn.innerHTML=_isCameraOn
      ?`<svg width="22" height="22" viewBox="0 0 24 24" fill="rgba(255,255,255,.9)"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>`
      :`<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M23 7l-7 5 7 5V7z" fill="rgba(255,255,255,.9)"/><rect x="1" y="5" width="15" height="14" rx="2" fill="rgba(255,255,255,.9)"/><line x1="1" y1="1" x2="23" y2="23" stroke="rgba(255,80,80,.9)" stroke-width="2.2" stroke-linecap="round"/></svg>`;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üîî Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _notifPermission = 'default';
let _lastNotifTs = {};

async function requestNotifPermission(){
  if(!('Notification' in window)) return;
  if(Notification.permission==='granted'){ _notifPermission='granted'; return; }
  if(Notification.permission!=='denied'){
    const result = await Notification.requestPermission();
    _notifPermission = result;
  }
}

function showPushNotification(title, body, icon){
  if(_notifPermission!=='granted') return;
  if(document.visibilityState==='visible') return;
  try {
    const n = new Notification(title, {body, icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="14" fill="%232c3038"/><text y="44" x="32" text-anchor="middle" font-size="36">'+icon+'</text></svg>', badge:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="14" fill="%232c3038"/></svg>', vibrate:[200,100,200]});
    n.onclick=()=>{window.focus();n.close();};
    setTimeout(()=>n.close(),5000);
  } catch(e){}
}

/* ‚ïê‚ïê SES Sƒ∞STEMƒ∞ ‚ïê‚ïê */
let _audioCtx = null;
let _audioUserGestured = false;
function getAudioCtx(){
  if(!_audioUserGestured) return null;
  if(!_audioCtx) _audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  if(_audioCtx.state==='suspended') _audioCtx.resume();
  return _audioCtx;
}



/* ‚ïê‚ïê PROFƒ∞L TAB Sƒ∞STEMƒ∞ ‚ïê‚ïê */
let _profTab = 'profile';
function switchProfTab(tab){
  if(tab==='profile'){
    setTimeout(loadBio, 50);
    // Arkada≈ü sayƒ±sƒ± ve rozet g√ºncelle
    setTimeout(()=>{
      if(typeof updateProfileFriendCount==='function') updateProfileFriendCount();
      // Mesaj sayƒ±sƒ±nƒ± Firebase'den al
      if(_db&&_cu){
        dbRef('users/'+_cu).once('value').then(snap=>{
          const d=snap.val()||{};
          const mc=d.msgCount||0;
          const el=document.getElementById('profMsgCount');
          if(el) el.textContent=mc>999?Math.floor(mc/1000)+'K':mc;
          if(typeof updateProfileBadges==='function') updateProfileBadges(mc);
        }).catch(()=>{});
      }
    },100);
  }
  _profTab = tab;
  ['profile','appearance','sounds','account'].forEach(t=>{
    const btn = document.getElementById('ptab-'+t);
    const body = document.getElementById('profTabBody-'+t);
    if(btn){
      btn.style.color = t===tab ? '#fff' : 'var(--muted)';
      btn.style.borderBottom = t===tab ? '2px solid var(--accent)' : '2px solid transparent';
    }
    if(body) body.style.display = t===tab ? 'block' : 'none';
  });
  if(tab==='appearance') { renderUiStyleGrid(); }
  if(tab==='sounds'){ renderToneGrids(); }
  if(tab==='account'){
    const ab=document.getElementById('adminPanelBtn');
    if(ab) ab.style.display=_isAdmin?'flex':'none';
  }
}
/* ‚ïê‚ïê PROFƒ∞L TAB SON ‚ïê‚ïê */

/* ‚ïê‚ïê SES TERCƒ∞Hƒ∞ ‚ïê‚ïê */
const RING_TONES = [
  { id:'classic',  label:'Klasik',    desc:'Telefon zili' },
  { id:'modern',   label:'Modern',    desc:'Dijital bip'  },
  { id:'retro',    label:'Retro',     desc:'Eski stil'    },
  { id:'soft',     label:'Yumu≈üak',   desc:'Sakin melodi' },
  { id:'crystal',  label:'Kristal',   desc:'Cam √ßƒ±ngƒ±rak' },
  { id:'nature',   label:'Doƒüa',      desc:'Orman sesi'   },
  { id:'alarm',    label:'Alarm',     desc:'G√º√ßl√º uyarƒ±'  },
];
const NOTIF_TONES = [
  { id:'default',  label:'Varsayƒ±lan', desc:'√áift bip'    },
  { id:'ding',     label:'Ding',       desc:'Tek ton'     },
  { id:'pop',      label:'Pop',        desc:'Mesaj popu'  },
  { id:'chime',    label:'Chime',      desc:'√áan sesi'    },
  { id:'water',    label:'Su Damlasƒ±', desc:'Hafif tƒ±kƒ±rtƒ±'},
  { id:'bubble',   label:'Kabarcƒ±k',  desc:'Yumu≈üak bip'  },
  { id:'whistle',  label:'Islƒ±k',      desc:'Hafif ƒ±slƒ±k' },
  { id:'wood',     label:'Tahta',      desc:'Odun vurma'  },
  { id:'silent',   label:'Sessiz',     desc:'Ses yok'     },
];

// Her okumada localStorage'dan al ‚Äî b√∂ylece her sekme/her a√ßƒ±lƒ±≈üta g√ºncel
function getSelectedRing(){ return localStorage.getItem('sohbet_ring') || 'nature'; }
function getSelectedNotif(){ return localStorage.getItem('sohbet_notif') || 'bubble'; }

function renderToneGrids(){
  const ring = getSelectedRing();
  const notif = getSelectedNotif();
  // Sayfada birden fazla grid olabilir (mobil + desktop) ‚Äî hepsini g√ºncelle
  document.querySelectorAll('#ringToneGrid').forEach(rg=>{
    rg.innerHTML = RING_TONES.map(t=>`
      <div onclick="selectRingTone('${t.id}')" style="
        cursor:pointer;border-radius:10px;padding:10px 8px;text-align:center;
        background:${ring===t.id?'var(--purple)':'var(--surface)'};
        border:2px solid ${ring===t.id?'var(--accent)':'transparent'};
        transition:all .15s;
      ">
        <div style="font-size:.95rem;font-weight:700;color:var(--text-hi)">${t.label}</div>
        <div style="font-size:.68rem;color:var(--muted);margin-top:2px">${t.desc}</div>
      </div>`).join('');
  });
  document.querySelectorAll('#notifToneGrid').forEach(ng=>{
    ng.innerHTML = NOTIF_TONES.map(t=>`
      <div onclick="selectNotifTone('${t.id}')" style="
        cursor:pointer;border-radius:10px;padding:10px 8px;text-align:center;
        background:${notif===t.id?'var(--purple)':'var(--surface)'};
        border:2px solid ${notif===t.id?'var(--accent)':'transparent'};
        transition:all .15s;
      ">
        <div style="font-size:.95rem;font-weight:700;color:var(--text-hi)">${t.label}</div>
        <div style="font-size:.68rem;color:var(--muted);margin-top:2px">${t.desc}</div>
      </div>`).join('');
  });
}
function selectRingTone(id){
  localStorage.setItem('sohbet_ring', id);
  renderToneGrids();
  _playSoundById('ring', id);
}
function selectNotifTone(id){
  localStorage.setItem('sohbet_notif', id);
  renderToneGrids();
  _playSoundById('notif', id);
}

// Tek merkezi ses √ßalma fonksiyonu ‚Äî preview ve ger√ßek ses aynƒ±
function _playSoundById(type, id){
  if(id==='silent') return;
  try{
    const ctx = getAudioCtx();
    if(!ctx) return;
    if(ctx.state==='suspended'){ ctx.resume().then(()=>_playSoundById(type,id)); return; }
    const mg = ctx.createGain(); mg.gain.value=1.8; mg.connect(ctx.destination);
    const t = ctx.currentTime;
    if(type==='ring'){
      if(id==='classic'){
        [[0,.18],[.22,.18],[.44,.18],[.66,.18]].forEach(([w,d])=>{
          _toneBeep(ctx,mg,t+w,800,d,'sawtooth');
          _toneBeep(ctx,mg,t+w,1200,d,'square');
        });
      } else if(id==='modern'){
        [[0,.15],[.2,.15],[.4,.15]].forEach(([w,d])=>_toneBeep(ctx,mg,t+w,880,d,'sine'));
      } else if(id==='retro'){
        [0,.1,.2,.3,.4,.5].forEach(w=>_toneBeep(ctx,mg,t+w,660,.09,'square'));
      } else if(id==='soft'){
        [[0,523,.25],[.3,659,.25],[.6,784,.25]].forEach(([w,f,d])=>_toneBeep(ctx,mg,t+w,f,d,'sine'));
      } else if(id==='crystal'){
        // Kristal √ßƒ±ngƒ±rak - y√ºksek frekans, uzun √ßƒ±nlama
        [[0,1047,.6],[.25,1319,.5],[.5,1568,.45]].forEach(([w,f,d])=>{
          const o=ctx.createOscillator(),g=ctx.createGain();
          o.type='sine'; o.frequency.setValueAtTime(f,t+w);
          g.gain.setValueAtTime(0.8,t+w); g.gain.exponentialRampToValueAtTime(0.001,t+w+d);
          o.connect(g); g.connect(mg); o.start(t+w); o.stop(t+w+d+0.05);
        });
      } else if(id==='nature'){
        // Doƒüa - ku≈ü cƒ±vƒ±ltƒ±sƒ± gibi frekans kaymasƒ±
        [0,.2,.4,.6].forEach((w,i)=>{
          const o=ctx.createOscillator(),g=ctx.createGain();
          o.type='sine';
          o.frequency.setValueAtTime(800+i*120,t+w);
          o.frequency.exponentialRampToValueAtTime(1200+i*80,t+w+0.12);
          g.gain.setValueAtTime(0.5,t+w); g.gain.exponentialRampToValueAtTime(0.001,t+w+0.18);
          o.connect(g); g.connect(mg); o.start(t+w); o.stop(t+w+0.2);
        });
      } else if(id==='alarm'){
        [0,.08,.16,.24,.32,.4,.48].forEach(w=>_toneBeep(ctx,mg,t+w,1100,.07,'sawtooth'));
      }
    } else {
      if(id==='default'){
        [[0,900,.14],[.18,1200,.14]].forEach(([w,f,d])=>_toneBeep(ctx,mg,t+w,f,d,'triangle'));
      } else if(id==='ding'){
        _toneBeep(ctx,mg,t,1047,.35,'sine');
      } else if(id==='pop'){
        _toneBeep(ctx,mg,t,800,.08,'sine');
        _toneBeep(ctx,mg,t+.06,1200,.06,'sine');
      } else if(id==='chime'){
        [[0,523,.18],[.15,659,.18],[.3,784,.18],[.45,1047,.18]].forEach(([w,f,d])=>_toneBeep(ctx,mg,t+w,f,d,'sine'));
      } else if(id==='water'){
        // Su damlasƒ± - kƒ±sa ve tatlƒ±
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type='sine';
        o.frequency.setValueAtTime(1200,t);
        o.frequency.exponentialRampToValueAtTime(400,t+0.15);
        g.gain.setValueAtTime(0.9,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.2);
        o.connect(g); g.connect(mg); o.start(t); o.stop(t+0.22);
      } else if(id==='bubble'){
        // Kabarcƒ±k - √ßok yumu≈üak √ßift pop
        [[0,600,.12],[.15,800,.1]].forEach(([w,f,d])=>{
          const o=ctx.createOscillator(),g=ctx.createGain();
          o.type='sine'; o.frequency.setValueAtTime(f,t+w);
          o.frequency.exponentialRampToValueAtTime(f*0.6,t+w+d);
          g.gain.setValueAtTime(0.5,t+w); g.gain.exponentialRampToValueAtTime(0.001,t+w+d);
          o.connect(g); g.connect(mg); o.start(t+w); o.stop(t+w+d+0.05);
        });
      } else if(id==='whistle'){
        // Hafif ƒ±slƒ±k
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type='sine';
        o.frequency.setValueAtTime(1800,t);
        o.frequency.linearRampToValueAtTime(2200,t+0.08);
        o.frequency.linearRampToValueAtTime(1600,t+0.2);
        g.gain.setValueAtTime(0.6,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.25);
        o.connect(g); g.connect(mg); o.start(t); o.stop(t+0.28);
      } else if(id==='wood'){
        // Tahta vurma - d√º≈ü√ºk frekans, hƒ±zlƒ± √ß√ºr√ºme
        const o=ctx.createOscillator(),g=ctx.createGain();
        o.type='triangle'; o.frequency.setValueAtTime(300,t);
        o.frequency.exponentialRampToValueAtTime(80,t+0.08);
        g.gain.setValueAtTime(1.2,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.12);
        o.connect(g); g.connect(mg); o.start(t); o.stop(t+0.14);
        // ƒ∞kinci vurma
        setTimeout(()=>{try{
          const ctx2=getAudioCtx(),o2=ctx2.createOscillator(),g2=ctx2.createGain(),mg2=ctx2.createGain();
          mg2.gain.value=1.8; mg2.connect(ctx2.destination);
          const t2=ctx2.currentTime;
          o2.type='triangle'; o2.frequency.setValueAtTime(280,t2);
          o2.frequency.exponentialRampToValueAtTime(70,t2+0.07);
          g2.gain.setValueAtTime(0.8,t2); g2.gain.exponentialRampToValueAtTime(0.001,t2+0.1);
          o2.connect(g2); g2.connect(mg2); o2.start(t2); o2.stop(t2+0.12);
        }catch(e){}},200);
      }
    }
  }catch(e){}
}
function _toneBeep(ctx,dest,when,freq,dur,type='sine'){
  const osc=ctx.createOscillator();
  const g=ctx.createGain();
  osc.type=type; osc.frequency.value=freq;
  g.gain.setValueAtTime(0,when);
  g.gain.linearRampToValueAtTime(1,when+0.01);
  g.gain.setValueAtTime(1,when+dur-0.02);
  g.gain.linearRampToValueAtTime(0,when+dur);
  osc.connect(g); g.connect(dest);
  osc.start(when); osc.stop(when+dur+0.05);
}
/* ‚ïê‚ïê SES TERCƒ∞Hƒ∞ SON ‚ïê‚ïê */

// Kullanici ilk etkilesiminde AudioContext unlock
function _unlockAudio(){ _audioUserGestured=true; try{ if(!_audioCtx) _audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if(_audioCtx.state==='suspended') _audioCtx.resume(); }catch(e){} }
document.addEventListener('click', _unlockAudio, {once:true});
document.addEventListener('touchstart', _unlockAudio, {once:true});
document.addEventListener('keydown', _unlockAudio, {once:true});

// Bildirim sesi ‚Äî localStorage'dan oku, _playSoundById ile √ßal
function playNotifSound(){
  const id = getSelectedNotif();
  _playSoundById('notif', id);
}

// Arama zil sesi ‚Äî se√ßilen tona g√∂re
let _ringOscNodes = [];
let _ringInterval = null;
function playRingSound(){
  stopRingSound();
  try{ const ctx=getAudioCtx(); if(ctx && ctx.state==='suspended') ctx.resume(); }catch(e){}
  const playOnce = ()=>{
    try {
      const ctx = getAudioCtx();
      if(ctx.state==='suspended'){ ctx.resume().then(playOnce); return; }
      // localStorage'dan g√ºncel se√ßimi al
      const id = getSelectedRing();
      _playSoundById('ring', id);
    } catch(e){}
  };
  playOnce();
  _ringInterval = setInterval(playOnce, 1400);
}

function stopRingSound(){
  if(_ringInterval){ clearInterval(_ringInterval); _ringInterval=null; }
  _ringOscNodes.forEach(n=>{ try{n.stop();}catch(e){} });
  _ringOscNodes = [];
}

function checkAndNotify(roomId, msg){
  if(!msg||!msg.user||msg.user===_cu||msg.sys) return;
  const isActiveRoom = (_cRoom===roomId||_deskRoom===roomId) && document.visibilityState==='visible';
  // Duplicate √∂nleme
  const key=roomId+'_'+msg.ts;
  if(_lastNotifTs[key]) return;
  _lastNotifTs[key]=true;
  if(Object.keys(_lastNotifTs).length>50) _lastNotifTs={};
  // Susturulmu≈ü oda kontrol√º
  const muted = JSON.parse(localStorage.getItem('sohbet_muted')||'{}');
  if(muted[roomId]) return;
  dbRef('rooms/'+roomId).once('value').then(snap=>{
    const room = snap.val();
    if(!room) return;
    if(room.type==='dm'||room.type==='group'){
      const members = room.members||[];
      if(!members.includes(_cu)) return;
    }
    // Ses her zaman √ßal (aktif odada da)
    playNotifSound();
    if(navigator.vibrate) navigator.vibrate([100,50,100]);
    // Push bildirimi sadece arka planda
    if(!isActiveRoom){
      const text = msg.file?'üìé Dosya g√∂nderdi':(msg.text||'').slice(0,60);
      showPushNotification('üí¨ '+msg.user, text, 'üí¨');
    }
  });
}
/* ‚ïê‚ïê ARAMA & Bƒ∞LDƒ∞Rƒ∞M SON ‚ïê‚ïê */

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
function waitForFirebase(cb,tries=0){
  if(typeof firebase!=='undefined'&&firebase.database){cb();}
  else if(tries<20){setTimeout(()=>waitForFirebase(cb,tries+1),100);}
  else{document.body.innerHTML='<div style="color:#fff;background:#3f0e40;height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;text-align:center;font-family:sans-serif;"><div><div style="font-size:3rem;margin-bottom:16px">‚ö†Ô∏è</div><div style="font-size:1.1rem;font-weight:700;margin-bottom:8px">Baƒülantƒ± hatasƒ±</div><div style="font-size:.9rem;opacity:.7">Sayfayƒ± yenileyin veya internet baƒülantƒ±nƒ±zƒ± kontrol edin.</div><button onclick="location.reload()" style="margin-top:20px;padding:12px 24px;background:#fff;color:#3f0e40;border:none;border-radius:8px;font-size:1rem;font-weight:700;cursor:pointer">Yenile</button></div></div>';}
}
document.addEventListener('DOMContentLoaded',()=>{
  const lastServer = localStorage.getItem('sohbet_last_server');
  if(lastServer && typeof FB_SERVERS!=='undefined' && FB_SERVERS[lastServer]){
    const savedUser = localStorage.getItem('sohbet_user_' + lastServer);
    const savedPass = localStorage.getItem('sohbet_pass_' + lastServer);
    if(savedUser && savedPass){
      _activeServer = lastServer;
      FB_CONFIG = FB_SERVERS[lastServer].config;
      _FB_REST = FB_SERVERS[lastServer].config.databaseURL;

      // Loader ‚Äî mevcut ekrana dokunmaz
      const loader = document.createElement('div');
      loader.id = '_autoLoginLoader';
      loader.style.cssText = 'position:fixed;inset:0;z-index:99999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;';
      loader.innerHTML =
        '<div style="font-size:2.5rem;">'+(FB_SERVERS[lastServer].icon||'üí¨')+'</div>'+
        '<div style="font-size:1rem;font-weight:700;color:var(--text-hi);">'+(FB_SERVERS[lastServer].label||'')+'</div>'+
        '<div class="ld"><span></span><span></span><span></span></div>'+
        '<div style="font-size:.82rem;color:var(--muted);">Oturum y√ºkleniyor...</div>';
      document.body.appendChild(loader);

      const removeLoader = ()=>{ const l=document.getElementById('_autoLoginLoader'); if(l)l.remove(); };

      waitForFirebase(async ()=>{
        try{
          if(!await fbInit()) throw new Error('fbInit failed');
          const rootD = await fbRestGet('users/'+savedUser).catch(()=>null);
          if(rootD && rootD.passwordHash===savedPass && !rootD.banned){
            _passwordHash=savedPass; _cu=savedUser; _isAdmin=false;
            removeLoader();
            onLoginSuccess();
            return;
          }
        }catch(e){ console.warn('Otomatik giri≈ü ba≈üarƒ±sƒ±z:',e); }
        localStorage.removeItem('sohbet_last_server');
        removeLoader();
        // Ba≈üarƒ±sƒ±z otomatik giri≈üte Ekosistem Chat login ekranƒ±na d√∂n
        _activeServer = 'chat';
        FB_CONFIG     = FB_SERVERS['chat'].config;
        _FB_REST      = FB_SERVERS['chat'].config.databaseURL;
        await fbInit().catch(()=>{});
        const ss_fl = document.getElementById('serverSelectScreen');
        const ls_fl = document.getElementById('loginScreen');
        if(ss_fl) ss_fl.classList.remove('active');
        if(ls_fl) ls_fl.classList.add('active');
        if(typeof startTurkQuoteTimer === 'function') startTurkQuoteTimer();
      });
      return;
    }
  }

  // ‚îÄ‚îÄ Varsayƒ±lan Sunucu: Ekosistem Chat (lisa-518f0) ‚îÄ‚îÄ
  const _DEFAULT_SERVER = 'chat';
  if(typeof FB_SERVERS !== 'undefined' && FB_SERVERS[_DEFAULT_SERVER]){
    _activeServer = _DEFAULT_SERVER;
    FB_CONFIG     = FB_SERVERS[_DEFAULT_SERVER].config;
    _FB_REST      = FB_SERVERS[_DEFAULT_SERVER].config.databaseURL;

    waitForFirebase(async ()=>{
      try{
        const ok = await fbInit();
        if(!ok) throw new Error('fbInit ba≈üarƒ±sƒ±z');
      }catch(e){
        console.warn('Ekosistem Chat baƒülantƒ± hatasƒ±:', e);
      }
      const ls = document.getElementById('loginScreen');
      const ss = document.getElementById('serverSelectScreen');
      if(ss) ss.classList.remove('active');
      if(ls) ls.classList.add('active');
      if(typeof startTurkQuoteTimer === 'function') startTurkQuoteTimer();
    });
    return;
  }

  // Fallback: sunucu bulunamazsa se√ßim ekranƒ±
  setTimeout(()=>{
    const anyActive=document.querySelector('.screen.active');
    if(!anyActive){
      const ss=document.getElementById('serverSelectScreen');
      if(ss){ ss.classList.add('active'); renderServerSelect(); }
    }
  },2000);

  waitForFirebase(()=>{});
  renderServerSelect();

  setTimeout(()=>{
    const serverScreen=document.getElementById('serverSelectScreen');
    const anyActive=document.querySelector('.screen.active');
    if(!anyActive && serverScreen){ serverScreen.classList.add('active'); renderServerSelect(); }
  },4000);
});

/* ‚ïê‚ïê Gƒ∞Rƒ∞≈û ALANLARI ‚ïê‚ïê */
document.addEventListener('DOMContentLoaded', function() {
  function onEnter(id, cb) {
    var el = document.getElementById(id);
    if (el) el.addEventListener('keydown', function(e) { if (e.key === 'Enter') { e.preventDefault(); cb(); } });
  }
  onEnter('loginUser', loginNext);
  onEnter('loginPass', submitLogin);
  onEnter('regUser', submitRegister);
  onEnter('regPass', submitRegister);
  onEnter('regPass2', submitRegister);
  if (!CSS.supports('-webkit-text-security', 'disc')) {
    ['loginPass','regPass','regPass2'].forEach(function(id) {
      var el = document.getElementById(id); if (el) el.setAttribute('type', 'password');
    });
  }
});
/* ‚ïê‚ïê Gƒ∞Rƒ∞≈û ALANLARI SON ‚ïê‚ïê */


/* ‚ïê‚ïê SWIPE GERƒ∞ ANƒ∞MASYON ‚ïê‚ïê */
document.addEventListener('DOMContentLoaded',function(){
  var sx=0,sy=0,dragging=false,confirmed=false;
  var W=window.innerWidth;

  function getActive(){
    var a=document.querySelector('.screen.active');
    if(!a) return null;
    if(a.id==='loginScreen'||a.id==='roomsScreen') return null;
    return a;
  }

  function doGoBack(el){
    if(el.id==='chatScreen') goBack();
    else switchMainTab('home');
  }

  function snapBack(el){
    el.style.transition='transform .25s cubic-bezier(.4,0,.2,1)';
    el.style.transform='translateX(0)';
    setTimeout(function(){ el.style.transition=''; el.style.transform=''; },260);
  }

  function snapComplete(el){
    el.style.transition='transform .22s cubic-bezier(.4,0,.2,1)';
    el.style.transform='translateX('+W+'px)';
    setTimeout(function(){
      el.style.transition='';
      el.style.transform='';
      doGoBack(el);
    },220);
  }

  document.addEventListener('touchstart',function(e){
    W=window.innerWidth;
    var a=getActive(); if(!a) return;
    sx=e.touches[0].clientX;
    sy=e.touches[0].clientY;
    dragging=false; confirmed=false;
  },{passive:true});

  document.addEventListener('touchmove',function(e){
    var a=getActive(); if(!a) return;
    var cx=e.touches[0].clientX;
    var cy=e.touches[0].clientY;
    var dx=cx-sx;
    var dy=Math.abs(cy-sy);
    if(!dragging){
      if(dy>12&&dy>Math.abs(dx)){ return; } // dikey scroll
      if(dx>10){ dragging=true; }
      else return;
    }
    if(dx<0) dx=0;
    a.style.transition='none';
    a.style.transform='translateX('+dx+'px)';
    // E≈üiƒüi ge√ßtiyse i≈üaretle
    confirmed=(dx>W*0.38);
  },{passive:true});

  document.addEventListener('touchend',function(e){
    var a=getActive(); if(!a||!dragging){ dragging=false; return; }
    dragging=false;
    var ex=e.changedTouches[0].clientX;
    var dx=ex-sx;
    if(confirmed||dx>W*0.38){ snapComplete(a); }
    else { snapBack(a); }
  },{passive:true});

  document.addEventListener('touchcancel',function(){
    var a=getActive(); if(!a) return;
    snapBack(a);
    dragging=false;
  },{passive:true});
});

/* ‚îÄ‚îÄ PWA SW ‚îÄ‚îÄ */
if('serviceWorker'in navigator){const sw=`const C='sb-v8';self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(['./']).catch(()=>{})));self.skipWaiting();});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==C).map(k=>caches.delete(k)))));});self.addEventListener('fetch',e=>{if(e.request.url.includes('firebase')||e.request.url.includes('gstatic'))return;e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)));});`;navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:'text/javascript'}))).catch(()=>{});}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DESKTOP ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const IS_DESKTOP = () => window.innerWidth >= 768;

let _deskRoom = null;
let _deskNav = 'home';
let _deskMembersOpen = true;
let _deskStopMsg = null;

function initDesktop() {
  if (!IS_DESKTOP()) return;
  document.getElementById('desktopShell').style.display = 'flex';
  document.getElementById('loginScreen').style.display = 'none';
  // Redirect onLoginSuccess to desktop init
}

function deskOnLogin() {
  if (!IS_DESKTOP()) return;
  document.getElementById('desktopShell').style.display = 'flex';
  // Hide all mobile screens
  document.querySelectorAll('.screen').forEach(s => { s.style.display = 'none'; s.classList.remove('active'); });

  // Kendi fotoƒürafƒ±nƒ± cache'e y√ºkle sonra avatarƒ± set et
  if(_db && _cu){
    dbRef('users/'+_cu+'/photoURL').once('value').then(s=>{
      const url=s.val();
      if(url) _avatarCache[_cu]=url;
      const railUser=document.getElementById('deskRailUser');
      if(railUser){
        railUser.innerHTML='<div class="sdot"></div>';
        railUser.style.background=strColor(_cu);
        if(url) _applyAvatarPhoto(railUser,url);
        else railUser.insertAdjacentText('afterbegin',initials(_cu));
        if(!railUser.querySelector('.sdot')){const d=document.createElement('div');d.className='sdot';railUser.appendChild(d);}
      }
      // Sidebar header avatar
      const sideAv=document.getElementById('deskSidebarAvatar');
      if(sideAv){
        sideAv.style.background=strColor(_cu);
        if(url) _applyAvatarPhoto(sideAv,url);
        else { sideAv.insertAdjacentText('afterbegin',initials(_cu)); }
      }
    });
  }
  // rb-admin g√∂r√ºn√ºrl√ºƒü√º onLoginSuccess._finalizeAdminStatus ile y√∂netiliyor

  deskNav('home');
  setTimeout(()=>applyTabIcons(true), 100);
}

function deskNav(tab) {
  if (!IS_DESKTOP()) return;
  _deskNav = tab;
  if(typeof _updateURL === 'function') _updateURL(tab);
  closeEmoji();

  // Update rail active state
  document.querySelectorAll('.rail-btn').forEach(b => b.classList.remove('act'));
  const rbEl = document.getElementById('rb-' + tab);
  if (rbEl) rbEl.classList.add('act');

  const sidebar = document.getElementById('deskSidebar');
  const sideTitle = document.getElementById('deskSidebarTitle');
  const sideSub = document.getElementById('deskSidebarSub');

  // Hide chat, show appropriate content
  document.getElementById('deskEmptyState').style.display = 'flex';
  document.getElementById('deskChatArea').style.display = 'none';
  document.getElementById('deskPanelContent').style.display = 'none';

  if (tab === 'home') {
    sidebar.style.display = 'flex';
    sideTitle.textContent = 'Nature.co';
    sideSub.textContent = 'Kanallar & Gruplar';
    deskLoadRoomList();
    // Sidebar a√ßƒ±k = kul√ºbe g√∂r√ºn√ºr (uyuyorsa)
    if (window._natureBotInstance && window._natureBotInstance.isSleeping) {
      window._natureBotInstance.showKennel();
      window._natureBotInstance.showZzz();
    }
  } else if (tab === 'forum') {
    sidebar.style.display = 'none';
    // Sidebar gizli = kul√ºbeyi gizle
    if (window._natureBotInstance) {
      window._natureBotInstance.hideKennel();
      window._natureBotInstance.hideZzz();
    }
    document.getElementById('deskEmptyState').style.display = 'none';
    document.getElementById('deskPanelContent').style.display = 'flex';
    document.getElementById('deskPanelContent').style.flexDirection = 'column';
    deskLoadForum();
  } else if (tab === 'friends') {
    sidebar.style.display = 'none';
    document.getElementById('deskEmptyState').style.display = 'none';
    document.getElementById('deskPanelContent').style.display = 'flex';
    document.getElementById('deskPanelContent').style.flexDirection = 'column';
    deskLoadFriendsPanel();
  } else if (tab === 'profile') {
    sidebar.style.display = 'none';
    document.getElementById('deskEmptyState').style.display = 'none';
    document.getElementById('deskPanelContent').style.display = 'flex';
    document.getElementById('deskPanelContent').style.flexDirection = 'column';
    deskLoadProfile();
  } else if (tab === 'admin') {
    sidebar.style.display = 'none';
    document.getElementById('deskEmptyState').style.display = 'none';
    document.getElementById('deskPanelContent').style.display = 'flex';
    document.getElementById('deskPanelContent').style.flexDirection = 'column';
    deskLoadAdmin();
  } else if (tab === 'games') {
    sidebar.style.display = 'none';
    document.getElementById('deskEmptyState').style.display = 'none';
    document.getElementById('deskPanelContent').style.display = 'flex';
    document.getElementById('deskPanelContent').style.flexDirection = 'column';
    deskLoadGames();
  } else if (tab === 'watch') {
    sidebar.style.display = 'none';
    document.getElementById('deskEmptyState').style.display = 'none';
    document.getElementById('deskPanelContent').style.display = 'flex';
    document.getElementById('deskPanelContent').style.flexDirection = 'column';
    deskLoadWatch();
  } else if (tab === 'botHome') {
    sidebar.style.display = 'flex';
    const _bhBot = window._natureBotInstance;
    sideTitle.textContent = 'üåø Robot Evi';
    if (_bhBot) {
      if (_bhBot.isSleeping) {
        sideSub.textContent = 'NatureBot uyandƒ±rƒ±lƒ±yor...';
        _bhBot.wakeUp();
      } else {
        sideSub.textContent = 'NatureBot yuvaya g√∂nderildi üò¥';
        _bhBot.goToKennel();
      }
    } else {
      sideSub.textContent = "NatureBot'un ya≈üam alanƒ±";
    }
    const sideList = document.getElementById('deskSidebarList');
    if (sideList) sideList.innerHTML = '<div style="padding:20px 16px;color:var(--muted);font-size:.8rem;text-align:center;line-height:1.6;">üåø Kul√ºbeye tƒ±klayarak<br>robotu uyandƒ±rabilirsin!</div>';
  }
  setTimeout(()=>applyTabIcons(true), 0);
}

function deskLoadRoomList(q) {
  if (!_db) return;
  dbRef('rooms').once('value').then(snap => {
    const rooms = snap.val() || {};
    const all = Object.values(rooms);
    loadRoomOrder();
    const ch = deskApplyOrder(all.filter(r => r.type === 'channel'));
    const grMember = deskApplyOrder(all.filter(r => r.type === 'group' && (r.members || []).includes(_cu)));
    const grHidden = _isAdmin ? deskApplyOrder(all.filter(r => r.type === 'group' && !(r.members || []).includes(_cu))) : [];
    const dm = deskApplyOrder(all.filter(r => r.type === 'dm' && (r.members || []).includes(_cu) && !((r.hiddenBy||[]).includes(_cu))));

    const filter = q ? q.toLowerCase() : '';
    const matchF = name => !filter || (name || '').toLowerCase().includes(filter);

    let h = '';

    if (!filter) {
      // NatureBot √∂zel satƒ±r
      h += `<div class="dsk-sec-hdr"><span class="chev">‚ñ∏</span>NatureBot</div>`;
      h += `<div class="dsk-row" onclick="if(window._natureBotInstance){window._natureBotInstance.el.click();}else{startNatureBot&&startNatureBot();}" style="position:relative;">
        <div class="dsk-row-ic" style="font-size:.85rem;">ü§ñ</div>
        <div class="dsk-row-name" style="color:var(--accent);">NatureBot</div>
        <div style="font-size:.65rem;color:var(--muted);margin-left:auto;padding-right:4px;">AI</div>
      </div>`;

      // Channels
      if (ch.length) {
        h += `<div class="dsk-sec-hdr"><span class="chev">‚ñ∏</span>Kanallar<span class="sec-add-btn" onclick="event.stopPropagation();if(_isAdmin)adminTab('rooms')" title="Kanal olu≈ütur (Admin)">Ôºã</span></div>`;
        ch.filter(r => matchF(r.name)).forEach(r => { h += deskRoomRow(r, false, false); });
      }

      // My groups
      const myGr = grMember.filter(r => matchF(r.name));
      const hiddenGr = grHidden.filter(r => matchF(r.name));
      if (myGr.length || hiddenGr.length || _isAdmin) {
        h += '<div class="dsk-sec-hdr"><span class="chev">‚ñ∏</span>Gruplar<span class="sec-add-btn" onclick="event.stopPropagation();openCreateGroupModal()" title="Grup olu≈ütur">Ôºã</span></div>';
        myGr.forEach(r => { h += deskRoomRow(r, true, false); });
        hiddenGr.forEach(r => { h += deskRoomRow(r, false, true); });
      }

      // DMs
      h += '<div class="dsk-sec-hdr"><span class="chev">‚ñ∏</span>Direkt Mesajlar<span class="sec-add-btn" onclick="event.stopPropagation();openDMModal()" title="Yeni DM">Ôºã</span></div>';
      if (dm.length) {
        dm.forEach(r => { h += deskDmRow(r); });
      } else {
        h += '<div style="padding:4px 14px;font-size:.78rem;color:var(--muted)">Ôºã ile yeni mesaj ba≈ülat</div>';
      }
    } else {
      // Search results
      const allMatch = all.filter(r => r.type !== 'dm' && matchF(r.name));
      const dmMatch = dm.filter(r => {
        const other = (r.members || []).find(m => m !== _cu) || '';
        return matchF(other);
      });
      allMatch.forEach(r => { h += deskRoomRow(r, (r.members || []).includes(_cu), _isAdmin && !(r.members || []).includes(_cu)); });
      dmMatch.forEach(r => { h += deskDmRow(r); });
      if (!allMatch.length && !dmMatch.length) h = '<div style="padding:16px;color:var(--muted);font-size:.82rem;text-align:center">Sonu√ß bulunamadƒ±</div>';
    }

    document.getElementById('deskSideList').innerHTML = h || '<div style="padding:16px;color:var(--muted);font-size:.82rem">Hen√ºz oda yok.</div>';
    setTimeout(initDeskDnd, 50);
  });
}

function deskRoomRow(r, isMyGroup, isHiddenAdmin) {
  const unread = _unread[r.id] || 0;
  const icon = r.type === 'group' ? 'üë•' : '#';
  const isActive = _deskRoom === r.id;
  const last = _lastMsg[r.id] || {};
  const prevText = last.text ? (last.text.length > 42 ? last.text.slice(0,42)+'‚Ä¶' : last.text) : (last.file ? 'üìé Dosya' : '');
  const prevUser = last.user || '';
  const onlineCount = r.type==='group'
    ? (r.members||[]).filter(m=>!!_online[m]).length
    : Object.keys(_online||{}).length;
  const popup = `<div class="room-preview-popup">
    <div class="rpp-name">${icon} ${esc(r.name||r.id)}</div>
    ${prevText ? `<div class="rpp-msg">${prevUser?`<b style="color:var(--text-hi)">${esc(prevUser)}:</b> `:''} ${esc(prevText)}</div>` : ''}
    <div class="rpp-meta"><div class="rpp-dot"></div><span>${onlineCount} √ßevrimi√ßi</span></div>
  </div>`;
  return '<div class="dsk-row' + (isActive ? ' act' : '') + '" data-id="' + r.id + '" style="position:relative" onclick="deskOpenRoom(this.dataset.id)">' +
    '<div class="dsk-drag-handle" onclick="event.stopPropagation()">‚†ø</div>' +
    '<div class="dsk-row-ic">' + icon + '</div>' +
    '<div class="dsk-row-name">' + esc(r.name || r.id) + '</div>' +
    (isHiddenAdmin ? '<span class="dsk-spy-tag">üëÅ</span>' : '') +
    (unread ? '<div class="dsk-row-badge">' + unread + '</div>' : '') +
    popup +
    '</div>';
}

function deskDmRow(r) {
  const other = (r.members || []).find(m => m !== _cu) || '?';
  const on = !!_online[other];
  const unread = _unread[r.id] || 0;
  const isActive = _deskRoom === r.id;
  return '<div class="dsk-row dsk-dm-row' + (isActive ? ' act' : '') + '" data-id="' + r.id + '" onclick="deskOpenRoom(this.dataset.id)">' +
    '<div class="dsk-row-av" style="background:' + strColor(other) + '">' + initials(other) +
    '<div class="r-dot ' + (on ? 'on' : 'off') + '"></div></div>' +
    '<div class="dsk-row-name">' + esc(other) + '</div>' +
    (unread ? '<div class="dsk-row-badge">' + unread + '</div>' : '') +
    `<div class="dsk-dm-close" onclick="event.stopPropagation();closeDmConversation('${r.id}')" title="Kapat">‚úï</div>` +
    '</div>';
}

function deskSearch(q) {
  if (_deskNav === 'home') deskLoadRoomList(q);
  else if (_deskNav === 'friends') deskLoadFriendsList(q);
}

function deskOpenRoom(roomId) {
  if (_deskStopMsg) { _deskStopMsg(); _deskStopMsg = null; }
  _deskRoom = roomId;
  clearUnreadBadge(roomId);
  _currentMsgBox = 'deskMsgs';
  markRoomRead(roomId);
  listenReads(roomId);

  // Highlight active row
  document.querySelectorAll('.dsk-row').forEach(r => r.classList.remove('act'));
  const activeRows = document.querySelectorAll('[onclick*="' + roomId + '"]');
  activeRows.forEach(r => r.classList.add('act'));

  // Show chat area
  document.getElementById('deskEmptyState').style.display = 'none';
  document.getElementById('deskPanelContent').style.display = 'none';
  const ca = document.getElementById('deskChatArea');
  ca.style.display = 'flex';
  ca.style.flexDirection = 'column';
  ca.style.flex = '1';
  ca.style.overflow = 'hidden';

  // Also sync mobile _cRoom for sending
  _cRoom = roomId;
  listenPinBar(roomId);

  const msgs = document.getElementById('deskMsgs');
  msgs.innerHTML = '<div class="ld"><span></span><span></span><span></span></div>';

  // ‚îÄ‚îÄ Mesajlarƒ± HEMEN dinlemeye ba≈üla ‚Äî oda verisini bekleme ‚îÄ‚îÄ
  const ref = dbRef('msgs/' + roomId);
  const h = snap2 => { if (_deskRoom !== roomId) return; deskRenderMsgs(snap2.val()); };
  ref.on('value', h);
  let _deskNotifFirst = true;
  const notifRef = dbRef('msgs/' + roomId);
  const notifH = snap2 => {
    if(_deskNotifFirst){ _deskNotifFirst=false; return; }
    const msg = snap2.val();
    if(msg) checkAndNotify(roomId, msg);
  };
  notifRef.on('child_added', notifH);
  _deskStopMsg = () => { ref.off('value', h); notifRef.off('child_added', notifH); };

  // ‚îÄ‚îÄ Oda verisi paralel y√ºkle (header/ayarlar i√ßin) ‚îÄ‚îÄ
  dbRef('rooms/' + roomId).once('value').then(snap => {
    const room = snap.val();
    if (!room || _deskRoom !== roomId) return;
    const isHiddenAdmin = _isAdmin && room.type === 'group' && !(room.members || []).includes(_cu);

    // Update header
    const ic = document.getElementById('deskChatHdrIcon');
    if (room.type === 'dm') {
      const other = (room.members || []).find(m => m !== _cu) || '?';
      ic.textContent = initials(other); ic.style.background = strColor(other);
      document.getElementById('deskChatHdrName').textContent = other;
      document.getElementById('deskChatHdrSub').textContent = _online[other] ? 'üü¢ √áevrimi√ßi' : '√áevrimdƒ±≈üƒ±';
      document.getElementById('deskCallAudio').style.display = 'flex';
      document.getElementById('deskCallVideo').style.display = 'flex';
      document.getElementById('deskCallScreen').style.display = (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) ? 'flex' : 'none';
      document.getElementById('deskToggleMembers').style.display = 'none';
    } else {
      ic.textContent = room.type === 'group' ? 'üë•' : '#';
      ic.style.background = room.type === 'group' ? 'linear-gradient(135deg,#9b72ff,#c4a7ff)' : 'var(--surface2)';
      document.getElementById('deskChatHdrName').textContent = room.name || roomId;
      document.getElementById('deskChatHdrSub').textContent = room.type === 'group' ? (room.members || []).length + ' √ºye' : 'Kanal';
      document.getElementById('deskCallAudio').style.display = 'none';
      document.getElementById('deskCallVideo').style.display = 'none';
      document.getElementById('deskCallScreen').style.display = 'none';
      document.getElementById('deskToggleMembers').style.display = room.type === 'group' ? 'flex' : 'none';
    }

    // Spy banner
    const spyBanner = document.getElementById('deskSpyBanner');
    const mobileSpyBanner = document.getElementById('adminSpyBanner');
    const spyContent = `<span style="font-size:.82rem;color:#f5a623;font-weight:700;">\u{1F441} G\u00f6zetleme Modu</span><button onclick="adminJoinGroup()" style="margin-left:auto;background:rgba(245,166,35,.2);border:1px solid rgba(245,166,35,.4);color:#f5a623;border-radius:6px;padding:4px 14px;font-size:.78rem;font-weight:700;cursor:pointer;">Gruba Kat\u0131l</button>`;
    if (isHiddenAdmin) {
      spyBanner.innerHTML = spyContent;
      spyBanner.style.display = 'flex';
      if (mobileSpyBanner) { mobileSpyBanner.innerHTML = spyContent; }
      document.getElementById('deskInputArea').style.display = 'none';
    } else {
      spyBanner.style.display = 'none';
      document.getElementById('deskInputArea').style.display = 'block';
      const inp = document.getElementById('deskInp');
      if (inp) inp.placeholder = (room.locked && !_isAdmin) ? 'üîí Bu oda kilitli' : 'Mesaj yaz...';
    }

    // Load members panel
    if (room.type === 'group' && _deskMembersOpen) {
      deskLoadMembers(room);
    } else {
      document.getElementById('deskMemberPanel').classList.add('hidden');
    }

    // Update placeholder for locked rooms
    if (room.locked && !_isAdmin) {
      document.getElementById('deskInp').disabled = true;
      document.getElementById('deskSendBtn').disabled = true;
      document.getElementById('deskInp').placeholder = 'üîí Bu oda kilitli';
    } else {
      document.getElementById('deskInp').disabled = false;
      document.getElementById('deskSendBtn').disabled = false;
    }
  });
}

function deskRenderMsgs(msgsObj) {
  const box = document.getElementById('deskMsgs');
  if (!box) return;
  const wasAtBottom = box.scrollHeight - box.scrollTop - box.clientHeight < 100;
  const msgs = msgsObj ? Object.entries(msgsObj).map(([k,v]) => ({...v, _key: k})).sort((a,b) => a.ts - b.ts) : [];
  if (!msgs.length) {
    box.innerHTML = '<div style="padding:40px 20px;text-align:center;color:var(--muted);font-size:.85rem">Hen√ºz mesaj yok. ƒ∞lk mesajƒ± g√∂nder!</div>';
    return;
  }
  let h = '', lastDate = '', lastUser = '', lastTs = 0;
  msgs.forEach(m => {
    try {
      if (m.sys) { h += '<div class="msg-sys">' + esc(m.text) + '</div>'; lastUser = ''; return; }
      const own = m.user === _cu;
      const d = new Date(m.ts || 0);
      const ds = formatDate(d);
      if (ds !== lastDate) { h += '<div style="text-align:center;margin:12px 0 8px;"><span style="background:var(--surface2);color:var(--muted);font-size:.72rem;border-radius:100px;padding:2px 12px;font-weight:700;">' + ds + '</span></div>'; lastDate = ds; lastUser = ''; }
      const gap = (m.ts - lastTs) > 300000;
      const first = m.user !== lastUser || gap;
      lastUser = m.user; lastTs = m.ts;
      let content = '';
      if (m.file) {
        if (m.file.type && m.file.type.startsWith('image/')) content = m.file.isEmoji ? '<img src="' + m.file.data + '" style="width:48px;height:48px;border-radius:6px;vertical-align:middle;">' : '<img class="msg-img" src="' + m.file.data + '" onclick="zoomImg(this.src)" loading="lazy" style="max-width:300px;border-radius:8px;margin-top:4px;display:block;">';
        else if (m.file.type && m.file.type.startsWith('video/')) content = '<video controls style="max-width:300px;border-radius:8px;margin-top:4px"><source src="' + m.file.data + '" type="' + m.file.type + '"></video>';
        else content = '<div class="msg-file-card" onclick="downloadDataUrl(\'' + m.file.data + '\',\'' + esc(m.file.name||'dosya') + '\')"><div class="msg-file-icon">üìÑ</div><div class="msg-file-info"><div class="msg-file-name">' + esc(m.file.name) + '</div><div class="msg-file-size">' + fmtSize(m.file.size) + '</div></div><div style="margin-left:auto;font-size:1rem;color:var(--muted);">‚¨áÔ∏è</div></div>';
      } else {
        const safeText = linkify(esc(m.text || ''));
        content = own ? '<div class="ob">' + safeText + '</div>' : '<div class="mb-text">' + safeText + '</div>';
      }
      const meta = first ? '<div class="mb-meta"><div class="mb-name" style="color:' + strColor(m.user) + '">' + esc(own ? _cu : m.user) + '</div><div class="mb-ts">' + fmtTime(m.ts) + (own ? getMsgStatusSvg('sent') : '') + '</div></div>' :
        (own ? '<div class="mb-meta mb-meta-mini"><div class="mb-ts">' + fmtTime(m.ts) + getMsgStatusSvg('sent') + '</div></div>' : '');
      const reactionsHtml = buildReactionsHtml(_deskRoom, m._key, m.reactions);
       const avMenuBtnDesk = '<button class="mb-av-menu-btn" data-room="' + _deskRoom + '" data-key="' + m._key + '" data-own="' + own + '" data-admin="' + _isAdmin + '" data-text="' + esc(m.text||'').replace(/"/g,'&quot;') + '" onclick="showMsgMenuAtBtn(event)">‚ãÆ</button>';




       h += '<div class="mb ' + (own ? 'own' : '') + ' ' + (first ? 'first' : '') + '" data-key="' + m._key + '"' + (own ? ' data-ts="' + m.ts + '"' : '') + '>' +
         '<div class="av ' + (first ? '' : 'ghost') + '" style="background:' + strColor(m.user) + '">' + initials(m.user) + '</div>' +
         (own ? avMenuBtnDesk : '') +
         '<div class="mb-body">' + meta + content + reactionsHtml + '</div>' +
         (own ? '' : avMenuBtnDesk) +
         '</div>';
    } catch(e) {}
  });
  const prevKeys = new Set(Array.from(box.querySelectorAll('.mb[data-key]')).map(el=>el.dataset.key));
  box.innerHTML = h;
  if (wasAtBottom) box.scrollTop = box.scrollHeight;
  // Sadece YENƒ∞ gelen mesajlara pop animasyonu
  box.querySelectorAll('.mb[data-key]').forEach(el=>{
    if(!prevKeys.has(el.dataset.key)){
      el.classList.add('pop-in');
      setTimeout(()=>el.classList.remove('pop-in'), 400);
    }
  });
  // Hover tooltip ekle
  if (typeof window._addTimestampTooltips === 'function') {
    // t√ºm mesajlara ts ekle
    msgs.forEach(m => {
      const el = box.querySelector('.mb[data-key="' + m._key + '"]');
      if (el && !el.dataset.ts) el.dataset.ts = m.ts;
    });
    window._addTimestampTooltips();
  }
  if(_deskRoom){markRoomRead(_deskRoom);updateMsgStatuses(_deskRoom);}
}
function deskLoadMembers(room) {
  const panel = document.getElementById('deskMemberPanel');
  const list = document.getElementById('deskMemberList');
  panel.classList.remove('hidden');
  const members = room.members || [];
  const online = members.filter(u => _online[u]);
  const offline = members.filter(u => !_online[u]);
  let h = '';
  if (online.length) {
    h += '<div style="font-size:.65rem;font-weight:900;color:var(--muted);padding:6px 8px 2px;text-transform:uppercase;letter-spacing:.06em;">√áevrimi√ßi ‚Äî ' + online.length + '</div>';
    online.forEach(u => { h += deskMemberRow(u, true); });
  }
  if (offline.length) {
    h += '<div style="font-size:.65rem;font-weight:900;color:var(--muted);padding:10px 8px 2px;text-transform:uppercase;letter-spacing:.06em;">√áevrimdƒ±≈üƒ± ‚Äî ' + offline.length + '</div>';
    offline.forEach(u => { h += deskMemberRow(u, false); });
  }
  list.innerHTML = h;
}

function deskMemberRow(u, online) {
  return '<div class="desk-member-row">' +
    '<div class="desk-m-av" style="background:' + strColor(u) + '">' + initials(u) +
    '<div class="r-dot ' + (online ? 'on' : 'off') + '"></div></div>' +
    '<div class="desk-m-name">' + esc(u) + '</div>' +
    (online ? '<div style="width:7px;height:7px;border-radius:50%;background:var(--green);flex-shrink:0;"></div>' : '') +
    '</div>';
}

function toggleDeskMembers() {
  _deskMembersOpen = !_deskMembersOpen;
  const panel = document.getElementById('deskMemberPanel');
  panel.classList.toggle('hidden', !_deskMembersOpen);
}

function deskLoadFriendsList(q) {
  const list = document.getElementById('deskSideList');
  list.innerHTML = '<div class="ld"><span></span><span></span><span></span></div>';
  dbRef('users').once('value').then(snap => {
    const users = snap.val() || {};
    const filter = (q || '').toLowerCase();
    const all = Object.keys(users).filter(u => {
      if(u === _cu) return false;
      if(users[u].banned) return false;
      if(filter && !u.toLowerCase().includes(filter)) return false;
      return true;
    });
    if (!all.length) { list.innerHTML = '<div style="padding:16px;color:var(--muted);font-size:.82rem">Kullanƒ±cƒ± bulunamadƒ±</div>'; return; }
    const onlineUsers = all.filter(u => _online[u]);
    const offlineUsers = all.filter(u => !_online[u]);
    let h = '';
    if (onlineUsers.length) {
      h += '<div class="dsk-sec-hdr"><span class="chev">‚ñ∏</span>√áevrimi√ßi ‚Äî ' + onlineUsers.length + '</div>';
      onlineUsers.forEach(u => { h += deskUserRow(u, users[u], true); });
    }
    if (offlineUsers.length) {
      h += '<div class="dsk-sec-hdr"><span class="chev">‚ñ∏</span>√áevrimdƒ±≈üƒ±</div>';
      offlineUsers.forEach(u => { h += deskUserRow(u, users[u], false); });
    }
    list.innerHTML = h;
  });
}

function deskUserRow(u, data, online) {
  return '<div class="dsk-row" data-u="' + u + '" onclick="startDMWithUser(this.dataset.u)">' +
    '<div class="dsk-row-av" style="background:' + strColor(u) + '">' + initials(u) +
    '<div class="r-dot ' + (online ? 'on' : 'off') + '"></div></div>' +
    '<div class="dsk-row-name">' + esc(u) + (data.origin ? ' <span style="font-size:.65rem;color:var(--muted);">' + data.origin.split(' ')[0] + '</span>' : '') + '</div>' +
    '</div>';
}

function startDMWithUser(username) {
  if (!_db || !_cu) return;
  const possible = [_cu + '_dm_' + username, username + '_dm_' + _cu];
  dbRef('rooms').once('value').then(snap => {
    const rooms = snap.val() || {};
    const existing = Object.values(rooms).find(r => r.type === 'dm' && r.members && r.members.includes(_cu) && r.members.includes(username));
    if (existing) {
      // Unhide if previously hidden
      if(existing.hiddenBy && existing.hiddenBy.includes(_cu)){
        const updated = existing.hiddenBy.filter(u=>u!==_cu);
        dbRef('rooms/'+existing.id+'/hiddenBy').set(updated.length?updated:null);
      }
      deskNav('home'); setTimeout(() => deskOpenRoom(existing.id), 200); return;
    }
    const id = [_cu, username].sort().join('_dm_');
    dbRef('rooms/' + id).set({ id, type: 'dm', members: [_cu, username], ts: Date.now() }).then(() => {
      deskNav('home');
      setTimeout(() => deskOpenRoom(id), 300);
    });
  });
}

let _deskForumCat = 'hepsi';
let _deskForumStop = null;

function deskLoadForum(cat) {
  if (cat !== undefined) _deskForumCat = cat;
  const panel = document.getElementById('deskPanelContent');
  panel.style.overflowY = 'hidden';
  panel.style.display = 'flex';
  panel.style.flexDirection = 'column';

  const CAT_LABELS2 = {genel:'üí¨ Genel',tarih:'üìú Tarih',kultur:'üé≠ K√ºlt√ºr',spor:'‚öΩ Spor',muzik:'üéµ M√ºzik',teknoloji:'üíª Teknoloji',soru:'‚ùì Soru'};
  function ftab(key,label){ return `<div class="dsk-ftab${_deskForumCat===key?' act':''}" onclick="deskLoadForum('${key}')">${label}</div>`; }

  panel.innerHTML =
    '<div class="dsk-forum-wrap" id="deskForumWrap">'+
      '<div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">'+
        '<div class="dsk-forum-topbar">'+
          ftab('hepsi','T√ºm√º')+ftab('genel','üí¨ Genel')+ftab('tarih','üìú Tarih')+
          ftab('kultur','üé≠ K√ºlt√ºr')+ftab('spor','‚öΩ Spor')+ftab('muzik','üéµ M√ºzik')+
          ftab('teknoloji','üíª Teknoloji')+ftab('soru','‚ùì Soru')+
        '</div>'+
        '<div class="dsk-compose">'+
          '<div style="display:flex;gap:12px;align-items:flex-start;">'+
            '<div style="width:38px;height:38px;border-radius:10px;background:'+strColor(_cu)+';display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:900;color:#fff;flex-shrink:0;">'+initials(_cu)+'</div>'+
            '<div style="flex:1;">'+
              '<div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;transition:border-color .15s;" onfocusin="this.style.borderColor=\'var(--accent)\'" onfocusout="this.style.borderColor=\'var(--border)\'">'+
                '<div style="display:flex;flex-wrap:wrap;gap:1px;padding:5px 8px;border-bottom:1px solid var(--border);background:var(--surface2);align-items:center;">'+
                  '<button onclick="dbbWrap(\'b\')" title="Kalƒ±n" class="fmt-btn"><b>B</b></button>'+
                  '<button onclick="dbbWrap(\'i\')" title="ƒ∞talik" class="fmt-btn"><i>I</i></button>'+
                  '<button onclick="dbbWrap(\'u\')" title="Altƒ± √áizili" class="fmt-btn"><u>U</u></button>'+
                  '<button onclick="dbbWrap(\'s\')" title="√úst√º √áizili" class="fmt-btn"><s>S</s></button>'+
                  '<span style="width:1px;height:16px;background:var(--border);margin:0 3px;flex-shrink:0;"></span>'+
                  '<button onclick="dbbColor()" title="Renk" class="fmt-btn">üé®</button>'+
                  '<button onclick="dbbSize()" title="Boyut" class="fmt-btn" style="font-size:.78rem;font-weight:700;">Aa</button>'+
                  '<span style="width:1px;height:16px;background:var(--border);margin:0 3px;flex-shrink:0;"></span>'+
                  '<button onclick="dbbWrap(\'url\')" title="Link" class="fmt-btn">üîó</button>'+
                  '<button onclick="dbbWrap(\'img\')" title="Resim" class="fmt-btn">üñºÔ∏è</button>'+
                  '<span style="width:1px;height:16px;background:var(--border);margin:0 3px;flex-shrink:0;"></span>'+
                  '<button onclick="dbbInsert(\'[list]\\n[*] \')" title="Liste" class="fmt-btn">‚Ä¢ ‚â°</button>'+
                  '<button onclick="dbbWrap(\'quote\')" title="Alƒ±ntƒ±" class="fmt-btn">‚ùù</button>'+
                  '<button onclick="dbbWrap(\'code\')" title="Kod" class="fmt-btn" style="font-family:monospace;font-size:.8rem;">&lt;/&gt;</button>'+
                  '<button onclick="dbbWrap(\'spoiler\')" title="Spoiler" class="fmt-btn">üëÅÔ∏è</button>'+
                  '<span style="width:1px;height:16px;background:var(--border);margin:0 3px;flex-shrink:0;"></span>'+
                  '<button onclick="toggleDbbPreview()" id="dbbPreviewBtn" title="√ñnizleme" class="fmt-btn" style="font-size:.75rem;font-weight:700;">üëÅ √ñnizle</button>'+
                '</div>'+
                '<textarea class="dsk-compose-inp" id="deskForumInp" placeholder="D√º≈ü√ºncelerini payla≈ü..." rows="3" oninput="this.style.height=\'auto\';this.style.height=Math.min(this.scrollHeight,300)+\'px\'"></textarea>'+
                '<div id="dbbPreviewArea" style="display:none;padding:10px 13px;min-height:50px;border-top:1px solid var(--border);font-size:.9rem;line-height:1.6;color:var(--text-hi);background:var(--bg2);word-break:break-word;"></div>'+
              '</div>'+

              '<div class="dsk-compose-footer">'+
                '<select class="dsk-cat-sel" id="deskForumCatSel">'+
                  '<option value="genel">üí¨ Genel</option><option value="tarih">üìú Tarih</option>'+
                  '<option value="kultur">üé≠ K√ºlt√ºr</option><option value="spor">‚öΩ Spor</option>'+
                  '<option value="muzik">üéµ M√ºzik</option><option value="teknoloji">üíª Teknoloji</option>'+
                  '<option value="soru">‚ùì Soru</option>'+
                '</select>'+
                '<button class="dsk-forum-post-btn" onclick="deskSubmitForumPost()">Payla≈ü ‚Üí</button>'+
              '</div>'+
            '</div>'+
          '</div>'+
        '</div>'+
        '<div class="dsk-forum-feed" id="deskForumFeed"></div>'+
      '</div>';

  deskForumLoadFeed();
}

function deskForumLoadFeed() {
  if (_deskForumStop) { _deskForumStop(); _deskForumStop = null; }
  const feed = document.getElementById('deskForumFeed');
  if (!feed) return;
  const CAT_LABELS2 = {genel:'üí¨ Genel',tarih:'üìú Tarih',kultur:'üé≠ K√ºlt√ºr',spor:'‚öΩ Spor',muzik:'üéµ M√ºzik',teknoloji:'üíª Teknoloji',soru:'‚ùì Soru'};
  let ref = dbRef('forum/posts').orderByChild('ts').limitToLast(80);
  const handler = ref.on('value', snap => {
    const feed2 = document.getElementById('deskForumFeed');
    if (!feed2) return;
    const posts = snap.val() || {};
    const arr = Object.entries(posts).map(([k,v])=>({...v,_key:k})).sort((a,b)=>b.ts-a.ts);
    const filtered = _deskForumCat==='hepsi' ? arr : arr.filter(p=>p.cat===_deskForumCat);
    feed2.innerHTML = filtered.length
      ? filtered.map(p=>deskForumEntryHTML(p)).join('')
      : '<div style="text-align:center;padding:60px 20px;color:var(--muted);"><div style="font-size:3rem;margin-bottom:12px;">üìã</div><div style="font-size:1rem;font-weight:700;color:var(--text-hi);">Hen√ºz entry yok</div><div style="margin-top:6px;font-size:.85rem;">ƒ∞lk entry\'i sen yaz!</div></div>';
  });
  _deskForumStop = ()=>ref.off('value',handler);
}

function deskForumEntryHTML(p) {
  const CAT_LABELS2 = {genel:'üí¨ Genel',tarih:'üìú Tarih',kultur:'üé≠ K√ºlt√ºr',spor:'‚öΩ Spor',muzik:'üéµ M√ºzik',teknoloji:'üíª Teknoloji',soru:'‚ùì Soru'};
  const lc=p.likes?Object.keys(p.likes).length:0, liked=!!(p.likes&&p.likes[_cu]);
  const dc=p.dislikes?Object.keys(p.dislikes).length:0, disliked=!!(p.dislikes&&p.dislikes[_cu]);
  const hc=p.hearts?Object.keys(p.hearts).length:0, hearted=!!(p.hearts&&p.hearts[_cu]);
  const comments=p.comments?Object.values(p.comments).sort((a,b)=>a.ts-b.ts):[];
  const time=new Date(p.ts||0).toLocaleString('tr-TR',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});
  const canDel=(p.user===_cu)||_isAdmin;

  let h = '<div class="dsk-entry" id="dskentry-'+p._key+'">';
  h += '<div class="dsk-entry-header">';
  h += '<div class="dsk-entry-av" style="background:'+strColor(p.user||'?')+'">'+initials(p.user||'?')+'</div>';
  h += '<div class="dsk-entry-meta">';
  h += '<div class="dsk-entry-author">'+esc(p.user||'?')+'<span class="dsk-entry-cat-badge">'+(CAT_LABELS2[p.cat]||p.cat||'')+'</span></div>';
  h += '<div class="dsk-entry-time">'+time+'</div></div>';
  h += canDel?`<button class="dsk-entry-del-btn" onclick="deskForumDeletePost('${p._key}')">üóëÔ∏è</button>`:'';
  h += '</div>';
  h += '<div class="dsk-entry-body">'+(p.bbcode ? parseBBCode(p.text||'') : esc(p.text||''))+'</div>';
  h += '<div class="dsk-entry-footer">';
  h += `<button class="dsk-vote-btn${liked?' active-up':''}" onclick="forumVote('${p._key}','like')"><svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3H14z"/></svg> ${lc}</button>`;
  h += `<button class="dsk-vote-btn${disliked?' active-down':''}" onclick="forumVote('${p._key}','dislike')"><svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3H10z"/></svg> ${dc}</button>`;
  h += `<button class="dsk-vote-btn${hearted?' active-heart':''}" onclick="forumHeart('${p._key}')">‚ù§Ô∏è ${hc}</button>`;
  h += `<button class="dsk-entry-reply-btn" onclick="deskToggleReply('${p._key}')"><svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> ${comments.length?comments.length+' yorum':'Yorum'}</button>`;
  h += '</div>';
  if(comments.length){
    h += '<div class="dsk-comments">';
    comments.forEach(c=>{
      const ct=new Date(c.ts||0).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
      const cDel=(c.user===_cu)||_isAdmin;
      h += '<div class="dsk-comment"><div class="dsk-comment-av" style="background:'+strColor(c.user||'?')+'">'+initials(c.user||'?')+'</div>';
      h += '<div class="dsk-comment-body"><span class="dsk-comment-author">'+esc(c.user||'?')+'</span><span class="dsk-comment-time">'+ct+'</span>';
      h += cDel?`<button onclick="deskForumDeleteComment('${p._key}','${c.key||''}')" style="background:none;border:none;cursor:pointer;color:var(--muted);font-size:.7rem;margin-left:4px;">‚úï</button>`:'';
      h += '<div class="dsk-comment-text">'+esc(c.text||'')+'</div></div></div>';
    });
    h += '</div>';
  }
  h += '<div class="dsk-reply-area" id="dsk-reply-'+p._key+'">';
  h += `<textarea class="dsk-reply-inp" id="dsk-reply-inp-${p._key}" placeholder="Yorumunu yaz..." rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();deskForumSendComment('${p._key}')}"></textarea>`;
  h += `<button class="dsk-reply-send" onclick="deskForumSendComment('${p._key}')">G√∂nder</button></div>`;
  h += '</div>';
  return h;
}

function deskToggleReply(k){
  const a=document.getElementById('dsk-reply-'+k);
  if(!a)return;
  a.classList.toggle('open');
  if(a.classList.contains('open')){const i=document.getElementById('dsk-reply-inp-'+k);if(i)i.focus();}
}
function deskForumSendComment(postKey){
  const inp=document.getElementById('dsk-reply-inp-'+postKey);
  if(!inp)return;
  const txt=inp.value.trim();if(!txt)return;
  const ck=dbRef('forum/posts/'+postKey+'/comments').push().key;
  dbRef('forum/posts/'+postKey+'/comments/'+ck).set({key:ck,user:_cu,text:txt,ts:Date.now()})
    .then(()=>{inp.value='';inp.style.height='auto';}).catch(()=>showToast('Hata.'));
}
function deskForumDeletePost(k){if(!confirm('Bu entry silinsin mi?'))return;dbRef('forum/posts/'+k).remove().catch(()=>showToast('Hata.'));}
function deskForumDeleteComment(pk,ck){dbRef('forum/posts/'+pk+'/comments/'+ck).remove().catch(()=>showToast('Hata.'));}
/* Desktop BBCode edit√∂r yardƒ±mcƒ±larƒ± */
function dbbWrap(tag){
  const ta=document.getElementById('deskForumInp');
  if(!ta) return;
  const s=ta.selectionStart,e=ta.selectionEnd,sel=ta.value.slice(s,e);
  let open=`[${tag}]`,close=`[/${tag}]`;
  if(tag==='url'){const href=prompt('Link URL:','https://');if(!href)return;open=`[url=${href}]`;close='[/url]';}
  ta.value=ta.value.slice(0,s)+open+sel+close+ta.value.slice(e);
  ta.selectionStart=s+open.length; ta.selectionEnd=s+open.length+sel.length;
  ta.focus(); ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight,300)+'px';
  if(document.getElementById('dbbPreviewArea')?.style.display!=='none') updateDbbPreview();
}
function dbbInsert(text){
  const ta=document.getElementById('deskForumInp');
  if(!ta) return;
  const s=ta.selectionStart;
  ta.value=ta.value.slice(0,s)+text+ta.value.slice(s);
  ta.selectionStart=ta.selectionEnd=s+text.length;
  ta.focus(); ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight,300)+'px';
}
function dbbColor(){
  const c=prompt('Renk (√∂rn: red, #ff0000):','red'); if(!c) return;
  const ta=document.getElementById('deskForumInp');
  const s=ta.selectionStart,e=ta.selectionEnd,sel=ta.value.slice(s,e)||'metin';
  const tag=`[color=${c}]${sel}[/color]`;
  ta.value=ta.value.slice(0,s)+tag+ta.value.slice(e);
  ta.selectionStart=ta.selectionEnd=s+tag.length; ta.focus();
}
function dbbSize(){
  const sz=prompt('Yazƒ± boyutu (8-32):','16'); if(!sz||isNaN(sz)) return;
  const ta=document.getElementById('deskForumInp');
  const s=ta.selectionStart,e=ta.selectionEnd,sel=ta.value.slice(s,e)||'metin';
  const tag=`[size=${sz}]${sel}[/size]`;
  ta.value=ta.value.slice(0,s)+tag+ta.value.slice(e);
  ta.selectionStart=ta.selectionEnd=s+tag.length; ta.focus();
}
function toggleDbbPreview(){
  const area=document.getElementById('dbbPreviewArea');
  const btn=document.getElementById('dbbPreviewBtn');
  const ta=document.getElementById('deskForumInp');
  if(!area) return;
  if(area.style.display==='none'){
    area.style.display='block';
    if(btn){btn.style.background='var(--accent2)';btn.style.color='var(--text-hi)';}
    updateDbbPreview();
    ta.addEventListener('input',updateDbbPreview);
  } else {
    area.style.display='none';
    if(btn){btn.style.background='';btn.style.color='';}
    ta.removeEventListener('input',updateDbbPreview);
  }
}
function updateDbbPreview(){
  const ta=document.getElementById('deskForumInp');
  const area=document.getElementById('dbbPreviewArea');
  if(!ta||!area) return;
  area.innerHTML=parseBBCode(ta.value)||'<span style="color:var(--muted);font-size:.82rem">√ñnizleme burada g√∂r√ºnecek...</span>';
}

function deskSubmitForumPost(){
  const inp=document.getElementById('deskForumInp');
  const txt=inp?.value.trim();
  const cat=document.getElementById('deskForumCatSel')?.value||'genel';
  if(!txt){showToast('Bir ≈üeyler yaz!');return;}
  const btn=document.querySelector('.dsk-forum-post-btn');
  if(btn){btn.disabled=true;btn.textContent='Payla≈üƒ±lƒ±yor...';}
  const key=dbRef('forum/posts').push().key;
  dbRef('forum/posts/'+key).set({key,user:_cu,text:txt,bbcode:true,cat,ts:Date.now(),likes:{},dislikes:{},hearts:{},comments:{}})
    .then(()=>{
      showToast('Entry payla≈üƒ±ldƒ±! ‚úÖ');
      if(inp){inp.value='';inp.style.height='auto';}
      if(btn){btn.disabled=false;btn.textContent='Payla≈ü ‚Üí';}
    }).catch(()=>{showToast('Hata.');if(btn){btn.disabled=false;btn.textContent='Payla≈ü ‚Üí';}});
}

function deskLoadProfile() {
  const panel = document.getElementById('deskPanelContent');
  panel.style.overflowY = 'auto';
  const isAdmin = _isAdmin;
  panel.innerHTML =
    '<div style="max-width:520px;margin:0 auto;display:flex;flex-direction:column;height:100%;">' +
    // Tab bar
    '<div style="display:flex;border-bottom:1px solid var(--border);flex-shrink:0;padding:0 20px;margin-top:16px;">' +
    '<div id="dptab-profile" onclick="deskSwitchProfTab(\'profile\')" style="padding:10px 16px;font-size:.8rem;font-weight:700;color:#fff;border-bottom:2px solid var(--accent);cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>Profil</div>' +
    '<div id="dptab-appearance" onclick="deskSwitchProfTab(\'appearance\')" style="padding:10px 16px;font-size:.8rem;font-weight:700;color:var(--muted);border-bottom:2px solid transparent;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="3"/></svg>G√∂r√ºn√ºm</div>' +
    '<div id="dptab-sounds" onclick="deskSwitchProfTab(\'sounds\')" style="padding:10px 16px;font-size:.8rem;font-weight:700;color:var(--muted);border-bottom:2px solid transparent;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>Sesler</div>' +
    '<div id="dptab-account" onclick="deskSwitchProfTab(\'account\')" style="padding:10px 16px;font-size:.8rem;font-weight:700;color:var(--muted);border-bottom:2px solid transparent;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Hesap</div>' +
    '</div>' +
    // Tab: Profil
    '<div id="dppanel-profile" style="padding:0;overflow-y:auto;">' +
    // Banner
    '<div id="deskProfBanner" style="height:80px;background:linear-gradient(135deg,' + strColor(_cu) + 'aa 0%,var(--bg2) 100%);border-radius:0;flex-shrink:0;"></div>' +
    '<div style="display:flex;flex-direction:column;align-items:center;gap:6px;padding:0 20px 20px;margin-top:-40px;">' +
    // Avatar
    '<div style="position:relative;cursor:pointer;" onclick="triggerPhotoUpload()" title="Fotoƒüraf deƒüi≈ütir">' +
    '<div id="deskProfAvBig" style="width:80px;height:80px;border-radius:20px;background:' + strColor(_cu) + ';display:flex;align-items:center;justify-content:center;font-size:1.6rem;font-weight:900;color:#fff;background-size:cover;background-position:center;border:3px solid var(--bg2);">' + initials(_cu) + '</div>' +
    '<div style="position:absolute;bottom:-4px;right:-4px;width:24px;height:24px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;border:2px solid var(--bg2);">üì∑</div>' +
    // Online dot
    '<div style="position:absolute;bottom:2px;left:-4px;width:12px;height:12px;background:#4ade80;border-radius:50%;border:2px solid var(--bg2);"></div>' +
    '</div>' +
    // ƒ∞sim + badge
    '<div style="font-size:1.1rem;font-weight:900;color:var(--text-hi);margin-top:4px;">' + esc(_cu) + (isAdmin ? ' <span style="background:var(--yellow);color:#000;font-size:.6rem;border-radius:4px;padding:2px 6px;vertical-align:middle;">Admin</span>' : '') + '</div>' +
    // ƒ∞statistik satƒ±rƒ±
    '<div style="display:flex;width:100%;background:var(--surface);border:1px solid var(--border);border-radius:14px;margin-top:10px;overflow:hidden;">' +
    '<div style="flex:1;padding:12px 8px;text-align:center;border-right:1px solid var(--border);">' +
    '<span id="deskProfMsgCount" style="display:block;font-size:1rem;font-weight:900;color:var(--text-hi);">‚Äî</span>' +
    '<span style="display:block;font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-top:2px;">Mesaj</span></div>' +
    '<div style="flex:1;padding:12px 8px;text-align:center;border-right:1px solid var(--border);">' +
    '<span id="deskProfJoinDate" style="display:block;font-size:1rem;font-weight:900;color:var(--text-hi);">‚Äî</span>' +
    '<span style="display:block;font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-top:2px;">Katƒ±lƒ±m</span></div>' +
    '<div style="flex:1;padding:12px 8px;text-align:center;">' +
    '<span style="display:block;"><svg width="10" height="10" viewBox="0 0 10 10"><circle cx="5" cy="5" r="4" fill="#4ade80"/></svg></span>' +
    '<span style="display:block;font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-top:2px;">Aktif</span></div>' +
    '</div>' +
    // Bio kartƒ±
    '<div style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:10px;">' +
    '<div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;display:flex;align-items:center;gap:4px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-1px"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Hakkƒ±mda</div>' +
    '<textarea id="deskProfBioInp" placeholder="Kendinizi kƒ±saca tanƒ±tƒ±n..." maxlength="160" rows="3" ' +
    'oninput="this.style.height=\'auto\';this.style.height=Math.min(this.scrollHeight,120)+\'px\';var c=document.getElementById(\'deskBioCharCount\');if(c)c.textContent=(this.value||\'\')+.length+\'/160\';" ' +
    'style="width:100%;background:transparent;border:none;outline:none;color:var(--text-hi);font-size:.88rem;font-family:inherit;resize:none;line-height:1.5;"></textarea>' +
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">' +
    '<span id="deskBioCharCount" style="font-size:.68rem;color:var(--muted);">0/160</span>' +
    '<button onclick="deskSaveBio()" style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:5px 14px;font-size:.78rem;font-weight:700;cursor:pointer;">Kaydet</button>' +
    '</div></div>' +
    '</div></div>' +
    // Tab: G√∂r√ºn√ºm
    '<div id="dppanel-appearance" style="padding:20px;display:none;">' +
    '<div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">‚ú® Aray√ºz Stili</div>' +
    '<div id="uiStyleGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:18px;"></div>' +
    '<div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">üéØ Navigasyon ƒ∞konlarƒ±</div>' +
    '<div style="display:flex;align-items:center;justify-content:space-between;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:14px;">' +
    '<div><div style="font-size:.85rem;font-weight:700;color:var(--text-hi);">SVG ƒ∞kon Seti</div><div style="font-size:.72rem;color:var(--muted);">Vekt√∂rel ikonlar aktif</div></div>' +
    '<span style="background:rgba(34,197,94,.12);color:#4ade80;border:1px solid rgba(34,197,94,.2);font-size:.68rem;font-weight:700;border-radius:100px;padding:3px 10px;">‚úì Aktif</span>' +
    '</div>' +
    '</div>' +
    // Tab: Sesler
    '<div id="dppanel-sounds" style="padding:20px;display:none;">' +
    '<div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">üìû Arama Zil Sesi</div>' +
    '<div id="ringToneGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"></div>' +
    '<div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin:16px 0 10px;">üîî Bildirim Sesi</div>' +
    '<div id="notifToneGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"></div>' +
    '</div>' +
    // Tab: Hesap
    '<div id="dppanel-account" style="padding:20px;display:none;">' +
    '<div style="display:flex;flex-direction:column;gap:8px;">' +
    (isAdmin ? '<div onclick="deskNav(\'admin\')" style="background:var(--surface2);border-radius:10px;padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;" onmouseover="this.style.background=\'var(--surface)\'" onmouseout="this.style.background=\'var(--surface2)\'"><div style="font-size:1.2rem;">üëë</div><div style="font-size:.9rem;font-weight:700;color:var(--text-hi);">Admin Paneli</div></div>' : '') +
    '<div onclick="openChangePassword()" style="background:var(--surface2);border-radius:10px;padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;" onmouseover="this.style.background=\'var(--surface)\'" onmouseout="this.style.background=\'var(--surface2)\'"><div style="font-size:1.2rem;">üîë</div><div style="font-size:.9rem;font-weight:700;color:var(--text-hi);">≈ûifre Deƒüi≈ütir</div></div>' +
    '<div onclick="deskDoLogout()" style="background:rgba(224,30,90,.1);border-radius:10px;padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:12px;" onmouseover="this.style.background=\'rgba(224,30,90,.2)\'" onmouseout="this.style.background=\'rgba(224,30,90,.1)\'"><div style="font-size:1.2rem;">üö™</div><div style="font-size:.9rem;font-weight:700;color:#e01e5a;">√áƒ±kƒ±≈ü Yap</div></div>' +
    '</div></div>' +
    '</div>';
  const deskAv = document.getElementById('deskProfAvBig');
  if(deskAv) setAvatar(deskAv, _cu);
  setTimeout(()=>{ deskSwitchProfTab('profile'); deskLoadProfileData(); }, 50);
}

async function deskSaveBio(){
  if(!_cu||!_db) return;
  const inp = document.getElementById('deskProfBioInp');
  if(!inp) return;
  const bio = (inp.value||'').slice(0,160);
  await dbRef(wsPath('users/'+_cu+'/bio')).set(bio);
  showToast('‚úÖ Bio kaydedildi');
}

async function deskLoadProfileData(){
  if(!_cu||!_db) return;
  // Bio y√ºkle
  try {
    const bioSnap = await dbRef(wsPath('users/'+_cu+'/bio')).once('value');
    const bio = bioSnap.val()||'';
    const bioInp = document.getElementById('deskProfBioInp');
    if(bioInp){
      bioInp.value = bio;
      bioInp.style.height='auto';
      bioInp.style.height=Math.min(bioInp.scrollHeight,120)+'px';
      const c=document.getElementById('deskBioCharCount');
      if(c) c.textContent=bio.length+'/160';
    }
  } catch(e){}
  // Katƒ±lƒ±m tarihi + mesaj sayƒ±sƒ±
  try {
    const userSnap = await dbRef('users/'+_cu).once('value');
    const u = userSnap.val()||{};
    const joinEl = document.getElementById('deskProfJoinDate');
    if(joinEl && u.joinedAt){
      const d = new Date(u.joinedAt);
      joinEl.textContent = (d.getMonth()+1)+'/'+d.getFullYear();
    }
    const msgEl = document.getElementById('deskProfMsgCount');
    if(msgEl){
      msgEl.textContent = u.msgCount > 999 ? Math.floor(u.msgCount/1000)+'K' : (u.msgCount||'0');
    }
  } catch(e){}
  // Banner rengini ayarla
  const banner = document.getElementById('deskProfBanner');
  if(banner) banner.style.background = 'linear-gradient(135deg,'+strColor(_cu)+'aa 0%,var(--bg2) 100%)';
  // Avatar
  const av = document.getElementById('deskProfAvBig');
  if(av) setAvatar(av, _cu);
}

function deskSwitchProfTab(tab){
  ['profile','appearance','sounds','account'].forEach(t=>{
    const btn=document.getElementById('dptab-'+t);
    const panel=document.getElementById('dppanel-'+t);
    if(btn){ btn.style.color=t===tab?'var(--text-hi)':'var(--muted)'; btn.style.borderBottom=t===tab?'2px solid var(--accent)':'2px solid transparent'; }
    if(panel) panel.style.display=t===tab?'block':'none';
  });
  if(tab==='profile') setTimeout(deskLoadProfileData, 80);
  if(tab==='appearance') { renderUiStyleGrid(); }
  if(tab==='sounds') renderToneGrids();
}

function deskLoadAdmin() {
  const panel = document.getElementById('deskPanelContent');
  const tabs = [
    { key: 'users',      label: 'üë• Kullanƒ±cƒ±' },
    { key: 'rooms',      label: 'üì¢ Oda' },
    { key: 'msgs',       label: 'üí¨ Mesaj' },
    { key: 'forum',      label: 'üìã Forum' },
    { key: 'announce',   label: 'üì£ Duyuru' },
    { key: 'games',      label: 'üéÆ Oyunlar' },
    { key: 'health',     label: 'üìä Sistem Saƒülƒ±ƒüƒ±' },
    { key: 'security',   label: 'üõ°Ô∏è G√ºvenlik' },
    { key: 'settings',   label: '‚öôÔ∏è Ayarlar' },
    { key: 'naturebot',  label: 'ü§ñ NatureBot' },
  ];
  const tabsHTML = tabs.map(t =>
    `<div class="dsk-atab" data-key="${t.key}" onclick="deskAdminTab('${t.key}')">${t.label}</div>`
  ).join('');

  panel.innerHTML =
    `<div style="display:flex;flex-direction:column;height:100%;overflow:hidden;">
      <div style="display:flex;align-items:center;gap:8px;padding:16px 20px 0;flex-shrink:0;">
        <div style="font-size:1.3rem;">üëë</div>
        <div style="font-size:1.05rem;font-weight:900;color:var(--text-hi);">Admin Paneli</div>
      </div>
      <div id="deskAdminTabs" style="display:flex;gap:4px;padding:12px 16px 0;flex-shrink:0;overflow-x:auto;border-bottom:1px solid var(--border);"></div>
      <div id="adminBody" style="flex:1;overflow-y:auto;padding:16px 20px;">
        <div class="ld"><span></span><span></span><span></span></div>
      </div>
    </div>`;

  // Render tabs
  const tabBar = document.getElementById('deskAdminTabs');
  tabs.forEach(t => {
    const el = document.createElement('div');
    el.textContent = t.label;
    el.dataset.key = t.key;
    el.style.cssText = 'padding:8px 14px;border-radius:8px 8px 0 0;cursor:pointer;font-size:.82rem;font-weight:700;color:var(--muted);white-space:nowrap;transition:background .1s,color .1s;';
    el.onclick = () => deskAdminTab(t.key);
    tabBar.appendChild(el);
  });

  deskAdminTab('users');
}

function deskAdminTab(tab) {
  _adminTab = tab;
  const tabBar = document.getElementById('deskAdminTabs');
  if (tabBar) {
    tabBar.querySelectorAll('div').forEach(el => {
      const isActive = el.dataset.key === tab;
      el.style.color = isActive ? 'var(--text-hi)' : 'var(--muted)';
      el.style.background = isActive ? 'var(--surface)' : 'transparent';
      el.style.borderBottom = isActive ? '2px solid var(--blue)' : '2px solid transparent';
    });
  }
  // Also sync mobile atabs if present
  document.querySelectorAll('.atab').forEach((el, i) => {
    el.classList.toggle('act', ['users','rooms','msgs','forum','announce','stats','settings'][i] === tab);
  });
  const body = document.getElementById('adminBody');
  if (!body) return;
  body.innerHTML = '<div class="ld"><span></span><span></span><span></span></div>';
  if (tab === 'users') loadAdminUsers();
  else if (tab === 'rooms') loadAdminRooms();
  else if (tab === 'msgs') loadAdminMsgs();
  else if (tab === 'forum') loadAdminForum();
  else if (tab === 'announce') loadAdminAnnounce();
  else if (tab === 'games') loadAdminGames();
  else if (tab === 'health') loadAdminSystemHealth();
  else if (tab === 'stats') loadAdminStats();
  else if (tab === 'security') loadAdminSecurity();
  else if (tab === 'settings') loadAdminSettings();
  else if (tab === 'naturebot') loadAdminNatureBot();
}


let _deskFrTab = 'friends';

function deskLoadFriendsPanel() {
  const panel = document.getElementById('deskPanelContent');
  panel.style.overflowY = 'hidden';

  const reqCount = Object.keys(_friendReqs).length;
  const badge = reqCount > 0 ? `<span style="background:var(--red);color:#fff;border-radius:100px;padding:0 7px;font-size:.65rem;font-weight:900;margin-left:5px">${reqCount}</span>` : '';

  panel.innerHTML = `
    <div style="display:flex;flex-direction:column;height:100%;overflow:hidden;">
      <div style="padding:16px 20px 0;flex-shrink:0;">
        <div style="font-size:1.05rem;font-weight:900;color:var(--text-hi);margin-bottom:12px;">üë• Arkada≈ülar</div>
        <div id="deskFrTabs" style="display:flex;gap:4px;border-bottom:1px solid var(--border);padding-bottom:0;">
          <div class="dsk-fr-tab" data-tab="friends" onclick="deskFriendsTab('friends')">üë§ Arkada≈ülar</div>
          <div class="dsk-fr-tab" data-tab="requests" onclick="deskFriendsTab('requests')">üì© ƒ∞stekler${badge}</div>
          <div class="dsk-fr-tab" data-tab="add" onclick="deskFriendsTab('add')">üîç Ki≈üi Ekle</div>
        </div>
      </div>
      <div id="deskFrContent" style="flex:1;overflow-y:auto;padding:14px 20px;">
        <div class="ld"><span></span><span></span><span></span></div>
      </div>
    </div>`;

  // Inject CSS if not already present
  if (!document.getElementById('deskFrCSS')) {
    const s = document.createElement('style');
    s.id = 'deskFrCSS';
    s.textContent = `
      .dsk-fr-tab{padding:8px 14px;border-radius:8px 8px 0 0;cursor:pointer;font-size:.82rem;font-weight:700;color:var(--muted);white-space:nowrap;transition:background .1s,color .1s;border-bottom:2px solid transparent;}
      .dsk-fr-tab.act{color:var(--text-hi);background:var(--surface);border-bottom:2px solid var(--blue);}
      .dsk-fr-tab:hover:not(.act){color:var(--text);background:var(--surface2);}
      .dsk-fr-row{display:flex;align-items:center;gap:12px;padding:10px 8px;border-radius:8px;cursor:pointer;transition:background .1s;}
      .dsk-fr-row:hover{background:var(--surface2);}
      .dsk-fr-av{width:42px;height:42px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.82rem;font-weight:900;color:#fff;flex-shrink:0;position:relative;}
      .dsk-fr-av .r-dot{position:absolute;bottom:-2px;right:-2px;width:10px;height:10px;border-radius:50%;border:2px solid var(--bg2);}
      .dsk-fr-info{flex:1;min-width:0;}
      .dsk-fr-name{font-size:.92rem;font-weight:700;color:var(--text-hi);}
      .dsk-fr-status{font-size:.72rem;color:var(--muted);}
      .dsk-fr-actions{display:flex;gap:6px;flex-shrink:0;}
      .dsk-fr-btn{padding:5px 12px;border-radius:6px;border:none;font-size:.78rem;font-weight:700;cursor:pointer;}
      .dsk-fr-btn.msg{background:var(--blue);color:#fff;}
      .dsk-fr-btn.accept{background:#2ecc71;color:#fff;}
      .dsk-fr-btn.reject{background:rgba(224,85,85,.2);color:var(--red);border:1px solid rgba(224,85,85,.3);}
      .dsk-fr-btn.add{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
      .dsk-fr-empty{padding:40px 20px;text-align:center;color:var(--muted);font-size:.9rem;}
      .dsk-fr-section{font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;padding:8px 8px 4px;}
    `;
    document.head.appendChild(s);
  }

  deskFriendsTab(_deskFrTab);
}

function deskFriendsTab(tab) {
  _deskFrTab = tab;
  document.querySelectorAll('.dsk-fr-tab').forEach(el => {
    el.classList.toggle('act', el.dataset.tab === tab);
  });
  const box = document.getElementById('deskFrContent');
  if (!box) return;
  box.innerHTML = '<div class="ld"><span></span><span></span><span></span></div>';

  if (tab === 'friends') deskLoadFriendsList_panel(box);
  else if (tab === 'requests') deskLoadFriendRequests_panel(box);
  else if (tab === 'add') deskLoadAddFriend_panel(box);
}

function deskLoadFriendsList_panel(box) {
  Promise.all([
    dbRef('friends/' + _cu).once('value'),
    dbRef('users').once('value')
  ]).then(([frSnap, usersSnap]) => {
    const friends = Object.keys(frSnap.val() || {});
    const users = usersSnap.val() || {};
    if (!friends.length) { box.innerHTML = `<div class="dsk-fr-empty">üì≠ Hen√ºz arkada≈üƒ±n yok.<br><br><button class="dsk-fr-btn add" style="margin-top:8px" onclick="deskFriendsTab('add')">+ Ki≈üi Ekle</button></div>`; return; }
    const online = friends.filter(u => _online[u]);
    const offline = friends.filter(u => !_online[u]);
    let h = '';
    if (online.length) {
      h += '<div class="dsk-fr-section">√áevrimi√ßi ‚Äî ' + online.length + '</div>';
      online.forEach(u => { h += deskFrRow(u, true, 'friend'); });
    }
    if (offline.length) {
      h += '<div class="dsk-fr-section">√áevrimdƒ±≈üƒ± ‚Äî ' + offline.length + '</div>';
      offline.forEach(u => { h += deskFrRow(u, false, 'friend'); });
    }
    box.innerHTML = h;
  });
}

function deskLoadFriendRequests_panel(box) {
  Promise.all([
    dbRef('friendRequests/' + _cu).once('value'),
    dbRef('friendRequestsSent/' + _cu).once('value')
  ]).then(([inSnap, outSnap]) => {
    const incoming = Object.keys(inSnap.val() || {});
    const outgoing = Object.keys(outSnap.val() || {});
    if (!incoming.length && !outgoing.length) { box.innerHTML = '<div class="dsk-fr-empty">üì≠ Bekleyen istek yok.</div>'; return; }
    let h = '';
    if (incoming.length) {
      h += '<div class="dsk-fr-section">Gelen ƒ∞stekler ‚Äî ' + incoming.length + '</div>';
      incoming.forEach(u => { h += deskFrRow(u, !!_online[u], 'incoming'); });
    }
    if (outgoing.length) {
      h += '<div class="dsk-fr-section" style="margin-top:12px">G√∂nderilen ƒ∞stekler ‚Äî ' + outgoing.length + '</div>';
      outgoing.forEach(u => { h += deskFrRow(u, !!_online[u], 'outgoing'); });
    }
    box.innerHTML = h;
  });
}

function deskLoadAddFriend_panel(box) {
  box.innerHTML = `
    <div style="margin-bottom:16px">
      <input id="deskFrSearch" class="admin-inp" placeholder="Kullanƒ±cƒ± adƒ± ara..." oninput="deskSearchUsersToAdd(this.value)" autocorrect="off" autocapitalize="none" style="margin-bottom:0">
    </div>
    <div id="deskFrAddResults" style="display:flex;flex-direction:column;gap:4px;"></div>`;
  deskSearchUsersToAdd('');
}

function deskSearchUsersToAdd(q) {
  const res = document.getElementById('deskFrAddResults');
  if (!res) return;
  res.innerHTML = '<div class="ld"><span></span><span></span><span></span></div>';
  const filter = (q || '').toLowerCase();
  Promise.all([
    dbRef('users').once('value'),
    dbRef('friends/' + _cu).once('value'),
    dbRef('friendRequests/' + _cu).once('value'),
    dbRef('friendRequestsSent/' + _cu).once('value')
  ]).then(([usersSnap, frSnap, inSnap, outSnap]) => {
    const users = usersSnap.val() || {};
    const friends = Object.keys(frSnap.val() || {});
    const incoming = Object.keys(inSnap.val() || {});
    const outgoing = Object.keys(outSnap.val() || {});
    const all = Object.keys(users).filter(u => {
      if(u === _cu) return false;
      if(users[u].banned) return false;
      if(filter && !u.toLowerCase().includes(filter)) return false;
      return true;
    });
    if (!all.length) { res.innerHTML = '<div class="dsk-fr-empty">Kullanƒ±cƒ± bulunamadƒ±.</div>'; return; }
    let h = '';
    all.forEach(u => {
      const on = !!_online[u];
      const isFriend = friends.includes(u);
      const isIncoming = incoming.includes(u);
      const isOutgoing = outgoing.includes(u);
      let actions = '';
      if (isFriend) actions = `<button class="dsk-fr-btn msg" onclick="deskFriendMsg('${u}')">üí¨ Mesaj</button>`;
      else if (isIncoming) actions = `<button class="dsk-fr-btn accept" onclick="deskAcceptReq('${u}')">‚úì Kabul</button><button class="dsk-fr-btn reject" style="margin-left:4px" onclick="deskRejectReq('${u}')">‚úï</button>`;
      else if (isOutgoing) actions = '<button class="dsk-fr-btn add" style="opacity:.6;cursor:default">ƒ∞stek G√∂nderildi</button>';
      else actions = `<button class="dsk-fr-btn accept" onclick="deskSendFriendReq('${u}')">+ Ekle</button>`;
      h += `<div class="dsk-fr-row">
        <div class="dsk-fr-av" style="background:${strColor(u)}">${initials(u)}<div class="r-dot ${on?'on':'off'}"></div></div>
        <div class="dsk-fr-info"><div class="dsk-fr-name">${esc(u)}</div><div class="dsk-fr-status">${on?'üü¢ √áevrimi√ßi':'√áevrimdƒ±≈üƒ±'}</div></div>
        <div class="dsk-fr-actions">${actions}</div>
      </div>`;
    });
    res.innerHTML = h;
  });
}

function deskFrRow(u, online, type) {
  let actions = '';
  if (type === 'friend') {
    actions = `<button class="dsk-fr-btn msg" onclick="deskFriendMsg('${u}')">üí¨ Mesaj</button>`;
  } else if (type === 'incoming') {
    actions = `<button class="dsk-fr-btn accept" onclick="deskAcceptReq('${u}')">‚úì Kabul</button><button class="dsk-fr-btn reject" style="margin-left:4px" onclick="deskRejectReq('${u}')">‚úï</button>`;
  } else if (type === 'outgoing') {
    actions = '<span style="font-size:.75rem;color:var(--muted)">Bekliyor...</span>';
  }
  return `<div class="dsk-fr-row">
    <div class="dsk-fr-av" style="background:${strColor(u)}">${initials(u)}<div class="r-dot ${online?'on':'off'}"></div></div>
    <div class="dsk-fr-info"><div class="dsk-fr-name">${esc(u)}</div><div class="dsk-fr-status">${online?'üü¢ √áevrimi√ßi':'√áevrimdƒ±≈üƒ±'}</div></div>
    <div class="dsk-fr-actions">${actions}</div>
  </div>`;
}

function deskFriendMsg(u) { deskNav('home'); setTimeout(() => startDMWithUser(u), 200); }

function deskAcceptReq(from) {
  acceptFriendRequest(from);
  setTimeout(() => {
    if(document.getElementById('deskFrContent')) deskFriendsTab(_deskFrTab);
    deskUpdateFrBadge();
  }, 500);
}

function deskRejectReq(from) {
  rejectFriendRequest(from);
  setTimeout(() => {
    if(document.getElementById('deskFrContent')) deskFriendsTab(_deskFrTab);
    deskUpdateFrBadge();
  }, 500);
}

function deskSendFriendReq(to) {
  sendFriendRequest(to);
  setTimeout(() => { if(document.getElementById('deskFrAddResults')) deskSearchUsersToAdd(document.getElementById('deskFrSearch')?.value||''); }, 500);
}

function deskUpdateFrBadge() {
  const count = Object.keys(_friendReqs).length;
  // Update rail badge pill
  const pill = document.getElementById('deskFrNotif');
  if (pill) { pill.style.display = count > 0 ? 'flex' : 'none'; pill.textContent = count; }
  // Refresh panel badge if open
  if (_deskNav === 'friends' && document.getElementById('deskFrTabs')) {
    const reqTab = document.querySelector('.dsk-fr-tab[data-tab="requests"]');
    if (reqTab) {
      reqTab.innerHTML = 'üì© ƒ∞stekler' + (count > 0 ? `<span style="background:var(--red);color:#fff;border-radius:100px;padding:0 7px;font-size:.65rem;font-weight:900;margin-left:5px">${count}</span>` : '');
    }
  }
}

function deskDoLogout() {
  if (_deskStopMsg) { _deskStopMsg(); _deskStopMsg = null; }
  document.getElementById('desktopShell').style.display = 'none';
  doLogout();
  // After logout show login
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginScreen').classList.add('active');
}

async function sendDeskMsg() {
  if (!_db || !_cu || !_deskRoom) return;
  const inp = document.getElementById('deskInp');
  let t = inp.value.trim();
  if (!t) return;

  const roomSnap = await dbRef('rooms/' + _deskRoom).once('value');
  const roomData = roomSnap.val() || {};
  if (roomData.locked && !_isAdmin) { showToast('Bu oda kilitli.'); return; }
  // Rate limiting (desktop)
  const _now2 = Date.now();
  const muteUntil2 = _userMutedUntil || 0;
  if(muteUntil2 > _now2){ const rem=Math.ceil((muteUntil2-_now2)/60000); showToast('üîá Susturuldunuz. '+rem+' dk kaldƒ±.'); return; }
  if(_now2 - _msgCountReset > MSG_BURST_WINDOW){ _msgCount=0; _msgCountReset=_now2; }
  if(_now2 - _lastMsgTs < MSG_RATE_MS){ showToast('‚è± √áok hƒ±zlƒ± g√∂nderiyorsunuz.'); return; }
  if(_msgCount >= MSG_BURST_LIMIT){ showToast('‚è± √áok fazla mesaj g√∂nderildi.'); return; }
  if(t.length > 2000){ showToast('Mesaj √ßok uzun (max 2000 karakter).'); return; }
  // Banned words
  if(_bannedWordsList && _bannedWordsList.length){
    _bannedWordsList.forEach(w=>{ if(!w)return; const re=new RegExp(w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi'); t=t.replace(re,'***'); });
  }
  _lastMsgTs=_now2; _msgCount++;
  if (roomData.slowMode > 0 && !_isAdmin) {
    const key = '_slowlast_' + _deskRoom;
    const last = parseInt(sessionStorage.getItem(key) || 0);
    const now = Date.now();
    if (now - last < roomData.slowMode * 1000) { showToast('Yava≈ü mod: ' + Math.ceil((roomData.slowMode * 1000 - (now - last)) / 1000) + 's bekle.'); return; }
    sessionStorage.setItem(key, now);
  }

  const key = dbRef('msgs/' + _deskRoom).push().key;
  const msg = { key, user: _cu, text: t, ts: Date.now() };
  inp.value = ''; inp.style.height = 'auto';
  await dbRef('msgs/' + _deskRoom + '/' + key).set(msg);
}

function onDeskMsgKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendDeskMsg(); }
}

function deskInpResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 180) + 'px';
}

// ‚îÄ‚îÄ Wire into existing onLoginSuccess ‚îÄ‚îÄ
const _origOnLoginSuccess = onLoginSuccess;
onLoginSuccess = function() {
  _origOnLoginSuccess();
  if (IS_DESKTOP()) {
    setTimeout(deskOnLogin, 100);
  }
};

// On resize, switch modes
window.addEventListener('resize', () => {
  if (IS_DESKTOP() && _cu) {
    document.getElementById('desktopShell').style.display = 'flex';
    document.querySelectorAll('.screen').forEach(s => { s.style.display = 'none'; s.classList.remove('active'); });
    if (_deskRoom) deskOpenRoom(_deskRoom);
    else deskLoadRoomList();
  } else if (!IS_DESKTOP()) {
    document.getElementById('desktopShell').style.display = 'none';
    if (_cu) {
      switchMainTab(_deskNav === 'home' ? 'home' : _deskNav);
    } else {
      showScreen('loginScreen');
    }
  }
});

// Also update room list when online status changes
const _origListenOnline = listenOnline;
listenOnline = function() {
  _origListenOnline();
  // Refresh desktop member panel periodically
  if (IS_DESKTOP()) {
    setInterval(() => {
      if (_deskRoom && document.getElementById('deskMemberPanel') && !document.getElementById('deskMemberPanel').classList.contains('hidden')) {
        dbRef('rooms/' + _deskRoom).once('value').then(s => { if (s.val() && s.val().type === 'group') deskLoadMembers(s.val()); });
      }
    }, 30000);
  }
};


/* ‚ïê‚ïê Drag & Drop Order ‚ïê‚ïê */
let _roomOrder = {};

function loadRoomOrder() {
  try { _roomOrder = JSON.parse(localStorage.getItem('sohbet_room_order') || '{}'); } catch(e) { _roomOrder = {}; }
}
function saveRoomOrder() {
  localStorage.setItem('sohbet_room_order', JSON.stringify(_roomOrder));
}
function getRoomSortKey(id) {
  return _roomOrder[id] !== undefined ? _roomOrder[id] : 999999;
}

function deskApplyOrder(list) {
  return [...list].sort((a, b) => {
    const ka = getRoomSortKey(a.id || a);
    const kb = getRoomSortKey(b.id || b);
    return ka - kb;
  });
}

function initDeskDnd() {
  // Called after rendering sidebar list
  const rows = document.querySelectorAll('#deskSideList .dsk-row[data-id]');
  rows.forEach(row => {
    row.setAttribute('draggable', 'true');
    row.addEventListener('dragstart', onDeskDragStart);
    row.addEventListener('dragover', onDeskDragOver);
    row.addEventListener('dragleave', onDeskDragLeave);
    row.addEventListener('drop', onDeskDrop);
    row.addEventListener('dragend', onDeskDragEnd);
  });
}

let _dragSrcId = null;
let _dragSrcSection = null;

function getDeskRowSection(row) {
  // Walk up to find the section header text
  let prev = row.previousElementSibling;
  while (prev) {
    if (prev.classList.contains('dsk-sec-hdr')) return prev.textContent.trim();
    prev = prev.previousElementSibling;
  }
  return '';
}

function onDeskDragStart(e) {
  _dragSrcId = this.dataset.id;
  _dragSrcSection = getDeskRowSection(this);
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', _dragSrcId);
}
function onDeskDragOver(e) {
  e.preventDefault();
  if (this.dataset.id === _dragSrcId) return;
  if (getDeskRowSection(this) !== _dragSrcSection) return; // only within same section
  e.dataTransfer.dropEffect = 'move';
  this.classList.add('drag-over');
}
function onDeskDragLeave() { this.classList.remove('drag-over'); }
function onDeskDrop(e) {
  e.preventDefault();
  this.classList.remove('drag-over');
  const targetId = this.dataset.id;
  if (!targetId || targetId === _dragSrcId) return;
  if (getDeskRowSection(this) !== _dragSrcSection) return;

  // Collect all rows in this section
  const allRows = [...document.querySelectorAll('#deskSideList .dsk-row[data-id]')].filter(r => getDeskRowSection(r) === _dragSrcSection);
  const ids = allRows.map(r => r.dataset.id);
  const srcIdx = ids.indexOf(_dragSrcId);
  const tgtIdx = ids.indexOf(targetId);
  if (srcIdx < 0 || tgtIdx < 0) return;

  // Reorder
  ids.splice(srcIdx, 1);
  ids.splice(tgtIdx, 0, _dragSrcId);

  // Save order
  ids.forEach((id, i) => { _roomOrder[id] = i * 10; });
  saveRoomOrder();

  // Re-render
  deskLoadRoomList();
}
function onDeskDragEnd() {
  this.classList.remove('dragging');
  document.querySelectorAll('.dsk-row.drag-over').forEach(r => r.classList.remove('drag-over'));
}

// Also support touch-based drag (mobile fallback - long press to reorder)
// Load order on init
loadRoomOrder();


/* ‚îÄ‚îÄ Local video PiP drag ‚îÄ‚îÄ */
function initLocalVideoDrag(){
  const v = document.getElementById('localVideo');
  if(!v) return;
  let dragging=false, ox=0, oy=0, sx=0, sy=0;
  v.addEventListener('mousedown', e=>{
    dragging=true; ox=v.offsetLeft; oy=v.offsetTop; sx=e.clientX; sy=e.clientY;
    v.style.transition='none'; e.preventDefault();
  });
  document.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const dx=e.clientX-sx, dy=e.clientY-sy;
    const parent=v.parentElement;
    const maxX=parent.clientWidth-v.clientWidth;
    const maxY=parent.clientHeight-v.clientHeight;
    v.style.left=Math.max(0,Math.min(maxX,ox+dx))+'px';
    v.style.top=Math.max(0,Math.min(maxY,oy+dy))+'px';
    v.style.right='auto'; v.style.bottom='auto';
  });
  document.addEventListener('mouseup', ()=>{ dragging=false; });

  // Touch support
  v.addEventListener('touchstart', e=>{
    const t=e.touches[0]; dragging=true; ox=v.offsetLeft; oy=v.offsetTop; sx=t.clientX; sy=t.clientY;
    v.style.transition='none'; e.preventDefault();
  },{passive:false});
  document.addEventListener('touchmove', e=>{
    if(!dragging) return;
    const t=e.touches[0]; const dx=t.clientX-sx, dy=t.clientY-sy;
    const parent=v.parentElement;
    const maxX=parent.clientWidth-v.clientWidth;
    const maxY=parent.clientHeight-v.clientHeight;
    v.style.left=Math.max(0,Math.min(maxX,ox+dx))+'px';
    v.style.top=Math.max(0,Math.min(maxY,oy+dy))+'px';
    v.style.right='auto'; v.style.bottom='auto';
  });
  document.addEventListener('touchend', ()=>{ dragging=false; });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Mƒ∞Nƒ∞ OYUNLAR Sƒ∞STEMƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let _currentGameCategory = 'all';

/* ‚îÄ‚îÄ Oyun Kataloƒüu ‚îÄ‚îÄ */
const GAME_CATALOG = [
  // .io Oyunlar
  { id:'agario',    cat:'io',      name:'Agar.io',        icon:'üü¢', color:'#27ae60', desc:'H√ºcre yut, b√ºy√º!',        url:'https://agar.io',                                    age:'12+' },
  { id:'slither',   cat:'io',      name:'Slither.io',     icon:'üêç', color:'#8e44ad', desc:'Yƒ±lan ol, rakipleri sar!', url:'https://slither.io',                                 age:'6+'  },
  { id:'diep',      cat:'io',      name:'Diep.io',        icon:'üî´', color:'#2980b9', desc:'Tank sava≈üƒ±!',             url:'https://diep.io',                                    age:'12+' },
  { id:'wormate',   cat:'io',      name:'Wormate.io',     icon:'ü™±', color:'#e67e22', desc:'≈ûeker topla, b√ºy√º!',       url:'https://wormate.io',                                 age:'6+'  },
  { id:'paper',     cat:'io',      name:'Paper.io 2',     icon:'üìÑ', color:'#16a085', desc:'Alan kazan!',              url:'https://paper-io.com',                               age:'6+'  },
  { id:'zombsroyale',cat:'io',     name:'ZombsRoyale',    icon:'üî•', color:'#c0392b', desc:'Battle royale!',           url:'https://zombsroyale.io',                             age:'12+' },
  { id:'moomoo',    cat:'io',      name:'MooMoo.io',      icon:'üêÑ', color:'#27ae60', desc:'K√∂y kur, sava≈ü!',          url:'https://moomoo.io',                                  age:'6+'  },
  { id:'lordz',     cat:'io',      name:'Lordz.io',       icon:'‚öîÔ∏è', color:'#8e44ad', desc:'Ordu topla, kaleleri al!', url:'https://www.lordz.io',                               age:'6+'  },
  { id:'wings',     cat:'io',      name:'Wings.io',       icon:'‚úàÔ∏è', color:'#3498db', desc:'U√ßak sava≈üƒ±!',             url:'https://wings.io',                                   age:'6+'  },
  // Aksiyon
  { id:'surviv',    cat:'action',  name:'Surviv.io',      icon:'üéØ', color:'#e74c3c', desc:'2D battle royale!',        url:'https://surviv.io',                                  age:'12+' },
  { id:'krunker',   cat:'action',  name:'Krunker.io',     icon:'üéÆ', color:'#e67e22', desc:'FPS aksiyon!',             url:'https://krunker.io',                                 age:'12+' },
  { id:'shellshock',cat:'action',  name:'Shell Shockers', icon:'ü•ö', color:'#f1c40f', desc:'Yumurta sava≈üƒ±!',          url:'https://shellshock.io',                              age:'12+' },
  { id:'venge',     cat:'action',  name:'Venge.io',       icon:'üî±', color:'#c0392b', desc:'3D FPS sava≈ü!',            url:'https://venge.io',                                   age:'12+' },
  { id:'stickman',  cat:'action',  name:'Stickman Archer',icon:'üèπ', color:'#7f8c8d', desc:'Ok√ßu d√∂v√º≈ü√º!',             url:'https://www.crazygames.com/game/stickman-archer',    age:'6+'  },
  { id:'bowmasters',cat:'action',  name:'Bowmasters',     icon:'üéØ', color:'#e74c3c', desc:'Yay ile d√ºello!',          url:'https://www.crazygames.com/game/bowmasters',         age:'12+' },
  // Yarƒ±≈ü
  { id:'moto',      cat:'racing',  name:'Moto X3M',       icon:'üèçÔ∏è', color:'#e74c3c', desc:'Motosiklet parkuru!',      url:'https://www.crazygames.com/game/moto-x3m',          age:'6+'  },
  { id:'smashkarts',cat:'racing',  name:'Smash Karts',    icon:'üèéÔ∏è', color:'#8e44ad', desc:'Kart yarƒ±≈üƒ± sava≈üƒ±!',      url:'https://smashkarts.io',                              age:'6+'  },
  { id:'driftboss', cat:'racing',  name:'Drift Boss',     icon:'üåÄ', color:'#16a085', desc:'Drift yap, puan kazan!',   url:'https://www.crazygames.com/game/drift-boss',        age:'0+'  },
  { id:'roadfury',  cat:'racing',  name:'Road Fury',      icon:'üí®', color:'#2980b9', desc:'Yol sava≈üƒ±!',              url:'https://www.crazygames.com/game/road-fury',         age:'6+'  },
  { id:'racinggo',  cat:'racing',  name:'Racing Go',      icon:'üöó', color:'#c0392b', desc:'Araba yarƒ±≈üƒ±!',            url:'https://www.crazygames.com/game/racing-go',         age:'12+' },
  // Strateji
  { id:'chess',     cat:'strategy',name:'Satran√ß',        icon:'‚ôüÔ∏è', color:'#2c3e50', desc:'Klasik satran√ß!',          url:'https://www.chess.com/play/online',                 age:'0+'  },
  { id:'ludo',      cat:'strategy',name:'Ludo',           icon:'üé≤', color:'#e74c3c', desc:'Parcheesi!',               url:'https://www.crazygames.com/game/ludo-online',       age:'0+'  },
  { id:'checkers',  cat:'strategy',name:'Dama',           icon:'‚ö´', color:'#8e44ad', desc:'Klasik dama oyunu!',        url:'https://www.crazygames.com/game/checkers',          age:'0+'  },
  { id:'bloons',    cat:'strategy',name:'Bloons TD 5',    icon:'üéà', color:'#e74c3c', desc:'Balonlarƒ± patlat!',         url:'https://www.crazygames.com/game/bloons-tower-defense-5', age:'6+' },
  { id:'warzone',   cat:'strategy',name:'Warzone',        icon:'üó∫Ô∏è', color:'#27ae60', desc:'D√ºnya hakimiyeti!',         url:'https://www.warzone.com',                           age:'0+'  },
];

const GAME_CATEGORIES = [
  { id:'all',      label:'üéÆ T√ºm√º' },
  { id:'io',       label:'üåê .io Oyunlar' },
  { id:'action',   label:'‚öîÔ∏è Aksiyon' },
  { id:'racing',   label:'üèéÔ∏è Yarƒ±≈ü' },
  { id:'strategy', label:'‚ôüÔ∏è Strateji' },
];




/* ‚îÄ‚îÄ CSS Enjeksiyonu ‚îÄ‚îÄ */
(function injectGameCSS(){
  const s = document.createElement('style');
  s.textContent = `
.games-container{display:flex;flex-direction:column;height:100%;overflow:hidden;}
.games-cat-bar{display:flex;gap:6px;overflow-x:auto;padding:12px 16px 8px;flex-shrink:0;scrollbar-width:none;}
.games-cat-bar::-webkit-scrollbar{display:none;}
.games-cat-btn{flex-shrink:0;padding:6px 14px;border-radius:20px;font-size:.78rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:var(--surface2);color:var(--muted);transition:all .15s;}
.games-cat-btn.act{background:var(--accent);border-color:var(--accent);color:#fff;}
.games-scroll{flex:1;overflow-y:auto;padding:0 12px 16px;}
.games-section-title{font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin:14px 4px 8px;}
.games-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:4px;}
.game-item{display:flex;flex-direction:column;cursor:pointer;}
.game-item:hover .game-thumb{transform:scale(1.05);}
.game-thumb{border-radius:18px;overflow:hidden;transition:transform .18s;position:relative;aspect-ratio:1;box-shadow:0 4px 14px rgba(0,0,0,.35);}
.game-thumb-bg{position:absolute;inset:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2.8rem;z-index:1;}
.game-thumb-name{font-size:.68rem;font-weight:700;color:var(--text);margin-top:5px;text-align:center;padding:0 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.game-thumb-age{position:absolute;bottom:6px;left:6px;background:#22c55e;color:#fff;font-size:.58rem;font-weight:900;border-radius:50px;padding:2px 7px;z-index:3;box-shadow:0 1px 5px rgba(0,0,0,.45);letter-spacing:.02em;}
.game-fullscreen{position:fixed;inset:0;background:#000;z-index:999999;display:flex;flex-direction:column;}
.game-fullscreen-bar{height:44px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:0 14px;flex-shrink:0;}
.game-fullscreen-title{font-size:.9rem;font-weight:800;color:var(--text-hi);flex:1;}
.game-fullscreen-close{background:rgba(255,255,255,.1);border:none;border-radius:8px;color:#fff;font-size:.78rem;font-weight:700;padding:6px 12px;cursor:pointer;}
.game-fullscreen iframe{flex:1;border:none;width:100%;background:#000;}
/* Invite notif badge */
.notif-pill{position:absolute;top:-3px;right:-3px;min-width:16px;height:16px;background:#e74c3c;border-radius:8px;font-size:.62rem;font-weight:900;color:#fff;display:flex;align-items:center;justify-content:center;padding:0 3px;}
  `;
  document.head.appendChild(s);
})();

/* ‚îÄ‚îÄ Panel Y√ºkleme ‚îÄ‚îÄ */
function loadGamesPanel() {
  const isDesk = IS_DESKTOP();
  const container = isDesk ? document.getElementById('deskPanelContent') : document.getElementById('gamesScreenBody');
  if (!container || !_cu) return;
  container.innerHTML = '';
  container.style.padding = '0';
  container.style.overflow = 'hidden';
  container.style.display = 'flex';
  container.style.flexDirection = 'column';
  renderFullGamesPanel(container);
}
function deskLoadGames() { loadGamesPanel(); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üì∫ TV CANLI ƒ∞ZLE PANELƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TV_CHANNELS = [
  // Haber
  { id:'trt_haber',  name:'TRT Haber',   cat:'Haber',  emoji:'üì°', m3u8:'https://tv-trthaber.medya.trt.com.tr/master_720.m3u8' },
  { id:'ntv',        name:'NTV',          cat:'Haber',  emoji:'üì°', m3u8:'https://dogus-live.daioncdn.net/ntv/ntv.m3u8' },
  { id:'haberturk',  name:'Habert√ºrk',    cat:'Haber',  emoji:'üì°', m3u8:'https://ciner-live.daioncdn.net/haberturktv/haberturktv.m3u8' },
  { id:'halktv',     name:'Halk TV',      cat:'Haber',  emoji:'üì°', m3u8:'https://halktv-live.daioncdn.net/halktv/halktv.m3u8' },
  { id:'tele1',      name:'Tele1',        cat:'Haber',  emoji:'üì°', m3u8:'https://tele1.blutv.com/blutv_tele1_live/live.m3u8' },
  { id:'sozcu',      name:'S√∂zc√º TV',     cat:'Haber',  emoji:'üì°', m3u8:'https://szctvdvr.blutv.com/blutv_szctv_dvr/live.m3u8' },
  { id:'tv100',      name:'TV100',        cat:'Haber',  emoji:'üì°', m3u8:'https://tv100dvr.blutv.com/blutv_tv100dvr/live.m3u8' },
  // Genel
  { id:'tv8',        name:'TV8',          cat:'Genel',  emoji:'üì∫', m3u8:'https://mn-nl.mncdn.com/tv8/smil:tv8.smil/playlist.m3u8' },
  { id:'dream',      name:'Dream T√ºrk',   cat:'Genel',  emoji:'üì∫', m3u8:'https://mn-nl.mncdn.com/blutv_dreamturk/smil:dreamturk_sd.smil/playlist.m3u8' },
  { id:'trt_world',  name:'TRT World',    cat:'Genel',  emoji:'üì∫', m3u8:'https://tv-trtworld.medya.trt.com.tr/master_720.m3u8' },
  // Spor
  { id:'trt_spor',   name:'TRT Spor',     cat:'Spor',   emoji:'‚öΩ', m3u8:'https://tv-trtspor1.medya.trt.com.tr/master.m3u8' },
  { id:'trt_spor2',  name:'TRT Spor 2',   cat:'Spor',   emoji:'‚öΩ', m3u8:'https://tv-trtspor2.medya.trt.com.tr/master.m3u8' },
  // M√ºzik
  { id:'kralpop',    name:'Kral Pop',     cat:'M√ºzik',  emoji:'üéµ', m3u8:'https://dogus-live.daioncdn.net/kralpoptv/kralpoptv.m3u8' },
  { id:'powertv',    name:'Power T√ºrk',   cat:'M√ºzik',  emoji:'üéµ', m3u8:'https://livetv.powerapp.com.tr/powerturktv/powerturkhd.smil/playlist.m3u8' },
  // √áocuk
  { id:'trt_cocuk',  name:'TRT √áocuk',    cat:'√áocuk',  emoji:'üéà', m3u8:'https://tv-trtcocuk.medya.trt.com.tr/master_720.m3u8' },
  { id:'trt_muzik',  name:'TRT M√ºzik',    cat:'M√ºzik',  emoji:'üéµ', m3u8:'https://mn-nl.mncdn.com/blutv_trtmuzik/smil:trtmuzik_hd.smil/playlist.m3u8' },
];

let _currentTvCh = null;
let _hlsInstance = null;

function _destroyHls() {
  if (_hlsInstance) { try { _hlsInstance.destroy(); } catch(e){} _hlsInstance = null; }
}

function _playHlsStream(videoEl, url) {
  _destroyHls();
  if (!videoEl) return;
  // Try native HLS (Safari/iOS)
  if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
    videoEl.src = url;
    videoEl.play().catch(()=>{});
    return;
  }
  // Use hls.js
  if (typeof Hls !== 'undefined' && Hls.isSupported()) {
    const hls = new Hls({ enableWorker: true, lowLatencyMode: true, backBufferLength: 90 });
    _hlsInstance = hls;
    hls.loadSource(url);
    hls.attachMedia(videoEl);
    hls.on(Hls.Events.MANIFEST_PARSED, () => videoEl.play().catch(()=>{}));
    hls.on(Hls.Events.ERROR, (e, data) => {
      if (data.fatal) {
        const errEl = videoEl.parentElement?.querySelector('.watch-stream-err');
        if (errEl) errEl.style.display = 'flex';
      }
    });
  } else {
    videoEl.src = url;
    videoEl.play().catch(()=>{});
  }
}

function loadWatchPanel() {
  const body = document.getElementById('watchScreenBody');
  if (!body) return;
  let h = '<div class="watch-mob-grid">';
  TV_CHANNELS.forEach(ch => {
    h += `<div class="watch-mob-card" onclick="openMobTv('${ch.id}')">
      <div class="wmc-logo">${ch.emoji}</div>
      <div class="wmc-name">${ch.name}</div>
      <div class="wmc-cat">${ch.cat}</div>
    </div>`;
  });
  h += '</div>';
  body.innerHTML = h;
  // Load hls.js if not loaded
  _ensureHlsJs();
}

function _ensureHlsJs(cb) {
  if (typeof Hls !== 'undefined') { cb && cb(); return; }
  const s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.7/hls.min.js';
  s.onload = () => { cb && cb(); };
  document.head.appendChild(s);
}

function openMobTv(id) {
  const ch = TV_CHANNELS.find(c => c.id === id);
  if (!ch) return;
  _destroyHls();
  let p = document.getElementById('watchMobPlayer');
  if (!p) {
    p = document.createElement('div');
    p.id = 'watchMobPlayer';
    p.className = 'watch-mob-player';
    document.body.appendChild(p);
  }
  p.innerHTML = `
    <div class="watch-mob-player-header">
      <div class="watch-mob-close" onclick="closeMobTv()">‚úï</div>
      <div style="flex:1">
        <div style="font-size:.95rem;font-weight:900;color:#fff;">${ch.name}</div>
        <div style="font-size:.7rem;color:rgba(255,255,255,.5);">${ch.cat} ¬∑ Canlƒ± Yayƒ±n</div>
      </div>
      <span class="watch-live-badge">CANLI</span>
    </div>
    <video id="watchMobVideo" style="width:100%;height:100%;object-fit:contain;background:#000;" controls playsinline></video>
    <div class="watch-stream-err" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.8);align-items:center;justify-content:center;flex-direction:column;gap:8px;color:#fff;text-align:center;padding:20px;">
      <div style="font-size:2.5rem;">üì°</div>
      <div style="font-size:.95rem;font-weight:700;">Yayƒ±n y√ºklenemedi</div>
      <div style="font-size:.78rem;opacity:.6;">Kanal ge√ßici olarak eri≈üilemez olabilir</div>
    </div>`;
  p.style.display = 'flex';
  _ensureHlsJs(() => {
    const v = document.getElementById('watchMobVideo');
    if (v) _playHlsStream(v, ch.m3u8);
  });
}

function closeMobTv() {
  _destroyHls();
  const p = document.getElementById('watchMobPlayer');
  if (p) { p.style.display = 'none'; p.innerHTML = ''; }
}

function deskLoadWatch() {
  const panel = document.getElementById('deskPanelContent');
  if (!panel) return;
  panel.style.overflowY = 'hidden';
  panel.style.padding = '0';

  const cats = [...new Set(TV_CHANNELS.map(c => c.cat))];
  let sidebarH = '';
  cats.forEach(cat => {
    sidebarH += `<div class="watch-cat-header">${cat}</div>`;
    TV_CHANNELS.filter(c => c.cat === cat).forEach(ch => {
      sidebarH += `<div class="watch-ch-item${_currentTvCh===ch.id?' act':''}" id="wch-${ch.id}" onclick="deskPlayTv('${ch.id}')">
        <div class="watch-ch-logo">${ch.emoji}</div>
        <div class="watch-ch-info">
          <div class="watch-ch-name">${ch.name}</div>
          <div class="watch-ch-cat">${ch.cat}</div>
        </div>
      </div>`;
    });
  });

  panel.innerHTML = `
    <div class="watch-wrap">
      <div class="watch-header">
        <div>
          <div class="watch-header-title">üì∫ Canlƒ± Televizyon</div>
          <div class="watch-header-sub">T√ºrk televizyon kanallarƒ±nƒ± canlƒ± izle</div>
        </div>
        <span class="watch-live-badge" style="margin-left:auto">CANLI</span>
      </div>
      <div class="watch-content">
        <div class="watch-sidebar">${sidebarH}</div>
        <div class="watch-player-area">
          <div class="watch-player-box" id="watchPlayerBox">
            <div class="watch-player-placeholder">
              <div class="pp-icon">üì∫</div>
              <div class="pp-text">Kanal se√ßin</div>
              <div class="pp-sub">Sol taraftan bir kanal se√ßerek izlemeye ba≈ülayƒ±n</div>
            </div>
          </div>
          <div class="watch-now-info" id="watchNowInfo" style="display:none">
            <div class="watch-live-badge">CANLI</div>
            <div>
              <div class="watch-now-ch" id="watchNowCh">‚Äî</div>
              <div class="watch-now-sub" id="watchNowSub">Canlƒ± Yayƒ±n</div>
            </div>
          </div>
        </div>
      </div>
    </div>`;

  _ensureHlsJs();
  if (_currentTvCh) deskPlayTv(_currentTvCh);
}

function deskPlayTv(id) {
  const ch = TV_CHANNELS.find(c => c.id === id);
  if (!ch) return;
  _currentTvCh = id;
  document.querySelectorAll('.watch-ch-item').forEach(el => el.classList.remove('act'));
  const item = document.getElementById('wch-' + id);
  if (item) item.classList.add('act');
  const box = document.getElementById('watchPlayerBox');
  if (!box) return;
  box.innerHTML = `
    <video id="watchDeskVideo" style="width:100%;height:100%;object-fit:contain;background:#000;" controls autoplay playsinline></video>
    <div class="watch-stream-err" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.8);align-items:center;justify-content:center;flex-direction:column;gap:8px;color:#fff;text-align:center;padding:20px;">
      <div style="font-size:2.5rem;">üì°</div>
      <div style="font-size:.95rem;font-weight:700;">Yayƒ±n y√ºklenemedi</div>
      <div style="font-size:.78rem;opacity:.6;">Kanal ge√ßici olarak eri≈üilemez olabilir</div>
    </div>`;
  _ensureHlsJs(() => {
    const v = document.getElementById('watchDeskVideo');
    if (v) _playHlsStream(v, ch.m3u8);
  });
  const info = document.getElementById('watchNowInfo');
  if (info) info.style.display = 'flex';
  const ch_el = document.getElementById('watchNowCh');
  if (ch_el) ch_el.textContent = ch.name;
  const sub_el = document.getElementById('watchNowSub');
  if (sub_el) sub_el.textContent = ch.cat + ' ¬∑ Canlƒ± Yayƒ±n';
}

function renderFullGamesPanel(container) {
  // Fetch invites & active games

  // Category bar
  let catHtml = '<div class="games-cat-bar">';
  GAME_CATEGORIES.forEach(c => {
    catHtml += `<div class="games-cat-btn${_currentGameCategory===c.id?' act':''}" onclick="switchGameCat('${c.id}')">${c.label}</div>`;
  });
  catHtml += '</div>';

  // Scroll area
  let scrollHtml = '<div class="games-scroll" id="gamesScrollArea">';

  // Browser games grid
  const _allG = allGames();
  const filtered = _currentGameCategory === 'all' ? _allG : _allG.filter(g=>g.cat===_currentGameCategory);

  if (filtered.length) {
    const catMap = {};
    filtered.forEach(g => {
      if (!catMap[g.cat]) catMap[g.cat] = [];
      catMap[g.cat].push(g);
    });

    if (_currentGameCategory === 'all') {
      scrollHtml += '<div class="games-section-title">üåê Tarayƒ±cƒ± Oyunlarƒ±</div>';
      scrollHtml += '<div class="games-grid">';
      filtered.forEach(g => {
        scrollHtml += buildGameThumb(g);
      });
      scrollHtml += '</div>';
    } else {
      const catLabel = GAME_CATEGORIES.find(c=>c.id===_currentGameCategory)?.label || '';
      scrollHtml += `<div class="games-section-title">${catLabel}</div>`;
      scrollHtml += '<div class="games-grid">';
      filtered.forEach(g => {
        scrollHtml += buildGameThumb(g);
      });
      scrollHtml += '</div>';
    }
  }

  scrollHtml += '</div>';

  container.innerHTML = `<div class="games-container">${catHtml}${scrollHtml}</div>`;
}

function buildGameThumb(g) {
  const grad = `linear-gradient(135deg, ${g.color}ee, ${g.color}99)`;
  return `<div class="game-item" onclick="openBrowserGame('${g.id}')">
    <div class="game-thumb" style="background:${grad};">
      <div class="game-thumb-bg" style="display:flex;">${g.icon}</div>
      <div class="game-thumb-age">${g.age}</div>
    </div>
    <div class="game-thumb-name">${g.name}</div>
  </div>`;
}

function switchGameCat(cat) {
  _currentGameCategory = cat;
  const isDesk = IS_DESKTOP();
  const container = isDesk ? document.getElementById('deskPanelContent') : document.getElementById('gamesScreenBody');
  if (container) renderFullGamesPanel(container);
}

/* ‚îÄ‚îÄ Tarayƒ±cƒ± Oyunu A√ß (fullscreen iframe) ‚îÄ‚îÄ */
function openBrowserGame(gameId) {
  const game = GAME_CATALOG.find(g=>g.id===gameId);
  if (!game) return;

  // Remove existing overlay
  const existing = document.getElementById('gameFullscreenOverlay');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'gameFullscreenOverlay';
  overlay.className = 'game-fullscreen';
  overlay.innerHTML = `
    <div class="game-fullscreen-bar">
      <div style="font-size:1.2rem;">${game.icon}</div>
      <div class="game-fullscreen-title">${game.name}</div>
      <button class="game-fullscreen-close" onclick="closeBrowserGame()">‚úï Kapat</button>
    </div>
    <iframe src="${game.url}" allowfullscreen allow="fullscreen;autoplay;gamepad" loading="lazy"></iframe>
  `;
  document.body.appendChild(overlay);
}

function closeBrowserGame() {
  const el = document.getElementById('gameFullscreenOverlay');
  if (el) el.remove();
}

function escHtml(s){
  if(!s)return'';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showWsInfo(){ /* workspace kaldƒ±rƒ±ldƒ± */ }
async function openWsSwitcher(){ /* workspace kaldƒ±rƒ±ldƒ± */ }
async function switchWorkspace(wsId){ /* workspace kaldƒ±rƒ±ldƒ± */ }
function loadAdminWorkspaces(){ /* workspace kaldƒ±rƒ±ldƒ± */ }

/* ‚ïê‚ïê DM G√úNL√úK OTOMATƒ∞K TEMƒ∞ZLƒ∞K ‚Äî DEVRE DI≈ûI (mesajlar kalƒ±cƒ± olsun) ‚ïê‚ïê */
function clearDMsForToday(){ /* devre dƒ±≈üƒ± ‚Äî mesajlar artƒ±k kalƒ±cƒ± */ }
function scheduleDMClear(){ /* devre dƒ±≈üƒ± ‚Äî mesajlar artƒ±k kalƒ±cƒ± */ }


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   YENƒ∞ √ñZELLƒ∞KLER JS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ Evrensel Arama ‚îÄ‚îÄ */
let _gsFilter = 'all';
function openGlobalSearch(){
  const modal=document.getElementById('globalSearchModal');
  if(!modal) return;
  modal.style.display='flex';
  setTimeout(()=>{ const inp=document.getElementById('globalSearchInp'); if(inp){inp.focus();inp.value='';} },50);
  runGlobalSearch('');
}
function closeGlobalSearch(){
  const modal=document.getElementById('globalSearchModal');
  if(modal) modal.style.display='none';
}
function setGsFilter(f, btn){
  _gsFilter=f;
  document.querySelectorAll('.gs-filter-btn').forEach(b=>b.classList.remove('gs-filter-act'));
  if(btn) btn.classList.add('gs-filter-act');
  const inp=document.getElementById('globalSearchInp');
  runGlobalSearch(inp?inp.value:'');
}
function runGlobalSearch(q){
  const box=document.getElementById('globalSearchResults');
  if(!box) return;
  q=q.trim().toLowerCase();
  if(!q){ box.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted);font-size:.85rem;">Aramaya ba≈ülayƒ±n...</div>'; return; }
  let html='';
  const strCol=typeof strColor==='function'?strColor:(s=>'#5b9bd5');
  const ini=typeof initials==='function'?initials:(s=>s.slice(0,2).toUpperCase());
  // Kullanƒ±cƒ±lar
  if(_gsFilter==='all'||_gsFilter==='users'){
    if(_db){
      dbRef('users').once('value').then(snap=>{
        const users=snap.val()||{};
        const matched=Object.entries(users).filter(([u])=>u.toLowerCase().includes(q)).slice(0,5);
        let h=matched.length?'<div class="gs-section-title">üë§ Ki≈üiler</div>':'';
        matched.forEach(([u,d])=>{
          const online=typeof _onlineUsers!=='undefined'&&_onlineUsers&&_onlineUsers[u];
          h+=`<div class="gs-result-item" onclick="closeGlobalSearch();openUserProfileModal('${u}')">
            <div class="gs-result-av" style="background:${strCol(u)}">${ini(u)}</div>
            <div class="gs-result-info">
              <div class="gs-result-name">${u}</div>
              <div class="gs-result-sub">${d&&d.bio?d.bio.slice(0,40):'Kullanƒ±cƒ±'}</div>
            </div>
            <span class="gs-chip" style="background:${online?'rgba(34,197,94,.15)':'rgba(107,114,128,.15)'};color:${online?'#22c55e':'#6b7280'}">${online?'Online':'Offline'}</span>
          </div>`;
        });
        if(!matched.length) h+='';
        appendGsSection(h);
      }).catch(()=>{});
    }
  }
  // Odalar
  if(_gsFilter==='all'||_gsFilter==='rooms'){
    if(_db){
      dbRef('rooms').once('value').then(snap=>{
        const rooms=snap.val()||{};
        const matched=Object.values(rooms).filter(r=>r&&r.name&&r.name.toLowerCase().includes(q)).slice(0,5);
        let h=matched.length?'<div class="gs-section-title">üè† Odalar</div>':'';
        matched.forEach(r=>{
          const ic=r.type==='dm'?'üí¨':r.type==='group'?'üë•':'#';
          h+=`<div class="gs-result-item" onclick="closeGlobalSearch();if(typeof IS_DESKTOP==='function'&&IS_DESKTOP()){deskOpenRoom('${r.id}');}else{openChat('${r.id}','${r.name||''}','${r.type||'channel'}','')}">
            <div class="gs-result-av" style="background:${strCol(r.name||r.id)}">${ic}</div>
            <div class="gs-result-info">
              <div class="gs-result-name">${r.name||r.id}</div>
              <div class="gs-result-sub">${(r.members||[]).length||0} √ºye ¬∑ ${r.type==='group'?'Grup':'Kanal'}</div>
            </div>
            <span class="gs-chip" style="background:rgba(91,155,213,.15);color:#5b9bd5">Oda</span>
          </div>`;
        });
        appendGsSection(h);
      }).catch(()=>{});
    }
  }
  // Forum
  if(_gsFilter==='all'||_gsFilter==='forum'){
    if(_db){
      dbRef('forum/posts').once('value').then(snap=>{
        const posts=snap.val()||{};
        const matched=Object.values(posts).filter(p=>p&&p.text&&p.text.toLowerCase().includes(q)).slice(0,3);
        let h=matched.length?'<div class="gs-section-title">üìã Forum</div>':'';
        matched.forEach(p=>{
          h+=`<div class="gs-result-item" onclick="closeGlobalSearch();switchMainTab('forum')">
            <div class="gs-result-av" style="background:${strCol(p.user||'x')}">${ini(p.user||'?')}</div>
            <div class="gs-result-info">
              <div class="gs-result-name">${(p.text||'').slice(0,50)}</div>
              <div class="gs-result-sub">${p.user||''} ¬∑ ${typeof formatDate==='function'?formatDate(new Date(p.ts)):''}</div>
            </div>
            <span class="gs-chip" style="background:rgba(139,92,246,.15);color:#8b5cf6">Forum</span>
          </div>`;
        });
        appendGsSection(h);
      }).catch(()=>{});
    }
  }
}
let _gsSections=[];
function appendGsSection(html){
  if(!html) return;
  const box=document.getElementById('globalSearchResults');
  if(!box) return;
  if(box.innerHTML.includes('Aramaya ba≈ülayƒ±n')||box.innerHTML.includes('Sonu√ß bulunamadƒ±')) box.innerHTML='';
  box.innerHTML+=html;
  if(!box.innerHTML.trim()) box.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted);font-size:.85rem;">Sonu√ß bulunamadƒ±</div>';
}
// Cmd+K / Ctrl+K arama kƒ±sayolu
document.addEventListener('keydown',e=>{
  if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();openGlobalSearch();}
  if(e.key==='Escape'){closeGlobalSearch();closeNotifCenter();}
});

/* ‚îÄ‚îÄ Bildirim Merkezi ‚îÄ‚îÄ */
let _notifs=[];
function openNotifCenter(triggerEl){
  const modal=document.getElementById('notifCenterModal');
  const panel=document.getElementById('notifCenterPanel');
  if(!modal||!panel) return;

  const isMobile = window.innerWidth < 768;

  if(isMobile){
    // Mobilde: sayfanƒ±n √ºst kƒ±smƒ±nda tam geni≈ülik panel
    const safeTop = parseInt(getComputedStyle(document.documentElement)
      .getPropertyValue('--safe-top')) || 0;
    panel.style.left     = '12px';
    panel.style.right    = '12px';
    panel.style.width    = 'calc(100vw - 24px)';
    panel.style.maxWidth = 'calc(100vw - 24px)';
    panel.style.top      = (safeTop + 58) + 'px';
    panel.style.position = 'absolute';
  } else {
    // Masa√ºst√º: bell butonunun hizasƒ±nda
    const btn = triggerEl || document.getElementById('deskBellBtn');
    if(btn){
      const r = btn.getBoundingClientRect();
      const panelW = 360;
      let left = r.right - panelW;
      if(left < 8) left = 8;
      if(left + panelW > window.innerWidth - 8) left = window.innerWidth - panelW - 8;
      panel.style.left  = left + 'px';
      panel.style.top   = (r.bottom + 6) + 'px';
      panel.style.right = 'auto';
      panel.style.width = '';
      panel.style.maxWidth = '';
    }
  }

  modal.style.display='flex';
  renderNotifCenter();

  // Dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
  requestAnimationFrame(()=>{
    const close = (e)=>{
      if(!panel.contains(e.target) && !e.target.closest('#deskBellBtn')){
        closeNotifCenter();
        document.removeEventListener('mousedown', close);
      }
    };
    document.addEventListener('mousedown', close);
  });
}
function closeNotifCenter(){
  const modal=document.getElementById('notifCenterModal');
  if(modal) modal.style.display='none';
}
function addNotif(type, title, sub, action){
  const notif={id:Date.now(),type,title,sub,action,ts:Date.now(),read:false};
  _notifs.unshift(notif);
  if(_notifs.length>50) _notifs=_notifs.slice(0,50);
  updateNotifBadge();
  // Kaydet
  try{localStorage.setItem('nc_notifs',JSON.stringify(_notifs.slice(0,20)));}catch(e){}
}
function loadNotifs(){
  try{const saved=localStorage.getItem('nc_notifs');if(saved)_notifs=JSON.parse(saved);}catch(e){}
  updateNotifBadge();
}
function updateNotifBadge(){
  const unread=_notifs.filter(n=>!n.read).length;
  const dot=document.getElementById('mobNotifDot');
  const deskDot=document.getElementById('deskNotifDot');
  const countEl=document.getElementById('ncUnreadCount');
  if(dot) dot.style.display=unread>0?'block':'none';
  if(deskDot) deskDot.style.display=unread>0?'block':'none';
  if(countEl){countEl.style.display=unread>0?'inline':'none';countEl.textContent=unread;}
}
function markAllNotifsRead(){
  _notifs.forEach(n=>n.read=true);
  try{localStorage.setItem('nc_notifs',JSON.stringify(_notifs));}catch(e){}
  updateNotifBadge();
  renderNotifCenter();
}
function renderNotifCenter(){
  const box=document.getElementById('notifCenterList');
  if(!box) return;
  loadNotifs();
  if(!_notifs.length){
    box.innerHTML='<div style="text-align:center;padding:32px;color:var(--muted);font-size:.85rem;">üì≠ Bildirim yok</div>';
    return;
  }
  const icons={msg:'üí¨',friend:'üë•',forum:'üìã',system:'‚öôÔ∏è',call:'üìû'};
  const colors={msg:'rgba(91,155,213,.15)',friend:'rgba(34,197,94,.15)',forum:'rgba(139,92,246,.15)',system:'rgba(245,158,11,.15)',call:'rgba(239,68,68,.15)'};
  box.innerHTML=_notifs.map(n=>`
    <div class="nc-item${n.read?'':' unread'}" onclick="notifClick('${n.id}')">
      <div class="nc-icon" style="background:${colors[n.type]||colors.system}">${icons[n.type]||'üîî'}</div>
      <div class="nc-text">
        <div class="nc-title">${n.title}</div>
        <div class="nc-sub">${n.sub||''}</div>
      </div>
      <div class="nc-time">${fmtNotifTime(n.ts)}</div>
      ${!n.read?'<div class="nc-unread-dot"></div>':''}
    </div>`).join('');
}
function notifClick(id){
  const n=_notifs.find(x=>x.id==id);
  if(!n) return;
  n.read=true;
  try{localStorage.setItem('nc_notifs',JSON.stringify(_notifs));}catch(e){}
  updateNotifBadge();
  closeNotifCenter();
  if(n.action) try{n.action();}catch(e){}
}
function fmtNotifTime(ts){
  const diff=Date.now()-ts;
  if(diff<60000) return 'Az √∂nce';
  if(diff<3600000) return Math.floor(diff/60000)+'dk';
  if(diff<86400000) return Math.floor(diff/3600000)+'sa';
  return Math.floor(diff/86400000)+'g';
}

/* ‚îÄ‚îÄ Profil Arkada≈ü Sayƒ±sƒ± ‚îÄ‚îÄ */
function updateProfileFriendCount(){
  const el=document.getElementById('profFriendCount');
  if(!el||!_cu||!_db) return;
  dbRef('friends/'+_cu).once('value').then(snap=>{
    const fr=snap.val()||{};
    const accepted=Object.values(fr).filter(f=>f&&f.status==='accepted').length;
    el.textContent=accepted;
  }).catch(()=>{el.textContent='‚Äî';});
}

/* ‚îÄ‚îÄ Profil Rozet Sistemi ‚îÄ‚îÄ */
function updateProfileBadges(msgCount){
  const box=document.getElementById('profBadgesRow');
  if(!box) return;
  const badges=[];
  if(msgCount>=1) badges.push({icon:'‚≠ê',label:'ƒ∞lk Mesaj',color:'rgba(245,158,11,.2)',border:'rgba(245,158,11,.4)',text:'#f59e0b'});
  if(msgCount>=100) badges.push({icon:'üí¨',label:'100 Mesaj',color:'rgba(91,155,213,.2)',border:'rgba(91,155,213,.4)',text:'#5b9bd5'});
  if(msgCount>=500) badges.push({icon:'üî•',label:'500 Mesaj',color:'rgba(239,68,68,.2)',border:'rgba(239,68,68,.4)',text:'#ef4444'});
  if(_isAdmin) badges.push({icon:'üëë',label:'Admin',color:'rgba(245,158,11,.2)',border:'rgba(245,158,11,.5)',text:'#f59e0b'});
  box.innerHTML=badges.map(b=>`<span title="${b.label}" style="background:${b.color};border:1px solid ${b.border};color:${b.text};font-size:.65rem;font-weight:700;padding:3px 9px;border-radius:100px;display:flex;align-items:center;gap:3px;">${b.icon} ${b.label}</span>`).join('');
}

/* ‚îÄ‚îÄ Yazƒ± Boyutu ‚îÄ‚îÄ */
function setFontSize(size){
  const sizes={small:'13px',medium:'15px',large:'17px'};
  const px=sizes[size]||'15px';
  document.documentElement.style.setProperty('--base-font-size',px);
  document.getElementById('chatMsgs')&&(document.getElementById('chatMsgs').style.fontSize=px);
  document.querySelectorAll('.mb-text,.ob').forEach(el=>el.style.fontSize=px);
  ['small','medium','large'].forEach(s=>{
    const el=document.getElementById('fs-'+s);
    if(!el) return;
    if(s===size){el.style.background='var(--accent)';el.style.borderColor='var(--accent)';el.querySelector('div').style.color='#fff';}
    else{el.style.background='var(--surface)';el.style.borderColor='var(--border)';el.querySelector('div').style.color='var(--text-hi)';}
  });
  try{localStorage.setItem('fontSize',size);}catch(e){}
}
function loadFontSize(){
  try{const s=localStorage.getItem('fontSize');if(s)setFontSize(s);}catch(e){}
}

/* ‚îÄ‚îÄ Kompakt Mod ‚îÄ‚îÄ */
let _compactMode=false;
function toggleCompactMode(){
  _compactMode=!_compactMode;
  const toggle=document.getElementById('compactModeToggle');
  const knob=document.getElementById('compactModeKnob');
  if(toggle) toggle.style.background=_compactMode?'var(--accent)':'var(--surface2)';
  if(knob) knob.style.transform=_compactMode?'translateX(18px)':'translateX(0)';
  document.querySelectorAll('.mb.first').forEach(el=>{el.style.marginTop=_compactMode?'4px':'10px';});
  document.querySelectorAll('.mb').forEach(el=>{el.style.paddingTop=_compactMode?'1px':'3px';});
  try{localStorage.setItem('compactMode',_compactMode?'1':'0');}catch(e){}
}
function loadCompactMode(){
  try{if(localStorage.getItem('compactMode')==='1') toggleCompactMode();}catch(e){}
}

/* ‚îÄ‚îÄ Nature Bot (Slash Komutlarƒ±) ‚îÄ‚îÄ */
function checkBotCommand(text){
  if(!text.startsWith('/')) return false;
  const parts=text.trim().split(' ');
  const cmd=parts[0].toLowerCase();
  const args=parts.slice(1).join(' ');
  const botCmds={
    '/yardƒ±m':()=>showBotMsg('ü§ñ Kullanƒ±labilir komutlar: /hava [≈üehir] /saat /flip /zar /rng /anket'),
    '/saat':()=>showBotMsg('üïê ≈ûu an: '+new Date().toLocaleTimeString('tr-TR')),
    '/tarih':()=>showBotMsg('üìÖ Bug√ºn: '+new Date().toLocaleDateString('tr-TR',{weekday:'long',year:'numeric',month:'long',day:'numeric'})),
    '/flip':()=>showBotMsg('ü™ô '+(Math.random()<.5?'YAZI ‚úÖ':'TURA ‚úÖ')),
    '/zar':()=>showBotMsg('üé≤ Zar: '+Math.ceil(Math.random()*6)),
    '/rng':()=>{const n=parseInt(args)||100;showBotMsg('üéØ 1-'+n+' arasƒ±: '+Math.ceil(Math.random()*n));},
    '/hava':()=>{
      if(!args){showBotMsg('üìç Kullanƒ±m: /hava [≈üehir]');return;}
      showBotMsg('‚è≥ '+args+' i√ßin hava durumu alƒ±nƒ±yor...');
      fetch('https://wttr.in/'+encodeURIComponent(args)+'?format=3&lang=tr')
        .then(r=>r.text()).then(t=>showBotMsg('üå§Ô∏è '+t.trim()))
        .catch(()=>showBotMsg('‚ùå Hava durumu alƒ±namadƒ±.'));
    },
    '/anket':()=>{
      if(!args){showBotMsg('üìä Kullanƒ±m: /anket [soru]');return;}
      const pollModal=document.getElementById('createPollModal');
      const pollQ=document.getElementById('pollQuestion');
      if(pollModal&&pollQ){pollQ.value=args;pollModal.style.display='flex';}
      else showBotMsg('üìä Anket olu≈üturucu a√ßƒ±lamadƒ±.');
    }
  };
  const fn=botCmds[cmd];
  if(fn){fn();return true;}
  // Bilinmeyen komut
  showBotMsg('‚ùì Bilinmeyen komut: '+cmd+'. Yardƒ±m i√ßin /yardƒ±m yazƒ±n.');
  return true;
}
function showBotMsg(text){
  // Sisteme mesaj olarak g√∂ster (local, Firebase'e g√∂ndermez)
  const box=document.getElementById('chatMsgs');
  if(!box) return;
  const div=document.createElement('div');
  div.className='msg-sys';
  div.style.cssText='background:rgba(91,155,213,.08);border:1px solid rgba(91,155,213,.15);border-radius:10px;padding:8px 12px;margin:6px 12px;font-size:.82rem;white-space:pre-wrap;';
  div.innerHTML='<span style="color:var(--accent);font-weight:700;">ü§ñ NatureBot</span><br>'+text.replace(/</g,'&lt;');
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}

/* ‚îÄ‚îÄ Slash Komut √ñneri Kutusu ‚îÄ‚îÄ */
let _slashSuggestions=false;
function checkSlashInput(val){
  const box=document.getElementById('slashSuggestBox');
  if(!val.startsWith('/')||val.includes(' ')){
    if(box) box.style.display='none';
    return;
  }
  const cmds=[
    {cmd:'/yardƒ±m',desc:'Yardƒ±m men√ºs√º'},
    {cmd:'/hava',desc:'Hava durumu ‚Äî /hava Istanbul'},
    {cmd:'/saat',desc:'≈ûu anki saat'},
    {cmd:'/tarih',desc:'Bug√ºn√ºn tarihi'},
    {cmd:'/flip',desc:'Yazƒ±/Tura'},
    {cmd:'/zar',desc:'Rastgele zar'},
    {cmd:'/rng',desc:'Rastgele sayƒ± ‚Äî /rng 100'},
    {cmd:'/anket',desc:'Anket olu≈ütur'},
  ];
  const filtered=cmds.filter(c=>c.cmd.startsWith(val.toLowerCase()));
  if(!filtered.length){if(box) box.style.display='none';return;}
  let suggestBox=box;
  if(!suggestBox){
    suggestBox=document.createElement('div');
    suggestBox.id='slashSuggestBox';
    suggestBox.style.cssText='position:absolute;bottom:100%;left:0;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:12px 12px 0 0;overflow:hidden;z-index:500;margin-bottom:1px;max-height:200px;overflow-y:auto;';
    const inpWrap=document.getElementById('chatInputRow')||document.querySelector('.inp-wrap');
    if(inpWrap){inpWrap.style.position='relative';inpWrap.appendChild(suggestBox);}
    else return;
  }
  suggestBox.style.display='block';
  suggestBox.innerHTML=filtered.map(c=>`
    <div onclick="fillSlashCmd('${c.cmd}')" style="display:flex;align-items:center;gap:8px;padding:9px 14px;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--border);" onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background=''">
      <span style="font-size:.8rem;font-weight:700;color:var(--accent);">${c.cmd}</span>
      <span style="font-size:.75rem;color:var(--muted);">${c.desc}</span>
    </div>`).join('');
}
function fillSlashCmd(cmd){
  const inp=document.getElementById('msgInp')||document.getElementById('deskInp');
  if(inp){inp.value=cmd+' ';inp.focus();}
  const box=document.getElementById('slashSuggestBox');
  if(box) box.style.display='none';
}

/* ‚îÄ‚îÄ Sayfa y√ºklenince ba≈ülat ‚îÄ‚îÄ */
setTimeout(()=>{
  loadNotifs();
  loadFontSize();
  loadCompactMode();
  // Slash komut dinleyici
  ['msgInp','deskInp'].forEach(id=>{
    const inp=document.getElementById(id);
    if(inp) inp.addEventListener('input',e=>checkSlashInput(e.target.value));
  });
},500);

// Hook into login success

</script>

<!-- ‚ïê‚ïê GRUP OLU≈ûTUR MODAL ‚ïê‚ïê -->
<div id="createGroupModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:3000;align-items:flex-end;justify-content:center;">
  <div style="background:var(--bg2);border-radius:20px 20px 0 0;width:100%;max-width:480px;max-height:88vh;display:flex;flex-direction:column;padding:20px 16px 32px;" onclick="event.stopPropagation()">
    <div style="width:40px;height:4px;background:rgba(255,255,255,.15);border-radius:2px;margin:0 auto 16px;"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div style="font-size:1rem;font-weight:900;color:var(--text-hi);">üë• Yeni Grup Olu≈ütur</div>
      <div onclick="closeCGModal()" style="cursor:pointer;color:var(--muted);font-size:1.2rem;">‚úï</div>
    </div>
    <input id="cgName" class="admin-inp" placeholder="Grup adƒ±..." style="margin-bottom:12px;" autocorrect="off">
    <div style="font-size:.75rem;font-weight:700;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.05em;">√úye Ekle</div>
    <input id="cgSearch" class="admin-inp" placeholder="Kullanƒ±cƒ± ara..." style="margin-bottom:8px;" oninput="loadCGUsers(this.value.toLowerCase())" autocorrect="off" autocapitalize="none">
    <div id="cgUserList" style="flex:1;overflow-y:auto;max-height:200px;border:1px solid var(--border);border-radius:8px;padding:4px;margin-bottom:10px;"></div>
    <div style="font-size:.75rem;font-weight:700;color:var(--muted);margin-bottom:6px;">SE√áƒ∞LENLER</div>
    <div id="cgSelectedList" style="min-height:32px;margin-bottom:14px;display:flex;flex-wrap:wrap;gap:4px;"></div>
    <button onclick="submitCreateGroup()" style="background:var(--blue);border:none;border-radius:10px;color:#fff;font-size:.9rem;font-weight:700;padding:13px;cursor:pointer;width:100%;">‚úö Grubu Olu≈ütur</button>
  </div>
</div>


<!-- ‚ïê‚ïê GAMES SCREEN (Mobile) ‚ïê‚ïê -->
<div class="screen" id="gamesScreen">
  <div class="ws-header">
    <div class="ws-name">üéÆ Mini Oyunlar</div>
    <div class="ws-av" onclick="openProfile()"><div class="sdot"></div></div>
  </div>
  <div id="gamesScreenBody" style="flex:1;overflow-y:auto;padding:16px;"></div>
  <div class="tab-bar">
    <div class="tab" onclick="switchMainTab('home')"><div class="tab-ic-wrap"><div class="tab-ic">üè†</div></div><div class="tab-lb">Ana Sayfa</div></div>
    <div class="tab" onclick="openDMModal()"><div class="tab-ic-wrap"><div class="tab-ic">üí¨</div></div><div class="tab-lb">Mesajlar</div></div>
    <div class="tab" onclick="switchMainTab('forum')"><div class="tab-ic-wrap"><div class="tab-ic">üìã</div></div><div class="tab-lb">Forum</div></div>
    <div class="tab act" onclick="switchMainTab('games')"><div class="tab-ic-wrap"><div class="tab-ic">üéÆ</div></div><div class="tab-lb">Oyunlar</div></div>
    <div class="tab" onclick="switchMainTab('watch')"><div class="tab-ic-wrap"><div class="tab-ic">üì∫</div></div><div class="tab-lb">ƒ∞zle</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê GAME PLAY MODAL ‚ïê‚ïê -->
<div id="gamePlayModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:99999;align-items:center;justify-content:center;flex-direction:column;">
  <div id="gamePlayBox" style="background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:24px;width:min(480px,95vw);max-height:90vh;overflow-y:auto;">
    <div id="gamePlayContent"></div>
  </div>
</div>

<!-- ‚ïê‚ïê WATCH SCREEN (Mobile) ‚ïê‚ïê -->
<div class="screen" id="watchScreen">
  <div class="ws-header">
    <div class="ws-name">üì∫ Canlƒ± ƒ∞zle</div>
    <span class="watch-live-badge">CANLI</span>
    <div class="ws-av" onclick="openProfile()"><div class="sdot"></div></div>
  </div>
  <div id="watchScreenBody" style="flex:1;overflow-y:auto;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;">
    <!-- NatureBot Ev Alanƒ± -->
    <div id="natureBotHomeZone" style="
      display:none;flex-direction:column;
      align-items:center;justify-content:center;
      pointer-events:none;
      width:100%;padding:20px 0 60px;
    ">
      <!-- Ev zemini ve aƒüa√ßlar -->
      <svg width="260" height="120" viewBox="0 0 260 120" fill="none" style="margin-bottom:-8px;">
        <!-- Sol aƒüa√ß -->
        <path d="M46 118 C46 84 28 54 34 32 C40 10 60 26 46 118Z" fill="#4a8f40" opacity=".9"/>
        <line x1="46" y1="118" x2="46" y2="32" stroke="#2d6b25" stroke-width="1.5"/>
        <line x1="46" y1="72" x2="34" y2="90" stroke="#3a7a34" stroke-width="1"/>
        <line x1="46" y1="72" x2="58" y2="90" stroke="#3a7a34" stroke-width="1"/>
        <line x1="46" y1="50" x2="37" y2="64" stroke="#4a8f40" stroke-width=".7"/>
        <!-- Orta b√ºy√ºk aƒüa√ß -->
        <path d="M130 118 C130 68 106 30 114 6 C122 -10 150 12 130 118Z" fill="#3a7a34"/>
        <line x1="130" y1="118" x2="130" y2="6" stroke="#2d6b25" stroke-width="2"/>
        <line x1="130" y1="58" x2="114" y2="80" stroke="#4a8f40" stroke-width="1.2"/>
        <line x1="130" y1="58" x2="146" y2="80" stroke="#4a8f40" stroke-width="1.2"/>
        <line x1="130" y1="34" x2="118" y2="50" stroke="#4a8f40" stroke-width=".9"/>
        <line x1="130" y1="34" x2="142" y2="50" stroke="#4a8f40" stroke-width=".9"/>
        <!-- Saƒü aƒüa√ß -->
        <path d="M214 118 C214 84 196 54 202 32 C208 10 228 26 214 118Z" fill="#4a8f40" opacity=".9"/>
        <line x1="214" y1="118" x2="214" y2="32" stroke="#2d6b25" stroke-width="1.5"/>
        <line x1="214" y1="72" x2="202" y2="90" stroke="#3a7a34" stroke-width="1"/>
        <line x1="214" y1="72" x2="226" y2="90" stroke="#3a7a34" stroke-width="1"/>
        <!-- K√º√ß√ºk √ßi√ßekler -->
        <circle cx="78" cy="112" r="6" fill="rgba(107,191,103,.7)"/>
        <circle cx="92" cy="108" r="4" fill="rgba(107,191,103,.5)"/>
        <circle cx="160" cy="112" r="6" fill="rgba(107,191,103,.7)"/>
        <circle cx="174" cy="108" r="4" fill="rgba(107,191,103,.5)"/>
        <circle cx="68" cy="106" r="3" fill="rgba(150,220,100,.6)"/>
        <circle cx="184" cy="106" r="3" fill="rgba(150,220,100,.6)"/>
        <!-- Zemin -->
        <line x1="4" y1="118" x2="256" y2="118" stroke="rgba(74,143,64,.5)" stroke-width="2"/>
        <rect x="4" y="118" width="252" height="3" fill="rgba(74,143,64,.2)" rx="1"/>
      </svg>
      <!-- Yazƒ± -->
      <div style="font-size:.75rem;font-weight:900;color:rgba(107,191,103,.8);letter-spacing:.14em;text-transform:uppercase;margin-top:18px;text-shadow:0 0 12px rgba(74,143,64,.4);">üåø NatureBot'un Yuvasƒ±</div>
      <div style="font-size:.65rem;color:rgba(74,143,64,.5);margin-top:6px;">Robota dokunarak uyandƒ±r!</div>
    </div>
  </div>
  <div class="tab-bar">
    <div class="tab" onclick="switchMainTab('home')"><div class="tab-ic-wrap"><div class="tab-ic">üè†</div></div><div class="tab-lb">Ana Sayfa</div></div>
    <div class="tab" onclick="openDMModal()"><div class="tab-ic-wrap"><div class="tab-ic">üí¨</div></div><div class="tab-lb">Mesajlar</div></div>
    <div class="tab" onclick="switchMainTab('forum')"><div class="tab-ic-wrap"><div class="tab-ic">üìã</div></div><div class="tab-lb">Forum</div></div>
    <div class="tab" onclick="switchMainTab('games')"><div class="tab-ic-wrap"><div class="tab-ic">üéÆ</div></div><div class="tab-lb">Oyunlar</div></div>
    <div class="tab act" onclick="switchMainTab('watch')"><div class="tab-ic-wrap"><div class="tab-ic">üì∫</div></div><div class="tab-lb">ƒ∞zle</div></div>
  </div>
</div>


<!-- Custom Emoji Modal -->
<div class="ce-modal-overlay" id="ceModal">
    <div class="ce-upload-area" id="ceUploadArea" onclick="document.getElementById('ceFileInput').click()">
      <div style="font-size:1.5rem;margin-bottom:4px;">üñºÔ∏è</div>
      <div>GIF veya PNG/JPG y√ºkle</div>
      <div style="font-size:.75rem;margin-top:2px;opacity:.6;">Hareketli GIF desteklenir</div>
    </div>
    <input type="file" id="ceFileInput" accept="image/*,.gif" style="display:none" onchange="cePrevFile(this)">
    <div class="ce-preview" id="cePreview"><span style="color:var(--muted);font-size:.7rem;text-align:center;">√ñnizleme</span></div>
    <input type="text" id="ceNameInp" placeholder="Emoji adƒ± (√∂rn: dance, fire, patlama)" maxlength="32">
    <div class="ce-modal-btns">
      <button class="ce-cancel" onclick="closeCeModal()">ƒ∞ptal</button>
      <button class="ce-save" onclick="saveCustomEmoji()">Ekle ‚úì</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê UI KIT MODAL ‚ïê‚ïê -->
<div id="uiKitModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:9999;overflow-y:auto;padding:20px;padding-top:calc(20px + env(safe-area-inset-top,0px));">
  <div style="max-width:480px;margin:0 auto;background:var(--bg2);border-radius:16px;border:1px solid var(--border);overflow:hidden;">
    <div style="display:flex;align-items:center;padding:14px 16px;background:var(--surface);border-bottom:1px solid var(--border);">
      <div style="font-size:.95rem;font-weight:900;color:var(--text-hi);flex:1;">üß© UI Bile≈üen K√ºt√ºphanesi</div>
      <div onclick="closeUIKit()" style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--muted);font-size:1.2rem;border-radius:6px;" onmouseenter="this.style.background='var(--border)'" onmouseleave="this.style.background='transparent'">‚úï</div>
    </div>
    <div style="padding:16px;display:flex;flex-direction:column;gap:14px;">

      <!-- Avatarlar -->
      <div class="uikit-card">
        <div class="uikit-title">üë§ Avatarlar</div>
        <div class="uikit-av-row">
          <div class="uikit-av sm" style="background:#6c63ff;">MK<div class="uikit-status on"></div></div>
          <div class="uikit-av sm" style="background:#f97316;">ZD<div class="uikit-status away"></div></div>
          <div class="uikit-av sm" style="background:#22c55e;">HT<div class="uikit-status off"></div></div>
          <div class="uikit-av md" style="background:linear-gradient(135deg,#6c63ff,#ec4899);">AB<div class="uikit-status on"></div></div>
          <div class="uikit-av lg" style="background:linear-gradient(135deg,#0ea5e9,#6c63ff);">BY</div>
        </div>
      </div>

      <!-- Butonlar -->
      <div class="uikit-card">
        <div class="uikit-title">üñ±Ô∏è Butonlar</div>
        <div class="uikit-btn-row">
          <button class="uikit-btn uikit-btn-primary">G√∂nder</button>
          <button class="uikit-btn uikit-btn-secondary">ƒ∞ptal</button>
        </div>
        <div class="uikit-btn-row">
          <button class="uikit-btn uikit-btn-ghost">D√ºzenle</button>
          <button class="uikit-btn uikit-btn-danger">Sil</button>
          <button class="uikit-btn uikit-btn-success">‚úì Kabul</button>
        </div>
      </div>

      <!-- Rozetler -->
      <div class="uikit-card">
        <div class="uikit-title">üè∑Ô∏è Rozetler</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;">
          <span class="uikit-badge uikit-badge-online">‚óè √áevrimi√ßi</span>
          <span class="uikit-badge uikit-badge-away">‚óê Uzakta</span>
          <span class="uikit-badge uikit-badge-admin">‚≠ê Admin</span>
          <span class="uikit-badge uikit-badge-mod">üõ° Mod</span>
          <span class="uikit-badge uikit-badge-new">‚ú¶ Yeni</span>
        </div>
      </div>

      <!-- Emoji Tepkiler -->
      <div class="uikit-card">
        <div class="uikit-title">üòä Emoji Tepkiler</div>
        <div class="uikit-react-bar">
          <span class="uikit-react on">üëç</span>
          <span class="uikit-react">‚ù§Ô∏è</span>
          <span class="uikit-react">üòÇ</span>
          <span class="uikit-react">üòÆ</span>
          <span class="uikit-react">üò¢</span>
          <span style="width:1px;height:16px;background:var(--border);margin:0 3px;"></span>
          <span class="uikit-react">+</span>
        </div>
        <div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:8px;">
          <span style="display:inline-flex;align-items:center;gap:2px;background:rgba(108,99,255,.12);border:1px solid rgba(108,99,255,.25);border-radius:100px;padding:2px 8px;font-size:.68rem;color:#9b8eff;">üëç 12</span>
          <span style="display:inline-flex;align-items:center;gap:2px;background:rgba(236,72,153,.1);border:1px solid rgba(236,72,153,.25);border-radius:100px;padding:2px 8px;font-size:.68rem;color:#f472b6;">‚ù§Ô∏è 5</span>
          <span style="display:inline-flex;align-items:center;gap:2px;background:rgba(234,179,8,.1);border:1px solid rgba(234,179,8,.25);border-radius:100px;padding:2px 8px;font-size:.68rem;color:#fbbf24;">üòÇ 3</span>
        </div>
      </div>

      <!-- SVG ƒ∞kon Seti -->
      <div class="uikit-card">
        <div class="uikit-title">üéØ SVG ƒ∞kon Seti</div>
        <div class="uikit-icon-grid">
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(91,155,213,.14);color:#5b9bd5;"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div><div class="uikit-icon-name">Ana Sayfa</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(108,99,255,.14);color:#9b8eff;"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></div><div class="uikit-icon-name">Mesajlar</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(0,188,156,.14);color:#00bca0;"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg></div><div class="uikit-icon-name">Arkada≈ülar</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(249,115,22,.14);color:#fb923c;"><svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><polyline points="8 21 12 17 16 21"/></svg></div><div class="uikit-icon-name">Oyunlar</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(236,72,153,.14);color:#f472b6;"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div><div class="uikit-icon-name">Profil</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(234,179,8,.14);color:#fbbf24;"><svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div><div class="uikit-icon-name">Ara</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(34,197,94,.14);color:#4ade80;"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 9.8a2 2 0 011.72-2.18h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L5.09 7.91a16 16 0 006 6z"/></svg></div><div class="uikit-icon-name">Sesli Ara</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(224,85,85,.14);color:#f07070;"><svg viewBox="0 0 24 24"><polyline points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg></div><div class="uikit-icon-name">Video</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(91,155,213,.14);color:#5b9bd5;"><svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg></div><div class="uikit-icon-name">Dosya</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(0,188,156,.14);color:#00bca0;"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div><div class="uikit-icon-name">Admin</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(249,115,22,.14);color:#fb923c;"><svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg></div><div class="uikit-icon-name">Bildirim</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(236,72,153,.14);color:#f472b6;"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93l-1.41 1.41M22 12h-2M19.07 19.07l-1.41-1.41M12 22v-2M4.93 19.07l1.41-1.41M2 12h2M4.93 4.93l1.41 1.41M12 2v2"/></svg></div><div class="uikit-icon-name">Ayarlar</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(34,197,94,.14);color:#4ade80;"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div><div class="uikit-icon-name">Okundu</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(234,179,8,.14);color:#fbbf24;"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div><div class="uikit-icon-name">Favori</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(224,85,85,.14);color:#f07070;"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></div><div class="uikit-icon-name">√áƒ±kƒ±≈ü</div></div>
          <div class="uikit-icon-item"><div class="uikit-icon-box" style="background:rgba(108,99,255,.14);color:#9b8eff;"><svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg></div><div class="uikit-icon-name">D√ºzenle</div></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê UI STƒ∞L Sƒ∞STEMƒ∞ ‚ïê‚ïê */
const UI_STYLES = [
  {
    id: 'default',
    label: '‚öôÔ∏è Varsayƒ±lan',
    desc: 'Klasik stil',
    preview: { sidebar:'#2c3038', chat:'#141618', bubbleIn:'#252830', bubbleOut:'#2a4a7a' }
  },
  {
    id: 'glass',
    label: 'üåå Glass/Aurora',
    desc: 'Uzay & Glassmorphism',
    preview: { sidebar:'#0f0c29', chat:'#0d0b20', bubbleIn:'rgba(255,255,255,.09)', bubbleOut:'rgba(108,99,255,.8)' }
  },
  {
    id: 'clean',
    label: '‚óªÔ∏è Clean Slate',
    desc: 'Sade profesyonel',
    preview: { sidebar:'#111418', chat:'#0e1016', bubbleIn:'#181b22', bubbleOut:'#1d2d4a' }
  },
  {
    id: 'vivid',
    label: 'üî• Vivid',
    desc: 'Enerji dolu renk',
    preview: { sidebar:'#0c0e14', chat:'#0a0c12', bubbleIn:'#161922', bubbleOut:'linear-gradient(135deg,#f97316,#ec4899)' }
  }
];

let _selectedUiStyle = localStorage.getItem('sohbet_ui_style') || 'glass';

function applyUiStyle(id) {
  if (id === 'default') {
    document.documentElement.removeAttribute('data-ui');
  } else {
    document.documentElement.setAttribute('data-ui', id);
  }
}

function selectUiStyle(id) {
  _selectedUiStyle = id;
  localStorage.setItem('sohbet_ui_style', id);
  applyUiStyle(id);
  renderUiStyleGrid();
}

function renderUiStyleGrid() {
  const grids = document.querySelectorAll('#uiStyleGrid');
  grids.forEach(grid => {
    if (!grid) return;
    grid.innerHTML = UI_STYLES.map(s => `
      <div onclick="selectUiStyle('${s.id}')" style="
        cursor:pointer;border-radius:12px;padding:8px 6px 10px;text-align:center;
        background:${_selectedUiStyle===s.id?'var(--surface2)':'var(--surface)'};
        border:2px solid ${_selectedUiStyle===s.id?'var(--accent)':'transparent'};
        transition:all .18s;
      ">
        <div style="width:100%;height:44px;border-radius:7px;margin-bottom:7px;overflow:hidden;display:flex;border:1px solid rgba(255,255,255,.07);">
          <div style="width:34%;background:${s.preview.sidebar};"></div>
          <div style="flex:1;background:${s.preview.chat};display:flex;flex-direction:column;justify-content:flex-end;gap:2px;padding:3px;">
            <div style="height:6px;border-radius:2px;width:70%;background:${s.preview.bubbleIn};"></div>
            <div style="height:6px;border-radius:2px;width:55%;align-self:flex-end;background:${s.preview.bubbleOut};"></div>
          </div>
        </div>
        <div style="font-size:.7rem;font-weight:700;color:var(--text-hi);line-height:1.2;margin-bottom:1px;">${s.label}</div>
        <div style="font-size:.58rem;color:var(--muted);">${s.desc}</div>
      </div>`).join('');
  });
}

// Sayfa y√ºklenince UI stilini uygula
(function(){ applyUiStyle(_selectedUiStyle); })();

/* ‚ïê‚ïê SVG ƒ∞KON Sƒ∞STEMƒ∞ ‚ïê‚ïê */
const SVG_ICONS = {
  home: '<svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
  msgs: '<svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>',
  forum: '<svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
  friends: '<svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>',
  games: '<svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><polyline points="8 21 12 17 16 21"/></svg>',
  games: '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M12 12h.01"/><path d="M8 10v4"/><path d="M6 12h4"/><path d="M16 10h.01"/><path d="M14 12h4"/></svg>',
  watch: '<svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="15" rx="2"/><polyline points="17 2 12 7 7 2"/><polygon points="10 12 16 14.5 10 17"/></svg>',
  profile: '<svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'
};
const EMOJI_ICONS = {home:'üè†',msgs:'üí¨',forum:'üìã',friends:'üë•',games:'üéÆ',watch:'üì∫',profile:'üë§'};
let _svgIconsEnabled = true; // Her zaman a√ßƒ±k

function applyTabIcons(useSvg) {
  function resolveKey(onclick) {
    if (!onclick) return null;
    if (onclick.includes("'home'") || onclick.includes('"home"')) return 'home';
    if (onclick.includes("openDMModal") || onclick.includes("'msgs'") || onclick.includes('"msgs"')) return 'msgs';
    if (onclick.includes("'forum'") || onclick.includes('"forum"')) return 'forum';
    if (onclick.includes("openFriendsModal") || onclick.includes("'friends'") || onclick.includes('"friends"')) return 'friends';
    if (onclick.includes("'games'") || onclick.includes('"games"')) return 'games';
    if (onclick.includes("'watch'") || onclick.includes('"watch"')) return 'watch';
    if (onclick.includes("'profile'") || onclick.includes('"profile"')) return 'profile';
    return null;
  }
  // Mobile .tab-ic ‚Äî tab-wrap parent onclick desteƒüi
  document.querySelectorAll('.tab-ic').forEach(el => {
    const tab = el.closest('.tab, .tab-wrap');
    if (!tab) return;
    let onclick = tab.getAttribute('onclick') || '';
    if (!onclick && tab.classList.contains('tab')) {
      const wrap = tab.closest('.tab-wrap');
      if (wrap) onclick = wrap.getAttribute('onclick') || '';
    }
    const key = resolveKey(onclick);
    if (!key) return;
    if (useSvg) {
      el.innerHTML = SVG_ICONS[key] || el.innerHTML;
      el.style.fontSize = '0';
    } else {
      el.innerHTML = '<span style="font-size:1.3rem;line-height:1;">' + EMOJI_ICONS[key] + '</span>';
      el.style.fontSize = '';
    }
  });
  // Desktop .rail-btn-ic
  document.querySelectorAll('.rail-btn-ic').forEach(el => {
    const btn = el.closest('.rail-btn');
    if (!btn) return;
    const key = resolveKey(btn.getAttribute('onclick') || '');
    if (!key) return;
    if (useSvg) {
      el.innerHTML = SVG_ICONS[key] || el.innerHTML;
      el.style.fontSize = '0';
      el.style.display = 'flex';
      el.style.alignItems = 'center';
      el.style.justifyContent = 'center';
    } else {
      el.innerHTML = '<span style="font-size:1.2rem;line-height:1;">' + EMOJI_ICONS[key] + '</span>';
      el.style.fontSize = '';
    }
  });
  const toggle = document.getElementById('svgIconToggle');
  const knob = document.getElementById('svgIconKnob');
  if (toggle) toggle.style.background = useSvg ? 'var(--accent)' : 'var(--border)';
  if (knob) knob.style.transform = useSvg ? 'translateX(20px)' : 'translateX(0)';
}

function toggleSvgIcons() { /* SVG ikonlar kalƒ±cƒ± olarak aktif */ }

// Uygula
(function(){
  if (true) setTimeout(() => applyTabIcons(true), 200);
})();

/* ‚ïê‚ïê UI KIT MODAL ‚ïê‚ïê */
function openUIKit() {
  document.getElementById('uiKitModal').style.display = 'block';
}
function closeUIKit() {
  document.getElementById('uiKitModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    renderUiStyleGrid && renderUiStyleGrid();
    applyTabIcons(true);
    // Toggle g√∂r√ºn√ºm√ºn√º her zaman a√ßƒ±k g√∂ster
    const knob = document.getElementById('svgIconKnob');
    const toggle = document.getElementById('svgIconToggle');
    if (toggle && knob) {
      toggle.style.background = 'var(--accent)';
      knob.style.transform = 'translateX(20px)';
    }
  }, 100);
});
</script>




<!-- ‚ïê‚ïê KULLANICI PROFƒ∞L G√ñR√úNT√úLE MODAL ‚ïê‚ïê -->
<div id="userProfileModal" onclick="closeUserProfile()">
  <div class="up-card" onclick="event.stopPropagation()">
    <div class="up-banner" id="upBanner">
      <div class="up-close" onclick="closeUserProfile()">‚úï</div>
    </div>
    <div class="up-body-scroll">
      <div id="upBody" style="display:flex;flex-direction:column;align-items:center;text-align:center;">
        <div class="ld"><span></span><span></span><span></span></div>
      </div>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê ANKET OLU≈ûTUR MODAL ‚ïê‚ïê -->
<div id="createPollModal" onclick="this.style.display='none'" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:6000;align-items:center;justify-content:center;padding:16px;">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:24px;max-width:380px;width:100%;" onclick="event.stopPropagation()">
    <div style="font-size:1rem;font-weight:900;color:var(--text-hi);margin-bottom:16px;">üìä Anket Olu≈ütur</div>
    <input id="pollQuestion" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text-hi);font-size:.88rem;outline:none;font-family:inherit;margin-bottom:10px;box-sizing:border-box;" placeholder="Soru girin..." maxlength="120">
    <div id="pollOptionsWrap" style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;">
      <input class="poll-opt-inp" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text-hi);font-size:.85rem;outline:none;font-family:inherit;box-sizing:border-box;" placeholder="Se√ßenek 1" maxlength="80">
      <input class="poll-opt-inp" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text-hi);font-size:.85rem;outline:none;font-family:inherit;box-sizing:border-box;" placeholder="Se√ßenek 2" maxlength="80">
    </div>
    <button onclick="addPollOption()" style="width:100%;padding:9px;background:var(--surface2);border:1px dashed var(--border);border-radius:8px;color:var(--muted);font-size:.82rem;cursor:pointer;margin-bottom:14px;">+ Se√ßenek Ekle</button>
    <div style="display:flex;gap:8px;">
      <button onclick="document.getElementById('createPollModal').style.display='none'" style="flex:1;padding:11px;background:var(--surface2);border:none;border-radius:9px;color:var(--muted);font-size:.85rem;font-weight:700;cursor:pointer;">ƒ∞ptal</button>
      <button onclick="submitPoll()" style="flex:1;padding:11px;background:var(--accent);border:none;border-radius:9px;color:#fff;font-size:.85rem;font-weight:700;cursor:pointer;">üìä Olu≈ütur</button>
    </div>
  </div>
</div>

<script>
function showTosTab(tab){
  const tos = document.getElementById('tosTabContent');
  const kvkk = document.getElementById('kvkkTabContent');
  const btnTos = document.getElementById('tabTos');
  const btnKvkk = document.getElementById('tabKvkk');
  if(!tos || !kvkk) return;
  if(tab === 'tos'){
    tos.style.display = 'block';
    kvkk.style.display = 'none';
    if(btnTos){ btnTos.style.background='#5b9bd5'; btnTos.style.color='#fff'; }
    if(btnKvkk){ btnKvkk.style.background='#2a2a2a'; btnKvkk.style.color='#aaa'; }
  } else {
    tos.style.display = 'none';
    kvkk.style.display = 'block';
    if(btnTos){ btnTos.style.background='#2a2a2a'; btnTos.style.color='#aaa'; }
    if(btnKvkk){ btnKvkk.style.background='#5b9bd5'; btnKvkk.style.color='#fff'; }
  }
}
</script>
<!-- ‚ïê‚ïê D√úZENLEME GE√áMƒ∞≈ûƒ∞ MODAL ‚ïê‚ïê -->
<div id="editHistoryModal" onclick="this.style.display='none'" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:6000;align-items:center;justify-content:center;padding:16px;">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:24px;max-width:380px;width:100%;max-height:70vh;overflow-y:auto;" onclick="event.stopPropagation()">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div style="font-size:1rem;font-weight:900;color:var(--text-hi);">‚úèÔ∏è D√ºzenleme Ge√ßmi≈üi</div>
      <span onclick="document.getElementById('editHistoryModal').style.display='none'" style="cursor:pointer;color:var(--muted);">‚úï</span>
    </div>
    <div id="editHistoryBody"></div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üåü YENƒ∞ √ñZELLƒ∞KLER ‚Äî Kapsamlƒ± Ekleme
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* 1. KULLANICI ENGELLEME */
let _blockedUsers = {};
function loadBlockedUsers(){
  if(!_db||!_cu) return;
  dbRef('users/'+_cu+'/blocked').on('value', snap=>{
    _blockedUsers = snap.val()||{};
  });
}
function blockUser(username){
  if(!username||username===_cu){ showToast('Ge√ßersiz kullanƒ±cƒ±.'); return; }
  if(!confirm(username+' engellensin mi?')) return;
  dbRef('users/'+_cu+'/blocked/'+username).set(true).then(()=>{
    _blockedUsers[username]=true;
    showToast('üö´ '+username+' engellendi.');
  });
}
function unblockUser(username){
  dbRef('users/'+_cu+'/blocked/'+username).remove().then(()=>{
    delete _blockedUsers[username];
    showToast('‚úÖ Engel kaldƒ±rƒ±ldƒ±.');
  });
}
function isBlocked(username){ return !!_blockedUsers[username]; }

/* 2. RAPOR Sƒ∞STEMƒ∞ ‚Äî kaldƒ±rƒ±ldƒ± */
function reportMsg(){}
function reportUser(){}
function closeReportModal(){}
function submitReport(){}

/* 3. ANKET */
function openCreatePoll(){
  const wrap=document.getElementById('pollOptionsWrap');
  wrap.innerHTML='';
  document.getElementById('pollQuestion').value='';
  for(let i=0;i<2;i++){
    const inp=document.createElement('input');
    inp.className='poll-opt-inp';
    inp.style.cssText='width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text-hi);font-size:.85rem;outline:none;font-family:inherit;box-sizing:border-box;';
    inp.placeholder='Se√ßenek '+(i+1); inp.maxLength=80;
    wrap.appendChild(inp);
  }
  document.getElementById('createPollModal').style.display='flex';
}
function addPollOption(){
  const wrap=document.getElementById('pollOptionsWrap');
  if(wrap.querySelectorAll('.poll-opt-inp').length>=6){ showToast('En fazla 6 se√ßenek.'); return; }
  const inp=document.createElement('input');
  inp.className='poll-opt-inp';
  inp.style.cssText='width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text-hi);font-size:.85rem;outline:none;font-family:inherit;box-sizing:border-box;';
  inp.placeholder='Se√ßenek '+(wrap.querySelectorAll('.poll-opt-inp').length+1); inp.maxLength=80;
  wrap.appendChild(inp);
}
function submitPoll(){
  const q=document.getElementById('pollQuestion').value.trim();
  if(!q){ showToast('Soru girin.'); return; }
  const opts=Array.from(document.querySelectorAll('.poll-opt-inp')).map(i=>i.value.trim()).filter(Boolean);
  if(opts.length<2){ showToast('En az 2 se√ßenek.'); return; }
  if(!_cRoom){ showToast('√ñnce oda se√ßin.'); return; }
  _db.ref('msgs/'+_cRoom).push({user:_cu, ts:Date.now(), text:'', poll:{question:q, options:opts, votes:{}}})
    .then(()=>{ document.getElementById('createPollModal').style.display='none'; showToast('üìä Anket olu≈üturuldu!'); });
}
function votePoll(room, msgKey, optIdx){
  if(!_cu) return;
  _db.ref('msgs/'+room+'/'+msgKey+'/poll/votes').once('value').then(s=>{
    const votes=s.val()||{};
    const updates={};
    Object.keys(votes).forEach(i=>{ if(votes[i]&&votes[i][_cu]) updates['msgs/'+room+'/'+msgKey+'/poll/votes/'+i+'/'+_cu]=null; });
    updates['msgs/'+room+'/'+msgKey+'/poll/votes/'+optIdx+'/'+_cu]=true;
    _db.ref().update(updates);
  });
}
function buildPollHtml(room, msgKey, poll){
  if(!poll||!poll.question) return '';
  const total=Object.values(poll.votes||{}).reduce((s,v)=>s+(v?Object.keys(v).length:0),0);
  let h=`<div class="poll-wrap"><div class="poll-q">üìä ${esc(poll.question)}</div>`;
  (poll.options||[]).forEach((opt,i)=>{
    const cnt=poll.votes&&poll.votes[i]?Object.keys(poll.votes[i]).length:0;
    const pct=total?Math.round(cnt/total*100):0;
    const my=poll.votes&&poll.votes[i]&&poll.votes[i][_cu];
    h+=`<div class="poll-opt${my?' voted':''}" onclick="votePoll('${room}','${msgKey}',${i})"><div class="poll-bar" style="width:${pct}%"></div><div class="poll-opt-text"><span>${esc(opt)}</span><span>${pct}%</span></div></div>`;
  });
  return h+`<div class="poll-meta">${total} oy</div></div>`;
}

/* 4. G√úNL√úK √ñD√úL ‚Äî kaldƒ±rƒ±ldƒ± */
let _drClaimed=false;
function checkDailyReward(){}
function showDailyReward(){}
function claimDailyReward(){}

/* 5. KULLANICI PROFƒ∞Lƒ∞ G√ñR√úNT√úLE */
function viewUserProfile(username){
  if(!username) return;
  const m=document.getElementById('userProfileModal'); if(!m) return;
  // Banner rengini kullanƒ±cƒ± rengine g√∂re ayarla
  const banner = document.getElementById('upBanner');
  if(banner){
    const col = strColor(username);
    banner.style.background = `linear-gradient(135deg, ${col}cc 0%, var(--bg) 100%)`;
  }
  document.getElementById('upBody').innerHTML='<div style="padding:20px 0;"><div class="ld" style="display:flex;gap:5px;justify-content:center;"><span></span><span></span><span></span></div></div>';
  m.classList.add('show');
  m.style.display='flex';
  Promise.all([dbRef('users/'+username).once('value')])
    .then(([us])=>{
      const u=Object.assign({},us.val()||{});
      const online=_online&&_online[username]&&(Date.now()-(_online[username].ts||0)<90000);
      const isSelf=username===_cu;
      const col=strColor(username);

      // Sosyal linkler
      let socialHtml='';
      if(u.instagram) socialHtml+=`<a href="https://instagram.com/${esc(u.instagram)}" target="_blank" class="up-social-chip">üì∏ @${esc(u.instagram)}</a>`;
      if(u.twitter) socialHtml+=`<a href="https://twitter.com/${esc(u.twitter)}" target="_blank" class="up-social-chip">üê¶ @${esc(u.twitter)}</a>`;
      if(u.website) socialHtml+=`<a href="${esc(u.website)}" target="_blank" class="up-social-chip">üåê ${esc(u.website)}</a>`;

      // Aksiyon butonlarƒ±
      let actionBtns='';
      if(!isSelf){
        actionBtns+=`<button class="up-btn primary" onclick="closeUserProfile();openDMWith&&openDMWith('${esc(username)}');">üí¨ Mesaj G√∂nder</button>`;
        if(isBlocked(username)){
          actionBtns+=`<button class="up-btn muted" onclick="unblockUser('${esc(username)}');closeUserProfile();">‚úÖ Engeli Kaldƒ±r</button>`;
        } else {
          actionBtns+=`<button class="up-btn danger" onclick="blockUser('${esc(username)}');closeUserProfile();">üö´ Engelle</button>`;
        }
      }

      // Durum satƒ±rƒ±
      const statusLine = u.statusMsg
        ? `<div style="font-size:.8rem;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:4px;justify-content:center;">${esc(u.statusEmoji||'üí¨')} ${esc(u.statusMsg)}</div>`
        : '';

      // Rozet
      const badgeHtml = u.badge ? `<div class="up-badge-row">${esc(u.badge)}</div>` : '';

      // Bio
      const bioHtml = u.bio ? `<div class="up-bio-box">${esc(u.bio)}</div>` : '';

      // Origin
      const originHtml = u.origin ? `<div style="font-size:.75rem;color:var(--muted);margin-bottom:6px;">${esc(u.origin)}</div>` : '';

      document.getElementById('upBody').innerHTML=`
        <div class="up-av" id="upAv" style="background:${col}">${initials(username)}</div>
        <div class="up-online-dot" style="background:${online?'#4caf50':'#888'};position:absolute;bottom:${m.querySelector('.up-av')?0:0}px;display:none;"></div>
        <div class="up-name">${esc(username)}</div>
        <div class="up-status">
          <span style="width:8px;height:8px;border-radius:50%;background:${online?'#4caf50':'var(--muted)'};display:inline-block;flex-shrink:0;transition:background .5s;"></span>
          <span style="color:${online?'var(--green)':'var(--muted)'};">${online?'√áevrimi√ßi':'√áevrimdƒ±≈üƒ±'}</span>
        </div>
        ${badgeHtml}
        ${originHtml}
        ${statusLine}
        ${bioHtml}
        ${socialHtml?`<div class="up-social-row">${socialHtml}</div>`:''}
        ${actionBtns?`<div class="up-action-row">${actionBtns}</div>`:''}
      `;
      const avEl=document.getElementById('upAv');
      if(avEl) setTimeout(()=>setAvatar(avEl,username),50);
    }).catch(()=>{ document.getElementById('upBody').innerHTML='<div style="color:var(--muted);padding:20px;">Y√ºklenemedi.</div>'; });
}
function closeUserProfile(){
  const m=document.getElementById('userProfileModal');
  if(m){ m.style.display='none'; m.classList.remove('show'); }
}

/* 6. DURUM & SOSYAL */
function saveUserStatus(){
  const emoji=document.getElementById('statusEmoji')?.value||'üí¨';
  const msg=(document.getElementById('statusMsg')?.value||'').trim();
  _db.ref('users/'+_cu).update({statusMsg:msg,statusEmoji:emoji}).then(()=>{
    dbRef('users/'+_cu).update({statusMsg:msg,statusEmoji:emoji});
    showToast('‚úÖ Durum g√ºncellendi!');
  });
}
function saveSocialLinks(){
  const ig=(document.getElementById('socialInstagram')?.value||'').trim().replace('@','');
  const tw=(document.getElementById('socialTwitter')?.value||'').trim().replace('@','');
  const web=(document.getElementById('socialWebsite')?.value||'').trim();
  _db.ref('users/'+_cu).update({instagram:ig||null,twitter:tw||null,website:web||null}).then(()=>showToast('‚úÖ Sosyal linkler kaydedildi!'));
}
function loadProfileSocialTab(){
  if(!_db||!_cu) return;
  const el=document.getElementById('profSocialTab'); if(!el) return;
  _db.ref('users/'+_cu).once('value').then(s=>{
    const u=s.val()||{};
    el.innerHTML=`<div style="width:100%;box-sizing:border-box;"><div style="margin-bottom:16px;">
      <div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;display:flex;align-items:center;gap:4px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-1px"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg> Durum Mesajƒ±</div>
      <div style="display:flex;gap:8px;margin-bottom:8px;">
        <input id="statusEmoji" style="width:56px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text-hi);font-size:1.1rem;outline:none;text-align:center;" value="${esc(u.statusEmoji||'üí¨')}" maxlength="2">
        <input id="statusMsg" style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text-hi);font-size:.88rem;outline:none;font-family:inherit;" value="${esc(u.statusMsg||'')}" placeholder="Durumunuzu yazƒ±n..." maxlength="60">
      </div>
      <button onclick="saveUserStatus()" style="width:100%;padding:9px;background:var(--accent);border:none;border-radius:9px;color:#fff;font-size:.82rem;font-weight:700;cursor:pointer;">Kaydet</button>
    </div>
    <div>
      <div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;display:flex;align-items:center;gap:4px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-1px"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Sosyal Baƒülantƒ±lar</div>
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;gap:4px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-1px"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg> Instagram</div>
      <input id="socialInstagram" style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text-hi);font-size:.88rem;outline:none;font-family:inherit;margin-bottom:8px;box-sizing:border-box;" value="${esc(u.instagram||'')}" placeholder="instagram_adi" maxlength="50">
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;gap:4px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-1px"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/></svg> Twitter</div>
      <input id="socialTwitter" style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text-hi);font-size:.88rem;outline:none;font-family:inherit;margin-bottom:8px;box-sizing:border-box;" value="${esc(u.twitter||'')}" placeholder="twitter_adi" maxlength="50">
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;gap:4px;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="vertical-align:-1px"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg> Website</div>
      <input id="socialWebsite" style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text-hi);font-size:.88rem;outline:none;font-family:inherit;margin-bottom:10px;box-sizing:border-box;" value="${esc(u.website||'')}" placeholder="https://..." maxlength="100">
      <button onclick="saveSocialLinks()" style="width:100%;padding:9px;background:var(--accent);border:none;border-radius:9px;color:#fff;font-size:.82rem;font-weight:700;cursor:pointer;">Kaydet</button>
    </div></div>`;
  });
}

/* 7. MENTION DETECT */
function detectMentions(text){ return (text.match(/@([a-zA-Z0-9\u00c7\u00e7\u011e\u011f\u0130\u0131\u00d6\u00f6\u015e\u015f\u00dc\u00fc_.\-]+)/g)||[]).map(m=>m.slice(1)); }
function linkifyMentions(html){
  return html.replace(/@([a-zA-Z0-9\u00c7\u00e7\u011e\u011f\u0130\u0131\u00d6\u00f6\u015e\u015f\u00dc\u00fc_.\-]+)/g,(match,name)=>{
    return `<span class="mention" onclick="viewUserProfile('${esc(name)}')" style="color:var(--accent);font-weight:700;cursor:pointer;">@${esc(name)}</span>`;
  });
}
function checkMentionsInMsg(text){
  if(!text||!_cu||!_db) return;
  detectMentions(text).forEach(name=>{
    if(name===_cu) return;
    _db.ref('notifications/'+name+'/'+Date.now()).set({type:'mention',from:_cu,text:text.slice(0,80),room:_cRoom,ts:Date.now(),read:false});
  });
  // Push notification
  if(Notification&&Notification.permission==='granted'){
    detectMentions(text).forEach(name=>{
      if(name!==_cu) return; // only notify self
    });
  }
}
function requestNotifPermission(){
  if(!('Notification'in window)){ showToast('Tarayƒ±cƒ±nƒ±z bildirimleri desteklemiyor.'); return; }
  Notification.requestPermission().then(p=>showToast(p==='granted'?'üîî Bildirimler a√ßƒ±ldƒ±!':'ƒ∞zin reddedildi.'));
}

/* 8. D√úZENLEME GE√áMƒ∞≈ûƒ∞ */
function showEditHistory(room, key){
  _db.ref('editHistory/'+room+'/'+key).once('value').then(s=>{
    const hist=s.val();
    const body=document.getElementById('editHistoryBody');
    if(!hist||!Object.keys(hist).length){ body.innerHTML='<div style="color:var(--muted);font-size:.82rem;text-align:center;padding:20px;">D√ºzenleme ge√ßmi≈üi yok.</div>'; }
    else {
      const arr=Object.values(hist).sort((a,b)=>b.ts-a.ts);
      body.innerHTML=arr.map(h=>`<div class="edit-history-item"><div style="color:var(--muted);font-size:.7rem;margin-bottom:4px;">${new Date(h.ts).toLocaleString('tr-TR')}</div><div>${esc(h.text)}</div></div>`).join('');
    }
    document.getElementById('editHistoryModal').style.display='flex';
  });
}

/* 9. ADMIN: RAPORLAR ‚Äî kaldƒ±rƒ±ldƒ± */
function loadAdminReports(){
  const body = document.getElementById('adminBody');
  body.innerHTML = '<div class="ld"><span></span><span></span><span></span></div>';
  // Son banlanan kullanƒ±cƒ±larƒ± ve raporlarƒ± g√∂ster
  Promise.all([
    adminRestGet('users').catch(()=>({})),
    adminRestGet('bannedIPs').catch(()=>({})),
  ]).then(([usersData, ipsData])=>{
    const users = usersData||{};
    const ips = ipsData||{};
    const banned = Object.values(users).filter(u=>u&&u.banned).sort((a,b)=>(b.bannedAt||0)-(a.bannedAt||0));
    const ipList = Object.values(ips).sort((a,b)=>(b.bannedAt||0)-(a.bannedAt||0));
    let h = '<div class="admin-section"><div class="admin-sec-title">üö´ Banlƒ± Kullanƒ±cƒ±lar ('+banned.length+')</div><div class="admin-card">';
    if(banned.length){
      banned.forEach(u=>{
        h+=`<div class="admin-row" style="align-items:center;">
          <div style="flex:1"><div style="font-weight:700;color:var(--text-hi);">${esc(u.username||'?')}</div>
          <div style="font-size:.7rem;color:var(--muted);">${u.lastIP?'üåê '+u.lastIP:''}</div></div>
          <button class="a-btn green" onclick="adminToggleBan('${esc(u.username)}',false)">‚úÖ Unban</button>
        </div>`;
      });
    } else { h+='<div style="color:var(--muted);padding:12px;">Ban yok.</div>'; }
    h += '</div></div>';
    h += '<div class="admin-section"><div class="admin-sec-title">üåê IP Banlar ('+ipList.length+')</div><div class="admin-card">';
    if(ipList.length){
      ipList.forEach(b=>{
        h+=`<div class="admin-row" style="align-items:center;">
          <div style="flex:1"><div style="font-family:monospace;font-weight:700;color:#e67e22;">${esc(b.ip||'?')}</div>
          <div style="font-size:.7rem;color:var(--muted);">${b.username?'üë§ '+esc(b.username):''} ${b.bannedAt?'¬∑ '+new Date(b.bannedAt).toLocaleDateString('tr-TR'):''}</div></div>
          <button class="a-btn green" onclick="adminRestDelete('bannedIPs/'+(b.ip||'').replace(/\./g,'_')).then(()=>{showToast('\xe2\x9c\x85 Kald\xc4\xb1r\xc4\xb1ld\xc4\xb1.');loadAdminReports();})">Kald\xc4\xb1r</button>
        </div>`;
      });
    } else { h+='<div style="color:var(--muted);padding:12px;">IP ban yok.</div>'; }
    h += '</div></div>';
    body.innerHTML = h;
  }).catch(()=>{ body.innerHTML='<p style="color:var(--muted);padding:20px;">Y√ºklenemedi.</p>'; });
}
function resolveReport(){}

/* 10. ADMIN: IP BAN */
async function loadAdminIPBan(){
  const body=document.getElementById('adminBody');
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  try{
    const bans=await adminRestGet('bannedIPs')||{};
    let h=`<div class="admin-section"><div class="admin-sec-title">üåê IP Ban Y√∂netimi</div>
      <div class="admin-card" style="padding:14px;margin-bottom:10px;">
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <input id="ipBanInp" class="admin-inp" placeholder="IP adresi (√∂rn: 192.168.1.1)" style="margin-bottom:0;flex:1;">
          <input id="ipBanNote" class="admin-inp" placeholder="Not (isteƒüe baƒülƒ±)" style="margin-bottom:0;flex:1;">
        </div>
        <button class="a-btn red" style="width:100%;" onclick="addIPBan()">üö´ IP Banla</button>
      </div>`;
    const arr=Object.entries(bans);
    if(arr.length){
      h+='<div class="admin-card" style="padding:0;">';
      arr.sort((a,b)=>((b[1]&&b[1].bannedAt)||0)-((a[1]&&a[1].bannedAt)||0)).forEach(([key,d])=>{
        const ip=d.ip||key.replace(/_/g,'.');
        const note=d.note||''; const ts=d.bannedAt?new Date(d.bannedAt).toLocaleString('tr-TR'):(d.ts?new Date(d.ts).toLocaleString('tr-TR'):'?'); const user=d.username||d.by||'?';
        h+=`<div class="admin-row" style="align-items:center;padding:10px 14px;"><div style="flex:1"><div style="font-family:monospace;font-weight:700;color:#e67e22">${esc(ip)}</div><div style="font-size:11px;color:var(--muted);margin-top:2px">üë§ ${esc(user)}${note?' ¬∑ üìù '+esc(note):''} ¬∑ üïê ${ts}</div></div><button class="a-btn green" style="padding:5px 10px;font-size:.72rem;" onclick="removeIPBan('${key}')">‚úÖ Kaldƒ±r</button></div>`;
      });
      h+='</div>';
    } else h+='<div class="admin-card" style="padding:18px;text-align:center;color:var(--muted);">Yasaklƒ± IP adresi yok.</div>';
    body.innerHTML=h+'</div>';
  }catch(e){ body.innerHTML='<div class="admin-section"><p style="color:#e74c3c;padding:20px">Hata: '+e.message+'</p></div>'; }
}
async function addIPBan(){
  const ip=(document.getElementById('ipBanInp')?.value||'').trim();
  const note=(document.getElementById('ipBanNote')?.value||'').trim();
  if(!ip){ showToast('IP adresi girin.'); return; }
  try{ await adminRestSet('bannedIPs/'+ip.replace(/\./g,'_'),{ip,note,bannedAt:Date.now(),bannedBy:_cu,username:'manuel'}); showToast('üö´ IP banlandƒ±: '+ip); loadAdminIPBan(); }
  catch(e){ showToast('‚ùå Hata: '+e.message); }
}
async function removeIPBan(ipKey){
  try{ await adminRestDelete('bannedIPs/'+ipKey); showToast('‚úÖ IP ban kaldƒ±rƒ±ldƒ±.'); loadAdminIPBan(); }
  catch(e){ showToast('‚ùå Hata: '+e.message); }
}

/* 11. ADMIN: B√úY√úME GRAFƒ∞ƒûƒ∞ + EN AKTƒ∞F ODALAR */
function loadAdminGrowthChart(){
  const body=document.getElementById('adminBody');
  body.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  Promise.all([adminRestGet('users').catch(()=>({})), adminRestGet('msgs').catch(()=>({}))]).then(([uS,mS])=>{
    const users=uS||{}, msgs=mS||{};
    const DAYS=30, now=Date.now();
    const buckets=Array.from({length:DAYS},(_,i)=>{
      const d=new Date(now-(DAYS-1-i)*86400000);
      return {label:(d.getMonth()+1)+'/'+d.getDate(), ts:d.setHours(0,0,0,0), users:0};
    });
    Object.values(users).forEach(u=>{
      if(!u.createdAt) return;
      for(let i=buckets.length-1;i>=0;i--){
        if(u.createdAt>=buckets[i].ts){ buckets[i].users++; break; }
      }
    });
    // Room activity
    const roomCounts={};
    Object.entries(msgs).forEach(([rid,rm])=>{ if(rm) roomCounts[rid]=Object.keys(rm).length; });
    const topRooms=Object.entries(roomCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
    const maxMsg=Math.max(...topRooms.map(r=>r[1]),1);
    let h=`<div class="admin-section"><div class="admin-sec-title">üìà Son 30 G√ºn Kayƒ±t</div><div class="admin-card" style="padding:16px;"><canvas id="growthCanvas" width="600" height="160" style="width:100%;max-width:100%;"></canvas></div></div>
    <div class="admin-section" style="margin-top:12px"><div class="admin-sec-title">üèÜ En Aktif Odalar</div><div class="admin-card" style="padding:14px;">`;
    topRooms.forEach(([rid,cnt])=>{
      const pct=Math.round(cnt/maxMsg*100);
      h+=`<div style="margin-bottom:10px;"><div style="display:flex;justify-content:space-between;font-size:.8rem;color:var(--text-hi);margin-bottom:3px;"><span>#${esc(rid)}</span><span>${cnt} mesaj</span></div><div style="background:var(--surface2);border-radius:100px;height:7px;"><div style="background:linear-gradient(90deg,var(--accent),#a855f7);height:100%;width:${pct}%;border-radius:100px;"></div></div></div>`;
    });
    body.innerHTML=h+'</div></div>';
    setTimeout(()=>{
      const canvas=document.getElementById('growthCanvas'); if(!canvas) return;
      const ctx=canvas.getContext('2d'), W=canvas.width, H=canvas.height;
      ctx.clearRect(0,0,W,H);
      const vis=buckets.slice(-20);
      const maxU=Math.max(...vis.map(b=>b.users),1);
      const bw=Math.floor((W-50)/vis.length)-3;
      ctx.fillStyle='rgba(255,255,255,0.03)'; ctx.fillRect(0,0,W,H);
      vis.forEach((b,i)=>{
        const x=50+i*(bw+3);
        const barH=Math.max(2,Math.round((b.users/maxU)*(H-40)));
        const y=H-25-barH;
        const g=ctx.createLinearGradient(0,y,0,H-25);
        g.addColorStop(0,'#6c63ff'); g.addColorStop(1,'rgba(108,99,255,.3)');
        ctx.fillStyle=g;
        ctx.beginPath(); ctx.roundRect?ctx.roundRect(x,y,bw,barH,3):ctx.rect(x,y,bw,barH); ctx.fill();
        if(b.users>0){ ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='bold 9px sans-serif'; ctx.fillText(b.users,x+1,y-3); }
        if(i%3===0){ ctx.fillStyle='rgba(255,255,255,.35)'; ctx.font='9px sans-serif'; ctx.fillText(b.label,x,H-8); }
      });
      [0,Math.ceil(maxU/2),maxU].forEach(v=>{
        const y=H-25-Math.round((v/maxU)*(H-40));
        ctx.fillStyle='rgba(255,255,255,.3)'; ctx.font='9px sans-serif'; ctx.fillText(v,2,y+4);
        ctx.fillStyle='rgba(255,255,255,.06)'; ctx.fillRect(48,y,W-48,1);
      });
    },150);
  });
}

/* 12. AKTƒ∞Vƒ∞TE ƒ∞STATƒ∞STƒ∞KLERƒ∞ */
function loadProfileStats(){ return; /*kaldƒ±rƒ±ldƒ±*/
  // REMOVED
  if(!_db||!_cu) return;
  const cont=document.getElementById('profStatsContent'); if(!cont) return;
  cont.innerHTML='<div class="ld"><span></span><span></span><span></span></div>';
  Promise.all([_db.ref('users/'+_cu).once('value'), _db.ref('msgs').once('value')]).then(([uS,mS])=>{
    const u=uS.val()||{};
    const allMsgs=mS.val()||{};
    let total=0;
    Object.values(allMsgs).forEach(rm=>{ if(rm) Object.values(rm).forEach(m=>{ if(m&&m.user===_cu) total++; }); });
    const join=u.createdAt?new Date(u.createdAt).toLocaleDateString('tr-TR'):'?';
    cont.innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;"><div style="font-size:1.4rem;font-weight:900;color:var(--accent);">${total}</div><div style="font-size:.68rem;color:var(--muted);">Mesaj G√∂nderildi</div></div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;"><div style="font-size:.85rem;font-weight:900;color:var(--text-hi);">${join}</div><div style="font-size:.68rem;color:var(--muted);">Katƒ±lƒ±m Tarihi</div></div>
    </div>`;
  });
}

/* 13. Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞ ‚Äî kaldƒ±rƒ±ldƒ± */
let _unreadNotifs=0;
function listenNotifications(){}
function openNotifications(){}
function markAllNotifsRead(){}

/* 14. YENƒ∞ SEKME & ADMIN SEKME EKLEME */
function injectProfileTabs(){
  const tabBar=document.querySelector('#profileScreen > div[style*="border-bottom"]');
  if(!tabBar||tabBar.dataset.pEnhanced) return;
  tabBar.dataset.pEnhanced='1';
  // Sosyal sekmesi kaldƒ±rƒ±ldƒ±
  const scroll=tabBar.nextElementSibling;
  if(scroll){
    const body=document.createElement('div');
    body.id='profTabBody-stats';
    body.style.cssText='padding:16px;display:none;';
    body.innerHTML='<div id="profStatsContent"><div class="ld"><span></span><span></span><span></span></div></div>';
    scroll.appendChild(body);
  }
}
function injectAdminTabs(){
  const atabs=document.querySelector('.admin-tabs');
  if(!atabs||atabs.dataset.aEnhanced) return;
  atabs.dataset.aEnhanced='1';
  [{id:'reports',label:'Raporlar'},{id:'ipban',label:'IP Ban'},{id:'growth',label:'Grafik'}].forEach(t=>{
    const d=document.createElement('div');
    d.className='atab';
    d.textContent=t.label;
    d.onclick=()=>adminTabNew(t.id);
    atabs.appendChild(d);
  });
}
function adminTabNew(tab){
  document.querySelectorAll('.atab').forEach(el=>el.classList.remove('act'));
  const active=[...document.querySelectorAll('.atab')].find(el=>{
    if(tab==='reports') return el.textContent.includes('Raporlar');
    if(tab==='ipban') return el.textContent.includes('IP Ban');
    if(tab==='growth') return el.textContent.includes('Grafik');
    return false;
  });
  if(active) active.classList.add('act');
  if(tab==='reports') loadAdminReports();
  else if(tab==='ipban') loadAdminIPBan();
  else if(tab==='growth') loadAdminGrowthChart();
}

/* 15. MESAJ MEN√úS√úNE YENƒ∞ √ñƒûELER */
const _origShowMsgMenu2=showMsgMenu;
function showMsgMenu(e,room,key,own,isAdmin,text){
  e.stopPropagation(); e.preventDefault();
  document.removeEventListener('click',_closeCtx);
  const menu=document.getElementById('msgCtxMenu'); if(!menu) return;
  let html='';
  // ‚îÄ‚îÄ Hƒ±zlƒ± Emoji Satƒ±rƒ± ‚îÄ‚îÄ
  const _qEmojis=['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•','üëè','üéâ'];
  html+=`<div style="display:flex;gap:1px;padding:7px 8px 6px;border-bottom:1px solid var(--border);margin-bottom:3px;">`;
  _qEmojis.forEach(em=>{
    html+=`<span onclick="addReaction(event,'${room}','${key}','${em}');_closeCtx()" style="font-size:1.3rem;cursor:pointer;padding:5px 6px;border-radius:8px;line-height:1;transition:background .12s,transform .15s;display:inline-flex;align-items:center;justify-content:center;" onmouseover="this.style.background='var(--border)';this.style.transform='scale(1.3)'" onmouseout="this.style.background='transparent';this.style.transform='scale(1)'">${em}</span>`;
  });
  html+=`</div>`;
  html+=`<div class="ctx-item" onclick="event.stopPropagation();showReactMenu(event,'${room}','${key}')"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></span> Tepki Ekle</div>`;
  html+=`<div class="ctx-item" onclick="event.stopPropagation();replyToMsg('${room}','${key}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg></span> Cevapla</div>`;
  html+=`<div class="ctx-item" onclick="event.stopPropagation();pinMsg('${room}','${key}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V17z"/></svg></span> Sabitle</div>`;
  html+=`<div class="ctx-item" onclick="event.stopPropagation();copyMsgText(${JSON.stringify(text)});_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg></span> Kopyala</div>`;
  html+=`<div class="ctx-item" onclick="event.stopPropagation();openCreatePoll();_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span> Anket Olu≈ütur</div>`;
  const msgEl=document.querySelector('.mb[data-key="'+key+'"]');
  const msgUser=msgEl?msgEl.querySelector('.mb-name')?.textContent||'':'';
  if(!own&&msgUser){
    html+=`<div class="ctx-item" onclick="event.stopPropagation();viewUserProfile('${esc(msgUser)}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg></span> Profili G√∂r</div>`;
  
  }
  if(own){
    html+=`<div class="ctx-item" onclick="event.stopPropagation();startEditMsg('${room}','${key}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span> D√ºzenle</div>`;
    html+=`<div class="ctx-item" onclick="event.stopPropagation();showEditHistory('${room}','${key}');_closeCtx()"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></span> D√ºzenleme Ge√ßmi≈üi</div>`;
  }
  if(own||isAdmin){
    html+=`<div style="height:1px;background:var(--border);margin:3px 4px;"></div>`;
    html+=`<div class="ctx-item danger" onclick="event.stopPropagation();deleteMsg('${room}','${key}')"><span style="width:22px;display:inline-flex;align-items:center;justify-content:center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></span> Sil</div>`;
  }
  menu.innerHTML=html;
  const mW=270, mH=(html.match(/ctx-item/g)||[]).length*42+62;
  let x=e.clientX, y=e.clientY;
  if(x+mW>window.innerWidth) x=window.innerWidth-mW-8;
  if(y+mH>window.innerHeight) y=window.innerHeight-mH-8;
  if(y<8) y=8;
  menu.style.cssText=`display:block;position:fixed;left:${x}px;top:${y}px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:5px;z-index:999999;box-shadow:0 8px 32px rgba(0,0,0,.7);min-width:220px;`;
  setTimeout(()=>document.addEventListener('click',_closeCtx,{once:true}),300);
}

/* 16. AVATAR TIKLANINCA PROFƒ∞L */
document.addEventListener('click',function(e){
  const av=e.target.closest('[data-av-user]');
  if(av&&av.dataset.avUser&&av.dataset.avUser!==_cu) viewUserProfile(av.dataset.avUser);
});

/* 17. PROFƒ∞L SEKMELERƒ∞ OVERRIDE */
const _origSwitchProfTab2=typeof switchProfTab==='function'?switchProfTab:null;
function switchProfTab(tab){
  ['profile','appearance','sounds','account'].forEach(t=>{
    const btn=document.getElementById('ptab-'+t);
    const body=document.getElementById('profTabBody-'+t);
    if(btn){btn.style.color=t===tab?'#fff':'var(--muted)';btn.style.borderBottom=t===tab?'2px solid var(--accent)':'2px solid transparent';}
    if(body) body.style.display=t===tab?(t==='profile'?'flex':'block'):'none';
  });
  // Se√ßili tab butonunu g√∂r√ºn√ºr yap (kaydƒ±rmalƒ± tab bar i√ßin)
  const activeBtn = document.getElementById('ptab-'+tab);
  if(activeBtn) activeBtn.scrollIntoView({inline:'center', behavior:'smooth'});
  // ƒ∞√ßerik alanƒ±nƒ± en √ºste kaydƒ±r
  const scrollWrap = document.querySelector('#profileScreen > div[style*="overflow-y"]');
  if(scrollWrap) scrollWrap.scrollTop = 0;
  if(tab==='account'){const ab=document.getElementById('adminPanelBtn');if(ab) ab.style.display=_isAdmin?'flex':'none';}
  if(tab==='sounds'){ renderToneGrids(); }
  // Sosyal sekmesi kaldƒ±rƒ±ldƒ±
}

/* 18. Bƒ∞LDƒ∞Rƒ∞M BUTONU ‚Äî kaldƒ±rƒ±ldƒ± */
function addNotifBell(){}

/* 19. MENTION Lƒ∞NKƒ∞FY ‚Äî observer */
const _mentionObserver=new MutationObserver(()=>{
  document.querySelectorAll('.mb-text, .ob').forEach(el=>{
    if(el.dataset.mz) return;
    el.dataset.mz='1';
    el.innerHTML=linkifyMentions(el.innerHTML);
  });
});
document.addEventListener('DOMContentLoaded',()=>{
  const b=document.getElementById('chatMsgs');
  if(b) _mentionObserver.observe(b,{childList:true,subtree:true});
});

/* 20. INIT */
document.addEventListener('DOMContentLoaded',()=>{
  // changePwModal'ƒ± body'e ta≈üƒ± ‚Äî masa√ºst√ºnde profileScreen gizlidir
  const pwModal = document.getElementById('changePwModal');
  if(pwModal && pwModal.parentElement !== document.body){
    document.body.appendChild(pwModal);
  }
  setTimeout(()=>{ injectProfileTabs(); injectAdminTabs(); },600);
});

// onLoginSuccess hook
const _prevOnLoginSuccess = typeof onLoginSuccess === 'function' ? onLoginSuccess : null;
onLoginSuccess = function(){
  if(_prevOnLoginSuccess) _prevOnLoginSuccess();
  setTimeout(()=>{
    loadBlockedUsers();
    injectProfileTabs();
    injectAdminTabs();
  },600);
};

// startEditMsg: save history
const _prevStartEditMsg = typeof startEditMsg === 'function' ? startEditMsg : null;
startEditMsg = function(room,key){
  if(_db) _db.ref('msgs/'+room+'/'+key).once('value').then(s=>{
    const m=s.val();
    if(m&&m.text) _db.ref('editHistory/'+room+'/'+key+'/'+Date.now()).set({text:m.text,ts:Date.now(),by:_cu});
  });
  if(_prevStartEditMsg) _prevStartEditMsg(room,key);
};
</script>

<script>
/* ‚îÄ‚îÄ Ekran Y√∂n√º Kilidi (portrait-only) ‚îÄ‚îÄ */
(function lockOrientation(){
  function tryLock(){
    try{
      if(screen.orientation&&screen.orientation.lock){
        screen.orientation.lock('portrait').catch(()=>{});
      } else if(screen.lockOrientation){
        screen.lockOrientation('portrait');
      } else if(screen.mozLockOrientation){
        screen.mozLockOrientation('portrait');
      }
    }catch(e){}
  }
  tryLock();
  document.addEventListener('DOMContentLoaded', tryLock);
  window.addEventListener('orientationchange', function(){
    setTimeout(tryLock, 100);
    // D√∂n√º≈üten sonra siyah ekran sorununu √ß√∂z (iOS repaint fix)
    setTimeout(function(){
      // G√ºvenilir portrait kontrol√º
      var isPortrait = false;
      if(screen.orientation && screen.orientation.type){
        isPortrait = screen.orientation.type.indexOf('portrait') !== -1;
      } else if(typeof window.orientation !== 'undefined'){
        isPortrait = (window.orientation === 0 || window.orientation === 180);
      } else {
        isPortrait = window.innerHeight > window.innerWidth;
      }
      if(isPortrait){
        var el = document.getElementById('orientationBlock');
        if(el) el.style.display = 'none';
        // iOS WebKit tam repaint
        document.documentElement.style.display = 'none';
        void document.documentElement.offsetHeight;
        document.documentElement.style.display = '';
        window.scrollTo(0, 0);
        // G√∂r√ºn√ºr ekranƒ± bul ve tetikle
        var visibleScreens = document.querySelectorAll('.screen');
        visibleScreens.forEach(function(s){
          var d = s.style.display;
          if(d && d !== 'none'){
            s.style.transform = 'translateZ(0)';
            void s.offsetHeight;
            s.style.transform = '';
          }
        });
      }
    }, 350);
  });
})();

/* ‚îÄ‚îÄ Emoji/GIF picker: bo≈ü alana tƒ±klayƒ±nca kapat ‚îÄ‚îÄ */
document.addEventListener('click', function(e){
  const picker = document.getElementById('emojiPicker');
  if(!picker || !picker.classList.contains('open')) return;
  // Picker i√ßine, emoji butonuna veya input alanƒ±na tƒ±klanmadƒ±ysa kapat
  const emojiBtn = e.target.closest('[onclick*="toggleEmoji"], .inp-btm button:first-child, button[onclick*="toggleEmoji"]');
  if(!emojiBtn && !picker.contains(e.target)){
    closeEmoji();
  }
}, true);
</script>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üåø SUNUCU GE√áƒ∞≈ûƒ∞ ‚Äî Kullanƒ±cƒ± Adƒ± & ≈ûifre ƒ∞ste
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showServerSwitchWithLogin(){
  const others = Object.entries(FB_SERVERS).filter(([k])=>k!==_activeServer);
  if(!others.length){ showToast('Ba≈üka sunucu yok.'); return; }

  const old = document.getElementById('_sswModal');
  if(old) old.remove();

  const modal = document.createElement('div');
  modal.id = '_sswModal';
  modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:9999999;display:flex;align-items:center;justify-content:center;padding:20px;';
  modal.innerHTML = `
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:18px;padding:26px 22px;width:100%;max-width:370px;box-shadow:0 20px 60px rgba(0,0,0,.7);">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div style="font-size:1.05rem;font-weight:900;color:var(--text-hi);">üîÄ Sunucu Ge√ßi≈üi</div>
        <div onclick="document.getElementById('_sswModal').remove()" style="cursor:pointer;color:var(--muted);font-size:1.3rem;line-height:1;padding:4px 8px;">‚úï</div>
      </div>
      <div style="font-size:.78rem;color:var(--muted);margin-bottom:16px;">≈ûu an: <b style="color:var(--text-hi)">${FB_SERVERS[_activeServer]?.label||_activeServer}</b></div>

      <div id="_sswStep1">
        <div style="font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">Sunucu Se√ß</div>
        ${others.map(([k,s])=>`
          <div onclick="_sswSelectServer('${k}')" style="display:flex;align-items:center;gap:12px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:13px 15px;cursor:pointer;margin-bottom:9px;transition:border-color .2s,background .2s;"
            onmouseover="this.style.borderColor='${s.color}';this.style.background='var(--surface2)'"
            onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--surface)'">
            <div style="width:40px;height:40px;border-radius:10px;background:${s.color}22;border:1px solid ${s.color}44;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;">${s.icon}</div>
            <div style="flex:1;">
              <div style="font-weight:700;color:var(--text-hi);font-size:.9rem;">${s.label}</div>
              <div style="font-size:.72rem;color:var(--muted);">${s.description}</div>
            </div>
            <div style="color:${s.color};font-size:1.2rem;">‚Ä∫</div>
          </div>
        `).join('')}
      </div>

      <div id="_sswStep2" style="display:none;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px;">
          <div id="_sswSrvIcon" style="width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><svg viewBox="0 0 120 120" width="32" height="32" xmlns="http://www.w3.org/2000/svg"><defs><clipPath id="lcswi"><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z"/></clipPath></defs><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="#0e2b0c"/><g clip-path="url(#lcswi)"><line x1="60" y1="14" x2="60" y2="108" stroke="#4a8f40" stroke-width="1.2"/><line x1="60" y1="35" x2="78" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="35" x2="42" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="52" x2="82" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="52" x2="38" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="68" x2="78" y2="82" stroke="#4a8f40" stroke-width=".5"/><line x1="60" y1="68" x2="42" y2="82" stroke="#4a8f40" stroke-width=".5"/></g><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="none" stroke="#4a8f40" stroke-width="1.2"/></svg></div>
          <div>
            <div id="_sswSrvName" style="font-weight:900;color:var(--text-hi);font-size:.95rem;"></div>
            <div style="font-size:.72rem;color:var(--muted);">Bu sunucuya giri≈ü yapƒ±n</div>
          </div>
        </div>
        <input id="_sswUser" type="text" placeholder="Kullanƒ±cƒ± adƒ±..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false"
          style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text-hi);font-size:.9rem;font-family:inherit;margin-bottom:10px;box-sizing:border-box;outline:none;"
          onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
        <input id="_sswPass" type="password" placeholder="≈ûifre..." autocomplete="new-password"
          style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:11px 14px;color:var(--text-hi);font-size:.9rem;font-family:inherit;margin-bottom:6px;box-sizing:border-box;outline:none;"
          onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"
          onkeydown="if(event.key==='Enter')_sswDoLogin()">
        <div id="_sswErr" style="color:#e05555;font-size:.78rem;margin-bottom:10px;min-height:18px;"></div>
        <div style="display:flex;gap:8px;">
          <button onclick="_sswBack()" style="flex:1;padding:11px;background:var(--surface);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:.88rem;font-weight:700;cursor:pointer;">‚Äπ Geri</button>
          <button onclick="_sswDoLogin()" id="_sswLoginBtn" style="flex:2;padding:11px;background:var(--accent);border:none;border-radius:10px;color:#fff;font-size:.88rem;font-weight:900;cursor:pointer;">Giri≈ü Yap ‚Üí</button>
        </div>
      </div>
    </div>
  `;
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.remove(); });
  document.body.appendChild(modal);
}

let _sswTargetKey = null;
function _sswSelectServer(key){
  _sswTargetKey = key;
  const s = FB_SERVERS[key];
  document.getElementById('_sswStep1').style.display = 'none';
  document.getElementById('_sswStep2').style.display = 'block';
  document.getElementById('_sswSrvIcon').textContent = s.icon;
  document.getElementById('_sswSrvIcon').style.background = s.color+'22';
  document.getElementById('_sswSrvName').textContent = s.label;
  setTimeout(()=>{ const u=document.getElementById('_sswUser'); if(u) u.focus(); }, 100);
}
function _sswBack(){
  document.getElementById('_sswStep1').style.display = 'block';
  document.getElementById('_sswStep2').style.display = 'none';
  document.getElementById('_sswErr').textContent = '';
}
async function _sswDoLogin(){
  const username = (document.getElementById('_sswUser').value||'').trim();
  const pass = document.getElementById('_sswPass').value||'';
  const errEl = document.getElementById('_sswErr');
  if(!username){ errEl.textContent='Kullanƒ±cƒ± adƒ± girin.'; return; }
  if(!pass){ errEl.textContent='≈ûifre girin.'; return; }
  const btn = document.getElementById('_sswLoginBtn');
  btn.textContent = 'Kontrol ediliyor...'; btn.disabled = true;
  errEl.textContent = '';

  try{
    const targetSrv = FB_SERVERS[_sswTargetKey];
    const tempApp = firebase.initializeApp(targetSrv.config, '_sswTemp_'+Date.now());
    const tempDb = firebase.database(tempApp);
    const snap = await tempDb.ref('users/'+username).once('value');
    const u = snap.val();
    await tempApp.delete().catch(()=>{});

    if(!u){ errEl.textContent='Kullanƒ±cƒ± bulunamadƒ±.'; btn.textContent='Giri≈ü Yap ‚Üí'; btn.disabled=false; return; }
    const ph = await hashStr(pass + username);
    const phLegacy = hashStrSync(pass + username);
    if(u.passwordHash !== ph && u.passwordHash !== phLegacy){ errEl.textContent='≈ûifre hatalƒ±.'; btn.textContent='Giri≈ü Yap ‚Üí'; btn.disabled=false; return; }
    if(u.banned){ errEl.textContent='Bu hesap banlƒ±.'; btn.textContent='Giri≈ü Yap ‚Üí'; btn.disabled=false; return; }

    document.getElementById('_sswModal').remove();
    await _switchToServer(_sswTargetKey);
    setTimeout(async ()=>{
      _cu = username;
      const ok = await fbInit();
      if(!ok){ showToast('Firebase baƒülanamadƒ±.'); return; }
      _passwordHash = ph;
      onLoginSuccess();
    }, 800);
  }catch(e){
    errEl.textContent='Baƒülantƒ± hatasƒ±: '+e.message;
    btn.textContent='Giri≈ü Yap ‚Üí'; btn.disabled=false;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üëë GENƒ∞≈ûLETƒ∞LMƒ∞≈û ADMIN PANELƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const _origDeskLoadAdmin = typeof deskLoadAdmin === 'function' ? deskLoadAdmin : null;
deskLoadAdmin = function(){
  const panel = document.getElementById('deskPanelContent');
  const tabs = [
    { key:'users',     label:'üë• Kullanƒ±cƒ±lar' },
    { key:'rooms',     label:'üì¢ Odalar' },
    { key:'msgs',      label:'üí¨ Mesajlar' },
    { key:'forum',     label:'üìã Forum' },
    { key:'announce',  label:'üì£ Duyuru' },
    { key:'broadcast', label:'üì° Yayƒ±m' },
    { key:'games',     label:'üéÆ Oyunlar' },
    { key:'health',    label:'üìä Sistem' },
    { key:'security',  label:'üõ°Ô∏è G√ºvenlik' },
    { key:'ipban',     label:'üîí IP Ban' },
    { key:'reports',   label:'üö© Raporlar' },
    { key:'growth',    label:'üìà B√ºy√ºme' },
    { key:'activity',  label:'üïê Aktivite' },
    { key:'naturebot', label:'ü§ñ NatureBot' },
    { key:'settings',  label:'‚öôÔ∏è Ayarlar' },
  ];
  panel.innerHTML = `
    <div style="display:flex;flex-direction:column;height:100%;overflow:hidden;">
      <div style="display:flex;align-items:center;gap:10px;padding:16px 20px 0;flex-shrink:0;">
        <div style="font-size:1.3rem;">üëë</div>
        <div style="font-size:1.05rem;font-weight:900;color:var(--text-hi);">Admin Paneli</div>
        <div style="margin-left:auto;font-size:.72rem;color:var(--muted);">Sunucu: <b style="color:var(--accent)">${FB_SERVERS[_activeServer]?.label||_activeServer}</b></div>
      </div>
      <div id="deskAdminTabs" style="display:flex;gap:2px;padding:10px 12px 0;flex-shrink:0;overflow-x:auto;border-bottom:1px solid var(--border);scrollbar-width:none;"></div>
      <div id="adminBody" style="flex:1;overflow-y:auto;padding:16px 20px;"></div>
    </div>`;
  const tabBar = document.getElementById('deskAdminTabs');
  tabs.forEach(t=>{
    const el = document.createElement('div');
    el.textContent = t.label;
    el.dataset.key = t.key;
    el.style.cssText = 'padding:7px 12px;border-radius:8px 8px 0 0;cursor:pointer;font-size:.78rem;font-weight:700;color:var(--muted);white-space:nowrap;transition:background .1s,color .1s;flex-shrink:0;';
    el.onclick = ()=>deskAdminTab(t.key);
    tabBar.appendChild(el);
  });
  deskAdminTab('users');
};

const _origDeskAdminTab = typeof deskAdminTab === 'function' ? deskAdminTab : null;
deskAdminTab = function(tab){
  _adminTab = tab;
  const tabBar = document.getElementById('deskAdminTabs');
  if(tabBar) tabBar.querySelectorAll('div').forEach(el=>{
    const act = el.dataset.key===tab;
    el.style.color = act?'var(--text-hi)':'var(--muted)';
    el.style.background = act?'var(--surface)':'transparent';
    el.style.borderBottom = act?'2px solid var(--accent)':'2px solid transparent';
  });
  const body = document.getElementById('adminBody');
  if(!body) return;
  body.innerHTML = '<div style="color:var(--muted);padding:40px;text-align:center;">Y√ºkleniyor...</div>';
  if(tab==='users') loadAdminUsers();
  else if(tab==='rooms') loadAdminRooms();
  else if(tab==='msgs') loadAdminMsgs();
  else if(tab==='forum') loadAdminForum();
  else if(tab==='announce') loadAdminAnnounce();
  else if(tab==='broadcast') loadAdminBroadcast();
  else if(tab==='games') loadAdminGames();
  else if(tab==='health') loadAdminSystemHealth();
  else if(tab==='stats') loadAdminStats();
  else if(tab==='security') loadAdminSecurity();
  else if(tab==='ipban') loadAdminIPBan();
  else if(tab==='reports') loadAdminReports();
  else if(tab==='growth') loadAdminGrowthChart();
  else if(tab==='activity') loadAdminActivityFull();
  else if(tab==='settings') loadAdminSettings();
  else if(tab==='naturebot') loadAdminNatureBot();
};

/* ‚îÄ‚îÄ üì° YAYIM (Broadcast) ‚îÄ‚îÄ */
function loadAdminNatureBot() {
  const body = document.getElementById('adminBody');
  if (!body) return;

  const bot = window._natureBotInstance;
  const isActive = !!bot;
  const state = !bot ? 'Ba≈ülatƒ±lmamƒ±≈ü'
    : bot.isSleeping ? 'üò¥ Uyuyor'
    : bot.isAtHome   ? 'üè† Yuvada'
    : bot.isCalling  ? 'üìû Arƒ±yor'
    : bot.isTalking  ? 'üí¨ Konu≈üuyor'
    : 'üö∂ Dola≈üƒ±yor';

  const wanderMin = bot ? Math.round(bot.WANDER_DURATION / 60000) : 15;
  const sleepMin  = bot ? Math.round(bot.SLEEP_DURATION  / 60000) : 45;

  body.innerHTML = `
  <div class="admin-section">
    <div class="admin-sec-title">ü§ñ NatureBot Durumu</div>
    <div class="admin-card" style="padding:16px;display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
      <div style="text-align:center;min-width:80px;">
        <div style="font-size:2.5rem;">ü§ñ</div>
        <div style="font-size:.7rem;font-weight:800;margin-top:4px;color:${isActive ? 'var(--green)' : 'var(--muted)'};">
          ${isActive ? '‚óè AKTƒ∞F' : '‚óã PASƒ∞F'}
        </div>
      </div>
      <div style="flex:1;min-width:160px;">
        <div style="font-size:1rem;font-weight:900;color:var(--text-hi);margin-bottom:4px;">NatureBot</div>
        <div style="font-size:.8rem;color:var(--muted);margin-bottom:8px;">Durum: <b style="color:var(--text)">${state}</b></div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="a-btn blue" onclick="adminBotAction('start')" ${isActive ? 'disabled style="opacity:.5"' : ''}>‚ñ∂ Ba≈ülat</button>
          <button class="a-btn red"  onclick="adminBotAction('stop')"  ${!isActive ? 'disabled style="opacity:.5"' : ''}>‚ñ† Durdur</button>
          <button class="a-btn"      onclick="adminBotAction('reload')" ${!isActive ? 'disabled style="opacity:.5"' : ''}>üîÑ Yeniden Ba≈ülat</button>
        </div>
      </div>
    </div>
  </div>

  <div class="admin-section" style="margin-top:12px;">
    <div class="admin-sec-title">üéÆ Anlƒ±k Kontroller</div>
    <div class="admin-card" style="padding:14px;display:flex;gap:8px;flex-wrap:wrap;">
      <button class="a-btn blue"  onclick="adminBotAction('wake')"   ${!isActive ? 'disabled style="opacity:.5"' : ''}>‚òÄ Uyandƒ±r</button>
      <button class="a-btn"       onclick="adminBotAction('sleep')"  ${!isActive ? 'disabled style="opacity:.5"' : ''}>üò¥ Uyut</button>
      <button class="a-btn"       onclick="adminBotAction('home')"   ${!isActive ? 'disabled style="opacity:.5"' : ''}>üè† Eve G√∂nder</button>
      <button class="a-btn blue"  onclick="adminBotAction('wander')" ${!isActive ? 'disabled style="opacity:.5"' : ''}>üö∂ Dola≈ütƒ±r</button>
      <button class="a-btn"       onclick="adminBotAction('greet')"  ${!isActive ? 'disabled style="opacity:.5"' : ''}>üëã Selamlat</button>
    </div>
  </div>

  <div class="admin-section" style="margin-top:12px;">
    <div class="admin-sec-title">‚è± S√ºre Ayarlarƒ±</div>
    <div class="admin-card" style="padding:14px;display:flex;flex-direction:column;gap:12px;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <label style="font-size:.8rem;color:var(--muted);min-width:140px;">üö∂ Dola≈üma S√ºresi (dk)</label>
        <input id="botWanderMin" type="number" min="1" max="120" value="${wanderMin}"
          style="width:80px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 8px;color:var(--text-hi);font-size:.85rem;outline:none;"
          onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"/>
        <span style="font-size:.75rem;color:var(--muted);">dk sonra uyku denemeleri ba≈ülar</span>
      </div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <label style="font-size:.8rem;color:var(--muted);min-width:140px;">üò¥ Uyku S√ºresi (dk)</label>
        <input id="botSleepMin" type="number" min="1" max="300" value="${sleepMin}"
          style="width:80px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 8px;color:var(--text-hi);font-size:.85rem;outline:none;"
          onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"/>
        <span style="font-size:.75rem;color:var(--muted);">dk hareketsizlik sonrasƒ± uyuyor</span>
      </div>
      <button class="a-btn blue" onclick="adminBotSaveTiming()" style="align-self:flex-start;padding:8px 18px;">üíæ S√ºreleri Kaydet</button>
    </div>
  </div>

  <div class="admin-section" style="margin-top:12px;">
    <div class="admin-sec-title">üí¨ Kar≈üƒ±lama Mesajlarƒ±</div>
    <div class="admin-card" style="padding:14px;display:flex;flex-direction:column;gap:8px;">
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Bot ilk a√ßƒ±ldƒ±ƒüƒ±nda bu mesajlardan birini s√∂yler. Her satƒ±r bir mesaj.</div>
      <textarea id="botGreetMsgs" rows="6"
        style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px;color:var(--text-hi);font-size:.82rem;font-family:inherit;resize:vertical;box-sizing:border-box;outline:none;line-height:1.6;"
        onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"
        >${window.GREETING_MSGS ? window.GREETING_MSGS.join('\n') : ''}</textarea>
      <button class="a-btn blue" onclick="adminBotSaveMsgs('greet')" style="align-self:flex-start;padding:8px 18px;">üíæ Kaydet</button>
    </div>
  </div>

  <div class="admin-section" style="margin-top:12px;">
    <div class="admin-sec-title">üåÄ Bo≈üta Mesajlarƒ±</div>
    <div class="admin-card" style="padding:14px;display:flex;flex-direction:column;gap:8px;">
      <div style="font-size:.75rem;color:var(--muted);margin-bottom:4px;">Bot dola≈üƒ±rken rastgele bu mesajlarƒ± g√∂sterir.</div>
      <textarea id="botIdleMsgs" rows="8"
        style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px;color:var(--text-hi);font-size:.82rem;font-family:inherit;resize:vertical;box-sizing:border-box;outline:none;line-height:1.6;"
        onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"
        >${window.IDLE_MSGS ? window.IDLE_MSGS.join('\n') : ''}</textarea>
      <button class="a-btn blue" onclick="adminBotSaveMsgs('idle')" style="align-self:flex-start;padding:8px 18px;">üíæ Kaydet</button>
    </div>
  </div>

  <div class="admin-section" style="margin-top:12px;">
    <div class="admin-sec-title">‚å® √ñzel Mesaj G√∂nder</div>
    <div class="admin-card" style="padding:14px;display:flex;flex-direction:column;gap:10px;">
      <div style="font-size:.75rem;color:var(--muted);">Bota istediƒüin bir mesajƒ± s√∂ylet (baloncukta g√∂sterilir).</div>
      <div style="display:flex;gap:8px;">
        <input id="botCustomMsg" type="text" placeholder="Mesaj yaz..."
          style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text-hi);font-size:.85rem;outline:none;"
          onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"
          onkeydown="if(event.key==='Enter')adminBotSendCustomMsg()"/>
        <button class="a-btn blue" onclick="adminBotSendCustomMsg()" style="padding:8px 16px;">üì§ S√∂yle</button>
      </div>
    </div>
  </div>`;
}

function adminBotAction(action) {
  const bot = window._natureBotInstance;
  if (action === 'start') {
    if (typeof startNatureBot === 'function') startNatureBot();
    showToast('ü§ñ NatureBot ba≈ülatƒ±lƒ±yor...');
    setTimeout(loadAdminNatureBot, 1000);
    return;
  }
  if (action === 'stop') {
    if (bot) {
      clearTimeout(bot.wanderTimer); clearTimeout(bot.sleepTimer);
      clearTimeout(bot.idleTimeout); clearTimeout(bot.homeCheckTimer);
      if (bot.el) bot.el.remove();
      if (bot.bubble) bot.bubble.remove();
      if (bot.kennelEl) bot.kennelEl.remove();
      if (bot.zzzEl) bot.zzzEl.remove();
      window._natureBotInstance = null;
    }
    showToast('üî¥ NatureBot durduruldu.');
    loadAdminNatureBot(); return;
  }
  if (action === 'reload') {
    adminBotAction('stop');
    setTimeout(() => { adminBotAction('start'); }, 600);
    return;
  }
  if (!bot) { showToast('‚ö† NatureBot aktif deƒüil.'); return; }
  if (action === 'wake')   { bot.wakeUp();      showToast('‚òÄ Bot uyandƒ±rƒ±ldƒ±!'); }
  if (action === 'sleep')  { if(bot.isAtHome){ bot.fallAsleep(); } else { bot.goToKennel(); } showToast('üò¥ Bot uyutulmaya g√∂nderildi!'); }
  if (action === 'home')   { bot.goToKennel(); showToast('üè† Bot evine g√∂nderildi!'); }
  if (action === 'wander') { bot.startWander && bot.startWander(); showToast('üö∂ Bot dola≈ümaya ba≈üladƒ±!'); }
  if (action === 'greet')  {
    const msg = window.GREETING_MSGS ? window.GREETING_MSGS[Math.floor(Math.random()*window.GREETING_MSGS.length)] : 'üëã Merhaba!';
    bot.say && bot.say(msg); showToast('üëã Bot selamlama yaptƒ±!');
  }
  setTimeout(loadAdminNatureBot, 400);
}

function adminBotSaveTiming() {
  const bot = window._natureBotInstance;
  const wMin = parseInt(document.getElementById('botWanderMin')?.value || 15);
  const sMin = parseInt(document.getElementById('botSleepMin')?.value || 45);
  if (isNaN(wMin) || isNaN(sMin) || wMin < 1 || sMin < 1) { showToast('‚ö† Ge√ßersiz deƒüer!'); return; }
  if (bot) {
    bot.WANDER_DURATION = wMin * 60 * 1000;
    bot.SLEEP_DURATION  = sMin * 60 * 1000;
  }
  try { localStorage.setItem('naturebot_wander_min', wMin); localStorage.setItem('naturebot_sleep_min', sMin); } catch {}
  showToast('‚úÖ S√ºreler kaydedildi!');
}

function adminBotSaveMsgs(type) {
  if (type === 'greet') {
    const lines = document.getElementById('botGreetMsgs')?.value.split('\n').map(s=>s.trim()).filter(Boolean);
    if (lines && lines.length) { window.GREETING_MSGS = lines; showToast('‚úÖ Kar≈üƒ±lama mesajlarƒ± g√ºncellendi! (' + lines.length + ' adet)'); }
    else showToast('‚ö† En az bir mesaj gir!');
  }
  if (type === 'idle') {
    const lines = document.getElementById('botIdleMsgs')?.value.split('\n').map(s=>s.trim()).filter(Boolean);
    if (lines && lines.length) { window.IDLE_MSGS = lines; showToast('‚úÖ Bo≈üta mesajlarƒ± g√ºncellendi! (' + lines.length + ' adet)'); }
    else showToast('‚ö† En az bir mesaj gir!');
  }
}

function adminBotSendCustomMsg() {
  const bot = window._natureBotInstance;
  const inp = document.getElementById('botCustomMsg');
  const msg = inp?.value.trim();
  if (!msg) { showToast('‚ö† Mesaj bo≈ü!'); return; }
  if (!bot) { showToast('‚ö† NatureBot aktif deƒüil.'); return; }
  bot.say && bot.say(msg);
  if (inp) inp.value = '';
  showToast('üì§ Mesaj g√∂nderildi!');
}

function loadAdminBroadcast(){
  const body = document.getElementById('adminBody');
  body.innerHTML = `
    <div class="admin-section">
      <div class="admin-sec-title">üì° Toplu Yayƒ±m Mesajƒ±</div>
      <div class="admin-card" style="padding:16px;display:flex;flex-direction:column;gap:12px;">
        <div style="font-size:.78rem;color:var(--muted);">T√ºm kanallara veya se√ßili bir kanala sistem mesajƒ± g√∂nder.</div>
        <div><div class="admin-sec-title" style="margin-bottom:6px;">Hedef Kanal</div>
          <select class="admin-inp" id="bcastRoom" style="margin-bottom:0;"></select></div>
        <div><div class="admin-sec-title" style="margin-bottom:6px;">Mesaj</div>
          <textarea id="bcastMsg" placeholder="Yayƒ±m mesajƒ±nƒ± yazƒ±n..." style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text-hi);font-size:.88rem;font-family:inherit;resize:vertical;min-height:90px;box-sizing:border-box;outline:none;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'"></textarea></div>
        <div style="display:flex;gap:8px;">
          <button class="a-btn blue" onclick="sendAdminBroadcast(false)" style="flex:1;padding:11px;">üì¢ Se√ßili Kanala</button>
          <button class="a-btn red" onclick="sendAdminBroadcast(true)" style="flex:1;padding:11px;">üì° T√ºm Kanallara</button>
        </div>
      </div>
    </div>
    <div class="admin-section" style="margin-top:14px;">
      <div class="admin-sec-title">üìã Son Yayƒ±mlar</div>
      <div class="admin-card" id="bcastHistory" style="padding:12px;font-size:.82rem;color:var(--muted);">Y√ºkleniyor...</div>
    </div>`;

  adminRestGet('rooms').then(roomsData=>{
    const rooms = Object.values(roomsData||{}).filter(r=>r.type==='channel');
    const sel = document.getElementById('bcastRoom');
    if(sel) sel.innerHTML = rooms.map(r=>`<option value="${r.id}">${esc(r.name)}</option>`).join('');
  }).catch(()=>{});
  adminRestGet('adminBroadcasts').then(data=>{
    const hist = document.getElementById('bcastHistory');
    if(!hist) return;
    if(!data){ hist.innerHTML='<div style="color:var(--muted);">Hen√ºz yayƒ±m yok.</div>'; return; }
    hist.innerHTML = Object.values(data).reverse().map(b=>`
      <div style="border-bottom:1px solid var(--border);padding:8px 0;">
        <div style="color:var(--text-hi);margin-bottom:2px;font-size:.83rem;">${esc(b.text||'')}</div>
        <div style="font-size:.72rem;color:var(--muted);">${b.room==='all'?'üì° T√ºm kanallar':'üì¢ '+esc(b.roomName||b.room)} ¬∑ ${new Date(b.ts||0).toLocaleString('tr-TR')}</div>
      </div>`).join('');
  }).catch(()=>{});
}
function sendAdminBroadcast(allRooms){
  const msg = (document.getElementById('bcastMsg')?.value||'').trim();
  if(!msg){ showToast('Mesaj bo≈ü olamaz.'); return; }
  if(!confirm(allRooms?'T√ºm kanallara mesaj g√∂nderilsin mi?':'Se√ßili kanala mesaj g√∂nderilsin mi?')) return;
  const ts = Date.now();
  async function sendToRoom(roomId, roomName){
    const key = ts.toString(36)+'_bc'+Math.random().toString(36).slice(2,6);
    await adminRestSet('msgs/'+roomId+'/'+key, {user:'üì° Admin Yayƒ±mƒ±', text:'üì° '+msg, ts, system:true, _key:key});
    await adminRestSet('adminBroadcasts/'+key, {text:msg, room:roomId, roomName, ts, by:_cu});
  }
  if(allRooms){
    adminRestGet('rooms').then(async roomsData=>{
      const chans = Object.values(roomsData||{}).filter(r=>r.type==='channel');
      await Promise.all(chans.map(r=>sendToRoom(r.id, r.name)));
      showToast('‚úÖ T√ºm kanallara g√∂nderildi!');
      document.getElementById('bcastMsg').value='';
      loadAdminBroadcast();
    }).catch(()=>showToast('Hata.'));
  } else {
    const sel = document.getElementById('bcastRoom');
    if(!sel?.value){ showToast('Kanal se√ßin.'); return; }
    sendToRoom(sel.value, sel.options[sel.selectedIndex]?.text||sel.value).then(()=>{
      showToast('‚úÖ G√∂nderildi!');
      document.getElementById('bcastMsg').value='';
      loadAdminBroadcast();
    }).catch(()=>showToast('Hata.'));
  }
}

/* ‚îÄ‚îÄ üïê AKTƒ∞Vƒ∞TE LOGLARI ‚îÄ‚îÄ */
function loadAdminActivityFull(){
  const body = document.getElementById('adminBody');
  body.innerHTML = `
    <div class="admin-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
        <div class="admin-sec-title" style="margin:0">üïê Aktivite Loglarƒ±</div>
        <div style="display:flex;gap:6px;">
          <select id="actLogFilter" onchange="loadAdminActivityFull()" class="admin-inp" style="margin:0;padding:5px 10px;font-size:.78rem;">
            <option value="all">T√ºm√º</option>
            <option value="login">Giri≈üler</option>
            <option value="msg">Mesajlar</option>
            <option value="ban">Ban/Unban</option>
            <option value="admin">Admin ƒ∞≈ülemleri</option>
          </select>
          <button class="a-btn red" onclick="clearActivityLogs()" style="padding:5px 12px;font-size:.78rem;">üóëÔ∏è Temizle</button>
        </div>
      </div>
      <div class="admin-card" id="actLogBody" style="padding:0;max-height:500px;overflow-y:auto;"></div>
    </div>`;
  const filter = document.getElementById('actLogFilter')?.value||'all';
  adminRestGet('activityLog').then(data=>{
    const logBody = document.getElementById('actLogBody');
    if(!logBody) return;
    data = data||{};
    let entries = Object.values(data).reverse();
    if(filter!=='all') entries = entries.filter(e=>e.type===filter);
    if(!entries.length){ logBody.innerHTML='<div style="color:var(--muted);padding:20px;text-align:center;">Log bulunamadƒ±.</div>'; return; }
    const typeIcon = {login:'üîë',msg:'üí¨',ban:'üö´',admin:'üëë',register:'üìù',logout:'üö™'};
    logBody.innerHTML = entries.map(e=>`
      <div style="display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border);">
        <div style="font-size:1.1rem;flex-shrink:0;">${typeIcon[e.type]||'üìå'}</div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:.83rem;color:var(--text-hi);font-weight:600;">${esc(e.user||'?')} <span style="color:var(--muted);font-weight:400;">${esc(e.action||e.type||'')}</span></div>
          <div style="font-size:.72rem;color:var(--muted);">${new Date(e.ts||0).toLocaleString('tr-TR')}${e.ip?' ¬∑ IP: '+esc(e.ip):''}</div>
        </div>
      </div>`).join('');
  });
}
function clearActivityLogs(){
  if(!confirm('T√ºm aktivite loglarƒ± silinsin mi?')) return;
  _db.ref('activityLog').remove().then(()=>{ showToast('Loglar temizlendi.'); loadAdminActivityFull(); });
}
</script>


<!-- ‚ïê‚ïê √úYELƒ∞K S√ñZLE≈ûMESƒ∞ & KVKK MODALƒ∞ ‚ïê‚ïê -->
<div id="tosModal" style="display:none;position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.82);overflow-y:auto;-webkit-overflow-scrolling:touch;">
  <div style="max-width:700px;margin:30px auto 60px;background:#1a1a1a;border-radius:14px;padding:28px 24px;color:#ddd;font-size:13.5px;line-height:1.75;font-family:system-ui,sans-serif;">

    <!-- Sekme Ba≈ülƒ±klarƒ± -->
    <div style="display:flex;gap:8px;margin-bottom:24px;border-bottom:1px solid #333;padding-bottom:12px;">
      <button id="tabTos" onclick="showTosTab('tos')"
        style="flex:1;padding:9px;border-radius:8px;border:none;background:#2ecc71;color:#fff;font-weight:700;font-size:13px;cursor:pointer;">
        üìÑ √úyelik S√∂zle≈ümesi
      </button>
      <button id="tabKvkk" onclick="showTosTab('kvkk')"
        style="flex:1;padding:9px;border-radius:8px;border:none;background:#2a2a2a;color:#aaa;font-weight:700;font-size:13px;cursor:pointer;">
        üîí KVKK Aydƒ±nlatma Metni
      </button>
    </div>

    <!-- ‚îÄ‚îÄ S√ñZLE≈ûME SEKMESƒ∞ ‚îÄ‚îÄ -->
    <div id="tosTabContent">
      <h2 style="color:#fff;font-size:17px;margin-bottom:4px;text-align:center;display:flex;align-items:center;justify-content:center;gap:8px;"><svg viewBox="0 0 120 120" width="20" height="20" xmlns="http://www.w3.org/2000/svg"><defs><clipPath id="lctos"><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z"/></clipPath></defs><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="#0e2b0c"/><g clip-path="url(#lctos)"><line x1="60" y1="14" x2="60" y2="108" stroke="#4a8f40" stroke-width="1.2"/><line x1="60" y1="35" x2="78" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="35" x2="42" y2="55" stroke="#4a8f40" stroke-width=".7"/><line x1="60" y1="52" x2="82" y2="68" stroke="#4a8f40" stroke-width=".6"/><line x1="60" y1="52" x2="38" y2="68" stroke="#4a8f40" stroke-width=".6"/></g><path d="M60 14 C76 22 98 44 98 68 C98 92 81 108 60 108 C39 108 22 92 22 68 C22 44 44 22 60 14Z" fill="none" stroke="#4a8f40" stroke-width="1.2"/></svg> NATURE.CO √úYELƒ∞K S√ñZLE≈ûMESƒ∞</h2>
      <p style="text-align:center;color:#888;font-size:12px;margin-bottom:20px;">Son g√ºncelleme: Mart 2026</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">1. TARAFLAR VE KAPSAM</h3>
      <p>Bu √úyelik S√∂zle≈ümesi ("S√∂zle≈üme"), Nature.co platformu ("Platform") ile platforma √ºye olan ger√ßek ki≈üi ("√úye") arasƒ±nda akdedilmektedir. S√∂zle≈üme, T√ºrkiye Cumhuriyeti kanunlarƒ±na ve 6698 sayƒ±lƒ± Ki≈üisel Verilerin Korunmasƒ± Kanunu'na (KVKK) uygun olarak d√ºzenlenmi≈ütir. Platforma √ºye olarak bu s√∂zle≈ümeyi okuduƒüunuzu, anladƒ±ƒüƒ±nƒ±zƒ± ve t√ºm ≈üartlarƒ± kabul ettiƒüinizi beyan etmi≈ü olursunuz.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">2. √úYELƒ∞K KO≈ûULLARI</h3>
      <p>Platforma √ºye olabilmek i√ßin 18 ya≈üƒ±nƒ± doldurmu≈ü olmak gerekmektedir. 18 ya≈üƒ±ndan k√º√ß√ºk ki≈üilerin veli/vasi onayƒ± olmaksƒ±zƒ±n √ºye olmasƒ± yasaktƒ±r. √úye, kayƒ±t sƒ±rasƒ±nda ger√ßeƒüe aykƒ±rƒ± bilgi vermemekle y√ºk√ºml√ºd√ºr; aksi h√¢lde hesap kalƒ±cƒ± olarak kapatƒ±lƒ±r ve gerektiƒüinde yetkili mercilere bildirilir.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">3. Kƒ∞≈ûƒ∞SEL VERƒ∞LER VE KVKK</h3>
      <p>√úyelik sƒ±rasƒ±nda toplanan ki≈üisel veriler (kullanƒ±cƒ± adƒ±, e-posta adresi) ve √∂zel nitelikli ki≈üisel veri sayƒ±lan k√∂ken/milliyet bilgisi; 6698 sayƒ±lƒ± KVKK'nƒ±n 5. ve 6. maddeleri kapsamƒ±nda, yalnƒ±zca a≈üaƒüƒ±daki ama√ßlarla ve <strong style="color:#fff;">a√ßƒ±k rƒ±zanƒ±za</strong> dayanƒ±larak i≈ülenmektedir:</p>
      <ul style="margin:8px 0 8px 20px;">
        <li>√úyelik kaydƒ±nƒ±n olu≈üturulmasƒ± ve y√∂netilmesi</li>
        <li>Hesap g√ºvenliƒüinin ve platform b√ºt√ºnl√ºƒü√ºn√ºn saƒülanmasƒ±</li>
        <li>Yasal y√ºk√ºml√ºl√ºklerin yerine getirilmesi</li>
      </ul>
      <p>K√∂ken/milliyet bilgisi KVKK kapsamƒ±nda <em>√∂zel nitelikli ki≈üisel veri</em> olup Kurul'un √∂ng√∂rd√ºƒü√º yeterli g√ºvenlik tedbirleri alƒ±narak i≈ülenmektedir. Bu veri √º√ß√ºnc√º ki≈üilerle payla≈üƒ±lmaz, satƒ±lmaz veya ticari ama√ßla kullanƒ±lmaz. Detaylƒ± bilgi i√ßin <strong style="color:#fff;">KVKK Aydƒ±nlatma Metni</strong> sekmesini inceleyiniz.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">4. YASAK ƒ∞√áERƒ∞K VE DAVRANI≈ûLAR</h3>
      <p>√úyeler a≈üaƒüƒ±daki i√ßerik ve davranƒ±≈ülardan kesinlikle ka√ßƒ±nmakla y√ºk√ºml√ºd√ºr:</p>
      <ul style="margin:8px 0 8px 20px;">
        <li>Hakaret, k√ºf√ºr, iftira veya tehdit i√ßeren payla≈üƒ±mlar</li>
        <li>Nefret s√∂ylemi, ƒ±rk/din/cinsiyet ayrƒ±mcƒ±lƒ±ƒüƒ±</li>
        <li>T√ºrk Ceza Kanunu'na aykƒ±rƒ± her t√ºrl√º i√ßerik</li>
        <li>Telif hakkƒ± ihlali i√ßeren materyal payla≈üƒ±mƒ±</li>
        <li>Spam, reklam veya yanƒ±ltƒ±cƒ± i√ßerik</li>
        <li>Ba≈üka √ºyelerin hesaplarƒ±na yetkisiz eri≈üim giri≈üimi</li>
        <li>Platform g√ºvenliƒüini tehdit eden yazƒ±lƒ±m veya kod payla≈üƒ±mƒ±</li>
      </ul>
      <p>Bu kurallara aykƒ±rƒ± davranƒ±≈ülar tespit edildiƒüinde hesap askƒ±ya alƒ±nƒ±r veya kalƒ±cƒ± olarak kapatƒ±lƒ±r. Su√ß te≈ükil eden i√ßerikler T√ºrk makamlarƒ±yla payla≈üƒ±labilir.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">5. Fƒ∞KRƒ∞ M√úLKƒ∞YET</h3>
      <p>Platform √ºzerindeki logo, tasarƒ±m, yazƒ±lƒ±m ve i√ßerikler Nature.co'ya aittir ve 5846 sayƒ±lƒ± FSEK kapsamƒ±nda korunmaktadƒ±r. √úyelerin payla≈ütƒ±ƒüƒ± i√ßerikler kendilerine ait olmakla birlikte, bu i√ßeriklerin platformda g√∂r√ºnt√ºlenmesi i√ßin Nature.co'ya sƒ±nƒ±rlƒ±, m√ºnhasƒ±r olmayan, √ºcretsiz bir lisans verilmi≈ü sayƒ±lƒ±r. Bu lisans, √ºyeliƒüin sona ermesiyle birlikte otomatik olarak ge√ßerliliƒüini yitirir.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">6. Hƒ∞ZMET DEƒûƒ∞≈ûƒ∞KLƒ∞KLERƒ∞ VE FESƒ∞H</h3>
      <p>Nature.co, platformda deƒüi≈üiklik yapma, hizmeti askƒ±ya alma veya sonlandƒ±rma hakkƒ±nƒ± saklƒ± tutar. √úye, dilediƒüi zaman hesabƒ±nƒ± kapatabilir. S√∂zle≈üme ihlali tespit edildiƒüinde hesap √∂nceden bildirim yapƒ±lmaksƒ±zƒ±n kapatƒ±labilir. <strong style="color:#fff;">6502 sayƒ±lƒ± T√ºketicinin Korunmasƒ± Hakkƒ±nda Kanun</strong> kapsamƒ±ndaki t√ºketici haklarƒ± bu maddeden baƒüƒ±msƒ±z olarak saklƒ±dƒ±r ve hi√ßbir s√∂zle≈üme h√ºkm√º ile kƒ±sƒ±tlanamaz.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">7. SORUMLULUK SINIRLAMASI</h3>
      <p>Nature.co; √ºyeler arasƒ± ileti≈üimden, √º√ß√ºnc√º taraf i√ßeriklerinden, teknik arƒ±zalardan, siber saldƒ±rƒ±lardan veya m√ºcbir sebeplerden doƒüan doƒürudan ya da dolaylƒ± zararlardan sorumlu tutulamaz. Platform "olduƒüu gibi" sunulmakta olup kesintisiz hizmet taahh√ºd√º verilmemektedir. Bu sorumluluk sƒ±nƒ±rlamasƒ±, t√ºketicilerin yasal haklarƒ±nƒ± etkilemez.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">8. VERƒ∞ G√úVENLƒ∞ƒûƒ∞ ƒ∞HLALƒ∞ Bƒ∞LDƒ∞Rƒ∞Mƒ∞</h3>
      <p>Ki≈üisel verilerinizin g√ºvenliƒüini tehdit eden bir ihlal tespit edilmesi h√¢linde Nature.co; 6698 sayƒ±lƒ± KVKK'nƒ±n 12. maddesi ve Ki≈üisel Verileri Koruma Kurulu'nun 2019/10 sayƒ±lƒ± Kararƒ± uyarƒ±nca, ilgili ki≈üileri ve Ki≈üisel Verileri Koruma Kurumu'nu en ge√ß <strong style="color:#fff;">72 saat</strong> i√ßinde bilgilendirmeyi taahh√ºt eder.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">9. UYGULANACAK HUKUK VE YETKƒ∞Lƒ∞ MAHKEME</h3>
      <p>Bu S√∂zle≈üme, T√ºrkiye Cumhuriyeti hukukuna tabidir. Uyu≈ümazlƒ±klarda T√ºrkiye mahkemeleri ve icra daireleri yetkilidir. T√ºketici sƒ±fatƒ±nƒ± haiz √ºyeler, bulunduklarƒ± yerdeki T√ºketici Hakem Heyeti'ne veya T√ºketici Mahkemesi'ne ba≈üvurma haklarƒ±nƒ± saklƒ± tutarlar.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">10. ƒ∞LETƒ∞≈ûƒ∞M</h3>
      <p>Her t√ºrl√º soru, ≈üik√¢yet ve KVKK ba≈üvurularƒ± i√ßin: <strong style="color:#fff;"><a href="/cdn-cgi/l/email-protection#2f464149406f414e5b5a5d4a4c4001424a" style="color:inherit;"><span class="__cf_email__" data-cfemail="90f9fef6ffd0fef1e4e5e2f5f3ffbefdf5">[email&#160;protected]</span></a></strong></p>
    </div>

    <!-- ‚îÄ‚îÄ KVKK SEKMESƒ∞ ‚îÄ‚îÄ -->
    <div id="kvkkTabContent" style="display:none;">
      <h2 style="color:#fff;font-size:17px;margin-bottom:4px;text-align:center;">üîí KVKK AYDINLATMA METNƒ∞</h2>
      <p style="text-align:center;color:#888;font-size:12px;margin-bottom:20px;">6698 Sayƒ±lƒ± Ki≈üisel Verilerin Korunmasƒ± Kanunu Madde 10 Kapsamƒ±nda</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">1. VERƒ∞ SORUMLUSU</h3>
      <p>Ki≈üisel verileriniz, veri sorumlusu sƒ±fatƒ±yla <strong style="color:#fff;">Nature.co</strong> tarafƒ±ndan i≈ülenmektedir. ƒ∞leti≈üim: <strong style="color:#fff;"><a href="/cdn-cgi/l/email-protection#1a73747c755a747b6e6f687f797534777f" style="color:inherit;"><span class="__cf_email__" data-cfemail="b1d8dfd7def1dfd0c5c4c3d4d2de9fdcd4">[email&#160;protected]</span></a></strong></p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">2. ƒ∞≈ûLENEN Kƒ∞≈ûƒ∞SEL VERƒ∞LER VE HUKUKƒ∞ DAYANAK</h3>
      <p><strong style="color:#ddd;">Genel nitelikli ki≈üisel veriler</strong> (KVKK md. 5/2-c ‚Äî s√∂zle≈ümenin ifasƒ±):</p>
      <ul style="margin:6px 0 12px 20px;">
        <li><strong>Kullanƒ±cƒ± adƒ±</strong> ‚Äî Kimlik doƒürulama ve ileti≈üim amacƒ±yla</li>
        <li><strong>E-posta adresi</strong> ‚Äî Hesap g√ºvenliƒüi ve bildirim amacƒ±yla</li>
        <li><strong>≈ûifre √∂zeti (hash)</strong> ‚Äî G√ºvenli kimlik doƒürulama amacƒ±yla</li>
      </ul>
      <p><strong style="color:#e8a020;">√ñzel nitelikli ki≈üisel veri</strong> (KVKK md. 6 ‚Äî k√∂ken/milliyet bilgisi, <em>yalnƒ±zca a√ßƒ±k rƒ±zanƒ±za dayanƒ±larak i≈ülenmektedir</em>):</p>
      <ul style="margin:6px 0 12px 20px;">
        <li><strong>K√∂ken / Milliyet bilgisi</strong> ‚Äî Platform topluluk y√∂netimi amacƒ±yla, Kurul'un √∂ng√∂rd√ºƒü√º yeterli g√ºvenlik tedbirleri alƒ±narak i≈ülenmektedir</li>
      </ul>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">3. VERƒ∞LERƒ∞N AKTARIMI</h3>
      <p>Ki≈üisel verileriniz; yurt i√ßinde veya yurt dƒ±≈üƒ±nda herhangi bir √º√ß√ºnc√º ki≈üiye, ≈üirkete veya kuruma a√ßƒ±k rƒ±zanƒ±z olmaksƒ±zƒ±n aktarƒ±lmaz. Yalnƒ±zca yasal zorunluluk h√¢linde yetkili kamu kurumlarƒ±yla payla≈üƒ±labilir.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">4. VERƒ∞LERƒ∞N SAKLANMA S√úRESƒ∞</h3>
      <p>Ki≈üisel verileriniz, √ºyeliƒüinizin aktif olduƒüu s√ºre boyunca saklanƒ±r. √úyeliƒüin sona ermesi veya hesabƒ±n silinmesi h√¢linde verileriniz, yasal saklama y√ºk√ºml√ºl√ºkleri saklƒ± kalmak kaydƒ±yla en ge√ß <strong style="color:#fff;">30 g√ºn</strong> i√ßinde sistemden silinir veya anonim h√¢le getirilir.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">5. G√úVENLƒ∞K TEDBƒ∞RLERƒ∞</h3>
      <p>Verilerinizin korunmasƒ± i√ßin a≈üaƒüƒ±daki teknik ve idari tedbirler alƒ±nmaktadƒ±r:</p>
      <ul style="margin:6px 0 12px 20px;">
        <li>≈ûifreler kriptografik hash fonksiyonuyla saklanmakta, a√ßƒ±k metin olarak tutulmamaktadƒ±r</li>
        <li>Veriler g√ºvenli Firebase altyapƒ±sƒ±nda barƒ±ndƒ±rƒ±lmaktadƒ±r</li>
        <li>Platforma eri≈üimler kayƒ±t altƒ±na alƒ±nmaktadƒ±r</li>
        <li>G√ºvenlik ihlali tespitinde 72 saat i√ßinde bildirim yapƒ±lmaktadƒ±r</li>
      </ul>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">6. ƒ∞LGƒ∞Lƒ∞ Kƒ∞≈ûƒ∞Nƒ∞N HAKLARI (KVKK MD. 11)</h3>
      <p>KVKK'nƒ±n 11. maddesi kapsamƒ±nda a≈üaƒüƒ±daki haklara sahipsiniz:</p>
      <ul style="margin:6px 0 12px 20px;">
        <li>Ki≈üisel verilerinizin i≈ülenip i≈ülenmediƒüini √∂ƒürenme</li>
        <li>ƒ∞≈ülenmi≈üse buna ili≈ükin bilgi talep etme</li>
        <li>Verilerin i≈ülenme amacƒ±nƒ± ve amaca uygun kullanƒ±lƒ±p kullanƒ±lmadƒ±ƒüƒ±nƒ± √∂ƒürenme</li>
        <li>Yurt i√ßinde veya yurt dƒ±≈üƒ±nda aktarƒ±ldƒ±ƒüƒ± √º√ß√ºnc√º ki≈üileri bilme</li>
        <li>Verilerin eksik veya yanlƒ±≈ü i≈ülenmesi h√¢linde d√ºzeltilmesini isteme</li>
        <li>KVKK'nƒ±n 7. maddesi kapsamƒ±nda silinmesini veya yok edilmesini isteme</li>
        <li>D√ºzeltme ve silme i≈ülemlerinin √º√ß√ºnc√º ki≈üilere bildirilmesini talep etme</li>
        <li>M√ºnhasƒ±ran otomatik sistemler ile analiz edilmesi sonucu aleyhinize bir sonucun ortaya √ßƒ±kmasƒ±na itiraz etme</li>
        <li>Kanuna aykƒ±rƒ± i≈üleme nedeniyle zarara uƒüramanƒ±z h√¢linde zararƒ±n giderilmesini talep etme</li>
      </ul>
      <p>Bu haklarƒ±nƒ±zƒ± kullanmak i√ßin <strong style="color:#fff;"><a href="/cdn-cgi/l/email-protection#3b52555d547b555a4f4e495e585415565e" style="color:inherit;"><span class="__cf_email__" data-cfemail="f891969e97b896998c8d8a9d9b97d6959d">[email&#160;protected]</span></a></strong> adresine yazƒ±lƒ± olarak ba≈üvurabilirsiniz. Ba≈üvurularƒ±nƒ±z en ge√ß <strong style="color:#fff;">30 g√ºn</strong> i√ßinde sonu√ßlandƒ±rƒ±lƒ±r.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">7. KVKK KURUMU'NA ≈ûƒ∞K√ÇYET HAKKI</h3>
      <p>Ba≈üvurunuzun reddedilmesi, verilen yanƒ±tƒ± yetersiz bulmanƒ±z veya s√ºresinde yanƒ±t alamamanƒ±z h√¢linde <strong style="color:#fff;">Ki≈üisel Verileri Koruma Kurumu'na (kvkk.gov.tr)</strong> ≈üik√¢yette bulunma hakkƒ±nƒ±z mevcuttur.</p>

      <h3 style="color:#e8e8e8;font-size:14px;margin-top:20px;">8. √áEREZLER (COOKIE)</h3>
      <p>Platform, oturum y√∂netimi amacƒ±yla yalnƒ±zca zorunlu yerel depolama (localStorage) kullanmaktadƒ±r. Pazarlama veya takip ama√ßlƒ± √ßerez kullanƒ±lmamaktadƒ±r.</p>
    </div>

    <div style="margin-top:28px;text-align:center;">
      <button onclick="document.getElementById('tosModal').style.display='none'"
        style="background:#5b9bd5;border:none;border-radius:100px;color:#fff;font-size:14px;font-weight:700;padding:10px 32px;cursor:pointer;">
        ‚úì Okudum, Kapat
      </button>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   YENƒ∞ √ñZELLƒ∞KLER ‚Äî T√ºm aray√ºz iyile≈ütirmeleri
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ 1. TEMA SMOOTH TRANSƒ∞Tƒ∞ON ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ 2. HOVER ZAMAN DAMGASI TOOLTIP ‚îÄ‚îÄ */
(function(){
  // renderMsgs √ßaƒürƒ±ldƒ±ktan sonra tooltipleri ekle
  const origRender = window.renderMsgs;
  if(origRender) window.renderMsgs = function(msgsObj, clearedAt){
    origRender(msgsObj, clearedAt);
    _addTimestampTooltips();
  };
  function _addTimestampTooltips(){
    const box = document.getElementById('chatMsgs');
    if(!box) return;
    box.querySelectorAll('.mb[data-ts]').forEach(mb=>{
      if(mb.querySelector('.msg-hover-tooltip')) return;
      const ts = parseInt(mb.dataset.ts);
      if(!ts) return;
      const d = new Date(ts);
      const day = d.toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'});
      const time = d.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
      const tip = document.createElement('div');
      tip.className = 'msg-hover-tooltip';
      tip.textContent = `${day} ¬∑ ${time}`;
      mb.appendChild(tip);
    });
  }
  window._addTimestampTooltips = _addTimestampTooltips;
  // data-ts attribute'u own olmayan mesajlara da ekle
  const origRender2 = window.renderMsgs;
  if(origRender2) {
    const _patchedRender = origRender2;
    window.renderMsgs = function(msgsObj, clearedAt){
      _patchedRender(msgsObj, clearedAt);
      // Own olmayan mesajlara da ts ekle
      const box = document.getElementById('chatMsgs');
      if(box && msgsObj){
        const msgs = Object.entries(msgsObj).map(([k,v])=>({...v,_key:k}));
        msgs.forEach(m=>{
          const el = box.querySelector(`.mb[data-key="${m._key}"]`);
          if(el && !el.dataset.ts) el.dataset.ts = m.ts;
        });
        _addTimestampTooltips();
      }
    };
  }
})();

/* ‚îÄ‚îÄ 3. MESAJ POP ANƒ∞MASYONU ‚îÄ‚îÄ */
(function(){
  const origAppend = window.appendMsg;
  // renderMsgs sonrasƒ± son mesaja pop animasyonu ekle
  const origRenderMsgs = window.renderMsgs;
  if(origRenderMsgs){
    window.renderMsgs = function(msgsObj, clearedAt){
      const box = document.getElementById('chatMsgs');
      const prevCount = box ? box.querySelectorAll('.mb').length : 0;
      origRenderMsgs(msgsObj, clearedAt);
      if(box){
        const newMsgs = box.querySelectorAll('.mb');
        const newCount = newMsgs.length;
        if(newCount > prevCount){
          // Sadece yeni gelen mesaja animasyon
          for(let i = newCount - (newCount - prevCount); i < newCount; i++){
            if(newMsgs[i]){
              newMsgs[i].classList.add('pop-in');
              setTimeout(()=>newMsgs[i].classList.remove('pop-in'), 400);
            }
          }
        }
      }
    };
  }
})();

/* ‚îÄ‚îÄ 4. SCROLL-TO-BOTTOM BUTONU ‚îÄ‚îÄ */
(function(){
  let _unreadCount = 0;
  function _initScrollBtn(){
    const chatMsgs = document.getElementById('chatMsgs');
    const btn = document.getElementById('scrollToBottomBtn');
    if(!chatMsgs || !btn) return;
    chatMsgs.addEventListener('scroll', ()=>{
      const atBot = chatMsgs.scrollHeight - chatMsgs.scrollTop - chatMsgs.clientHeight < 60;
      btn.classList.toggle('visible', !atBot);
      if(atBot){ _unreadCount = 0; btn.classList.remove('has-unread'); }
    });
  }
  window.scrollToBottomSmooth = function(){
    const b = document.getElementById('chatMsgs');
    if(b){ b.scrollTo({top:b.scrollHeight, behavior:'smooth'}); }
    _unreadCount = 0;
    const btn = document.getElementById('scrollToBottomBtn');
    if(btn) btn.classList.remove('has-unread','visible');
  };
  // Sayfa hazƒ±r olduƒüunda init et
  document.addEventListener('DOMContentLoaded', _initScrollBtn);
  setTimeout(_initScrollBtn, 1500);
  // Oda deƒüi≈üince yeniden init
  const origOpenRoom = window.openRoom;
  if(origOpenRoom) window.openRoom = function(...args){
    origOpenRoom(...args);
    setTimeout(_initScrollBtn, 500);
  };
})();

/* ‚îÄ‚îÄ 5. S√úR√úKLE-BIRAK DOSYA ‚îÄ‚îÄ */
(function(){
  function _attachDrag(container, overlay, inputId){
    if(!container || !overlay) return;
    let dragCount = 0;
    container.addEventListener('dragenter', e=>{
      if(!e.dataTransfer?.types?.includes('Files')) return;
      e.preventDefault(); dragCount++;
      overlay.classList.add('active');
    });
    container.addEventListener('dragleave', e=>{
      dragCount--;
      if(dragCount<=0){ dragCount=0; overlay.classList.remove('active'); }
    });
    container.addEventListener('dragover', e=>{ if(e.dataTransfer?.types?.includes('Files')) e.preventDefault(); });
    container.addEventListener('drop', e=>{
      if(!e.dataTransfer?.types?.includes('Files')) return;
      e.preventDefault(); dragCount=0;
      overlay.classList.remove('active');
      const files = e.dataTransfer.files;
      if(files && files[0]){
        const fakeInput = document.getElementById(inputId);
        if(fakeInput){
          const dt = new DataTransfer();
          dt.items.add(files[0]);
          fakeInput.files = dt.files;
          fakeInput.dispatchEvent(new Event('change'));
        }
      }
    });
    overlay.addEventListener('click', ()=>overlay.classList.remove('active'));
  }
  function _initDrop(){
    // Mobil chat screen
    const mobileScreen = document.getElementById('chatScreen');
    const mobileOverlay = document.getElementById('dropOverlay');
    _attachDrag(mobileScreen, mobileOverlay, 'fileInput');
    // Desktop chat area ‚Äî ayrƒ± overlay kullan
    const deskArea = document.getElementById('deskChatArea');
    const deskOverlay = document.getElementById('deskDropOverlay');
    _attachDrag(deskArea, deskOverlay, 'fileInput');
  }
  document.addEventListener('DOMContentLoaded', _initDrop);
  setTimeout(_initDrop, 1500);
})();

/* ‚îÄ‚îÄ 6. SWIPE-TO-REPLY (Mobil) ‚îÄ‚îÄ */
(function(){
  let _swipeStartX = null, _swipeEl = null, _swipeTriggered = false;

  function _onTouchStart(e){
    if(e.touches.length !== 1) return;
    const mb = e.target.closest('.mb');
    if(!mb) return;
    _swipeStartX = e.touches[0].clientX;
    _swipeEl = mb;
    _swipeTriggered = false;
  }
  function _onTouchMove(e){
    if(!_swipeEl || _swipeStartX===null) return;
    const dx = e.touches[0].clientX - _swipeStartX;
    if(dx > 0 && !_swipeEl.classList.contains('own')){
      // Sola yaslanmƒ±≈ü mesaj - saƒüa kaydƒ±rma
      if(!_swipeEl.querySelector('.swipe-reply-hint')){
        const h = document.createElement('div');
        h.className = 'swipe-reply-hint'; h.textContent = '‚Ü©';
        _swipeEl.appendChild(h);
      }
      if(dx > 40 && !_swipeTriggered){
        _swipeTriggered = true;
        _swipeEl.classList.add('swiping-right');
        if(navigator.vibrate) navigator.vibrate(30);
      }
    }
  }
  function _onTouchEnd(){
    if(_swipeEl && _swipeTriggered){
      // Reply modunu tetikle
      const key = _swipeEl.dataset.key;
      const room = window._cRoom;
      if(key && room && window.replyToMsg) window.replyToMsg(room, key);
      setTimeout(()=>{
        if(_swipeEl) _swipeEl.classList.remove('swiping-right');
        _swipeEl = null; _swipeStartX = null; _swipeTriggered = false;
      }, 300);
    } else {
      if(_swipeEl) _swipeEl.classList.remove('swiping-right');
      _swipeEl = null; _swipeStartX = null; _swipeTriggered = false;
    }
  }

  document.addEventListener('touchstart', _onTouchStart, {passive:true});
  document.addEventListener('touchmove', _onTouchMove, {passive:true});
  document.addEventListener('touchend', _onTouchEnd);
})();

/* ‚îÄ‚îÄ 7. TAB BADGE POP ANƒ∞MASYONU ‚îÄ‚îÄ */
(function(){
  function _popBadge(el){
    if(!el) return;
    el.classList.remove('badge-pop');
    void el.offsetWidth;
    el.classList.add('badge-pop');
    setTimeout(()=>el.classList.remove('badge-pop'), 450);
  }
  // unread badge g√ºncellemelerini izle
  const origUpdateBadge = window.updateUnreadBadge;
  if(origUpdateBadge){
    window.updateUnreadBadge = function(roomId, count){
      origUpdateBadge(roomId, count);
      setTimeout(()=>{
        // Mobil badge
        document.querySelectorAll('.ubadge').forEach(b=>{ if(parseInt(b.textContent)>0) _popBadge(b); });
        // Desktop badge
        document.querySelectorAll('.dsk-row-badge').forEach(b=>{ if(parseInt(b.textContent)>0) _popBadge(b); });
      }, 50);
    };
  }
  // updateRoomBadge'ƒ± da izle (doƒürudan √ßaƒürƒ±lanlar i√ßin)
  const origRoomBadge = window.updateRoomBadge;
  if(origRoomBadge){
    window.updateRoomBadge = function(roomId, count){
      origRoomBadge(roomId, count);
      setTimeout(()=>{
        document.querySelectorAll('.ubadge, .dsk-row-badge').forEach(b=>{ if(parseInt(b.textContent)>0) _popBadge(b); });
      }, 50);
    };
  }
  window._popBadge = _popBadge;
})();

/* ‚îÄ‚îÄ 8. TEPKƒ∞ BOUNCE + G√ñNDER SQUISH ‚îÄ‚îÄ */
(function(){
  // Tepki pill tƒ±klamasƒ± (mevcut tepkiler)
  document.addEventListener('click', e=>{
    const pill = e.target.closest('.react-pill');
    if(pill){
      pill.classList.remove('bouncing');
      void pill.offsetWidth;
      pill.classList.add('bouncing');
      setTimeout(()=>pill.classList.remove('bouncing'), 400);
    }
    // Hƒ±zlƒ± emoji butonu bounce (√ºst emoji bar)
    const qs = e.target.closest('.mb-react-quick span');
    if(qs){
      qs.classList.remove('emoji-bounce');
      void qs.offsetWidth;
      qs.classList.add('emoji-bounce');
      setTimeout(()=>qs.classList.remove('emoji-bounce'), 400);
    }
  });
  // G√∂nder butonu squish ‚Äî mobil + masa√ºst√º
  function _squishSendBtn(){
    ['sendBtn','deskSendBtn'].forEach(id=>{
      const btn = document.getElementById(id);
      if(btn){ btn.classList.add('squish'); setTimeout(()=>btn.classList.remove('squish'),300); }
    });
  }
  const origSend = window.sendMsg;
  if(origSend){
    window.sendMsg = function(...args){
      _squishSendBtn();
      return origSend(...args);
    };
  }
  const origDeskSend = window.sendDeskMsg;
  if(origDeskSend){
    window.sendDeskMsg = function(...args){
      _squishSendBtn();
      return origDeskSend(...args);
    };
  }
})();

/* ‚îÄ‚îÄ 9. Sƒ∞LME SESƒ∞ ‚îÄ‚îÄ */
function playDeleteSound(){
  try{
    const ctx = getAudioCtx();
    if(!ctx) return;
    const t = ctx.currentTime;
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.6, t);
    g.gain.exponentialRampToValueAtTime(0.001, t+0.3);
    g.connect(ctx.destination);
    // Hafif inen ton
    const osc = ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(400, t);
    osc.frequency.exponentialRampToValueAtTime(200, t+0.25);
    osc.connect(g);
    osc.start(t); osc.stop(t+0.3);
    // Kƒ±sa tƒ±k
    const osc2 = ctx.createOscillator();
    const g2 = ctx.createGain();
    osc2.type = 'triangle';
    osc2.frequency.value = 800;
    g2.gain.setValueAtTime(0.3, t); g2.gain.exponentialRampToValueAtTime(0.001, t+0.06);
    osc2.connect(g2); g2.connect(ctx.destination);
    osc2.start(t); osc2.stop(t+0.07);
  }catch(e){}
}

/* ‚îÄ‚îÄ 10. Bƒ∞LDƒ∞Rƒ∞M SESƒ∞ ƒ∞Yƒ∞LE≈ûTƒ∞RME ‚Äî artƒ±k ana NOTIF_TONES i√ßinde ‚îÄ‚îÄ */

/* ‚îÄ‚îÄ 11. Sƒ∞LME - Flash Animasyonu ‚îÄ‚îÄ */
(function(){
  const orig = window.deleteMsg;
  if(orig){
    window.deleteMsg = function(roomId, key){
      // Flash animasyonu
      const el = document.querySelector(`.mb[data-key="${key}"]`);
      if(el){ el.classList.add('deleting'); setTimeout(()=>el.classList.remove('deleting'),450); }
      // Ses √ßal
      playDeleteSound();
      orig(roomId, key);
    };
  }
})();

/* ‚îÄ‚îÄ 12. SOHBET ARKA PLAN DESENƒ∞ ‚îÄ‚îÄ */
(function(){
  const BG_KEY = 'sohbet_chat_bg';
  const opts = [
    {id:'none',  label:'Yok'},
    {id:'dots',  label:'Nokta'},
    {id:'grid',  label:'Izgara'},
    {id:'cross', label:'Daire'},
  ];
  function applyBg(id){
    const el = document.getElementById('chatMsgs');
    if(el){ el.dataset.bg = id==='none'?'':id; }
    // Masa√ºst√º i√ßin de uygula
    const deskEl = document.getElementById('deskMsgs');
    if(deskEl){ deskEl.dataset.bg = id==='none'?'':id; }
    localStorage.setItem(BG_KEY, id);
  }
  function getChatBg(){ return localStorage.getItem(BG_KEY)||'none'; }
  window.getChatBg = getChatBg;
  window.applyBg = applyBg;
  // Sayfa a√ßƒ±lƒ±≈üƒ±nda uygula
  setTimeout(()=>applyBg(getChatBg()), 800);
  // Profile G√∂r√ºn√ºm tabƒ±na arka plan se√ßici ekle
  const origSwitch = window.switchProfTab;
  if(origSwitch){
    window.switchProfTab = function(tab){
      origSwitch(tab);
      if(tab==='appearance'){
        setTimeout(_renderBgPicker, 50);
      }
    };
  }
  function _renderBgPicker(){
    const container = document.getElementById('themeGrid')?.parentElement;
    if(!container) return;
    if(container.querySelector('#chatBgPicker')) return;
    const cur = getChatBg();
    const wrap = document.createElement('div');
    wrap.style.cssText='margin-top:18px;';
    wrap.innerHTML=`
      <div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;padding:0 2px 10px;">üí¨ Sohbet Arka Planƒ±</div>
      <div id="chatBgPicker" style="display:flex;gap:8px;flex-wrap:wrap;">
        ${opts.map(o=>`
          <div onclick="applyBg('${o.id}');document.querySelectorAll('.bg-opt').forEach(e=>e.style.borderColor='transparent');this.style.borderColor='var(--accent)';"
            class="bg-opt" style="
            flex:1;min-width:60px;padding:10px 6px;text-align:center;border-radius:10px;
            background:var(--surface);border:2px solid ${cur===o.id?'var(--accent)':'transparent'};
            cursor:pointer;font-size:.75rem;font-weight:700;color:var(--text-hi);
            transition:border-color .15s;">
            ${o.label}
          </div>`).join('')}
      </div>`;
    container.appendChild(wrap);
  }
})();

/* ‚îÄ‚îÄ 13. PROFƒ∞L SAYFASI ‚Äî kullanƒ±cƒ± adƒ± label ‚îÄ‚îÄ */
(function(){
  const origLoadBio = window.loadBio;
  if(origLoadBio){
    window.loadBio = function(){
      origLoadBio();
      // handle label g√ºncelle
      const hl = document.getElementById('profHandleLabel');
      if(hl && window._cu) hl.textContent = '@' + _cu;
    };
  }
  // Banner rengini profil a√ßƒ±lƒ±≈üƒ±nda ayarla
  const origOpenProfile = window.openProfile;
  if(origOpenProfile){
    window.openProfile = function(){
      origOpenProfile();
      setTimeout(()=>{
        const banner = document.getElementById('profBanner');
        const hl = document.getElementById('profHandleLabel');
        if(banner && window._cu) banner.style.background = `linear-gradient(135deg, ${strColor(_cu)}aa 0%, var(--bg2) 100%)`;
        if(hl && window._cu) hl.textContent = '@' + _cu;
      }, 100);
    };
  }
})();

/* ‚îÄ‚îÄ 14. DESKTop SOHBET SCROLL BUTONU ‚îÄ‚îÄ */
(function(){
  function _initDeskScroll(){
    const deskMsgs = document.getElementById('deskMsgs'); // D√ºzeltildi: deskChatMsgs ‚Üí deskMsgs
    const btn = document.getElementById('deskScrollToBottomBtn');
    if(!deskMsgs || !btn) return;
    deskMsgs.addEventListener('scroll', ()=>{
      const atBot = deskMsgs.scrollHeight - deskMsgs.scrollTop - deskMsgs.clientHeight < 60;
      btn.classList.toggle('visible', !atBot);
    });
  }
  window.deskScrollToBottom = function(){
    const b = document.getElementById('deskMsgs');
    if(b) b.scrollTo({top:b.scrollHeight, behavior:'smooth'});
    const btn = document.getElementById('deskScrollToBottomBtn');
    if(btn) btn.classList.remove('has-unread', 'visible');
  };
  setTimeout(_initDeskScroll, 1500);
  // Oda a√ßƒ±lƒ±nca yeniden init
  const origDeskOpen = window.deskOpenRoom;
  if(origDeskOpen) window.deskOpenRoom = function(...args){
    origDeskOpen(...args);
    setTimeout(_initDeskScroll, 500);
  };
})();




/* ‚îÄ‚îÄ Kanal √ñnizleme Popup Konumlama ‚îÄ‚îÄ */
(function(){
  document.addEventListener('mouseover', function(e){
    const row = e.target.closest('.dsk-row, .r-row');
    if(!row) return;
    const popup = row.querySelector('.room-preview-popup');
    if(!popup) return;
    const rect = row.getBoundingClientRect();
    popup.style.top = Math.min(rect.top, window.innerHeight - 120) + 'px';
    popup.style.left = (rect.right + 8) + 'px';
    popup.style.transform = 'none';
  });
})();

/* ‚îÄ‚îÄ Pull-to-Refresh ‚îÄ‚îÄ */
(function(){
  let _ptrY0=null, _ptrPulling=false;
  const THRESH=60;

  function _ptrStart(e){
    const list=document.getElementById('roomsList');
    if(!list||list.scrollTop>0) return; // sadece en tepedeyken
    _ptrY0=e.touches?e.touches[0].clientY:e.clientY;
  }
  function _ptrMove(e){
    if(_ptrY0===null) return;
    const y=e.touches?e.touches[0].clientY:e.clientY;
    const dy=y-_ptrY0;
    if(dy<0){_ptrY0=null;return;}
    const list=document.getElementById('roomsList');
    const ind=document.getElementById('ptr-indicator');
    if(!_ptrPulling && dy>20){
      _ptrPulling=true;
      if(ind){ind.classList.add('ptr-visible');}
      if(list){list.style.transform='translateY(46px)';}
    }
  }
  function _ptrEnd(){
    if(!_ptrPulling){_ptrY0=null;return;}
    const ind=document.getElementById('ptr-indicator');
    const list=document.getElementById('roomsList');
    if(ind){ind.classList.add('ptr-spinning');}
    // Firebase'den yenile
    if(typeof loadRooms==='function') loadRooms();
    setTimeout(()=>{
      if(ind){ind.classList.remove('ptr-visible','ptr-spinning');}
      if(list){list.style.transform='';}
      _ptrPulling=false; _ptrY0=null;
    },1200);
  }

  const screen=document.getElementById('roomsScreen');
  if(screen){
    screen.addEventListener('touchstart',_ptrStart,{passive:true});
    screen.addEventListener('touchmove',_ptrMove,{passive:true});
    screen.addEventListener('touchend',_ptrEnd);
  }
})();

/* ‚îÄ‚îÄ Online Flip Saya√ß G√ºncelle ‚îÄ‚îÄ */
function _updateHdrOnlineFlip(newCount){
  const el = document.getElementById('hdrOnlineCount');
  if(!el) return;
  const oldCount = parseInt(el.textContent)||0;
  if(oldCount === newCount) return;
  // Flip animasyonu
  el.style.transition = 'none';
  el.style.transform = 'translateY(0)';
  el.style.opacity = '1';
  el.style.display = 'inline-block';
  el.animate([
    {transform:'translateY(0)',opacity:1},
    {transform:'translateY(-8px)',opacity:0}
  ],{duration:150,easing:'ease-in',fill:'forwards'}).onfinish = () => {
    el.textContent = newCount + ' √ßevrimi√ßi';
    el.animate([
      {transform:'translateY(8px)',opacity:0},
      {transform:'translateY(0)',opacity:1}
    ],{duration:200,easing:'cubic-bezier(.34,1.56,.64,1)',fill:'forwards'});
  };
}
</script>

<!-- ‚ïê‚ïê EVRENSEL ARAMA MODAL ‚ïê‚ïê -->
<div id="globalSearchModal" onclick="if(event.target===this)closeGlobalSearch()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:8000;align-items:flex-start;justify-content:center;padding:60px 16px 16px;backdrop-filter:blur(8px);">
  <div style="background:var(--bg2);border-radius:18px;width:100%;max-width:520px;box-shadow:0 20px 60px rgba(0,0,0,.6);overflow:hidden;animation:searchSlideIn .2s ease;">
    <style>@keyframes searchSlideIn{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}</style>
    <div style="display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border);">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="globalSearchInp" placeholder="Kullanƒ±cƒ±, oda veya forum ara..." autocorrect="off" autocapitalize="none" oninput="runGlobalSearch(this.value)"
        style="flex:1;background:transparent;border:none;outline:none;color:var(--text-hi);font-size:.95rem;font-family:inherit;">
      <div onclick="closeGlobalSearch()" style="cursor:pointer;color:var(--muted);font-size:.8rem;background:var(--surface);border-radius:6px;padding:3px 8px;font-weight:700;">ESC</div>
    </div>
    <div style="display:flex;gap:6px;padding:10px 16px 6px;">
      <button class="gs-filter-btn gs-filter-act" onclick="setGsFilter('all',this)">T√ºm√º</button>
      <button class="gs-filter-btn" onclick="setGsFilter('users',this)">üë§ Ki≈üiler</button>
      <button class="gs-filter-btn" onclick="setGsFilter('rooms',this)">üè† Odalar</button>
      <button class="gs-filter-btn" onclick="setGsFilter('forum',this)">üìã Forum</button>
    </div>
    <div id="globalSearchResults" style="max-height:360px;overflow-y:auto;padding:6px 8px 12px;">
      <div style="text-align:center;padding:32px;color:var(--muted);font-size:.85rem;">Aramaya ba≈ülayƒ±n...</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê Bƒ∞LDƒ∞Rƒ∞M MERKEZƒ∞ MODAL ‚ïê‚ïê -->
<div id="notifCenterModal" onclick="if(event.target===this)closeNotifCenter()" style="display:none;position:fixed;inset:0;background:transparent;z-index:8000;align-items:flex-start;justify-content:flex-start;">
  <div id="notifCenterPanel" style="background:var(--bg2);border-radius:16px;width:360px;max-width:calc(100vw - 20px);box-shadow:0 16px 48px rgba(0,0,0,.5);overflow:hidden;animation:notifSlideIn .2s ease;position:absolute;">
    <style>
      @keyframes notifSlideIn{from{opacity:0;transform:translateX(12px)}to{opacity:1;transform:translateX(0)}}
      .gs-filter-btn{background:var(--surface);border:1px solid var(--border);color:var(--muted);font-family:inherit;font-size:.75rem;font-weight:700;padding:5px 12px;border-radius:100px;cursor:pointer;transition:all .15s;}
      .gs-filter-btn:hover,.gs-filter-btn.gs-filter-act{background:var(--accent);border-color:var(--accent);color:#fff;}
      .gs-result-item{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:10px;cursor:pointer;transition:background .12s;}
      .gs-result-item:hover{background:var(--surface);}
      .gs-result-av{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:700;color:#fff;flex-shrink:0;}
      .gs-result-info{flex:1;min-width:0;}
      .gs-result-name{font-size:.85rem;font-weight:700;color:var(--text-hi);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
      .gs-result-sub{font-size:.7rem;color:var(--muted);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
      .gs-chip{font-size:.62rem;font-weight:700;padding:2px 8px;border-radius:100px;flex-shrink:0;}
      .gs-section-title{font-size:.65rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;padding:8px 10px 4px;}
      .nc-item{display:flex;align-items:flex-start;gap:10px;padding:12px 14px;cursor:pointer;transition:background .12s;border-bottom:1px solid var(--border);}
      .nc-item:hover{background:var(--surface);}
      .nc-item.unread{background:rgba(91,155,213,.06);}
      .nc-icon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;}
      .nc-text{flex:1;min-width:0;}
      .nc-title{font-size:.78rem;font-weight:700;color:var(--text-hi);margin-bottom:2px;}
      .nc-sub{font-size:.7rem;color:var(--muted);line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
      .nc-time{font-size:.62rem;color:var(--muted);white-space:nowrap;flex-shrink:0;}
      .nc-unread-dot{width:7px;height:7px;background:var(--accent);border-radius:50%;flex-shrink:0;margin-top:5px;}
    </style>
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);">
      <div style="font-size:.9rem;font-weight:900;color:var(--text-hi);display:flex;align-items:center;gap:6px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        Bildirimler
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span id="ncUnreadCount" style="background:var(--red);color:#fff;font-size:.62rem;font-weight:900;border-radius:100px;padding:1px 7px;display:none;">0</span>
        <span onclick="markAllNotifsRead()" style="font-size:.72rem;color:var(--accent);cursor:pointer;font-weight:700;">T√ºm√ºn√º Oku</span>
        <span onclick="closeNotifCenter()" style="color:var(--muted);cursor:pointer;font-size:1.1rem;line-height:1;">‚úï</span>
      </div>
    </div>
    <div id="notifCenterList" style="max-height:420px;overflow-y:auto;">
      <div style="text-align:center;padding:32px;color:var(--muted);font-size:.85rem;">Bildirim yok</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê NATUREBOT ROBOT MASKOTU v3 ‚ïê‚ïê -->
<script>
(function() {
'use strict';

const IS_MOBILE = () => window.innerWidth < 768;

/* ‚ïê‚ïê CSS ‚ïê‚ïê */
const BOT_CSS = `
#natureBotPet {
  position: fixed;
  z-index: 9997;
  width: 60px;
  height: 96px;
  cursor: pointer;
  user-select: none;
  touch-action: none;
  filter: drop-shadow(0 4px 16px rgba(74,143,64,.4));
  transition: filter .3s;
  will-change: transform;
}
#natureBotPet:hover { filter: drop-shadow(0 6px 24px rgba(74,143,64,.7)); }
#natureBotPet.calling { filter: drop-shadow(0 0 30px rgba(91,155,213,.9)); }

/* Mobil: robot header slotunda */
@media (max-width: 767px) {
  #natureBotPet {
    position: relative !important;
    right: auto !important;
    top: auto !important;
    left: auto !important;
    width: 40px !important;
    height: 44px !important;
    overflow: hidden !important;
  }
}

/* ‚îÄ‚îÄ G√∂vde y√ºzen hareket ‚îÄ‚îÄ */
#natureBotPet .bot-body-group {
  animation: botHover 3.2s ease-in-out infinite;
  transform-origin: 32px 40px;
}
@keyframes botHover {
  0%,100% { transform: translateY(0px); }
  50% { transform: translateY(-4px); }
}
#natureBotPet.talking .bot-body-group {
  animation: botTalk 0.35s ease-in-out infinite alternate;
}
@keyframes botTalk {
  from { transform: translateY(0px) scale(1); }
  to   { transform: translateY(-3px) scale(1.03); }
}
#natureBotPet.at-home .bot-body-group {
  animation: botHoverSlow 5s ease-in-out infinite;
}
@keyframes botHoverSlow {
  0%,100% { transform: translateY(0px); }
  50% { transform: translateY(-2px); }
}
#natureBotPet.calling .bot-body-group {
  animation: botPulse .55s ease-in-out infinite alternate;
}
@keyframes botPulse {
  from { transform: scale(1); }
  to   { transform: scale(1.09); }
}

/* ‚îÄ‚îÄ Sol kol sallama ‚îÄ‚îÄ */
#natureBotPet .bot-arm-left {
  transform-origin: 2px 40px;
  animation: armSwingLeft 1.6s ease-in-out infinite;
}
@keyframes armSwingLeft {
  0%,100% { transform: rotate(0deg); }
  30% { transform: rotate(-22deg); }
  60% { transform: rotate(8deg); }
}

/* ‚îÄ‚îÄ Saƒü kol sallama ‚îÄ‚îÄ */
#natureBotPet .bot-arm-right {
  transform-origin: 62px 40px;
  animation: armSwingRight 1.6s ease-in-out infinite;
  animation-delay: -0.8s;
}
@keyframes armSwingRight {
  0%,100% { transform: rotate(0deg); }
  30% { transform: rotate(22deg); }
  60% { transform: rotate(-8deg); }
}

/* ‚îÄ‚îÄ Sol bacak y√ºr√ºy√º≈ü ‚îÄ‚îÄ */
#natureBotPet .bot-leg-left {
  transform-origin: 24px 78px;
  animation: legWalkLeft 1.6s ease-in-out infinite;
}
@keyframes legWalkLeft {
  0%,100% { transform: rotate(0deg) translateY(0px); }
  25% { transform: rotate(-12deg) translateY(-2px); }
  75% { transform: rotate(10deg) translateY(1px); }
}

/* ‚îÄ‚îÄ Saƒü bacak y√ºr√ºy√º≈ü ‚îÄ‚îÄ */
#natureBotPet .bot-leg-right {
  transform-origin: 40px 78px;
  animation: legWalkRight 1.6s ease-in-out infinite;
  animation-delay: -0.8s;
}
@keyframes legWalkRight {
  0%,100% { transform: rotate(0deg) translateY(0px); }
  25% { transform: rotate(12deg) translateY(-2px); }
  75% { transform: rotate(-10deg) translateY(1px); }
}

/* Durduƒüunda (at-home) bacak/kol daha sakin */
/* ‚îÄ‚îÄ UYKU animasyonlarƒ± ‚îÄ‚îÄ */
#natureBotPet.sleeping {
  filter: drop-shadow(0 2px 8px rgba(74,143,64,.2));
}
#natureBotPet.sleeping .bot-body-group {
  animation: botSleep 3s ease-in-out infinite;
  transform-origin: center bottom;
}
@keyframes botSleep {
  0%,100% { transform: translateY(0) rotate(-8deg) scale(0.9); }
  50%      { transform: translateY(3px) rotate(-8deg) scale(0.88); }
}
#natureBotPet.sleeping .bot-arm-left  { animation: armSleepL 3s ease-in-out infinite; }
#natureBotPet.sleeping .bot-arm-right { animation: armSleepR 3s ease-in-out infinite; }
@keyframes armSleepL { 0%,100%{transform:rotate(40deg)} 50%{transform:rotate(35deg)} }
@keyframes armSleepR { 0%,100%{transform:rotate(-40deg)} 50%{transform:rotate(-35deg)} }
#natureBotPet.sleeping .bot-leg-left,
#natureBotPet.sleeping .bot-leg-right { animation: none; transform: rotate(0deg); }
#natureBotPet.sleeping .bot-eye-glow  { animation: none; opacity: 0.05; }
#natureBotPet.sleeping .bot-antenna-light { animation: sleepAntenna 3s ease-in-out infinite; }
@keyframes sleepAntenna { 0%,100%{opacity:.15} 50%{opacity:.4} }
#natureBotPet.sleeping .bot-mouth-grid { opacity: 0.3; }

/* ‚îÄ‚îÄ UYANMA ge√ßi≈ü animasyonu ‚îÄ‚îÄ */
#natureBotPet.waking {
  animation: botWakeUp 0.8s ease-out forwards;
}
@keyframes botWakeUp {
  0%  { transform: rotate(-8deg) scale(0.88); filter: brightness(.7); }
  40% { transform: rotate(5deg) scale(1.08); filter: brightness(1.2); }
  70% { transform: rotate(-3deg) scale(0.97); }
  100%{ transform: rotate(0deg) scale(1); filter: brightness(1); }
}

/* ‚îÄ‚îÄ ZZZ Baloncuklarƒ± ‚îÄ‚îÄ */
#botZzzContainer {
  position: fixed;
  pointer-events: none;
  z-index: 9998;
  display: none;
}
#botZzzContainer.visible { display: block; }
.bot-zzz {
  position: absolute;
  font-size: .8rem;
  font-weight: 900;
  color: #a5d6a7;
  opacity: 0;
  animation: zzzFloat 2.5s ease-in-out infinite;
  text-shadow: 0 0 8px rgba(74,143,64,.5);
}
.bot-zzz:nth-child(1) { animation-delay: 0s;    font-size: .7rem; }
.bot-zzz:nth-child(2) { animation-delay: 0.8s;  font-size: .9rem; }
.bot-zzz:nth-child(3) { animation-delay: 1.6s;  font-size: 1.1rem; }
@keyframes zzzFloat {
  0%   { opacity: 0;   transform: translate(0, 0) scale(.8); }
  20%  { opacity: .9; }
  80%  { opacity: .6; }
  100% { opacity: 0;   transform: translate(-12px, -32px) scale(1.1); }
}

/* ‚îÄ‚îÄ Kul√ºbe ‚îÄ‚îÄ */
#botKennel {
  position: fixed;
  z-index: 9995;
  pointer-events: none;
  transition: opacity .5s, transform .5s;
}
#botKennel.visible { opacity: 1; }
#botKennel.hidden  { opacity: 0; }

/* Kul√ºbe kapƒ± parlamasƒ± ‚Äî bot i√ßerideyken */
#botKennel .kennel-door-glow {
  transition: opacity .8s;
  opacity: 0;
}
#botKennel.occupied .kennel-door-glow { opacity: 1; }

/* Kul√ºbe giri≈ü animasyonu ‚Äî bot k√º√ß√ºlerek i√ßeri girer */
#natureBotPet.entering-kennel {
  animation: botEnterKennel 0.9s ease-in forwards;
  pointer-events: none;
}
@keyframes botEnterKennel {
  0%   { transform: scale(1) translateY(0);   opacity: 1; }
  40%  { transform: scale(0.75) translateY(8px); opacity: 1; }
  80%  { transform: scale(0.35) translateY(18px); opacity: 0.6; }
  100% { transform: scale(0.1) translateY(24px);  opacity: 0; }
}

/* Kul√ºbeden √ßƒ±kƒ±≈ü animasyonu ‚Äî bot b√ºy√ºyerek √ßƒ±kar */
#natureBotPet.exiting-kennel {
  animation: botExitKennel 0.85s ease-out forwards;
}
@keyframes botExitKennel {
  0%   { transform: scale(0.1) translateY(24px); opacity: 0; }
  30%  { transform: scale(0.4) translateY(16px);  opacity: 0.7; }
  70%  { transform: scale(1.12) translateY(-6px); opacity: 1; }
  100% { transform: scale(1) translateY(0);       opacity: 1; }
}

/* Kul√ºbe hafif titreme ‚Äî uyanƒ±nca */
#botKennel.waking-up {
  animation: kennelShake .5s ease-in-out;
}
@keyframes kennelShake {
  0%,100% { transform: translateX(0); }
  20%  { transform: translateX(-3px) rotate(-.5deg); }
  40%  { transform: translateX(3px)  rotate(.5deg); }
  60%  { transform: translateX(-2px); }
  80%  { transform: translateX(2px); }
}

/* Kul√ºbe kapƒ± - parlayan kenar */
#botKennel .kennel-door-frame {
  filter: drop-shadow(0 0 4px rgba(74,143,64,.0));
  transition: filter 1s;
}
#botKennel.occupied .kennel-door-frame {
  filter: drop-shadow(0 0 6px rgba(74,143,64,.7));
}

#natureBotPet.at-home .bot-arm-left,
#natureBotPet.at-home .bot-arm-right {
  animation-duration: 4s;
  animation-name: armIdle;
}
@keyframes armIdle {
  0%,100% { transform: rotate(0deg); }
  50% { transform: rotate(-6deg); }
}
#natureBotPet.at-home .bot-leg-left,
#natureBotPet.at-home .bot-leg-right {
  animation-duration: 4s;
  animation-name: legIdle;
}
@keyframes legIdle {
  0%,100% { transform: translateY(0px); }
  50% { transform: translateY(-1px); }
}

/* Konu≈üurken kollar hƒ±zlƒ± */
#natureBotPet.talking .bot-arm-left,
#natureBotPet.talking .bot-arm-right {
  animation-duration: 0.5s;
}
#natureBotPet.talking .bot-leg-left,
#natureBotPet.talking .bot-leg-right {
  animation-duration: 0.5s;
}

/* ‚îÄ‚îÄ G√∂z kƒ±rpma ‚îÄ‚îÄ */
#natureBotPet .bot-eye-glow {
  animation: eyeBlink 4s ease-in-out infinite;
}
@keyframes eyeBlink {
  0%,90%,100% { opacity:1; transform:scaleY(1); }
  95% { opacity:.1; transform:scaleY(.1); }
}
#natureBotPet.talking .bot-eye-glow {
  animation: eyeTalk 0.6s ease-in-out infinite alternate;
}
@keyframes eyeTalk {
  from { transform: scaleY(1); }
  to   { transform: scaleY(0.7) scaleX(1.1); }
}

/* ‚îÄ‚îÄ Aƒüƒ±z konu≈üma ‚îÄ‚îÄ */
#natureBotPet .bot-mouth-grid { transition: all .15s; }
#natureBotPet.talking .bot-mouth-open { display: block !important; }
#natureBotPet.talking .bot-mouth-grid { display: none !important; }

/* ‚îÄ‚îÄ Anten ‚îÄ‚îÄ */
#natureBotPet .bot-antenna-light {
  animation: antennaGlow 2s ease-in-out infinite alternate;
}
@keyframes antennaGlow {
  from { opacity:.6; filter:brightness(1); }
  to   { opacity:1; filter:brightness(1.5) drop-shadow(0 0 4px #6dbf67); }
}
#natureBotPet.talking .bot-antenna-light {
  animation: antennaTalk .3s ease-in-out infinite alternate;
}
@keyframes antennaTalk {
  from { opacity:.8; r:3; }
  to   { opacity:1; r:5; fill:#a5f3a7; }
}

/* ‚îÄ‚îÄ Arama halkalarƒ± ‚îÄ‚îÄ */
#natureBotPet .call-ring { fill:none; stroke:rgba(91,155,213,.4); stroke-width:2; opacity:0; }
#natureBotPet.calling .call-ring { animation: callRing 1.5s ease-out infinite; }
#natureBotPet.calling .call-ring:nth-child(2) { animation-delay:.5s; }
#natureBotPet.calling .call-ring:nth-child(3) { animation-delay:1s; }
@keyframes callRing { from{r:20;opacity:.8;} to{r:50;opacity:0;} }

/* ‚îÄ‚îÄ Damar nabƒ±z ‚îÄ‚îÄ */
#natureBotPet .bot-vein { animation: veinPulse 3s ease-in-out infinite; }
#natureBotPet .bot-vein:nth-child(2){animation-delay:.5s}
#natureBotPet .bot-vein:nth-child(3){animation-delay:1s}
#natureBotPet .bot-vein:nth-child(4){animation-delay:1.5s}
@keyframes veinPulse { 0%,100%{stroke-opacity:.3} 50%{stroke-opacity:.9} }

/* ‚îÄ‚îÄ Ses dalga g√∂stergesi ‚îÄ‚îÄ */
#botVoiceWave {
  position:fixed; z-index:9998;
  display:none; align-items:center; justify-content:center; gap:3px;
  background:rgba(14,43,12,.9); border:1px solid rgba(74,143,64,.4);
  border-radius:20px; padding:4px 10px;
  pointer-events:none;
}
#botVoiceWave.visible { display:flex; }
.bvw-bar {
  width:3px; border-radius:2px;
  background: linear-gradient(to top, #4a8f40, #6dbf67);
  animation: bvwAnim 0.6s ease-in-out infinite alternate;
}
.bvw-bar:nth-child(1){height:8px;animation-delay:0s}
.bvw-bar:nth-child(2){height:14px;animation-delay:.1s}
.bvw-bar:nth-child(3){height:20px;animation-delay:.2s}
.bvw-bar:nth-child(4){height:14px;animation-delay:.3s}
.bvw-bar:nth-child(5){height:8px;animation-delay:.4s}
@keyframes bvwAnim {
  from { transform:scaleY(.4); opacity:.6; }
  to   { transform:scaleY(1.2); opacity:1; }
}

/* ‚îÄ‚îÄ Sohbet Balonu ‚îÄ‚îÄ */
#natureBotBubble {
  position:fixed; z-index:9998;
  background:linear-gradient(135deg,#0e2b0c,#1a3d18);
  border:1px solid rgba(74,143,64,.4);
  border-radius:16px 16px 16px 4px;
  padding:10px 14px; max-width:240px; min-width:150px;
  font-size:.8rem; color:#c8e6c9;
  box-shadow:0 8px 32px rgba(0,0,0,.5),0 0 16px rgba(74,143,64,.15);
  opacity:0; transform:scale(.85) translateY(8px);
  transition:opacity .25s,transform .25s;
  pointer-events:none; line-height:1.5;
}
#natureBotBubble.visible { opacity:1; transform:scale(1) translateY(0); pointer-events:auto; }
.bot-bubble-name { font-size:.7rem;color:#6dbf67;font-weight:700;margin-bottom:5px;display:flex;align-items:center;gap:4px; }
.bot-bubble-msg { color:#dcedc8;line-height:1.5;white-space:pre-wrap;word-break:break-word; }
.bot-quick-cmds { display:flex;flex-wrap:wrap;gap:4px;margin-top:8px; }
.bot-qcmd { background:rgba(74,143,64,.2);border:1px solid rgba(74,143,64,.4);border-radius:8px;padding:3px 8px;font-size:.72rem;color:#a5d6a7;cursor:pointer;transition:background .15s; }
.bot-qcmd:hover { background:rgba(74,143,64,.4); }
.bot-bubble-close { position:absolute;top:6px;right:8px;font-size:.75rem;color:#6dbf67;cursor:pointer;opacity:.7; }
.bot-bubble-close:hover{opacity:1}
.bot-speak-btn { display:inline-flex;align-items:center;gap:4px;margin-top:6px;background:rgba(74,143,64,.25);border:1px solid rgba(74,143,64,.4);border-radius:8px;padding:3px 8px;font-size:.72rem;color:#a5d6a7;cursor:pointer;transition:background .15s; }
.bot-speak-btn:hover{background:rgba(74,143,64,.5)}
.bot-speak-btn.speaking{background:rgba(74,143,64,.5);animation:speakBtnPulse .5s ease-in-out infinite alternate}
@keyframes speakBtnPulse{from{opacity:.8}to{opacity:1}}

@media (max-width:767px) {
  #natureBotBubble { max-width:200px; }
}
`;

/* ‚ïê‚ïê SVG (kol/bacak gruplarƒ± ayrƒ±) ‚ïê‚ïê */
const BOT_SVG = `
<svg class="bot-svg" viewBox="-14 -18 92 118" xmlns="http://www.w3.org/2000/svg" overflow="visible">
  <defs>
    <radialGradient id="bgBodyGrad2" cx="50%" cy="40%" r="55%">
      <stop offset="0%" stop-color="#1a4a18"/>
      <stop offset="100%" stop-color="#0a1f09"/>
    </radialGradient>
    <radialGradient id="bgEyeGrad2" cx="50%" cy="30%" r="60%">
      <stop offset="0%" stop-color="#7dd6f5"/>
      <stop offset="100%" stop-color="#2a7ab5"/>
    </radialGradient>
    <filter id="botGlow2">
      <feGaussianBlur stdDeviation="1.5" result="blur"/>
      <feComposite in="SourceGraphic" in2="blur" operator="over"/>
    </filter>
    <clipPath id="leafBodyClip2">
      <path d="M32 2 C46 8 62 26 62 46 C62 66 50 78 32 78 C14 78 2 66 2 46 C2 26 18 8 32 2Z"/>
    </clipPath>
  </defs>

  <!-- Arama halkalarƒ± -->
  <circle class="call-ring" cx="32" cy="40"/>
  <circle class="call-ring" cx="32" cy="40"/>
  <circle class="call-ring" cx="32" cy="40"/>

  <!-- SOL KOL (ayrƒ± grup, animate edilir) -->
  <g class="bot-arm-left">
    <path d="M4 42 C-7 38 -12 29 -6 25 C-2 23 4 29 4 42Z"
          fill="#0e2b0c" stroke="#3a7a34" stroke-width=".9"/>
    <line x1="4" y1="42" x2="-6" y2="25" stroke="#4a8f40" stroke-width=".5" stroke-opacity=".55"/>
    <circle cx="-6" cy="25" r="2" fill="#1a4a18" stroke="#4a8f40" stroke-width=".7"/>
  </g>

  <!-- SAƒû KOL -->
  <g class="bot-arm-right">
    <path d="M60 42 C71 38 76 29 70 25 C66 23 60 29 60 42Z"
          fill="#0e2b0c" stroke="#3a7a34" stroke-width=".9"/>
    <line x1="60" y1="42" x2="70" y2="25" stroke="#4a8f40" stroke-width=".5" stroke-opacity=".55"/>
    <circle cx="70" cy="25" r="2" fill="#1a4a18" stroke="#4a8f40" stroke-width=".7"/>
  </g>

  <!-- SOL BACAK -->
  <g class="bot-leg-left">
    <rect x="19" y="76" width="9" height="12" rx="3" fill="#0e2b0c" stroke="#3a7a34" stroke-width=".8"/>
    <ellipse cx="23.5" cy="89" rx="5" ry="3.5" fill="#1a4a18" stroke="#4a8f40" stroke-width=".8"/>
  </g>

  <!-- SAƒû BACAK -->
  <g class="bot-leg-right">
    <rect x="36" y="76" width="9" height="12" rx="3" fill="#0e2b0c" stroke="#3a7a34" stroke-width=".8"/>
    <ellipse cx="40.5" cy="89" rx="5" ry="3.5" fill="#1a4a18" stroke="#4a8f40" stroke-width=".8"/>
  </g>

  <!-- G√ñVDE ANA GRUBU -->
  <g class="bot-body-group">
    <!-- G√∂vde: Yaprak -->
    <path d="M32 2 C46 8 62 26 62 46 C62 66 50 78 32 78 C14 78 2 66 2 46 C2 26 18 8 32 2Z"
          fill="url(#bgBodyGrad2)" stroke="#3a7a34" stroke-width="1.2"/>

    <!-- Damar/devre √ßizgileri -->
    <g clip-path="url(#leafBodyClip2)">
      <line class="bot-vein" x1="32" y1="2"  x2="32"  y2="78" stroke="#4a8f40" stroke-width="1"   stroke-opacity=".6"/>
      <line class="bot-vein" x1="32" y1="22" x2="14"  y2="36" stroke="#4a8f40" stroke-width=".7"  stroke-opacity=".5"/>
      <line class="bot-vein" x1="32" y1="38" x2="10"  y2="50" stroke="#4a8f40" stroke-width=".6"  stroke-opacity=".4"/>
      <line class="bot-vein" x1="32" y1="52" x2="14"  y2="62" stroke="#4a8f40" stroke-width=".5"  stroke-opacity=".35"/>
      <line class="bot-vein" x1="32" y1="22" x2="50"  y2="36" stroke="#4a8f40" stroke-width=".7"  stroke-opacity=".5"/>
      <line class="bot-vein" x1="32" y1="38" x2="54"  y2="50" stroke="#4a8f40" stroke-width=".6"  stroke-opacity=".4"/>
      <line class="bot-vein" x1="32" y1="52" x2="50"  y2="62" stroke="#4a8f40" stroke-width=".5"  stroke-opacity=".35"/>
      <circle cx="14" cy="36" r="1.2" fill="#4a8f40" fill-opacity=".7"/>
      <circle cx="10" cy="50" r="1"   fill="#4a8f40" fill-opacity=".6"/>
      <circle cx="50" cy="36" r="1.2" fill="#4a8f40" fill-opacity=".7"/>
      <circle cx="54" cy="50" r="1"   fill="#4a8f40" fill-opacity=".6"/>
    </g>

    <!-- Y√ºz plakasƒ± -->
    <rect x="15" y="17" width="34" height="36" rx="8"
          fill="rgba(8,28,8,.75)" stroke="rgba(74,143,64,.5)" stroke-width=".8"/>

    <!-- Sol g√∂z -->
    <circle cx="23" cy="29" r="5.5" fill="rgba(0,0,0,.8)" stroke="#3a7a34" stroke-width=".8"/>
    <circle class="bot-eye-glow" cx="23" cy="29" r="4" fill="url(#bgEyeGrad2)" filter="url(#botGlow2)"/>
    <circle cx="24.5" cy="27.5" r="1.2" fill="rgba(255,255,255,.6)"/>

    <!-- Saƒü g√∂z -->
    <circle cx="41" cy="29" r="5.5" fill="rgba(0,0,0,.8)" stroke="#3a7a34" stroke-width=".8"/>
    <circle class="bot-eye-glow" cx="41" cy="29" r="4" fill="url(#bgEyeGrad2)" filter="url(#botGlow2)"/>
    <circle cx="42.5" cy="27.5" r="1.2" fill="rgba(255,255,255,.6)"/>

    <!-- Aƒüƒ±z ‚Äì normal ƒ±zgara -->
    <g class="bot-mouth-grid">
      <rect x="20" y="39" width="24" height="9" rx="4"
            fill="rgba(0,0,0,.6)" stroke="rgba(74,143,64,.4)" stroke-width=".6"/>
      <line x1="24" y1="39" x2="24" y2="48" stroke="rgba(74,143,64,.3)" stroke-width=".5"/>
      <line x1="28" y1="39" x2="28" y2="48" stroke="rgba(74,143,64,.3)" stroke-width=".5"/>
      <line x1="32" y1="39" x2="32" y2="48" stroke="rgba(74,143,64,.3)" stroke-width=".5"/>
      <line x1="36" y1="39" x2="36" y2="48" stroke="rgba(74,143,64,.3)" stroke-width=".5"/>
      <line x1="40" y1="39" x2="40" y2="48" stroke="rgba(74,143,64,.3)" stroke-width=".5"/>
    </g>

    <!-- Aƒüƒ±z ‚Äì konu≈üma (varsayƒ±lan gizli) -->
    <ellipse class="bot-mouth-open" cx="32" cy="43" rx="8" ry="5"
             fill="rgba(0,0,0,.8)" stroke="#4a8f40" stroke-width=".8"
             style="display:none"/>
    <ellipse class="bot-mouth-open" cx="32" cy="41" rx="5" ry="2.5"
             fill="#1a4a18" style="display:none"/>

    <!-- Anten -->
    <line x1="32" y1="2" x2="32" y2="-14" stroke="#4a8f40" stroke-width="1.6" stroke-linecap="round"/>
    <circle class="bot-antenna-light" cx="32" cy="-16" r="3.5" fill="#6dbf67" filter="url(#botGlow2)"/>
    <circle cx="32" cy="-16" r="2" fill="#a5d6a7"/>
  </g>
</svg>`;

/* ‚ïê‚ïê Mesajlar ‚ïê‚ïê */
const GREETING_MSGS = [
  'üëã Merhaba! Nasƒ±l yardƒ±mcƒ± olabilirim?\n/yardƒ±m ile komutlarƒ±mƒ± g√∂rebilirsin üåø',
  'üåø Selam! Sana yardƒ±m etmek i√ßin buradayƒ±m!',
  'ü§ñ NatureBot aktif! Ne yapmak istersin?',
  'üíö Merhaba! /hava, /flip, /zar dene!',
  'üå± Buradayƒ±m! Uygulama hakkƒ±nda ne merak ediyorsun?',
];
const IDLE_MSGS = [
  'üí¨ Bir oda se√ß ve sohbete katƒ±l!',
  'üå§Ô∏è Hava durumu i√ßin /hava [≈üehir] dene',
  'üé≤ Zar atmak ister misin? /zar yaz!',
  'ü™ô Yazƒ± mƒ± tura mƒ±? /flip ile √∂ƒüren!',
  'üë• Arkada≈ü eklemek i√ßin Arkada≈ülar sekmesine bak',
  'üîî Bildirimlerin i√ßin zil ikonuna tƒ±kla',
  'üé® Temayƒ± deƒüi≈ütirmek ister misin? Profil ‚Üí G√∂r√ºn√ºm',
  'üìã Forumda yeni konular var, bir g√∂z at!',
];

/* ‚ïê‚ïê Sesli Konu≈üma (Web Speech API) ‚ïê‚ïê */
const SPEECH = {
  supported: 'speechSynthesis' in window,
  speaking: false,
  currentUtter: null,

  getVoice() {
    const voices = speechSynthesis.getVoices();
    // √ñncelik: T√ºrk√ße kadƒ±n/kƒ±z sesi
    const trFemale = voices.find(v => v.lang.startsWith('tr') && /female|woman|girl|kadƒ±n/i.test(v.name));
    const tr = voices.find(v => v.lang.startsWith('tr'));
    // T√ºrk√ße yoksa ƒ∞ngilizce kadƒ±n sesi (daha tiz √ßƒ±kar)
    const enFemale = voices.find(v => v.lang.startsWith('en') && /female|woman|girl|samantha|karen|victoria|fiona/i.test(v.name));
    return trFemale || tr || enFemale || voices[0] || null;
  },

  // Metni doƒüal, anla≈üƒ±lƒ±r konu≈ümaya √ßevir
  cleanForSpeech(text) {
    let t = text;

    // Emojileri temizle
    t = t.replace(/[\u{1F000}-\u{1FFFF}]|[\u{2600}-\u{27FF}]/gu, ' ');
    t = t.replace(/[üåøü§ñüíöüå±üëãüí¨üå§Ô∏èüé≤ü™ôüë•üîîüé®üìã‚è≥‚ùåüìçüìäüîë‚öôÔ∏èüë§üìÖüïêüéØüå≥‚úÖ‚ûï]/g, ' ');

    // Saat formatƒ±: "05:30" ‚Üí "saat be≈ü otuz"
    t = t.replace(/\b(\d{1,2}):(\d{2})\b/g, (_, h, m) => {
      const hr = parseInt(h);
      const mn = parseInt(m);
      const hrTR = ['sƒ±fƒ±r','bir','iki','√º√ß','d√∂rt','be≈ü','altƒ±','yedi','sekiz','dokuz',
                    'on','on bir','on iki','on √º√ß','on d√∂rt','on be≈ü','on altƒ±','on yedi',
                    'on sekiz','on dokuz','yirmi','yirmi bir','yirmi iki','yirmi √º√ß'];
      const mnTR = mn === 0 ? '' : (mn < 10 ? 'sƒ±fƒ±r ' : '') +
        ['sƒ±fƒ±r','bir','iki','√º√ß','d√∂rt','be≈ü','altƒ±','yedi','sekiz','dokuz',
         'on','on bir','on iki','on √º√ß','on d√∂rt','on be≈ü','on altƒ±','on yedi',
         'on sekiz','on dokuz','yirmi','yirmi bir','yirmi iki','yirmi √º√ß','yirmi d√∂rt',
         'yirmi be≈ü','yirmi altƒ±','yirmi yedi','yirmi sekiz','yirmi dokuz',
         'otuz','otuz bir','otuz iki','otuz √º√ß','otuz d√∂rt','otuz be≈ü','otuz altƒ±',
         'otuz yedi','otuz sekiz','otuz dokuz','kƒ±rk','kƒ±rk bir','kƒ±rk iki','kƒ±rk √º√ß',
         'kƒ±rk d√∂rt','kƒ±rk be≈ü','kƒ±rk altƒ±','kƒ±rk yedi','kƒ±rk sekiz','kƒ±rk dokuz',
         'elli','elli bir','elli iki','elli √º√ß','elli d√∂rt','elli be≈ü','elli altƒ±',
         'elli yedi','elli sekiz','elli dokuz'][mn];
      const suffix = hr < 12 ? 'sabah' : (hr < 18 ? '√∂ƒüleden sonra' : 'ak≈üam');
      return 'saat ' + (hrTR[hr] || hr) + (mn > 0 ? ' ' + mnTR : '') + ' ' + suffix;
    });

    // Sayƒ±larƒ± T√ºrk√ße oku (1-999)
    const sayiTR = (n) => {
      const birler = ['','bir','iki','√º√ß','d√∂rt','be≈ü','altƒ±','yedi','sekiz','dokuz'];
      const onlar = ['','on','yirmi','otuz','kƒ±rk','elli','altmƒ±≈ü','yetmi≈ü','seksen','doksan'];
      if (n === 0) return 'sƒ±fƒ±r';
      let s = '';
      if (n >= 100) { if(Math.floor(n/100)>1) s += birler[Math.floor(n/100)]+'y√ºz'; else s+='y√ºz'; n%=100; }
      if (n >= 10)  { s += onlar[Math.floor(n/10)]; n%=10; }
      if (n > 0)    { s += birler[n]; }
      return s.trim();
    };

    // Yƒ±l formatƒ±: "2026" ‚Üí "iki bin yirmi altƒ±"
    t = t.replace(/\b(20\d{2}|19\d{2})\b/g, (_, y) => {
      const yr = parseInt(y);
      const binler = Math.floor(yr/1000);
      const rest = yr % 1000;
      return sayiTR(binler) + ' bin ' + (rest > 0 ? sayiTR(rest) : '');
    });

    // Diƒüer sayƒ±lar: rakam rakam deƒüil, sayƒ± olarak oku
    t = t.replace(/\b(\d+)\b/g, (_, n) => {
      const num = parseInt(n);
      if (num > 0 && num < 1000) return sayiTR(num);
      return n;
    });

    // Noktalama ve bi√ßimlendirme
    t = t.replace(/\n+/g, '. ');
    t = t.replace(/‚Üí/g, ', ');
    t = t.replace(/[|\/\\*_`~^<>{}[\]()#@=+]/g, ' ');
    t = t.replace(/\.{2,}/g, '.');
    t = t.replace(/\s{2,}/g, ' ');

    return t.trim();
  },

  speak(text, onStart, onEnd) {
    if (!this.supported) { onEnd && onEnd(); return; }
    this.stop();

    const clean = this.cleanForSpeech(text);
    if (!clean || clean.length < 2) { onEnd && onEnd(); return; }

    const utter = new SpeechSynthesisUtterance(clean);
    utter.lang = 'tr-TR';
    utter.pitch = 2.0;   // maksimum tiz ‚Äî √ßocuk sesi
    utter.rate = 1.1;    // hafif hƒ±zlƒ± ama anla≈üƒ±lƒ±r
    utter.volume = 1.0;

    // Sesi y√ºkle ve ata
    const setVoice = () => {
      const voice = this.getVoice();
      if (voice) utter.voice = voice;
    };
    setVoice();
    if (!utter.voice) {
      // Sesler hen√ºz y√ºklenmediyse bekle
      speechSynthesis.onvoiceschanged = () => { setVoice(); };
    }

    utter.onstart = () => { this.speaking = true; onStart && onStart(); };
    utter.onend   = () => { this.speaking = false; onEnd && onEnd(); };
    utter.onerror = (e) => {
      if (e.error !== 'interrupted') console.warn('TTS hata:', e.error);
      this.speaking = false;
      onEnd && onEnd();
    };

    this.currentUtter = utter;
    // iOS/Safari fix: k√º√ß√ºk gecikme
    setTimeout(() => { try { speechSynthesis.speak(utter); } catch(e){} }, 50);
  },

  stop() {
    if (this.supported) {
      try { speechSynthesis.cancel(); } catch(e){}
      this.speaking = false;
    }
  }
};

/* ‚ïê‚ïê Komut ƒ∞≈üleyici ‚ïê‚ïê */
function runBotCmd(cmdText, showInBubble) {
  if (!cmdText.startsWith('/')) return false;
  const parts = cmdText.trim().split(' ');
  const cmd = parts[0].toLowerCase();
  const args = parts.slice(1).join(' ');

  const respond = (text) => {
    if (showInBubble && window._natureBotInstance) {
      window._natureBotInstance.showBubble(text, false);
    }
    const box = document.getElementById('chatMsgs');
    if (box) {
      const div = document.createElement('div');
      div.className = 'msg-sys';
      div.style.cssText = 'background:rgba(74,143,64,.08);border:1px solid rgba(74,143,64,.15);border-radius:10px;padding:8px 12px;margin:6px 12px;font-size:.82rem;white-space:pre-wrap;';
      div.innerHTML = '<span style="color:var(--accent);font-weight:700;">ü§ñ NatureBot</span><br>' + text.replace(/</g,'&lt;');
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }
  };

  const cmds = {
    '/yardƒ±m': () => respond('ü§ñ Komutlar:\n/hava [≈üehir] ‚Äî Hava durumu\n/saat ‚Äî ≈ûu anki saat\n/tarih ‚Äî Bug√ºn√ºn tarihi\n/flip ‚Äî Yazƒ±/Tura\n/zar ‚Äî Rastgele zar\n/rng [sayƒ±] ‚Äî Rastgele sayƒ±\n/anket [soru] ‚Äî Anket olu≈ütur\n\nUygulama yardƒ±mƒ± i√ßin:\n"oda nasƒ±l olu≈ütururum?"\n"arkada≈ü nasƒ±l eklerim?" yazabilirsin'),
    '/saat': () => {
      const now = new Date();
      const display = now.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
      respond('üïê ≈ûu an: ' + display);
    },
    '/tarih': () => {
      const now = new Date();
      const display = now.toLocaleDateString('tr-TR', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
      respond('üìÖ ' + display);
    },
    '/flip': () => respond('ü™ô ' + (Math.random()<.5 ? 'YAZI ‚úÖ' : 'TURA ‚úÖ')),
    '/zar': () => respond('üé≤ Zar: ' + Math.ceil(Math.random()*6)),
    '/rng': () => { const n=parseInt(args)||100; respond('üéØ 1-'+n+' arasƒ±: '+Math.ceil(Math.random()*n)); },
    '/hava': () => {
      if (!args) { respond('üìç Kullanƒ±m: /hava [≈üehir]\n√ñrnek: /hava istanbul'); return; }
      respond('‚è≥ ' + args + ' i√ßin hava durumu alƒ±nƒ±yor...');
      fetch('https://wttr.in/'+encodeURIComponent(args)+'?format=3&lang=tr')
        .then(r=>r.text()).then(t=>respond('üå§Ô∏è '+t.trim()))
        .catch(()=>respond('‚ùå Hava durumu alƒ±namadƒ±.'));
    },
    '/anket': () => {
      if (!args) { respond('üìä Kullanƒ±m: /anket [soru]'); return; }
      const m=document.getElementById('createPollModal'), q=document.getElementById('pollQuestion');
      if(m&&q){q.value=args;m.style.display='flex';respond('üìä Anket olu≈üturucu a√ßƒ±ldƒ±!');}
      else respond('üìä Anket olu≈üturucu a√ßƒ±lamadƒ±. √ñnce bir odaya gir.');
    },
  };

  if (cmds[cmd]) { cmds[cmd](); return true; }

  // Akƒ±llƒ± uygulama yardƒ±mƒ±
  const helpMap = [
    { keys:['oda','kanal','grup','olu≈ütur','yarat'], reply:'‚ûï Oda olu≈üturmak i√ßin:\nAna Sayfa ‚Üí GRUPLAR ‚Üí + butonuna tƒ±kla' },
    { keys:['arkada≈ü','ekle','davet'], reply:'üë• Arkada≈ü eklemek i√ßin:\nAlt men√ºden "Arkada≈ülar" sekmesine git ‚Üí +' },
    { keys:['tema','g√∂r√ºn√ºm','renk','aray√ºz'], reply:'üé® Tema deƒüi≈ütirmek i√ßin:\nProfil ‚Üí Ayarlar ‚Üí G√∂r√ºn√ºm' },
    { keys:['bildirim','zil','ses'], reply:'üîî Bildirimler i√ßin saƒü √ºstteki zil ikonuna tƒ±kla' },
    { keys:['mesaj','dm','direkt'], reply:'üí¨ Direkt mesaj i√ßin:\nAna Sayfa ‚Üí Dƒ∞REKT MESAJLAR ‚Üí +' },
    { keys:['profil','hesap','ayar'], reply:'üë§ Profil i√ßin saƒü √ºstteki avatar fotoƒürafƒ±na tƒ±kla' },
    { keys:['forum','konu','post'], reply:'üìã Forum i√ßin alt men√ºden "Forum" sekmesine git' },
    { keys:['izle','video','yayƒ±n'], reply:'üì∫ ƒ∞zleme i√ßin alt men√ºden "ƒ∞zle" sekmesine git' },
    { keys:['arama','ara','bul'], reply:'üîç Arama i√ßin √ºstteki arama kutusunu kullan' },
    { keys:['√ßƒ±kƒ±≈ü','logout'], reply:'üö™ √áƒ±kƒ±≈ü: Profil ‚Üí Ayarlar ‚Üí √áƒ±kƒ±≈ü Yap' },
    { keys:['admin','y√∂net','panel'], reply:'‚öôÔ∏è Admin paneli i√ßin Profil men√ºs√ºnde "Admin" se√ß' },
    { keys:['robot','sen','kimsin'], reply:'ü§ñ Ben NatureBot! Nature.co uygulamasƒ±nƒ±n yapay zeka asistanƒ±yƒ±m. Sana her konuda yardƒ±mcƒ± olurum!' },
  ];
  const lower = cmdText.toLowerCase();
  for (const h of helpMap) {
    if (h.keys.some(k => lower.includes(k))) { respond(h.reply); return true; }
  }

  respond('‚ùì "' + cmd + '" komutunu bilmiyorum.\n/yardƒ±m ile t√ºm komutlarƒ± g√∂rebilirsin!');
  return true;
}

/* ‚ïê‚ïê NatureBotPet Sƒ±nƒ±fƒ± ‚ïê‚ïê */
class NatureBotPet {
  constructor() {
    this.el = null;
    this.bubble = null;
    this.voiceWave = null;
    this.isCalling = false;
    this.isDragging = false;
    this.isTalking = false;
    this.bubbleTimeout = null;
    this.idleTimeout = null;
    this.wanderTimer = null;
    this.rafId = null;
    this.isAtHome = false;
    this.isSleeping = false;
    this.isWaking = false;
    this.homeCheckTimer = null;
    this.sleepTimer = null;
    this.kennelEl = null;
    this.zzzEl = null;
    this.lastInteractTime = Date.now();
    this.wanderStartTime = Date.now();
    // S√ºre ayarlarƒ± (ms)
    this.WANDER_DURATION = (15 + Math.random() * 5) * 60 * 1000; // 15-20 dk
    this.SLEEP_DURATION  = 45 * 60 * 1000; // 45 dk
    this.x = 0; this.y = 0;
    this.targetX = 0; this.targetY = 0;
    this.init();
  }

  init() {
    const style = document.createElement('style');
    style.textContent = BOT_CSS;
    document.head.appendChild(style);

    this.el = document.createElement('div');
    this.el.id = 'natureBotPet';
    this.el.innerHTML = BOT_SVG;
    document.body.appendChild(this.el);

    // Ses dalga g√∂stergesi
    this.voiceWave = document.createElement('div');
    this.voiceWave.id = 'botVoiceWave';
    this.voiceWave.innerHTML = '<div class="bvw-bar"></div>'.repeat(5);
    document.body.appendChild(this.voiceWave);

    this.bubble = document.createElement('div');
    this.bubble.id = 'natureBotBubble';
    document.body.appendChild(this.bubble);

    if (IS_MOBILE()) {
      this.initMobile();
    } else {
      this.initDesktop();
    }

    this.bindClick();
    this.scheduleIdleMsg();
    this.hookCallScreen();

    // Sesler y√ºklenince yeniden kontrol
    if (SPEECH.supported) {
      speechSynthesis.onvoiceschanged = () => {};
      // Sesleri √∂nceden y√ºkle
      speechSynthesis.getVoices();
    }

    window.addEventListener('resize', () => {
      if (IS_MOBILE()) this.initMobile();
    });
  }

  initMobile() {
    // Robot'u header i√ßindeki slota ta≈üƒ±
    const slot = document.getElementById('mobileRobotSlot');
    if (slot && !slot.contains(this.el)) {
      slot.appendChild(this.el);
    }
    // Slot i√ßinde relative konumlanƒ±r
    this.el.style.cssText = '';
    this.el.style.position = 'relative';
    this.el.style.left = 'auto';
    this.el.style.top = 'auto';
    this.el.style.right = 'auto';
    this.el.style.width = '44px';
    this.el.style.height = '54px';
    this.el.style.zIndex = '9997';
    this.el.style.cursor = 'pointer';
    this.el.style.display = 'block';
    if (this.rafId) { cancelAnimationFrame(this.rafId); this.rafId = null; }
    if (this.wanderTimer) clearTimeout(this.wanderTimer);
  }

  initDesktop() {
    const b = this.getSidebarBounds();
    this.x = b.x1 + Math.random() * Math.max(0, b.x2 - b.x1);
    this.y = b.y1 + Math.random() * Math.max(0, b.y2 - b.y1);
    this.targetX = this.x; this.targetY = this.y;
    this.el.style.position = 'fixed';
    this.el.style.left = Math.round(this.x) + 'px';
    this.el.style.top = Math.round(this.y) + 'px';
    this.el.style.right = 'auto';
    this.el.style.width = '44px';   // k√º√ß√ºk
    this.el.style.height = '70px';
    this.el.style.zIndex = '100';   // sidebar i√ßeriƒüinin √ºst√ºnde ama modal altƒ±nda
    this.el.style.pointerEvents = 'auto';
    this.createKennel();
    this.createZzz();
    this.startWanderDesktop();
    this.loop();
    this.startHomeCheck();
  }

  getSidebarBounds() {
    // Robot sidebar i√ßinde gezinir: rail(68px) + sidebar(260px) = 328px
    const botW = 48, botH = 80, margin = 16;
    const kennelH = 86;  // kul√ºbe (78px + margin)
    return {
      x1: 68 + margin,
      x2: 328 - botW - margin,
      y1: 80 + margin,
      y2: window.innerHeight - botH - kennelH - margin
    };
  }

  getKennelPos() {
    const kW = 96, kH = 78;
    return {
      x: 68 + 10,  // sola yakƒ±n
      y: window.innerHeight - kH - 14
    };
  }

  createKennel() {
    // Eski varsa kaldƒ±r
    const old = document.getElementById('botKennel');
    if (old) old.remove();

    const k = document.createElement('div');
    k.id = 'botKennel';
    k.className = 'hidden';
    const pos = this.getKennelPos();
    k.style.cssText = 'position:fixed;z-index:9995;pointer-events:auto;cursor:pointer;transition:opacity .6s;opacity:0;';
    k.style.left = pos.x + 'px';
    k.style.top  = pos.y + 'px';
    k.innerHTML = `
      <svg width="96" height="78" viewBox="0 0 120 98" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <radialGradient id="kg1" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#6dbf67" stop-opacity=".9"/>
            <stop offset="100%" stop-color="#2d5a20" stop-opacity=".2"/>
          </radialGradient>
          <radialGradient id="kg2" cx="50%" cy="80%" r="60%">
            <stop offset="0%" stop-color="#4a8f40" stop-opacity=".6"/>
            <stop offset="100%" stop-color="#0a150a" stop-opacity="0"/>
          </radialGradient>
          <filter id="kglow" x="-20%" y="-20%" width="140%" height="140%">
            <feGaussianBlur stdDeviation="2.5" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
          <linearGradient id="roofGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#3a8a28"/>
            <stop offset="100%" stop-color="#1a4a12"/>
          </linearGradient>
          <linearGradient id="wallGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#162416"/>
            <stop offset="100%" stop-color="#0a150a"/>
          </linearGradient>
          <linearGradient id="doorGrad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#0d1f0d"/>
            <stop offset="100%" stop-color="#050a05"/>
          </linearGradient>
          <linearGradient id="glowDoor" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#4a8f40" stop-opacity=".7"/>
            <stop offset="100%" stop-color="#6dbf67" stop-opacity=".1"/>
          </linearGradient>
        </defs>

        <!-- Zemin g√∂lge -->
        <ellipse cx="60" cy="95" rx="50" ry="6" fill="rgba(0,0,0,.35)"/>

        <!-- ‚îÄ‚îÄ DUVARLAR ‚îÄ‚îÄ -->
        <rect x="12" y="46" width="96" height="49" rx="5" fill="url(#wallGrad)" stroke="#2a4a2a" stroke-width="1.5"/>

        <!-- Ah≈üap desen yatay √ßizgiler -->
        <line x1="13" y1="57" x2="107" y2="57" stroke="#1a3a1a" stroke-width=".7" opacity=".8"/>
        <line x1="13" y1="68" x2="107" y2="68" stroke="#1a3a1a" stroke-width=".7" opacity=".8"/>
        <line x1="13" y1="79" x2="107" y2="79" stroke="#1a3a1a" stroke-width=".7" opacity=".8"/>

        <!-- Devre izleri sol duvar -->
        <path d="M18 52 L18 62 L24 62 L24 74" stroke="#2d5a20" stroke-width=".8" fill="none" opacity=".6"/>
        <circle cx="18" cy="52" r="1.5" fill="#4a8f40" opacity=".8"/>
        <circle cx="24" cy="74" r="1.5" fill="#4a8f40" opacity=".8"/>
        <path d="M96 55 L96 65 L104 65" stroke="#2d5a20" stroke-width=".8" fill="none" opacity=".6"/>
        <circle cx="104" cy="65" r="1.5" fill="#4a8f40" opacity=".8"/>

        <!-- ‚îÄ‚îÄ √áATI ‚îÄ‚îÄ -->
        <!-- √áatƒ± alt y√ºzey -->
        <path d="M8 48 L60 6 L112 48 Z" fill="#1a4a12" stroke="#2d6a20" stroke-width="1.5"/>
        <!-- √áatƒ± ana y√ºzey -->
        <path d="M8 48 L60 6 L112 48 Z" fill="url(#roofGrad)"/>
        <!-- √áatƒ± parlak kenar -->
        <path d="M8 48 L60 6 L112 48" fill="none" stroke="#4a8f40" stroke-width="1.2" opacity=".8"/>
        <!-- √áatƒ± √ßizgileri -->
        <line x1="60" y1="8" x2="60" y2="48" stroke="#2d5a20" stroke-width="1" opacity=".7"/>
        <line x1="34" y1="34" x2="86" y2="34" stroke="#2d5a20" stroke-width=".8" opacity=".6"/>
        <line x1="20" y1="44" x2="100" y2="44" stroke="#2d5a20" stroke-width=".7" opacity=".5"/>
        <!-- √áatƒ± hexagon pattern -->
        <path d="M52 22 L56 18 L64 18 L68 22 L64 26 L56 26 Z" fill="none" stroke="#3a7a28" stroke-width=".7" opacity=".7"/>
        <path d="M38 34 L42 30 L50 30 L54 34 L50 38 L42 38 Z" fill="none" stroke="#3a7a28" stroke-width=".6" opacity=".5"/>
        <path d="M66 34 L70 30 L78 30 L82 34 L78 38 L70 38 Z" fill="none" stroke="#3a7a28" stroke-width=".6" opacity=".5"/>

        <!-- √áatƒ± g√ºne≈ü paneli -->
        <rect x="44" y="20" width="32" height="14" rx="2" fill="#0a200a" stroke="#2d5a2d" stroke-width=".8" opacity=".9"/>
        <line x1="50" y1="20" x2="50" y2="34" stroke="#2d5a2d" stroke-width=".5"/>
        <line x1="57" y1="20" x2="57" y2="34" stroke="#2d5a2d" stroke-width=".5"/>
        <line x1="63" y1="20" x2="63" y2="34" stroke="#2d5a2d" stroke-width=".5"/>
        <line x1="70" y1="20" x2="70" y2="34" stroke="#2d5a2d" stroke-width=".5"/>
        <line x1="44" y1="27" x2="76" y2="27" stroke="#2d5a2d" stroke-width=".5"/>

        <!-- Anten -->
        <line x1="60" y1="6" x2="60" y2="-8" stroke="#3a7a28" stroke-width="1.5" stroke-linecap="round"/>
        <circle cx="60" cy="-10" r="4" fill="#2d5a20" stroke="#4a8f40" stroke-width="1"/>
        <circle cx="60" cy="-10" r="2" fill="#6dbf67" filter="url(#kglow)"/>

        <!-- ‚îÄ‚îÄ TABELA ‚îÄ‚îÄ -->
        <rect x="34" y="37" width="52" height="14" rx="4" fill="#0f2a0f" stroke="#4a8f40" stroke-width="1.2"/>
        <!-- Tabela devre izleri -->
        <line x1="36" y1="41" x2="40" y2="41" stroke="#2d5a20" stroke-width=".7"/>
        <line x1="80" y1="41" x2="84" y2="41" stroke="#2d5a20" stroke-width=".7"/>
        <circle cx="36" cy="41" r="1" fill="#4a8f40"/>
        <circle cx="84" cy="41" r="1" fill="#4a8f40"/>
        <text x="60" y="47.5" text-anchor="middle" font-size="7.5" font-weight="bold" fill="#6dbf67" font-family="monospace" letter-spacing="0.5">NatureBot</text>

        <!-- ‚îÄ‚îÄ PENCERELER ‚îÄ‚îÄ -->
        <rect x="16" y="54" width="20" height="16" rx="3" fill="#071407" stroke="#2d5a2d" stroke-width="1"/>
        <rect x="17" y="55" width="8.5" height="7" rx="1" fill="#0a1f0a" stroke="#1a3a1a" stroke-width=".5"/>
        <rect x="26.5" y="55" width="8.5" height="7" rx="1" fill="#0a1f0a" stroke="#1a3a1a" stroke-width=".5"/>
        <rect x="17" y="63" width="8.5" height="6" rx="1" fill="#0a1f0a" stroke="#1a3a1a" stroke-width=".5"/>
        <rect x="26.5" y="63" width="8.5" height="6" rx="1" fill="#0a1f0a" stroke="#1a3a1a" stroke-width=".5"/>
        <!-- Sol pencere ƒ±≈üƒ±k -->
        <rect x="17" y="55" width="8.5" height="7" rx="1" fill="rgba(74,143,64,.08)" class="kennel-door-glow"/>

        <rect x="84" y="54" width="20" height="16" rx="3" fill="#071407" stroke="#2d5a2d" stroke-width="1"/>
        <rect x="85" y="55" width="8.5" height="7" rx="1" fill="#0a1f0a" stroke="#1a3a1a" stroke-width=".5"/>
        <rect x="94.5" y="55" width="8.5" height="7" rx="1" fill="#0a1f0a" stroke="#1a3a1a" stroke-width=".5"/>
        <rect x="85" y="63" width="8.5" height="6" rx="1" fill="#0a1f0a" stroke="#1a3a1a" stroke-width=".5"/>
        <rect x="94.5" y="63" width="8.5" height="6" rx="1" fill="#0a1f0a" stroke="#1a3a1a" stroke-width=".5"/>
        <!-- Saƒü pencere ƒ±≈üƒ±k -->
        <rect x="85" y="55" width="8.5" height="7" rx="1" fill="rgba(74,143,64,.08)" class="kennel-door-glow"/>

        <!-- ‚îÄ‚îÄ KAPI (Kemer) ‚îÄ‚îÄ -->
        <path d="M44 95 L44 68 Q44 54 60 54 Q76 54 76 68 L76 95 Z" fill="url(#doorGrad)" class="kennel-door-frame"/>
        <!-- Kapƒ± i√ß kemer √ßizgisi -->
        <path d="M47 95 L47 68.5 Q47 57.5 60 57.5 Q73 57.5 73 68.5 L73 95" fill="none" stroke="#1a3a1a" stroke-width=".8"/>
        <!-- Kapƒ± LED ≈üerit -->
        <path d="M44 68 Q44 54 60 54 Q76 54 76 68" fill="none" stroke="#4a8f40" stroke-width="1.2" class="kennel-door-frame"/>
        <!-- Kapƒ± i√ßinde uyuma ƒ±≈üƒ±ƒüƒ± -->
        <path d="M46 95 L46 68.5 Q46 56 60 56 Q74 56 74 68.5 L74 95 Z" fill="url(#glowDoor)" class="kennel-door-glow"/>

        <!-- LED noktalar √ºst k√∂≈üeler -->
        <circle cx="14" cy="50" r="2" fill="#4a8f40" opacity=".6"/>
        <circle cx="106" cy="50" r="2" fill="#4a8f40" opacity=".6"/>
        <circle cx="14" cy="88" r="2" fill="#2d5a20" opacity=".5"/>
        <circle cx="106" cy="88" r="2" fill="#2d5a20" opacity=".5"/>

        <!-- √ái√ßek/bitki sol -->
        <line x1="10" y1="95" x2="10" y2="82" stroke="#2d5a20" stroke-width="1.2"/>
        <circle cx="10" cy="80" r="4" fill="#2d5a20"/>
        <circle cx="7"  cy="77" r="2.5" fill="#3a7a28"/>
        <circle cx="13" cy="77" r="2.5" fill="#3a7a28"/>
        <!-- √ái√ßek/bitki saƒü -->
        <line x1="110" y1="95" x2="110" y2="82" stroke="#2d5a20" stroke-width="1.2"/>
        <circle cx="110" cy="80" r="4" fill="#2d5a20"/>
        <circle cx="107" cy="77" r="2.5" fill="#3a7a28"/>
        <circle cx="113" cy="77" r="2.5" fill="#3a7a28"/>
      </svg>`;

    // Tƒ±klanabilir: uyurken uyandƒ±r, uyanƒ±kken uyut
    k.title = 'NatureBot ‚Äî tƒ±kla!';
    k.addEventListener('click', () => {
      const bot = window._natureBotInstance;
      if (!bot) return;
      if (bot.isSleeping) {
        bot.wakeUp();
      } else if (!bot.isAtHome) {
        bot.goToKennel();
      }
    });

    document.body.appendChild(k);
    this.kennelEl = k;

    this._updateKennelPos();
    window.addEventListener('resize', () => this._updateKennelPos());
  }

  _updateKennelPos() {
    if (!this.kennelEl) return;
    const pos = this.getKennelPos();
    this.kennelEl.style.left = pos.x + 'px';
    this.kennelEl.style.top  = pos.y + 'px';
  }

  showKennel() {
    if (!this.kennelEl) return;
    this.kennelEl.style.opacity = '0';
    this.kennelEl.style.display = 'block';
    requestAnimationFrame(() => {
      this.kennelEl.style.transition = 'opacity .8s';
      this.kennelEl.style.opacity = '1';
    });
  }

  hideKennel() {
    if (!this.kennelEl) return;
    this.kennelEl.style.transition = 'opacity .5s';
    this.kennelEl.style.opacity = '0';
    setTimeout(() => { if(this.kennelEl) this.kennelEl.style.display = 'none'; }, 500);
  }

  createZzz() {
    const old = document.getElementById('botZzzContainer');
    if (old) old.remove();
    const z = document.createElement('div');
    z.id = 'botZzzContainer';
    z.innerHTML = '<span class="bot-zzz">z</span><span class="bot-zzz">Z</span><span class="bot-zzz">Z</span>';
    document.body.appendChild(z);
    this.zzzEl = z;
  }

  showZzz() {
    if (!this.zzzEl) return;
    const pos = this.getKennelPos();
    this.zzzEl.style.cssText = 'position:fixed;pointer-events:none;z-index:9999;display:block;left:'+(pos.x+50)+'px;top:'+(pos.y-14)+'px;';
    Array.from(this.zzzEl.children).forEach((z,i) => {
      z.style.cssText = 'position:absolute;font-size:'+(0.65+i*0.18)+'rem;font-weight:900;color:#a5d6a7;opacity:0;animation:zzzFloat 2.5s ease-in-out infinite;animation-delay:'+(i*0.85)+'s;text-shadow:0 0 8px rgba(74,143,64,.5);left:'+(i*10)+'px;top:'+(i*-8)+'px;';
    });
  }

  hideZzz() {
    if (!this.zzzEl) return;
    this.zzzEl.style.display = 'none';
  }

  startWanderDesktop() {
    this.isAtHome = false;
    this.isSleeping = false;
    this.isWaking = false;
    this.el.classList.remove('sleeping','at-home','waking','entering-kennel','exiting-kennel');
    this.el.style.opacity = '1';
    this.el.style.pointerEvents = 'auto';
    this.hideZzz();
    this.hideKennel();
    clearTimeout(this.wanderTimer);
    clearTimeout(this.sleepTimer);
    this.wanderStartTime = Date.now();
    // Gezinme s√ºresi: 15-20 dk sonra kul√ºbeye √ßekil
    this.WANDER_DURATION = (15 + Math.random() * 5) * 60 * 1000;
    const wander = () => {
      if (this.isDragging || this.isCalling || this.isAtHome || this.isSleeping) {
        this.wanderTimer = setTimeout(wander, 800);
        return;
      }
      // S√ºre doldu mu?
      if (Date.now() - this.wanderStartTime >= this.WANDER_DURATION) {
        this.goToKennel();
        return;
      }
      const b = this.getSidebarBounds();
      this.targetX = b.x1 + Math.random() * Math.max(0, b.x2 - b.x1);
      this.targetY = b.y1 + Math.random() * Math.max(0, b.y2 - b.y1);
      this.wanderTimer = setTimeout(wander, 3500 + Math.random() * 5000);
    };
    this.wanderTimer = setTimeout(wander, 1500 + Math.random() * 2000);
  }

  goToKennel() {
    if (this.isSleeping || this.isAtHome) return;
    this.isAtHome = true;
    clearTimeout(this.wanderTimer);
    clearTimeout(this.sleepTimer);

    // Kul√ºbeyi g√∂ster
    this.showKennel();
    this.hideBubble();

    // Kul√ºbenin √∂n√ºne y√ºr√º
    const kPos = this.getKennelPos();
    this.targetX = kPos.x + 26; // kapƒ± √∂n√º
    this.targetY = kPos.y - 48;

    // 2.5 sn y√ºr√ºy√º≈ü ‚Üí giri≈ü animasyonu ‚Üí uyu
    this.sleepTimer = setTimeout(() => {
      this._enterKennelAnimation();
    }, 2500);
  }

  _enterKennelAnimation() {
    if (!this.isAtHome) return;
    // Kapƒ±nƒ±n tam √∂n√ºne snap
    const kPos = this.getKennelPos();
    this.x = kPos.x + 26;
    this.y = kPos.y - 44;
    this.el.style.left = this.x + 'px';
    this.el.style.top  = this.y + 'px';
    // Giri≈ü animasyonu: k√º√ß√ºlerek kapƒ±ya gir
    this.el.classList.add('entering-kennel');
    // Kul√ºbe occupied sƒ±nƒ±fƒ± ‚Üí kapƒ± parlar
    setTimeout(() => {
      if (this.kennelEl) this.kennelEl.classList.add('occupied');
    }, 400);
    // Animasyon bitince uyu
    setTimeout(() => {
      this.el.classList.remove('entering-kennel');
      this.el.style.opacity = '0';
      this.el.style.pointerEvents = 'none';
      this.fallAsleep();
    }, 900);
  }

  fallAsleep() {
    if (!this.isAtHome) return;
    this.isSleeping = true;
    this.hideBubble();

    // Bot kul√ºbenin i√ßinde ‚Äî g√∂r√ºnmez (entering-kennel zaten gizledi)
    this.el.style.opacity = '0';
    this.el.style.pointerEvents = 'none';
    this.el.classList.remove('at-home','talking','entering-kennel');
    this.el.classList.add('sleeping');

    // ZZZ kul√ºbenin √ºst√ºnde g√∂ster
    this.showZzz();

    // Kul√ºbe ƒ±≈üƒ±klarƒ± yakƒ±k (occupied zaten eklendi)
    if (this.kennelEl) this.kennelEl.classList.add('occupied');

    // 45 dk sonra uyan
    this.sleepTimer = setTimeout(() => {
      this.wakeUp();
    }, this.SLEEP_DURATION);
  }

  wakeUp() {
    if (!this.isSleeping) return;
    this.isSleeping = false;
    this.isWaking = true;
    this.isAtHome = false;
    this.hideZzz();

    // Kul√ºbe titreme animasyonu
    if (this.kennelEl) {
      this.kennelEl.classList.add('waking-up');
      setTimeout(() => { if(this.kennelEl) this.kennelEl.classList.remove('waking-up'); }, 600);
    }

    // Botu kapƒ± √∂n√ºne yerle≈ütir
    const kPos = this.getKennelPos();
    this.x = kPos.x + 26;
    this.y = kPos.y - 44;
    this.el.style.left = this.x + 'px';
    this.el.style.top  = this.y + 'px';
    this.el.style.pointerEvents = 'auto';

    // Kul√ºbeden √ßƒ±kƒ±≈ü animasyonu
    this.el.classList.remove('sleeping', 'at-home');
    this.el.classList.add('exiting-kennel');
    this.el.style.opacity = '1';

    setTimeout(() => {
      this.el.classList.remove('exiting-kennel');
      this.el.classList.add('waking');
      // Kul√ºbe ƒ±≈üƒ±klarƒ±nƒ± s√∂nd√ºr
      if (this.kennelEl) this.kennelEl.classList.remove('occupied');
      setTimeout(() => { this.el.classList.remove('waking'); }, 900);
    }, 850);

    // Uyanma mesajƒ±
    const msgs = ['‚òÄÔ∏è Uyandƒ±m! Nasƒ±l yardƒ±mcƒ± olabilirim?', 'üåø G√ºnaydƒ±n! Buradayƒ±m!', 'üòä Dinlendim, hazƒ±rƒ±m!'];
    setTimeout(() => {
      this.showBubble(msgs[Math.floor(Math.random()*msgs.length)], true);
    }, 900);

    // Gezinmeye ba≈üla
    setTimeout(() => {
      this.isWaking = false;
      this.wanderStartTime = Date.now();
      this.WANDER_DURATION = (15 + Math.random() * 5) * 60 * 1000;
      this.startWanderDesktop();
    }, 1800);
  }

  startHomeCheck() {
    // Bu fonksiyon artƒ±k sadece eski compat i√ßin - asƒ±l zamanlayƒ±cƒ± startWanderDesktop'ta
    if (this.homeCheckTimer) clearInterval(this.homeCheckTimer);
  }

  recordInteraction() {
    this.lastInteractTime = Date.now();
    if (this.isSleeping && !IS_MOBILE()) {
      // Uyurken tƒ±klanƒ±nca uyan
      this.wakeUp();
      return;
    }
    if (this.isAtHome && !IS_MOBILE()) {
      this.isAtHome = false;
      this.el.classList.remove('at-home');
      clearTimeout(this.sleepTimer);
      this.startWanderDesktop();
    }
    // Wanderlamayƒ± sƒ±fƒ±rla
    this.wanderStartTime = Date.now();
  }

  loop() {
    if (IS_MOBILE()) return;
    if (!this.isDragging) {
      const speed = this.isCalling ? 0.03 : (this.isSleeping ? 0.04 : (this.isAtHome ? 0.035 : 0.055));
      this.x += (this.targetX - this.x) * speed;
      this.y += (this.targetY - this.y) * speed;
      const b = this.getSidebarBounds();
      // Uyku veya kul√ºbe yolunda sƒ±nƒ±r koyma ‚Äî tam konuma gidebilsin
      if (!this.isSleeping && !this.isAtHome) {
        this.x = Math.max(b.x1-20, Math.min(b.x2+20, this.x));
        this.y = Math.max(b.y1, Math.min(b.y2+30, this.y));
      }
      this.el.style.left = Math.round(this.x) + 'px';
      this.el.style.top  = Math.round(this.y) + 'px';
    }
    if (this.isSleeping) {
      this.el.classList.add('sleeping');
      this.el.classList.remove('at-home');
    } else if (this.isAtHome) {
      this.el.classList.add('at-home');
      this.el.classList.remove('sleeping');
    } else {
      this.el.classList.remove('at-home', 'sleeping');
    }
    this.updateBubblePos();
    this.updateVoiceWavePos();
    this.rafId = requestAnimationFrame(() => this.loop());
  }

  /* ‚îÄ‚îÄ Sesli konu≈üma ‚Äî sadece butonla ‚îÄ‚îÄ */
  speak(text) {
    if (!SPEECH.supported) return;
    // Sadece "Sesli Oku" butonuyla √ßalƒ±≈üƒ±r (mobil ve masa√ºst√º)
    if (!this._speakRequested) return;
    this._speakRequested = false;
    SPEECH.speak(text,
      () => {
        // Ba≈üladƒ±
        this.isTalking = true;
        this.el.classList.add('talking');
        this.voiceWave.classList.add('visible');
        this.updateVoiceWavePos();
      },
      () => {
        // Bitti
        this.isTalking = false;
        this.el.classList.remove('talking');
        this.voiceWave.classList.remove('visible');
      }
    );
  }

  stopSpeaking() {
    SPEECH.stop();
    this.isTalking = false;
    this.el.classList.remove('talking');
    this.voiceWave.classList.remove('visible');
  }

  updateVoiceWavePos() {
    if (!this.voiceWave.classList.contains('visible')) return;
    if (IS_MOBILE()) {
      this.voiceWave.style.right = '62px';
      this.voiceWave.style.top = '80px';
      this.voiceWave.style.left = 'auto';
    } else {
      this.voiceWave.style.left = (this.x + 65) + 'px';
      this.voiceWave.style.top = (this.y + 20) + 'px';
      this.voiceWave.style.right = 'auto';
    }
  }

  bindClick() {
    let touchMoved = false;
    this.el.addEventListener('touchstart', () => { touchMoved = false; }, {passive:true});
    this.el.addEventListener('touchmove', () => { touchMoved = true; }, {passive:true});
    this.el.addEventListener('touchend', (e) => {
      if (!touchMoved) { e.preventDefault(); this._onTap(); }
    });
    this.el.addEventListener('click', (e) => {
      if (!this.isDragging) { e.stopPropagation(); this._onTap(); }
    });

    // Masa√ºst√º s√ºr√ºkleme
    this.el.addEventListener('mousedown', (e) => {
      if (IS_MOBILE()) return;
      this.isDragging = false;
      const sx = e.clientX, sy = e.clientY;
      const ox = e.clientX - this.x, oy = e.clientY - this.y;
      const onMove = (ev) => {
        if (!this.isDragging && (Math.abs(ev.clientX-sx)>4||Math.abs(ev.clientY-sy)>4)) this.isDragging = true;
        if (this.isDragging) {
          this.x = ev.clientX-ox; this.y = ev.clientY-oy;
          this.targetX = this.x; this.targetY = this.y;
          this.el.style.left = this.x+'px'; this.el.style.top = this.y+'px';
          this.updateBubblePos();
        }
      };
      const onUp = () => {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        setTimeout(() => { this.isDragging = false; }, 50);
        this.recordInteraction();
        if (!IS_MOBILE()) this.startWanderDesktop();
      };
      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });

    document.addEventListener('click', (e) => {
      if (!this.el.contains(e.target) && !this.bubble.contains(e.target)) this.hideBubble();
    });
  }

  _onTap() {
    if (this.isSleeping) {
      this.wakeUp();
      return;
    }
    this.recordInteraction();
    if (this.isTalking) {
      this.stopSpeaking();
      return;
    }
    this.showGreeting();
  }

  updateBubblePos() {
    if (!this.bubble.classList.contains('visible')) return;
    if (IS_MOBILE()) {
      const slot = document.getElementById('mobileRobotSlot');
      if (slot) {
        const r = slot.getBoundingClientRect();
        // Balonun sola a√ßƒ±lmasƒ± i√ßin
        let bLeft = r.left - 230;
        if (bLeft < 8) bLeft = 8;
        this.bubble.style.left = bLeft + 'px';
        this.bubble.style.top = (r.bottom + 6) + 'px';
        this.bubble.style.right = 'auto';
        this.bubble.style.position = 'fixed';
      }
      return;
    }
    const botW = 60;
    let bx = this.x + botW + 8;
    if (bx + 240 > window.innerWidth) bx = this.x - 248;
    this.bubble.style.left = Math.max(8, bx) + 'px';
    this.bubble.style.top  = (this.y - 10) + 'px';
    this.bubble.style.right = 'auto';
  }

  showBubble(msg, showCmds=false) {
    clearTimeout(this.bubbleTimeout);

    const speakBtn = SPEECH.supported
      ? `<span class="bot-speak-btn" id="botSpeakBtn" onclick="window._natureBotInstance && window._natureBotInstance._speakBubble(this)">üîä Sesli Oku</span>`
      : '';

    const quickCmds = showCmds ? `<div class="bot-quick-cmds">
      <span class="bot-qcmd" onclick="window._natureBotRunCmd('/hava istanbul')">/hava</span>
      <span class="bot-qcmd" onclick="window._natureBotRunCmd('/flip')">/flip</span>
      <span class="bot-qcmd" onclick="window._natureBotRunCmd('/zar')">/zar</span>
      <span class="bot-qcmd" onclick="window._natureBotRunCmd('/saat')">/saat</span>
      <span class="bot-qcmd" onclick="window._natureBotRunCmd('/yardƒ±m')">/yardƒ±m</span>
    </div>` : '';

    this.bubble.innerHTML = `
      <div class="bot-bubble-name">
        <svg width="10" height="10" viewBox="0 0 12 12"><circle cx="6" cy="6" r="5" fill="#4a8f40" opacity=".3"/><circle cx="6" cy="6" r="3" fill="#6dbf67"/></svg>
        NatureBot
      </div>
      <div class="bot-bubble-msg" id="botBubbleMsg">${msg}</div>
      ${quickCmds}
      <div style="display:flex;align-items:center;gap:6px;margin-top:6px;">
        ${speakBtn}
      </div>
      <div class="bot-bubble-close" onclick="window._natureBotInstance&&window._natureBotInstance.hideBubble()">‚úï</div>
    `;

    if (IS_MOBILE()) {
      this.bubble.style.cssText = 'position:fixed;max-width:200px;';
    } else {
      this.updateBubblePos();
    }
    this.bubble.classList.add('visible');
    this.updateBubblePos();
    this.bubbleTimeout = setTimeout(() => this.hideBubble(), 10000);
    // Ses: sadece "Sesli Oku" butonuyla - otomatik yok
  }

  _speakBubble(btn) {
    const msgEl = document.getElementById('botBubbleMsg');
    if (!msgEl) return;
    if (SPEECH.speaking) {
      this.stopSpeaking();
      btn.textContent = 'üîä Sesli Oku';
      btn.classList.remove('speaking');
      return;
    }
    btn.textContent = '‚èπ Durdur';
    btn.classList.add('speaking');
    this._speakRequested = true;
    // onEnd callback'i doƒürudan SPEECH.speak'e ge√ßir
    const onEnd = () => {
      this.isTalking = false;
      this.el.classList.remove('talking');
      this.voiceWave.classList.remove('visible');
      btn.textContent = 'üîä Sesli Oku';
      btn.classList.remove('speaking');
    };
    const msgText = msgEl.textContent;
    // SPEECH.speak'i direkt √ßaƒüƒ±r (speak() wrapper'ƒ±nƒ± bypass ederek callback ilet)
    SPEECH.speak(msgText,
      () => {
        this.isTalking = true;
        this.el.classList.add('talking');
        this.voiceWave.classList.add('visible');
        this.updateVoiceWavePos();
      },
      onEnd
    );
  }

  hideBubble() {
    this.bubble.classList.remove('visible');
    this.stopSpeaking();
  }

  showGreeting() {
    const msg = GREETING_MSGS[Math.floor(Math.random() * GREETING_MSGS.length)];
    this.showBubble(msg, true);
  }

  scheduleIdleMsg() {
    clearTimeout(this.idleTimeout);
    const delay = 35000 + Math.random() * 35000;
    this.idleTimeout = setTimeout(() => {
      // Otomatik a√ßƒ±lmƒ±yor ‚Äî sadece zaten a√ßƒ±ksa mesajƒ± g√ºncelle
      // (bubble'ƒ± kullanƒ±cƒ± tƒ±klamadan a√ßmƒ±yoruz)
      this.scheduleIdleMsg();
    }, delay);
  }

  hookCallScreen() {
    const check = () => {
      const cs = document.getElementById('callScreen');
      if (!cs) { setTimeout(check, 1500); return; }
      new MutationObserver(() => {
        const vis = cs.style.display !== 'none' && cs.style.display !== '';
        if (vis && !this.isCalling) this.enterCallMode();
        else if (!vis && this.isCalling) this.exitCallMode();
      }).observe(cs, { attributes:true, attributeFilter:['style'] });
    };
    check();
  }

  enterCallMode() {
    this.isCalling = true;
    this.el.classList.add('calling');
    clearTimeout(this.wanderTimer);
    if (!IS_MOBILE()) {
      const av = document.getElementById('callAvatar');
      if (av) { const r=av.getBoundingClientRect(); this.targetX=r.left+r.width/2-30; this.targetY=r.top-95; }
      else { this.targetX=window.innerWidth/2-30; this.targetY=window.innerHeight/2-120; }
    }
    const name = (document.getElementById('callName')||{}).textContent || '...';
    this.showBubble(`üìû ${name} ile baƒülantƒ± kuruluyor! üåø`, false);
  }

  exitCallMode() {
    this.isCalling = false;
    this.el.classList.remove('calling');
    this.hideBubble();
    if (!IS_MOBILE() && !this.isSleeping) this.startWanderDesktop();
  }
}

/* ‚îÄ‚îÄ Global k√∂pr√ºler ‚îÄ‚îÄ */
window._natureBotRunCmd = function(cmd) {
  runBotCmd(cmd, true);
};

/* ‚îÄ‚îÄ Ba≈ülat ‚îÄ‚îÄ */
function startNatureBot() {
  if (document.getElementById('natureBotPet')) return;
  window._natureBotInstance = new NatureBotPet();
}

const _nbLoginObs = new MutationObserver(() => {
  const login = document.getElementById('loginScreen');
  if (login && (login.style.display === 'none' || !login.classList.contains('active'))) {
    setTimeout(startNatureBot, 800);
  }
});
const _nbLoginEl = document.getElementById('loginScreen');
if (_nbLoginEl) _nbLoginObs.observe(_nbLoginEl, { attributes: true });

setTimeout(() => {
  const login = document.getElementById('loginScreen');
  if (!login || login.style.display === 'none' || getComputedStyle(login).display === 'none') {
    startNatureBot();
  }
}, 2500);

})();
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     üöÄ NATURE.CO MODERNƒ∞ZASYON PAKETƒ∞ v2.0
     Eklenen √∂zellikler:
     1. üåô Sistem Temasƒ± Algƒ±lama (OS dark/light mode sync)
     2. ü§ñ AI Mesaj Asistanƒ± (Anthropic Claude API)
     3. üåç Anlƒ±k Mesaj √áevirisi (MyMemory API)
     4. üéµ M√ºzik Odasƒ± (YouTube Firebase Sync)
     5. ‚úÖ Toplu Mesaj Se√ßimi (Long press multi-select)
     6. ‚è∞ Mesaj Zamanlayƒ±cƒ± (Schedule messages)
     7. üé® √ñzel Sticker Paketi (Upload & use stickers)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üöÄ MODERNƒ∞ZASYON PACK ‚Äî GLOBAL STƒ∞LLER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ 1. Sistem Temasƒ± Toggle ‚îÄ‚îÄ */
.sys-theme-toggle {
  display: flex; align-items: center; gap: 8px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 8px 12px;
  cursor: pointer; user-select: none;
  font-size: .82rem; color: var(--text);
  transition: background .15s;
}
.sys-theme-toggle:hover { background: var(--surface2); }
.sys-theme-badge {
  font-size: .65rem; font-weight: 900; padding: 2px 7px;
  border-radius: 100px; background: rgba(91,155,213,.15);
  color: #5b9bd5; border: 1px solid rgba(91,155,213,.25);
}

/* ‚îÄ‚îÄ 2. AI Asistan Panel ‚îÄ‚îÄ */
#aiAssistPanel {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.75);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  z-index: 7000;
  display: none; align-items: flex-end; justify-content: center;
  padding: 0;
}
#aiAssistPanel.open { display: flex; }
.ai-panel-card {
  width: 100%; max-width: 640px;
  background: var(--bg2);
  border-radius: 24px 24px 0 0;
  border: 1px solid rgba(255,255,255,.08);
  border-bottom: none;
  box-shadow: 0 -8px 40px rgba(0,0,0,.6);
  animation: slideUp .3s cubic-bezier(.34,1.2,.64,1) both;
  max-height: 80vh;
  display: flex; flex-direction: column;
}
@media(min-width:640px) {
  #aiAssistPanel { align-items: center; padding: 20px; }
  .ai-panel-card { border-radius: 20px; border: 1px solid rgba(255,255,255,.08); }
}
@keyframes slideUp {
  from { transform: translateY(40px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}
.ai-panel-header {
  display: flex; align-items: center; gap: 10px;
  padding: 16px 18px 12px;
  border-bottom: 1px solid rgba(255,255,255,.06);
  flex-shrink: 0;
}
.ai-panel-title {
  flex: 1; font-size: 1rem; font-weight: 900;
  background: linear-gradient(135deg, #a855f7, #6c63ff);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.ai-panel-close {
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--surface2); display: flex;
  align-items: center; justify-content: center;
  cursor: pointer; color: var(--muted); font-size: .8rem;
  border: none; transition: background .15s;
}
.ai-panel-close:hover { background: var(--border); color: var(--text-hi); }
.ai-panel-body { padding: 16px 18px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
.ai-panel-body::-webkit-scrollbar { display: none; }

.ai-inp-area {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  transition: border-color .15s;
}
.ai-inp-area:focus-within { border-color: rgba(168,85,247,.4); }
.ai-inp-area textarea {
  width: 100%; background: none; border: none; outline: none;
  color: var(--text-hi); font-size: .9rem; font-family: inherit;
  resize: none; min-height: 72px; line-height: 1.55;
}
.ai-inp-area textarea::placeholder { color: var(--muted); }

.ai-result-box {
  background: linear-gradient(135deg, rgba(108,99,255,.08), rgba(168,85,247,.06));
  border: 1px solid rgba(168,85,247,.2);
  border-radius: 12px;
  padding: 14px;
  display: none;
}
.ai-result-box.show { display: block; }
.ai-result-label {
  font-size: .65rem; font-weight: 900; color: #a855f7;
  text-transform: uppercase; letter-spacing: .08em; margin-bottom: 8px;
}
.ai-result-text {
  font-size: .9rem; color: var(--text-hi); line-height: 1.6;
  white-space: pre-wrap;
}
.ai-result-actions {
  display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;
}
.ai-action-btn {
  padding: 7px 14px; border-radius: 8px; font-size: .78rem;
  font-weight: 800; cursor: pointer; border: none;
  font-family: inherit; transition: all .15s;
}
.ai-action-btn.primary {
  background: linear-gradient(135deg, #6c63ff, #a855f7);
  color: #fff; box-shadow: 0 2px 8px rgba(108,99,255,.3);
}
.ai-action-btn.primary:hover { filter: brightness(1.1); }
.ai-action-btn.secondary {
  background: var(--surface2); color: var(--muted);
  border: 1px solid var(--border);
}
.ai-action-btn.secondary:hover { color: var(--text-hi); }

.ai-style-row {
  display: flex; gap: 6px; flex-wrap: wrap;
}
.ai-style-chip {
  padding: 5px 11px; border-radius: 100px;
  font-size: .72rem; font-weight: 700;
  border: 1px solid var(--border);
  background: var(--surface); color: var(--muted);
  cursor: pointer; transition: all .15s;
}
.ai-style-chip.sel {
  background: rgba(108,99,255,.15);
  border-color: rgba(108,99,255,.4);
  color: #a855f7;
}

.ai-loading {
  display: none; align-items: center; gap: 10px;
  padding: 12px; color: var(--muted); font-size: .85rem;
}
.ai-loading.show { display: flex; }
.ai-loading-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: #a855f7;
  animation: aiDot 1.2s ease-in-out infinite;
}
.ai-loading-dot:nth-child(2) { animation-delay: .15s; }
.ai-loading-dot:nth-child(3) { animation-delay: .3s; }
@keyframes aiDot { 0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1} }

.ai-key-row {
  display: flex; gap: 8px; align-items: center;
}
.ai-key-inp {
  flex: 1; background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; padding: 8px 11px;
  color: var(--text-hi); font-size: .82rem; font-family: inherit;
  outline: none; transition: border-color .15s;
}
.ai-key-inp:focus { border-color: rgba(168,85,247,.4); }
.ai-key-inp::placeholder { color: var(--muted); }

/* AI buton mesaj inputu yanƒ±nda */
.ai-assist-btn {
  width: 32px; height: 32px; border-radius: 8px;
  background: linear-gradient(135deg, rgba(108,99,255,.2), rgba(168,85,247,.15));
  border: 1px solid rgba(108,99,255,.3);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: .9rem; transition: all .15s;
  flex-shrink: 0;
}
.ai-assist-btn:hover {
  background: linear-gradient(135deg, rgba(108,99,255,.35), rgba(168,85,247,.25));
  transform: scale(1.05);
}

/* ‚îÄ‚îÄ 3. √áeviri Tooltip ‚îÄ‚îÄ */
.translate-bubble {
  position: fixed; z-index: 9000;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 10px 14px;
  max-width: 300px;
  box-shadow: 0 8px 24px rgba(0,0,0,.5);
  font-size: .82rem; color: var(--text-hi); line-height: 1.5;
  display: none;
  animation: popIn .2s ease both;
}
.translate-bubble.show { display: block; }
.translate-bubble-label {
  font-size: .62rem; color: var(--muted); font-weight: 700;
  text-transform: uppercase; letter-spacing: .06em;
  margin-bottom: 5px; display: flex; align-items: center; gap: 5px;
}
.translate-bubble-text { color: var(--text-hi); }
.translate-bubble-close {
  position: absolute; top: 6px; right: 8px;
  cursor: pointer; color: var(--muted); font-size: .9rem;
}
@keyframes popIn {
  from { transform: scale(.85); opacity: 0; }
  to   { transform: scale(1); opacity: 1; }
}
.translate-lang-sel {
  display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap;
}
.translate-lang-chip {
  padding: 3px 8px; border-radius: 100px; font-size: .65rem;
  font-weight: 700; border: 1px solid var(--border);
  background: var(--surface); color: var(--muted);
  cursor: pointer; transition: all .12s;
}
.translate-lang-chip.sel {
  background: rgba(46,204,113,.15); border-color: rgba(46,204,113,.3); color: #2ecc71;
}

/* ‚îÄ‚îÄ 4. M√ºzik Odasƒ± ‚îÄ‚îÄ */
#musicRoomPanel {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.85);
  backdrop-filter: blur(16px);
  z-index: 7500;
  display: none; flex-direction: column;
}
#musicRoomPanel.open { display: flex; }
.music-header {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 18px;
  padding-top: calc(14px + env(safe-area-inset-top, 0px));
  background: rgba(0,0,0,.4);
  border-bottom: 1px solid rgba(255,255,255,.07);
  flex-shrink: 0;
}
.music-title {
  flex: 1; font-size: 1rem; font-weight: 900; color: #fff;
  display: flex; align-items: center; gap: 8px;
}
.music-live-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: #e05555; animation: watchPulse 1.2s ease infinite;
  display: inline-block;
}
.music-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.music-player-wrap {
  background: #000;
  display: flex; align-items: center; justify-content: center;
  aspect-ratio: 16/9; flex-shrink: 0; position: relative;
}
.music-player-wrap iframe { width: 100%; height: 100%; border: none; }
.music-controls {
  flex: 1; padding: 14px 18px; overflow-y: auto;
  display: flex; flex-direction: column; gap: 12px;
}
.music-controls::-webkit-scrollbar { display: none; }
.music-url-row {
  display: flex; gap: 8px;
}
.music-url-inp {
  flex: 1; background: var(--surface);
  border: 1px solid var(--border); border-radius: 10px;
  padding: 10px 13px; color: var(--text-hi);
  font-size: .85rem; font-family: inherit; outline: none;
  transition: border-color .15s;
}
.music-url-inp:focus { border-color: #e05555; }
.music-url-inp::placeholder { color: var(--muted); }
.music-play-btn {
  background: #e05555; border: none; border-radius: 10px;
  color: #fff; padding: 0 16px; font-size: .85rem;
  font-weight: 800; cursor: pointer; font-family: inherit;
  transition: opacity .15s; white-space: nowrap;
}
.music-play-btn:hover { opacity: .85; }
.music-queue-title {
  font-size: .7rem; font-weight: 900; color: var(--muted);
  text-transform: uppercase; letter-spacing: .08em;
  display: flex; align-items: center; gap: 6px;
}
.music-queue-title::before {
  content: ''; display: inline-block; width: 3px; height: 11px;
  background: #e05555; border-radius: 2px;
}
.music-queue-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 12px; background: var(--surface);
  border: 1px solid var(--border); border-radius: 10px;
  font-size: .82rem; color: var(--text);
}
.music-queue-item.now-playing {
  background: rgba(224,85,85,.1); border-color: rgba(224,85,85,.3);
  color: #ff6b6b;
}
.music-queue-item .mq-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.music-queue-item .mq-remove { cursor: pointer; color: var(--muted); padding: 2px 6px; border-radius: 4px; transition: color .15s; }
.music-queue-item .mq-remove:hover { color: #e05555; }
.music-sync-info {
  font-size: .72rem; color: var(--muted);
  text-align: center; padding: 4px;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.music-participants {
  display: flex; gap: 4px; flex-wrap: wrap;
}
.music-participant-av {
  width: 28px; height: 28px; border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  font-size: .55rem; font-weight: 900; color: #fff;
}

/* ‚îÄ‚îÄ 5. Toplu Mesaj Se√ßimi ‚îÄ‚îÄ */
.multi-select-bar {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--surface2);
  border-top: 1px solid var(--border);
  padding: 12px 16px;
  padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
  display: none; align-items: center; gap: 12px;
  z-index: 5000;
  animation: slideUp .2s ease both;
}
.multi-select-bar.show { display: flex; }
.multi-select-count {
  flex: 1; font-size: .88rem; font-weight: 700; color: var(--text-hi);
}
.multi-select-del {
  background: rgba(224,85,85,.15); color: #e05555;
  border: 1px solid rgba(224,85,85,.25);
  border-radius: 8px; padding: 8px 16px;
  font-size: .82rem; font-weight: 800;
  cursor: pointer; font-family: inherit;
  transition: all .15s;
}
.multi-select-del:hover { background: rgba(224,85,85,.25); }
.multi-select-cancel {
  background: var(--surface); color: var(--muted);
  border: 1px solid var(--border);
  border-radius: 8px; padding: 8px 14px;
  font-size: .82rem; font-weight: 700;
  cursor: pointer; font-family: inherit;
  transition: all .15s;
}
.multi-select-cancel:hover { color: var(--text-hi); }

/* Message checkbox */
.mb-check {
  width: 20px; height: 20px; border-radius: 50%;
  border: 2px solid var(--border);
  background: var(--surface);
  display: none; align-items: center; justify-content: center;
  cursor: pointer; flex-shrink: 0; transition: all .15s;
  position: absolute; left: -30px; top: 50%; transform: translateY(-50%);
}
.multi-select-mode .mb { position: relative; padding-left: 32px; cursor: pointer; }
.multi-select-mode .mb-check { display: flex; }
.mb.selected .mb-check {
  background: #5b9bd5; border-color: #5b9bd5;
}
.mb.selected .mb-check::after {
  content: '‚úì'; color: #fff; font-size: .7rem; font-weight: 900;
}
.mb.selected { background: rgba(91,155,213,.08); border-radius: 8px; }

/* ‚îÄ‚îÄ 6. Mesaj Zamanlayƒ±cƒ± ‚îÄ‚îÄ */
#scheduleMsgPanel {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.75);
  backdrop-filter: blur(10px);
  z-index: 7200;
  align-items: center; justify-content: center;
  padding: 20px;
}
#scheduleMsgPanel.open { display: flex; }
.schedule-card {
  width: 100%; max-width: 420px;
  background: var(--bg2);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 8px 40px rgba(0,0,0,.6);
  animation: popIn .25s ease both;
}
.schedule-title {
  font-size: 1rem; font-weight: 900; color: var(--text-hi);
  margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
}
.schedule-inp {
  width: 100%; background: var(--surface);
  border: 1px solid var(--border); border-radius: 10px;
  padding: 10px 13px; color: var(--text-hi);
  font-size: .88rem; font-family: inherit;
  outline: none; margin-bottom: 10px;
  transition: border-color .15s; -webkit-appearance: none;
}
.schedule-inp:focus { border-color: rgba(240,192,64,.4); }
.schedule-inp::placeholder { color: var(--muted); }
.schedule-btns { display: flex; gap: 8px; margin-top: 4px; }
.schedule-confirm {
  flex: 1; padding: 11px;
  background: linear-gradient(135deg, #f0c040, #e0a030);
  border: none; border-radius: 10px; color: #000;
  font-size: .88rem; font-weight: 900;
  cursor: pointer; font-family: inherit;
  transition: filter .15s;
}
.schedule-confirm:hover { filter: brightness(1.08); }
.schedule-cancel-btn {
  padding: 11px 18px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; color: var(--muted);
  font-size: .88rem; font-weight: 700;
  cursor: pointer; font-family: inherit;
  transition: all .15s;
}
.schedule-cancel-btn:hover { color: var(--text-hi); }

/* Scheduled badge on message */
.scheduled-badge {
  display: inline-flex; align-items: center; gap: 4px;
  background: rgba(240,192,64,.12); border: 1px solid rgba(240,192,64,.25);
  border-radius: 100px; padding: 2px 8px;
  font-size: .62rem; font-weight: 700; color: #f0c040;
  margin-top: 4px;
}

/* Scheduled messages list */
.scheduled-list-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 13px; background: var(--surface);
  border: 1px solid var(--border); border-radius: 10px;
  margin-bottom: 8px; font-size: .82rem;
}
.scheduled-list-item .sl-text {
  flex: 1; color: var(--text); overflow: hidden;
  text-overflow: ellipsis; white-space: nowrap;
}
.scheduled-list-item .sl-time {
  font-size: .68rem; color: var(--muted); flex-shrink: 0;
}
.scheduled-list-item .sl-cancel {
  cursor: pointer; color: var(--muted); padding: 2px 6px;
  border-radius: 5px; transition: color .15s;
}
.scheduled-list-item .sl-cancel:hover { color: #e05555; }

/* ‚îÄ‚îÄ 7. Sticker Pack ‚îÄ‚îÄ */
.sticker-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
  padding: 8px 0;
}
.sticker-item {
  aspect-ratio: 1; border-radius: 10px;
  overflow: hidden; cursor: pointer;
  background: var(--surface2);
  border: 2px solid transparent;
  transition: all .15s;
  display: flex; align-items: center; justify-content: center;
}
.sticker-item:hover {
  border-color: var(--accent); transform: scale(1.05);
}
.sticker-item img { width: 100%; height: 100%; object-fit: contain; }
.sticker-upload-btn {
  aspect-ratio: 1; border-radius: 10px;
  background: var(--surface);
  border: 2px dashed var(--border);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  cursor: pointer; gap: 4px;
  transition: border-color .15s; color: var(--muted);
  font-size: .62rem; font-weight: 700;
}
.sticker-upload-btn:hover { border-color: var(--accent); color: var(--text-hi); }
.sticker-upload-btn .su-icon { font-size: 1.4rem; }

/* ‚îÄ‚îÄ M√ºzik Odasƒ± butonu header'da ‚îÄ‚îÄ */
.music-room-btn {
  width: 30px; height: 30px; border-radius: 8px;
  background: rgba(224,85,85,.12); border: 1px solid rgba(224,85,85,.2);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: .85rem; transition: all .15s;
  flex-shrink: 0;
}
.music-room-btn:hover { background: rgba(224,85,85,.22); }

/* Schedule butonu send area'da */
.schedule-msg-btn {
  width: 32px; height: 32px; border-radius: 8px;
  background: rgba(240,192,64,.1); border: 1px solid rgba(240,192,64,.2);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: .82rem; transition: all .15s;
  flex-shrink: 0;
}
.schedule-msg-btn:hover { background: rgba(240,192,64,.2); }

/* ‚îÄ‚îÄ Sistem Temasƒ± bildirim banner ‚îÄ‚îÄ */
.sys-theme-banner {
  display: none;
  position: fixed; top: 60px; left: 50%; transform: translateX(-50%);
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 100px; padding: 8px 16px;
  font-size: .8rem; color: var(--text);
  z-index: 9999; box-shadow: 0 4px 20px rgba(0,0,0,.4);
  white-space: nowrap; animation: fadeInBanner .3s ease both;
}
.sys-theme-banner.show { display: block; }
@keyframes fadeInBanner {
  from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
  to   { opacity: 1; transform: translateX(-50%) translateY(0); }
}
</style>

<!-- ‚îÄ‚îÄ HTML: AI Asistan Panel ‚îÄ‚îÄ -->
<div id="aiAssistPanel" onclick="event.target===this&&closeAiPanel()">
  <div class="ai-panel-card">
    <div class="ai-panel-header">
      <span style="font-size:1.3rem;">ü§ñ</span>
      <div class="ai-panel-title">AI Mesaj Asistanƒ±</div>
      <button class="ai-panel-close" onclick="closeAiPanel()">‚úï</button>
    </div>
    <div class="ai-panel-body">
      <!-- API Key row (collapsible) -->
      <div id="aiKeySection" style="display:none;">
        <div style="font-size:.72rem;color:var(--muted);margin-bottom:6px;font-weight:700;">OpenRouter API Key <span style="color:#4caf50;font-size:.7rem;">(√úcretsiz)</span></div>
        <div class="ai-key-row">
          <input type="password" class="ai-key-inp" id="aiApiKeyInp" placeholder="sk-or-..." autocomplete="off">
          <button class="ai-action-btn primary" onclick="saveAiKey()" style="white-space:nowrap;">Kaydet</button>
        </div>
        <div style="font-size:.68rem;color:var(--muted);margin-top:4px;">√úcretsiz key i√ßin ‚Üí <a href="https://openrouter.ai/keys" target="_blank" style="color:var(--purple);">openrouter.ai/keys</a> &nbsp;|&nbsp; Tarayƒ±cƒ±nƒ±zda saklanƒ±r.</div>
      </div>

      <!-- Stil se√ßimi -->
      <div>
        <div style="font-size:.72rem;color:var(--muted);margin-bottom:8px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;">Mesaj Tonu</div>
        <div class="ai-style-row" id="aiStyleRow">
          <div class="ai-style-chip sel" data-style="casual" onclick="selectAiStyle(this)">üòä Samimi</div>
          <div class="ai-style-chip" data-style="formal" onclick="selectAiStyle(this)">üëî Resmi</div>
          <div class="ai-style-chip" data-style="funny" onclick="selectAiStyle(this)">üòÇ Esprili</div>
          <div class="ai-style-chip" data-style="kind" onclick="selectAiStyle(this)">üíù Nazik</div>
          <div class="ai-style-chip" data-style="direct" onclick="selectAiStyle(this)">‚ö° Doƒürudan</div>
        </div>
      </div>

      <!-- Girdi alanƒ± -->
      <div class="ai-inp-area">
        <textarea id="aiPromptInp" placeholder="Ne s√∂ylemek istiyorsun? Kabaca yaz, ben d√ºzeltirim...
√ñrnek: arkada≈üƒ±ma bug√ºn gelemeyeceƒüimi s√∂yle" rows="3"></textarea>
      </div>

      <button class="ai-action-btn primary" onclick="runAiAssist()" style="width:100%;padding:12px;font-size:.88rem;">
        ‚ú® AI ile Geli≈ütir
      </button>

      <!-- Loading -->
      <div class="ai-loading" id="aiLoading">
        <div class="ai-loading-dot"></div>
        <div class="ai-loading-dot"></div>
        <div class="ai-loading-dot"></div>
        <span>AI d√º≈ü√ºn√ºyor...</span>
      </div>

      <!-- Sonu√ß -->
      <div class="ai-result-box" id="aiResultBox">
        <div class="ai-result-label">‚ú® AI √ñnerisi</div>
        <div class="ai-result-text" id="aiResultText"></div>
        <div class="ai-result-actions">
          <button class="ai-action-btn primary" onclick="useAiResult()">üì• Giri≈ü Kutusuna Yapƒ±≈ütƒ±r</button>
          <button class="ai-action-btn secondary" onclick="copyAiResult()">üìã Kopyala</button>
          <button class="ai-action-btn secondary" onclick="runAiAssist()">üîÑ Tekrar Dene</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ HTML: √áeviri Bubble ‚îÄ‚îÄ -->
<div class="translate-bubble" id="translateBubble">
  <div class="translate-bubble-close" onclick="closeTranslateBubble()">‚úï</div>
  <div class="translate-bubble-label">
    <span>üåç</span> √áeviri
  </div>
  <div class="translate-lang-sel" id="translateLangSel">
    <div class="translate-lang-chip sel" data-lang="tr|en" onclick="switchTranslateLang(this,'tr|en')">TR‚ÜíEN</div>
    <div class="translate-lang-chip" data-lang="en|tr" onclick="switchTranslateLang(this,'en|tr')">EN‚ÜíTR</div>
    <div class="translate-lang-chip" data-lang="tr|de" onclick="switchTranslateLang(this,'tr|de')">TR‚ÜíDE</div>
    <div class="translate-lang-chip" data-lang="tr|fr" onclick="switchTranslateLang(this,'tr|fr')">TR‚ÜíFR</div>
    <div class="translate-lang-chip" data-lang="tr|ar" onclick="switchTranslateLang(this,'tr|ar')">TR‚ÜíAR</div>
  </div>
  <div class="translate-bubble-text" id="translateBubbleText">...</div>
</div>

<!-- ‚îÄ‚îÄ HTML: M√ºzik Odasƒ± Panel ‚îÄ‚îÄ -->
<div id="musicRoomPanel">
  <div class="music-header">
    <div class="music-title">
      <div class="music-live-dot" id="musicLiveDot" style="display:none;"></div>
      üéµ M√ºzik Odasƒ±
      <span id="musicRoomName" style="color:var(--muted);font-size:.78rem;"></span>
    </div>
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="musicParticipants" class="music-participants"></div>
      <div onclick="closeMusicRoom()" style="width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;cursor:pointer;color:rgba(255,255,255,.7);font-size:.9rem;transition:background .15s;" onmouseover="this.style.background='rgba(255,255,255,.15)'" onmouseout="this.style.background='rgba(255,255,255,.08)'">‚úï</div>
    </div>
  </div>
  <div class="music-body">
    <div class="music-player-wrap" id="musicPlayerWrap">
      <div id="musicPlayerPlaceholder" style="text-align:center;color:rgba(255,255,255,.3);padding:20px;">
        <div style="font-size:3rem;margin-bottom:8px;">üéµ</div>
        <div style="font-weight:700;">Bir YouTube linki gir</div>
        <div style="font-size:.8rem;margin-top:4px;opacity:.6;">Oda herkesiyle senkronize √ßalƒ±nƒ±r</div>
      </div>
      <div id="musicYTFrame" style="width:100%;height:100%;display:none;position:absolute;inset:0;"></div>
    </div>
    <div class="music-controls">
      <div class="music-url-row">
        <input type="text" class="music-url-inp" id="musicUrlInp" placeholder="YouTube linki veya video ID...">
        <button class="music-play-btn" onclick="startMusicSync()">‚ñ∂ Oynat</button>
      </div>
      <div class="music-sync-info" id="musicSyncInfo" style="display:none;">
        <div class="music-live-dot"></div>
        <span id="musicSyncText">Senkronize ediliyor...</span>
      </div>
      <div class="music-queue-title">üé∂ Sƒ±ra</div>
      <div id="musicQueue"></div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ HTML: Zamanlƒ± Mesaj Panel ‚îÄ‚îÄ -->
<div id="scheduleMsgPanel" onclick="event.target===this&&closeSchedulePanel()">
  <div class="schedule-card">
    <div class="schedule-title">‚è∞ Mesaj Zamanla</div>
    <textarea class="schedule-inp" id="scheduleMsgText" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." rows="3" style="resize:vertical;"></textarea>
    <input type="datetime-local" class="schedule-inp" id="scheduleMsgTime">
    <div style="font-size:.72rem;color:var(--muted);margin-bottom:10px;">Bu sayfayƒ± a√ßƒ±k tutmanƒ±z gerekiyor. Mesaj o saatte g√∂nderilir.</div>
    <div class="schedule-btns">
      <button class="schedule-confirm" onclick="confirmScheduleMsg()">‚è∞ Zamanla</button>
      <button class="schedule-cancel-btn" onclick="closeSchedulePanel()">ƒ∞ptal</button>
    </div>
    <!-- Existing scheduled -->
    <div id="scheduledMsgList" style="margin-top:14px;"></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ HTML: Toplu Se√ßim Bar ‚îÄ‚îÄ -->
<div class="multi-select-bar" id="multiSelectBar">
  <div class="multi-select-count" id="multiSelectCount">0 mesaj se√ßildi</div>
  <button class="multi-select-cancel" onclick="exitMultiSelect()">ƒ∞ptal</button>
  <button class="multi-select-del" onclick="deleteSelectedMsgs()">üóë Sil</button>
</div>

<!-- ‚îÄ‚îÄ HTML: Sistem Tema Banner ‚îÄ‚îÄ -->
<div class="sys-theme-banner" id="sysThemeBanner"></div>

<script>
(function() {
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   1. üåô Sƒ∞STEM TEMASI ALGILAMA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _sysThemeEnabled = localStorage.getItem('nc_sysTheme') === '1';

function applySysTheme(dark) {
  if (!_sysThemeEnabled) return;
  const body = document.body;
  const targetTheme = dark ? 'dark' : 'latte';
  if (body.getAttribute('data-theme') !== targetTheme) {
    body.setAttribute('data-theme', targetTheme);
    const banner = document.getElementById('sysThemeBanner');
    if (banner) {
      banner.textContent = dark ? 'üåô Koyu tema uygulandƒ±' : '‚òÄÔ∏è A√ßƒ±k tema uygulandƒ±';
      banner.classList.add('show');
      setTimeout(() => banner.classList.remove('show'), 2500);
    }
  }
}

function initSysTheme() {
  if (!window.matchMedia) return;
  const mq = window.matchMedia('(prefers-color-scheme: dark)');
  applySysTheme(mq.matches);
  mq.addEventListener('change', e => applySysTheme(e.matches));
}

function toggleSysTheme() {
  _sysThemeEnabled = !_sysThemeEnabled;
  localStorage.setItem('nc_sysTheme', _sysThemeEnabled ? '1' : '0');
  if (_sysThemeEnabled) {
    initSysTheme();
    showToast('üåô Sistem temasƒ± algƒ±lama: A√áIK');
  } else {
    showToast('üé® Manuel tema kontrol√º: A√áIK');
  }
  // Update toggle UI if visible
  const btn = document.getElementById('sysThemeToggleBtn');
  if (btn) btn.querySelector('.sys-theme-badge').textContent = _sysThemeEnabled ? 'A√áIK' : 'KAPALI';
}

if (_sysThemeEnabled) {
  // Apply after a short delay so existing theme logic has run first
  setTimeout(initSysTheme, 1000);
}

// Inject system theme toggle into profile/settings area
function injectSysThemeToggle() {
  // Find theme section in profile
  const appearanceSections = document.querySelectorAll('.ui-style-card, [data-theme-section]');
  // We'll add a persistent button in settings when they open
  const settingsBtn = document.getElementById('sysThemeToggleBtn');
  if (!settingsBtn) {
    // Hook into profile screen loading
    const profTheme = document.querySelector('#profileScreen .prof-section-title');
    if (profTheme) {
      const toggleRow = document.createElement('div');
      toggleRow.style.cssText = 'padding: 4px 0 12px;';
      toggleRow.innerHTML = `
        <div class="sys-theme-toggle" id="sysThemeToggleBtn" onclick="toggleSysTheme()">
          <span>üåô</span>
          <span style="flex:1;">Sistem temasƒ±nƒ± otomatik uygula</span>
          <div class="sys-theme-badge">${_sysThemeEnabled ? 'A√áIK' : 'KAPALI'}</div>
        </div>
      `;
      profTheme.after(toggleRow);
    }
  }
}

setTimeout(injectSysThemeToggle, 3000);
window._toggleSysTheme = toggleSysTheme;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   2. ü§ñ AI MESAJ ASƒ∞STANI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _aiStyle = 'casual';
let _aiResult = '';

function openAiPanel() {
  const panel = document.getElementById('aiAssistPanel');
  if (!panel) return;
  panel.classList.add('open');
  // Key g√∂m√ºl√º olduƒüu i√ßin key section her zaman gizli
  const keySection = document.getElementById('aiKeySection');
  if (keySection) keySection.style.display = 'none';
}

function closeAiPanel() {
  const panel = document.getElementById('aiAssistPanel');
  if (panel) panel.classList.remove('open');
}

function saveAiKey() {
  const inp = document.getElementById('aiApiKeyInp');
  if (!inp || !inp.value.trim()) return;
  localStorage.setItem('nc_openrouter_key', inp.value.trim());
  document.getElementById('aiKeySection').style.display = 'none';
  showToast('üîë API key kaydedildi');
}

function selectAiStyle(el) {
  document.querySelectorAll('.ai-style-chip').forEach(c => c.classList.remove('sel'));
  el.classList.add('sel');
  _aiStyle = el.dataset.style;
}

async function runAiAssist() {
  const prompt = (document.getElementById('aiPromptInp')?.value || '').trim();
  if (!prompt) { showToast('√ñnce ne s√∂ylemek istediƒüini yaz!'); return; }

  // G√∂m√ºl√º API key (√∂nce g√∂m√ºl√º, sonra Firebase, sonra localStorage)
  let apiKey = '';
  if (!apiKey) {
    try {
      const snap = await dbRef('settings/openrouterKey').once('value');
      apiKey = snap.val() || null;
    } catch(e) {}
  }
  if (!apiKey) apiKey = localStorage.getItem('nc_openrouter_key');
  if (!apiKey) {
    document.getElementById('aiKeySection').style.display = 'block';
    showToast('‚ö†Ô∏è √ñnce OpenRouter API key giriniz');
    return;
  }

  const styleMap = {
    casual: 'samimi ve arkada≈ü√ßa',
    formal: 'resmi ve profesyonel',
    funny: 'esprili ve eƒülenceli',
    kind: 'nazik ve sƒ±cak',
    direct: 'kƒ±sa ve doƒürudan',
  };

  const loading = document.getElementById('aiLoading');
  const resultBox = document.getElementById('aiResultBox');
  if (loading) loading.classList.add('show');
  if (resultBox) resultBox.classList.remove('show');

  try {
    const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + apiKey,
        'HTTP-Referer': location.origin,
        'X-Title': 'Nature.co AI Asistan',
      },
      body: JSON.stringify({
        model: 'meta-llama/llama-3.1-8b-instruct:free',
        max_tokens: 400,
        messages: [{
          role: 'user',
          content: `T√ºrk√ße bir sohbet mesajƒ± yaz. Ton: ${styleMap[_aiStyle]}. ƒ∞stek: ${prompt}. Sadece mesajƒ± yaz, a√ßƒ±klama ekleme. Kƒ±sa ve doƒüal olsun.`
        }]
      })
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error?.message || 'API hatasƒ±: ' + res.status);
    }

    const data = await res.json();
    _aiResult = (data.choices?.[0]?.message?.content || '').trim();

    const resultText = document.getElementById('aiResultText');
    if (resultText) resultText.textContent = _aiResult;
    if (resultBox) resultBox.classList.add('show');
  } catch(e) {
    showToast('‚ùå AI hatasƒ±: ' + e.message);
    if (e.message.includes('401') || e.message.includes('403')) {
      document.getElementById('aiKeySection').style.display = 'block';
    }
  } finally {
    if (loading) loading.classList.remove('show');
  }
}

function useAiResult() {
  if (!_aiResult) return;
  const inp = document.getElementById('deskInp') || document.getElementById('msgInp');
  if (inp) {
    inp.value = _aiResult;
    if (inp._autoResize) inp._autoResize();
    else { inp.style.height = 'auto'; inp.style.height = Math.min(inp.scrollHeight, 200) + 'px'; }
    inp.focus();
  }
  closeAiPanel();
}

function copyAiResult() {
  if (!_aiResult) return;
  navigator.clipboard.writeText(_aiResult).then(() => showToast('üìã Kopyalandƒ±!')).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = _aiResult;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); showToast('üìã Kopyalandƒ±!');
  });
}

window.openAiPanel = openAiPanel;
window.closeAiPanel = closeAiPanel;
window.saveAiKey = saveAiKey;
window.selectAiStyle = selectAiStyle;
window.runAiAssist = runAiAssist;
window.useAiResult = useAiResult;
window.copyAiResult = copyAiResult;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   3. üåç ANLIK √áEVƒ∞Rƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _currentTranslateLang = 'tr|en';
let _currentTranslateText = '';

function openTranslate(text, anchorEl) {
  _currentTranslateText = text;
  const bubble = document.getElementById('translateBubble');
  if (!bubble) return;

  const bubbleText = document.getElementById('translateBubbleText');
  if (bubbleText) bubbleText.textContent = '‚è≥ √áeviriliyor...';

  // Position
  const rect = anchorEl ? anchorEl.getBoundingClientRect() : null;
  if (rect) {
    let x = rect.left;
    let y = rect.bottom + 8;
    if (x + 310 > window.innerWidth) x = window.innerWidth - 318;
    if (y + 200 > window.innerHeight) y = rect.top - 210;
    bubble.style.left = Math.max(8, x) + 'px';
    bubble.style.top = Math.max(8, y) + 'px';
  } else {
    bubble.style.left = '50%';
    bubble.style.top = '50%';
    bubble.style.transform = 'translate(-50%,-50%)';
  }

  bubble.classList.add('show');
  doTranslate(_currentTranslateLang, text);
}

async function doTranslate(langpair, text) {
  const bubbleText = document.getElementById('translateBubbleText');
  if (!bubbleText) return;

  try {
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text.slice(0, 500))}&langpair=${langpair}`;
    const res = await fetch(url);
    const data = await res.json();
    const translated = data?.responseData?.translatedText || data?.matches?.[0]?.translation || '√áeviri alƒ±namadƒ±';
    bubbleText.textContent = translated;
  } catch(e) {
    bubbleText.textContent = '‚ùå √áeviri ba≈üarƒ±sƒ±z';
  }
}

function switchTranslateLang(el, lang) {
  document.querySelectorAll('.translate-lang-chip').forEach(c => c.classList.remove('sel'));
  el.classList.add('sel');
  _currentTranslateLang = lang;
  if (_currentTranslateText) {
    document.getElementById('translateBubbleText').textContent = '‚è≥ √áeviriliyor...';
    doTranslate(lang, _currentTranslateText);
  }
}

function closeTranslateBubble() {
  const bubble = document.getElementById('translateBubble');
  if (bubble) {
    bubble.classList.remove('show');
    bubble.style.transform = '';
  }
}

// Close on outside click
document.addEventListener('click', e => {
  const bubble = document.getElementById('translateBubble');
  if (bubble && bubble.classList.contains('show') && !bubble.contains(e.target)) {
    closeTranslateBubble();
  }
});

// Inject into message context menu
const _origShowCtx = window.showMsgCtx;
window.showMsgCtx = function(e, btn, room, key, text, own) {
  if (typeof _origShowCtx === 'function') {
    _origShowCtx(e, btn, room, key, text, own);
    // Add translate option to context menu
    const menu = document.getElementById('msgCtxMenu');
    if (menu && text) {
      const sep = document.createElement('div');
      sep.style.cssText = 'height:1px;background:var(--border);margin:3px 4px;';
      const translateItem = document.createElement('div');
      translateItem.className = 'ctx-item';
      translateItem.innerHTML = `<span style="width:22px;display:inline-flex;align-items:center;justify-content:center;">üåç</span> √áevir`;
      translateItem.onclick = (ev) => {
        ev.stopPropagation();
        if (menu._closeCtx) menu._closeCtx();
        openTranslate(text, btn);
      };
      menu.appendChild(sep);
      menu.appendChild(translateItem);
    }
  }
};

window.openTranslate = openTranslate;
window.closeTranslateBubble = closeTranslateBubble;
window.switchTranslateLang = switchTranslateLang;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   4. üéµ M√úZƒ∞K ODASI (YouTube Firebase Sync)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _musicRoom = null;
let _musicStopListener = null;
let _musicYTPlayer = null;
let _musicQueue = [];
let _isMusicDJ = false;

function extractYTId(input) {
  input = input.trim();
  // Direct ID (11 chars)
  if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;
  // URL patterns
  const patterns = [
    /youtu\.be\/([a-zA-Z0-9_-]{11})/,
    /[?&]v=([a-zA-Z0-9_-]{11})/,
    /embed\/([a-zA-Z0-9_-]{11})/,
  ];
  for (const p of patterns) {
    const m = input.match(p);
    if (m) return m[1];
  }
  return null;
}

function openMusicRoom(roomId, roomName) {
  _musicRoom = roomId || (typeof _deskRoom !== 'undefined' ? _deskRoom : (typeof _cRoom !== 'undefined' ? _cRoom : null));
  if (!_musicRoom) { showToast('‚ö†Ô∏è √ñnce bir odaya gir'); return; }

  const panel = document.getElementById('musicRoomPanel');
  if (!panel) return;
  panel.classList.add('open');

  const nameEl = document.getElementById('musicRoomName');
  if (nameEl) nameEl.textContent = roomName || _musicRoom;

  // Listen for sync state from Firebase
  startMusicListener();
}

function closeMusicRoom() {
  const panel = document.getElementById('musicRoomPanel');
  if (panel) panel.classList.remove('open');
  if (_musicStopListener) { _musicStopListener(); _musicStopListener = null; }
}

function startMusicListener() {
  if (_musicStopListener) _musicStopListener();
  if (typeof dbRef !== 'function' || !_musicRoom) return;

  const ref = dbRef('musicRoom/' + _musicRoom);
  const handler = snap => {
    const data = snap.val();
    if (!data) return;

    _musicQueue = data.queue ? Object.values(data.queue) : [];
    renderMusicQueue();

    const nowPlaying = data.nowPlaying;
    if (nowPlaying && nowPlaying.ytId) {
      loadMusicYT(nowPlaying.ytId, nowPlaying.startedAt, nowPlaying.title);
      document.getElementById('musicLiveDot').style.display = 'block';
      const syncInfo = document.getElementById('musicSyncInfo');
      if (syncInfo) {
        syncInfo.style.display = 'flex';
        const syncText = document.getElementById('musicSyncText');
        if (syncText) syncText.textContent = `‚ñ∂ ≈ûu an: ${nowPlaying.title || nowPlaying.ytId} ¬∑ DJ: ${nowPlaying.dj || '?'}`;
      }
    }

    // Update participants
    const parts = data.participants || {};
    const partDiv = document.getElementById('musicParticipants');
    if (partDiv) {
      partDiv.innerHTML = Object.keys(parts).slice(0, 6).map(u =>
        `<div class="music-participant-av" style="background:${typeof strColor==='function'?strColor(u):'#5b9bd5'}" title="${u}">${typeof initials==='function'?initials(u):u[0]}</div>`
      ).join('');
    }
  };

  ref.on('value', handler);
  _musicStopListener = () => ref.off('value', handler);

  // Register as participant
  if (typeof _cu !== 'undefined' && _cu) {
    dbRef('musicRoom/' + _musicRoom + '/participants/' + _cu).set(true);
    window.addEventListener('beforeunload', () => {
      dbRef('musicRoom/' + _musicRoom + '/participants/' + _cu).remove();
    });
  }
}

function loadMusicYT(ytId, startedAt, title) {
  const wrap = document.getElementById('musicPlayerWrap');
  const placeholder = document.getElementById('musicPlayerPlaceholder');
  const frameDiv = document.getElementById('musicYTFrame');
  if (!wrap || !frameDiv) return;

  // Calculate offset
  const elapsed = startedAt ? Math.floor((Date.now() - startedAt) / 1000) : 0;
  const startSec = Math.max(0, elapsed);

  // Load iframe
  frameDiv.innerHTML = `<iframe 
    src="https://www.youtube.com/embed/${ytId}?autoplay=1&start=${startSec}&enablejsapi=1" 
    style="width:100%;height:100%;border:none;" 
    allow="autoplay; fullscreen" 
    allowfullscreen>
  </iframe>`;
  frameDiv.style.display = 'block';
  if (placeholder) placeholder.style.display = 'none';
}

async function startMusicSync() {
  const urlInp = document.getElementById('musicUrlInp');
  if (!urlInp) return;
  const ytId = extractYTId(urlInp.value);
  if (!ytId) { showToast('‚ùå Ge√ßersiz YouTube linki'); return; }

  if (typeof dbRef !== 'function' || !_musicRoom) { showToast('Odaya baƒülanƒ±lamadƒ±'); return; }

  // Fetch video title via oEmbed
  let title = ytId;
  try {
    const r = await fetch(`https://www.youtube.com/oembed?url=https://youtu.be/${ytId}&format=json`);
    if (r.ok) { const d = await r.json(); title = d.title || ytId; }
  } catch {}

  const nowPlaying = {
    ytId, title,
    startedAt: Date.now(),
    dj: (typeof _cu !== 'undefined' ? _cu : 'Bilinmeyen'),
    ts: Date.now(),
  };

  dbRef('musicRoom/' + _musicRoom + '/nowPlaying').set(nowPlaying)
    .then(() => { showToast('üéµ ' + title + ' √ßalƒ±nƒ±yor!'); urlInp.value = ''; })
    .catch(() => showToast('‚ùå Yayƒ±n ba≈ülatƒ±lamadƒ±'));
}

function renderMusicQueue() {
  const qDiv = document.getElementById('musicQueue');
  if (!qDiv) return;
  if (!_musicQueue.length) {
    qDiv.innerHTML = '<div style="color:var(--muted);font-size:.8rem;text-align:center;padding:12px;">Sƒ±ra bo≈ü</div>';
    return;
  }
  qDiv.innerHTML = _musicQueue.map((item, i) =>
    `<div class="music-queue-item">
      <span style="font-size:.75rem;color:var(--muted);flex-shrink:0;">${i+1}</span>
      <span class="mq-title">${typeof esc === 'function' ? esc(item.title || item.ytId) : (item.title || item.ytId)}</span>
      <span style="font-size:.68rem;color:var(--muted);">@${item.by||'?'}</span>
      <span class="mq-remove" onclick="removeMusicQueue(${i})">‚úï</span>
    </div>`
  ).join('');
}

function removeMusicQueue(idx) {
  if (!_musicRoom || typeof dbRef !== 'function') return;
  dbRef('musicRoom/' + _musicRoom + '/queue').once('value').then(snap => {
    const data = snap.val();
    if (!data) return;
    const keys = Object.keys(data);
    if (keys[idx]) dbRef('musicRoom/' + _musicRoom + '/queue/' + keys[idx]).remove();
  });
}

window.openMusicRoom = openMusicRoom;
window.closeMusicRoom = closeMusicRoom;
window.startMusicSync = startMusicSync;
window.removeMusicQueue = removeMusicQueue;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   5. ‚úÖ TOPLU MESAJ SE√áƒ∞Mƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _multiSelectMode = false;
let _selectedMsgKeys = new Set();
let _multiSelectRoom = null;

function enterMultiSelect(roomId, msgKey) {
  _multiSelectMode = true;
  _multiSelectRoom = roomId;
  _selectedMsgKeys.clear();

  const chatMsgs = document.getElementById('chatMsgs') || document.getElementById('deskChatMsgs');
  if (chatMsgs) chatMsgs.classList.add('multi-select-mode');

  // Add checkboxes to all messages
  document.querySelectorAll('.mb[data-key]').forEach(mb => {
    if (!mb.querySelector('.mb-check')) {
      const chk = document.createElement('div');
      chk.className = 'mb-check';
      mb.appendChild(chk);
    }
    mb.addEventListener('click', onMsgMultiClick);
  });

  const bar = document.getElementById('multiSelectBar');
  if (bar) bar.classList.add('show');

  // Pre-select the first message
  if (msgKey) toggleMsgSelect(msgKey);

  // ESC to exit
  document.addEventListener('keydown', onMultiSelectEsc);
}

function onMultiSelectEsc(e) {
  if (e.key === 'Escape') exitMultiSelect();
}

function onMsgMultiClick(e) {
  if (!_multiSelectMode) return;
  e.stopPropagation();
  const key = this.dataset.key;
  if (key) toggleMsgSelect(key);
}

function toggleMsgSelect(key) {
  if (_selectedMsgKeys.has(key)) _selectedMsgKeys.delete(key);
  else _selectedMsgKeys.add(key);

  const mb = document.querySelector(`.mb[data-key="${key}"]`);
  if (mb) mb.classList.toggle('selected', _selectedMsgKeys.has(key));

  const count = document.getElementById('multiSelectCount');
  if (count) count.textContent = _selectedMsgKeys.size + ' mesaj se√ßildi';
}

function exitMultiSelect() {
  _multiSelectMode = false;
  _selectedMsgKeys.clear();
  _multiSelectRoom = null;

  const chatMsgs = document.getElementById('chatMsgs') || document.getElementById('deskChatMsgs');
  if (chatMsgs) chatMsgs.classList.remove('multi-select-mode');

  document.querySelectorAll('.mb').forEach(mb => {
    mb.classList.remove('selected');
    mb.removeEventListener('click', onMsgMultiClick);
    const chk = mb.querySelector('.mb-check');
    if (chk) chk.remove();
  });

  const bar = document.getElementById('multiSelectBar');
  if (bar) bar.classList.remove('show');

  document.removeEventListener('keydown', onMultiSelectEsc);
}

function deleteSelectedMsgs() {
  if (!_selectedMsgKeys.size || !_multiSelectRoom) return;
  const count = _selectedMsgKeys.size;
  if (!confirm(count + ' mesajƒ± silmek istediƒüinizden emin misiniz?')) return;

  if (typeof dbRef !== 'function') return;
  const promises = [..._selectedMsgKeys].map(key =>
    dbRef('msgs/' + _multiSelectRoom + '/' + key).remove()
  );
  Promise.all(promises).then(() => {
    showToast('üóë ' + count + ' mesaj silindi');
    exitMultiSelect();
  }).catch(() => showToast('‚ùå Silme ba≈üarƒ±sƒ±z'));
}

// Long press on message to enter multi-select
let _longPressTimer = null;
document.addEventListener('pointerdown', e => {
  const mb = e.target.closest('.mb[data-key]');
  if (!mb || _multiSelectMode) return;
  _longPressTimer = setTimeout(() => {
    const room = typeof _deskRoom !== 'undefined' ? (_deskRoom || (typeof _cRoom !== 'undefined' ? _cRoom : null)) : null;
    const key = mb.dataset.key;
    if (room && key) {
      navigator.vibrate && navigator.vibrate(50);
      enterMultiSelect(room, key);
    }
  }, 600);
}, { passive: true });

document.addEventListener('pointerup', () => clearTimeout(_longPressTimer), { passive: true });
document.addEventListener('pointermove', () => clearTimeout(_longPressTimer), { passive: true });

window.exitMultiSelect = exitMultiSelect;
window.deleteSelectedMsgs = deleteSelectedMsgs;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   6. ‚è∞ MESAJ ZAMANLAYICI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _scheduledMsgs = JSON.parse(localStorage.getItem('nc_scheduled') || '[]');
let _scheduleTimers = [];

function openSchedulePanel() {
  const panel = document.getElementById('scheduleMsgPanel');
  if (!panel) return;

  // Set min datetime to 1 min from now
  const timeInp = document.getElementById('scheduleMsgTime');
  if (timeInp) {
    const now = new Date(Date.now() + 60000);
    timeInp.min = now.toISOString().slice(0, 16);
    timeInp.value = now.toISOString().slice(0, 16);
  }

  // Pre-fill with current input
  const msgText = document.getElementById('scheduleMsgText');
  const currentInp = document.getElementById('deskInp') || document.getElementById('msgInp');
  if (msgText && currentInp) msgText.value = currentInp.value;

  renderScheduledList();
  panel.classList.add('open');
}

function closeSchedulePanel() {
  const panel = document.getElementById('scheduleMsgPanel');
  if (panel) panel.classList.remove('open');
}

function confirmScheduleMsg() {
  const text = (document.getElementById('scheduleMsgText')?.value || '').trim();
  const timeVal = document.getElementById('scheduleMsgTime')?.value;
  if (!text) { showToast('Mesaj yazƒ±n'); return; }
  if (!timeVal) { showToast('Zaman se√ßin'); return; }

  const scheduledFor = new Date(timeVal).getTime();
  if (scheduledFor <= Date.now()) { showToast('‚ö†Ô∏è Ge√ßmi≈ü bir zaman se√ßildi'); return; }

  const room = typeof _deskRoom !== 'undefined' ? (_deskRoom || (typeof _cRoom !== 'undefined' ? _cRoom : null)) : null;
  if (!room) { showToast('√ñnce bir odaya gir'); return; }
  if (typeof _cu === 'undefined') { showToast('Giri≈ü yapƒ±n'); return; }

  const item = {
    id: Date.now().toString(),
    text, scheduledFor, room, user: _cu,
    createdAt: Date.now(),
  };

  _scheduledMsgs.push(item);
  localStorage.setItem('nc_scheduled', JSON.stringify(_scheduledMsgs));
  scheduleTimer(item);
  renderScheduledList();

  const d = new Date(scheduledFor);
  const fmt = d.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) + ' ' +
    d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
  showToast('‚è∞ Mesaj ' + fmt + ' i√ßin ayarlandƒ±');

  document.getElementById('scheduleMsgText').value = '';
}

function scheduleTimer(item) {
  const delay = item.scheduledFor - Date.now();
  if (delay <= 0) { sendScheduledMsg(item); return; }
  const timer = setTimeout(() => sendScheduledMsg(item), delay);
  _scheduleTimers.push(timer);
}

function sendScheduledMsg(item) {
  if (typeof dbRef !== 'function' || !item.room) return;
  const msg = {
    user: item.user,
    text: item.text,
    ts: Date.now(),
    scheduled: true,
  };
  dbRef('msgs/' + item.room).push(msg).then(() => {
    showToast('‚è∞ Zamanlƒ± mesaj g√∂nderildi!');
  });
  // Remove from list
  _scheduledMsgs = _scheduledMsgs.filter(m => m.id !== item.id);
  localStorage.setItem('nc_scheduled', JSON.stringify(_scheduledMsgs));
  renderScheduledList();
}

function cancelScheduledMsg(id) {
  _scheduledMsgs = _scheduledMsgs.filter(m => m.id !== id);
  localStorage.setItem('nc_scheduled', JSON.stringify(_scheduledMsgs));
  renderScheduledList();
  showToast('üóë Zamanlƒ± mesaj iptal edildi');
}

function renderScheduledList() {
  const listEl = document.getElementById('scheduledMsgList');
  if (!listEl) return;
  const valid = _scheduledMsgs.filter(m => m.scheduledFor > Date.now());
  if (!valid.length) {
    listEl.innerHTML = '';
    return;
  }
  listEl.innerHTML = `
    <div style="font-size:.72rem;font-weight:900;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;">Zamanlanan Mesajlar</div>
    ${valid.map(m => {
      const d = new Date(m.scheduledFor);
      const fmt = d.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) + ' ¬∑ ' +
        d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
      return `<div class="scheduled-list-item">
        <span class="sl-text">${typeof esc === 'function' ? esc(m.text) : m.text}</span>
        <span class="sl-time">‚è∞ ${fmt}</span>
        <span class="sl-cancel" onclick="cancelScheduledMsg('${m.id}')">‚úï</span>
      </div>`;
    }).join('')}
  `;
}

// Restore timers on page load
_scheduledMsgs = _scheduledMsgs.filter(m => m.scheduledFor > Date.now());
localStorage.setItem('nc_scheduled', JSON.stringify(_scheduledMsgs));
_scheduledMsgs.forEach(item => scheduleTimer(item));

window.openSchedulePanel = openSchedulePanel;
window.closeSchedulePanel = closeSchedulePanel;
window.confirmScheduleMsg = confirmScheduleMsg;
window.cancelScheduledMsg = cancelScheduledMsg;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   7. üé® √ñZEL STICKER PAKETƒ∞
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let _myStickers = JSON.parse(localStorage.getItem('nc_stickers') || '[]');

function openStickerManager() {
  const panel = document.getElementById('aiAssistPanel'); // reuse panel structure
  // We'll inject sticker tab into emoji picker instead
  const pickerBody = document.querySelector('.picker-body');
  if (!pickerBody) { showToast('√ñnce emoji pikerini a√ß'); return; }
  injectStickerTab();
}

function injectStickerTab() {
  // Add sticker tab to emoji picker
  const tabs = document.querySelector('.picker-tabs');
  if (!tabs || tabs.querySelector('[data-sticker-tab]')) return;

  const tab = document.createElement('div');
  tab.className = 'picker-tab';
  tab.dataset.stickerTab = '1';
  tab.textContent = 'üé® Sticker';
  tab.onclick = () => showStickerGrid();
  tabs.appendChild(tab);
}

function showStickerGrid() {
  const body = document.querySelector('.picker-body');
  if (!body) return;

  // Deactivate other tabs
  document.querySelectorAll('.picker-tab').forEach(t => t.classList.remove('active'));
  const stickerTab = document.querySelector('[data-sticker-tab]');
  if (stickerTab) stickerTab.classList.add('active');

  const uploadBtn = `
    <label class="sticker-upload-btn" for="stickerFileInp" title="Sticker y√ºkle">
      <div class="su-icon">+</div>
      <div>Ekle</div>
    </label>
    <input type="file" id="stickerFileInp" accept="image/*" style="display:none" onchange="uploadSticker(this)">
  `;

  const stickers = _myStickers.map((src, i) =>
    `<div class="sticker-item" onclick="sendSticker('${i}')" title="Sticker g√∂nder">
      <img src="${src}" loading="lazy">
      <div class="sticker-del" onclick="event.stopPropagation();deleteSticker(${i})" style="position:absolute;top:2px;right:2px;background:rgba(0,0,0,.5);border-radius:4px;padding:1px 4px;font-size:.6rem;color:#fff;cursor:pointer;display:none;">‚úï</div>
    </div>`
  ).join('');

  body.innerHTML = `
    <div style="font-size:.68rem;color:var(--muted);margin-bottom:8px;text-align:center;">Sticker'a saƒü tƒ±kla/uzun bas ‚Üí Sil</div>
    <div class="sticker-grid">
      ${uploadBtn}
      ${stickers}
    </div>
  `;

  // Long press to delete sticker
  body.querySelectorAll('.sticker-item').forEach((el, i) => {
    const del = el.querySelector('.sticker-del');
    el.addEventListener('contextmenu', e => { e.preventDefault(); if (del) del.style.display = ''; });
  });
}

function uploadSticker(inp) {
  const file = inp.files?.[0];
  if (!file) return;
  if (file.size > 512 * 1024) { showToast('‚ö†Ô∏è Sticker max 512KB olabilir'); return; }

  const reader = new FileReader();
  reader.onload = e => {
    _myStickers.push(e.target.result);
    localStorage.setItem('nc_stickers', JSON.stringify(_myStickers));
    showStickerGrid();
    showToast('üé® Sticker eklendi!');
  };
  reader.readAsDataURL(file);
  inp.value = '';
}

function sendSticker(idx) {
  const src = _myStickers[parseInt(idx)];
  if (!src) return;

  const room = typeof _deskRoom !== 'undefined' ? (_deskRoom || (typeof _cRoom !== 'undefined' ? _cRoom : null)) : null;
  if (!room || typeof _cu === 'undefined') { showToast('Odaya gir'); return; }
  if (typeof dbRef !== 'function') return;

  const msg = {
    user: _cu, ts: Date.now(), text: '',
    file: { data: src, type: 'image/sticker', name: 'sticker.webp', isEmoji: false },
    isSticker: true,
  };
  dbRef('msgs/' + room).push(msg).then(() => {
    // Close emoji picker
    if (typeof closeEmoji === 'function') closeEmoji();
  }).catch(() => showToast('G√∂nderilemedi'));
}

function deleteSticker(idx) {
  if (!confirm('Bu stickeri silinsin mi?')) return;
  _myStickers.splice(idx, 1);
  localStorage.setItem('nc_stickers', JSON.stringify(_myStickers));
  showStickerGrid();
}

window.uploadSticker = uploadSticker;
window.sendSticker = sendSticker;
window.deleteSticker = deleteSticker;
window.showStickerGrid = showStickerGrid;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUTON ENJEKSƒ∞YONLARI ‚Äî Mevcut UI'ya butonlar ekle
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function injectActionButtons() {
  // 1. Sohbet input alanƒ±na AI + Schedule butonlarƒ± ekle
  const injectToInputArea = (inpId, areaClass) => {
    const inp = document.getElementById(inpId);
    if (!inp) return;

    // AI Butonu ‚Äî input yanƒ±na
    const inpWrap = inp.closest('.inp-wrap') || inp.closest('.inp-box') || inp.parentElement;
    if (inpWrap && !inpWrap.querySelector('.ai-assist-btn')) {
      const aiBtn = document.createElement('div');
      aiBtn.className = 'ai-assist-btn';
      aiBtn.title = 'AI Mesaj Asistanƒ±';
      aiBtn.innerHTML = '‚ú®';
      aiBtn.onclick = (e) => { e.stopPropagation(); openAiPanel(); };
      inpWrap.appendChild(aiBtn);
    }

    // Schedule butonu ‚Äî send button yanƒ±na
    const sendArea = document.getElementById(inpId === 'msgInp' ? 'sendBtn' : 'deskSendBtn');
    if (sendArea && sendArea.parentElement && !sendArea.parentElement.querySelector('.schedule-msg-btn')) {
      const schedBtn = document.createElement('div');
      schedBtn.className = 'schedule-msg-btn';
      schedBtn.title = 'Mesajƒ± Zamanla';
      schedBtn.innerHTML = '‚è∞';
      schedBtn.onclick = (e) => { e.stopPropagation(); openSchedulePanel(); };
      sendArea.before(schedBtn);
    }
  };

  injectToInputArea('msgInp');
  injectToInputArea('deskInp');

  // 2. Chat header'a M√ºzik Odasƒ± butonu ekle
  ['chatScreen', 'deskChatHeader'].forEach(containerId => {
    const header = document.getElementById(containerId);
    if (!header || header.querySelector('.music-room-btn')) return;

    const headerActions = header.querySelector('.c-header-actions, [style*="display:flex;align-items:center;gap"]');
    if (headerActions) {
      const musicBtn = document.createElement('div');
      musicBtn.className = 'music-room-btn';
      musicBtn.title = 'M√ºzik Odasƒ±';
      musicBtn.innerHTML = 'üéµ';
      musicBtn.onclick = () => openMusicRoom();
      headerActions.prepend(musicBtn);
    }
  });

  // 3. Sticker tab ‚Äî emoji picker'a
  injectStickerTab();
}

// Run injection on DOM changes (since screens are shown/hidden dynamically)
const _injectObserver = new MutationObserver(() => {
  injectActionButtons();
});
_injectObserver.observe(document.body, { childList: true, subtree: true, attributes: false });

// Initial injection
setTimeout(injectActionButtons, 1500);
setTimeout(injectActionButtons, 4000); // retry

})();
</script>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   üåç NATURE.CO i18n ‚Äî Otomatik Dil Sistemi v1.0
   Kullanƒ±cƒ±nƒ±n k√∂ken/uyruk se√ßimine g√∂re UI dilini deƒüi≈ütirir.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function(){
'use strict';

/* ‚îÄ‚îÄ K√∂ken ‚Üí Dil kodu e≈üle≈ütirmesi ‚îÄ‚îÄ */
const ORIGIN_LANG_MAP = {
  'üáπüá∑ T√ºrk':             'tr',
  'üá¶üáø Azerbaycanlƒ±':     'az',
  'üá∫üáø √ñzbek':            'uz',
  'üáπüá≤ T√ºrkmen':          'tk',
  'üá∞üáø Kazak':            'kk',
  'üá∞üá¨ Kƒ±rgƒ±z':           'ky',
  'üá∫üá¶ Ukraynalƒ±':        'uk',
  'üá∑üá∫ Rus':              'ru',
  'üá©üá™ Alman':            'de',
  'üá¶üáπ Avusturyalƒ±':      'de',
  'üá®üá≠ ƒ∞svi√ßreli':        'de',
  'üá¨üáß ƒ∞ngiliz':          'en',
  'üá∫üá∏ Amerikalƒ±':        'en',
  'üá®üá¶ Kanadalƒ±':         'en',
  'üá¶üá∫ Avustralyalƒ±':     'en',
  'üá´üá∑ Fransƒ±z':          'fr',
  'üáßüá™ Bel√ßikalƒ±':        'fr',
  'üá≥üá± Hollandalƒ±':       'nl',
  'üá∏üá™ ƒ∞sve√ßli':          'sv',
  'üá≥üá¥ Norve√ßli':         'no',
  'üá©üá∞ Danimarkalƒ±':      'da',
  'üá´üáÆ Finlandiyalƒ±':     'fi',
  'üáÆüáπ ƒ∞talyan':          'it',
  'üá™üá∏ ƒ∞spanyol':         'es',
  'üá≤üáΩ Meksikalƒ±':        'es',
  'üá¶üá∑ Arjantinli':       'es',
  'üáµüáπ Portekizli':       'pt',
  'üáßüá∑ Brezilyalƒ±':       'pt',
  'üá¨üá∑ Yunan':            'el',
  'üáßüá¨ Bulgar':           'bg',
  'üá∑üá¥ Rumen':            'ro',
  'üáµüá± Polonyalƒ±':        'pl',
  'üá≠üá∫ Macar':            'hu',
  'üá®üáø √áek':              'cs',
  'üá∏üá∞ Slovak':           'sk',
  'üá∑üá∏ Sƒ±rp':             'sr',
  'üá≠üá∑ Hƒ±rvat':           'hr',
  'üáßüá¶ Bo≈ünak':           'bs',
  'üá∏üáÆ Sloven':           'sl',
  'üá≤üá∞ Makedon':          'mk',
  'üá¶üá± Arnavut':          'sq',
  'üá≤üá™ Karadaƒülƒ±':        'sr',
  'üáÆüá∑ ƒ∞ranlƒ±':           'fa',
  'üá¶üá´ Afganlƒ±':          'fa',
  'üáÆüá∂ Iraklƒ±':           'ar',
  'üá∏üáæ Suriyeli':         'ar',
  'üá∏üá¶ Suudi Arabistanlƒ±':'ar',
  'üá¶üá™ BAE\'li':          'ar',
  'üá∂üá¶ Katarlƒ±':          'ar',
  'üá≤üá¶ Faslƒ±':            'ar',
  'üá©üáø Cezayirli':        'ar',
  'üáπüá≥ Tunuslu':          'ar',
  'üá™üá¨ Mƒ±sƒ±rlƒ±':          'ar',
  'üá±üáæ Libyalƒ±':          'ar',
  'üáµüá∞ Pakistanlƒ±':       'ur',
  'üáÆüá≥ Hintli':           'hi',
  'üáßüá© Banglade≈üli':      'bn',
  'üá®üá≥ √áinli':            'zh',
  'üáØüáµ Japon':            'ja',
  'üá∞üá∑ Koreli':           'ko',
  'üá∏üá¥ Somalili':         'so',
  'üá™üáπ Etiyopyalƒ±':       'am',
  'üá≥üá¨ Nijeryalƒ±':        'en',
  'üáøüá¶ G√ºney Afrikalƒ±':   'en',
  'üåç Diƒüer':             'tr',
};

/* ‚îÄ‚îÄ √áeviri s√∂zl√ºƒü√º ‚îÄ‚îÄ */
const I18N = {
  tr: {
    home:'Ana Sayfa', messages:'Mesajlar', forum:'Forum',
    friends:'Arkada≈ülar', watch:'ƒ∞zle', games:'Oyunlar',
    profile:'Profil', settings:'Ayarlar', logout:'√áƒ±kƒ±≈ü Yap',
    search:'Ara...', notifications:'Bildirimler',
    online:'√áevrimi√ßi', offline:'√áevrimdƒ±≈üƒ±',
    send:'G√∂nder', cancel:'ƒ∞ptal', save:'Kaydet', close:'Kapat',
    delete:'Sil', edit:'D√ºzenle', copy:'Kopyala', reply:'Cevapla',
    pin:'Sabitle', react:'Tepki Ekle',
    msg_placeholder:'Mesaj yaz...',
    chat_empty_title:'Sohbet ba≈ülasƒ±n!',
    chat_empty_sub:'Hen√ºz mesaj yok. ƒ∞lk mesajƒ± sen g√∂nder.',
    typing_one:'yazƒ±yor', typing_multi:'yazƒ±yor',
    last_seen:'Son g√∂r√ºlme:',
    add_friend:'Arkada≈ü Ekle', accept:'Kabul Et', reject:'Reddet',
    members:'√ºye', room:'Oda', group:'Grup', channel:'Kanal',
    new_group:'Yeni Grup', create:'Olu≈ütur',
    admin:'Y√∂netici', ban:'Yasakla', mute:'Sustur',
    loading:'Y√ºkleniyor...', error:'Hata olu≈ütu',
    send_msg:'Mesaj g√∂nder', voice_msg:'Sesli mesaj',
    upload_file:'Dosya g√∂nder', emoji:'Emoji',
    schedule:'Zamanla', ai_assist:'AI Asistan',
    music_room:'M√ºzik Odasƒ±', translate:'√áevir',
    pinned:'Sabitlenmi≈ü mesaj',
    read:'okundu', delivered:'iletildi',
    you:'Sen', ago:'√∂nce', just_now:'az √∂nce',
    min_ago:'dakika √∂nce', hour_ago:'saat √∂nce', day_ago:'g√ºn √∂nce',
    direct_messages:'Direkt Mesajlar', channels:'Kanallar', groups:'Gruplar',
    no_friends:'Hen√ºz arkada≈üƒ±n yok',
    friend_requests:'Arkada≈ülƒ±k ƒ∞stekleri',
    block:'Engelle', report:'≈ûikayet Et',
    username:'Kullanƒ±cƒ± Adƒ±', email:'E-posta', password:'≈ûifre',
    register:'Kayƒ±t Ol', login:'Giri≈ü Yap',
  },
  en: {
    home:'Home', messages:'Messages', forum:'Forum',
    friends:'Friends', watch:'Watch', games:'Games',
    profile:'Profile', settings:'Settings', logout:'Log Out',
    search:'Search...', notifications:'Notifications',
    online:'Online', offline:'Offline',
    send:'Send', cancel:'Cancel', save:'Save', close:'Close',
    delete:'Delete', edit:'Edit', copy:'Copy', reply:'Reply',
    pin:'Pin', react:'Add Reaction',
    msg_placeholder:'Type a message...',
    chat_empty_title:'Start the conversation!',
    chat_empty_sub:'No messages yet. Be the first to say something!',
    typing_one:'is typing', typing_multi:'are typing',
    last_seen:'Last seen:',
    add_friend:'Add Friend', accept:'Accept', reject:'Reject',
    members:'members', room:'Room', group:'Group', channel:'Channel',
    new_group:'New Group', create:'Create',
    admin:'Admin', ban:'Ban', mute:'Mute',
    loading:'Loading...', error:'Something went wrong',
    send_msg:'Send message', voice_msg:'Voice message',
    upload_file:'Send file', emoji:'Emoji',
    schedule:'Schedule', ai_assist:'AI Assistant',
    music_room:'Music Room', translate:'Translate',
    pinned:'Pinned message',
    read:'read', delivered:'delivered',
    you:'You', ago:'ago', just_now:'just now',
    min_ago:'minutes ago', hour_ago:'hours ago', day_ago:'days ago',
    direct_messages:'Direct Messages', channels:'Channels', groups:'Groups',
    no_friends:'No friends yet',
    friend_requests:'Friend Requests',
    block:'Block', report:'Report',
    username:'Username', email:'Email', password:'Password',
    register:'Sign Up', login:'Log In',
  },
  de: {
    home:'Startseite', messages:'Nachrichten', forum:'Forum',
    friends:'Freunde', watch:'Ansehen', games:'Spiele',
    profile:'Profil', settings:'Einstellungen', logout:'Abmelden',
    search:'Suchen...', notifications:'Benachrichtigungen',
    online:'Online', offline:'Offline',
    send:'Senden', cancel:'Abbrechen', save:'Speichern', close:'Schlie√üen',
    delete:'L√∂schen', edit:'Bearbeiten', copy:'Kopieren', reply:'Antworten',
    pin:'Anheften', react:'Reaktion hinzuf√ºgen',
    msg_placeholder:'Nachricht schreiben...',
    chat_empty_title:'Starte das Gespr√§ch!',
    chat_empty_sub:'Noch keine Nachrichten. Sei der Erste!',
    typing_one:'schreibt', typing_multi:'schreiben',
    last_seen:'Zuletzt gesehen:',
    add_friend:'Freund hinzuf√ºgen', accept:'Annehmen', reject:'Ablehnen',
    members:'Mitglieder', room:'Raum', group:'Gruppe', channel:'Kanal',
    new_group:'Neue Gruppe', create:'Erstellen',
    admin:'Admin', ban:'Sperren', mute:'Stummschalten',
    loading:'Laden...', error:'Fehler',
    send_msg:'Nachricht senden', voice_msg:'Sprachnachricht',
    upload_file:'Datei senden', emoji:'Emoji',
    schedule:'Planen', ai_assist:'KI-Assistent',
    music_room:'Musikraum', translate:'√úbersetzen',
    pinned:'Angeheftete Nachricht',
    read:'gelesen', delivered:'zugestellt',
    you:'Du', ago:'vor', just_now:'gerade eben',
    min_ago:'Minuten', hour_ago:'Stunden', day_ago:'Tagen',
    direct_messages:'Direktnachrichten', channels:'Kan√§le', groups:'Gruppen',
    no_friends:'Noch keine Freunde',
    friend_requests:'Freundschaftsanfragen',
    block:'Blockieren', report:'Melden',
    username:'Benutzername', email:'E-Mail', password:'Passwort',
    register:'Registrieren', login:'Anmelden',
  },
  fr: {
    home:'Accueil', messages:'Messages', forum:'Forum',
    friends:'Amis', watch:'Regarder', games:'Jeux',
    profile:'Profil', settings:'Param√®tres', logout:'D√©connexion',
    search:'Rechercher...', notifications:'Notifications',
    online:'En ligne', offline:'Hors ligne',
    send:'Envoyer', cancel:'Annuler', save:'Enregistrer', close:'Fermer',
    delete:'Supprimer', edit:'Modifier', copy:'Copier', reply:'R√©pondre',
    pin:'√âpingler', react:'Ajouter une r√©action',
    msg_placeholder:'√âcrire un message...',
    chat_empty_title:'Commencez la conversation !',
    chat_empty_sub:'Pas encore de messages. Soyez le premier !',
    typing_one:'√©crit', typing_multi:'√©crivent',
    last_seen:'Derni√®re connexion :',
    add_friend:'Ajouter un ami', accept:'Accepter', reject:'Refuser',
    members:'membres', room:'Salon', group:'Groupe', channel:'Canal',
    new_group:'Nouveau groupe', create:'Cr√©er',
    admin:'Admin', ban:'Bannir', mute:'Rendre muet',
    loading:'Chargement...', error:'Erreur',
    send_msg:'Envoyer un message', voice_msg:'Message vocal',
    upload_file:'Envoyer un fichier', emoji:'Emoji',
    schedule:'Planifier', ai_assist:'Assistant IA',
    music_room:'Salle de musique', translate:'Traduire',
    pinned:'Message √©pingl√©',
    read:'lu', delivered:'envoy√©',
    you:'Vous', ago:'il y a', just_now:'√† l\'instant',
    min_ago:'minutes', hour_ago:'heures', day_ago:'jours',
    direct_messages:'Messages directs', channels:'Canaux', groups:'Groupes',
    no_friends:'Pas encore d\'amis',
    friend_requests:'Demandes d\'amis',
    block:'Bloquer', report:'Signaler',
    username:'Nom d\'utilisateur', email:'E-mail', password:'Mot de passe',
    register:'S\'inscrire', login:'Se connecter',
  },
  ru: {
    home:'–ì–ª–∞–≤–Ω–∞—è', messages:'–°–æ–æ–±—â–µ–Ω–∏—è', forum:'–§–æ—Ä—É–º',
    friends:'–î—Ä—É–∑—å—è', watch:'–°–º–æ—Ç—Ä–µ—Ç—å', games:'–ò–≥—Ä—ã',
    profile:'–ü—Ä–æ—Ñ–∏–ª—å', settings:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏', logout:'–í—ã–π—Ç–∏',
    search:'–ü–æ–∏—Å–∫...', notifications:'–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
    online:'–í —Å–µ—Ç–∏', offline:'–ù–µ –≤ —Å–µ—Ç–∏',
    send:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å', cancel:'–û—Ç–º–µ–Ω–∞', save:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å', close:'–ó–∞–∫—Ä—ã—Ç—å',
    delete:'–£–¥–∞–ª–∏—Ç—å', edit:'–ò–∑–º–µ–Ω–∏—Ç—å', copy:'–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', reply:'–û—Ç–≤–µ—Ç–∏—Ç—å',
    pin:'–ó–∞–∫—Ä–µ–ø–∏—Ç—å', react:'–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏—é',
    msg_placeholder:'–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ...',
    chat_empty_title:'–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!',
    chat_empty_sub:'–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤—ã–º!',
    typing_one:'–ø–µ—á–∞—Ç–∞–µ—Ç', typing_multi:'–ø–µ—á–∞—Ç–∞—é—Ç',
    last_seen:'–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –≤ —Å–µ—Ç–∏:',
    add_friend:'–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è', accept:'–ü—Ä–∏–Ω—è—Ç—å', reject:'–û—Ç–∫–ª–æ–Ω–∏—Ç—å',
    members:'—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤', room:'–ö–æ–º–Ω–∞—Ç–∞', group:'–ì—Ä—É–ø–ø–∞', channel:'–ö–∞–Ω–∞–ª',
    new_group:'–ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞', create:'–°–æ–∑–¥–∞—Ç—å',
    admin:'–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', ban:'–ó–∞–±–∞–Ω–∏—Ç—å', mute:'–ó–∞–≥–ª—É—à–∏—Ç—å',
    loading:'–ó–∞–≥—Ä—É–∑–∫–∞...', error:'–û—à–∏–±–∫–∞',
    send_msg:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', voice_msg:'–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
    upload_file:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª', emoji:'–≠–º–æ–¥–∑–∏',
    schedule:'–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å', ai_assist:'–ò–ò-–ø–æ–º–æ—â–Ω–∏–∫',
    music_room:'–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞', translate:'–ü–µ—Ä–µ–≤–µ—Å—Ç–∏',
    pinned:'–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ',
    read:'–ø—Ä–æ—á–∏—Ç–∞–Ω–æ', delivered:'–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ',
    you:'–í—ã', ago:'–Ω–∞–∑–∞–¥', just_now:'—Ç–æ–ª—å–∫–æ —á—Ç–æ',
    min_ago:'–º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥', hour_ago:'—á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥', day_ago:'–¥–Ω–µ–π –Ω–∞–∑–∞–¥',
    direct_messages:'–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è', channels:'–ö–∞–Ω–∞–ª—ã', groups:'–ì—Ä—É–ø–ø—ã',
    no_friends:'–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π',
    friend_requests:'–ó–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è',
    block:'–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å', report:'–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è',
    username:'–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', email:'–≠–ª. –ø–æ—á—Ç–∞', password:'–ü–∞—Ä–æ–ª—å',
    register:'–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è', login:'–í–æ–π—Ç–∏',
  },
  ar: {
    home:'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©', messages:'ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ', forum:'ÿßŸÑŸÖŸÜÿ™ÿØŸâ',
    friends:'ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°', watch:'ŸÖÿ¥ÿßŸáÿØÿ©', games:'ÿßŸÑÿ£ŸÑÿπÿßÿ®',
    profile:'ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä', settings:'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', logout:'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨',
    search:'ÿ®ÿ≠ÿ´...', notifications:'ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™',
    online:'ŸÖÿ™ÿµŸÑ', offline:'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ',
    send:'ÿ•ÿ±ÿ≥ÿßŸÑ', cancel:'ÿ•ŸÑÿ∫ÿßÿ°', save:'ÿ≠ŸÅÿ∏', close:'ÿ•ÿ∫ŸÑÿßŸÇ',
    delete:'ÿ≠ÿ∞ŸÅ', edit:'ÿ™ÿπÿØŸäŸÑ', copy:'ŸÜÿ≥ÿÆ', reply:'ÿ±ÿØ',
    pin:'ÿ™ÿ´ÿ®Ÿäÿ™', react:'ÿ•ÿ∂ÿßŸÅÿ© ÿ™ŸÅÿßÿπŸÑ',
    msg_placeholder:'ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©...',
    chat_empty_title:'ÿßÿ®ÿØÿ£ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©!',
    chat_empty_sub:'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ®ÿπÿØ. ŸÉŸÜ ÿ£ŸàŸÑ ŸÖŸÜ Ÿäÿ™ÿ≠ÿØÿ´!',
    typing_one:'ŸäŸÉÿ™ÿ®', typing_multi:'ŸäŸÉÿ™ÿ®ŸàŸÜ',
    last_seen:'ÿ¢ÿÆÿ± ÿ∏ŸáŸàÿ±:',
    add_friend:'ÿ•ÿ∂ÿßŸÅÿ© ÿµÿØŸäŸÇ', accept:'ŸÇÿ®ŸàŸÑ', reject:'ÿ±ŸÅÿ∂',
    members:'ÿ£ÿπÿ∂ÿßÿ°', room:'ÿ∫ÿ±ŸÅÿ©', group:'ŸÖÿ¨ŸÖŸàÿπÿ©', channel:'ŸÇŸÜÿßÿ©',
    new_group:'ŸÖÿ¨ŸÖŸàÿπÿ© ÿ¨ÿØŸäÿØÿ©', create:'ÿ•ŸÜÿ¥ÿßÿ°',
    admin:'ŸÖÿØŸäÿ±', ban:'ÿ≠ÿ∏ÿ±', mute:'ŸÉÿ™ŸÖ',
    loading:'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...', error:'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£',
    send_msg:'ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ©', voice_msg:'ÿ±ÿ≥ÿßŸÑÿ© ÿµŸàÿ™Ÿäÿ©',
    upload_file:'ÿ•ÿ±ÿ≥ÿßŸÑ ŸÖŸÑŸÅ', emoji:'ÿ•ŸäŸÖŸàÿ¨Ÿä',
    schedule:'ÿ¨ÿØŸàŸÑÿ©', ai_assist:'ŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä',
    music_room:'ÿ∫ÿ±ŸÅÿ© ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ', translate:'ÿ™ÿ±ÿ¨ŸÖÿ©',
    pinned:'ÿ±ÿ≥ÿßŸÑÿ© ŸÖÿ´ÿ®ÿ™ÿ©',
    read:'ŸÖŸÇÿ±Ÿàÿ°', delivered:'ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ŸÑŸäŸÖ',
    you:'ÿ£ŸÜÿ™', ago:'ŸÖŸÜÿ∞', just_now:'ÿßŸÑÿ¢ŸÜ',
    min_ago:'ÿØŸÇÿßÿ¶ŸÇ', hour_ago:'ÿ≥ÿßÿπÿßÿ™', day_ago:'ÿ£ŸäÿßŸÖ',
    direct_messages:'ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©', channels:'ÿßŸÑŸÇŸÜŸàÿßÿ™', groups:'ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿßÿ™',
    no_friends:'ŸÑÿß ÿ£ÿµÿØŸÇÿßÿ° ÿ®ÿπÿØ',
    friend_requests:'ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿµÿØÿßŸÇÿ©',
    block:'ÿ≠ÿ∏ÿ±', report:'ÿ•ÿ®ŸÑÿßÿ∫',
    username:'ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ', email:'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä', password:'ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±',
    register:'ÿ™ÿ≥ÿ¨ŸäŸÑ', login:'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ',
  },
  es: {
    home:'Inicio', messages:'Mensajes', forum:'Foro',
    friends:'Amigos', watch:'Ver', games:'Juegos',
    profile:'Perfil', settings:'Configuraci√≥n', logout:'Cerrar sesi√≥n',
    search:'Buscar...', notifications:'Notificaciones',
    online:'En l√≠nea', offline:'Desconectado',
    send:'Enviar', cancel:'Cancelar', save:'Guardar', close:'Cerrar',
    delete:'Eliminar', edit:'Editar', copy:'Copiar', reply:'Responder',
    pin:'Fijar', react:'Agregar reacci√≥n',
    msg_placeholder:'Escribe un mensaje...',
    chat_empty_title:'¬°Inicia la conversaci√≥n!',
    chat_empty_sub:'No hay mensajes a√∫n. ¬°S√© el primero!',
    typing_one:'est√° escribiendo', typing_multi:'est√°n escribiendo',
    last_seen:'√öltima vez:',
    add_friend:'Agregar amigo', accept:'Aceptar', reject:'Rechazar',
    members:'miembros', room:'Sala', group:'Grupo', channel:'Canal',
    new_group:'Nuevo grupo', create:'Crear',
    admin:'Admin', ban:'Banear', mute:'Silenciar',
    loading:'Cargando...', error:'Error',
    send_msg:'Enviar mensaje', voice_msg:'Mensaje de voz',
    upload_file:'Enviar archivo', emoji:'Emoji',
    schedule:'Programar', ai_assist:'Asistente IA',
    music_room:'Sala de m√∫sica', translate:'Traducir',
    pinned:'Mensaje fijado',
    read:'le√≠do', delivered:'entregado',
    you:'T√∫', ago:'hace', just_now:'ahora mismo',
    min_ago:'minutos', hour_ago:'horas', day_ago:'d√≠as',
    direct_messages:'Mensajes directos', channels:'Canales', groups:'Grupos',
    no_friends:'A√∫n no tienes amigos',
    friend_requests:'Solicitudes de amistad',
    block:'Bloquear', report:'Reportar',
    username:'Nombre de usuario', email:'Correo', password:'Contrase√±a',
    register:'Registrarse', login:'Iniciar sesi√≥n',
  },
  pt: {
    home:'In√≠cio', messages:'Mensagens', forum:'F√≥rum',
    friends:'Amigos', watch:'Assistir', games:'Jogos',
    profile:'Perfil', settings:'Configura√ß√µes', logout:'Sair',
    search:'Pesquisar...', notifications:'Notifica√ß√µes',
    online:'Online', offline:'Offline',
    send:'Enviar', cancel:'Cancelar', save:'Salvar', close:'Fechar',
    delete:'Excluir', edit:'Editar', copy:'Copiar', reply:'Responder',
    pin:'Fixar', react:'Adicionar rea√ß√£o',
    msg_placeholder:'Digite uma mensagem...',
    chat_empty_title:'Comece a conversa!',
    chat_empty_sub:'Sem mensagens ainda. Seja o primeiro!',
    typing_one:'est√° digitando', typing_multi:'est√£o digitando',
    last_seen:'Visto por √∫ltimo:',
    add_friend:'Adicionar amigo', accept:'Aceitar', reject:'Rejeitar',
    members:'membros', room:'Sala', group:'Grupo', channel:'Canal',
    new_group:'Novo grupo', create:'Criar',
    admin:'Admin', ban:'Banir', mute:'Silenciar',
    loading:'Carregando...', error:'Erro',
    send_msg:'Enviar mensagem', voice_msg:'Mensagem de voz',
    upload_file:'Enviar arquivo', emoji:'Emoji',
    schedule:'Agendar', ai_assist:'Assistente IA',
    music_room:'Sala de m√∫sica', translate:'Traduzir',
    pinned:'Mensagem fixada',
    read:'lido', delivered:'entregue',
    you:'Voc√™', ago:'h√°', just_now:'agora mesmo',
    min_ago:'minutos', hour_ago:'horas', day_ago:'dias',
    direct_messages:'Mensagens diretas', channels:'Canais', groups:'Grupos',
    no_friends:'Sem amigos ainda',
    friend_requests:'Solicita√ß√µes de amizade',
    block:'Bloquear', report:'Denunciar',
    username:'Nome de usu√°rio', email:'E-mail', password:'Senha',
    register:'Cadastrar', login:'Entrar',
  },
  it: {
    home:'Home', messages:'Messaggi', forum:'Forum',
    friends:'Amici', watch:'Guarda', games:'Giochi',
    profile:'Profilo', settings:'Impostazioni', logout:'Esci',
    search:'Cerca...', notifications:'Notifiche',
    online:'Online', offline:'Offline',
    send:'Invia', cancel:'Annulla', save:'Salva', close:'Chiudi',
    delete:'Elimina', edit:'Modifica', copy:'Copia', reply:'Rispondi',
    pin:'Fissa', react:'Aggiungi reazione',
    msg_placeholder:'Scrivi un messaggio...',
    chat_empty_title:'Inizia la conversazione!',
    chat_empty_sub:'Nessun messaggio ancora. Sii il primo!',
    typing_one:'sta scrivendo', typing_multi:'stanno scrivendo',
    last_seen:'Ultimo accesso:',
    add_friend:'Aggiungi amico', accept:'Accetta', reject:'Rifiuta',
    members:'membri', room:'Stanza', group:'Gruppo', channel:'Canale',
    new_group:'Nuovo gruppo', create:'Crea',
    admin:'Admin', ban:'Banna', mute:'Silenzia',
    loading:'Caricamento...', error:'Errore',
    send_msg:'Invia messaggio', voice_msg:'Messaggio vocale',
    upload_file:'Invia file', emoji:'Emoji',
    schedule:'Programma', ai_assist:'Assistente IA',
    music_room:'Stanza musicale', translate:'Traduci',
    pinned:'Messaggio fissato',
    read:'letto', delivered:'consegnato',
    you:'Tu', ago:'fa', just_now:'adesso',
    min_ago:'minuti', hour_ago:'ore', day_ago:'giorni',
    direct_messages:'Messaggi diretti', channels:'Canali', groups:'Gruppi',
    no_friends:'Nessun amico ancora',
    friend_requests:'Richieste di amicizia',
    block:'Blocca', report:'Segnala',
    username:'Nome utente', email:'Email', password:'Password',
    register:'Registrati', login:'Accedi',
  },
  zh: {
    home:'È¶ñÈ°µ', messages:'Ê∂àÊÅØ', forum:'ËÆ∫Âùõ',
    friends:'Â•ΩÂèã', watch:'ËßÇÁúã', games:'Ê∏∏Êàè',
    profile:'‰∏™‰∫∫ËµÑÊñô', settings:'ËÆæÁΩÆ', logout:'ÈÄÄÂá∫ÁôªÂΩï',
    search:'ÊêúÁ¥¢...', notifications:'ÈÄöÁü•',
    online:'Âú®Á∫ø', offline:'Á¶ªÁ∫ø',
    send:'ÂèëÈÄÅ', cancel:'ÂèñÊ∂à', save:'‰øùÂ≠ò', close:'ÂÖ≥Èó≠',
    delete:'Âà†Èô§', edit:'ÁºñËæë', copy:'Â§çÂà∂', reply:'ÂõûÂ§ç',
    pin:'ÁΩÆÈ°∂', react:'Ê∑ªÂä†ÂèçÂ∫î',
    msg_placeholder:'ËæìÂÖ•Ê∂àÊÅØ...',
    chat_empty_title:'ÂºÄÂßãËÅäÂ§©ÂêßÔºÅ',
    chat_empty_sub:'ËøòÊ≤°ÊúâÊ∂àÊÅØÔºåÁéáÂÖàÂèëË®ÄÂêßÔºÅ',
    typing_one:'Ê≠£Âú®ËæìÂÖ•', typing_multi:'Ê≠£Âú®ËæìÂÖ•',
    last_seen:'ÊúÄÂêé‰∏äÁ∫ø:',
    add_friend:'Ê∑ªÂä†Â•ΩÂèã', accept:'Êé•Âèó', reject:'ÊãíÁªù',
    members:'ÊàêÂëò', room:'ÊàøÈó¥', group:'Áæ§ÁªÑ', channel:'È¢ëÈÅì',
    new_group:'Êñ∞Âª∫Áæ§ÁªÑ', create:'ÂàõÂª∫',
    admin:'ÁÆ°ÁêÜÂëò', ban:'Â∞ÅÁ¶Å', mute:'Á¶ÅË®Ä',
    loading:'Âä†ËΩΩ‰∏≠...', error:'ÂèëÁîüÈîôËØØ',
    send_msg:'ÂèëÈÄÅÊ∂àÊÅØ', voice_msg:'ËØ≠Èü≥Ê∂àÊÅØ',
    upload_file:'ÂèëÈÄÅÊñá‰ª∂', emoji:'Ë°®ÊÉÖ',
    schedule:'ÂÆöÊó∂', ai_assist:'AIÂä©Êâã',
    music_room:'Èü≥‰πêÂÆ§', translate:'ÁøªËØë',
    pinned:'Â∑≤ÁΩÆÈ°∂Ê∂àÊÅØ',
    read:'Â∑≤ËØª', delivered:'Â∑≤ÈÄÅËææ',
    you:'‰Ω†', ago:'Ââç', just_now:'ÂàöÂàö',
    min_ago:'ÂàÜÈíüÂâç', hour_ago:'Â∞èÊó∂Ââç', day_ago:'Â§©Ââç',
    direct_messages:'ÁßÅ‰ø°', channels:'È¢ëÈÅì', groups:'Áæ§ÁªÑ',
    no_friends:'ËøòÊ≤°ÊúâÂ•ΩÂèã',
    friend_requests:'Â•ΩÂèãËØ∑Ê±Ç',
    block:'ÊãâÈªë', report:'‰∏æÊä•',
    username:'Áî®Êà∑Âêç', email:'ÈÇÆÁÆ±', password:'ÂØÜÁ†Å',
    register:'Ê≥®ÂÜå', login:'ÁôªÂΩï',
  },
  ja: {
    home:'„Éõ„Éº„É†', messages:'„É°„ÉÉ„Çª„Éº„Ç∏', forum:'„Éï„Ç©„Éº„É©„É†',
    friends:'ÂèãÈÅî', watch:'Ë¶ñËÅ¥', games:'„Ç≤„Éº„É†',
    profile:'„Éó„É≠„Éï„Ç£„Éº„É´', settings:'Ë®≠ÂÆö', logout:'„É≠„Ç∞„Ç¢„Ç¶„Éà',
    search:'Ê§úÁ¥¢...', notifications:'ÈÄöÁü•',
    online:'„Ç™„É≥„É©„Ç§„É≥', offline:'„Ç™„Éï„É©„Ç§„É≥',
    send:'ÈÄÅ‰ø°', cancel:'„Ç≠„É£„É≥„Çª„É´', save:'‰øùÂ≠ò', close:'Èñâ„Åò„Çã',
    delete:'ÂâäÈô§', edit:'Á∑®ÈõÜ', copy:'„Ç≥„Éî„Éº', reply:'Ëøî‰ø°',
    pin:'Âõ∫ÂÆö', react:'„É™„Ç¢„ÇØ„Ç∑„Éß„É≥ËøΩÂä†',
    msg_placeholder:'„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...',
    chat_empty_title:'‰ºöË©±„ÇíÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ',
    chat_empty_sub:'„Åæ„Å†„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊúÄÂàù„Å´ÈÄÅ‰ø°„Åó„Çà„ÅÜÔºÅ',
    typing_one:'„ÅåÂÖ•Âäõ‰∏≠', typing_multi:'„ÅåÂÖ•Âäõ‰∏≠',
    last_seen:'ÊúÄÁµÇ„É≠„Ç∞„Ç§„É≥:',
    add_friend:'ÂèãÈÅîËøΩÂä†', accept:'ÊâøË™ç', reject:'ÊãíÂê¶',
    members:'„É°„É≥„Éê„Éº', room:'„É´„Éº„É†', group:'„Ç∞„É´„Éº„Éó', channel:'„ÉÅ„É£„É≥„Éç„É´',
    new_group:'Êñ∞Ë¶è„Ç∞„É´„Éº„Éó', create:'‰ΩúÊàê',
    admin:'ÁÆ°ÁêÜËÄÖ', ban:'„Éê„É≥', mute:'„Éü„É•„Éº„Éà',
    loading:'Ë™≠„ÅøËæº„Åø‰∏≠...', error:'„Ç®„É©„Éº',
    send_msg:'„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°', voice_msg:'Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏',
    upload_file:'„Éï„Ç°„Ç§„É´„ÇíÈÄÅ‰ø°', emoji:'ÁµµÊñáÂ≠ó',
    schedule:'„Çπ„Ç±„Ç∏„É•„Éº„É´', ai_assist:'AI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà',
    music_room:'Èü≥Ê•Ω„É´„Éº„É†', translate:'ÁøªË®≥',
    pinned:'„Éî„É≥Áïô„ÇÅ„É°„ÉÉ„Çª„Éº„Ç∏',
    read:'Êó¢Ë™≠', delivered:'ÈÖç‰ø°Ê∏à„Åø',
    you:'„ÅÇ„Å™„Åü', ago:'Ââç', just_now:'„Åü„Å£„Åü‰ªä',
    min_ago:'ÂàÜÂâç', hour_ago:'ÊôÇÈñìÂâç', day_ago:'Êó•Ââç',
    direct_messages:'„ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏', channels:'„ÉÅ„É£„É≥„Éç„É´', groups:'„Ç∞„É´„Éº„Éó',
    no_friends:'ÂèãÈÅî„Åå„ÅÑ„Åæ„Åõ„Çì',
    friend_requests:'„Éï„É¨„É≥„Éâ„É™„ÇØ„Ç®„Çπ„Éà',
    block:'„Éñ„É≠„ÉÉ„ÇØ', report:'ÈÄöÂ†±',
    username:'„É¶„Éº„Ç∂„ÉºÂêç', email:'„É°„Éº„É´', password:'„Éë„Çπ„ÉØ„Éº„Éâ',
    register:'ÁôªÈå≤', login:'„É≠„Ç∞„Ç§„É≥',
  },
  ko: {
    home:'Ìôà', messages:'Î©îÏãúÏßÄ', forum:'Ìè¨Îüº',
    friends:'ÏπúÍµ¨', watch:'ÏãúÏ≤≠', games:'Í≤åÏûÑ',
    profile:'ÌîÑÎ°úÌïÑ', settings:'ÏÑ§Ï†ï', logout:'Î°úÍ∑∏ÏïÑÏõÉ',
    search:'Í≤ÄÏÉâ...', notifications:'ÏïåÎ¶º',
    online:'Ïò®ÎùºÏù∏', offline:'Ïò§ÌîÑÎùºÏù∏',
    send:'Î≥¥ÎÇ¥Í∏∞', cancel:'Ï∑®ÏÜå', save:'Ï†ÄÏû•', close:'Îã´Í∏∞',
    delete:'ÏÇ≠Ï†ú', edit:'Ìé∏Ïßë', copy:'Î≥µÏÇ¨', reply:'ÎãµÏû•',
    pin:'Í≥†Ï†ï', react:'Î∞òÏùë Ï∂îÍ∞Ä',
    msg_placeholder:'Î©îÏãúÏßÄ ÏûÖÎ†•...',
    chat_empty_title:'ÎåÄÌôîÎ•º ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!',
    chat_empty_sub:'ÏïÑÏßÅ Î©îÏãúÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÎßêÏùÑ Í±∏Ïñ¥Î≥¥ÏÑ∏Ïöî!',
    typing_one:'Ïù¥(Í∞Ä) ÏûÖÎ†• Ï§ë', typing_multi:'ÏûÖÎ†• Ï§ë',
    last_seen:'ÎßàÏßÄÎßâ Ï†ëÏÜç:',
    add_friend:'ÏπúÍµ¨ Ï∂îÍ∞Ä', accept:'ÏàòÎùΩ', reject:'Í±∞Ï†à',
    members:'Î™Ö', room:'Ï±ÑÌåÖÎ∞©', group:'Í∑∏Î£π', channel:'Ï±ÑÎÑê',
    new_group:'ÏÉà Í∑∏Î£π', create:'ÎßåÎì§Í∏∞',
    admin:'Í¥ÄÎ¶¨Ïûê', ban:'Ï∞®Îã®', mute:'ÏùåÏÜåÍ±∞',
    loading:'Î°úÎî© Ï§ë...', error:'Ïò§Î•ò Î∞úÏÉù',
    send_msg:'Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞', voice_msg:'ÏùåÏÑ± Î©îÏãúÏßÄ',
    upload_file:'ÌååÏùº Î≥¥ÎÇ¥Í∏∞', emoji:'Ïù¥Î™®ÏßÄ',
    schedule:'ÏòàÏïΩ', ai_assist:'AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏',
    music_room:'ÏùåÏïÖ Î∞©', translate:'Î≤àÏó≠',
    pinned:'Í≥†Ï†ïÎêú Î©îÏãúÏßÄ',
    read:'ÏùΩÏùå', delivered:'Ï†ÑÎã¨Îê®',
    you:'ÎÇò', ago:'Ï†Ñ', just_now:'Î∞©Í∏à',
    min_ago:'Î∂Ñ Ï†Ñ', hour_ago:'ÏãúÍ∞Ñ Ï†Ñ', day_ago:'Ïùº Ï†Ñ',
    direct_messages:'Îã§Ïù¥Î†âÌä∏ Î©îÏãúÏßÄ', channels:'Ï±ÑÎÑê', groups:'Í∑∏Î£π',
    no_friends:'ÏïÑÏßÅ ÏπúÍµ¨Í∞Ä ÏóÜÏäµÎãàÎã§',
    friend_requests:'ÏπúÍµ¨ ÏöîÏ≤≠',
    block:'Ï∞®Îã®', report:'Ïã†Í≥†',
    username:'ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ', email:'Ïù¥Î©îÏùº', password:'ÎπÑÎ∞ÄÎ≤àÌò∏',
    register:'ÌöåÏõêÍ∞ÄÏûÖ', login:'Î°úÍ∑∏Ïù∏',
  },
  uk: {
    home:'–ì–æ–ª–æ–≤–Ω–∞', messages:'–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è', forum:'–§–æ—Ä—É–º',
    friends:'–î—Ä—É–∑—ñ', watch:'–î–∏–≤–∏—Ç–∏—Å—å', games:'–Ü–≥—Ä–∏',
    profile:'–ü—Ä–æ—Ñ—ñ–ª—å', settings:'–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è', logout:'–í–∏–π—Ç–∏',
    search:'–ü–æ—à—É–∫...', notifications:'–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è',
    online:'–û–Ω–ª–∞–π–Ω', offline:'–û—Ñ–ª–∞–π–Ω',
    send:'–ù–∞–¥—ñ—Å–ª–∞—Ç–∏', cancel:'–°–∫–∞—Å—É–≤–∞—Ç–∏', save:'–ó–±–µ—Ä–µ–≥—Ç–∏', close:'–ó–∞–∫—Ä–∏—Ç–∏',
    delete:'–í–∏–¥–∞–ª–∏—Ç–∏', edit:'–†–µ–¥–∞–≥—É–≤–∞—Ç–∏', copy:'–ö–æ–ø—ñ—é–≤–∞—Ç–∏', reply:'–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏',
    pin:'–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏', react:'–î–æ–¥–∞—Ç–∏ —Ä–µ–∞–∫—Ü—ñ—é',
    msg_placeholder:'–ù–∞–ø–∏—Å–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...',
    chat_empty_title:'–†–æ–∑–ø–æ—á–Ω—ñ—Ç—å —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è!',
    chat_empty_sub:'–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —â–µ –Ω–µ–º–∞—î. –ù–∞–ø–∏—à—ñ—Ç—å –ø–µ—Ä—à–∏–º!',
    typing_one:'–ø–∏—à–µ', typing_multi:'–ø–∏—à—É—Ç—å',
    last_seen:'–û—Å—Ç–∞–Ω–Ω—ñ–π —Ä–∞–∑ –≤ –º–µ—Ä–µ–∂—ñ:',
    add_friend:'–î–æ–¥–∞—Ç–∏ –≤ –¥—Ä—É–∑—ñ', accept:'–ü—Ä–∏–π–Ω—è—Ç–∏', reject:'–í—ñ–¥—Ö–∏–ª–∏—Ç–∏',
    members:'—É—á–∞—Å–Ω–∏–∫—ñ–≤', room:'–ö—ñ–º–Ω–∞—Ç–∞', group:'–ì—Ä—É–ø–∞', channel:'–ö–∞–Ω–∞–ª',
    new_group:'–ù–æ–≤–∞ –≥—Ä—É–ø–∞', create:'–°—Ç–≤–æ—Ä–∏—Ç–∏',
    admin:'–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä', ban:'–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏', mute:'–í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫',
    loading:'–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...', error:'–ü–æ–º–∏–ª–∫–∞',
    send_msg:'–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è', voice_msg:'–ì–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',
    upload_file:'–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–∞–π–ª', emoji:'–ï–º–æ–¥–∑—ñ',
    schedule:'–ó–∞–ø–ª–∞–Ω—É–≤–∞—Ç–∏', ai_assist:'–®–Ü-–ø–æ–º—ñ—á–Ω–∏–∫',
    music_room:'–ú—É–∑–∏—á–Ω–∞ –∫—ñ–º–Ω–∞—Ç–∞', translate:'–ü–µ—Ä–µ–∫–ª–∞—Å—Ç–∏',
    pinned:'–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è',
    read:'–ø—Ä–æ—á–∏—Ç–∞–Ω–æ', delivered:'–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ',
    you:'–í–∏', ago:'—Ç–æ–º—É', just_now:'—â–æ–π–Ω–æ',
    min_ago:'—Ö–≤–∏–ª–∏–Ω —Ç–æ–º—É', hour_ago:'–≥–æ–¥–∏–Ω —Ç–æ–º—É', day_ago:'–¥–Ω—ñ–≤ —Ç–æ–º—É',
    direct_messages:'–û—Å–æ–±–∏—Å—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è', channels:'–ö–∞–Ω–∞–ª–∏', groups:'–ì—Ä—É–ø–∏',
    no_friends:'–ü–æ–∫–∏ –Ω–µ–º–∞—î –¥—Ä—É–∑—ñ–≤',
    friend_requests:'–ó–∞–ø–∏—Ç–∏ –Ω–∞ –¥—Ä—É–∂–±—É',
    block:'–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏', report:'–ü–æ—Å–∫–∞—Ä–∂–∏—Ç–∏—Å—å',
    username:'–Ü–º\'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', email:'–ï–ª. –ø–æ—à—Ç–∞', password:'–ü–∞—Ä–æ–ª—å',
    register:'–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å', login:'–£–≤—ñ–π—Ç–∏',
  },
  nl: {
    home:'Startpagina', messages:'Berichten', forum:'Forum',
    friends:'Vrienden', watch:'Bekijken', games:'Spellen',
    profile:'Profiel', settings:'Instellingen', logout:'Uitloggen',
    search:'Zoeken...', notifications:'Meldingen',
    online:'Online', offline:'Offline',
    send:'Verzenden', cancel:'Annuleren', save:'Opslaan', close:'Sluiten',
    delete:'Verwijderen', edit:'Bewerken', copy:'Kopi√´ren', reply:'Beantwoorden',
    pin:'Vastmaken', react:'Reactie toevoegen',
    msg_placeholder:'Typ een bericht...',
    chat_empty_title:'Start het gesprek!',
    chat_empty_sub:'Nog geen berichten. Wees de eerste!',
    typing_one:'typt', typing_multi:'typen',
    last_seen:'Laatst gezien:',
    add_friend:'Vriend toevoegen', accept:'Accepteren', reject:'Weigeren',
    members:'leden', room:'Ruimte', group:'Groep', channel:'Kanaal',
    new_group:'Nieuwe groep', create:'Aanmaken',
    admin:'Beheerder', ban:'Verbannen', mute:'Dempen',
    loading:'Laden...', error:'Fout',
    send_msg:'Bericht sturen', voice_msg:'Voicebericht',
    upload_file:'Bestand sturen', emoji:'Emoji',
    schedule:'Inplannen', ai_assist:'AI-assistent',
    music_room:'Muziekkamer', translate:'Vertalen',
    pinned:'Vastgemaakt bericht',
    read:'gelezen', delivered:'bezorgd',
    you:'Jij', ago:'geleden', just_now:'zojuist',
    min_ago:'minuten geleden', hour_ago:'uur geleden', day_ago:'dagen geleden',
    direct_messages:'Directe berichten', channels:'Kanalen', groups:'Groepen',
    no_friends:'Nog geen vrienden',
    friend_requests:'Vriendschapsverzoeken',
    block:'Blokkeren', report:'Melden',
    username:'Gebruikersnaam', email:'E-mail', password:'Wachtwoord',
    register:'Registreren', login:'Inloggen',
  },
  fa: {
    home:'ÿÆÿßŸÜŸá', messages:'Ÿæ€åÿßŸÖ‚ÄåŸáÿß', forum:'ÿßŸÜÿ¨ŸÖŸÜ',
    friends:'ÿØŸàÿ≥ÿ™ÿßŸÜ', watch:'ÿ™ŸÖÿßÿ¥ÿß', games:'ÿ®ÿßÿ≤€å‚ÄåŸáÿß',
    profile:'Ÿæÿ±ŸàŸÅÿß€åŸÑ', settings:'ÿ™ŸÜÿ∏€åŸÖÿßÿ™', logout:'ÿÆÿ±Ÿàÿ¨',
    search:'ÿ¨ÿ≥ÿ™ÿ¨Ÿà...', notifications:'ÿßÿπŸÑÿßŸÜ‚ÄåŸáÿß',
    online:'ÿ¢ŸÜŸÑÿß€åŸÜ', offline:'ÿ¢ŸÅŸÑÿß€åŸÜ',
    send:'ÿßÿ±ÿ≥ÿßŸÑ', cancel:'ŸÑÿ∫Ÿà', save:'ÿ∞ÿÆ€åÿ±Ÿá', close:'ÿ®ÿ≥ÿ™ŸÜ',
    delete:'ÿ≠ÿ∞ŸÅ', edit:'Ÿà€åÿ±ÿß€åÿ¥', copy:'⁄©Ÿæ€å', reply:'Ÿæÿßÿ≥ÿÆ',
    pin:'ÿ≥ŸÜÿ¨ÿßŸÇ ⁄©ÿ±ÿØŸÜ', react:'ÿßŸÅÿ≤ŸàÿØŸÜ Ÿàÿß⁄©ŸÜÿ¥',
    msg_placeholder:'Ÿæ€åÿßŸÖ ÿ®ŸÜŸà€åÿ≥€åÿØ...',
    chat_empty_title:'ŸÖ⁄©ÿßŸÑŸÖŸá ÿ±ÿß ÿ¥ÿ±Ÿàÿπ ⁄©ŸÜ€åÿØ!',
    chat_empty_sub:'ŸáŸÜŸàÿ≤ Ÿæ€åÿßŸÖ€å ŸÜ€åÿ≥ÿ™. ÿßŸàŸÑ€åŸÜ ŸÜŸÅÿ± ÿ®ÿßÿ¥€åÿØ!',
    typing_one:'ÿØÿ± ÿ≠ÿßŸÑ ÿ™ÿß€åŸæ', typing_multi:'ÿØÿ± ÿ≠ÿßŸÑ ÿ™ÿß€åŸæ',
    last_seen:'ÿ¢ÿÆÿ±€åŸÜ ÿ®ÿßÿ≤ÿØ€åÿØ:',
    add_friend:'ÿßŸÅÿ≤ŸàÿØŸÜ ÿØŸàÿ≥ÿ™', accept:'ŸÇÿ®ŸàŸÑ', reject:'ÿ±ÿØ',
    members:'ÿπÿ∂Ÿà', room:'ÿßÿ™ÿßŸÇ', group:'⁄Øÿ±ŸàŸá', channel:'⁄©ÿßŸÜÿßŸÑ',
    new_group:'⁄Øÿ±ŸàŸá ÿ¨ÿØ€åÿØ', create:'ÿß€åÿ¨ÿßÿØ',
    admin:'ŸÖÿØ€åÿ±', ban:'ŸÖÿ≥ÿØŸàÿØ ⁄©ÿ±ÿØŸÜ', mute:'ŸÇÿ∑ÿπ ÿµÿØÿß',
    loading:'ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...', error:'ÿÆÿ∑ÿß',
    send_msg:'ÿßÿ±ÿ≥ÿßŸÑ Ÿæ€åÿßŸÖ', voice_msg:'Ÿæ€åÿßŸÖ ÿµŸàÿ™€å',
    upload_file:'ÿßÿ±ÿ≥ÿßŸÑ ŸÅÿß€åŸÑ', emoji:'ÿ¥⁄©ŸÑ⁄©',
    schedule:'ÿ≤ŸÖÿßŸÜ‚Äåÿ®ŸÜÿØ€å', ai_assist:'ÿØÿ≥ÿ™€åÿßÿ± ŸáŸàÿ¥ ŸÖÿµŸÜŸàÿπ€å',
    music_room:'ÿßÿ™ÿßŸÇ ŸÖŸàÿ≥€åŸÇ€å', translate:'ÿ™ÿ±ÿ¨ŸÖŸá',
    pinned:'Ÿæ€åÿßŸÖ ÿ≥ŸÜÿ¨ÿßŸÇ ÿ¥ÿØŸá',
    read:'ÿÆŸàÿßŸÜÿØŸá ÿ¥ÿØ', delivered:'ÿ™ÿ≠Ÿà€åŸÑ ÿØÿßÿØŸá ÿ¥ÿØ',
    you:'ÿ¥ŸÖÿß', ago:'Ÿæ€åÿ¥', just_now:'ŸáŸÖ€åŸÜ ÿßŸÑÿßŸÜ',
    min_ago:'ÿØŸÇ€åŸÇŸá Ÿæ€åÿ¥', hour_ago:'ÿ≥ÿßÿπÿ™ Ÿæ€åÿ¥', day_ago:'ÿ±Ÿàÿ≤ Ÿæ€åÿ¥',
    direct_messages:'Ÿæ€åÿßŸÖ‚ÄåŸáÿß€å ŸÖÿ≥ÿ™ŸÇ€åŸÖ', channels:'⁄©ÿßŸÜÿßŸÑ‚ÄåŸáÿß', groups:'⁄Øÿ±ŸàŸá‚ÄåŸáÿß',
    no_friends:'ŸáŸÜŸàÿ≤ ÿØŸàÿ≥ÿ™€å ŸÜÿØÿßÿ±€åÿØ',
    friend_requests:'ÿØÿ±ÿÆŸàÿßÿ≥ÿ™‚ÄåŸáÿß€å ÿØŸàÿ≥ÿ™€å',
    block:'ŸÖÿ≥ÿØŸàÿØ ⁄©ÿ±ÿØŸÜ', report:'⁄Øÿ≤ÿßÿ±ÿ¥',
    username:'ŸÜÿßŸÖ ⁄©ÿßÿ±ÿ®ÿ±€å', email:'ÿß€åŸÖ€åŸÑ', password:'ÿ±ŸÖÿ≤ ÿπÿ®Ÿàÿ±',
    register:'ÿ´ÿ®ÿ™‚ÄåŸÜÿßŸÖ', login:'Ÿàÿ±ŸàÿØ',
  },
  az: {
    home:'Ana S…ôhif…ô', messages:'Mesajlar', forum:'Forum',
    friends:'Dostlar', watch:'ƒ∞zl…ô', games:'Oyunlar',
    profile:'Profil', settings:'Parametrl…ôr', logout:'√áƒ±xƒ±≈ü',
    search:'Axtar...', notifications:'Bildiri≈ül…ôr',
    online:'Onlayn', offline:'Oflayn',
    send:'G√∂nd…ôr', cancel:'L…ôƒüv et', save:'Saxla', close:'Baƒüla',
    delete:'Sil', edit:'Redakt…ô et', copy:'Kopyala', reply:'Cavabla',
    pin:'Sabitle', react:'Reaksiya …ôlav…ô et',
    msg_placeholder:'Mesaj yaz...',
    chat_empty_title:'S√∂hb…ôti ba≈ülat!',
    chat_empty_sub:'H…ôl…ô mesaj yoxdur. ƒ∞lk mesajƒ± s…ôn g√∂nd…ôr.',
    typing_one:'yazƒ±r', typing_multi:'yazƒ±rlar',
    last_seen:'Son g√∂r√ºnm…ô:',
    add_friend:'Dost …ôlav…ô et', accept:'Q…ôbul et', reject:'R…ôdd et',
    members:'√ºzv', room:'Otaq', group:'Qrup', channel:'Kanal',
    new_group:'Yeni Qrup', create:'Yarat',
    admin:'Admin', ban:'Qadaƒüan et', mute:'Sustur',
    loading:'Y√ºkl…ônir...', error:'X…ôta ba≈ü verdi',
    send_msg:'Mesaj g√∂nd…ôr', voice_msg:'S…ôsli mesaj',
    upload_file:'Fayl g√∂nd…ôr', emoji:'Emoji',
    schedule:'Planla≈üdƒ±r', ai_assist:'AI K√∂m…ôk√ßi',
    music_room:'Musiqi Otaƒüƒ±', translate:'T…ôrc√ºm…ô et',
    pinned:'Sabitl…ônmi≈ü mesaj',
    read:'oxundu', delivered:'√ßatdƒ±rƒ±ldƒ±',
    you:'S…ôn', ago:'…ôvv…ôl', just_now:'indi',
    min_ago:'d…ôqiq…ô …ôvv…ôl', hour_ago:'saat …ôvv…ôl', day_ago:'g√ºn …ôvv…ôl',
    direct_messages:'Birba≈üa Mesajlar', channels:'Kanallar', groups:'Qruplar',
    no_friends:'H…ôl…ô dostun yoxdur',
    friend_requests:'Dostluq ƒ∞st…ôkl…ôri',
    block:'Blokla', report:'≈ûikay…ôt et',
    username:'ƒ∞stifad…ô√ßi adƒ±', email:'E-po√ßt', password:'≈ûifr…ô',
    register:'Qeydiyyat', login:'Daxil ol',
  },
};

/* Fallback: bilinmeyen diller i√ßin ƒ∞ngilizce */
function getLang(langCode) {
  return I18N[langCode] || I18N['en'];
}

/* ‚îÄ‚îÄ RTL diller ‚îÄ‚îÄ */
const RTL_LANGS = new Set(['ar','fa','ur','he']);

/* ‚îÄ‚îÄ Aktif dil ‚îÄ‚îÄ */
let _activeLang = 'tr';
let _activeT = I18N['tr'];

/* ‚îÄ‚îÄ √áeviri uygulama fonksiyonu ‚îÄ‚îÄ */
function applyI18n(langCode) {
  if (!langCode || langCode === _activeLang) return;
  _activeLang = langCode;
  _activeT = getLang(langCode);

  /* RTL desteƒüi */
  if (RTL_LANGS.has(langCode)) {
    document.documentElement.setAttribute('dir', 'rtl');
    document.documentElement.style.direction = 'rtl';
  } else {
    document.documentElement.setAttribute('dir', 'ltr');
    document.documentElement.style.direction = '';
  }

  /* Tab bar etiketleri ‚Äî t√ºm .tab-lb elementleri */
  const tabMap = {
    'Ana Sayfa': _activeT.home, 'Home': _activeT.home,
    'Mesajlar': _activeT.messages, 'Messages': _activeT.messages,
    'Forum': _activeT.forum,
    'Arkada≈ülar': _activeT.friends, 'Friends': _activeT.friends,
    'ƒ∞zle': _activeT.watch, 'Watch': _activeT.watch,
    'Oyunlar': _activeT.games, 'Games': _activeT.games,
    'Profil': _activeT.profile, 'Profile': _activeT.profile,
  };
  document.querySelectorAll('.tab-lb').forEach(el => {
    const txt = el.textContent.trim();
    if (tabMap[txt]) el.textContent = tabMap[txt];
  });

  /* Mesaj input placeholder */
  document.querySelectorAll('#msgInp, #deskInp').forEach(el => {
    if (!el.value && !el.dataset.locked) el.placeholder = _activeT.msg_placeholder;
  });

  /* Context menu butonlarƒ± ‚Äî DOM'da olu≈üunca yakalamak i√ßin MutationObserver ile izliyoruz, aynƒ± zamanda ≈üimdiki olanlarƒ± da g√ºncelle */
  translateContextMenuItems();

  /* Bo≈ü sohbet ekranƒ± */
  translateEmptyChat();

  /* √áevrimi√ßi/√áevrimdƒ±≈üƒ± etiketleri */
  document.querySelectorAll('.c-hdr-sub, #deskChatHdrSub').forEach(el => {
    if (el.textContent.trim().startsWith('üü¢')) {
      el.textContent = 'üü¢ ' + _activeT.online;
    }
  });

  /* Sidebar ba≈ülƒ±klarƒ± */
  translateSidebarLabels();

  /* Profil ekranƒ± */
  translateProfileLabels();

  /* Toast mesajlarƒ±nƒ± yakala ‚Äî showToast'u wrap et */
  wrapToastMessages();

  /* Dil kaydƒ± */
  localStorage.setItem('nc_ui_lang', langCode);

  /* Bildirim: T√ºrk√ße deƒüilse g√∂ster */
  if (langCode !== 'tr') {
    const names = { en:'English',de:'Deutsch',fr:'Fran√ßais',ru:'–†—É—Å—Å–∫–∏–π',ar:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
      es:'Espa√±ol',pt:'Portugu√™s',it:'Italiano',zh:'‰∏≠Êñá',ja:'Êó•Êú¨Ë™û',ko:'ÌïúÍµ≠Ïñ¥',
      uk:'–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',nl:'Nederlands',fa:'ŸÅÿßÿ±ÿ≥€å',az:'Az…ôrbaycan' };
    showToast('üåç Language changed to ' + (names[langCode] || langCode));
  }
}

function translateContextMenuItems() {
  const ctxMap = {
    'Tepki Ekle': _activeT.react, 'Add Reaction': _activeT.react,
    'Cevapla': _activeT.reply, 'Reply': _activeT.reply,
    'Sabitle': _activeT.pin, 'Pin': _activeT.pin,
    'Kopyala': _activeT.copy, 'Copy': _activeT.copy,
    'D√ºzenle': _activeT.edit, 'Edit': _activeT.edit,
    'Sil': _activeT.delete, 'Delete': _activeT.delete,
    '√áevir': _activeT.translate, 'Translate': _activeT.translate,
  };
  document.querySelectorAll('.ctx-item, .cm-item').forEach(el => {
    const txt = el.textContent.trim();
    for (const [key, val] of Object.entries(ctxMap)) {
      if (txt.includes(key)) {
        el.childNodes.forEach(n => {
          if (n.nodeType === 3 && n.textContent.trim()) n.textContent = ' ' + val;
        });
        break;
      }
    }
  });
}

function translateEmptyChat() {
  document.querySelectorAll('.empty-title').forEach(el => {
    el.textContent = _activeT.chat_empty_title;
  });
  document.querySelectorAll('.empty-sub').forEach(el => {
    if (el.textContent.includes('mesaj') || el.textContent.includes('message')) {
      el.textContent = _activeT.chat_empty_sub;
    }
  });
}

function translateSidebarLabels() {
  /* Masa√ºst√º sidebar ba≈ülƒ±klarƒ± */
  const sideMap = {
    'Ana Sayfa': _activeT.home,
    'Forum': _activeT.forum,
    'Arkada≈ülar': _activeT.friends,
    'Oyunlar': _activeT.games,
    'ƒ∞zle': _activeT.watch,
    'Profil': _activeT.profile,
  };
  const sideSub = document.getElementById('deskSidebarSub');
  if (sideSub) {
    const t = sideSub.textContent.trim();
    if (sideMap[t]) sideSub.textContent = sideMap[t];
  }
  /* Rail buton ba≈ülƒ±klarƒ± */
  document.querySelectorAll('.rail-btn').forEach(btn => {
    const title = btn.getAttribute('title');
    if (title && sideMap[title]) btn.setAttribute('title', sideMap[title]);
  });
}

function translateProfileLabels() {
  /* Basit label d√∂n√º≈ü√ºmleri profil sayfasƒ±nda */
  document.querySelectorAll('.prof-section-title, .admin-sec-title').forEach(el => {
    const t = el.textContent.trim();
    const secMap = {
      'Arkada≈ülar': _activeT.friends,
      'Mesajlar': _activeT.messages,
      'Forum': _activeT.forum,
      'Ayarlar': _activeT.settings,
    };
    if (secMap[t]) el.textContent = secMap[t];
  });
}

/* showToast sarmalamasƒ± ‚Äî dinamik mesajlar i√ßin */
const _origShowToast = window.showToast;
let _toastWrapped = false;
function wrapToastMessages() {
  if (_toastWrapped || _activeLang === 'tr') return;
  _toastWrapped = true;
  /* Belirli T√ºrk√ße toast mesajlarƒ±nƒ± √ßevir */
  if (typeof _origShowToast === 'function') {
    window.showToast = function(msg) {
      const toastMap = {
        'üìã Kopyalandƒ±!': {en:'üìã Copied!',de:'üìã Kopiert!',fr:'üìã Copi√© !',ru:'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!',ar:'üìã ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!',es:'üìã ¬°Copiado!',pt:'üìã Copiado!',it:'üìã Copiato!',zh:'üìã Â∑≤Â§çÂà∂ÔºÅ',ja:'üìã „Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ',ko:'üìã Î≥µÏÇ¨Îê®!',uk:'üìã –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!',nl:'üìã Gekopieerd!',fa:'üìã ⁄©Ÿæ€å ÿ¥ÿØ!',az:'üìã Kopyalandƒ±!'},
        '‚úÖ Bio kaydedildi': {en:'‚úÖ Bio saved',de:'‚úÖ Bio gespeichert',fr:'‚úÖ Bio enregistr√©e',ru:'‚úÖ –ë–∏–æ–≥—Ä–∞—Ñ–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞',ar:'‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ≥Ÿäÿ±ÿ©',es:'‚úÖ Bio guardada',pt:'‚úÖ Bio salva',it:'‚úÖ Bio salvata',zh:'‚úÖ ÁÆÄ‰ªãÂ∑≤‰øùÂ≠ò',ja:'‚úÖ „Éó„É≠„Éï„Ç£„Éº„É´‰øùÂ≠òÊ∏à„Åø',ko:'‚úÖ ÏÜåÍ∞ú Ï†ÄÏû•Îê®',uk:'‚úÖ –ë—ñ–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ',nl:'‚úÖ Bio opgeslagen',fa:'‚úÖ ÿ®€åŸà ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØ',az:'‚úÖ Bio saxlanƒ±ldƒ±'},
        'üìå Mesaj sabitlendi': {en:'üìå Message pinned',de:'üìå Nachricht angeheftet',fr:'üìå Message √©pingl√©',ru:'üìå –°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ',ar:'üìå ÿ™ŸÖ ÿ™ÿ´ÿ®Ÿäÿ™ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©',es:'üìå Mensaje fijado',pt:'üìå Mensagem fixada',it:'üìå Messaggio fissato',zh:'üìå Ê∂àÊÅØÂ∑≤ÁΩÆÈ°∂',ja:'üìå „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂõ∫ÂÆö',ko:'üìå Î©îÏãúÏßÄ Í≥†Ï†ïÎê®',uk:'üìå –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ',nl:'üìå Bericht vastgemaakt',fa:'üìå Ÿæ€åÿßŸÖ ÿ≥ŸÜÿ¨ÿßŸÇ ÿ¥ÿØ',az:'üìå Mesaj sabitl…ôndi'},
        'ü§ù Arkada≈ülƒ±k isteƒüi g√∂nderildi!': {en:'ü§ù Friend request sent!',de:'ü§ù Freundschaftsanfrage gesendet!',fr:'ü§ù Demande d\'ami envoy√©e !',ru:'ü§ù –ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!',ar:'ü§ù ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©!',es:'ü§ù ¬°Solicitud de amistad enviada!',pt:'ü§ù Pedido de amizade enviado!',it:'ü§ù Richiesta di amicizia inviata!',zh:'ü§ù Â•ΩÂèãËØ∑Ê±ÇÂ∑≤ÂèëÈÄÅÔºÅ',ja:'ü§ù „Éï„É¨„É≥„ÉâÁî≥Ë´ã„ÇíÈÄÅ„Çä„Åæ„Åó„ÅüÔºÅ',ko:'ü§ù ÏπúÍµ¨ ÏöîÏ≤≠Ïù¥ Ï†ÑÏÜ°Îê®!',uk:'ü§ù –ó–∞–ø–∏—Ç –Ω–∞ –¥—Ä—É–∂–±—É –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!',nl:'ü§ù Vriendschapsverzoek verzonden!',fa:'ü§ù ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ ÿØŸàÿ≥ÿ™€å ÿßÿ±ÿ≥ÿßŸÑ ÿ¥ÿØ!',az:'ü§ù Dostluq ist…ôyi g√∂nd…ôrildi!'},
      };
      let translated = msg;
      const map = toastMap[msg];
      if (map && map[_activeLang]) translated = map[_activeLang];
      _origShowToast(translated);
    };
  }
}

/* ‚îÄ‚îÄ Kullanƒ±cƒ± giri≈üi sonrasƒ± dil y√ºkle ‚îÄ‚îÄ */
function loadUserLang() {
  /* √ñnce localStorage'dan bak */
  const saved = localStorage.getItem('nc_ui_lang');
  if (saved && saved !== 'tr') { applyI18n(saved); return; }

  /* Firebase'den kullanƒ±cƒ± origin bilgisini al */
  if (typeof _cu === 'undefined' || !_cu) return;
  const getOrigin = () => {
    if (typeof dbRef === 'function') {
      dbRef('users/' + _cu + '/origin').once('value').then(snap => {
        const origin = snap.val();
        if (origin) {
          const lang = ORIGIN_LANG_MAP[origin];
          if (lang && lang !== 'tr') applyI18n(lang);
          localStorage.setItem('nc_ui_lang', lang || 'tr');
        }
      }).catch(() => {});
    } else if (typeof fbRestGet === 'function') {
      fbRestGet('users/' + _cu + '/origin').then(origin => {
        if (origin) {
          const lang = ORIGIN_LANG_MAP[origin];
          if (lang && lang !== 'tr') applyI18n(lang);
          localStorage.setItem('nc_ui_lang', lang || 'tr');
        }
      }).catch(() => {});
    }
  };
  /* DB hazƒ±r olmayabilir, kƒ±sa gecikmeyle dene */
  setTimeout(getOrigin, 800);
}

/* ‚îÄ‚îÄ onLoginSuccess hook ‚îÄ‚îÄ */
const _origOnLoginSuccess = window.onLoginSuccess;
window.onLoginSuccess = function() {
  if (typeof _origOnLoginSuccess === 'function') _origOnLoginSuccess.apply(this, arguments);
  setTimeout(loadUserLang, 500);
};

/* ‚îÄ‚îÄ Kayƒ±t sƒ±rasƒ±nda anlƒ±k √∂nizleme ‚îÄ‚îÄ */
const regOriginEl = document.getElementById('regOrigin');
if (regOriginEl) {
  regOriginEl.addEventListener('change', function() {
    const lang = ORIGIN_LANG_MAP[this.value];
    if (lang && lang !== 'tr') {
      const t = getLang(lang);
      /* Kayƒ±t ekranƒ±ndaki buton metnini de anlƒ±k g√ºncelle */
      const regBtn = document.getElementById('regBtn');
      if (regBtn) regBtn.textContent = t.register + ' ‚Üí';
    } else {
      const regBtn = document.getElementById('regBtn');
      if (regBtn) regBtn.textContent = 'Kayƒ±t Ol ‚Üí';
    }
  });
}

/* ‚îÄ‚îÄ MutationObserver: dinamik DOM deƒüi≈üikliklerini de √ßevir ‚îÄ‚îÄ */
const _i18nObserver = new MutationObserver(mutations => {
  if (_activeLang === 'tr') return;
  let hasNewNodes = false;
  mutations.forEach(m => { if (m.addedNodes.length > 0) hasNewNodes = true; });
  if (!hasNewNodes) return;
  /* Belirli kritik elementleri yeniden √ßevir */
  requestAnimationFrame(() => {
    translateEmptyChat();
    translateContextMenuItems();
    document.querySelectorAll('#msgInp, #deskInp').forEach(el => {
      if (!el.value && !el.dataset.locked) el.placeholder = _activeT.msg_placeholder;
    });
  });
});
_i18nObserver.observe(document.body, { childList: true, subtree: true });

/* ‚îÄ‚îÄ Sayfa y√ºklenirken localStorage'dan dil uygula ‚îÄ‚îÄ */
const _savedLang = localStorage.getItem('nc_ui_lang');
if (_savedLang && _savedLang !== 'tr') {
  /* Kƒ±sa gecikme ‚Äî DOM hazƒ±r olsun */
  setTimeout(() => applyI18n(_savedLang), 600);
}

/* ‚îÄ‚îÄ Global eri≈üim ‚îÄ‚îÄ */
window._i18n = { apply: applyI18n, t: () => _activeT, lang: () => _activeLang, dict: I18N };

})();
</script>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     üì± MOBƒ∞L UI ƒ∞Yƒ∞LE≈ûTƒ∞RMELERƒ∞ v2.0
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<style>

/* ‚îÄ‚îÄ 1. ROBOT MASKOT: Header'da ta≈üma √∂nleme ‚îÄ‚îÄ */
@media (max-width: 767px) {
  #mobileRobotSlot {
    width: 40px !important;
    height: 44px !important;
    overflow: hidden !important;
    border-radius: 10px;
    flex-shrink: 0;
  }
  #natureBotPet {
    width: 40px !important;
    height: 44px !important;
    overflow: hidden !important;
  }
  /* ws-name robot ile √∂rt√º≈ümesin */
  .ws-header {
    overflow: hidden;
    gap: 8px;
  }
  .ws-name {
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
}

/* ‚îÄ‚îÄ 2. Bƒ∞LDƒ∞Rƒ∞M PANELƒ∞: Mobilde tam geni≈ülik ‚îÄ‚îÄ */
@media (max-width: 767px) {
  #notifCenterModal {
    align-items: flex-start !important;
    justify-content: center !important;
    background: rgba(0,0,0,0.45) !important;
  }
  #notifCenterPanel {
    width: calc(100vw - 24px) !important;
    max-width: calc(100vw - 24px) !important;
    top: calc(env(safe-area-inset-top, 0px) + 56px) !important;
    left: 12px !important;
    right: 12px !important;
    border-radius: 14px !important;
    animation: notifSlideDown .22s cubic-bezier(.34,1.56,.64,1) !important;
  }
  @keyframes notifSlideDown {
    from { opacity: 0; transform: translateY(-14px) scale(.97); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }
  #notifCenterList {
    max-height: min(55vh, 420px) !important;
  }
}

/* ‚îÄ‚îÄ 3. FORUM TOOLBAR: Kaydƒ±rƒ±labilir tek satƒ±r ‚îÄ‚îÄ */
#forumToolbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}
#forumToolbar::-webkit-scrollbar { display: none; }
#forumToolbar .fmt-btn { flex-shrink: 0; }
#forumToolbar > span[style*="width:1px"] { flex-shrink: 0; }

/* ‚îÄ‚îÄ 4. WS-HEADER: Logo & isim hizalama ‚îÄ‚îÄ */
.ws-header {
  align-items: center;
}
/* Header saƒü grup: sƒ±kƒ±≈ümayƒ± √∂nle */
.ws-header > div:last-child {
  flex-shrink: 0;
}

/* ‚îÄ‚îÄ 5. PROFƒ∞L ƒ∞STATƒ∞STƒ∞KLER: Loading shimmer ‚îÄ‚îÄ */
.prof-stat-num {
  min-width: 20px;
  display: inline-block;
}
@keyframes profStatShimmer {
  0%   { opacity: .3; }
  50%  { opacity: .8; }
  100% { opacity: .3; }
}
.prof-stat-num:empty::before,
.prof-stat-num[data-loading]::before {
  content: '‚Äî';
  animation: profStatShimmer 1.4s ease-in-out infinite;
}

/* ‚îÄ‚îÄ 6. MESAJLAR / ARKADA≈ûLAR: Buton tutarlƒ±lƒ±ƒüƒ± ‚îÄ‚îÄ */
.dm-user-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.dm-user-actions { margin-left: auto; display: flex; gap: 6px; }

/* T√ºm arkada≈ü/mesaj butonlarƒ± aynƒ± minimum geni≈ülikte */
.fr-msg-btn, .fr-add-btn {
  min-width: 90px;
  text-align: center;
  justify-content: center;
}

/* ‚îÄ‚îÄ 7. BO≈ûLUK DOLGUSU: Sayfalar i√ßin ho≈ü empty-state ‚îÄ‚îÄ */
#roomsList:empty::after {
  content: 'Hen√ºz kanal yok';
  display: block;
  text-align: center;
  color: var(--muted);
  font-size: .82rem;
  padding: 48px 16px;
  opacity: .6;
}

/* ‚îÄ‚îÄ 8. TAB BAR: Aktif sekme belirginle≈ütirme ‚îÄ‚îÄ */
.tab.act .tab-ic-wrap {
  background: rgba(91,155,213,.22) !important;
  border-radius: 10px;
}
.tab.act .tab-lb {
  color: var(--accent);
  font-weight: 800;
}

/* ‚îÄ‚îÄ 9. GENEL: Kaydƒ±rma √ßubuklarƒ±nƒ± gizle ‚îÄ‚îÄ */
.rooms-scroll::-webkit-scrollbar,
#frContent::-webkit-scrollbar,
#dmUserList::-webkit-scrollbar,
#notifCenterList::-webkit-scrollbar { display: none; }

/* ‚îÄ‚îÄ 10. SEARCH ROW: Daha ≈üƒ±k g√∂r√ºn√ºm ‚îÄ‚îÄ */
.search-row {
  margin: 10px 12px 6px !important;
  border-radius: 10px !important;
  padding: 9px 13px !important;
  gap: 10px !important;
}

/* ‚îÄ‚îÄ 11. MOBƒ∞L Bƒ∞LDƒ∞Rƒ∞M BALONU: Saƒüa konumla ‚îÄ‚îÄ */
@media (max-width: 767px) {
  .bot-bubble {
    right: 8px !important;
    left: auto !important;
    max-width: calc(100vw - 80px) !important;
  }
}

/* ‚îÄ‚îÄ 12. CANLI ƒ∞ZLE: Kanal kartlarƒ± ‚îÄ‚îÄ */
@media (max-width: 767px) {
  .watch-channel-card, [class*="watch-card"] {
    border-radius: 14px;
  }
}

/* ‚îÄ‚îÄ 13. PROFIL BANNER: Gradient rengi d√ºzelt ‚îÄ‚îÄ */
.prof-banner {
  background: linear-gradient(135deg, var(--accent2, #2a4a7a) 0%, var(--accent, #5b9bd5) 100%) !important;
}

/* ‚îÄ‚îÄ 14. ANA SAYFA: Bot konu≈üma balonunu sol ta≈ümadan koru ‚îÄ‚îÄ */
@media (max-width: 767px) {
  #natureBotBubble, [id*="BotBubble"], .bot-bubble {
    left: max(8px, env(safe-area-inset-left, 0px)) !important;
    right: 8px !important;
    max-width: calc(100vw - 80px) !important;
    width: auto !important;
  }
}

</style>

<script>
/* ‚ïê‚ïê MOBƒ∞L Bƒ∞LDƒ∞Rƒ∞M PANELƒ∞: Doƒüru konum hesabƒ± ‚ïê‚ïê */
(function() {
  'use strict';

  /* openNotifCenter'ƒ± mobil i√ßin override et */
  const _origOpen = window.openNotifCenter;
  window.openNotifCenter = function(triggerEl) {
    const isMobile = window.innerWidth < 768;
    if (isMobile) {
      const modal  = document.getElementById('notifCenterModal');
      const panel  = document.getElementById('notifCenterPanel');
      if (!modal || !panel) return;

      /* Mobilde: safe-area'yƒ± hesaba kat */
      const safeTop = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-top')) || 0;
      panel.style.left   = '12px';
      panel.style.right  = '12px';
      panel.style.top    = (safeTop + 56) + 'px';
      panel.style.width  = '';
      panel.style.maxWidth = '';
      panel.style.position = 'absolute';
      modal.style.display = 'flex';

      if (typeof renderNotifCenter === 'function') renderNotifCenter();

      requestAnimationFrame(() => {
        const close = (e) => {
          if (!panel.contains(e.target)) {
            if (typeof closeNotifCenter === 'function') closeNotifCenter();
            document.removeEventListener('touchstart', close);
            document.removeEventListener('mousedown', close);
          }
        };
        document.addEventListener('touchstart', close, { passive: true });
        document.addEventListener('mousedown', close);
      });
    } else {
      if (typeof _origOpen === 'function') _origOpen.call(this, triggerEl);
    }
  };

  /* ‚ïê‚ïê PROFƒ∞L ƒ∞STATƒ∞STƒ∞KLER: Otomatik y√ºkleme animasyonu ‚ïê‚ïê */
  function watchProfileStats() {
    const ids = ['profMsgCount', 'profFriendCount', 'profJoinDate'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      /* Ba≈ülangƒ±√ßta "‚Äî" ise shimmer g√∂ster */
      if (el.textContent.trim() === '‚Äî') {
        el.dataset.loading = '1';
      }
      /* ƒ∞√ßerik deƒüi≈üince loading'i kaldƒ±r */
      const obs = new MutationObserver(() => {
        if (el.textContent.trim() !== '‚Äî' && el.textContent.trim() !== '') {
          delete el.dataset.loading;
          obs.disconnect();
        }
      });
      obs.observe(el, { childList: true, subtree: true, characterData: true });
    });
  }

  /* DOM hazƒ±r olunca √ßalƒ±≈ütƒ±r */
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', watchProfileStats);
  } else {
    setTimeout(watchProfileStats, 500);
  }

  /* ‚ïê‚ïê FORUM TOOLBAR: Kaydƒ±rma hint (blur efekti) ‚ïê‚ïê */
  function setupForumToolbar() {
    const tb = document.getElementById('forumToolbar');
    if (!tb) return;
    /* Saƒü kenar fade efekti i√ßin wrapper */
    const wrap = tb.parentElement;
    if (!wrap) return;
    wrap.style.position = 'relative';

    /* Fade overlay ekle */
    if (!document.getElementById('_tbFadeR')) {
      const fadeR = document.createElement('div');
      fadeR.id = '_tbFadeR';
      fadeR.style.cssText = [
        'position:absolute', 'right:0', 'top:0', 'width:28px',
        'height:100%', 'pointer-events:none', 'z-index:2',
        'background:linear-gradient(to right, transparent, var(--surface2))',
        'border-radius:0 6px 0 0', 'transition:opacity .2s'
      ].join(';');
      tb.parentElement.style.position = 'relative';
      tb.parentElement.appendChild(fadeR);

      tb.addEventListener('scroll', function() {
        const atEnd = this.scrollLeft + this.clientWidth >= this.scrollWidth - 4;
        fadeR.style.opacity = atEnd ? '0' : '1';
      }, { passive: true });
    }
  }

  /* ‚ïê‚ïê ROBOT MASKOT: Header'dan ta≈üma d√ºzeltmesi ‚ïê‚ïê */
  function fixMobileRobot() {
    if (window.innerWidth >= 768) return;
    const slot = document.getElementById('mobileRobotSlot');
    const bot  = document.getElementById('natureBotPet');
    if (!slot || !bot) return;

    slot.style.width   = '40px';
    slot.style.height  = '44px';
    slot.style.overflow = 'hidden';
    slot.style.borderRadius = '10px';
    slot.style.display = 'flex';
    slot.style.alignItems = 'center';
    slot.style.justifyContent = 'center';

    bot.style.width  = '40px';
    bot.style.height = '44px';
  }

  /* Sayfa y√ºklenince ve resize'da uygula */
  window.addEventListener('load', () => {
    fixMobileRobot();
    setupForumToolbar();
    watchProfileStats();
  });
  window.addEventListener('resize', fixMobileRobot);

  /* MutationObserver ile robot inject edilince yakala */
  const robotObs = new MutationObserver(() => {
    if (document.getElementById('natureBotPet')) {
      fixMobileRobot();
    }
    if (document.getElementById('forumToolbar')) {
      setupForumToolbar();
    }
  });
  robotObs.observe(document.body, { childList: true, subtree: true });

})();
</script>

</body>
</html>
